<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><div id="myscoll"></div><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>JUCå¹¶å‘ç¼–ç¨‹ä¸‹ç¯‡ | geqian's BlogğŸ­</title><meta name="keywords" content="JUC"><meta name="author" content="geqian's BlogğŸ­"><meta name="copyright" content="geqian's BlogğŸ­"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="é»‘é©¬ç¨‹åºå‘˜JUCå¹¶å‘ç¼–ç¨‹ä¸‹ç¯‡ï¼ˆçº¿ç¨‹æ± ã€AQSåŸç†ã€ReentrantLockã€ReentrantReadWriteLockã€StampedLockã€Semaphoreã€CountDownLatchã€CyclicBarrierã€çº¿ç¨‹å®‰å…¨é›†åˆç±»ã€ConcurrentHashMapã€LinkedBlockingQueueã€ConcurrentLinkedQueueã€CopyOnWriteArrayLis">
<meta property="og:type" content="article">
<meta property="og:title" content="JUCå¹¶å‘ç¼–ç¨‹ä¸‹ç¯‡">
<meta property="og:url" content="https://itgeqian.github.io/posts/29.html">
<meta property="og:site_name" content="geqian&#39;s BlogğŸ­">
<meta property="og:description" content="é»‘é©¬ç¨‹åºå‘˜JUCå¹¶å‘ç¼–ç¨‹ä¸‹ç¯‡ï¼ˆçº¿ç¨‹æ± ã€AQSåŸç†ã€ReentrantLockã€ReentrantReadWriteLockã€StampedLockã€Semaphoreã€CountDownLatchã€CyclicBarrierã€çº¿ç¨‹å®‰å…¨é›†åˆç±»ã€ConcurrentHashMapã€LinkedBlockingQueueã€ConcurrentLinkedQueueã€CopyOnWriteArrayLis">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp">
<meta property="article:published_time" content="2025-07-31T21:19:03.000Z">
<meta property="article:modified_time" content="2025-08-03T12:12:00.000Z">
<meta property="article:author" content="geqian&#39;s BlogğŸ­">
<meta property="article:tag" content="JUC">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp"><link rel="shortcut icon" href="/"><link rel="canonical" href="https://itgeqian.github.io/posts/29"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'JUCå¹¶å‘ç¼–ç¨‹ä¸‹ç¯‡',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-08-03 20:12:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><style id="themeColor"></style><style id="rightSide"></style><style id="transPercent"></style><style id="blurNum"></style><style id="settingStyle"></style><span id="fps"></span><style id="defineBg"></style><style id="menu_shadow"></style><script src="https://cdn.jsdelivr.net/npm/echarts@6/dist/echarts.min.js"></script><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper@1.0.12/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper@1.0.12/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="geqian's BlogğŸ­" type="application/atom+xml">
</head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/assets/avatar.png" onerror="onerror=null;src='/assets/r1.jpg'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">68</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">44</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">18</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> ä¼‘é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> å…«éŸ³ç›’</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½±é™¢</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xiangzi"></use></svg><span class="menu_word" style="font-size:17px"> å…«å®ç®±</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-tubiaozhizuomoban">                   </use></svg><span class="menu_word" style="font-size:17px"> ç”»å»Š</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-nvwumao">                   </use></svg><span class="menu_word" style="font-size:17px"> åŠ¨ç”»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘å€å¯¼èˆª</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> æœ‹å‹åœˆ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> å‹äººå¸</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> æ—§æ—¶å…‰</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">geqian's BlogğŸ­</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> ä¼‘é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> å…«éŸ³ç›’</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½±é™¢</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xiangzi"></use></svg><span class="menu_word" style="font-size:17px"> å…«å®ç®±</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-tubiaozhizuomoban">                   </use></svg><span class="menu_word" style="font-size:17px"> ç”»å»Š</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-nvwumao">                   </use></svg><span class="menu_word" style="font-size:17px"> åŠ¨ç”»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘å€å¯¼èˆª</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> æœ‹å‹åœˆ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> å‹äººå¸</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> æ—§æ—¶å…‰</span></a></li></ul></div></div><center id="name-container"><a id="page-name" href="javascript:scrollToTop()">PAGE_NAME</a></center><div id="nav-right"><div id="search-button"><a class="search faa-parent animated-hover" title="æ£€ç´¢ç«™å†…ä»»ä½•ä½ æƒ³è¦çš„ä¿¡æ¯"><svg class="faa-tada icon" style="height:24px;width:24px;fill:currentColor;position:relative;top:6px" aria-hidden="true"><use xlink:href="#icon-valentine_-search-love-find-heart"></use></svg><span> æœç´¢</span></a></div><a class="meihua faa-parent animated-hover" onclick="toggleWinbox()" title="ç¾åŒ–è®¾ç½®-è‡ªå®šä¹‰ä½ çš„é£æ ¼" id="meihua-button"><svg class="faa-tada icon" style="height:26px;width:26px;fill:currentColor;position:relative;top:8px" aria-hidden="true"><use xlink:href="#icon-tupian1"></use></svg></a><a class="sun_moon faa-parent animated-hover" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢" id="nightmode-button"><svg class="faa-tada" style="height:25px;width:25px;fill:currentColor;position:relative;top:7px" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon">       </use></svg></a><div id="toggle-menu"><a><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-info"><h1 class="post-title">JUCå¹¶å‘ç¼–ç¨‹ä¸‹ç¯‡</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><svg class="meta_icon post-meta-icon" style="width:30px;height:30px;position:relative;top:10px"><use xlink:href="#icon-rili"></use></svg><span class="post-meta-label">å‘è¡¨äº </span><time class="post-meta-date-created" datetime="2025-07-31T21:19:03.000Z" title="å‘è¡¨äº 2025-08-01 05:19:03">2025-08-01</time><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-gengxin1"></use></svg><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2025-08-03T12:12:00.000Z" title="æ›´æ–°äº 2025-08-03 20:12:00">2025-08-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-biaoqian"></use></svg><a class="post-meta-categories" href="/categories/JUC/">JUC</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:8px"><use xlink:href="#icon-charuword"></use></svg><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">3.6w</span><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:20px;height:20px;position:relative;top:5px"><use xlink:href="#icon-shizhong"></use></svg><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>148åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="JUCå¹¶å‘ç¼–ç¨‹ä¸‹ç¯‡"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:5px"><use xlink:href="#icon-eye"></use></svg><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="ä¸‹ç¯‡">ä¸‹ç¯‡</h1>
<h2 id="8-å…±äº«æ¨¡å‹ä¹‹å·¥å…·">8.å…±äº«æ¨¡å‹ä¹‹å·¥å…·</h2>
<h3 id="8-1çº¿ç¨‹æ± ">8.1çº¿ç¨‹æ± </h3>
<h4 id="åŸºæœ¬æ¦‚è¿°">åŸºæœ¬æ¦‚è¿°</h4>
<p>çº¿ç¨‹æ± ï¼šä¸€ä¸ªå®¹çº³å¤šä¸ªçº¿ç¨‹çš„å®¹å™¨ï¼Œå®¹å™¨ä¸­çš„çº¿ç¨‹å¯ä»¥é‡å¤ä½¿ç”¨ï¼Œçœå»äº†é¢‘ç¹åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹å¯¹è±¡çš„æ“ä½œ</p>
<p>çº¿ç¨‹æ± ä½œç”¨ï¼š</p>
<ol>
<li>é™ä½èµ„æºæ¶ˆè€—ï¼Œå‡å°‘äº†åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹çš„æ¬¡æ•°ï¼Œæ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½å¯ä»¥è¢«é‡å¤åˆ©ç”¨ï¼Œå¯æ‰§è¡Œå¤šä¸ªä»»åŠ¡</li>
<li>æé«˜å“åº”é€Ÿåº¦ï¼Œå½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œå¦‚æœæœ‰çº¿ç¨‹å¯ä»¥ç›´æ¥ç”¨ï¼Œä¸ä¼šå‡ºç°ç³»ç»Ÿåƒµæ­»</li>
<li>æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§ï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºçº¿ç¨‹ï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§</li>
</ol>
<p>çº¿ç¨‹æ± çš„æ ¸å¿ƒæ€æƒ³ï¼š<strong>çº¿ç¨‹å¤ç”¨</strong>ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥è¢«é‡å¤ä½¿ç”¨ï¼Œæ¥å¤„ç†å¤šä¸ªä»»åŠ¡</p>
<p>æ± åŒ–æŠ€æœ¯ (Pool) ï¼šä¸€ç§ç¼–ç¨‹æŠ€å·§ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯èµ„æºå¤ç”¨ï¼Œåœ¨è¯·æ±‚é‡å¤§æ—¶èƒ½ä¼˜åŒ–åº”ç”¨æ€§èƒ½ï¼Œé™ä½ç³»ç»Ÿé¢‘ç¹å»ºè¿çš„èµ„æºå¼€é”€</p>
<h4 id="ä¸€ã€è‡ªå®šä¹‰çº¿ç¨‹æ± ">ä¸€ã€è‡ªå®šä¹‰çº¿ç¨‹æ± </h4>
<p>çº¿ç¨‹æ± ä¸æ˜¯è¶Šå¤§è¶Šå¥½ï¼Œè¦ä¸CPUæ ¸æ•°é€‚é…</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1515.png" alt="img"></p>
<p>ä¸€æ­¥æ­¥æ‰‹å†™çº¿ç¨‹æ± -é˜»å¡é˜Ÿåˆ—</p>
<h5 id="1-åˆ›å»ºåŸºæœ¬ç±»å’Œæ–¹æ³•">1.åˆ›å»ºåŸºæœ¬ç±»å’Œæ–¹æ³•</h5>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">BlockingQueue</span>&lt;<span class="title">T</span>&gt; &#123;</span><br><span class="line">    <span class="comment">//1.ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> Deque&lt;T&gt; queue = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</span><br><span class="line">    <span class="comment">//2.é”</span></span><br><span class="line">    <span class="keyword">private</span> ReentrantLock <span class="keyword">lock</span> = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="comment">//3.ç”Ÿäº§è€…æ¡ä»¶å˜é‡</span></span><br><span class="line">    <span class="keyword">private</span> Condition fullWaitSet = <span class="keyword">lock</span>.newCondition();</span><br><span class="line">    <span class="comment">//4.æ¶ˆè´¹è€…æ¡ä»¶å˜é‡</span></span><br><span class="line">    <span class="keyword">private</span> Condition emptyWaitSet = <span class="keyword">lock</span>.newCondition();</span><br><span class="line">    <span class="comment">//5.å®¹é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> capacity;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é˜»å¡è·å–</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">take</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">lock</span>.<span class="keyword">lock</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">            <span class="keyword">while</span> (queue.isEmpty()) &#123;</span><br><span class="line">                <span class="comment">//é˜Ÿåˆ—ä¸ºç©ºï¼Œç­‰å¾…</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    emptyWaitSet.<span class="keyword">await</span>();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå–å‡ºå…ƒç´ </span></span><br><span class="line">            T t = queue.removeFirst();</span><br><span class="line">            <span class="comment">//é€šçŸ¥ç”Ÿäº§è€…é˜Ÿåˆ—ä¸­æœ‰ç©ºä½å¯ä»¥å­˜æ”¾å…ƒç´ äº†</span></span><br><span class="line">            fullWaitSet.signal();</span><br><span class="line">            <span class="keyword">return</span> t;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">lock</span>.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é˜»å¡æ·»åŠ </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span>(<span class="params">T element</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">lock</span>.<span class="keyword">lock</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦å·²æ»¡</span></span><br><span class="line">            <span class="keyword">while</span> (queue.size() == capacity) &#123;</span><br><span class="line">                <span class="comment">//é˜Ÿåˆ—å·²æ»¡ï¼Œç­‰å¾…</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fullWaitSet.<span class="keyword">await</span>();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//é˜Ÿåˆ—æœªæ»¡ï¼Œé˜Ÿåˆ—å°¾éƒ¨æ·»åŠ å…ƒç´ </span></span><br><span class="line">            queue.addLast(element);</span><br><span class="line">            <span class="comment">//é€šçŸ¥æ¶ˆè´¹è€…é˜Ÿåˆ—ä¸­æœ‰å…ƒç´ å¯ä»¥æ¶ˆè´¹äº†</span></span><br><span class="line">            emptyWaitSet.signal();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">lock</span>.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–å¤§å°</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">size</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">lock</span>.<span class="keyword">lock</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> queue.size();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">lock</span>.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-å¸¦è¶…æ—¶çš„é˜»å¡è·å–">2.å¸¦è¶…æ—¶çš„é˜»å¡è·å–</h5>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¸¦è¶…æ—¶çš„é˜»å¡è·å–</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> T <span class="title">poll</span>(<span class="params"><span class="built_in">long</span> timeout, TimeUnit unit</span>)</span>&#123;</span><br><span class="line">       <span class="keyword">lock</span>.<span class="keyword">lock</span>();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">//å°†timeoutç»Ÿä¸€è½¬æ¢ä¸ºçº³ç§’</span></span><br><span class="line">           <span class="built_in">long</span> nanos = unit.toNanos(timeout);</span><br><span class="line">           <span class="comment">//åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">           <span class="keyword">while</span> (queue.isEmpty()) &#123;</span><br><span class="line">               <span class="comment">//é˜Ÿåˆ—ä¸ºç©ºï¼Œç­‰å¾…</span></span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   <span class="comment">//è¿”å›çš„æ˜¯å‰©ä½™æ—¶é—´ï¼Œå¦‚æœå°äºç­‰äº0ï¼Œåˆ™ç›´æ¥è¿”å›null</span></span><br><span class="line">                   <span class="keyword">if</span>(nanos&lt;=<span class="number">0</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                   <span class="comment">//ç­‰å¾…ï¼Œç›´åˆ°è¢«å”¤é†’æˆ–è€…è¶…æ—¶ï¼ˆè¿”å›å‰©ä½™æ—¶é—´</span></span><br><span class="line">                   nanos=emptyWaitSet.awaitNanos(nanos);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                   e.printStackTrace();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå–å‡ºå…ƒç´ </span></span><br><span class="line">           T t = queue.removeFirst();</span><br><span class="line">           <span class="comment">//é€šçŸ¥ç”Ÿäº§è€…é˜Ÿåˆ—ä¸­æœ‰ç©ºä½å¯ä»¥å­˜æ”¾å…ƒç´ äº†</span></span><br><span class="line">           fullWaitSet.signal();</span><br><span class="line">           <span class="keyword">return</span> t;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">lock</span>.unlock();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-ä¸‹é¢æ˜¯çº¿ç¨‹æ± çš„åŸºæœ¬æ¡†æ¶ï¼š">3.ä¸‹é¢æ˜¯çº¿ç¨‹æ± çš„åŸºæœ¬æ¡†æ¶ï¼š</h5>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">ThreadPool</span> &#123;</span><br><span class="line">    <span class="comment">//ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> BlockingQueue&lt;Runnable&gt; taskQueue;</span><br><span class="line">    <span class="comment">//çº¿ç¨‹é›†åˆ</span></span><br><span class="line">    <span class="keyword">private</span> HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    <span class="comment">//æ ¸å¿ƒçº¿ç¨‹æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> coreSize;</span><br><span class="line">    <span class="comment">//è·å–ä»»åŠ¡çš„è¶…æ—¶æ—¶é—´</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">long</span> timeout;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TimeUnit timeUnit;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ThreadPool</span>(<span class="params"><span class="built_in">int</span> coreSize, <span class="built_in">long</span> timeout, TimeUnit timeUnit, <span class="built_in">int</span> queueCapacity</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.coreSize = coreSize;</span><br><span class="line">        <span class="keyword">this</span>.timeout = timeout;</span><br><span class="line">        <span class="keyword">this</span>.timeUnit = timeUnit;</span><br><span class="line">        <span class="keyword">this</span>.taskQueue = <span class="keyword">new</span> BlockingQueue&lt;&gt;(queueCapacity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title">Worker</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title">BlockingQueue</span>&lt;<span class="title">T</span>&gt; &#123;</span><br><span class="line">        <span class="comment">//1.ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">        <span class="keyword">private</span> Deque&lt;T&gt; queue = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</span><br><span class="line">        <span class="comment">//2.é”</span></span><br><span class="line">        <span class="keyword">private</span> ReentrantLock <span class="keyword">lock</span> = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">        <span class="comment">//3.ç”Ÿäº§è€…æ¡ä»¶å˜é‡</span></span><br><span class="line">        <span class="keyword">private</span> Condition fullWaitSet = <span class="keyword">lock</span>.newCondition();</span><br><span class="line">        <span class="comment">//4.æ¶ˆè´¹è€…æ¡ä»¶å˜é‡</span></span><br><span class="line">        <span class="keyword">private</span> Condition emptyWaitSet = <span class="keyword">lock</span>.newCondition();</span><br><span class="line">        <span class="comment">//5.å®¹é‡</span></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">int</span> capacity;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ„é€ å™¨</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BlockingQueue</span>(<span class="params"><span class="built_in">int</span> capacity</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.capacity = capacity;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¸¦è¶…æ—¶çš„é˜»å¡è·å–</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> T <span class="title">poll</span>(<span class="params"><span class="built_in">long</span> timeout, TimeUnit unit</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">lock</span>.<span class="keyword">lock</span>();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//å°†timeoutç»Ÿä¸€è½¬æ¢ä¸ºçº³ç§’</span></span><br><span class="line">                <span class="built_in">long</span> nanos = unit.toNanos(timeout);</span><br><span class="line">                <span class="comment">//åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">                <span class="keyword">while</span> (queue.isEmpty()) &#123;</span><br><span class="line">                    <span class="comment">//é˜Ÿåˆ—ä¸ºç©ºï¼Œç­‰å¾…</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">//è¿”å›çš„æ˜¯å‰©ä½™æ—¶é—´ï¼Œå¦‚æœå°äºç­‰äº0ï¼Œåˆ™ç›´æ¥è¿”å›null</span></span><br><span class="line">                        <span class="keyword">if</span> (nanos &lt;= <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                        <span class="comment">//ç­‰å¾…ï¼Œç›´åˆ°è¢«å”¤é†’æˆ–è€…è¶…æ—¶ï¼ˆè¿”å›å‰©ä½™æ—¶é—´</span></span><br><span class="line">                        nanos = emptyWaitSet.awaitNanos(nanos);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå–å‡ºå…ƒç´ </span></span><br><span class="line">                T t = queue.removeFirst();</span><br><span class="line">                <span class="comment">//é€šçŸ¥ç”Ÿäº§è€…é˜Ÿåˆ—ä¸­æœ‰ç©ºä½å¯ä»¥å­˜æ”¾å…ƒç´ äº†</span></span><br><span class="line">                fullWaitSet.signal();</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">lock</span>.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//é˜»å¡è·å–</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> T <span class="title">take</span>()</span> &#123;</span><br><span class="line">            <span class="keyword">lock</span>.<span class="keyword">lock</span>();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">                <span class="keyword">while</span> (queue.isEmpty()) &#123;</span><br><span class="line">                    <span class="comment">//é˜Ÿåˆ—ä¸ºç©ºï¼Œç­‰å¾…</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        emptyWaitSet.<span class="keyword">await</span>();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå–å‡ºå…ƒç´ </span></span><br><span class="line">                T t = queue.removeFirst();</span><br><span class="line">                <span class="comment">//é€šçŸ¥ç”Ÿäº§è€…é˜Ÿåˆ—ä¸­æœ‰ç©ºä½å¯ä»¥å­˜æ”¾å…ƒç´ äº†</span></span><br><span class="line">                fullWaitSet.signal();</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">lock</span>.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//é˜»å¡æ·»åŠ </span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span>(<span class="params">T element</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">lock</span>.<span class="keyword">lock</span>();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦å·²æ»¡</span></span><br><span class="line">                <span class="keyword">while</span> (queue.size() == capacity) &#123;</span><br><span class="line">                    <span class="comment">//é˜Ÿåˆ—å·²æ»¡ï¼Œç­‰å¾…</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        fullWaitSet.<span class="keyword">await</span>();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//é˜Ÿåˆ—æœªæ»¡ï¼Œé˜Ÿåˆ—å°¾éƒ¨æ·»åŠ å…ƒç´ </span></span><br><span class="line">                queue.addLast(element);</span><br><span class="line">                <span class="comment">//é€šçŸ¥æ¶ˆè´¹è€…é˜Ÿåˆ—ä¸­æœ‰å…ƒç´ å¯ä»¥æ¶ˆè´¹äº†</span></span><br><span class="line">                emptyWaitSet.signal();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">lock</span>.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//è·å–å¤§å°</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">size</span>()</span> &#123;</span><br><span class="line">            <span class="keyword">lock</span>.<span class="keyword">lock</span>();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> queue.size();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">lock</span>.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-å®Œå–„ä»»åŠ¡æäº¤-Workerå®ç°">4.å®Œå–„ä»»åŠ¡æäº¤ Workerå®ç°</h5>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j(topic=<span class="string">&quot;c.ThreadPool&quot;</span>)</span><br><span class="line"><span class="keyword">class</span> ThreadPool&#123;</span><br><span class="line">    <span class="comment">//ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> BlockingQueue&lt;Runnable&gt; taskQueue;</span><br><span class="line">    <span class="comment">//çº¿ç¨‹é›†åˆ</span></span><br><span class="line">    <span class="keyword">private</span> HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    <span class="comment">//æ ¸å¿ƒçº¿ç¨‹æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> coreSize;</span><br><span class="line">    <span class="comment">//è·å–ä»»åŠ¡çš„è¶…æ—¶æ—¶é—´</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> timeout;</span><br><span class="line">    <span class="comment">//æ—¶é—´å•ä½</span></span><br><span class="line">    <span class="keyword">private</span> TimeUnit timeUnit;</span><br><span class="line">    <span class="comment">//æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> execute(Runnable <span class="keyword">task</span>)&#123;</span><br><span class="line">        <span class="comment">//å½“ä»»åŠ¡æ•°æ²¡æœ‰è¶…è¿‡coreSizeæ—¶ï¼Œç›´æ¥äº¤ç»™workerå¯¹è±¡æ‰§è¡Œ</span></span><br><span class="line">        <span class="comment">//å¦‚æœä»»åŠ¡æ•°è¶…è¿‡coreSizeæ—¶ï¼ŒåŠ å…¥ä»»åŠ¡é˜Ÿåˆ—æš‚å­˜</span></span><br><span class="line">        <span class="keyword">synchronized</span> (workers)&#123;</span><br><span class="line">            <span class="keyword">if</span>(workers.<span class="keyword">size</span>()&lt;coreSize)&#123;</span><br><span class="line">                Worker worker = <span class="keyword">new</span> Worker(<span class="keyword">task</span>);</span><br><span class="line">                log.debug(<span class="string">&quot;æ–°å¢ worker&#123;&#125;,&#123;&#125;&quot;</span>,worker,<span class="keyword">task</span>);</span><br><span class="line">                workers.add(worker);</span><br><span class="line">                worker.start();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                log.debug(<span class="string">&quot;åŠ å…¥ä»»åŠ¡é˜Ÿåˆ— &#123;&#125;&quot;</span>,<span class="keyword">task</span>);</span><br><span class="line">                taskQueue.put(<span class="keyword">task</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> ThreadPool( <span class="keyword">int</span> coreSize, <span class="keyword">long</span> timeout, TimeUnit timeUnit,<span class="keyword">int</span> queueCapcity) &#123;</span><br><span class="line">        <span class="keyword">this</span>.taskQueue = <span class="keyword">new</span> BlockingQueue&lt;&gt;(queueCapcity);</span><br><span class="line">        <span class="keyword">this</span>.coreSize = coreSize;</span><br><span class="line">        <span class="keyword">this</span>.timeout = timeout;</span><br><span class="line">        <span class="keyword">this</span>.timeUnit = timeUnit;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">class</span> Worker <span class="keyword">extends</span> Thread&#123;</span><br><span class="line">        <span class="keyword">private</span> Runnable <span class="keyword">task</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">public</span> Worker(Runnable <span class="keyword">task</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.<span class="keyword">task</span> = <span class="keyword">task</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> run()&#123;</span><br><span class="line">            <span class="comment">//æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">            <span class="comment">// 1ï¼‰å½“taskä¸ä¸ºç©ºï¼Œæ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">            <span class="comment">// 2ï¼‰å½“taskæ‰§è¡Œå®Œæ¯•ï¼Œå†æ¥ç€ä»ä»»åŠ¡é˜Ÿåˆ—è·å–ä»»åŠ¡</span></span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">task</span> !=<span class="keyword">null</span> || (<span class="keyword">task</span> = taskQueue.take() )!= <span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ­£åœ¨æ‰§è¡Œ...&#123;&#125;&quot;</span>,<span class="keyword">task</span>);</span><br><span class="line">                    <span class="keyword">task</span>.run();</span><br><span class="line">                &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">task</span>=<span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">synchronized</span> (workers)&#123;</span><br><span class="line">                log.debug(<span class="string">&quot;workerè¢«ç§»é™¤&#123;&#125;&quot;</span>,<span class="keyword">this</span>);</span><br><span class="line">                workers.remove(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯æ‰§è¡Œæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic=&quot;c.TestPool&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestPool</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">ThreadPool</span> <span class="variable">threadPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPool</span>(<span class="number">2</span>,<span class="number">1000</span>,TimeUnit.MICROSECONDS,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i;</span><br><span class="line">            threadPool.execute(()-&gt;&#123;</span><br><span class="line">                log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>,j);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºçº¿ç¨‹æ± çº¿ç¨‹æ•°ä¸º2ï¼Œæ‰€ä»¥æ˜¯åˆ›å»ºäº†2ä¸ªworkerçº¿ç¨‹ã€‚</p>
<p>ç„¶åæŠŠåˆ›å»ºå‡ºæ¥çš„2ä¸ªçº¿ç¨‹åŠ å…¥åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œã€‚</p>
<p>ç„¶åThread1å’ŒThread2åˆ†åˆ«æ‰§è¡Œã€‚è¾“å‡ºç»“æœ1å’Œ0</p>
<p>æ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡ï¼Œæ–°çš„ä»»åŠ¡ä¼šè¢«ç»§ç»­åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—ã€‚</p>
<p>æ€»å…±è®¾ç½®äº†5ä¸ªä»»åŠ¡ï¼Œå…¨éƒ¨æ¯”çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1517-1024x375.png" alt="img"></p>
<p>ç°åœ¨æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œçº¿ç¨‹ä¼šæ— é™æ­»ç­‰ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1518.png" alt="img"></p>
<p>åªéœ€è¦æŠŠtakeæ–¹æ³•æ›¿æ¢ä¸ºpollæ–¹æ³•å³å¯ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1519.png" alt="img"></p>
<p>è‡ªåŠ¨åœæ­¢ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1520-1024x498.png" alt="img"></p>
<h5 id="5-å½“ä»»åŠ¡é˜Ÿåˆ—å·²æ»¡">5.å½“ä»»åŠ¡é˜Ÿåˆ—å·²æ»¡</h5>
<p>ç°åœ¨å‡å¦‚æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º2ï¼Œé˜Ÿåˆ—å®¹é‡å¤§å°ä¸º10ï¼Œå‡å¦‚å¤„ç†ä¸€ä¸ªä»»åŠ¡çš„è€—æ—¶å¾ˆé•¿ï¼Œç”Ÿæˆäº†15ä¸ªä»»åŠ¡ï¼Œå¿…ç„¶ä¼šæœ‰10ä¸ªä»»åŠ¡åœ¨ä»»åŠ¡é˜Ÿåˆ—ä¸­é˜»å¡ï¼Œè€Œæœ‰3ä¸ªä»»åŠ¡ç­‰å¾…åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1521-1024x429.png" alt="img"></p>
<p>åº”è¯¥æ·»åŠ ä¸€ä¸ªæ‹’ç»ç­–ç•¥ã€‚</p>
<h5 id="6-offerå¢å¼º">6. offerå¢å¼º</h5>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¸¦è¶…æ—¶æ—¶é—´çš„é˜»å¡æ·»åŠ </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">boolean</span> offer(T <span class="keyword">task</span>,<span class="keyword">long</span> timeout,TimeUnit timeUnit)&#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">long</span> nanos = timeUnit.toNanos(timeout);</span><br><span class="line">        <span class="keyword">while</span>(queue.<span class="keyword">size</span>()==capcity)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;ç­‰å¾…åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—&#123;&#125;...&quot;</span>,<span class="keyword">task</span>);</span><br><span class="line">                <span class="keyword">if</span>(nanos&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                nanos = fullWaitSet.awaitNanos(nanos);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;åŠ å…¥ä»»åŠ¡é˜Ÿåˆ— &#123;&#125;&quot;</span>,<span class="keyword">task</span>);</span><br><span class="line">        queue.addLast(<span class="keyword">task</span>);</span><br><span class="line">        emptyWaitSet.signal();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="7-æ‹’ç»ç­–ç•¥">7.æ‹’ç»ç­–ç•¥</h5>
<p>å¦‚æœæŠŠæ‹’ç»ç­–ç•¥å†™æ­»åœ¨æ‰§è¡Œæ–¹æ³•é‡Œéœ€è¦å¾ˆå¤šçš„if-elseåˆ¤æ–­ï¼Œç°åœ¨çš„æ€è·¯æ˜¯å°†æ‹’ç»ç­–ç•¥çš„é€‰æ‹©äº¤ç»™ç”¨æˆ·ç«¯ï¼Œç”±ç”¨æˆ·æ¥å†³å®šè¦ç”¨å“ªç§æ‹’ç»ç­–ç•¥ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1523.png" alt="img"></p>
<p>ç°åœ¨å¯ä»¥ç”¨ç­–ç•¥æ¨¡å¼ï¼ŒæŠŠæ“ä½œæŠ½è±¡ä¸ºæ¥å£ï¼Œå…·ä½“çš„å®ç°ç”±è°ƒç”¨è€…ä¼ é€’è¿›æ¥ã€‚</p>
<p>ä¸»è¦æ˜¯ä¿®æ”¹mainæ–¹æ³•å’Œexecuteæ–¹æ³•ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1524.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1525-1024x350.png" alt="img"></p>
<p>é¦–å…ˆæ˜¯æ­»ç­‰ç­–ç•¥ï¼Œåªè¦é˜Ÿåˆ—è¿˜æœ‰ä»»åŠ¡å°±ä¸€ç›´æ­»ç­‰</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1522-1024x692.png" alt="img"></p>
<p>ç¬¬äºŒç§å¸¦è¶…æ—¶ç­‰å¾…</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1527-1024x702.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1528-1024x676.png" alt="img"></p>
<p>ç¬¬ä¸‰ç§ï¼Œè®©è°ƒç”¨è€…æ”¾å¼ƒä»»åŠ¡æ‰§è¡Œ</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1529-1024x608.png" alt="img"></p>
<p>ç¬¬å››ç§è®©è°ƒç”¨è€…æŠ›å‡ºå¼‚å¸¸</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1530-1024x669.png" alt="img"></p>
<p>ç¬¬äº”ç§è®©è°ƒç”¨è€…è‡ªå·±æ‰§è¡Œä»»åŠ¡</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1531-1024x402.png" alt="img"></p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j(topic=<span class="string">&quot;c.TestPool&quot;</span>)</span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">TestPool</span> &#123;</span><br><span class="line">    public <span class="keyword">static</span> <span class="literal">void</span> main(<span class="built_in">String</span>[] args)&#123;</span><br><span class="line">        ThreadPool threadPool = <span class="keyword">new</span> ThreadPool<span class="function"><span class="params">(<span class="number">1</span>,<span class="number">1000</span>,TimeUnit.MILLISECONDS,<span class="number">1</span>,(queue,task)-&gt;&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="regexp">//1.æ­»ç­‰</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">   //</span>         queue.put(task);</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="regexp">// 2ï¼‰å¸¦è¶…æ—¶ç­‰å¾…</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">   //</span>         queue.offer(task,<span class="number">1500</span>,TimeUnit.MILLISECONDS);</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="regexp">// 3ï¼‰è®©è°ƒç”¨è€… æ”¾å¼ƒä»»åŠ¡æ‰§è¡Œ</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">   //</span>         log.debug(<span class="string">&quot;æ”¾å¼ƒ&#123;&#125;&quot;</span>,task); <span class="regexp">//é˜Ÿåˆ—ä¸€æ»¡å°±è‡ªåŠ¨æ”¾å¼ƒæ‰§è¡Œ</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">            //</span> <span class="number">4</span>ï¼‰è®©è°ƒç”¨è€… æŠ›å‡ºå¼‚å¸¸</span></span></span><br><span class="line"><span class="params"><span class="function">   <span class="regexp">//         throw new RuntimeException(&quot;ä»»åŠ¡æ‰§è¡Œå¤±è´¥ &quot;+task);</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">            //</span> <span class="number">5</span>ï¼‰è®©è°ƒç”¨è€…è‡ªå·±æ‰§è¡Œä»»åŠ¡</span></span></span><br><span class="line"><span class="params"><span class="function">              task.run();</span></span></span><br><span class="line"><span class="params"><span class="function">        &#125;)</span>;</span></span><br><span class="line"><span class="function">        <span class="title">for</span> <span class="params">(int i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span> &#123;</span></span><br><span class="line"><span class="function">            <span class="title">int</span> <span class="title">j</span> = <span class="title">i</span>;</span></span><br><span class="line"><span class="function">            <span class="title">threadPool</span>.<span class="title">execute</span><span class="params">(()-&gt;&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">try</span> &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                    Thread.sleep(<span class="number">1000</span>L);</span></span></span><br><span class="line"><span class="params"><span class="function">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span></span></span><br><span class="line"><span class="params"><span class="function">                &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">                log.debug(<span class="string">&quot;&#123;&#125;&quot;</span>,j);</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;)</span>;</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function">@<span class="title">FunctionalInterface</span> //æ‹’ç»ç­–ç•¥</span></span><br><span class="line"><span class="function"><span class="title">interface</span> <span class="title">RejectPolicy</span>&lt;<span class="title">T</span>&gt;&#123;</span></span><br><span class="line"><span class="function">    <span class="title">void</span> <span class="title">reject</span><span class="params">(BlockingQueue&lt;T&gt; queue,T task)</span>;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function">@<span class="title">Slf4j</span><span class="params">(topic=<span class="string">&quot;c.ThreadPool&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">class</span> <span class="title">ThreadPool</span>&#123;</span></span><br><span class="line"><span class="function">    //ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line"><span class="function">    <span class="title">private</span> <span class="title">BlockingQueue</span>&lt;<span class="title">Runnable</span>&gt; <span class="title">taskQueue</span>;</span></span><br><span class="line"><span class="function">    //çº¿ç¨‹é›†åˆ</span></span><br><span class="line"><span class="function">    <span class="title">private</span> <span class="title">HashSet</span>&lt;<span class="title">Worker</span>&gt; <span class="title">workers</span> = <span class="title">new</span> <span class="title">HashSet</span>&lt;&gt;<span class="params">()</span>;</span></span><br><span class="line"><span class="function">    //æ ¸å¿ƒçº¿ç¨‹æ•°</span></span><br><span class="line"><span class="function">    <span class="title">private</span> <span class="title">int</span> <span class="title">coreSize</span>;</span></span><br><span class="line"><span class="function">    //è·å–ä»»åŠ¡çš„è¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="function">    <span class="title">private</span> <span class="title">long</span> <span class="title">timeout</span>;</span></span><br><span class="line"><span class="function">    //æ—¶é—´å•ä½</span></span><br><span class="line"><span class="function">    <span class="title">private</span> <span class="title">TimeUnit</span> <span class="title">timeUnit</span>;</span></span><br><span class="line"><span class="function">    <span class="title">private</span> <span class="title">RejectPolicy</span>&lt;<span class="title">Runnable</span>&gt; <span class="title">rejectPolicy</span>;</span></span><br><span class="line"><span class="function">    //æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line"><span class="function">    <span class="title">public</span> <span class="title">void</span> <span class="title">execute</span><span class="params">(Runnable task)</span>&#123;</span></span><br><span class="line"><span class="function">        //å½“ä»»åŠ¡æ•°æ²¡æœ‰è¶…è¿‡<span class="title">coreSize</span>æ—¶ï¼Œç›´æ¥äº¤ç»™<span class="title">worker</span>å¯¹è±¡æ‰§è¡Œ</span></span><br><span class="line"><span class="function">        //å¦‚æœä»»åŠ¡æ•°è¶…è¿‡<span class="title">coreSize</span>æ—¶ï¼ŒåŠ å…¥ä»»åŠ¡é˜Ÿåˆ—æš‚å­˜</span></span><br><span class="line"><span class="function">        <span class="title">synchronized</span> <span class="params">(workers)</span>&#123;</span></span><br><span class="line"><span class="function">            <span class="title">if</span><span class="params">(workers.size()&lt;coreSize)</span>&#123;</span></span><br><span class="line"><span class="function">                <span class="title">Worker</span> <span class="title">worker</span> = <span class="title">new</span> <span class="title">Worker</span><span class="params">(task)</span>;</span></span><br><span class="line"><span class="function">                <span class="title">log</span>.<span class="title">debug</span><span class="params">(<span class="string">&quot;æ–°å¢ worker&#123;&#125;,&#123;&#125;&quot;</span>,worker,task)</span>;</span></span><br><span class="line"><span class="function">                <span class="title">workers</span>.<span class="title">add</span><span class="params">(worker)</span>;</span></span><br><span class="line"><span class="function">                <span class="title">worker</span>.<span class="title">start</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">            &#125;<span class="title">else</span>&#123;</span></span><br><span class="line"><span class="function">                <span class="title">taskQueue</span>.<span class="title">tryPut</span><span class="params">(rejectPolicy,task)</span>;</span></span><br><span class="line"><span class="function">            &#125;</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">    <span class="title">public</span> <span class="title">ThreadPool</span><span class="params">( int coreSize, long timeout, TimeUnit timeUnit,int queueCapcity,RejectPolicy&lt;Runnable&gt; rejectPolicy)</span> &#123;</span></span><br><span class="line"><span class="function">        <span class="title">this</span>.<span class="title">taskQueue</span> = <span class="title">new</span> <span class="title">BlockingQueue</span>&lt;&gt;<span class="params">(queueCapcity)</span>;</span></span><br><span class="line"><span class="function">        <span class="title">this</span>.<span class="title">coreSize</span> = <span class="title">coreSize</span>;</span></span><br><span class="line"><span class="function">        <span class="title">this</span>.<span class="title">timeout</span> = <span class="title">timeout</span>;</span></span><br><span class="line"><span class="function">        <span class="title">this</span>.<span class="title">timeUnit</span> = <span class="title">timeUnit</span>;</span></span><br><span class="line"><span class="function">        <span class="title">this</span>.<span class="title">rejectPolicy</span> = <span class="title">rejectPolicy</span>;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">    <span class="title">class</span> <span class="title">Worker</span> <span class="title">extends</span> <span class="title">Thread</span>&#123;</span></span><br><span class="line"><span class="function">        <span class="title">private</span> <span class="title">Runnable</span> <span class="title">task</span>;</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">        <span class="title">public</span> <span class="title">Worker</span><span class="params">(Runnable task)</span> &#123;</span></span><br><span class="line"><span class="function">            <span class="title">this</span>.<span class="title">task</span> = <span class="title">task</span>;</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">        <span class="title">public</span> <span class="title">void</span> <span class="title">run</span><span class="params">()</span>&#123;</span></span><br><span class="line"><span class="function">            //æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line"><span class="function">            // 1ï¼‰å½“<span class="title">task</span>ä¸ä¸ºç©ºï¼Œæ‰§è¡Œä»»åŠ¡</span></span><br><span class="line"><span class="function">            // 2ï¼‰å½“<span class="title">task</span>æ‰§è¡Œå®Œæ¯•ï¼Œå†æ¥ç€ä»ä»»åŠ¡é˜Ÿåˆ—è·å–ä»»åŠ¡</span></span><br><span class="line"><span class="function">            <span class="title">while</span><span class="params">(task !=<span class="literal">null</span> || (task = taskQueue.poll(timeout,timeUnit) )!= <span class="literal">null</span>)</span>&#123;</span></span><br><span class="line"><span class="function">                <span class="title">try</span>&#123;</span></span><br><span class="line"><span class="function">                    <span class="title">log</span>.<span class="title">debug</span><span class="params">(<span class="string">&quot;æ­£åœ¨æ‰§è¡Œ...&#123;&#125;&quot;</span>,task)</span>;</span></span><br><span class="line"><span class="function">                    <span class="title">task</span>.<span class="title">run</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">                &#125;<span class="title">catch</span><span class="params">(Exception e)</span>&#123;</span></span><br><span class="line"><span class="function">                    <span class="title">e</span>.<span class="title">printStackTrace</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">                &#125;<span class="title">finally</span> &#123;</span></span><br><span class="line"><span class="function">                    <span class="title">task</span>=<span class="title">null</span>;</span></span><br><span class="line"><span class="function">                &#125;</span></span><br><span class="line"><span class="function">            &#125;</span></span><br><span class="line"><span class="function">            <span class="title">synchronized</span> <span class="params">(workers)</span>&#123;</span></span><br><span class="line"><span class="function">                <span class="title">log</span>.<span class="title">debug</span><span class="params">(<span class="string">&quot;workerè¢«ç§»é™¤&#123;&#125;&quot;</span>,this)</span>;</span></span><br><span class="line"><span class="function">                <span class="title">workers</span>.<span class="title">remove</span><span class="params">(this)</span>;</span></span><br><span class="line"><span class="function">            &#125;</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">@<span class="title">Slf4j</span><span class="params">(topic=<span class="string">&quot;c.BlockingQueue&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">class</span> <span class="title">BlockingQueue</span>&lt;<span class="title">T</span>&gt;&#123;</span></span><br><span class="line"><span class="function">    // 1.ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line"><span class="function">    <span class="title">private</span> <span class="title">Deque</span>&lt;<span class="title">T</span>&gt; <span class="title">queue</span> = <span class="title">new</span> <span class="title">ArrayDeque</span>&lt;&gt;<span class="params">()</span>;</span></span><br><span class="line"><span class="function">    // 2.é”</span></span><br><span class="line"><span class="function">    <span class="title">private</span> <span class="title">ReentrantLock</span> <span class="title">lock</span> = <span class="title">new</span> <span class="title">ReentrantLock</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">    // 3.ç”Ÿäº§è€…æ¡ä»¶å˜é‡</span></span><br><span class="line"><span class="function">    <span class="title">private</span> <span class="title">Condition</span> <span class="title">fullWaitSet</span> = <span class="title">lock</span>.<span class="title">newCondition</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">    // 4.æ¶ˆè´¹è€…æ¡ä»¶å˜é‡</span></span><br><span class="line"><span class="function">    <span class="title">private</span> <span class="title">Condition</span> <span class="title">emptyWaitSet</span> = <span class="title">lock</span>.<span class="title">newCondition</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">    // 5.å®¹é‡</span></span><br><span class="line"><span class="function">    <span class="title">private</span> <span class="title">int</span> <span class="title">capcity</span>;</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">    <span class="title">public</span> <span class="title">BlockingQueue</span><span class="params">(int capcity)</span> &#123;</span></span><br><span class="line"><span class="function">        <span class="title">this</span>.<span class="title">capcity</span> = <span class="title">capcity</span>;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">    //å¸¦è¶…æ—¶çš„é˜»å¡è·å–</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">T</span> <span class="title">poll</span><span class="params">(long timeout, TimeUnit unit)</span>&#123;</span></span><br><span class="line"><span class="function">    <span class="title">lock</span>.<span class="title">lock</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">    <span class="title">try</span>&#123;</span></span><br><span class="line"><span class="function">        <span class="title">long</span> <span class="title">nanos</span> = <span class="title">unit</span>.<span class="title">toNanos</span><span class="params">(timeout)</span>;//å°†<span class="title">timeout</span>æ—¶é—´ç»Ÿä¸€è½¬åŒ–ä¸ºçº³ç§’</span></span><br><span class="line"><span class="function">        <span class="title">while</span><span class="params">(queue.isEmpty())</span>&#123;</span></span><br><span class="line"><span class="function">            <span class="title">try</span> &#123;</span></span><br><span class="line"><span class="function">                //æ²¡ç­‰åˆ°ç›´æ¥è¿”å›</span></span><br><span class="line"><span class="function">                <span class="title">if</span><span class="params">(nanos&lt;=<span class="number">0</span>)</span>&#123;</span></span><br><span class="line"><span class="function">                    <span class="title">return</span> <span class="title">null</span>;</span></span><br><span class="line"><span class="function">                &#125;</span></span><br><span class="line"><span class="function">                //è¿”å›çš„æ˜¯å‰©ä½™æ—¶é—´</span></span><br><span class="line"><span class="function">                <span class="title">nanos</span> = <span class="title">emptyWaitSet</span>.<span class="title">awaitNanos</span><span class="params">(nanos)</span>;</span></span><br><span class="line"><span class="function">            &#125; <span class="title">catch</span> <span class="params">(InterruptedException e)</span> &#123;</span></span><br><span class="line"><span class="function">                <span class="title">e</span>.<span class="title">printStackTrace</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">            &#125;</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">        <span class="title">T</span> <span class="title">t</span> = <span class="title">queue</span>.<span class="title">removeFirst</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">        <span class="title">fullWaitSet</span>.<span class="title">signal</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">        <span class="title">return</span> <span class="title">t</span>;</span></span><br><span class="line"><span class="function">    &#125;<span class="title">finally</span>&#123;</span></span><br><span class="line"><span class="function">        <span class="title">lock</span>.<span class="title">unlock</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">//é˜»å¡è·å–</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">T</span> <span class="title">take</span><span class="params">()</span>&#123;</span></span><br><span class="line"><span class="function">    <span class="title">lock</span>.<span class="title">lock</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">    <span class="title">try</span>&#123;</span></span><br><span class="line"><span class="function">        <span class="title">while</span><span class="params">(queue.isEmpty())</span>&#123;</span></span><br><span class="line"><span class="function">            <span class="title">try</span> &#123;</span></span><br><span class="line"><span class="function">                <span class="title">emptyWaitSet</span>.<span class="title">await</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">            &#125; <span class="title">catch</span> <span class="params">(InterruptedException e)</span> &#123;</span></span><br><span class="line"><span class="function">                <span class="title">e</span>.<span class="title">printStackTrace</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">            &#125;</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">        <span class="title">T</span> <span class="title">t</span> = <span class="title">queue</span>.<span class="title">removeFirst</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">        <span class="title">fullWaitSet</span>.<span class="title">signal</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">        <span class="title">return</span> <span class="title">t</span>;</span></span><br><span class="line"><span class="function">    &#125;<span class="title">finally</span>&#123;</span></span><br><span class="line"><span class="function">        <span class="title">lock</span>.<span class="title">unlock</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function">//é˜»å¡æ·»åŠ </span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">void</span> <span class="title">put</span><span class="params">(T task)</span>&#123;</span></span><br><span class="line"><span class="function">    <span class="title">lock</span>.<span class="title">lock</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">    <span class="title">try</span>&#123;</span></span><br><span class="line"><span class="function">        <span class="title">while</span><span class="params">(queue.size()==capcity)</span>&#123;</span></span><br><span class="line"><span class="function">            <span class="title">try</span> &#123;</span></span><br><span class="line"><span class="function">                <span class="title">log</span>.<span class="title">debug</span><span class="params">(<span class="string">&quot;ç­‰å¾…åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—&#123;&#125;...&quot;</span>,task)</span>;</span></span><br><span class="line"><span class="function">                <span class="title">fullWaitSet</span>.<span class="title">await</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">            &#125; <span class="title">catch</span> <span class="params">(InterruptedException e)</span> &#123;</span></span><br><span class="line"><span class="function">                <span class="title">e</span>.<span class="title">printStackTrace</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">            &#125;</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">        <span class="title">queue</span>.<span class="title">addLast</span><span class="params">(task)</span>;</span></span><br><span class="line"><span class="function">        <span class="title">log</span>.<span class="title">debug</span><span class="params">(<span class="string">&quot;åŠ å…¥ä»»åŠ¡é˜Ÿåˆ— &#123;&#125;&quot;</span>,task)</span>;</span></span><br><span class="line"><span class="function">        <span class="title">emptyWaitSet</span>.<span class="title">signal</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">    &#125;<span class="title">finally</span> &#123;</span></span><br><span class="line"><span class="function">        <span class="title">lock</span>.<span class="title">unlock</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function">//å¸¦è¶…æ—¶æ—¶é—´çš„é˜»å¡æ·»åŠ </span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">boolean</span> <span class="title">offer</span><span class="params">(T task,long timeout,TimeUnit timeUnit)</span>&#123;</span></span><br><span class="line"><span class="function">    <span class="title">lock</span>.<span class="title">lock</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">    <span class="title">try</span>&#123;</span></span><br><span class="line"><span class="function">        <span class="title">long</span> <span class="title">nanos</span> = <span class="title">timeUnit</span>.<span class="title">toNanos</span><span class="params">(timeout)</span>;</span></span><br><span class="line"><span class="function">        <span class="title">while</span><span class="params">(queue.size()==capcity)</span>&#123;</span></span><br><span class="line"><span class="function">            <span class="title">try</span> &#123;</span></span><br><span class="line"><span class="function">                <span class="title">log</span>.<span class="title">debug</span><span class="params">(<span class="string">&quot;ç­‰å¾…åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—&#123;&#125;...&quot;</span>,task)</span>;</span></span><br><span class="line"><span class="function">                <span class="title">if</span><span class="params">(nanos&lt;=<span class="number">0</span>)</span>&#123;</span></span><br><span class="line"><span class="function">                    <span class="title">return</span> <span class="title">false</span>;</span></span><br><span class="line"><span class="function">                &#125;</span></span><br><span class="line"><span class="function">                <span class="title">nanos</span> = <span class="title">fullWaitSet</span>.<span class="title">awaitNanos</span><span class="params">(nanos)</span>;</span></span><br><span class="line"><span class="function">            &#125; <span class="title">catch</span> <span class="params">(InterruptedException e)</span> &#123;</span></span><br><span class="line"><span class="function">                <span class="title">e</span>.<span class="title">printStackTrace</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">            &#125;</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">        <span class="title">log</span>.<span class="title">debug</span><span class="params">(<span class="string">&quot;åŠ å…¥ä»»åŠ¡é˜Ÿåˆ— &#123;&#125;&quot;</span>,task)</span>;</span></span><br><span class="line"><span class="function">        <span class="title">queue</span>.<span class="title">addLast</span><span class="params">(task)</span>;</span></span><br><span class="line"><span class="function">        <span class="title">emptyWaitSet</span>.<span class="title">signal</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">        <span class="title">return</span> <span class="title">true</span>;</span></span><br><span class="line"><span class="function">    &#125;<span class="title">finally</span> &#123;</span></span><br><span class="line"><span class="function">        <span class="title">lock</span>.<span class="title">unlock</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function">//è·å–å¤§å°</span></span><br><span class="line"><span class="function"><span class="title">public</span> <span class="title">int</span> <span class="title">size</span><span class="params">()</span>&#123;</span></span><br><span class="line"><span class="function">    <span class="title">lock</span>.<span class="title">lock</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">    <span class="title">try</span>&#123;</span></span><br><span class="line"><span class="function">        <span class="title">return</span> <span class="title">queue</span>.<span class="title">size</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">    &#125;<span class="title">finally</span> &#123;</span></span><br><span class="line"><span class="function">        <span class="title">lock</span>.<span class="title">unlock</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">    <span class="title">public</span> <span class="title">void</span> <span class="title">tryPut</span><span class="params">(RejectPolicy&lt;T&gt; rejectPolicy, T task)</span> &#123;</span></span><br><span class="line"><span class="function">        <span class="title">lock</span>.<span class="title">lock</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">        <span class="title">try</span>&#123;</span></span><br><span class="line"><span class="function">            //åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦å·²æ»¡</span></span><br><span class="line"><span class="function">            <span class="title">if</span><span class="params">(queue.size()==capcity)</span>&#123;</span></span><br><span class="line"><span class="function">                <span class="title">rejectPolicy</span>.<span class="title">reject</span><span class="params">(this,task)</span>;</span></span><br><span class="line"><span class="function">            &#125;<span class="title">else</span>&#123; //é˜Ÿåˆ—æœ‰ç©ºé—²</span></span><br><span class="line"><span class="function">                <span class="title">log</span>.<span class="title">debug</span><span class="params">(<span class="string">&quot;åŠ å…¥ä»»åŠ¡é˜Ÿåˆ— &#123;&#125;&quot;</span>,task)</span>;</span></span><br><span class="line"><span class="function">                <span class="title">queue</span>.<span class="title">addLast</span><span class="params">(task)</span>;</span></span><br><span class="line"><span class="function">                <span class="title">emptyWaitSet</span>.<span class="title">signal</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">            &#125;</span></span><br><span class="line"><span class="function">        &#125;<span class="title">finally</span>&#123;</span></span><br><span class="line"><span class="function">            <span class="title">lock</span>.<span class="title">unlock</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="äºŒã€JDKä¸ºæˆ‘ä»¬æä¾›çš„çº¿ç¨‹æ± ThreadPoolExecutor">äºŒã€JDKä¸ºæˆ‘ä»¬æä¾›çš„çº¿ç¨‹æ± ThreadPoolExecutor</h4>
<p>ThreadPoolExecutor æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p><code>ThreadPoolExecutor</code> æ˜¯ Java æä¾›çš„æœ€åŸºç¡€ã€æœ€çµæ´»çš„çº¿ç¨‹æ± å®ç°ç±»ï¼Œå‡ ä¹æ‰€æœ‰çº¿ç¨‹æ± çš„åº•å±‚å®ç°éƒ½æ˜¯åŸºäºå®ƒæ¥æ„å»ºçš„ã€‚æ¯”å¦‚ï¼š</p>
<ul>
<li><code>Executors.newFixedThreadPool()</code> å°±æ˜¯åŸºäºå®ƒåˆ›å»ºå›ºå®šçº¿ç¨‹æ± </li>
<li><code>Executors.newCachedThreadPool()</code> æ˜¯å¯ç¼“å­˜çº¿ç¨‹æ± </li>
<li><code>ScheduledThreadPoolExecutor</code> æ˜¯å®ƒçš„å­ç±»ï¼Œæ”¯æŒå®šæ—¶è°ƒåº¦ä»»åŠ¡</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1532.png" alt="img"></p>
<p>è¯´æ˜ï¼š</p>
<ul>
<li>ScheduledThreadPoolExecutoræ˜¯å¸¦è°ƒåº¦çš„çº¿ç¨‹æ± </li>
<li>ThreadPoolExecutoræ˜¯ä¸å¸¦è°ƒåº¦çš„çº¿ç¨‹æ± </li>
</ul>
<h5 id="1-çº¿ç¨‹æ± çŠ¶æ€">1.çº¿ç¨‹æ± çŠ¶æ€</h5>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1535.png" alt="img"></p>
<table>
<thead>
<tr>
<th>çŠ¶æ€å</th>
<th>é«˜3ä½</th>
<th>æ¥æ”¶æ–°ä»»åŠ¡</th>
<th>å¤„ç†é˜Ÿåˆ—ä»»åŠ¡</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>RUNNING</td>
<td>111</td>
<td>âœ…</td>
<td>âœ…</td>
<td>æ­£å¸¸è¿è¡Œä¸­</td>
</tr>
<tr>
<td>SHUTDOWN</td>
<td>000</td>
<td>âŒ</td>
<td>âœ…</td>
<td>æ‹’ç»æ–°ä»»åŠ¡ï¼Œä½†ä¼šç»§ç»­æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</td>
</tr>
<tr>
<td>STOP</td>
<td>001</td>
<td>âŒ</td>
<td>âŒ</td>
<td>æ‹’ç»æ‰€æœ‰ä»»åŠ¡ï¼Œå¹¶ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡</td>
</tr>
<tr>
<td>TIDYING</td>
<td>010</td>
<td>æ— æ„ä¹‰</td>
<td>æ— æ„ä¹‰</td>
<td>æ‰€æœ‰ä»»åŠ¡å·²æ¸…ç©ºï¼Œæ´»åŠ¨çº¿ç¨‹ä¸º 0ï¼Œå‡†å¤‡å½»åº•å…³é—­</td>
</tr>
<tr>
<td>TERMINATED</td>
<td>011</td>
<td>æ— æ„ä¹‰</td>
<td>æ— æ„ä¹‰</td>
<td>å·²å½»åº•ç»ˆæ­¢</td>
</tr>
</tbody>
</table>
<p>ä»æ•°å­—ä¸Šæ¯”è¾ƒï¼ŒTERMINATED &gt; TIDYING &gt; STOP &gt; SHUTDOWN &gt; RUNNING</p>
<p>ä¸ºä½•è¿™æ ·è®¾è®¡ï¼Ÿ</p>
<p>å°†çŠ¶æ€ä¿¡æ¯ä¸çº¿ç¨‹æ•°é‡åˆå¹¶åœ¨ä¸€èµ·ï¼ˆåŸå­å˜é‡ctlï¼‰ï¼Œå¯ä»¥é€šè¿‡ä¸€æ¬¡åŸå­æ“ä½œï¼ˆCASï¼‰åŒæ—¶æ›´æ–°çŠ¶æ€ä¸çº¿ç¨‹æ•°ï¼Œ<strong>æå‡æ€§èƒ½ï¼Œå‡å°‘åŒæ­¥æˆæœ¬</strong>ã€‚</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// c ä¸ºæ—§å€¼ï¼Œ ctlOf è¿”å›ç»“æœä¸ºæ–°å€¼</span></span><br><span class="line">ctl.<span class="built_in">compareAndSet</span>(c, <span class="built_in">ctlOf</span>(targetState, <span class="built_in">workerCountOf</span>(c))));</span><br><span class="line"><span class="comment">// rs ä¸ºé«˜ 3 ä½ä»£è¡¨çº¿ç¨‹æ± çŠ¶æ€ï¼Œ wc ä¸ºä½ 29 ä½ä»£è¡¨çº¿ç¨‹ä¸ªæ•°ï¼Œctl æ˜¯åˆå¹¶å®ƒä»¬</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="type">static</span> <span class="type">int</span> <span class="title">ctlOf</span><span class="params">(<span class="type">int</span> rs, <span class="type">int</span> wc)</span> </span>&#123; <span class="keyword">return</span> rs | wc; &#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-æ„é€ æ–¹æ³•">2.æ„é€ æ–¹æ³•</h5>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ThreadPoolExecutor(<span class="keyword">int</span> corePoolSize,</span><br><span class="line">                          <span class="keyword">int</span> maximumPoolSize,</span><br><span class="line">                          <span class="keyword">long</span> keepAliveTime,</span><br><span class="line">                          TimeUnit unit,</span><br><span class="line">                          BlockingQueue&lt;Runnable&gt; workQueue,</span><br><span class="line">                          ThreadFactory threadFactory,</span><br><span class="line">                          RejectedExecutionHandler <span class="keyword">handler</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>corePoolSize æ ¸å¿ƒçº¿ç¨‹æ•°ç›® ï¼ˆå¸¸é©»çº¿ç¨‹æ•°ï¼‰</li>
<li>maximumPoolSize æœ€å¤§çº¿ç¨‹æ•°ç›®ï¼ˆæ•‘æ€¥çº¿ç¨‹ä¸Šé™ï¼‰</li>
<li>keepAliveTime ç”Ÿå­˜æ—¶é—´ - é’ˆå¯¹æ•‘æ€¥çº¿ç¨‹ï¼ˆ<br>
æ•‘æ€¥çº¿ç¨‹å¤šä¹…æ— ä»»åŠ¡ä¼šé”€æ¯ï¼‰</li>
<li>unit æ—¶é—´å•ä½ - é’ˆå¯¹æ•‘æ€¥çº¿ç¨‹</li>
<li>workQueue é˜»å¡é˜Ÿåˆ—ï¼ˆä»»åŠ¡é˜Ÿåˆ—ï¼Œå­˜å‚¨å¾…å¤„ç†ä»»åŠ¡ï¼‰</li>
<li>threadFactory çº¿ç¨‹å·¥å‚ - å¯ä»¥ä¸ºçº¿ç¨‹åˆ›å»ºæ—¶èµ·ä¸ªå¥½åå­—ï¼ˆåˆ›å»ºçº¿ç¨‹çš„å·¥å‚ï¼Œå¸¸ç”¨äºè®¾ç½®çº¿ç¨‹åï¼‰</li>
<li>handler æ‹’ç»ç­–ç•¥ï¼ˆä»»åŠ¡æ— æ³•å¤„ç†æ—¶çš„è¡Œä¸ºï¼‰</li>
</ul>
<h5 id="3-å·¥ä½œæ–¹å¼">3.å·¥ä½œæ–¹å¼</h5>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1533.png" alt="img"></p>
<ul>
<li>çº¿ç¨‹æ± ä¸­åˆšå¼€å§‹æ²¡æœ‰çº¿ç¨‹ï¼Œå½“ä¸€ä¸ªä»»åŠ¡æäº¤ç»™çº¿ç¨‹æ± åï¼Œçº¿ç¨‹æ± ä¼šåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ã€‚</li>
<li>å½“çº¿ç¨‹æ•°è¾¾åˆ° corePoolSize å¹¶æ²¡æœ‰çº¿ç¨‹ç©ºé—²ï¼Œè¿™æ—¶å†åŠ å…¥ä»»åŠ¡ï¼Œæ–°åŠ çš„ä»»åŠ¡ä¼šè¢«åŠ å…¥workQueue é˜Ÿåˆ—æ’ é˜Ÿï¼Œç›´åˆ°æœ‰ç©ºé—²çš„çº¿ç¨‹ã€‚</li>
<li>å¦‚æœé˜Ÿåˆ—é€‰æ‹©äº†æœ‰ç•Œé˜Ÿåˆ—ï¼Œé‚£ä¹ˆä»»åŠ¡è¶…è¿‡äº†é˜Ÿåˆ—å¤§å°æ—¶ï¼Œä¼šåˆ›å»º maximumPoolSize - corePoolSize æ•°ç›®çš„çº¿ç¨‹æ¥æ•‘æ€¥ã€‚</li>
<li>å¦‚æœçº¿ç¨‹åˆ°è¾¾ maximumPoolSize ä»ç„¶æœ‰æ–°ä»»åŠ¡è¿™æ—¶ä¼šæ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚æ‹’ç»ç­–ç•¥ jdk æä¾›äº† 4 ç§å®ç°ï¼Œå…¶å®ƒè‘—åæ¡†æ¶ä¹Ÿæä¾›äº†å®ç°
<ul>
<li>AbortPolicy è®©è°ƒç”¨è€…æŠ›å‡º RejectedExecutionException å¼‚å¸¸ï¼Œè¿™æ˜¯é»˜è®¤ç­–ç•¥</li>
<li>CallerRunsPolicy è®©è°ƒç”¨è€…è¿è¡Œä»»åŠ¡</li>
<li>DiscardPolicy æ”¾å¼ƒæœ¬æ¬¡ä»»åŠ¡</li>
<li>DiscardOldestPolicy æ”¾å¼ƒé˜Ÿåˆ—ä¸­æœ€æ—©çš„ä»»åŠ¡ï¼Œæœ¬ä»»åŠ¡å–è€Œä»£ä¹‹</li>
<li>Dubbo çš„å®ç°ï¼Œåœ¨æŠ›å‡º RejectedExecutionException å¼‚å¸¸ä¹‹å‰ä¼šè®°å½•æ—¥å¿—ï¼Œå¹¶ dump çº¿ç¨‹æ ˆä¿¡æ¯ï¼Œæ–¹ ä¾¿å®šä½é—®é¢˜</li>
<li>Netty çš„å®ç°ï¼Œæ˜¯åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡</li>
<li>ActiveMQ çš„å®ç°ï¼Œå¸¦è¶…æ—¶ç­‰å¾…ï¼ˆ60sï¼‰å°è¯•æ”¾å…¥é˜Ÿåˆ—ï¼Œç±»ä¼¼æˆ‘ä»¬ä¹‹å‰è‡ªå®šä¹‰çš„æ‹’ç»ç­–ç•¥</li>
<li>PinPoint çš„å®ç°ï¼Œå®ƒä½¿ç”¨äº†ä¸€ä¸ªæ‹’ç»ç­–ç•¥é“¾ï¼Œä¼šé€ä¸€å°è¯•ç­–ç•¥é“¾ä¸­æ¯ç§æ‹’ç»ç­–ç•¥</li>
</ul>
</li>
<li>å½“é«˜å³°è¿‡å»åï¼Œè¶…è¿‡corePoolSize çš„æ•‘æ€¥çº¿ç¨‹å¦‚æœä¸€æ®µæ—¶é—´æ²¡æœ‰ä»»åŠ¡åšï¼Œéœ€è¦ç»“æŸèŠ‚çœèµ„æºï¼Œè¿™ä¸ªæ—¶é—´ç”± keepAliveTime å’Œ unit æ¥æ§åˆ¶ã€‚</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1536.png" alt="img"></p>
<p><strong>æ‹’ç»ç­–ç•¥</strong>ï¼ˆRejectedExecutionHandlerï¼‰</p>
<table>
<thead>
<tr>
<th>ç­–ç•¥å</th>
<th>è¡Œä¸ºè¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>AbortPolicyï¼ˆé»˜è®¤ï¼‰</td>
<td>æŠ›å‡º <code>RejectedExecutionException</code> å¼‚å¸¸</td>
</tr>
<tr>
<td>CallerRunsPolicy</td>
<td>ç”±æäº¤ä»»åŠ¡çš„çº¿ç¨‹ï¼ˆè°ƒç”¨è€…ï¼‰è‡ªå·±æ‰§è¡Œä»»åŠ¡</td>
</tr>
<tr>
<td>DiscardPolicy</td>
<td>ç›´æ¥ä¸¢å¼ƒè¯¥ä»»åŠ¡ï¼Œä¸æŠ›å¼‚å¸¸</td>
</tr>
<tr>
<td>DiscardOldestPolicy</td>
<td>ä¸¢å¼ƒé˜Ÿåˆ—ä¸­æœ€æ—©çš„ä»»åŠ¡ï¼Œç„¶åæ‰§è¡Œå½“å‰ä»»åŠ¡</td>
</tr>
<tr>
<td>è‡ªå®šä¹‰ç­–ç•¥</td>
<td>æ¡†æ¶å¸¸è§å®ç°ï¼Œå¦‚ï¼šDubboã€Nettyã€ActiveMQã€Pinpoint ç­‰</td>
</tr>
</tbody>
</table>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1534.png" alt="img"></p>
<p>æ ¹æ®è¿™ä¸ªæ„é€ æ–¹æ³•ï¼ŒJDK Executors ç±»ä¸­æä¾›äº†ä¼—å¤šå·¥å‚æ–¹æ³•æ¥åˆ›å»ºå„ç§ç”¨é€”çš„çº¿ç¨‹æ± ã€‚</p>
<p>Executors å·¥å‚æ–¹æ³•ï¼ˆå¿«é€Ÿåˆ›å»ºçº¿ç¨‹æ± ï¼‰</p>
<table>
<thead>
<tr>
<th>å·¥å‚æ–¹æ³•</th>
<th>å†…éƒ¨ä½¿ç”¨ ThreadPoolExecutor</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>newFixedThreadPool(n)</code></td>
<td>å›ºå®šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä»»åŠ¡å¤šæ—¶è¿›å…¥é˜Ÿåˆ—</td>
</tr>
<tr>
<td><code>newCachedThreadPool()</code></td>
<td>æ²¡æœ‰é™åˆ¶çš„çº¿ç¨‹æ± ï¼Œç©ºé—²çº¿ç¨‹ä¼šè¢«å›æ”¶</td>
</tr>
<tr>
<td><code>newSingleThreadExecutor()</code></td>
<td>å•çº¿ç¨‹æ± ï¼Œä¸²è¡Œæ‰§è¡Œä»»åŠ¡</td>
</tr>
<tr>
<td><code>newScheduledThreadPool(n)</code></td>
<td>å®šæ—¶çº¿ç¨‹æ± ï¼ˆç”¨ ScheduledThreadPoolExecutorï¼‰</td>
</tr>
</tbody>
</table>
<h5 id="4-Executors-å›ºå®šå¤§å°çº¿ç¨‹æ± newFixedThreadPool">4.Executors å›ºå®šå¤§å°çº¿ç¨‹æ± newFixedThreadPool</h5>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">static</span> ExecutorService <span class="title">newFixedThreadPool</span><span class="params">(<span class="type">int</span> nThreads)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">ThreadPoolExecutor</span>(nThreads, nThreads,</span><br><span class="line">                                  <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                  <span class="keyword">new</span> <span class="built_in">LinkedBlockingQueue</span>&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çº¿ç¨‹æ± ç‰¹æ€§</p>
<ul>
<li>æ ¸å¿ƒçº¿ç¨‹æ•° = æœ€å¤§çº¿ç¨‹æ•° = n</li>
<li>æ²¡æœ‰æ•‘æ€¥çº¿ç¨‹ï¼Œä¸æ¶‰åŠè¶…æ—¶é”€æ¯é€»è¾‘</li>
<li>é˜Ÿåˆ—ä¸ºæ— ç•Œé˜Ÿåˆ—ï¼ˆ<code>LinkedBlockingQueue</code>ï¼‰</li>
<li>æ‹’ç»ç­–ç•¥ï¼šé»˜è®¤æŠ›å¼‚å¸¸ï¼ˆ<code>AbortPolicy</code>ï¼‰</li>
</ul>
<blockquote>
<p>é€‚ç”¨åœºæ™¯</p>
<p>ä»»åŠ¡é‡å·²çŸ¥ä¸”è¾ƒé‡ï¼Œé€‚åˆæŒä¹…è¿è¡Œçš„ä»»åŠ¡å¤„ç†ï¼Œä¾‹å¦‚æ—¥å¿—è®°å½•ã€I/O ä»»åŠ¡ç­‰ã€‚</p>
</blockquote>
<h5 id="5-Executors-å¸¦ç¼“å†²çº¿ç¨‹æ± newCachedThreadPool">5. Executors å¸¦ç¼“å†²çº¿ç¨‹æ± newCachedThreadPool</h5>
<p>æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º0ï¼Œæœ€å¤§çº¿ç¨‹æ•°ä¸ºInteger.Max_VALUE</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newCachedThreadPool</span>()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">0</span>, Integer.MAX_VALUE,</span><br><span class="line">                                  <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">                                  <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç‰¹ç‚¹</p>
<ul>
<li>æ ¸å¿ƒçº¿ç¨‹æ•°æ˜¯ 0ï¼Œ æœ€å¤§çº¿ç¨‹æ•°æ˜¯ Integer.MAX_VALUEï¼Œæ•‘æ€¥çº¿ç¨‹çš„ç©ºé—²ç”Ÿå­˜æ—¶é—´æ˜¯ 60sï¼Œ
<ul>
<li>æ„å‘³ç€å…¨éƒ¨éƒ½æ˜¯æ•‘æ€¥çº¿ç¨‹ï¼ˆ60s åå¯ä»¥å›æ”¶ï¼‰</li>
<li>æ•‘æ€¥çº¿ç¨‹å¯ä»¥æ— é™åˆ›å»º</li>
</ul>
</li>
<li>é˜Ÿåˆ—é‡‡ç”¨äº† SynchronousQueue å®ç°ç‰¹ç‚¹æ˜¯ï¼Œå®ƒæ²¡æœ‰å®¹é‡ï¼Œæ²¡æœ‰çº¿ç¨‹æ¥å–æ˜¯æ”¾ä¸è¿›å»çš„ï¼ˆä¸€æ‰‹äº¤é’±ã€ä¸€æ‰‹äº¤è´§ï¼‰</li>
</ul>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">SynchronousQueue&lt;Integer&gt; integers = <span class="keyword">new</span> SynchronousQueue&lt;&gt;();</span><br><span class="line"><span class="keyword">new</span> Thread<span class="function"><span class="params">(() -&gt; &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">try</span> &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        log.debug(<span class="string">&quot;putting &#123;&#125; &quot;</span>, <span class="number">1</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">        integers.put(<span class="number">1</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">        log.debug(<span class="string">&quot;&#123;&#125; putted...&quot;</span>, <span class="number">1</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">        log.debug(<span class="string">&quot;putting...&#123;&#125; &quot;</span>, <span class="number">2</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">        integers.put(<span class="number">2</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">        log.debug(<span class="string">&quot;&#123;&#125; putted...&quot;</span>, <span class="number">2</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        e.printStackTrace();</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;,<span class="string">&quot;t1&quot;</span>)</span>.<span class="title">start</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function"><span class="title">sleep</span><span class="params">(<span class="number">1</span>)</span>;</span></span><br><span class="line"><span class="function"><span class="title">new</span> <span class="title">Thread</span><span class="params">(() -&gt; &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">try</span> &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        log.debug(<span class="string">&quot;taking &#123;&#125;&quot;</span>, <span class="number">1</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">        integers.take();</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        e.printStackTrace();</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;,<span class="string">&quot;t2&quot;</span>)</span>.<span class="title">start</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function"><span class="title">sleep</span><span class="params">(<span class="number">1</span>)</span>;</span></span><br><span class="line"><span class="function"><span class="title">new</span> <span class="title">Thread</span><span class="params">(() -&gt; &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">try</span> &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        log.debug(<span class="string">&quot;taking &#123;&#125;&quot;</span>, <span class="number">2</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">        integers.take();</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        e.printStackTrace();</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;,<span class="string">&quot;t3&quot;</span>)</span>.<span class="title">start</span><span class="params">()</span>;</span></span><br></pre></td></tr></table></figure>
<p>è¾“å‡º</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11</span>:<span class="number">48</span>:<span class="number">15.500</span> c<span class="selector-class">.TestSynchronousQueue</span> <span class="selector-attr">[t1]</span> - putting <span class="number">1</span> </span><br><span class="line"><span class="number">11</span>:<span class="number">48</span>:<span class="number">16.500</span> c<span class="selector-class">.TestSynchronousQueue</span> <span class="selector-attr">[t2]</span> - taking <span class="number">1</span> </span><br><span class="line"><span class="number">11</span>:<span class="number">48</span>:<span class="number">16.500</span> c<span class="selector-class">.TestSynchronousQueue</span> <span class="selector-attr">[t1]</span> - <span class="number">1</span> putted... </span><br><span class="line"><span class="number">11</span>:<span class="number">48</span>:<span class="number">16.500</span> c<span class="selector-class">.TestSynchronousQueue</span> <span class="selector-attr">[t1]</span> - putting...<span class="number">2</span> </span><br><span class="line"><span class="number">11</span>:<span class="number">48</span>:<span class="number">17.502</span> c<span class="selector-class">.TestSynchronousQueue</span> <span class="selector-attr">[t3]</span> - taking <span class="number">2</span> </span><br><span class="line"><span class="number">11</span>:<span class="number">48</span>:<span class="number">17.503</span> c<span class="selector-class">.TestSynchronousQueue</span> <span class="selector-attr">[t1]</span> - <span class="number">2</span> putted... </span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1538.png" alt="img"></p>
<blockquote>
<p><strong>è¯„ä»·</strong> æ•´ä¸ªçº¿ç¨‹æ± è¡¨ç°ä¸ºçº¿ç¨‹æ•°ä¼šæ ¹æ®ä»»åŠ¡é‡ä¸æ–­å¢é•¿ï¼Œæ²¡æœ‰ä¸Šé™ï¼Œå½“ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œç©ºé—² 1åˆ†é’Ÿåé‡Šæ”¾çº¿ç¨‹ã€‚ é€‚åˆä»»åŠ¡æ•°æ¯”è¾ƒå¯†é›†ï¼Œä½†æ¯ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´è¾ƒçŸ­çš„æƒ…å†µ</p>
</blockquote>
<h5 id="6-Executors-å•çº¿ç¨‹çº¿ç¨‹æ± newSingleThreadExecutor">6.Executors å•çº¿ç¨‹çº¿ç¨‹æ± <strong>newSingleThreadExecutor</strong></h5>
<p>ç‰¹æ€§è¯´æ˜ï¼š</p>
<ul>
<li>æ ¸å¿ƒçº¿ç¨‹æ•° = æœ€å¤§çº¿ç¨‹æ•° = 1</li>
<li>æ— æ•‘æ€¥çº¿ç¨‹ï¼Œçº¿ç¨‹æ­»åè‡ªåŠ¨è¡¥ä¸€ä¸ª</li>
<li>ä½¿ç”¨ <code>LinkedBlockingQueue</code>ï¼Œä»»åŠ¡ä¸²è¡Œæ’é˜Ÿ</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newSingleThreadExecutor</span>()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FinalizableDelegatedExecutorService</span><br><span class="line">        (<span class="keyword">new</span> ThreadPoolExecutor(<span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line">                                <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨åœºæ™¯ï¼š</p>
<p>å¸Œæœ›å¤šä¸ªä»»åŠ¡æ’é˜Ÿæ‰§è¡Œã€‚çº¿ç¨‹æ•°å›ºå®šä¸º 1ï¼Œä»»åŠ¡æ•°å¤šäº 1 æ—¶ï¼Œä¼šæ”¾å…¥æ— ç•Œé˜Ÿåˆ—æ’é˜Ÿã€‚ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œè¿™å”¯ä¸€çš„çº¿ç¨‹ ä¹Ÿä¸ä¼šè¢«é‡Šæ”¾ã€‚</p>
<p>åŒºåˆ«ï¼š</p>
<ul>
<li>è‡ªå·±åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœä»»åŠ¡æ‰§è¡Œå¤±è´¥è€Œç»ˆæ­¢é‚£ä¹ˆæ²¡æœ‰ä»»ä½•è¡¥æ•‘æªæ–½ï¼Œè€Œçº¿ç¨‹æ± è¿˜ä¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¿è¯æ± çš„æ­£å¸¸å·¥ä½œ</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1537.png" alt="img"></p>
<ul>
<li>Executors.newSingleThreadExecutor() çº¿ç¨‹ä¸ªæ•°å§‹ç»ˆä¸º1ï¼Œä¸èƒ½ä¿®æ”¹
<ul>
<li>FinalizableDelegatedExecutorService åº”ç”¨çš„æ˜¯è£…é¥°å™¨æ¨¡å¼ï¼Œåœ¨è°ƒç”¨æ„é€ æ–¹æ³•æ—¶å°†ThreadPoolExecutorå¯¹è±¡ä¼ ç»™äº†å†…éƒ¨çš„ExecutorServiceæ¥å£ã€‚åªå¯¹å¤–æš´éœ²äº† ExecutorService æ¥å£ï¼Œå› æ­¤ä¸èƒ½è°ƒç”¨ ThreadPoolExecutor ä¸­ç‰¹æœ‰çš„æ–¹æ³•ï¼Œä¹Ÿä¸èƒ½é‡æ–°è®¾ç½®çº¿ç¨‹æ± çš„å¤§å°ã€‚</li>
</ul>
</li>
<li>Executors.newFixedThreadPool(1) åˆå§‹æ—¶ä¸º1ï¼Œä»¥åè¿˜å¯ä»¥ä¿®æ”¹
<ul>
<li>å¯¹å¤–æš´éœ²çš„æ˜¯ ThreadPoolExecutor å¯¹è±¡ï¼Œå¯ä»¥å¼ºè½¬åè°ƒç”¨ setCorePoolSize ç­‰æ–¹æ³•è¿›è¡Œä¿®æ”¹</li>
</ul>
</li>
</ul>
<p>ä¸ºä»€ä¹ˆä½¿ç”¨ <code>FinalizableDelegatedExecutorService</code>ï¼Ÿ</p>
<ul>
<li>å®ƒåŒ…è£…äº† ThreadPoolExecutorï¼Œåªæš´éœ²å‡º <code>ExecutorService</code> æ¥å£ï¼Œ<strong>å±è”½ä¿®æ”¹çº¿ç¨‹æ•°çš„èƒ½åŠ›</strong>ï¼Œé˜²æ­¢ç”¨æˆ·ç ´åå•çº¿ç¨‹è¯­ä¹‰ã€‚</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1539.png" alt="img"></p>
<h5 id="æ€»ç»“Executors-å·¥å‚ç±»æä¾›çš„ä¸‰ç§çº¿ç¨‹æ± å·¥å…·æ–¹æ³•">æ€»ç»“<code>Executors</code> å·¥å‚ç±»æä¾›çš„ä¸‰ç§çº¿ç¨‹æ± å·¥å…·æ–¹æ³•</h5>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>æ ¸å¿ƒçº¿ç¨‹</th>
<th>æœ€å¤§çº¿ç¨‹</th>
<th>é˜Ÿåˆ—ç±»å‹</th>
<th>ç‰¹ç‚¹</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>newFixedThreadPool(n)</code></td>
<td>n</td>
<td>n</td>
<td>æ— ç•Œé˜Ÿåˆ—</td>
<td>å›ºå®šçº¿ç¨‹æ•°ï¼Œä¸ä¼šé”€æ¯çº¿ç¨‹</td>
<td>ä»»åŠ¡é‡å·²çŸ¥ã€æ‰§è¡Œæ—¶é—´è¾ƒé•¿</td>
</tr>
<tr>
<td><code>newCachedThreadPool()</code></td>
<td>0</td>
<td>âˆ</td>
<td>SynchronousQueue</td>
<td>æ•‘æ€¥çº¿ç¨‹å¤šã€ç©ºé—²é”€æ¯</td>
<td>çŸ­ä»»åŠ¡é‡å¤§ã€å¹¶å‘å‹åŠ›çªå‘</td>
</tr>
<tr>
<td><code>newSingleThreadExecutor()</code></td>
<td>1</td>
<td>1</td>
<td>æ— ç•Œé˜Ÿåˆ—</td>
<td>å•çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œï¼Œçº¿ç¨‹å¼‚å¸¸ä¼šè¢«é‡å»º</td>
<td>é¡ºåºæ‰§è¡Œä»»åŠ¡ã€ä¸²è¡Œæ—¥å¿—å†™å…¥ç­‰</td>
</tr>
</tbody>
</table>
<h5 id="7-ThreadPoolExecutor-ä¸­ä»»åŠ¡çš„æäº¤æ–¹æ³•ï¼ˆsubmit-invokeAll-invokeAnyï¼‰">7.<code>ThreadPoolExecutor</code> ä¸­ä»»åŠ¡çš„<strong>æäº¤æ–¹æ³•ï¼ˆsubmit/invokeAll/invokeAnyï¼‰</strong></h5>
<ol>
<li><code>execute(Runnable)</code> â€” æœ€ç®€å•æäº¤ä»»åŠ¡ï¼ˆæ— ç»“æœï¼‰</li>
</ol>
<ul>
<li>æ²¡æœ‰è¿”å›å€¼</li>
<li>é€‚ç”¨äºåªå…³å¿ƒä»»åŠ¡æ˜¯å¦è¿è¡Œï¼Œè€Œä¸å…³å¿ƒå…¶ç»“æœçš„æƒ…å†µ</li>
</ul>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pool.execute<span class="function"><span class="params">(() -&gt; System.out.println(<span class="string">&quot;do work&quot;</span>))</span>;</span></span><br></pre></td></tr></table></figure>
<p>2.<code>submit(Callable)</code> â€” æäº¤ä»»åŠ¡å¹¶è·å¾—ç»“æœï¼ˆFutureï¼‰</p>
<p>å¯ä½¿ç”¨ <code>future.get()</code> é˜»å¡ç­‰å¾…ç»“æœ</p>
<p>è¿”å› <code>Future&lt;T&gt;</code> å¯å¼‚æ­¥è·å–æ‰§è¡Œç»“æœ(Callableä¸Runnableçš„å·®å¼‚åœ¨äºï¼ŒCallableä¼šè¿”å›ç»“æœã€‚)</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1540.png" alt="img"></p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;<span class="built_in">String</span>&gt; future = pool.submit<span class="function"><span class="params">(() -&gt; &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    Thread.sleep(<span class="number">1000</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;)</span>;</span></span><br><span class="line"><span class="function"><span class="title">System</span>.<span class="title">out</span>.<span class="title">println</span><span class="params">(future.get())</span></span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1543.png" alt="img"></p>
<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li><code>Callable</code> æ”¯æŒè¿”å›å€¼ï¼Œä¼˜äº <code>Runnable</code></li>
<li><code>get()</code> æ–¹æ³•ä¼šé˜»å¡ç›´åˆ°ç»“æœè¿”å›ï¼Œæˆ–å¼‚å¸¸æŠ›å‡º</li>
</ul>
<p>3.<code>invokeAll(...)</code> â€” æäº¤ä¸€ç»„ä»»åŠ¡ï¼Œç­‰å¾…å…¨éƒ¨å®Œæˆ</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1541.png" alt="img"></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">List</span>&lt;Future&lt;<span class="built_in">String</span>&gt;&gt; results = pool.invokeAll(tasks);</span><br><span class="line"><span class="keyword">for</span> (Future&lt;<span class="built_in">String</span>&gt; f : results) &#123;</span><br><span class="line">    System.out.println(f.<span class="keyword">get</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1544.png" alt="img"></p>
<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ‰€æœ‰ä»»åŠ¡å¹¶å‘æ‰§è¡Œ</li>
<li>ä¼šé˜»å¡ç›´åˆ°<strong>æ‰€æœ‰ä»»åŠ¡å®Œæˆ</strong></li>
<li>å¯è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶ä»»åŠ¡ä¼šè¢«å–æ¶ˆ</li>
</ul>
<p>4.<code>invokeAny(...)</code> â€” æäº¤ä¸€ç»„ä»»åŠ¡ï¼Œè°å…ˆæˆåŠŸå°±è¿”å›è°çš„ç»“æœ</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String result <span class="operator">=</span> pool.invokeAny(tasks)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>è¿”å›<strong>ç¬¬ä¸€ä¸ªå®Œæˆçš„ä»»åŠ¡ç»“æœ</strong></li>
<li>å…¶å®ƒä»»åŠ¡å–æ¶ˆ</li>
<li>é‡åˆ°å¼‚å¸¸æˆ–å…¨éƒ¨å¤±è´¥ä¼šæŠ›å¼‚å¸¸</li>
<li>å¯è®¾ç½®è¶…æ—¶é™åˆ¶</li>
</ul>
<figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j(topic = <span class="string">&quot;c.Test1&quot;</span>)</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Test1</span> &#123;</span></span><br><span class="line">    public static void main(String[] args) throws ExecutionException,InterruptedException &#123;</span><br><span class="line">        ExecutorService pool = Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">        String result =  pool.invokeAny(Arrays.asList(</span><br><span class="line">                <span class="function"><span class="params">()</span>-&gt;</span>&#123;</span><br><span class="line">                    log.<span class="built_in">debug</span>(<span class="string">&quot;begin&quot;</span>);</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    log.<span class="built_in">debug</span>(<span class="string">&quot;end&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="function"><span class="params">()</span>-&gt;</span>&#123;</span><br><span class="line">                    log.<span class="built_in">debug</span>(<span class="string">&quot;begin&quot;</span>);</span><br><span class="line">                    Thread.sleep(<span class="number">500</span>);</span><br><span class="line">                    log.<span class="built_in">debug</span>(<span class="string">&quot;end&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;2&quot;</span>;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="function"><span class="params">()</span>-&gt;</span>&#123;</span><br><span class="line">                    log.<span class="built_in">debug</span>(<span class="string">&quot;begin&quot;</span>);</span><br><span class="line">                    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                    log.<span class="built_in">debug</span>(<span class="string">&quot;end&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;3&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        ));</span><br><span class="line">        log.<span class="built_in">debug</span>(<span class="string">&quot;&#123;&#125;&quot;</span>,result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1542.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1545.png" alt="img"></p>
<h5 id="8-çº¿ç¨‹æ± å…³é—­æœºåˆ¶">8.çº¿ç¨‹æ± å…³é—­æœºåˆ¶</h5>
<p>çº¿ç¨‹æ± ä¸€æ—¦å…³é—­ä¸èƒ½å†æäº¤ä»»åŠ¡ï¼Œå¦åˆ™æŠ›å‡º <code>RejectedExecutionException</code>ã€‚</p>
<p>1.<code>shutdown()</code> â€” å¹³ç¼“å…³é—­</p>
<ul>
<li>æ‹’ç»æ–°ä»»åŠ¡</li>
<li>æ‰§è¡Œå®Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</li>
<li>ä¸ä¼šä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹</li>
</ul>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pool.shutdown()<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1546.png" alt="img"></p>
<p>ä¸‹é¢çš„ä¾‹å­å¯ä»¥è¯´æ˜ï¼šè°ƒç”¨shutdownä¹‹åï¼Œå·²ç»æäº¤çš„ä»»åŠ¡ä¼šæ‰§è¡Œå®Œï¼Œä½†ä¸èƒ½åŠ å…¥æ–°çš„ä»»åŠ¡ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1549.png" alt="img"></p>
<p>2.<code>shutdownNow()</code> â€” ç«‹å³å¼ºåˆ¶å…³é—­</p>
<ul>
<li>æ‹’ç»æ–°ä»»åŠ¡</li>
<li>ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹</li>
<li>è¿”å›é˜Ÿåˆ—ä¸­å°šæœªæ‰§è¡Œçš„ä»»åŠ¡</li>
</ul>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Runnable&gt; pending <span class="operator">=</span> pool.shutdownNow()<span class="comment">;</span></span><br><span class="line">System.out.println(pending)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1547.png" alt="img"></p>
<p>å¦‚ä¸‹å›¾å¯è§è°ƒç”¨shutdownNowä¹‹åå·²æœ‰çš„ä»»åŠ¡ä¾¿ä¸ä¼šå†æ‰§è¡Œï¼Œä¹Ÿä¸ä¼šå†åŠ å…¥æ–°çš„ä»»åŠ¡ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1552.png" alt="img"></p>
<p>3.<code>awaitTermination(timeout)</code> â€” ç­‰å¾…çº¿ç¨‹æ± å®Œå…¨ç»ˆæ­¢</p>
<ul>
<li>é˜»å¡è°ƒç”¨çº¿ç¨‹ç›´åˆ°çº¿ç¨‹æ± å…³é—­</li>
<li>è¿”å›æ˜¯å¦åœ¨è§„å®šæ—¶é—´å†…æˆåŠŸç»ˆæ­¢</li>
</ul>
<figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pool.shutdow<span class="meta">n</span>();</span><br><span class="line">pool.awaitTerminatio<span class="meta">n</span>(5, TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1550.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1551.png" alt="img"></p>
<p>æ€»ç»“ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>ç‰¹ç‚¹</th>
<th>æ˜¯å¦é˜»å¡ä¸»çº¿ç¨‹</th>
<th>æ˜¯å¦è¿”å›ç»“æœ</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>execute()</code></td>
<td>æ— è¿”å›å€¼ï¼Œæäº¤ Runnable</td>
<td>âŒ</td>
<td>âŒ</td>
</tr>
<tr>
<td><code>submit()</code></td>
<td>è¿”å› Futureï¼Œå¯è°ƒç”¨ <code>get()</code></td>
<td>âœ…ï¼ˆé€šè¿‡ getï¼‰</td>
<td>âœ…</td>
</tr>
<tr>
<td><code>invokeAll()</code></td>
<td>ä¸€ç»„ä»»åŠ¡ï¼Œç­‰å¾…å…¨éƒ¨å®Œæˆ</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td><code>invokeAny()</code></td>
<td>ä¸€ç»„ä»»åŠ¡ï¼Œè¿”å›ç¬¬ä¸€ä¸ªæˆåŠŸç»“æœ</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
</tbody>
</table>
<p>å…³é—­æ–¹æ³•:</p>
<table>
<thead>
<tr>
<th>å…³é—­æ–¹æ³•</th>
<th>æ‹’ç»æ–°ä»»åŠ¡</th>
<th>å–æ¶ˆè¿è¡Œä¸­ä»»åŠ¡</th>
<th>ç­‰å¾…å·²æœ‰ä»»åŠ¡</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>shutdown()</code></td>
<td>âœ…</td>
<td>âŒ</td>
<td>âœ…</td>
</tr>
<tr>
<td><code>shutdownNow()</code></td>
<td>âœ…</td>
<td>âœ…</td>
<td>âŒï¼ˆç«‹å³è¿”å›ï¼‰</td>
</tr>
</tbody>
</table>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1548.png" alt="img"></p>
<h5 id="9-ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± ">9.ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± </h5>
<p>ä¸»è¦æ˜¯ <code>ScheduledExecutorService</code> çš„ä½¿ç”¨æ–¹å¼å’Œæ›¿ä»£ä¼ ç»Ÿ <code>Timer</code> çš„ä¼˜åŠ¿ã€‚</p>
<p>å®šæ—¶ä»»åŠ¡çš„å‰ä¸–ä»Šç”Ÿ</p>
<p>1.<code>java.util.Timer</code>ï¼ˆæ—©æœŸåšæ³•ï¼‰</p>
<ul>
<li>æœ€æ—©ç”¨äº JDK 1.3 ä¹‹å‰çš„å®šæ—¶ä»»åŠ¡è°ƒåº¦å·¥å…·</li>
<li>æ‰€æœ‰ä»»åŠ¡ç”±<strong>åŒä¸€ä¸ªçº¿ç¨‹é¡ºåºæ‰§è¡Œ</strong>ï¼šä¸€ä¸ªä»»åŠ¡é˜»å¡ä¼šå¯¼è‡´ä¸‹ä¸€ä¸ªä»»åŠ¡å»¶è¿Ÿ</li>
<li>æ— æ³•åº”å¯¹ä»»åŠ¡æ‰§è¡Œæ—¶é—´ä¸ç¡®å®šã€å¼‚å¸¸ç­‰å¤æ‚æƒ…å†µ</li>
</ul>
<p>æ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯ç”±åŒä¸€ä¸ªçº¿ç¨‹æ¥è°ƒåº¦ï¼Œå› æ­¤æ‰€æœ‰çš„ä»»åŠ¡éƒ½æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ã€‚</p>
<p>åªè¦å‰é¢æœ‰ä»»åŠ¡å­˜åœ¨å»¶è¿Ÿæˆ–è€…å¼‚å¸¸ï¼Œéƒ½ä¼šå½±å“åˆ°åé¢çš„ä»»åŠ¡ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1557.png" alt="img"></p>
<p>Timerçš„é—®é¢˜</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1558.png" alt="img"></p>
<p>2.ç°ä»£æ›¿ä»£ï¼š<code>ScheduledExecutorService</code></p>
<p>JDK 1.5 å¼•å…¥ï¼Œè§£å†³ <code>Timer</code> ç¼ºé™·ï¼Œæ”¯æŒçº¿ç¨‹æ± æ‰§è¡Œå®šæ—¶ä»»åŠ¡ã€‚</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ScheduledExecutorService executor <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">2</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>å¤šçº¿ç¨‹è°ƒåº¦ï¼Œäº’ä¸é˜»å¡</li>
<li>æ”¯æŒ<strong>å»¶æ—¶æ‰§è¡Œã€å‘¨æœŸæ‰§è¡Œ</strong></li>
<li>å¯è®¾ç½®å›ºå®šé€Ÿç‡æˆ–å›ºå®šå»¶è¿Ÿ</li>
</ul>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j(topic = <span class="string">&quot;c.Test1&quot;</span>)</span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">Test1</span> &#123;</span><br><span class="line">    public static <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line">        ScheduledExecutorService pool = Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line">        pool.schedule(<span class="function"><span class="params">()</span>-&gt;</span>&#123;</span><br><span class="line">            log.debug(<span class="string">&quot;task1&quot;</span>);</span><br><span class="line">            sleep(<span class="number">2</span>);</span><br><span class="line">            <span class="regexp">//</span> int i = <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">        &#125;,<span class="number">1</span>,TimeUnit.SECONDS);</span><br><span class="line">        pool.schedule(<span class="function"><span class="params">()</span>-&gt;</span>&#123;</span><br><span class="line">            log.debug(<span class="string">&quot;task2&quot;</span>);</span><br><span class="line">        &#125;,<span class="number">1</span>,TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥å‘ç°å°½ç®¡ä»»åŠ¡1å­˜åœ¨å»¶æ—¶ï¼Œä½†ä¸¤ä¸ªçº¿ç¨‹éƒ½æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ã€‚</p>
<p>3.ä¸‰ç§ä½¿ç”¨æ–¹å¼è®²è§£</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1559.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1561.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1562.png" alt="img"></p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>å¯åŠ¨å»¶æ—¶</th>
<th>é—´éš”è®¡ç®—æ–¹å¼</th>
<th>ç‰¹ç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>schedule()</code></td>
<td>âœ…</td>
<td>ä»…æ‰§è¡Œä¸€æ¬¡</td>
<td>å»¶æ—¶æ‰§è¡Œä¸€æ¬¡</td>
</tr>
<tr>
<td><code>scheduleAtFixedRate()</code></td>
<td>âœ…</td>
<td>å›ºå®šå‘¨æœŸè°ƒåº¦ï¼ˆä¸è€ƒè™‘ä»»åŠ¡æ‰§è¡Œæ—¶é—´ï¼‰</td>
<td>ä»»åŠ¡æ…¢ä¼šè¢«â€œæŒ¤å‹â€</td>
</tr>
<tr>
<td><code>scheduleWithFixedDelay()</code></td>
<td>âœ…</td>
<td>æ¯æ¬¡ä»»åŠ¡æ‰§è¡Œå®Œåå»¶è¿Ÿä¸€æ®µæ—¶é—´å†æ‰§è¡Œ</td>
<td>ä»»åŠ¡æ‰§è¡Œå®Œå†è®¡æ—¶ï¼Œç¨³å®šä¸å †ç§¯</td>
</tr>
</tbody>
</table>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1563.png" alt="img"></p>
<h5 id="10-çº¿ç¨‹æ± ä¸­å¦‚ä½•æ­£ç¡®å¤„ç†ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿçš„å¼‚å¸¸">10.<strong>çº¿ç¨‹æ± ä¸­å¦‚ä½•æ­£ç¡®å¤„ç†ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿçš„å¼‚å¸¸</strong></h5>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒJava çº¿ç¨‹æ± å¹¶ä¸ä¼šç›´æ¥æŠ›å‡ºä»»åŠ¡æ‰§è¡Œçš„å¼‚å¸¸ï¼Œè€Œæ˜¯<strong>æ‚„æ‚„â€œåæ‰â€äº†</strong>ï¼Œå¦‚æœä¸åšé¢å¤–å¤„ç†å°±ä¼šå¯¼è‡´å¼‚å¸¸â€œæ²‰æ²¡â€ï¼Œä¸åˆ©äºæ’æŸ¥ bug æˆ–åšå‡ºè¡¥å¿æœºåˆ¶ã€‚</p>
<p>1.é—®é¢˜ç°è±¡å›é¡¾</p>
<p>çº¿ç¨‹æ± ä¸­ä»»åŠ¡å‡ºé”™ï¼Œä¸ä¼šæŠ›å¼‚å¸¸ï¼Ÿ</p>
<p>å½“ä½ ç”¨çº¿ç¨‹æ± æ‰§è¡Œä»»åŠ¡ï¼Œä»»åŠ¡å†…éƒ¨æŠ›å‡ºå¼‚å¸¸æ—¶ï¼š</p>
<ul>
<li>æ§åˆ¶å°ä¸ä¼šæ˜¾ç¤ºé”™è¯¯</li>
<li>ä¸»çº¿ç¨‹ä¸ä¼šæ”¶åˆ°é€šçŸ¥</li>
<li>æ²¡æœ‰ <code>try/catch</code> æˆ– <code>get()</code> çš„è¯ï¼Œ<strong>å¼‚å¸¸å°±â€œæ¶ˆå¤±äº†â€</strong></li>
</ul>
<p>2.ä¸¤ç§æ­£ç¡®å¤„ç†æ–¹å¼</p>
<p>æ–¹æ³•ä¸€ï¼šä¸»åŠ¨åœ¨ä»»åŠ¡ä¸­ <code>try-catch</code> æ•è·å¼‚å¸¸</p>
<p>è¿™æ˜¯æœ€ç›´æ¥ã€æ¨èçš„æ–¹å¼ã€‚</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService pool = Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">pool.submit(() -&gt; &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        <span class="keyword">log</span>.debug(<span class="string">&quot;task1&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">1</span> / <span class="number">0</span>; <span class="comment">// æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">log</span>.<span class="keyword">error</span>(<span class="string">&quot;error:&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>è¾“å‡º</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[pool-1-thread-1]</span> - task1</span><br><span class="line"><span class="selector-attr">[pool-1-thread-1]</span> - error:</span><br><span class="line">java<span class="selector-class">.lang</span><span class="selector-class">.ArithmeticException</span>: / by zero</span><br></pre></td></tr></table></figure>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>èƒ½çœ‹åˆ°é”™è¯¯å †æ ˆ</li>
<li>å¯è¿›è¡Œæ—¥å¿—è®°å½•ã€æŠ¥è­¦ã€é‡è¯•ç­‰å¤„ç†</li>
<li>æœ€é€šç”¨ã€æœ€çµæ´»çš„æ–¹å¼</li>
</ul>
<p>æ–¹æ³•äºŒï¼šå€ŸåŠ© <code>Future.get()</code> æ•è·å¼‚å¸¸</p>
<p>é€‚ç”¨äºä½ é€šè¿‡ <code>submit()</code> æäº¤ä»»åŠ¡ï¼Œå¹¶å¸Œæœ›åœ¨ä¸»çº¿ç¨‹ä¸­ç»Ÿä¸€å¤„ç†å¼‚å¸¸çš„åœºæ™¯ã€‚</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;<span class="built_in">Boolean</span>&gt; f = pool.submit<span class="function"><span class="params">(() -&gt; &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    log.debug(<span class="string">&quot;task1&quot;</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">    int i = <span class="number">1</span> / <span class="number">0</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">return</span> <span class="literal">true</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;)</span>;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">log</span>.<span class="title">debug</span><span class="params">(<span class="string">&quot;result:&#123;&#125;&quot;</span>, f.get())</span>;  // ä¼šæŠ›å‡ºå¼‚å¸¸</span></span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºï¼š</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[pool-1-thread-1]</span> - task1</span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;main&quot;</span> java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ExecutionException</span>:</span><br><span class="line">java<span class="selector-class">.lang</span><span class="selector-class">.ArithmeticException</span>: / by zero</span><br></pre></td></tr></table></figure>
<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>å¦‚æœä»»åŠ¡æŠ›å¼‚å¸¸ï¼Œ<code>Future.get()</code> ä¼šåŒ…è£…æˆ <code>ExecutionException</code> æŠ›å‡º</li>
<li>å¯ä»¥åœ¨è°ƒç”¨ <code>get()</code> çš„åœ°æ–¹ç»Ÿä¸€å¤„ç†å¼‚å¸¸</li>
</ul>
<p>æ³¨æ„ï¼š</p>
<p>è‹¥ lambda ä¸­<strong>æ²¡æœ‰è¿”å›å€¼</strong>ï¼Œå°±ä¸ä¼šè‡ªåŠ¨è¯†åˆ«ä¸º <code>Callable</code>ï¼Œé‚£è¿”å›çš„ <code>Future</code> å®é™…ä¸Šæ²¡æ³•è·å–åˆ°å¼‚å¸¸ã€‚</p>
<p>3.æ€»ç»“</p>
<table>
<thead>
<tr>
<th>æ–¹å¼</th>
<th>æ˜¯å¦èƒ½çœ‹åˆ°å¼‚å¸¸</th>
<th>å¼‚å¸¸å¤„ç†ä½ç½®</th>
<th>æ¨èåœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>try-catch åŒ…è£¹ä»»åŠ¡ä½“</td>
<td>âœ…</td>
<td>ä»»åŠ¡çº¿ç¨‹å†…éƒ¨</td>
<td>æ—¥å¿—è®°å½•ã€è¡¥å¿é€»è¾‘ç­‰éœ€è¦</td>
</tr>
<tr>
<td>Future.get() æ•è·</td>
<td>âœ…</td>
<td>æäº¤ä»»åŠ¡çš„ä¸»çº¿ç¨‹</td>
<td>å¤šä»»åŠ¡æ‰¹é‡å¤„ç†ç»Ÿä¸€å¼‚å¸¸æ±‡æ€»</td>
</tr>
<tr>
<td>ä¸åšä»»ä½•å¤„ç†</td>
<td>âŒ</td>
<td>æ— æ³•è·å–</td>
<td>éæ¨èæ–¹å¼ï¼Œä¼šå¯¼è‡´â€œå¼‚å¸¸æ²‰æ²¡â€</td>
</tr>
</tbody>
</table>
<p>4.å»ºè®®</p>
<ol>
<li>æ‰€æœ‰é€šè¿‡çº¿ç¨‹æ± æ‰§è¡Œçš„ä»»åŠ¡ï¼Œ<strong>éƒ½åº”ä¿è¯å¼‚å¸¸è¢«æ˜¾å¼å¤„ç†</strong></li>
<li>å¦‚æœæ˜¯å¹¶å‘åœºæ™¯ï¼Œæ¨èç»“åˆ <code>Future.get()</code> åšç»Ÿä¸€å¼‚å¸¸æ§åˆ¶å’Œèšåˆ</li>
<li>å¤æ‚ç³»ç»Ÿä¸­ï¼Œå¯å°è£…ç»Ÿä¸€çš„çº¿ç¨‹æ± æäº¤å·¥å…·ç±»ï¼Œå†…éƒ¨ç»Ÿä¸€æ•è·/è®°å½•å¼‚å¸¸</li>
</ol>
<h5 id="11-åº”ç”¨ä¹‹å®šæ—¶ä»»åŠ¡">11.åº”ç”¨ä¹‹å®šæ—¶ä»»åŠ¡</h5>
<p>å¦‚ä½•è®©æ¯å‘¨å›› 18:00:00 å®šæ—¶æ‰§è¡Œä»»åŠ¡ï¼Ÿ</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å¾—å½“å‰æ—¶é—´</span></span><br><span class="line">LocalDateTime <span class="built_in">now</span> = LocalDateTime.<span class="built_in">now</span>();</span><br><span class="line"><span class="comment">// è·å–æœ¬å‘¨å›› 18:00:00.000</span></span><br><span class="line">LocalDateTime thursday = </span><br><span class="line">     <span class="built_in">now</span>.with(DayOfWeek.THURSDAY).withHour(<span class="number">18</span>).withMinute(<span class="number">0</span>).withSecond(<span class="number">0</span>).withNano(<span class="number">0</span>);</span><br><span class="line"><span class="comment">// å¦‚æœå½“å‰æ—¶é—´å·²ç»è¶…è¿‡ æœ¬å‘¨å›› 18:00:00.000ï¼Œ é‚£ä¹ˆæ‰¾ä¸‹å‘¨å›› 18:00:00.000</span></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">now</span>.compareTo(thursday) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    thursday = thursday.plusWeeks(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è®¡ç®—æ—¶é—´å·®ï¼Œå³å»¶æ—¶æ‰§è¡Œæ—¶é—´</span></span><br><span class="line">long initialDelay = Duration.between(<span class="built_in">now</span>, thursday).toMillis();</span><br><span class="line"><span class="comment">// è®¡ç®—é—´éš”æ—¶é—´ï¼Œå³ 1 å‘¨çš„æ¯«ç§’å€¼</span></span><br><span class="line">long oneWeek = <span class="number">7</span> * <span class="number">24</span> * <span class="number">3600</span> * <span class="number">1000</span>;</span><br><span class="line">ScheduledExecutorService executor = Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;å¼€å§‹æ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">executor.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;æ‰§è¡Œæ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="built_in">Date</span>());</span><br><span class="line">&#125;, initialDelay, oneWeek, TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1564.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1565.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1566.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1567.png" alt="img"></p>
<h5 id="12-Tomcat-çº¿ç¨‹æ± ">12.Tomcat çº¿ç¨‹æ± </h5>
<p>1.Tomcat ä¸­çº¿ç¨‹æ± çš„æ•´ä½“æ¶æ„</p>
<p>Tomcat åœ¨å“ªé‡Œç”¨åˆ°äº†çº¿ç¨‹æ± å‘¢</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1570-1024x237.png" alt="img"></p>
<p>æ¨¡å—è§’è‰²è¯´æ˜ï¼š</p>
<table>
<thead>
<tr>
<th>æ¨¡å—</th>
<th>èŒè´£è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Acceptor</code></td>
<td>åªè´Ÿè´£<strong>æ¥æ”¶ socket è¿æ¥</strong>ï¼ˆç›‘å¬ç«¯å£ï¼‰</td>
</tr>
<tr>
<td><code>Poller</code></td>
<td>ç›‘å¬è¿æ¥çš„ I/O äº‹ä»¶ï¼ˆæ˜¯å¦å¯è¯»ï¼‰ï¼ŒåŸºäº NIO</td>
</tr>
<tr>
<td><code>Executor</code></td>
<td>çº¿ç¨‹æ± ï¼Œè´Ÿè´£çœŸæ­£<strong>å¤„ç†è¯·æ±‚é€»è¾‘</strong>ï¼ˆservlet è°ƒç”¨ç­‰ï¼‰</td>
</tr>
</tbody>
</table>
<p>å›¾ä¸­æµç¨‹è¯´æ˜ï¼š</p>
<ol>
<li>ç”¨æˆ·è¿æ¥å‘èµ·è¯·æ±‚</li>
<li><code>Acceptor</code> æ¥æ”¶è¿æ¥</li>
<li><code>Poller</code> å‘ç°å¯è¯»ï¼Œå°è£…ä¸º <code>SocketProcessor</code></li>
<li>æäº¤ <code>SocketProcessor</code> åˆ° <code>Executor</code> çº¿ç¨‹æ± </li>
<li>çº¿ç¨‹æ± ä¸­å·¥ä½œçº¿ç¨‹å¤„ç†ä¸šåŠ¡é€»è¾‘</li>
</ol>
<ul>
<li>LimitLatch ç”¨æ¥é™æµï¼Œå¯ä»¥æ§åˆ¶æœ€å¤§è¿æ¥ä¸ªæ•°ï¼Œç±»ä¼¼ J.U.C ä¸­çš„ Semaphore åé¢å†è®²</li>
<li>Acceptor åªè´Ÿè´£ã€æ¥æ”¶æ–°çš„ socket è¿æ¥ã€‘</li>
<li>Poller åªè´Ÿè´£ç›‘å¬ socket channel æ˜¯å¦æœ‰ã€å¯è¯»çš„ I/O äº‹ä»¶ã€‘</li>
<li>ä¸€æ—¦å¯è¯»ï¼Œå°è£…ä¸€ä¸ªä»»åŠ¡å¯¹è±¡ï¼ˆsocketProcessorï¼‰ï¼Œæäº¤ç»™ Executor çº¿ç¨‹æ± å¤„ç†</li>
<li>Executor çº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹æœ€ç»ˆè´Ÿè´£ã€å¤„ç†è¯·æ±‚ã€‘</li>
</ul>
<p>2.Tomcat çš„çº¿ç¨‹æ± è¡Œä¸ºç‰¹ç‚¹</p>
<p>Tomcat çš„ <code>Executor</code> æœ¬è´¨ä¸Šæ˜¯å¯¹ <code>ThreadPoolExecutor</code> çš„æ‰©å±•</p>
<p>è¡Œä¸ºç¨æœ‰ä¸åŒï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1571.png" alt="img"></p>
<p>ç›¸å…³æºç åˆ†æï¼š</p>
<p>æºç  tomcat-7.0.42</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command, <span class="type">long</span> timeout, TimeUnit unit)</span> &#123;</span><br><span class="line">    submittedCount.incrementAndGet();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.execute(command);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RejectedExecutionException rx) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">super</span>.getQueue() <span class="keyword">instanceof</span> TaskQueue) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">TaskQueue</span> <span class="variable">queue</span> <span class="operator">=</span> (TaskQueue)<span class="built_in">super</span>.getQueue();</span><br><span class="line">            <span class="comment">// å°è¯•å†æ¬¡å¼ºè¡Œæ”¾å…¥é˜Ÿåˆ—</span></span><br><span class="line">            <span class="keyword">if</span> (!queue.force(command, timeout, unit)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RejectedExecutionException</span>(<span class="string">&quot;Queue capacity is full.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> rx;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>é‡ç‚¹ç†è§£ï¼š</strong></p>
<ul>
<li><code>force()</code> æ˜¯ Tomcat ç‰¹æœ‰é€»è¾‘ï¼Œä¸æ˜¯ Java åŸç”Ÿçº¿ç¨‹æ± çš„é»˜è®¤è¡Œä¸º</li>
<li>å®ƒå¯ä»¥é¿å…è¯·æ±‚é«˜å³°æ—¶ä»»åŠ¡è¢«ç›´æ¥æ‹’ç»ï¼Œæé«˜ç³»ç»Ÿçš„<strong>é²æ£’æ€§å’ŒæœåŠ¡æ‰¿è½½èƒ½åŠ›</strong></li>
</ul>
<p>3.è¿æ¥å™¨ Connector é…ç½®è§£æ</p>
<p>Tomcat é€šè¿‡ <code>&lt;Connector&gt;</code> å’Œ <code>&lt;Executor&gt;</code> è¿›è¡Œçº¿ç¨‹æ± é…ç½®ã€‚</p>
<p>Connector ä¸­å¯è°ƒå‚æ•°ï¼ˆç®€ç‰ˆï¼‰</p>
<table>
<thead>
<tr>
<th>é…ç½®é¡¹</th>
<th>é»˜è®¤å€¼</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>acceptorThreadCount</code></td>
<td>1</td>
<td>è´Ÿè´£ accept socket çš„çº¿ç¨‹æ•°é‡</td>
</tr>
<tr>
<td><code>pollerThreadCount</code></td>
<td>1</td>
<td>è´Ÿè´£ç›‘å¬ socket channel çš„çº¿ç¨‹æ•°</td>
</tr>
<tr>
<td><code>minSpareThreads</code></td>
<td>10</td>
<td>æ ¸å¿ƒçº¿ç¨‹æ•°ï¼ˆcorePoolSizeï¼‰</td>
</tr>
<tr>
<td><code>maxThreads</code></td>
<td>200</td>
<td>æœ€å¤§çº¿ç¨‹æ•°ï¼ˆmaximumPoolSizeï¼‰</td>
</tr>
<tr>
<td><code>executor</code></td>
<td>-</td>
<td>å¯¹åº”çš„ Executor åç§°</td>
</tr>
</tbody>
</table>
<p>Executor ä¸­å¯è°ƒå‚æ•°ï¼ˆé«˜çº§é…ç½®ï¼‰</p>
<table>
<thead>
<tr>
<th>é…ç½®é¡¹</th>
<th>é»˜è®¤å€¼</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>threadPriority</code></td>
<td>5</td>
<td>çº¿ç¨‹ä¼˜å…ˆçº§</td>
</tr>
<tr>
<td><code>deamon</code></td>
<td>true</td>
<td>æ˜¯å¦å®ˆæŠ¤çº¿ç¨‹</td>
</tr>
<tr>
<td><code>minSpareThreads</code></td>
<td>25</td>
<td>æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå³corePoolSize</td>
</tr>
<tr>
<td><code>maxThreads</code></td>
<td>200</td>
<td>æœ€å¤§çº¿ç¨‹æ•°ï¼Œå³ maximumPoolSize</td>
</tr>
<tr>
<td><code>maxIdleTime</code></td>
<td>60000</td>
<td>çº¿ç¨‹ç”Ÿå­˜æ—¶é—´ï¼ˆ çº¿ç¨‹é—²ç½®å¤šä¹…å¯å›æ”¶ï¼‰ï¼Œå•ä½æ˜¯æ¯«ç§’ï¼Œé»˜è®¤å€¼å³ 1 åˆ†é’Ÿ</td>
</tr>
<tr>
<td><code>maxQueueSize</code></td>
<td>Integer.MAX_VALUE</td>
<td>ä»»åŠ¡é˜Ÿåˆ—å®¹é‡ï¼ˆé»˜è®¤æ— é™ï¼‰</td>
</tr>
<tr>
<td><code>prestartminSpareThreads</code></td>
<td>false</td>
<td>æ˜¯å¦åœ¨å¯åŠ¨æ—¶é¢„çƒ­æ ¸å¿ƒçº¿ç¨‹</td>
</tr>
</tbody>
</table>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1569.png" alt="img"></p>
<p>å›¾ä¸­å±•ç¤ºçš„æ˜¯ Tomcat è¯·æ±‚åˆ°è¾¾åçš„å¤„ç†æµç¨‹ï¼š</p>
<ol>
<li>å®¢æˆ·ç«¯å‘èµ·è¿æ¥</li>
<li>Acceptor æ¥æ”¶åä¼ ç»™ Poller</li>
<li>Poller ç›‘å¬è¯»äº‹ä»¶åå°†ä»»åŠ¡åŒ…è£…ä¸º <code>SocketProcessor</code></li>
<li>æäº¤åˆ°çº¿ç¨‹æ± ï¼ˆExecutorï¼‰</li>
<li>çº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹å¼€å§‹æ‰§è¡Œå®é™…çš„ Servlet å¤„ç†é€»è¾‘</li>
</ol>
<p>æ•´ä¸ªæ¨¡å‹ä½“ç°äº†<strong>è§£è€¦ + é«˜å¹¶å‘åˆ†å·¥</strong>çš„æ€æƒ³ã€‚</p>
<p>4.æ€»ç»“</p>
<table>
<thead>
<tr>
<th>æ¨¡å—</th>
<th>ä½œç”¨</th>
<th>ç‰¹ç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Acceptor</code></td>
<td>åªæ¥è¿æ¥</td>
<td>éé˜»å¡ï¼Œé«˜æ€§èƒ½</td>
</tr>
<tr>
<td><code>Poller</code></td>
<td>NIOç›‘å¬ï¼Œè§¦å‘äº‹ä»¶</td>
<td>I/O çº¿ç¨‹</td>
</tr>
<tr>
<td><code>Executor</code></td>
<td>çœŸæ­£ä¸šåŠ¡å¤„ç†</td>
<td>å¯è°ƒçº¿ç¨‹æ± ï¼Œæ”¯æŒæ‹’ç»ç­–ç•¥ä¼˜åŒ–</td>
</tr>
</tbody>
</table>
<p><strong>Tomcat çš„çº¿ç¨‹æ± ä¸ä»…æ”¯æŒæ ¸å¿ƒçº¿ç¨‹æ± æ‰©å®¹æœºåˆ¶</strong>ï¼Œè¿˜æ”¯æŒé€šè¿‡ <code>force()</code> å¢å¼ºå®¹é”™èƒ½åŠ›ï¼Œéå¸¸é€‚åˆå¤§å¹¶å‘åœºæ™¯ã€‚</p>
<h4 id="ä¸‰ã€Fork-Join">ä¸‰ã€Fork/Join</h4>
<h5 id="1-Fork-Joinæ¦‚å¿µ">1.Fork/Joinæ¦‚å¿µ</h5>
<p>Fork/Join æ˜¯ JDK 1.7 åŠ å…¥çš„æ–°çš„çº¿ç¨‹æ± å®ç°ï¼Œå®ƒä½“ç°çš„æ˜¯ä¸€ç§åˆ†æ²»æ€æƒ³ï¼Œé€‚ç”¨äºèƒ½å¤Ÿè¿›è¡Œä»»åŠ¡æ‹†åˆ†çš„ cpu å¯†é›†å‹è¿ç®—</p>
<p><strong>Fork/Join</strong> æ˜¯ Java æä¾›çš„ä¸€ç§<strong>åˆ†æ²»å¹¶å‘ç¼–ç¨‹æ¨¡å‹</strong>ï¼Œé€šè¿‡å°†ä¸€ä¸ªå¤§ä»»åŠ¡é€’å½’æ‹†åˆ†æˆå¤šä¸ªå°ä»»åŠ¡å¹¶è¡Œæ‰§è¡Œï¼Œæœ€ååˆå¹¶ç»“æœï¼Œæé«˜æ•ˆç‡ã€‚</p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>åˆ†æ²»æ€æƒ³</td>
<td>å°†å¤§ä»»åŠ¡åˆ†è§£æˆå­ä»»åŠ¡ï¼Œé€’å½’æ‰§è¡Œ</td>
</tr>
<tr>
<td>å¤šçº¿ç¨‹å¹¶è¡Œ</td>
<td>æ¯ä¸ªå­ä»»åŠ¡å¯ä»¥å¹¶è¡Œæ‰§è¡Œ</td>
</tr>
<tr>
<td>å·¥ä½œçªƒå–ç®—æ³•</td>
<td>ç©ºé—²çº¿ç¨‹ä¼šä»å…¶ä»–çº¿ç¨‹å·ä»»åŠ¡åšï¼Œæé«˜èµ„æºåˆ©ç”¨ç‡</td>
</tr>
<tr>
<td>è‡ªåŠ¨ä»»åŠ¡è°ƒåº¦</td>
<td>çº¿ç¨‹æ± è‡ªåŠ¨è°ƒåº¦ä»»åŠ¡æ‰§è¡Œï¼Œå¼€å‘è€…æ— éœ€å¹²é¢„</td>
</tr>
</tbody>
</table>
<h5 id="2-åº”ç”¨ä¹‹æ±‚å’Œ">2.åº”ç”¨ä¹‹æ±‚å’Œ</h5>
<p>äº¤ç»™ Fork/Join çº¿ç¨‹æ± çš„ä»»åŠ¡éœ€è¦ç»§æ‰¿ RecursiveTaskï¼ˆæœ‰è¿”å›å€¼ï¼‰æˆ– RecursiveActionï¼ˆæ²¡æœ‰è¿”å›å€¼ï¼‰ï¼Œä¾‹å¦‚ä¸‹ é¢å®šä¹‰äº†ä¸€ä¸ªå¯¹ 1~n ä¹‹é—´çš„æ•´æ•°æ±‚å’Œçš„ä»»åŠ¡</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1574.png" alt="img"></p>
<p>ç»“æœ</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1575.png" alt="img"></p>
<p>ç”¨å›¾æ¥è¡¨ç¤º</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1572.png" alt="img"></p>
<ul>
<li>æ¯æ¬¡æ‹†ä¸€ä¸ªå­ä»»åŠ¡ï¼ˆæ·±åº¦é€’å½’ï¼‰</li>
<li>å½¢æˆä¸€æ¡é•¿é“¾ï¼Œä¸åˆ©äºå¹¶å‘</li>
</ul>
<p>é—®é¢˜ï¼š</p>
<p>è¿™ä¸ªç‰ˆæœ¬è™½ç„¶ç”¨äº† fork/joinï¼Œä½†<strong>æ¯æ¬¡åª fork ä¸€ä¸ªå­ä»»åŠ¡</strong>ï¼Œçº¿ç¨‹åˆ©ç”¨ç‡ä¸é«˜ï¼Œå¤šæ ¸ CPU éš¾ä»¥å‘æŒ¥ã€‚</p>
<p>ä¼˜åŒ–ç‰ˆæœ¬ï¼šåŒºé—´åˆ’åˆ†é€’å½’ï¼ˆAddTask3ï¼‰</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1576.png" alt="img"></p>
<p>ç”¨å›¾æ¥è¡¨ç¤º</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1573.png" alt="img"></p>
<ul>
<li>æ¯æ¬¡æ‹†æˆä¸¤åŠï¼ˆå¹³è¡¡é€’å½’ï¼‰</li>
<li>æ„æˆäºŒå‰æ ‘çŠ¶ï¼Œçº¿ç¨‹å¯å¹¶å‘æ‰§è¡Œå·¦å³å­ä»»åŠ¡ï¼Œæ•ˆç‡æ›´é«˜</li>
</ul>
<h3 id="è¡¥å……ï¼šå¼‚æ­¥æ¨¡å¼ä¹‹å·¥ä½œçº¿ç¨‹æ¨¡å¼">è¡¥å……ï¼šå¼‚æ­¥æ¨¡å¼ä¹‹å·¥ä½œçº¿ç¨‹æ¨¡å¼</h3>
<p>é‡ç‚¹åœ¨äºï¼š</p>
<ul>
<li>å·¥ä½œçº¿ç¨‹çš„åŸºæœ¬æ€æƒ³</li>
<li>é¥¥é¥¿é—®é¢˜çš„å‡ºç°åŠç¤ºä¾‹</li>
<li>çº¿ç¨‹æ± åˆ†å·¥çš„ä¼˜åŒ–æ–¹æ¡ˆ</li>
<li>å¦‚ä½•æ ¹æ®ä»»åŠ¡ç±»å‹ï¼ˆCPUå¯†é›†å‹ vs I/Oå¯†é›†å‹ï¼‰åˆç†é…ç½®çº¿ç¨‹æ± å¤§å°</li>
</ul>
<h4 id="1-ä»€ä¹ˆæ˜¯-Worker-Thread-æ¨¡å¼ï¼Ÿ">1.ä»€ä¹ˆæ˜¯ Worker Thread æ¨¡å¼ï¼Ÿ</h4>
<p>å®šä¹‰ï¼š</p>
<blockquote>
<p><strong>è®©æœ‰é™æ•°é‡çš„å·¥ä½œçº¿ç¨‹è½®æµå¤„ç†æ— é™çš„ä»»åŠ¡</strong>ã€‚</p>
</blockquote>
<p>è¿™æ˜¯çº¿ç¨‹æ± ï¼ˆ<code>ThreadPoolExecutor</code>ï¼‰çš„æ ¸å¿ƒæ€æƒ³ï¼Œä¹Ÿæ˜¯<strong>ä¸€ç§èµ„æºå¤ç”¨ã€ä»»åŠ¡åˆ†å‘çš„ç»å…¸è®¾è®¡æ¨¡å¼</strong>ã€‚</p>
<ul>
<li>æ¯ä¸ªè¯·æ±‚ä¸å†é…å¤‡ä¸€ä¸ªçº¿ç¨‹ï¼ˆé‚£æ ·å¤ªæµªè´¹ï¼‰</li>
<li>è€Œæ˜¯é€šè¿‡çº¿ç¨‹æ± çš„å‡ ä¸ªçº¿ç¨‹<strong>é‡å¤å¤ç”¨</strong>ï¼Œè½®æµå¤„ç†ä»»åŠ¡</li>
<li>ç±»ä¼¼â€œæœåŠ¡å‘˜â€è½®æµä¸ºä¸åŒçš„é¡¾å®¢ç‚¹é¤</li>
</ul>
<p>ä¸¾ä¾‹ç±»æ¯”ï¼š</p>
<ul>
<li>æµ·åº•æåªæœ‰å‡ ä¸ªæœåŠ¡å‘˜ï¼ˆçº¿ç¨‹ï¼‰</li>
<li>å®¢äººå¾ˆå¤šï¼ˆä»»åŠ¡ï¼‰</li>
<li>æœåŠ¡å‘˜è½®æµæ¥å¾…ï¼Œå®Œæˆâ€œç‚¹é¤ â†’ ä¸Šèœâ€çš„æ•´ä¸ªæµç¨‹</li>
</ul>
<h4 id="2-é¥¥é¥¿é—®é¢˜ï¼ˆDeadlock-like-starvationï¼‰">2.é¥¥é¥¿é—®é¢˜ï¼ˆDeadlock-like starvationï¼‰</h4>
<p>é—®é¢˜å¼•å…¥ï¼š</p>
<p>ä½ å®šä¹‰äº†ä¸€ä¸ª<strong>å›ºå®šå¤§å°çš„çº¿ç¨‹æ± </strong>ï¼Œå‡è®¾çº¿ç¨‹æ•°æ˜¯ 2ã€‚</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService executorService <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>ä½ è®¾è®¡çš„å·¥ä½œæµæ˜¯ï¼š</p>
<ul>
<li>çº¿ç¨‹ Aï¼šå¤„ç†â€œç‚¹é¤â€ä»»åŠ¡ï¼Œå¹¶æäº¤â€œåšèœâ€ä»»åŠ¡ï¼ˆå†ç”±å…¶ä»–çº¿ç¨‹åšï¼‰</li>
<li>ç‚¹é¤çº¿ç¨‹ç­‰å¾…â€œåšèœâ€ä»»åŠ¡çš„ç»“æœï¼ˆè°ƒç”¨ <code>.get()</code>ï¼‰</li>
<li>å¦‚æœæ­¤æ—¶ä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨åšâ€œç‚¹é¤â€ä»»åŠ¡ï¼Œé‚£ä¹ˆå°±<strong>æ²¡äººèƒ½åšèœäº†</strong> â€”â€”&gt; é¥¥é¥¿ï¼</li>
</ul>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j(topic = <span class="string">&quot;c.Test1&quot;</span>)</span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">Test1</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> final List&lt;<span class="built_in">String</span>&gt; MENU=Arrays.asList(<span class="string">&quot;åœ°ä¸‰é²œ&quot;</span>,<span class="string">&quot;å®«ä¿é¸¡ä¸&quot;</span>,<span class="string">&quot;è¾£å­é¸¡ä¸&quot;</span>,<span class="string">&quot;çƒ¤é¸¡ç¿…&quot;</span>);</span><br><span class="line">    <span class="keyword">static</span> Random RANDOM = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">String</span> cooking()&#123;</span><br><span class="line">        <span class="keyword">return</span> MENU.get(RANDOM.nextInt(MENU.size()));</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="keyword">static</span> <span class="literal">void</span> main(<span class="built_in">String</span>[] args) throws ExecutionException,InterruptedException &#123;</span><br><span class="line">        ExecutorService pool = Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">        pool.execute<span class="function"><span class="params">(()-&gt;&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            log.debug(<span class="string">&quot;å¤„ç†ç‚¹é¤...&quot;</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">            Future&lt;<span class="built_in">String</span>&gt; f=pool.submit(()-&gt;&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                log.debug(<span class="string">&quot;åšèœ&quot;</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">return</span> cooking();</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;);</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">try</span>&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                log.debug(<span class="string">&quot;ä¸Šèœï¼š&#123;&#125;&quot;</span>,f.get());</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;<span class="keyword">catch</span> (InterruptedException|ExecutionException e)&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                e.printStackTrace();</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">        &#125;)</span>;</span></span><br><span class="line"><span class="function">        <span class="title">pool</span>.<span class="title">execute</span><span class="params">(()-&gt;&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            log.debug(<span class="string">&quot;å¤„ç†ç‚¹é¤...&quot;</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">            Future&lt;<span class="built_in">String</span>&gt; f=pool.submit(()-&gt;&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                log.debug(<span class="string">&quot;åšèœ&quot;</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">return</span> cooking();</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;);</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">try</span>&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                log.debug(<span class="string">&quot;ä¸Šèœï¼š&#123;&#125;&quot;</span>,f.get());</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;<span class="keyword">catch</span> (InterruptedException|ExecutionException e)&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                e.printStackTrace();</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">        &#125;)</span>;</span></span><br><span class="line"><span class="function"> </span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<p>ä¸€ä¸ªå®¢äººå¯ä»¥å®Œç¾å¤„ç†ï¼Œ2ä¸ªå®¢äººå°±å¤„ç†ä¸åŠ¨äº†ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1553.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1554.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1555.png" alt="img"></p>
<h4 id="3-è§£å†³æ–¹æ¡ˆï¼šä»»åŠ¡åˆ†ç±»ï¼Œçº¿ç¨‹æ± åˆ†å·¥">3.è§£å†³æ–¹æ¡ˆï¼šä»»åŠ¡åˆ†ç±»ï¼Œçº¿ç¨‹æ± åˆ†å·¥</h4>
<p>å¯ä»¥è®¾ç½®2ç§ç±»å‹çš„çº¿ç¨‹æ± ï¼š</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j(topic = <span class="string">&quot;c.Test1&quot;</span>)</span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">Test1</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> final List&lt;<span class="built_in">String</span>&gt; MENU=Arrays.asList(<span class="string">&quot;åœ°ä¸‰é²œ&quot;</span>,<span class="string">&quot;å®«ä¿é¸¡ä¸&quot;</span>,<span class="string">&quot;è¾£å­é¸¡ä¸&quot;</span>,<span class="string">&quot;çƒ¤é¸¡ç¿…&quot;</span>);</span><br><span class="line">    <span class="keyword">static</span> Random RANDOM = <span class="keyword">new</span> Random();</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">String</span> cooking()&#123;</span><br><span class="line">        <span class="keyword">return</span> MENU.get(RANDOM.nextInt(MENU.size()));</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="keyword">static</span> <span class="literal">void</span> main(<span class="built_in">String</span>[] args) throws ExecutionException,InterruptedException &#123;</span><br><span class="line">        ExecutorService waitpool = Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">        ExecutorService cookpool = Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">        waitpool.execute<span class="function"><span class="params">(()-&gt;&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            log.debug(<span class="string">&quot;å¤„ç†ç‚¹é¤...&quot;</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">            Future&lt;<span class="built_in">String</span>&gt; f=cookpool.submit(()-&gt;&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                log.debug(<span class="string">&quot;åšèœ&quot;</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="keyword">return</span> cooking();</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;);</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">try</span>&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                log.debug(<span class="string">&quot;ä¸Šèœï¼š&#123;&#125;&quot;</span>,f.get());</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;<span class="keyword">catch</span> (InterruptedException|ExecutionException e)&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                e.printStackTrace();</span></span></span><br><span class="line"><span class="params"><span class="function">            &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">        &#125;)</span>;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1556.png" alt="img"></p>
<h4 id="4-çº¿ç¨‹æ± å¤§å°å¦‚ä½•è®¾ç½®æœ€åˆé€‚ï¼Ÿ">4.çº¿ç¨‹æ± å¤§å°å¦‚ä½•è®¾ç½®æœ€åˆé€‚ï¼Ÿ</h4>
<p>è¿‡å°çš„é—®é¢˜ï¼š</p>
<ul>
<li>çº¿ç¨‹ä¸å¤Ÿ â†’ ä»»åŠ¡å †ç§¯ â†’ é¥¥é¥¿ã€å»¶è¿Ÿã€ååä½</li>
</ul>
<p>è¿‡å¤§çš„é—®é¢˜ï¼š</p>
<ul>
<li>çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬å¤§</li>
<li>å†…å­˜å ç”¨é«˜ï¼Œå¯èƒ½ OOM</li>
</ul>
<p>ä¸€èˆ¬å»ºè®®ï¼š</p>
<p>1ï¼‰CPU å¯†é›†å‹ä»»åŠ¡ï¼ˆæ¯”å¦‚åŠ è§£å¯†ã€è®¡ç®—ï¼‰ï¼š</p>
<ul>
<li>çº¿ç¨‹æ•° = <strong>CPU æ ¸æ•° + 1</strong></li>
<li>é¢å¤–çº¿ç¨‹æ˜¯ä¸ºäº†é˜²æ­¢è°ƒåº¦/IO é˜»å¡å¸¦æ¥çš„ CPU ç©ºè½¬</li>
</ul>
<p>2ï¼‰I/O å¯†é›†å‹ä»»åŠ¡ï¼ˆæ¯”å¦‚æ•°æ®åº“ã€æ–‡ä»¶ã€ç½‘ç»œï¼‰ï¼š</p>
<p>ç»éªŒå…¬å¼ï¼š</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">çº¿ç¨‹æ•° = <span class="meta">CPU</span>æ ¸æ•° * æœŸæœ›<span class="meta">CPU</span>åˆ©ç”¨ç‡ * (è®¡ç®—æ—¶é—´ + ç­‰å¾…æ—¶é—´) / è®¡ç®—æ—¶é—´</span><br></pre></td></tr></table></figure>
<p>ä¸¾ä¾‹ï¼š</p>
<ul>
<li>4 æ ¸ CPUï¼Œè®¡ç®—æ—¶é—´ 10%ï¼Œç­‰å¾…æ—¶é—´ 90%</li>
</ul>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">çº¿ç¨‹æ•° =<span class="number"> 4 </span>*<span class="number"> 1 </span>* (10% + 90%) / 10% = 40</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>å»ºè®®çº¿ç¨‹æ•°é…ç½®</th>
<th>åŸå› </th>
</tr>
</thead>
<tbody>
<tr>
<td>CPU å¯†é›†å‹ä»»åŠ¡</td>
<td><code>æ ¸å¿ƒæ•° + 1</code></td>
<td>ä¿è¯ CPU ä¸ç©ºé—²</td>
</tr>
<tr>
<td>I/O å¯†é›†å‹ä»»åŠ¡</td>
<td>çœ‹å…¬å¼ï¼ˆä¸€èˆ¬è¿œå¤§äºæ ¸å¿ƒæ•°ï¼‰</td>
<td>åˆ©ç”¨ IO ç­‰å¾…æ—¶ CPU ç©ºé—²æ—¶é—´</td>
</tr>
<tr>
<td>ä»»åŠ¡ä¾èµ–åµŒå¥—æ—¶</td>
<td><strong>åˆ†å¤šä¸ªçº¿ç¨‹æ± </strong></td>
<td>é¿å…çº¿ç¨‹æ± å†…éƒ¨é€’å½’è°ƒç”¨å¯¼è‡´é¥¥é¥¿</td>
</tr>
</tbody>
</table>
<h2 id="8-2JUC">8.2JUC</h2>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1577.png" alt="img"></p>
<h3 id="1-AQSåŸç†">1.AQSåŸç†</h3>
<h4 id="æ¦‚è¿°">æ¦‚è¿°</h4>
<p>AQS å…¨ç§°æ˜¯ <strong>AbstractQueuedSynchronizer</strong>ï¼Œå®ƒæ˜¯ JDK æä¾›çš„ä¸€ä¸ª<strong>æ„å»ºé”å’ŒåŒæ­¥å™¨çš„åŸºç¡€æ¡†æ¶</strong>ï¼Œå¾ˆå¤šå¹¶å‘å·¥å…·ç±»ï¼ˆå¦‚ <code>ReentrantLock</code>ã€<code>Semaphore</code>ã€<code>CountDownLatch</code> ç­‰ï¼‰éƒ½åŸºäºå®ƒæ„å»ºã€‚</p>
<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>ç”¨ state å±æ€§æ¥è¡¨ç¤ºèµ„æºçš„çŠ¶æ€ï¼ˆåˆ†ç‹¬å æ¨¡å¼å’Œå…±äº«æ¨¡å¼ï¼‰ï¼Œå­ç±»éœ€è¦å®šä¹‰å¦‚ä½•ç»´æŠ¤è¿™ä¸ªçŠ¶æ€ï¼Œæ§åˆ¶å¦‚ä½•è·å– é”å’Œé‡Šæ”¾é”
<ul>
<li>getState - è·å– state çŠ¶æ€</li>
<li>setState - è®¾ç½® state çŠ¶æ€</li>
<li>compareAndSetState - cas æœºåˆ¶è®¾ç½® state çŠ¶æ€</li>
<li>ç‹¬å æ¨¡å¼æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè®¿é—®èµ„æºï¼Œè€Œå…±äº«æ¨¡å¼å¯ä»¥å…è®¸å¤šä¸ªçº¿ç¨‹è®¿é—®èµ„æº</li>
</ul>
</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1580.png" alt="img"></p>
<ul>
<li>æä¾›äº†åŸºäº FIFO çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œç±»ä¼¼äº Monitor çš„ EntryList</li>
<li>æ¡ä»¶å˜é‡æ¥å®ç°ç­‰å¾…ã€å”¤é†’æœºåˆ¶ï¼Œæ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡ï¼Œç±»ä¼¼äº Monitor çš„ WaitSet</li>
</ul>
<p>æ ¸å¿ƒæ€æƒ³ï¼šçŠ¶æ€ + é˜Ÿåˆ— + é˜»å¡</p>
<table>
<thead>
<tr>
<th>æ¨¡å—</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>state</code></td>
<td>ç”¨äºè¡¨ç¤ºèµ„æºçŠ¶æ€ï¼ˆå¦‚ 0 è¡¨ç¤ºæœªå ç”¨ï¼Œ1 è¡¨ç¤ºè¢«å ç”¨ï¼‰</td>
</tr>
<tr>
<td>FIFO é˜Ÿåˆ—</td>
<td>ç­‰å¾…çº¿ç¨‹éƒ½ä¼šè¢«æ„é€ æˆèŠ‚ç‚¹æŒ‚å…¥é˜Ÿåˆ—ï¼ˆCLH é˜Ÿåˆ—ï¼‰</td>
</tr>
<tr>
<td><code>park</code>/<code>unpark</code></td>
<td>ç”¨æ¥é˜»å¡/å”¤é†’çº¿ç¨‹ï¼Œæ›¿ä»£åºŸå¼ƒçš„ <code>suspend/resume</code></td>
</tr>
</tbody>
</table>
<p>å­ç±»ä¸»è¦å®ç°è¿™æ ·ä¸€äº›æ–¹æ³•ï¼ˆé»˜è®¤æŠ›å‡º UnsupportedOperationExceptionï¼‰</p>
<ul>
<li>tryAcquire</li>
<li>tryRelease</li>
<li>tryAcquireShared</li>
<li>tryReleaseShared</li>
<li>isHeldExclusively</li>
</ul>
<p>è·å–é”çš„å§¿åŠ¿ï¼ˆç‹¬å æ¨¡å¼ï¼‰</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (!tryAcquire(arg)) &#123;</span><br><span class="line">    <span class="comment">// è·å–å¤±è´¥ï¼ŒåŠ å…¥é˜Ÿåˆ—å¹¶é˜»å¡</span></span><br><span class="line">    <span class="built_in">enqueue</span>();</span><br><span class="line">    <span class="built_in">park</span>(); <span class="comment">// ç›´åˆ°è¢«å”¤é†’</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‡Šæ”¾é”çš„å§¿åŠ¿ï¼ˆç‹¬å æ¨¡å¼ï¼‰</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (tryRelease(arg)) &#123;</span><br><span class="line">    <span class="comment">// æˆåŠŸé‡Šæ”¾ï¼Œå”¤é†’é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªç­‰å¾…çº¿ç¨‹</span></span><br><span class="line">    <span class="built_in">unparkSuccessor</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="è‡ªå®šä¹‰ä¸å¯é‡å…¥é”å®ç°">è‡ªå®šä¹‰ä¸å¯é‡å…¥é”å®ç°</h4>
<h5 id="é€šè¿‡è‡ªå®šä¹‰åŒæ­¥å™¨-MySync-ç»§æ‰¿-AQSï¼š"><strong>é€šè¿‡è‡ªå®šä¹‰åŒæ­¥å™¨ <code>MySync</code> ç»§æ‰¿ AQSï¼š</strong></h5>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MySync</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> boolean tryAcquire(int acquires) &#123;</span><br><span class="line">        <span class="keyword">if</span> (acquires == <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(<span class="type">Thread</span>.currentThread());</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> boolean tryRelease(int acquires) &#123;</span><br><span class="line">        <span class="keyword">if</span>(acquires == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(getState() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalMonitorStateException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">            setState(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">Condition</span> newCondition() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">ConditionObject</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> boolean isHeldExclusively() &#123;</span><br><span class="line">        <span class="keyword">return</span> getState() == <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="è‡ªå®šä¹‰é”"><strong>è‡ªå®šä¹‰é”</strong></h5>
<p>æœ‰äº†è‡ªå®šä¹‰åŒæ­¥å™¨ï¼Œå¾ˆå®¹æ˜“å¤ç”¨ AQS ï¼Œå®ç°ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡çš„è‡ªå®šä¹‰é”</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyLock</span> <span class="keyword">implements</span> <span class="title">Lock</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> MySync sync = <span class="keyword">new</span> MySync();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// å°è¯•ï¼Œä¸æˆåŠŸï¼Œè¿›å…¥ç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sync.acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// å°è¯•ï¼Œä¸æˆåŠŸï¼Œè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œå¯æ‰“æ–­</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        sync.acquireInterruptibly(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// å°è¯•ä¸€æ¬¡ï¼Œä¸æˆåŠŸè¿”å›ï¼Œä¸è¿›å…¥é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">return</span> sync.<span class="title">tryAcquire</span><span class="params">(<span class="number">1</span>)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// å°è¯•ï¼Œä¸æˆåŠŸï¼Œè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œæœ‰æ—¶é™</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(<span class="keyword">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sync.tryAcquireNanos(<span class="number">1</span>, unit.toNanos(time));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sync.release(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// ç”Ÿæˆæ¡ä»¶å˜é‡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">Condition <span class="title">newCondition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">return</span> sync.<span class="title">newCondition</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ä¸€ä¸‹</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">MyLock lock = <span class="keyword">new</span> MyLock();</span><br><span class="line"><span class="keyword">new</span> Thread<span class="function"><span class="params">(() -&gt; &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    lock.lock();</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">try</span> &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        log.debug(<span class="string">&quot;locking...&quot;</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">        sleep(<span class="number">1</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125; <span class="keyword">finally</span> &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        log.debug(<span class="string">&quot;unlocking...&quot;</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">        lock.unlock();</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;,<span class="string">&quot;t1&quot;</span>)</span>.<span class="title">start</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function"><span class="title">new</span> <span class="title">Thread</span><span class="params">(() -&gt; &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    lock.lock();</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">try</span> &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        log.debug(<span class="string">&quot;locking...&quot;</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125; <span class="keyword">finally</span> &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        log.debug(<span class="string">&quot;unlocking...&quot;</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">        lock.unlock();</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;,<span class="string">&quot;t2&quot;</span>)</span>.<span class="title">start</span><span class="params">()</span>;</span></span><br></pre></td></tr></table></figure>
<p>è¾“å‡º</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">22</span>:<span class="number">29</span>:<span class="number">28.727</span> c<span class="selector-class">.TestAqs</span> <span class="selector-attr">[t1]</span> - locking... </span><br><span class="line"><span class="number">22</span>:<span class="number">29</span>:<span class="number">29.732</span> c<span class="selector-class">.TestAqs</span> <span class="selector-attr">[t1]</span> - unlocking... </span><br><span class="line"><span class="number">22</span>:<span class="number">29</span>:<span class="number">29.732</span> c<span class="selector-class">.TestAqs</span> <span class="selector-attr">[t2]</span> - locking... </span><br><span class="line"><span class="number">22</span>:<span class="number">29</span>:<span class="number">29.732</span> c<span class="selector-class">.TestAqs</span> <span class="selector-attr">[t2]</span> - unlocking... </span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºè¯´æ˜ï¼š</p>
<ul>
<li>t1 å…ˆè·å–é”å¹¶æŒæœ‰ 1 ç§’</li>
<li>t2 é˜»å¡ç­‰å¾…ï¼Œç›´åˆ° t1 é‡Šæ”¾åå†æ‰§è¡Œ</li>
</ul>
<p>ä¸å¯é‡å…¥æµ‹è¯•</p>
<p>å¦‚æœæ”¹ä¸ºä¸‹é¢ä»£ç ï¼Œä¼šå‘ç°è‡ªå·±ä¹Ÿä¼šè¢«æŒ¡ä½ï¼ˆåªä¼šæ‰“å°ä¸€æ¬¡ lockingï¼‰</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lock</span>.<span class="keyword">lock</span>();</span><br><span class="line"><span class="keyword">log</span>.<span class="keyword">debug</span>(&quot;locking...&quot;);</span><br><span class="line"><span class="keyword">lock</span>.<span class="keyword">lock</span>();</span><br><span class="line"><span class="keyword">log</span>.<span class="keyword">debug</span>(&quot;locking...&quot;);</span><br></pre></td></tr></table></figure>
<h4 id="AQS-é˜Ÿåˆ—æ¨¡å‹ï¼ˆåŸºäº-CLHï¼‰">AQS é˜Ÿåˆ—æ¨¡å‹ï¼ˆåŸºäº CLHï¼‰</h4>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1581.png" alt="img"></p>
<h5 id="ç›®æ ‡"><strong>ç›®æ ‡</strong></h5>
<p>AQS è¦å®ç°çš„åŠŸèƒ½ç›®æ ‡</p>
<ul>
<li>é˜»å¡ç‰ˆæœ¬è·å–é” acquire å’Œéé˜»å¡çš„ç‰ˆæœ¬å°è¯•è·å–é” tryAcquire</li>
<li>è·å–é”è¶…æ—¶æœºåˆ¶</li>
<li>é€šè¿‡æ‰“æ–­å–æ¶ˆæœºåˆ¶</li>
<li>ç‹¬å æœºåˆ¶åŠå…±äº«æœºåˆ¶</li>
<li>æ¡ä»¶ä¸æ»¡è¶³æ—¶çš„ç­‰å¾…æœºåˆ¶</li>
</ul>
<p>è¦å®ç°çš„æ€§èƒ½ç›®æ ‡</p>
<blockquote>
<p>Instead, the primary performance goal here is scalability: to predictably maintain efficiency even, or especially, when synchronizers are contended.</p>
</blockquote>
<h5 id="è®¾è®¡"><strong>è®¾è®¡</strong></h5>
<p>AQS çš„åŸºæœ¬æ€æƒ³å…¶å®å¾ˆç®€å•</p>
<p>è·å–é”çš„é€»è¾‘</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">while(<span class="keyword">state</span> çŠ¶æ€ä¸å…è®¸è·å–) &#123;</span><br><span class="line">    if(é˜Ÿåˆ—ä¸­è¿˜æ²¡æœ‰æ­¤çº¿ç¨‹) &#123;</span><br><span class="line">        å…¥é˜Ÿå¹¶é˜»å¡</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">å½“å‰çº¿ç¨‹å‡ºé˜Ÿ</span><br></pre></td></tr></table></figure>
<p>é‡Šæ”¾é”çš„é€»è¾‘</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if(<span class="keyword">state</span> çŠ¶æ€å…è®¸äº†) &#123;</span><br><span class="line">    æ¢å¤é˜»å¡çš„çº¿ç¨‹(s)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¦ç‚¹</p>
<ul>
<li>åŸå­ç»´æŠ¤ state çŠ¶æ€</li>
<li>é˜»å¡åŠæ¢å¤çº¿ç¨‹</li>
<li>ç»´æŠ¤é˜Ÿåˆ—</li>
</ul>
<ol>
<li>
<p>state è®¾è®¡</p>
<ul>
<li>state ä½¿ç”¨ volatile é…åˆ cas ä¿è¯å…¶ä¿®æ”¹æ—¶çš„åŸå­æ€§</li>
<li>state ä½¿ç”¨äº† 32bit int æ¥ç»´æŠ¤åŒæ­¥çŠ¶æ€ï¼Œå› ä¸ºå½“æ—¶ä½¿ç”¨ long åœ¨å¾ˆå¤šå¹³å°ä¸‹æµ‹è¯•çš„ç»“æœå¹¶ä¸ç†æƒ³</li>
</ul>
</li>
<li>
<p>é˜»å¡æ¢å¤è®¾è®¡</p>
<ul>
<li>æ—©æœŸçš„æ§åˆ¶çº¿ç¨‹æš‚åœå’Œæ¢å¤çš„ api æœ‰ suspend å’Œ resumeï¼Œä½†å®ƒä»¬æ˜¯ä¸å¯ç”¨çš„ï¼Œå› ä¸ºå¦‚æœå…ˆè°ƒç”¨çš„ resume é‚£ä¹ˆ suspend å°†æ„ŸçŸ¥ä¸åˆ°</li>
<li>è§£å†³æ–¹æ³•æ˜¯ä½¿ç”¨ park &amp; unpark æ¥å®ç°çº¿ç¨‹çš„æš‚åœå’Œæ¢å¤ï¼Œå…·ä½“åŸç†åœ¨ä¹‹å‰è®²è¿‡äº†ï¼Œå…ˆ unpark å† park ä¹Ÿæ²¡ é—®é¢˜</li>
<li>park &amp; unpark æ˜¯é’ˆå¯¹çº¿ç¨‹çš„ï¼Œè€Œä¸æ˜¯é’ˆå¯¹åŒæ­¥å™¨çš„ï¼Œå› æ­¤æ§åˆ¶ç²’åº¦æ›´ä¸ºç²¾ç»†</li>
<li>park çº¿ç¨‹è¿˜å¯ä»¥é€šè¿‡ interrupt æ‰“æ–­</li>
</ul>
</li>
<li>
<p>é˜Ÿåˆ—è®¾è®¡</p>
<ul>
<li>ä½¿ç”¨äº† FIFO å…ˆå…¥å…ˆå‡ºé˜Ÿåˆ—ï¼Œå¹¶ä¸æ”¯æŒä¼˜å…ˆçº§é˜Ÿåˆ—</li>
<li>è®¾è®¡æ—¶å€Ÿé‰´äº† CLH é˜Ÿåˆ—ï¼Œå®ƒæ˜¯ä¸€ç§å•å‘æ— é”é˜Ÿåˆ—</li>
</ul>
</li>
</ol>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1578.png" alt="img"></p>
<ul>
<li>ç±»ä¼¼ä¸€ä¸ªé“¾è¡¨ç»“æ„ï¼Œæ¯ä¸ªçº¿ç¨‹é€šè¿‡èŠ‚ç‚¹ Node åŠ å…¥é˜Ÿåˆ—</li>
<li>ä½¿ç”¨ <code>park/unpark</code> æ–¹å¼æŒ‚èµ·/å”¤é†’çº¿ç¨‹ï¼Œæ•ˆç‡æ›´é«˜ã€å¯ä¸­æ–­</li>
</ul>
<p>é˜Ÿåˆ—ä¸­æœ‰ head å’Œ tail ä¸¤ä¸ªæŒ‡é’ˆèŠ‚ç‚¹ï¼Œéƒ½ç”¨ volatile ä¿®é¥°é…åˆ cas ä½¿ç”¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹æœ‰ state ç»´æŠ¤èŠ‚ç‚¹çŠ¶æ€ å…¥é˜Ÿä¼ªä»£ç ï¼Œåªéœ€è¦è€ƒè™‘ tail èµ‹å€¼çš„åŸå­æ€§</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">do &#123;</span><br><span class="line">    // åŸæ¥çš„ tail</span><br><span class="line">    <span class="keyword">Node</span> <span class="title">prev</span> = tail;</span><br><span class="line">    // ç”¨ cas åœ¨åŸæ¥ tail çš„åŸºç¡€ä¸Šæ”¹ä¸º <span class="keyword">node</span></span><br><span class="line"><span class="title">&#125; while</span>(tail.compareAndSet(prev, <span class="keyword">node</span><span class="title">))</span></span><br></pre></td></tr></table></figure>
<p>å‡ºé˜Ÿä¼ªä»£ç </p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// prev æ˜¯ä¸Šä¸€ä¸ªèŠ‚ç‚¹</span><br><span class="line">while((<span class="keyword">Node</span> <span class="title">prev</span>=node.prev).state != å”¤é†’çŠ¶æ€) &#123;</span><br><span class="line">&#125;</span><br><span class="line">// è®¾ç½®å¤´èŠ‚ç‚¹</span><br><span class="line">head = <span class="keyword">node</span><span class="title">;</span></span><br></pre></td></tr></table></figure>
<p>CLH å¥½å¤„ï¼š</p>
<ul>
<li>æ— é”ï¼Œä½¿ç”¨è‡ªæ—‹</li>
<li>å¿«é€Ÿï¼Œæ— é˜»å¡</li>
</ul>
<p>AQS åœ¨ä¸€äº›æ–¹é¢æ”¹è¿›äº† CLH</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private <span class="keyword">Node</span> <span class="title">enq</span>(final <span class="keyword">Node</span> <span class="title">node</span>) &#123;</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        <span class="keyword">Node</span> <span class="title">t</span> = tail;</span><br><span class="line">        // é˜Ÿåˆ—ä¸­è¿˜æ²¡æœ‰å…ƒç´  tail ä¸º null</span><br><span class="line">        if (t == null) &#123;</span><br><span class="line">            // å°† head ä» null -&gt; dummy</span><br><span class="line">            if (compareAndSetHead(new <span class="keyword">Node</span><span class="title">()))</span></span><br><span class="line"><span class="title">                tail</span> = head;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // å°† <span class="keyword">node</span> <span class="title">çš„ prev</span> è®¾ç½®ä¸ºåŸæ¥çš„ tail</span><br><span class="line">            node.prev = t;</span><br><span class="line">            // å°† tail ä»åŸæ¥çš„ tail è®¾ç½®ä¸º <span class="keyword">node</span></span><br><span class="line">            <span class="title">if</span> (compareAndSetTail(t, <span class="keyword">node</span><span class="title">)) &#123;</span></span><br><span class="line"><span class="title">                // åŸæ¥ tail</span> çš„ next è®¾ç½®ä¸º <span class="keyword">node</span></span><br><span class="line">                <span class="title">t</span>.next = <span class="keyword">node</span><span class="title">;</span></span><br><span class="line"><span class="title">                return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ä¸»è¦ç”¨åˆ°-AQS-çš„å¹¶å‘å·¥å…·ç±»">ä¸»è¦ç”¨åˆ° AQS çš„å¹¶å‘å·¥å…·ç±»</h5>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1579-1024x481.png" alt="img"></p>
<h3 id="2-ReentrantLock-åŸç†">2.ReentrantLock åŸç†</h3>
<p>å…ˆå›é¡¾ä¸€ä¸‹ä¸Šç¯‡å­¦è¿‡çš„ReentrantLockçš„ç‰¹æ€§</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1627-1024x342.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1582.png" alt="img"></p>
<h4 id="éå…¬å¹³é”å®ç°åŸç†">éå…¬å¹³é”å®ç°åŸç†</h4>
<p>ä»€ä¹ˆæ˜¯éå…¬å¹³é”ï¼Ÿ</p>
<p>éå…¬å¹³é”æŒ‡çš„æ˜¯çº¿ç¨‹åœ¨è·å–é”æ—¶<strong>ä¸å…³å¿ƒé˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰ç­‰å¾…çº¿ç¨‹</strong>ï¼Œåªè¦é”æ˜¯ç©ºé—²çš„ï¼Œ<strong>è°å…ˆ CAS æˆåŠŸè°å°±è·å¾—é”</strong>ã€‚</p>
<p>ReentrantLock é»˜è®¤æ˜¯ <strong>éå…¬å¹³é”</strong>ï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReentrantLock</span>()</span> &#123;</span><br><span class="line">    sync = <span class="keyword">new</span> NonfairSync(); <span class="comment">// é»˜è®¤ä½¿ç”¨éå…¬å¹³ç­–ç•¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="åŠ é”è§£é”æµç¨‹">åŠ é”è§£é”æµç¨‹</h5>
<p>NonfairSync ç»§æ‰¿è‡ª AQS æ²¡æœ‰ç«äº‰æ—¶</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1583.png" alt="img"></p>
<p>ç¬¬ä¸€ä¸ªç«äº‰å‡ºç°æ—¶</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1584.png" alt="img"></p>
<p>Thread-1 æ‰§è¡Œäº†</p>
<ol>
<li>CAS å°è¯•å°† state ç”± 0 æ”¹ä¸º 1ï¼Œç»“æœå¤±è´¥</li>
<li>è¿›å…¥ tryAcquire é€»è¾‘ï¼Œè¿™æ—¶ state å·²ç»æ˜¯1ï¼Œç»“æœä»ç„¶å¤±è´¥</li>
</ol>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1594.png" alt="img"></p>
<p>3.æ¥ä¸‹æ¥è¿›å…¥ addWaiter é€»è¾‘ï¼Œæ„é€  Node é˜Ÿåˆ—</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1595.png" alt="img"></p>
<p>å›¾ä¸­é»„è‰²ä¸‰è§’è¡¨ç¤ºè¯¥ Node çš„ waitStatus çŠ¶æ€ï¼Œå…¶ä¸­ 0 ä¸ºé»˜è®¤æ­£å¸¸çŠ¶æ€</p>
<p>Node çš„åˆ›å»ºæ˜¯æ‡’æƒ°çš„</p>
<p>å…¶ä¸­ç¬¬ä¸€ä¸ª Node ç§°ä¸º Dummyï¼ˆå“‘å…ƒï¼‰æˆ–å“¨å…µï¼Œç”¨æ¥å ä½ï¼Œå¹¶ä¸å…³è”çº¿ç¨‹</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1585.png" alt="img"></p>
<p>4.å½“å‰çº¿ç¨‹è¿›å…¥ acquireQueued é€»è¾‘</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1596.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1601.png" alt="img"></p>
<p>1.acquireQueued ä¼šåœ¨ä¸€ä¸ªæ­»å¾ªç¯ä¸­ä¸æ–­å°è¯•è·å¾—é”ï¼Œå¤±è´¥åè¿›å…¥ park é˜»å¡</p>
<p>2.å¦‚æœè‡ªå·±æ˜¯ç´§é‚»ç€ headï¼ˆæ’ç¬¬äºŒä½ï¼‰ï¼Œé‚£ä¹ˆå†æ¬¡ tryAcquire å°è¯•è·å–é”ï¼Œå½“ç„¶è¿™æ—¶ state ä»ä¸º 1ï¼Œå¤±è´¥</p>
<p>3.è¿›å…¥ shouldParkAfterFailedAcquire é€»è¾‘ï¼Œå°†å‰é©± nodeï¼Œå³ head çš„ waitStatus æ”¹ä¸º -1ï¼Œè¿™æ¬¡è¿”å› false</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1588.png" alt="img"></p>
<p>4.shouldParkAfterFailedAcquire æ‰§è¡Œå®Œæ¯•å›åˆ° acquireQueued ï¼Œå†æ¬¡ tryAcquire å°è¯•è·å–é”ï¼Œå½“ç„¶è¿™æ—¶ state ä»ä¸º 1ï¼Œå¤±è´¥</p>
<p>5.å½“å†æ¬¡è¿›å…¥ shouldParkAfterFailedAcquire æ—¶ï¼Œè¿™æ—¶å› ä¸ºå…¶å‰é©± node çš„ waitStatus å·²ç»æ˜¯ -1ï¼Œè¿™æ¬¡è¿”å› true</p>
<p>6.è¿›å…¥ parkAndCheckInterruptï¼Œ Thread-1 parkï¼ˆç°è‰²è¡¨ç¤ºï¼‰</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1589.png" alt="img"></p>
<p>å†æ¬¡æœ‰å¤šä¸ªçº¿ç¨‹ç»å†ä¸Šè¿°è¿‡ç¨‹ç«äº‰å¤±è´¥ï¼Œå˜æˆè¿™ä¸ªæ ·å­</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1590.png" alt="img"></p>
<p>Thread-0 é‡Šæ”¾é”ï¼Œè¿›å…¥ tryRelease æµç¨‹ï¼Œå¦‚æœæˆåŠŸ</p>
<ul>
<li>è®¾ç½® exclusiveOwnerThread ä¸º null</li>
<li>state = 0</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1591.png" alt="img"></p>
<p>å½“å‰é˜Ÿåˆ—ä¸ä¸º nullï¼Œå¹¶ä¸” head çš„ waitStatus = -1ï¼Œè¿›å…¥ unparkSuccessor æµç¨‹</p>
<p>æ‰¾åˆ°é˜Ÿåˆ—ä¸­ç¦» head æœ€è¿‘çš„ä¸€ä¸ª Nodeï¼ˆæ²¡å–æ¶ˆçš„ï¼‰ï¼Œunpark æ¢å¤å…¶è¿è¡Œï¼Œæœ¬ä¾‹ä¸­å³ä¸º Thread-1</p>
<p>å›åˆ° Thread-1 çš„ acquireQueued æµç¨‹</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1592.png" alt="img"></p>
<p>å¦‚æœåŠ é”æˆåŠŸï¼ˆæ²¡æœ‰ç«äº‰ï¼‰ï¼Œä¼šè®¾ç½®</p>
<ul>
<li>exclusiveOwnerThread ä¸º Thread-1ï¼Œstate = 1</li>
<li>head æŒ‡å‘åˆšåˆš Thread-1 æ‰€åœ¨çš„ Nodeï¼Œè¯¥ Node æ¸…ç©º Thread</li>
<li>åŸæœ¬çš„ head å› ä¸ºä»é“¾è¡¨æ–­å¼€ï¼Œè€Œå¯è¢«åƒåœ¾å›æ”¶</li>
</ul>
<p>å¦‚æœè¿™æ—¶å€™æœ‰å…¶å®ƒçº¿ç¨‹æ¥ç«äº‰ï¼ˆéå…¬å¹³çš„ä½“ç°ï¼‰ï¼Œä¾‹å¦‚è¿™æ—¶æœ‰ Thread-4 æ¥äº†</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1593.png" alt="img"></p>
<p>å¦‚æœä¸å·§åˆè¢« Thread-4 å äº†å…ˆ</p>
<ul>
<li>Thread-4 è¢«è®¾ç½®ä¸º exclusiveOwnerThreadï¼Œstate = 1</li>
<li>Thread-1 å†æ¬¡è¿›å…¥ acquireQueued æµç¨‹ï¼Œè·å–é”å¤±è´¥ï¼Œé‡æ–°è¿›å…¥ park é˜»å¡</li>
</ul>
<h5 id="åŠ é”æºç ">åŠ é”æºç </h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sync ç»§æ‰¿è‡ª AQS</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonfairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">7316153563782823691L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŠ é”å®ç°</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// é¦–å…ˆç”¨ cas å°è¯•ï¼ˆä»…å°è¯•ä¸€æ¬¡ï¼‰å°† state ä» 0 æ”¹ä¸º 1, å¦‚æœæˆåŠŸè¡¨ç¤ºè·å¾—äº†ç‹¬å é”</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">            setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// å¦‚æœå°è¯•å¤±è´¥ï¼Œè¿›å…¥ ãˆ </span></span><br><span class="line">            acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ  AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="comment">// ãˆ¡ tryAcquire </span></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            !tryAcquire(arg) &amp;&amp;</span><br><span class="line">            <span class="comment">// å½“ tryAcquire è¿”å›ä¸º false æ—¶, å…ˆè°ƒç”¨ addWaiter ãˆ£, æ¥ç€ acquireQueued ãˆ¤</span></span><br><span class="line">            acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</span><br><span class="line">        ) &#123;</span><br><span class="line">            selfInterrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¡ è¿›å…¥ ãˆ¢</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nonfairTryAcquire(acquires);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¢ Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">nonfairTryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="comment">// å¦‚æœè¿˜æ²¡æœ‰è·å¾—é”</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å°è¯•ç”¨ cas è·å¾—, è¿™é‡Œä½“ç°äº†éå…¬å¹³æ€§: ä¸å»æ£€æŸ¥ AQS é˜Ÿåˆ—</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(current);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœå·²ç»è·å¾—äº†é”, çº¿ç¨‹è¿˜æ˜¯å½“å‰çº¿ç¨‹, è¡¨ç¤ºå‘ç”Ÿäº†é”é‡å…¥</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            <span class="comment">// state++</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">            setState(nextc);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è·å–å¤±è´¥, å›åˆ°è°ƒç”¨å¤„</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ£ AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="comment">//å°†å½“å‰nodeåŠ å…¥ç­‰å¾…é˜Ÿåˆ—æœ«å°¾ç­‰å¾…ï¼Œå¹¶è¿”å›å½“å‰node</span></span><br><span class="line">    <span class="keyword">private</span> Node <span class="title function_">addWaiter</span><span class="params">(Node mode)</span> &#123;</span><br><span class="line">        <span class="comment">// å°†å½“å‰çº¿ç¨‹å…³è”åˆ°ä¸€ä¸ª Node å¯¹è±¡ä¸Š, æ¨¡å¼ä¸ºç‹¬å æ¨¡å¼</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(Thread.currentThread(), mode);</span><br><span class="line">        <span class="comment">//éå…¬å¹³åŒæ­¥å™¨ä¸­æœ‰headå’Œtailä¸¤ä¸ªå¼•ç”¨åˆ†åˆ«æŒ‡å‘äº†ç­‰å¾…é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="comment">//predæŒ‡çš„æ˜¯nodeçš„å‰é©±ï¼Œä»é˜Ÿå°¾æ’å…¥ï¼Œæ‰€ä»¥predä¸ºtail</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">pred</span> <span class="operator">=</span> tail;</span><br><span class="line">        <span class="comment">// å¦‚æœ tail ä¸ä¸º null, è¯´æ˜å·²ç»æœ‰äº†ç­‰å¾…é˜Ÿåˆ—äº†ï¼Œcas å°è¯•å°† Node å¯¹è±¡åŠ å…¥ AQS é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line">        <span class="keyword">if</span> (pred != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//å°†nodeçš„å‰é©±èŠ‚ç‚¹è®¾ç½®ä¸ºpred</span></span><br><span class="line">            node.prev = pred;</span><br><span class="line">            <span class="comment">//å°è¯•å°†é˜Ÿåˆ—çš„tialä»å½“å‰çš„predä¿®æ”¹ä¸ºnode</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">                <span class="comment">// åŒå‘é“¾è¡¨</span></span><br><span class="line">                pred.next = node;</span><br><span class="line">                <span class="keyword">return</span> node;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœpredä¸ºnullï¼Œè¯´æ˜ç­‰å¾…é˜Ÿåˆ—è¿˜æœªåˆ›å»ºï¼Œè°ƒç”¨enqæ–¹æ³•åˆ›å»ºé˜Ÿåˆ—</span></span><br><span class="line">        <span class="comment">// å°è¯•å°† Node åŠ å…¥ AQS, è¿›å…¥ ãˆ¥</span></span><br><span class="line">        enq(node);</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¥ AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="comment">//è¯¥æ–¹æ³•å°±æ˜¯åˆ›å»ºç­‰å¾…é˜Ÿåˆ—ï¼Œå¹¶å°†nodeæ’å…¥é˜Ÿåˆ—çš„å°¾éƒ¨ã€‚</span></span><br><span class="line">    <span class="keyword">private</span> Node <span class="title function_">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail;</span><br><span class="line">            <span class="keyword">if</span> (t == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// è¿˜æ²¡æœ‰, è®¾ç½® head ä¸ºå“¨å…µèŠ‚ç‚¹ï¼ˆä¸å¯¹åº”çº¿ç¨‹ï¼ŒçŠ¶æ€ä¸º 0ï¼‰</span></span><br><span class="line">                <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> <span class="title class_">Node</span>())) &#123;</span><br><span class="line">                    <span class="comment">//å°†headèµ‹å€¼ç»™tailï¼Œheadå’ŒtailåŒæ—¶æŒ‡å‘å“¨å…µèŠ‚ç‚¹</span></span><br><span class="line">                    tail = head;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// cas å°è¯•å°† Node å¯¹è±¡åŠ å…¥ AQS é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line">                <span class="comment">//è®¾ç½®nodeçš„å‰é©±èŠ‚ç‚¹ä¸ºé˜Ÿåˆ—çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">                node.prev = t;</span><br><span class="line">                <span class="comment">//å°è¯•å°†é˜Ÿåˆ—çš„å°¾éƒ¨ä»å½“å‰çš„tailè®¾ç½®ä¸ºnode</span></span><br><span class="line">                <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                    <span class="comment">//å°†nodeè®¾ä¸ºä¸Šä¸€ä¸ªtailçš„åç»§èŠ‚ç‚¹</span></span><br><span class="line">                    t.next = node;</span><br><span class="line">                    <span class="keyword">return</span> t;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¤ AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="comment">//åœ¨é˜Ÿåˆ—ä¸­å¾ªç¯ç­‰å¾…ï¼Œåªæœ‰å½“æ’é˜Ÿæ’åˆ°ç¬¬ä¸€åå¹¶ä¸”è·å¾—äº†é”æ‰èƒ½å‡ºé˜Ÿå¹¶ä»æ–¹æ³•ä¸­é€€å‡ºã€‚</span></span><br><span class="line">    <span class="comment">//è¿”å›æ‰“æ–­çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="comment">//æ‰¾åˆ°å½“å‰nodeçš„å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">                <span class="comment">// ä¸Šä¸€ä¸ªèŠ‚ç‚¹æ˜¯ head, è¡¨ç¤ºè½®åˆ°è‡ªå·±ï¼ˆå½“å‰çº¿ç¨‹å¯¹åº”çš„ nodeï¼‰äº†, å°è¯•è·å–</span></span><br><span class="line">                <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                    <span class="comment">// è·å–æˆåŠŸ, è®¾ç½®è‡ªå·±ï¼ˆå½“å‰çº¿ç¨‹å¯¹åº”çš„ nodeï¼‰ä¸º head</span></span><br><span class="line">                    setHead(node);</span><br><span class="line">                    <span class="comment">// ä¸Šä¸€ä¸ªèŠ‚ç‚¹ help GC</span></span><br><span class="line">                    p.next = <span class="literal">null</span>;</span><br><span class="line">                    failed = <span class="literal">false</span>;</span><br><span class="line">                    <span class="comment">// è¿”å›ä¸­æ–­æ ‡è®° false</span></span><br><span class="line">                    <span class="keyword">return</span> interrupted;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (</span><br><span class="line">                    <span class="comment">// åˆ¤æ–­æ˜¯å¦åº”å½“ park, è¿›å…¥ ãˆ¦</span></span><br><span class="line">                    shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                    <span class="comment">// park ç­‰å¾…, æ­¤æ—¶ Node çš„çŠ¶æ€è¢«ç½®ä¸º Node.SIGNAL ãˆ§</span></span><br><span class="line">                    parkAndCheckInterrupt()</span><br><span class="line">                ) &#123;</span><br><span class="line">                    interrupted = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (failed)</span><br><span class="line">                cancelAcquire(node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¦ AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="comment">//åˆ¤æ–­acquireå¤±è´¥ä»¥åæ˜¯å¦åº”è¯¥é˜»å¡ç­‰å¾…ã€‚ä»è§„åˆ™ä¸Šæ¥è®²ï¼š</span></span><br><span class="line">    <span class="comment">//1.å¦‚æœå‰é©±èŠ‚ç‚¹éƒ½é˜»å¡äº†ï¼Œé‚£ä¹ˆå½“å‰èŠ‚ç‚¹ä¹Ÿåº”è¯¥é˜»å¡</span></span><br><span class="line">    <span class="comment">//2.å¦‚æœå‰é©±èŠ‚ç‚¹å–æ¶ˆï¼Œé‚£ä¹ˆåº”è¯¥å°†å‰é©±èŠ‚ç‚¹å‰ç§»ï¼Œç›´åˆ°å…¶çŠ¶æ€ä¸ä¸ºå–æ¶ˆä¸ºæ­¢ã€‚</span></span><br><span class="line">    <span class="comment">//3.å¦‚æœå‰ä¸¤ç§æƒ…å†µéƒ½ä¸æ˜¯ï¼Œå°è¯•å°†å‰é©±èŠ‚ç‚¹çŠ¶æ€è®¾ä¸ºSIGNALï¼Œè¿”å›falseï¼ˆä¸ç”¨é˜»å¡ï¼Œç­‰åˆ°ä¸‹æ¬¡åœ¨é˜»å¡ï¼‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> pred.waitStatus;</span><br><span class="line">        <span class="keyword">if</span> (ws == Node.SIGNAL) &#123;</span><br><span class="line">            <span class="comment">// ä¸Šä¸€ä¸ªèŠ‚ç‚¹éƒ½åœ¨é˜»å¡, é‚£ä¹ˆè‡ªå·±ä¹Ÿé˜»å¡å¥½äº†</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// &gt; 0 è¡¨ç¤ºå–æ¶ˆçŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ä¸Šä¸€ä¸ªèŠ‚ç‚¹å–æ¶ˆ, é‚£ä¹ˆé‡æ„åˆ é™¤å‰é¢æ‰€æœ‰å–æ¶ˆçš„èŠ‚ç‚¹, è¿”å›åˆ°å¤–å±‚å¾ªç¯é‡è¯•</span></span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                node.prev = pred = pred.prev;</span><br><span class="line">            &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">            pred.next = node;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// è¿™æ¬¡è¿˜æ²¡æœ‰é˜»å¡</span></span><br><span class="line">            <span class="comment">// ä½†ä¸‹æ¬¡å¦‚æœé‡è¯•ä¸æˆåŠŸ, åˆ™éœ€è¦é˜»å¡ï¼Œè¿™æ—¶éœ€è¦è®¾ç½®ä¸Šä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€ä¸º Node.SIGNAL</span></span><br><span class="line">            compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ§ é˜»å¡å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">parkAndCheckInterrupt</span><span class="params">()</span> &#123;</span><br><span class="line">        LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>æ³¨æ„</strong></p>
<p>æ˜¯å¦éœ€è¦ unpark æ˜¯ç”±å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹çš„ waitStatus == Node.SIGNAL æ¥å†³å®šï¼Œè€Œä¸æ˜¯æœ¬èŠ‚ç‚¹çš„ waitStatus å†³å®š</p>
</blockquote>
<p>æ€»ç»“ï¼š</p>
<ul>
<li>
<p>è°ƒç”¨</p>
<figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lock</span></span><br></pre></td></tr></table></figure>
<p>ï¼Œå°è¯•å°†stateä»0ä¿®æ”¹ä¸º1</p>
<ul>
<li>
<p>æˆåŠŸï¼šå°†ownerè®¾ä¸ºå½“å‰çº¿ç¨‹</p>
</li>
<li>
<p>å¤±è´¥ï¼šè°ƒç”¨</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">acquire</span></span><br></pre></td></tr></table></figure>
<p>-&gt;</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">tryAcquire</span></span><br></pre></td></tr></table></figure>
<p>-&gt;</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">nonfairTryAcquire</span></span><br></pre></td></tr></table></figure>
<p>ï¼Œåˆ¤æ–­state=0åˆ™è·å¾—é”ï¼Œæˆ–è€…stateä¸ä¸º0ä½†å½“å‰çº¿ç¨‹æŒæœ‰é”åˆ™é‡å…¥é”ï¼Œä»¥ä¸Šä¸¤ç§æƒ…å†µ</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">tryAcquire</span></span><br></pre></td></tr></table></figure>
<p>è¿”å›trueï¼Œå‰©ä½™æƒ…å†µè¿”å›falseã€‚</p>
<ul>
<li>
<p>trueï¼šè·å¾—é”</p>
</li>
<li>
<p>falseï¼šè°ƒç”¨</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">acquireQueued</span><span class="params">(addWaiter(Node.EXCLUSIVE)</span></span>, arg)</span><br></pre></td></tr></table></figure>
<p>,å…¶ä¸­</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">addwiter</span></span><br></pre></td></tr></table></figure>
<p>å°†å…³è”çº¿ç¨‹çš„èŠ‚ç‚¹æ’å…¥AQSé˜Ÿåˆ—å°¾éƒ¨ï¼Œè¿›å…¥</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">acquireQueued</span></span><br></pre></td></tr></table></figure>
<p>ä¸­çš„forå¾ªç¯:</p>
<ul>
<li>å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ï¼Œå¹¶å°è¯•è·å¾—é”æˆåŠŸï¼Œå°†å½“å‰èŠ‚ç‚¹è®¾ä¸ºå¤´èŠ‚ç‚¹ï¼Œæ¸…é™¤æ­¤èŠ‚ç‚¹ä¿¡æ¯ï¼Œè¿”å›æ‰“æ–­æ ‡è®°ã€‚</li>
<li>è°ƒç”¨<code>shoudParkAfterFailure</code>,ç¬¬ä¸€æ¬¡è°ƒç”¨è¿”å›falseï¼Œå¹¶å°†å‰é©±èŠ‚ç‚¹æ”¹ä¸º-1ï¼Œç¬¬äºŒæ¬¡å¾ªç¯å¦‚æœå†è¿›å…¥æ­¤æ–¹æ³•ï¼Œä¼šè¿›å…¥é˜»å¡å¹¶æ£€æŸ¥æ‰“æ–­çš„æ–¹æ³•ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="è§£é”æºç ">è§£é”æºç </h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sync ç»§æ‰¿è‡ª AQS</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonfairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="comment">// è§£é”å®ç°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.release(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">release</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="comment">// å°è¯•é‡Šæ”¾é”, è¿›å…¥ ãˆ </span></span><br><span class="line">        <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">            <span class="comment">// é˜Ÿåˆ—å¤´èŠ‚ç‚¹ unpark</span></span><br><span class="line">            <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head; </span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">                <span class="comment">// é˜Ÿåˆ—ä¸ä¸º null</span></span><br><span class="line">                h != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                <span class="comment">// waitStatus == Node.SIGNAL æ‰éœ€è¦ unpark</span></span><br><span class="line">                h.waitStatus != <span class="number">0</span></span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="comment">// unpark AQS ä¸­ç­‰å¾…çš„çº¿ç¨‹, è¿›å…¥ ãˆ¡</span></span><br><span class="line">                unparkSuccessor(h);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ  Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">        <span class="comment">// state--</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState() - releases;</span><br><span class="line">        <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">free</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// æ”¯æŒé”é‡å…¥, åªæœ‰ state å‡ä¸º 0, æ‰é‡Šæ”¾æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            free = <span class="literal">true</span>;</span><br><span class="line">            setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        setState(c);</span><br><span class="line">        <span class="keyword">return</span> free;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¡ AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unparkSuccessor</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœçŠ¶æ€ä¸º Node.SIGNAL å°è¯•é‡ç½®çŠ¶æ€ä¸º 0</span></span><br><span class="line">        <span class="comment">// ä¸æˆåŠŸä¹Ÿå¯ä»¥</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> node.waitStatus;</span><br><span class="line">        <span class="keyword">if</span> (ws &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ‰¾åˆ°éœ€è¦ unpark çš„èŠ‚ç‚¹, ä½†æœ¬èŠ‚ç‚¹ä» AQS é˜Ÿåˆ—ä¸­è„±ç¦», æ˜¯ç”±å”¤é†’èŠ‚ç‚¹å®Œæˆçš„</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">        <span class="comment">// ä¸è€ƒè™‘å·²å–æ¶ˆçš„èŠ‚ç‚¹, ä» AQS é˜Ÿåˆ—ä»åè‡³å‰æ‰¾åˆ°é˜Ÿåˆ—æœ€å‰é¢éœ€è¦ unpark çš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (s == <span class="literal">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            s = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail; t != <span class="literal">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">                <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                    s = t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (s != <span class="literal">null</span>)</span><br><span class="line">            LockSupport.unpark(s.thread);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ€»ç»“ï¼š</p>
<ul>
<li>
<p><code>unlock</code>-&gt;<code>syn.release</code>(1)-&gt;<code>tryRelease</code>(1),å¦‚æœå½“å‰çº¿ç¨‹å¹¶ä¸æŒæœ‰é”ï¼ŒæŠ›å¼‚å¸¸ã€‚stateå‡å»1,å¦‚æœä¹‹åstateä¸º0ï¼Œè§£é”æˆåŠŸï¼Œè¿”å›trueï¼›å¦‚æœä»å¤§äº0ï¼Œè¡¨ç¤ºè§£é”ä¸å®Œå…¨ï¼Œå½“å‰çº¿ç¨‹ä¾æ—§æŒæœ‰é”ï¼Œè¿”å›falseã€‚</p>
</li>
<li>
<p>è¿”å›trueï¼šæ£€æŸ¥AQSé˜Ÿåˆ—ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€å›¾æ˜¯å¦ä¸º</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">SIGNAL</span></span><br></pre></td></tr></table></figure>
<p>(æ„å‘³ç€æœ‰è´£ä»»å”¤é†’å…¶åè®°èŠ‚ç‚¹)ï¼Œå¦‚æœæœ‰ï¼Œè°ƒç”¨</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">unparkSuccessor</span></span><br></pre></td></tr></table></figure>
<p>ã€‚</p>
<ul>
<li>å†<code>unparkSuccessor</code>ä¸­ï¼Œä¸è€ƒè™‘å·²å–æ¶ˆçš„èŠ‚ç‚¹, ä» AQS é˜Ÿåˆ—ä»åè‡³å‰æ‰¾åˆ°é˜Ÿåˆ—æœ€å‰é¢éœ€è¦ unpark çš„èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰ï¼Œå°†å…¶å”¤é†’ã€‚</li>
</ul>
</li>
<li>
<p>è¿”å›falseï¼š</p>
</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1598.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1599.png" alt="img"></p>
<h5 id="éå…¬å¹³æ€§ä½“ç°åœ¨å“ªï¼Ÿ">éå…¬å¹³æ€§ä½“ç°åœ¨å“ªï¼Ÿ</h5>
<p>éå…¬å¹³é”ä¸ä¼šä¿è¯é˜Ÿåˆ—ä¸­â€œæ’åœ¨æœ€å‰é¢çš„çº¿ç¨‹â€ä¼˜å…ˆè·å–é”ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå½“ Thread-1 åˆšè¢«å”¤é†’ï¼Œè¿˜æœªå†æ¬¡æŠ¢åˆ°é”æ—¶ï¼Œè‹¥è¿™æ—¶ Thread-4 æ–°æ¥å¹¶ç«‹å³æ‰§è¡Œ <code>compareAndSetState(0, 1)</code> æˆåŠŸï¼Œ<strong>Thread-1 å°±è¦ç»§ç»­æ’é˜Ÿï¼ŒThread-4 è·å¾—é”</strong>ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1600.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1603.png" alt="img"></p>
<p>stateä¸ºé”çš„é‡å…¥é‡</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1607.png" alt="img"></p>
<table>
<thead>
<tr>
<th>é˜¶æ®µ</th>
<th>æ–¹æ³•</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>åŠ é”å…¥å£</td>
<td><code>lock()</code></td>
<td>éå…¬å¹³é”å°è¯•è·å–é”</td>
</tr>
<tr>
<td>CASå¤±è´¥</td>
<td><code>acquire(1)</code></td>
<td>è¿›å…¥ AQS è·å–æµç¨‹</td>
</tr>
<tr>
<td>åŠ å…¥é˜Ÿåˆ—</td>
<td><code>addWaiter(Node.EXCLUSIVE)</code></td>
<td>å°†å½“å‰çº¿ç¨‹åŒ…è£…æˆ Node å…¥é˜Ÿ</td>
</tr>
<tr>
<td>è‡ªæ—‹å°è¯•</td>
<td><code>acquireQueued(...)</code></td>
<td>æ­»å¾ªç¯ä¸­ä¸æ–­å°è¯•è·å–é”</td>
</tr>
<tr>
<td>æ˜¯å¦é˜»å¡</td>
<td><code>shouldParkAfterFailedAcquire</code></td>
<td>åˆ¤æ–­æ˜¯å¦è¯¥ park å½“å‰çº¿ç¨‹</td>
</tr>
<tr>
<td>é˜»å¡å½“å‰çº¿ç¨‹</td>
<td><code>parkAndCheckInterrupt</code></td>
<td>çº¿ç¨‹è¿›å…¥ç­‰å¾…</td>
</tr>
<tr>
<td>è§£é”å…¥å£</td>
<td><code>unlock()</code></td>
<td>è°ƒç”¨ <code>release(1)</code></td>
</tr>
<tr>
<td>æˆåŠŸé‡Šæ”¾</td>
<td><code>tryRelease()</code></td>
<td>ä¿®æ”¹ stateï¼Œå¹¶å”¤é†’</td>
</tr>
<tr>
<td>å”¤é†’é˜Ÿåˆ—</td>
<td><code>unparkSuccessor()</code></td>
<td>æ‰¾åˆ°ä¸‹ä¸€ä¸ªæœ‰æ•ˆèŠ‚ç‚¹å¹¶å”¤é†’</td>
</tr>
</tbody>
</table>
<h5 id="å¯é‡å…¥åŸç†">å¯é‡å…¥åŸç†</h5>
<p><strong>å¯é‡å…¥é”</strong>è¡¨ç¤ºï¼šä¸€ä¸ªçº¿ç¨‹è·å–äº†é”åï¼Œå¦‚æœå†æ¬¡è¯·æ±‚è¯¥é”ï¼Œä¸ä¼šè¢«é˜»å¡ï¼Œè€Œæ˜¯ä¼šç›´æ¥è·å¾—é”å¹¶å°†è®¡æ•°åŠ ä¸€ã€‚é‡Šæ”¾é”æ—¶åˆ™éœ€å¤šæ¬¡ <code>unlock()</code>ï¼Œç›´åˆ°é‡å…¥æ¬¡æ•°æ¸…é›¶ã€‚</p>
<p>å½“æŒæœ‰é”çš„çº¿ç¨‹å†æ¬¡å°è¯•è·å–é”æ—¶ï¼Œä¼šå°†stateçš„å€¼åŠ 1ï¼Œstateè¡¨ç¤ºé”çš„é‡å…¥é‡ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonfairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">nonfairTryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(current);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœå·²ç»è·å¾—äº†é”, çº¿ç¨‹è¿˜æ˜¯å½“å‰çº¿ç¨‹, è¡¨ç¤ºå‘ç”Ÿäº†é”é‡å…¥</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            <span class="comment">// state++</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">            setState(nextc);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">        <span class="comment">// state-- </span></span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState() - releases;</span><br><span class="line">        <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">free</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// æ”¯æŒé”é‡å…¥, åªæœ‰ state å‡ä¸º 0, æ‰é‡Šæ”¾æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            free = <span class="literal">true</span>;</span><br><span class="line">            setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        setState(c);</span><br><span class="line">        <span class="keyword">return</span> free;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1605.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1606.png" alt="img"></p>
<h5 id="å¯æ‰“æ–­åŸç†">å¯æ‰“æ–­åŸç†</h5>
<p>1.<strong>ä¸å¯æ‰“æ–­æ¨¡å¼</strong>ï¼ˆé»˜è®¤ lockï¼‰</p>
<p>åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œå³ä½¿å®ƒè¢«æ‰“æ–­ï¼Œä»ä¼šé©»ç•™åœ¨ AQS é˜Ÿåˆ—ä¸­ï¼Œå¹¶å°†æ‰“æ–­ä¿¡å·å­˜å‚¨åœ¨ä¸€ä¸ªinterruptå˜é‡ä¸­ã€‚ä¸€ç›´è¦ç­‰åˆ°è·å¾—é”åæ–¹èƒ½å¾—çŸ¥è‡ªå·±è¢«æ‰“æ–­äº†,å¹¶ä¸”è°ƒç”¨<code>selfInterrupt</code>æ–¹æ³•æ‰“æ–­è‡ªå·±ã€‚</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sync ç»§æ‰¿è‡ª AQS</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NonfairSync</span> <span class="keyword">extends</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="function"><span class="keyword">boolean</span> <span class="title">parkAndCheckInterrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ‰“æ–­æ ‡è®°å·²ç»æ˜¯ true, åˆ™ park ä¼šå¤±æ•ˆ</span></span><br><span class="line">        LockSupport.park(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// interrupted ä¼šæ¸…é™¤æ‰“æ–­æ ‡è®°</span></span><br><span class="line">        <span class="function"><span class="keyword">return</span> Thread.<span class="title">interrupted</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="function"><span class="keyword">boolean</span> <span class="title">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> failed = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="keyword">final</span> Node p = node.predecessor();</span><br><span class="line">                <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                    setHead(node);</span><br><span class="line">                    p.next = <span class="keyword">null</span>;</span><br><span class="line">                    failed = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="comment">// è¿˜æ˜¯éœ€è¦è·å¾—é”å, æ‰èƒ½è¿”å›æ‰“æ–­çŠ¶æ€</span></span><br><span class="line">                    <span class="keyword">return</span> interrupted;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (</span><br><span class="line">                    shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                    parkAndCheckInterrupt()</span><br><span class="line">                ) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœæ˜¯å› ä¸º interrupt è¢«å”¤é†’, è¿”å›æ‰“æ–­çŠ¶æ€ä¸º true</span></span><br><span class="line">                    interrupted = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (failed)</span><br><span class="line">                cancelAcquire(node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="function"><span class="keyword">void</span> <span class="title">acquire</span><span class="params">(<span class="keyword">int</span> arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            !tryAcquire(arg) &amp;&amp;</span><br><span class="line">            acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœæ‰“æ–­çŠ¶æ€ä¸º true</span></span><br><span class="line">            selfInterrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å“åº”æ‰“æ–­æ ‡è®°ï¼Œæ‰“æ–­è‡ªå·±</span></span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">selfInterrupt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// é‡æ–°äº§ç”Ÿä¸€æ¬¡ä¸­æ–­</span></span><br><span class="line">        Thread.currentThread().interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1608.png" alt="img"></p>
<p><strong>å¯æ‰“æ–­æ¨¡å¼</strong></p>
<p>æ­¤æ¨¡å¼ä¸‹å³ä½¿çº¿ç¨‹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œä¸€æ—¦è¢«æ‰“æ–­ï¼Œå°±ä¼šç«‹åˆ»æŠ›å‡ºæ‰“æ–­å¼‚å¸¸ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonfairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        <span class="comment">// å¦‚æœæ²¡æœ‰è·å¾—åˆ°é”, è¿›å…¥ ãˆ </span></span><br><span class="line">        <span class="keyword">if</span> (!tryAcquire(arg))</span><br><span class="line">            doAcquireInterruptibly(arg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ  å¯æ‰“æ–­çš„è·å–é”æµç¨‹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doAcquireInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addWaiter(Node.EXCLUSIVE);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">                <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                    setHead(node);</span><br><span class="line">                    p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                    failed = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                    parkAndCheckInterrupt()) &#123;</span><br><span class="line">                    <span class="comment">// åœ¨ park è¿‡ç¨‹ä¸­å¦‚æœè¢« interrupt ä¼šè¿›å…¥æ­¤</span></span><br><span class="line">                    <span class="comment">// è¿™æ—¶å€™æŠ›å‡ºå¼‚å¸¸, è€Œä¸ä¼šå†æ¬¡è¿›å…¥ for (;;)</span></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (failed)</span><br><span class="line">                cancelAcquire(node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1609.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1610.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1611.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1612.png" alt="img"></p>
<h5 id="å…¬å¹³é”å®ç°åŸç†">å…¬å¹³é”å®ç°åŸç†</h5>
<p>ä¸ä¹‹å‰é»˜è®¤çš„éå…¬å¹³é”ï¼ˆ<code>NonfairSync</code>ï¼‰ç›¸æ¯”ï¼Œ<strong>å…¬å¹³é”ï¼ˆ<code>FairSync</code>ï¼‰çš„æ ¸å¿ƒå˜åŒ–</strong>åœ¨äºå®ƒ<strong>é¿å…â€œæ’é˜Ÿâ€ï¼Œéµå¾ªâ€œå…ˆæ¥å…ˆå¾—â€åŸåˆ™</strong>ã€‚</p>
<p>ç®€è€Œè¨€ä¹‹ï¼Œå…¬å¹³ä¸éå…¬å¹³çš„åŒºåˆ«åœ¨äºï¼Œå…¬å¹³é”ä¸­çš„<strong>tryAcquireæ–¹æ³•è¢«é‡å†™äº†</strong>ï¼Œæ–°æ¥çš„çº¿ç¨‹å³ä¾¿å¾—çŸ¥äº†é”çš„stateä¸º0ï¼Œä¹Ÿè¦å…ˆåˆ¤æ–­ç­‰å¾…é˜Ÿåˆ—ä¸­æ˜¯å¦è¿˜æœ‰çº¿ç¨‹ç­‰å¾…ï¼Œåªæœ‰å½“é˜Ÿåˆ—æ²¡æœ‰çº¿ç¨‹ç­‰å¾…å¼ï¼Œæ‰è·å¾—é”ã€‚</p>
<p>å…¬å¹³é” VS éå…¬å¹³é”çš„åŒºåˆ«</p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>éå…¬å¹³é”ï¼ˆé»˜è®¤ï¼‰</th>
<th>å…¬å¹³é”</th>
</tr>
</thead>
<tbody>
<tr>
<td>é”ç«äº‰ç­–ç•¥</td>
<td>å¯ä»¥ç›´æ¥æŠ¢é”</td>
<td>å¿…é¡»æ’é˜Ÿ</td>
</tr>
<tr>
<td>æ’é˜Ÿè¡Œä¸º</td>
<td>å…è®¸æ’é˜Ÿ</td>
<td>ç¦æ­¢æ’é˜Ÿ</td>
</tr>
<tr>
<td>tryAcquire æ˜¯å¦åˆ¤æ–­é˜Ÿåˆ—</td>
<td>å¦</td>
<td>âœ…æ˜¯ï¼ˆæ ¸å¿ƒï¼‰</td>
</tr>
</tbody>
</table>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1613.png" alt="img"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">FairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">3000897897090466540L</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            !tryAcquire(arg) &amp;&amp;</span><br><span class="line">            acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</span><br><span class="line">        ) &#123;</span><br><span class="line">            selfInterrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸éå…¬å¹³é”ä¸»è¦åŒºåˆ«åœ¨äº tryAcquire æ–¹æ³•çš„å®ç°</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å…ˆæ£€æŸ¥ AQS é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹, æ²¡æœ‰æ‰å»ç«äº‰</span></span><br><span class="line">            <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">                compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(current);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">            <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">            setState(nextc);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ  AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="comment">//å­˜ç–‘</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">hasQueuedPredecessors</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        Node s;</span><br><span class="line">        <span class="comment">// h != t æ—¶è¡¨ç¤ºé˜Ÿåˆ—ä¸­æœ‰ Node</span></span><br><span class="line">        <span class="keyword">return</span> h != t &amp;&amp;</span><br><span class="line">            (</span><br><span class="line">            <span class="comment">// (s = h.next) == null è¡¨ç¤ºé˜Ÿåˆ—ä¸­è¿˜æœ‰æ²¡æœ‰è€äºŒ</span></span><br><span class="line">            (s = h.next) == <span class="literal">null</span> ||</span><br><span class="line">            <span class="comment">// æˆ–è€…é˜Ÿåˆ—ä¸­è€äºŒçº¿ç¨‹ä¸æ˜¯æ­¤çº¿ç¨‹</span></span><br><span class="line">            s.thread != Thread.currentThread()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»£ç è§£è¯»ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1614.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1615.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1616.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1617.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1618.png" alt="img"></p>
<h5 id="æ¡ä»¶å˜é‡Conditionå®ç°åŸç†">æ¡ä»¶å˜é‡Conditionå®ç°åŸç†</h5>
<p>ä»€ä¹ˆæ˜¯ Conditionï¼Ÿ</p>
<p><code>Condition</code> æ˜¯é…åˆ <code>ReentrantLock</code> ä½¿ç”¨çš„ä¸€ä¸ªç­‰å¾…/é€šçŸ¥æœºåˆ¶ã€‚æ¯ä¸ª <code>Condition</code> ç»´æŠ¤äº†ä¸€ä¸ª<strong>æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—</strong>ï¼ˆå•å‘é“¾è¡¨ç»“æ„ï¼‰ï¼Œç§°ä¸º <strong>Conditioné˜Ÿåˆ—</strong>ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1626.png" alt="img"></p>
<p>æ¯ä¸ªæ¡ä»¶å˜é‡å…¶å®å°±å¯¹åº”ç€ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œå…¶å®ç°ç±»æ˜¯ ConditionObject</p>
<p>await æµç¨‹</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1628.png" alt="img"></p>
<p>å¼€å§‹ Thread-0 æŒæœ‰é”ï¼Œè°ƒç”¨ awaitï¼Œè¿›å…¥ ConditionObject çš„ addConditionWaiter æµç¨‹</p>
<p>åˆ›å»ºæ–°çš„ Node çŠ¶æ€ä¸º -2ï¼ˆNode.CONDITIONï¼‰ï¼Œå…³è” Thread-0ï¼ŒåŠ å…¥ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1619-1024x379.png" alt="img"></p>
<p>æ¥ä¸‹æ¥è¿›å…¥ AQS çš„ fullyRelease æµç¨‹ï¼Œé‡Šæ”¾åŒæ­¥å™¨ä¸Šçš„é”</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1620-1024x363.png" alt="img"></p>
<p>unpark AQS é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç«äº‰é”ï¼Œå‡è®¾æ²¡æœ‰å…¶ä»–ç«äº‰çº¿ç¨‹ï¼Œé‚£ä¹ˆ Thread-1 ç«äº‰æˆåŠŸ</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1621-1024x373.png" alt="img"></p>
<p>park é˜»å¡ Thread-0</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1622-1024x368.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1629.png" alt="img"></p>
<p>æ€»ç»“ï¼š</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œå…³è”å½“å‰çº¿ç¨‹ï¼Œå¹¶æ’å…¥åˆ°å½“å‰Conditioné˜Ÿåˆ—çš„å°¾éƒ¨</li>
<li>è°ƒç”¨<code>fullRelease</code>ï¼Œå®Œå…¨é‡Šæ”¾åŒæ­¥å™¨ä¸­çš„é”ï¼Œå¹¶è®°å½•å½“å‰çº¿ç¨‹çš„é”é‡å…¥æ•°</li>
<li>å”¤é†’(park)AQSé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹</li>
<li>è°ƒç”¨parkæ–¹æ³•ï¼Œé˜»å¡å½“å‰çº¿ç¨‹ã€‚</li>
</ul>
<p>signal æµç¨‹</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1630.png" alt="img"></p>
<p>å‡è®¾ Thread-1 è¦æ¥å”¤é†’ Thread-0</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1623-1024x468.png" alt="img"></p>
<p>è¿›å…¥ ConditionObject çš„ doSignal æµç¨‹ï¼Œå–å¾—ç­‰å¾…é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ª Nodeï¼Œå³ Thread-0 æ‰€åœ¨ Node</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1624-1024x475.png" alt="img"></p>
<p>æ‰§è¡Œ transferForSignal æµç¨‹ï¼Œå°†è¯¥ Node åŠ å…¥ AQS é˜Ÿåˆ—å°¾éƒ¨ï¼Œå°† Thread-0 çš„ waitStatus æ”¹ä¸º 0ï¼ŒThread-3 çš„ waitStatus æ”¹ä¸º -1</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1625-1024x379.png" alt="img"></p>
<p>Thread-1 é‡Šæ”¾é”ï¼Œè¿›å…¥ unlock æµç¨‹ï¼Œç•¥</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1631.png" alt="img"></p>
<p>æ€»ç»“ï¼š</p>
<ul>
<li>å½“å‰æŒæœ‰é”çš„çº¿ç¨‹å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹ï¼Œè°ƒç”¨doSignalæˆ–doSignalAllæ–¹æ³•ï¼Œå°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªï¼ˆæˆ–å…¨éƒ¨ï¼‰èŠ‚ç‚¹æ’å…¥åˆ°AQSé˜Ÿåˆ—ä¸­çš„å°¾éƒ¨ã€‚</li>
<li>å°†æ’å…¥çš„èŠ‚ç‚¹çš„çŠ¶æ€ä»Conditionè®¾ç½®ä¸º0ï¼Œå°†æ’å…¥èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®ä¸º-1ï¼ˆæ„å‘³ç€è¦æ‰¿æ‹…å”¤é†’åä¸€ä¸ªèŠ‚ç‚¹çš„è´£ä»»ï¼‰</li>
<li>å½“å‰çº¿ç¨‹é‡Šæ”¾é”ï¼ŒparkAQSé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çº¿ç¨‹ã€‚</li>
</ul>
<p>æºç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConditionObject</span> <span class="keyword">implements</span> <span class="title class_">Condition</span>, java.io.Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1173984872572414699L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¬¬ä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Node firstWaiter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ€åä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Node lastWaiter;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ConditionObject</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">    <span class="comment">// ãˆ  æ·»åŠ ä¸€ä¸ª Node è‡³ç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> Node <span class="title function_">addConditionWaiter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> lastWaiter;</span><br><span class="line">        <span class="comment">// æ‰€æœ‰å·²å–æ¶ˆçš„ Node ä»é˜Ÿåˆ—é“¾è¡¨åˆ é™¤, è§ ãˆ¡</span></span><br><span class="line">        <span class="keyword">if</span> (t != <span class="literal">null</span> &amp;&amp; t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">            unlinkCancelledWaiters();</span><br><span class="line">            t = lastWaiter;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªå…³è”å½“å‰çº¿ç¨‹çš„æ–° Node, æ·»åŠ è‡³é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(Thread.currentThread(), Node.CONDITION);</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="literal">null</span>)</span><br><span class="line">            firstWaiter = node;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            t.nextWaiter = node;</span><br><span class="line">        lastWaiter = node;</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å”¤é†’ - å°†æ²¡å–æ¶ˆçš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹è½¬ç§»è‡³ AQS é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doSignal</span><span class="params">(Node first)</span> &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">// å·²ç»æ˜¯å°¾èŠ‚ç‚¹äº†</span></span><br><span class="line">            <span class="keyword">if</span> ( (firstWaiter = first.nextWaiter) == <span class="literal">null</span>) &#123;</span><br><span class="line">                lastWaiter = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            first.nextWaiter = <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span> (</span><br><span class="line">            <span class="comment">// å°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ Node è½¬ç§»è‡³ AQS é˜Ÿåˆ—, ä¸æˆåŠŸä¸”è¿˜æœ‰èŠ‚ç‚¹åˆ™ç»§ç»­å¾ªç¯ ãˆ¢</span></span><br><span class="line">            !transferForSignal(first) &amp;&amp;</span><br><span class="line">            <span class="comment">// é˜Ÿåˆ—è¿˜æœ‰èŠ‚ç‚¹</span></span><br><span class="line">            (first = firstWaiter) != <span class="literal">null</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤–éƒ¨ç±»æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="comment">// ãˆ¢ å¦‚æœèŠ‚ç‚¹çŠ¶æ€æ˜¯å–æ¶ˆ, è¿”å› false è¡¨ç¤ºè½¬ç§»å¤±è´¥, å¦åˆ™è½¬ç§»æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">transferForSignal</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœçŠ¶æ€å·²ç»ä¸æ˜¯ Node.CONDITION, è¯´æ˜è¢«å–æ¶ˆäº†</span></span><br><span class="line">        <span class="keyword">if</span> (!compareAndSetWaitStatus(node, Node.CONDITION, <span class="number">0</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// åŠ å…¥ AQS é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> enq(node);</span><br><span class="line">        <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> p.waitStatus;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            <span class="comment">// ä¸Šä¸€ä¸ªèŠ‚ç‚¹è¢«å–æ¶ˆ</span></span><br><span class="line">            ws &gt; <span class="number">0</span> ||</span><br><span class="line">            <span class="comment">// ä¸Šä¸€ä¸ªèŠ‚ç‚¹ä¸èƒ½è®¾ç½®çŠ¶æ€ä¸º Node.SIGNAL</span></span><br><span class="line">            !compareAndSetWaitStatus(p, ws, Node.SIGNAL) </span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="comment">// unpark å–æ¶ˆé˜»å¡, è®©çº¿ç¨‹é‡æ–°åŒæ­¥çŠ¶æ€</span></span><br><span class="line">            LockSupport.unpark(node.thread);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å…¨éƒ¨å”¤é†’ - ç­‰å¾…é˜Ÿåˆ—çš„æ‰€æœ‰èŠ‚ç‚¹è½¬ç§»è‡³ AQS é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doSignalAll</span><span class="params">(Node first)</span> &#123;</span><br><span class="line">        lastWaiter = firstWaiter = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">next</span> <span class="operator">=</span> first.nextWaiter;</span><br><span class="line">            first.nextWaiter = <span class="literal">null</span>;</span><br><span class="line">            transferForSignal(first);</span><br><span class="line">            first = next;</span><br><span class="line">        &#125; <span class="keyword">while</span> (first != <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlinkCancelledWaiters</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å”¤é†’ - å¿…é¡»æŒæœ‰é”æ‰èƒ½å”¤é†’, å› æ­¤ doSignal å†…æ— éœ€è€ƒè™‘åŠ é”</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">signal</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">        <span class="type">Node</span> <span class="variable">first</span> <span class="operator">=</span> firstWaiter;</span><br><span class="line">        <span class="keyword">if</span> (first != <span class="literal">null</span>)</span><br><span class="line">            doSignal(first);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å…¨éƒ¨å”¤é†’ - å¿…é¡»æŒæœ‰é”æ‰èƒ½å”¤é†’, å› æ­¤ doSignalAll å†…æ— éœ€è€ƒè™‘åŠ é”</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">signalAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">        <span class="type">Node</span> <span class="variable">first</span> <span class="operator">=</span> firstWaiter;</span><br><span class="line">        <span class="keyword">if</span> (first != <span class="literal">null</span>)</span><br><span class="line">            doSignalAll(first);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸å¯æ‰“æ–­ç­‰å¾… - ç›´åˆ°è¢«å”¤é†’</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">awaitUninterruptibly</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// æ·»åŠ ä¸€ä¸ª Node è‡³ç­‰å¾…é˜Ÿåˆ—, è§ ãˆ </span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addConditionWaiter();</span><br><span class="line">        <span class="comment">// é‡Šæ”¾èŠ‚ç‚¹æŒæœ‰çš„é”, è§ ãˆ£</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">savedState</span> <span class="operator">=</span> fullyRelease(node);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœè¯¥èŠ‚ç‚¹è¿˜æ²¡æœ‰è½¬ç§»è‡³ AQS é˜Ÿåˆ—, é˜»å¡</span></span><br><span class="line">        <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">            <span class="comment">// park é˜»å¡</span></span><br><span class="line">            LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">            <span class="comment">// å¦‚æœè¢«æ‰“æ–­, ä»…è®¾ç½®æ‰“æ–­çŠ¶æ€</span></span><br><span class="line">            <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">                interrupted = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å”¤é†’å, å°è¯•ç«äº‰é”, å¦‚æœå¤±è´¥è¿›å…¥ AQS é˜Ÿåˆ—</span></span><br><span class="line">        <span class="keyword">if</span> (acquireQueued(node, savedState) || interrupted)</span><br><span class="line">            selfInterrupt();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doSignalAll</span><span class="params">(Node first)</span> &#123;</span><br><span class="line">        lastWaiter = firstWaiter = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">next</span> <span class="operator">=</span> first.nextWaiter;</span><br><span class="line">            first.nextWaiter = <span class="literal">null</span>;</span><br><span class="line">            transferForSignal(first);</span><br><span class="line">            first = next;</span><br><span class="line">        &#125; <span class="keyword">while</span> (first != <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlinkCancelledWaiters</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å”¤é†’ - å¿…é¡»æŒæœ‰é”æ‰èƒ½å”¤é†’, å› æ­¤ doSignal å†…æ— éœ€è€ƒè™‘åŠ é”</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">signal</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">        <span class="type">Node</span> <span class="variable">first</span> <span class="operator">=</span> firstWaiter;</span><br><span class="line">        <span class="keyword">if</span> (first != <span class="literal">null</span>)</span><br><span class="line">            doSignal(first);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å…¨éƒ¨å”¤é†’ - å¿…é¡»æŒæœ‰é”æ‰èƒ½å”¤é†’, å› æ­¤ doSignalAll å†…æ— éœ€è€ƒè™‘åŠ é”</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">signalAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">        <span class="type">Node</span> <span class="variable">first</span> <span class="operator">=</span> firstWaiter;</span><br><span class="line">        <span class="keyword">if</span> (first != <span class="literal">null</span>)</span><br><span class="line">            doSignalAll(first);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸å¯æ‰“æ–­ç­‰å¾… - ç›´åˆ°è¢«å”¤é†’</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">awaitUninterruptibly</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// æ·»åŠ ä¸€ä¸ª Node è‡³ç­‰å¾…é˜Ÿåˆ—, è§ ãˆ </span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addConditionWaiter();</span><br><span class="line">        <span class="comment">// é‡Šæ”¾èŠ‚ç‚¹æŒæœ‰çš„é”, è§ ãˆ£</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">savedState</span> <span class="operator">=</span> fullyRelease(node);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœè¯¥èŠ‚ç‚¹è¿˜æ²¡æœ‰è½¬ç§»è‡³ AQS é˜Ÿåˆ—, é˜»å¡</span></span><br><span class="line">        <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">            <span class="comment">// park é˜»å¡</span></span><br><span class="line">            LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">            <span class="comment">// å¦‚æœè¢«æ‰“æ–­, ä»…è®¾ç½®æ‰“æ–­çŠ¶æ€</span></span><br><span class="line">            <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">                interrupted = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å”¤é†’å, å°è¯•ç«äº‰é”, å¦‚æœå¤±è´¥è¿›å…¥ AQS é˜Ÿåˆ—</span></span><br><span class="line">        <span class="keyword">if</span> (acquireQueued(node, savedState) || interrupted)</span><br><span class="line">            selfInterrupt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤–éƒ¨ç±»æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="comment">// ãˆ£ å› ä¸ºæŸçº¿ç¨‹å¯èƒ½é‡å…¥ï¼Œéœ€è¦å°† state å…¨éƒ¨é‡Šæ”¾</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">fullyRelease</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">savedState</span> <span class="operator">=</span> getState();</span><br><span class="line">            <span class="keyword">if</span> (release(savedState)) &#123;</span><br><span class="line">                failed = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">return</span> savedState;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (failed)</span><br><span class="line">                node.waitStatus = Node.CANCELLED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ‰“æ–­æ¨¡å¼ - åœ¨é€€å‡ºç­‰å¾…æ—¶é‡æ–°è®¾ç½®æ‰“æ–­çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REINTERRUPT</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// æ‰“æ–­æ¨¡å¼ - åœ¨é€€å‡ºç­‰å¾…æ—¶æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">THROW_IE</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ‰“æ–­æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">checkInterruptWhileWaiting</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Thread.interrupted() ?</span><br><span class="line">            (transferAfterCancelledWait(node) ? THROW_IE : REINTERRUPT) :</span><br><span class="line">        <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ãˆ¤ åº”ç”¨æ‰“æ–­æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">reportInterruptAfterWait</span><span class="params">(<span class="type">int</span> interruptMode)</span></span><br><span class="line">        <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">if</span> (interruptMode == THROW_IE)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (interruptMode == REINTERRUPT)</span><br><span class="line">            selfInterrupt();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç­‰å¾… - ç›´åˆ°è¢«å”¤é†’æˆ–æ‰“æ–­</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ·»åŠ ä¸€ä¸ª Node è‡³ç­‰å¾…é˜Ÿåˆ—, è§ ãˆ </span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addConditionWaiter();</span><br><span class="line">        <span class="comment">// é‡Šæ”¾èŠ‚ç‚¹æŒæœ‰çš„é”</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">savedState</span> <span class="operator">=</span> fullyRelease(node);</span><br><span class="line">        <span class="type">int</span> <span class="variable">interruptMode</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœè¯¥èŠ‚ç‚¹è¿˜æ²¡æœ‰è½¬ç§»è‡³ AQS é˜Ÿåˆ—, é˜»å¡</span></span><br><span class="line">        <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">            <span class="comment">// park é˜»å¡</span></span><br><span class="line">            LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">            <span class="comment">// å¦‚æœè¢«æ‰“æ–­, é€€å‡ºç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">            <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é€€å‡ºç­‰å¾…é˜Ÿåˆ—å, è¿˜éœ€è¦è·å¾— AQS é˜Ÿåˆ—çš„é”</span></span><br><span class="line">        <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</span><br><span class="line">            interruptMode = REINTERRUPT;</span><br><span class="line">        <span class="comment">// æ‰€æœ‰å·²å–æ¶ˆçš„ Node ä»é˜Ÿåˆ—é“¾è¡¨åˆ é™¤, è§ ãˆ¡</span></span><br><span class="line">        <span class="keyword">if</span> (node.nextWaiter != <span class="literal">null</span>) </span><br><span class="line">            unlinkCancelledWaiters();</span><br><span class="line">        <span class="comment">// åº”ç”¨æ‰“æ–­æ¨¡å¼, è§ ãˆ¤</span></span><br><span class="line">        <span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</span><br><span class="line">            reportInterruptAfterWait(interruptMode);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å‘Conditionä¸­çš„ç­‰å¾…é˜Ÿåˆ—ä¸­æ–°å¢èŠ‚ç‚¹ï¼Œå¹¶å°†æ­¤èŠ‚ç‚¹è¿”å›</span></span><br><span class="line">    <span class="keyword">private</span> Node <span class="title function_">addConditionWaiter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> lastWaiter;</span><br><span class="line">        <span class="comment">// If lastWaiter is cancelled, clean out.</span></span><br><span class="line">        <span class="keyword">if</span> (t != <span class="literal">null</span> &amp;&amp; t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">            unlinkCancelledWaiters();</span><br><span class="line">            t = lastWaiter;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(Thread.currentThread(), Node.CONDITION);</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="literal">null</span>)</span><br><span class="line">            firstWaiter = node;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            t.nextWaiter = node;</span><br><span class="line">        lastWaiter = node;</span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦åœ¨åŒæ­¥å™¨ä¸­çš„é˜Ÿåˆ—ä¸­ç­‰å¾…é”</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">isOnSyncQueue</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (node.waitStatus == Node.CONDITION || node.prev == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (node.next != <span class="literal">null</span>) <span class="comment">// If has successor, it must be on queue</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * node.prev can be non-null, but not yet on queue because</span></span><br><span class="line"><span class="comment">         * the CAS to place it on queue can fail. So we have to</span></span><br><span class="line"><span class="comment">         * traverse from tail to make sure it actually made it.  It</span></span><br><span class="line"><span class="comment">         * will always be near the tail in calls to this method, and</span></span><br><span class="line"><span class="comment">         * unless the CAS failed (which is unlikely), it will be</span></span><br><span class="line"><span class="comment">         * there, so we hardly ever traverse much.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> findNodeFromTail(node);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç­‰å¾… - ç›´åˆ°è¢«å”¤é†’æˆ–æ‰“æ–­æˆ–è¶…æ—¶</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">long</span> <span class="title function_">awaitNanos</span><span class="params">(<span class="type">long</span> nanosTimeout)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ·»åŠ ä¸€ä¸ª Node è‡³ç­‰å¾…é˜Ÿåˆ—, è§ ãˆ </span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addConditionWaiter();</span><br><span class="line">        <span class="comment">// é‡Šæ”¾èŠ‚ç‚¹æŒæœ‰çš„é”</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">savedState</span> <span class="operator">=</span> fullyRelease(node);</span><br><span class="line">        <span class="comment">// è·å¾—æœ€åæœŸé™</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">long</span> <span class="variable">deadline</span> <span class="operator">=</span> System.nanoTime() + nanosTimeout;</span><br><span class="line">        <span class="type">int</span> <span class="variable">interruptMode</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœè¯¥èŠ‚ç‚¹è¿˜æ²¡æœ‰è½¬ç§»è‡³ AQS é˜Ÿåˆ—, é˜»å¡</span></span><br><span class="line">        <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">            <span class="comment">// å·²è¶…æ—¶, é€€å‡ºç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">            <span class="keyword">if</span> (nanosTimeout &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">                transferAfterCancelledWait(node);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// park é˜»å¡ä¸€å®šæ—¶é—´, spinForTimeoutThreshold ä¸º 1000 ns</span></span><br><span class="line">            <span class="keyword">if</span> (nanosTimeout &gt;= spinForTimeoutThreshold)</span><br><span class="line">                LockSupport.parkNanos(<span class="built_in">this</span>, nanosTimeout);</span><br><span class="line">            <span class="comment">// å¦‚æœè¢«æ‰“æ–­, é€€å‡ºç­‰å¾…é˜Ÿåˆ—</span></span><br><span class="line">            <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            nanosTimeout = deadline - System.nanoTime();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é€€å‡ºç­‰å¾…é˜Ÿåˆ—å, è¿˜éœ€è¦è·å¾— AQS é˜Ÿåˆ—çš„é”</span></span><br><span class="line">        <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</span><br><span class="line">            interruptMode = REINTERRUPT;</span><br><span class="line">        <span class="comment">// æ‰€æœ‰å·²å–æ¶ˆçš„ Node ä»é˜Ÿåˆ—é“¾è¡¨åˆ é™¤, è§ ãˆ¡</span></span><br><span class="line">        <span class="keyword">if</span> (node.nextWaiter != <span class="literal">null</span>)</span><br><span class="line">            unlinkCancelledWaiters();</span><br><span class="line">        <span class="comment">// åº”ç”¨æ‰“æ–­æ¨¡å¼, è§ ãˆ¤</span></span><br><span class="line">        <span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</span><br><span class="line">            reportInterruptAfterWait(interruptMode);</span><br><span class="line">        <span class="keyword">return</span> deadline - System.nanoTime();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç­‰å¾… - ç›´åˆ°è¢«å”¤é†’æˆ–æ‰“æ–­æˆ–è¶…æ—¶, é€»è¾‘ç±»ä¼¼äº awaitNanos</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">awaitUntil</span><span class="params">(Date deadline)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç­‰å¾… - ç›´åˆ°è¢«å”¤é†’æˆ–æ‰“æ–­æˆ–è¶…æ—¶, é€»è¾‘ç±»ä¼¼äº awaitNanos</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">await</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å·¥å…·æ–¹æ³• çœç•¥ ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ä¸¤ç±»ç­‰å¾…é˜Ÿåˆ—å¯¹æ¯”</p>
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>é˜Ÿåˆ—åç§°</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>Condition é˜Ÿåˆ—</td>
<td><code>firstWaiter</code></td>
<td>ä¿å­˜ <code>await</code> çš„çº¿ç¨‹</td>
</tr>
<tr>
<td>AQS é˜Ÿåˆ—</td>
<td>CLH é˜Ÿåˆ—</td>
<td>æ­£åœ¨ç­‰å¾…é”çš„çº¿ç¨‹</td>
</tr>
</tbody>
</table>
<p>é‡è¦ï¼šawait çº¿ç¨‹å¿…é¡»å…ˆä» Condition é˜Ÿåˆ—è¢« signal å”¤é†’ â†’ å†è½¬ç§»åˆ° AQS é˜Ÿåˆ—å‚ä¸é”ç«äº‰ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1632.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1633.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1634.png" alt="img"></p>
<h3 id="3-è¯»å†™é”ä¹‹ReentrantReadWriteLock">3.è¯»å†™é”ä¹‹ReentrantReadWriteLock</h3>
<h4 id="ReentrantReadWriteLockä»‹ç»">ReentrantReadWriteLockä»‹ç»</h4>
<p>ä»€ä¹ˆæ˜¯ <code>ReentrantReadWriteLock</code></p>
<p>1.å®šä¹‰</p>
<p>å®ƒå°†é”åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š</p>
<ul>
<li><strong>è¯»é” ReadLock</strong>ï¼šå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è·å¾—ï¼Œé€‚ç”¨äºåªè¯»æ“ä½œã€‚</li>
<li><strong>å†™é” WriteLock</strong>ï¼šåŒä¸€æ—¶åˆ»åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è·å¾—ï¼Œé€‚ç”¨äºå†™æ“ä½œã€‚</li>
</ul>
<blockquote>
<p><strong>è¯»-è¯»ä¸äº’æ–¥ï¼Œè¯»-å†™/å†™-å†™äº’æ–¥</strong></p>
</blockquote>
<p>å½“è¯»æ“ä½œè¿œè¿œé«˜äºå†™æ“ä½œæ—¶ï¼Œè¿™æ—¶å€™ä½¿ç”¨<code>è¯»å†™é”</code>è®©<code>è¯»-è¯»</code>å¯ä»¥å¹¶å‘ï¼Œæé«˜æ€§èƒ½ã€‚ ç±»ä¼¼äºæ•°æ®åº“ä¸­çš„<code>select ... from ... lock in share mode</code></p>
<p>2.è¯»å†™é”çš„åº”ç”¨ï¼šæ•°æ®å®¹å™¨ç¤ºä¾‹</p>
<p>æä¾›ä¸€ä¸ª<code>æ•°æ®å®¹å™¨ç±»</code>å†…éƒ¨åˆ†åˆ«ä½¿ç”¨è¯»é”ä¿æŠ¤æ•°æ®çš„ read() æ–¹æ³•ï¼Œå†™é”ä¿æŠ¤æ•°æ®çš„ write() æ–¹æ³•</p>
<p>æµ‹è¯•</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> DataContainer &#123;</span><br><span class="line">    private <span class="keyword">Object</span> data;</span><br><span class="line">    private ReentrantReadWriteLock rw = <span class="built_in">new</span> ReentrantReadWriteLock();</span><br><span class="line">    private ReentrantReadWriteLock.ReadLock r = rw.readLock();</span><br><span class="line">    private ReentrantReadWriteLock.WriteLock w = rw.writeLock();</span><br><span class="line">    <span class="built_in">public</span> <span class="keyword">Object</span> <span class="keyword">read</span>() &#123;</span><br><span class="line">        <span class="keyword">log</span>.<span class="keyword">debug</span>(&quot;è·å–è¯»é”...&quot;);</span><br><span class="line">        r.<span class="keyword">lock</span>();</span><br><span class="line">        try &#123;</span><br><span class="line">            <span class="keyword">log</span>.<span class="keyword">debug</span>(&quot;è¯»å–&quot;);</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            <span class="keyword">log</span>.<span class="keyword">debug</span>(&quot;é‡Šæ”¾è¯»é”...&quot;);</span><br><span class="line">            r.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">public</span> <span class="type">void</span> <span class="keyword">write</span>() &#123;</span><br><span class="line">        <span class="keyword">log</span>.<span class="keyword">debug</span>(&quot;è·å–å†™é”...&quot;);</span><br><span class="line">        w.<span class="keyword">lock</span>();</span><br><span class="line">        try &#123;</span><br><span class="line">            <span class="keyword">log</span>.<span class="keyword">debug</span>(&quot;å†™å…¥&quot;);</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            <span class="keyword">log</span>.<span class="keyword">debug</span>(&quot;é‡Šæ”¾å†™é”...&quot;);</span><br><span class="line">            w.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1635.png" alt="img"></p>
<p>ï¼ˆ1ï¼‰æµ‹è¯•<code>è¯»é”-è¯»é”</code>å¯ä»¥å¹¶å‘</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DataContainer dataContainer = <span class="keyword">new</span> DataContainer();</span><br><span class="line"><span class="keyword">new</span> Thread<span class="function"><span class="params">(() -&gt; &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    dataContainer.read();</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;, <span class="string">&quot;t1&quot;</span>)</span>.<span class="title">start</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function"><span class="title">new</span> <span class="title">Thread</span><span class="params">(() -&gt; &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    dataContainer.read();</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;, <span class="string">&quot;t2&quot;</span>)</span>.<span class="title">start</span><span class="params">()</span>;</span></span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºç»“æœï¼Œä»è¿™é‡Œå¯ä»¥çœ‹åˆ° Thread-0 é”å®šæœŸé—´ï¼ŒThread-1 çš„è¯»æ“ä½œä¸å—å½±å“ï¼ˆè¯´æ˜ <strong>è¯»-è¯»ä¸äº’æ–¥</strong>ï¼‰</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">05</span>:<span class="number">14.341</span> c<span class="selector-class">.DataContainer</span> <span class="selector-attr">[t2]</span> - è·å–è¯»é”... </span><br><span class="line"><span class="number">14</span>:<span class="number">05</span>:<span class="number">14.341</span> c<span class="selector-class">.DataContainer</span> <span class="selector-attr">[t1]</span> - è·å–è¯»é”... </span><br><span class="line"><span class="number">14</span>:<span class="number">05</span>:<span class="number">14.345</span> c<span class="selector-class">.DataContainer</span> <span class="selector-attr">[t1]</span> - è¯»å–</span><br><span class="line"><span class="number">14</span>:<span class="number">05</span>:<span class="number">14.345</span> c<span class="selector-class">.DataContainer</span> <span class="selector-attr">[t2]</span> - è¯»å–</span><br><span class="line"><span class="number">14</span>:<span class="number">05</span>:<span class="number">15.365</span> c<span class="selector-class">.DataContainer</span> <span class="selector-attr">[t2]</span> - é‡Šæ”¾è¯»é”... </span><br><span class="line"><span class="number">14</span>:<span class="number">05</span>:<span class="number">15.386</span> c<span class="selector-class">.DataContainer</span> <span class="selector-attr">[t1]</span> - é‡Šæ”¾è¯»é”... </span><br></pre></td></tr></table></figure>
<p>ï¼ˆ2ï¼‰æµ‹è¯•<code>è¯»é”-å†™é”</code>ç›¸äº’é˜»å¡</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DataContainer dataContainer = <span class="keyword">new</span> DataContainer();</span><br><span class="line"><span class="keyword">new</span> Thread<span class="function"><span class="params">(() -&gt; &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    dataContainer.read();</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;, <span class="string">&quot;t1&quot;</span>)</span>.<span class="title">start</span><span class="params">()</span>;</span></span><br><span class="line"><span class="function"><span class="title">Thread</span>.<span class="title">sleep</span><span class="params">(<span class="number">100</span>)</span>;</span></span><br><span class="line"><span class="function"><span class="title">new</span> <span class="title">Thread</span><span class="params">(() -&gt; &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    dataContainer.write();</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;, <span class="string">&quot;t2&quot;</span>)</span>.<span class="title">start</span><span class="params">()</span>;</span></span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºç»“æœï¼ˆå†™çº¿ç¨‹å¿…é¡»ç­‰å¾…è¯»çº¿ç¨‹é‡Šæ”¾é”åæ‰èƒ½è¿›è¡Œï¼‰</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">21.838</span> c<span class="selector-class">.DataContainer</span> <span class="selector-attr">[t1]</span> - è·å–è¯»é”... </span><br><span class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">21.838</span> c<span class="selector-class">.DataContainer</span> <span class="selector-attr">[t2]</span> - è·å–å†™é”... </span><br><span class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">21.841</span> c<span class="selector-class">.DataContainer</span> <span class="selector-attr">[t2]</span> - å†™å…¥</span><br><span class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">22.843</span> c<span class="selector-class">.DataContainer</span> <span class="selector-attr">[t2]</span> - é‡Šæ”¾å†™é”... </span><br><span class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">22.843</span> c<span class="selector-class">.DataContainer</span> <span class="selector-attr">[t1]</span> - è¯»å–</span><br><span class="line"><span class="number">14</span>:<span class="number">04</span>:<span class="number">23.843</span> c<span class="selector-class">.DataContainer</span> <span class="selector-attr">[t1]</span> - é‡Šæ”¾è¯»é”... </span><br></pre></td></tr></table></figure>
<p>ï¼ˆ3ï¼‰<code>å†™é”-å†™é”</code>ä¹Ÿæ˜¯ç›¸äº’é˜»å¡çš„ï¼Œè¿™é‡Œå°±ä¸æµ‹è¯•äº†</p>
<p>3.<strong>æ³¨æ„äº‹é¡¹</strong></p>
<ul>
<li>è¯»é”ä¸æ”¯æŒæ¡ä»¶å˜é‡</li>
</ul>
<p>ä½ ä¸èƒ½å¯¹ <code>readLock()</code> ä½¿ç”¨ <code>await()</code> / <code>signal()</code>ï¼Œä»…å†™é”æ”¯æŒæ¡ä»¶ç­‰å¾…æœºåˆ¶ã€‚</p>
<ul>
<li>é‡å…¥æ—¶å‡çº§ä¸æ”¯æŒï¼ˆè¯» â†’ å†™ï¼‰ï¼šå³æŒæœ‰è¯»é”çš„æƒ…å†µä¸‹å»è·å–å†™é”ï¼Œä¼šå¯¼è‡´è·å–å†™é”æ°¸ä¹…ç­‰å¾…</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1636.png" alt="img"></p>
<ul>
<li>é‡å…¥æ—¶é™çº§æ”¯æŒï¼ˆå†™ â†’ è¯»ï¼‰ï¼šå³æŒæœ‰å†™é”çš„æƒ…å†µä¸‹å»è·å–è¯»é”</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">CachedData</span> &#123;</span><br><span class="line">    Object data;</span><br><span class="line">    <span class="comment">// æ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœå¤±æ•ˆï¼Œéœ€è¦é‡æ–°è®¡ç®— data</span></span><br><span class="line">    <span class="keyword">volatile</span> boolean cacheValid;</span><br><span class="line">    final ReentrantReadWriteLock rwl = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">processCachedData</span>()</span> &#123;</span><br><span class="line">        rwl.readLock().<span class="keyword">lock</span>();</span><br><span class="line">        <span class="keyword">if</span> (!cacheValid) &#123;</span><br><span class="line">            <span class="comment">// è·å–å†™é”å‰å¿…é¡»é‡Šæ”¾è¯»é”</span></span><br><span class="line">            rwl.readLock().unlock();</span><br><span class="line">            rwl.writeLock().<span class="keyword">lock</span>();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// åˆ¤æ–­æ˜¯å¦æœ‰å…¶å®ƒçº¿ç¨‹å·²ç»è·å–äº†å†™é”ã€æ›´æ–°äº†ç¼“å­˜, é¿å…é‡å¤æ›´æ–°</span></span><br><span class="line">                <span class="keyword">if</span> (!cacheValid) &#123;</span><br><span class="line">                    data = ...</span><br><span class="line">                        cacheValid = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// é™çº§ä¸ºè¯»é”, é‡Šæ”¾å†™é”, è¿™æ ·èƒ½å¤Ÿè®©å…¶å®ƒçº¿ç¨‹è¯»å–ç¼“å­˜</span></span><br><span class="line">                rwl.readLock().<span class="keyword">lock</span>();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                rwl.writeLock().unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è‡ªå·±ç”¨å®Œæ•°æ®, é‡Šæ”¾è¯»é” </span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            use(data);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            rwl.readLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1637.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1638.png" alt="img"></p>
<p>æ€»ç»“ï¼š</p>
<table>
<thead>
<tr>
<th>æƒ…å†µ</th>
<th>æ˜¯å¦äº’æ–¥</th>
<th>ç‰¹æ€§</th>
</tr>
</thead>
<tbody>
<tr>
<td>è¯» vs è¯»</td>
<td>å¦</td>
<td>å¹¶å‘æ‰§è¡Œ</td>
</tr>
<tr>
<td>è¯» vs å†™</td>
<td>æ˜¯</td>
<td>å†™æ“ä½œç­‰å¾…</td>
</tr>
<tr>
<td>å†™ vs å†™</td>
<td>æ˜¯</td>
<td>æ’ä»–æ“ä½œ</td>
</tr>
<tr>
<td>è¯» â†’ å†™å‡çº§</td>
<td>âŒ æ­»é”</td>
<td>ä¸å…è®¸</td>
</tr>
<tr>
<td>å†™ â†’ è¯»é™çº§</td>
<td>âœ…</td>
<td>æ”¯æŒç¼“å­˜ä¼˜åŒ–ç­‰åœºæ™¯</td>
</tr>
<tr>
<td>è¯»é”æ”¯æŒæ¡ä»¶å˜é‡</td>
<td>âŒ</td>
<td>ä¸æ”¯æŒ await/signal</td>
</tr>
<tr>
<td>å†™é”æ”¯æŒæ¡ä»¶å˜é‡</td>
<td>âœ…</td>
<td>å¯ç”¨äºçº¿ç¨‹åè°ƒ</td>
</tr>
</tbody>
</table>
<h4 id="ReentrantReadWriteLockåº”ç”¨åˆ°ç¼“å­˜">ReentrantReadWriteLockåº”ç”¨åˆ°ç¼“å­˜</h4>
<p>è¿™éƒ¨åˆ†å†…å®¹è®²çš„æ˜¯ä½¿ç”¨ <strong><code>ReentrantReadWriteLock</code> å®ç°ä¸€è‡´æ€§ç¼“å­˜</strong> çš„åº”ç”¨ç¤ºä¾‹ï¼ŒåŒæ—¶ä¹Ÿæ¢è®¨äº†â€œç¼“å­˜æ›´æ–°ç­–ç•¥â€çš„ä¸¤ä¸ªé€‰æ‹©ï¼š<strong>å…ˆåˆ ç¼“å­˜ vs å…ˆæ”¹æ•°æ®åº“</strong></p>
<h5 id="ç¼“å­˜æ›´æ–°ç­–ç•¥">ç¼“å­˜æ›´æ–°ç­–ç•¥</h5>
<p>1.å…ˆåˆ ç¼“å­˜ï¼Œå†æ”¹æ•°æ®åº“ï¼ˆæ¨èï¼‰</p>
<ul>
<li>æµç¨‹ï¼šå…ˆåˆ é™¤ç¼“å­˜ â†’ æ›´æ–°æ•°æ®åº“</li>
<li>å¯èƒ½çš„é—®é¢˜ï¼š
<ul>
<li>åˆ é™¤ç¼“å­˜åï¼Œè¿˜æ²¡æ¥å¾—åŠæ›´æ–°æ•°æ®åº“ï¼Œæ­¤æ—¶æœ‰æŸ¥è¯¢è¯·æ±‚è¿›å…¥ï¼ŒæŸ¥ä¸åˆ°ç¼“å­˜å°±å»æŸ¥æ•°æ®åº“ï¼ŒæŸ¥åˆ°æ—§å€¼ååˆå†™å…¥ç¼“å­˜ï¼Œé€ æˆ<strong>è„æ•°æ®å›å†™ç¼“å­˜</strong></li>
</ul>
</li>
</ul>
<blockquote>
<p>å³â€œç¼“å­˜è¢«åˆ  + æŸ¥è¯¢åˆšå¥½åˆ°è¾¾â€çš„å°æ¦‚ç‡é—®é¢˜</p>
<p>å…ˆåˆ ç¼“å­˜ï¼Œå†™åº“æ…¢</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1639-1024x458.png" alt="img"></p>
<p>â†’è„æ•°æ®å†™å›ç¼“å­˜</p>
<p>æŸ¥è¯¢è¯·æ±‚åˆšå¥½ç©¿é€ç¼“å­˜å¤±æ•ˆ(å‡è®¾æŸ¥è¯¢çº¿ç¨‹ A æŸ¥è¯¢æ•°æ®æ—¶æ°å¥½ç¼“å­˜æ•°æ®ç”±äºæ—¶é—´åˆ°æœŸå¤±æ•ˆï¼Œæˆ–æ˜¯ç¬¬ä¸€æ¬¡æŸ¥è¯¢)</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1642-1024x457.png" alt="img"></p>
<p>â†’ç¼“å­˜è„å›å†™ï¼ˆæå°æ¦‚ç‡ï¼‰</p>
</blockquote>
<p>2.å…ˆæ”¹æ•°æ®åº“ï¼Œå†åˆ ç¼“å­˜</p>
<ul>
<li>æµç¨‹ï¼šå…ˆæ›´æ–°æ•°æ®åº“ â†’ åˆ é™¤ç¼“å­˜</li>
<li>å¯èƒ½çš„é—®é¢˜ï¼š
<ul>
<li>å¦‚æœåˆ é™¤ç¼“å­˜å¤±è´¥ï¼ˆä¾‹å¦‚ Redis å®•æœºï¼‰ï¼Œæ–°æ—§æ•°æ®åŒæ—¶å­˜åœ¨äºç¼“å­˜å’Œæ•°æ®åº“ï¼Œé€ æˆ<strong>æ•°æ®ä¸ä¸€è‡´</strong></li>
</ul>
</li>
</ul>
<p>å…ˆæ›´æ–°æ•°æ®åº“ï¼Œåˆ ç¼“å­˜å¤±è´¥</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1640-1024x435.png" alt="img"></p>
<p>â†’ æ•°æ®ä¸ä¸€è‡´</p>
<h5 id="ä½¿ç”¨-ReentrantReadWriteLock-å®ç°ç¼“å­˜ä¸€è‡´æ€§">ä½¿ç”¨ <code>ReentrantReadWriteLock</code> å®ç°ç¼“å­˜ä¸€è‡´æ€§</h5>
<p>åŸºæœ¬è®¾è®¡æ€è·¯ï¼š</p>
<ul>
<li>ä½¿ç”¨ <code>HashMap</code> ä½œä¸ºç¼“å­˜ï¼Œéçº¿ç¨‹å®‰å…¨ â†’ ç”¨ <code>è¯»å†™é”</code>ä¿æŠ¤</li>
<li><strong>å†™æ“ä½œåŠ å†™é”ï¼š</strong> åªèƒ½ä¸€ä¸ªçº¿ç¨‹å†™å…¥ç¼“å­˜ï¼ˆæˆ–æ¸…ç©ºç¼“å­˜ï¼‰</li>
<li><strong>è¯»æ“ä½œåŠ è¯»é”ï¼š</strong> å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»ç¼“å­˜</li>
<li>å¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼š
<ul>
<li>å‡çº§ä¸ºå†™é”ï¼Œ<strong>å†æ¬¡æ£€æŸ¥ç¼“å­˜</strong></li>
<li>å¦‚æœä¾æ—§æœªå‘½ä¸­ â†’ æŸ¥è¯¢æ•°æ®åº“ â†’ å†™å…¥ç¼“å­˜</li>
</ul>
</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">GenericCachedDao</span>&lt;<span class="title">T</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// HashMap ä½œä¸ºç¼“å­˜éçº¿ç¨‹å®‰å…¨, éœ€è¦ä¿æŠ¤</span></span><br><span class="line">    HashMap&lt;SqlPair, T&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    ReentrantReadWriteLock <span class="keyword">lock</span> = <span class="keyword">new</span> ReentrantReadWriteLock(); </span><br><span class="line">    GenericDao genericDao = <span class="keyword">new</span> GenericDao();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">update</span>(<span class="params">String sql, Object... <span class="keyword">params</span></span>)</span> &#123;</span><br><span class="line">        SqlPair key = <span class="keyword">new</span> SqlPair(sql, <span class="keyword">params</span>);</span><br><span class="line">        <span class="comment">// åŠ å†™é”, é˜²æ­¢å…¶å®ƒçº¿ç¨‹å¯¹ç¼“å­˜è¯»å–å’Œæ›´æ”¹</span></span><br><span class="line">        <span class="keyword">lock</span>.writeLock().<span class="keyword">lock</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">int</span> rows = genericDao.update(sql, <span class="keyword">params</span>);</span><br><span class="line">            map.clear();</span><br><span class="line">            <span class="keyword">return</span> rows;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">lock</span>.writeLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">queryOne</span>(<span class="params">Class&lt;T&gt; beanClass, String sql, Object... <span class="keyword">params</span></span>)</span> &#123;</span><br><span class="line">        SqlPair key = <span class="keyword">new</span> SqlPair(sql, <span class="keyword">params</span>);</span><br><span class="line">        <span class="comment">// åŠ è¯»é”, é˜²æ­¢å…¶å®ƒçº¿ç¨‹å¯¹ç¼“å­˜æ›´æ”¹</span></span><br><span class="line">        <span class="keyword">lock</span>.readLock().<span class="keyword">lock</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            T <span class="keyword">value</span> = map.<span class="keyword">get</span>(key);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">value</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">value</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">lock</span>.readLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åŠ å†™é”, é˜²æ­¢å…¶å®ƒçº¿ç¨‹å¯¹ç¼“å­˜è¯»å–å’Œæ›´æ”¹</span></span><br><span class="line">        <span class="keyword">lock</span>.writeLock().<span class="keyword">lock</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// get æ–¹æ³•ä¸Šé¢éƒ¨åˆ†æ˜¯å¯èƒ½å¤šä¸ªçº¿ç¨‹è¿›æ¥çš„, å¯èƒ½å·²ç»å‘ç¼“å­˜å¡«å……äº†æ•°æ®</span></span><br><span class="line">            <span class="comment">// ä¸ºé˜²æ­¢é‡å¤æŸ¥è¯¢æ•°æ®åº“, å†æ¬¡éªŒè¯</span></span><br><span class="line">            T <span class="keyword">value</span> = map.<span class="keyword">get</span>(key);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">value</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœæ²¡æœ‰, æŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">                <span class="keyword">value</span> = genericDao.queryOne(beanClass, sql, <span class="keyword">params</span>);</span><br><span class="line">                map.put(key, <span class="keyword">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">value</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">lock</span>.writeLock().unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä½œä¸º key ä¿è¯å…¶æ˜¯ä¸å¯å˜çš„</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title">SqlPair</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String sql;</span><br><span class="line">        <span class="keyword">private</span> Object[] <span class="keyword">params</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">SqlPair</span>(<span class="params">String sql, Object[] <span class="keyword">params</span></span>)</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.sql = sql;</span><br><span class="line">            <span class="keyword">this</span>.<span class="keyword">params</span> = <span class="keyword">params</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        @Override</span><br><span class="line">        <span class="function"><span class="keyword">public</span> boolean <span class="title">equals</span>(<span class="params">Object o</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span> == o) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (o == <span class="literal">null</span> || getClass() != o.getClass()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            SqlPair sqlPair = (SqlPair) o;</span><br><span class="line">            <span class="keyword">return</span> sql.<span class="keyword">equals</span>(sqlPair.sql) &amp;&amp;</span><br><span class="line">                Arrays.<span class="keyword">equals</span>(<span class="keyword">params</span>, sqlPair.<span class="keyword">params</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        @Override</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">hashCode</span>()</span> &#123;</span><br><span class="line">            <span class="built_in">int</span> result = Objects.hash(sql);</span><br><span class="line">            result = <span class="number">31</span> * result + Arrays.hashCode(<span class="keyword">params</span>);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¸å¿ƒä»£ç è§£è¯»</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1643.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1644.png" alt="img"></p>
<p>å­˜åœ¨çš„é—®é¢˜</p>
<table>
<thead>
<tr>
<th>é—®é¢˜ç‚¹</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>å†™é¢‘ç¹æ€§èƒ½ä½</td>
<td>å†™é”ç‹¬å ï¼Œé˜»å¡æ‰€æœ‰è¯»æ“ä½œ</td>
</tr>
<tr>
<td>ç²—æš´æ¸…ç¼“å­˜</td>
<td>æ¯æ¬¡å†™æ“ä½œéƒ½æ¸…ç©ºæ•´ä¸ª mapï¼Œæ•ˆç‡å·®</td>
</tr>
<tr>
<td>ç¼“å­˜æ— å®¹é‡æ§åˆ¶</td>
<td>å¯èƒ½ OOM</td>
</tr>
<tr>
<td>æ— è¿‡æœŸæœºåˆ¶</td>
<td>æ•°æ®ä¸€ç›´é©»ç•™å†…å­˜</td>
</tr>
<tr>
<td>å•æœºå¯ç”¨</td>
<td>ä¸é€‚åˆåˆ†å¸ƒå¼éƒ¨ç½²</td>
</tr>
<tr>
<td>å¹¶å‘ä¸é«˜</td>
<td>æ‰€æœ‰æ•°æ®å…±ç”¨ä¸€æŠŠé”ï¼Œå®¹æ˜“æˆä¸ºç“¶é¢ˆ</td>
</tr>
<tr>
<td>æ— ç¼“å­˜æ›´æ–°ç²’åº¦</td>
<td>å¯ä»¥è®¾è®¡æ›´ç»†çš„ key ç»´åº¦</td>
</tr>
</tbody>
</table>
<h4 id="ReentrantReadWriteLockåŸç†">ReentrantReadWriteLockåŸç†</h4>
<p>æ ¸å¿ƒåŸç†å›é¡¾</p>
<ul>
<li><code>ReentrantReadWriteLock</code> è¯»å†™é”ä½¿ç”¨åŒä¸€ä¸ª <code>Sync</code> åŒæ­¥å™¨ï¼ˆç»§æ‰¿è‡ª AQSï¼‰ã€‚</li>
<li><strong>çŠ¶æ€ state çš„é«˜ 16 ä½ç”¨äºè¯»é”è®¡æ•°ï¼Œä½ 16 ä½ç”¨äºå†™é”è®¡æ•°</strong>ã€‚</li>
<li>æ‰€æœ‰é”è¯·æ±‚ï¼ˆè¯»æˆ–å†™ï¼‰éƒ½æ’é˜Ÿè¿›å…¥ AQS çš„ç­‰å¾…é˜Ÿåˆ—ï¼ˆåŒå‘é“¾è¡¨ç»“æ„ï¼‰ã€‚</li>
</ul>
<h5 id="å›¾è§£æµç¨‹">å›¾è§£æµç¨‹</h5>
<p>è¯»å†™é”ç”¨çš„æ˜¯åŒä¸€ä¸ª Sycn åŒæ­¥å™¨ï¼Œå› æ­¤ç­‰å¾…é˜Ÿåˆ—ã€state ç­‰ä¹Ÿæ˜¯åŒä¸€ä¸ª</p>
<p>é˜¶æ®µ 1ï¼št1 è·å–å†™é”ï¼Œt2 å°è¯•è·å–è¯»é”å¤±è´¥ <strong>t1 w.lockï¼Œt2 r.lock</strong></p>
<p>1ï¼‰ t1 æˆåŠŸä¸Šé”ï¼Œæµç¨‹ä¸ ReentrantLock åŠ é”ç›¸æ¯”æ²¡æœ‰ç‰¹æ®Šä¹‹å¤„ï¼Œä¸åŒæ˜¯å†™é”çŠ¶æ€å äº† state çš„ä½ 16 ä½ï¼Œè€Œè¯»é”ä½¿ç”¨çš„æ˜¯ state çš„é«˜ 16 ä½</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1649.png" alt="img"></p>
<p>2ï¼‰t2 æ‰§è¡Œ r.lockï¼Œè¿™æ—¶è¿›å…¥è¯»é”çš„ sync.acquireShared(1) æµç¨‹ï¼Œé¦–å…ˆä¼šè¿›å…¥ tryAcquireShared æµç¨‹ã€‚å¦‚æœæœ‰å†™é”å æ®ï¼Œé‚£ä¹ˆ tryAcquireShared è¿”å› -1 è¡¨ç¤ºå¤±è´¥</p>
<blockquote>
<p>tryAcquireShared è¿”å›å€¼è¡¨ç¤º</p>
<ul>
<li>-1 è¡¨ç¤ºå¤±è´¥</li>
<li>0 è¡¨ç¤ºæˆåŠŸï¼Œä½†åç»§èŠ‚ç‚¹ä¸ä¼šç»§ç»­å”¤é†’</li>
<li>æ­£æ•°è¡¨ç¤ºæˆåŠŸï¼Œè€Œä¸”æ•°å€¼æ˜¯è¿˜æœ‰å‡ ä¸ªåç»§èŠ‚ç‚¹éœ€è¦å”¤é†’ï¼Œè¯»å†™é”è¿”å› 1</li>
</ul>
</blockquote>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1650.png" alt="img"></p>
<p>3ï¼‰è¿™æ—¶ä¼šè¿›å…¥ sync.doAcquireShared(1) æµç¨‹ï¼Œé¦–å…ˆä¹Ÿæ˜¯è°ƒç”¨ addWaiter æ·»åŠ èŠ‚ç‚¹ï¼Œä¸åŒä¹‹å¤„åœ¨äºèŠ‚ç‚¹è¢«è®¾ç½®ä¸º Node.SHARED æ¨¡å¼è€Œé Node.EXCLUSIVE æ¨¡å¼ï¼Œæ³¨æ„æ­¤æ—¶ t2 ä»å¤„äºæ´»è·ƒçŠ¶æ€</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1651-1024x500.png" alt="img"></p>
<p>4ï¼‰t2 ä¼šçœ‹çœ‹è‡ªå·±çš„èŠ‚ç‚¹æ˜¯ä¸æ˜¯è€äºŒï¼Œå¦‚æœæ˜¯ï¼Œè¿˜ä¼šå†æ¬¡è°ƒç”¨ tryAcquireShared(1) æ¥å°è¯•è·å–é”</p>
<p>5ï¼‰å¦‚æœæ²¡æœ‰æˆåŠŸï¼Œåœ¨ doAcquireShared å†… for (;;) å¾ªç¯ä¸€æ¬¡ï¼ŒæŠŠå‰é©±èŠ‚ç‚¹çš„ waitStatus æ”¹ä¸º -1ï¼Œå† for (;;) å¾ªç¯ä¸€ æ¬¡å°è¯• tryAcquireShared(1) å¦‚æœè¿˜ä¸æˆåŠŸï¼Œé‚£ä¹ˆåœ¨ parkAndCheckInterrupt() å¤„ park</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1652-1024x498.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1663.png" alt="img"></p>
<p>é˜¶æ®µ 2ï¼št3 å†æ¬¡å°è¯•è·å–è¯»é”ï¼Œt4 å°è¯•è·å–å†™é” <strong>t3 r.lockï¼Œt4 w.lock</strong></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1664.png" alt="img"></p>
<p>è¿™ç§çŠ¶æ€ä¸‹ï¼Œå‡è®¾åˆæœ‰ t3 åŠ è¯»é”å’Œ t4 åŠ å†™é”ï¼Œè¿™æœŸé—´ t1 ä»ç„¶æŒæœ‰é”ï¼Œå°±å˜æˆäº†ä¸‹é¢çš„æ ·å­</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1653-1024x341.png" alt="img"></p>
<p>é˜¶æ®µ 3ï¼št1 é‡Šæ”¾å†™é”ï¼Œå”¤é†’åç»§èŠ‚ç‚¹ï¼ˆt2ï¼‰ <strong>t1 w.unlock</strong></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1665.png" alt="img"></p>
<p>è¿™æ—¶ä¼šèµ°åˆ°å†™é”çš„ sync.release(1) æµç¨‹ï¼Œè°ƒç”¨ sync.tryRelease(1) æˆåŠŸï¼Œå˜æˆä¸‹é¢çš„æ ·å­</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1654-1024x328.png" alt="img"></p>
<p>æ¥ä¸‹æ¥æ‰§è¡Œå”¤é†’æµç¨‹ sync.unparkSuccessorï¼Œå³è®©è€äºŒæ¢å¤è¿è¡Œï¼Œè¿™æ—¶ t2 åœ¨ doAcquireShared å†… parkAndCheckInterrupt() å¤„æ¢å¤è¿è¡Œ</p>
<p>è¿™å›å†æ¥ä¸€æ¬¡ for (;;) æ‰§è¡Œ tryAcquireShared æˆåŠŸåˆ™è®©è¯»é”è®¡æ•°åŠ ä¸€</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1655-1024x324.png" alt="img"></p>
<p>é˜¶æ®µ 4ï¼št2 è°ƒç”¨ <code>setHeadAndPropagate()</code> ä¼ æ’­å”¤é†’</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1666.png" alt="img"></p>
<p>è¿™æ—¶ t2 å·²ç»æ¢å¤è¿è¡Œï¼Œæ¥ä¸‹æ¥ t2 è°ƒç”¨ setHeadAndPropagate(node, 1)ï¼Œå®ƒåŸæœ¬æ‰€åœ¨èŠ‚ç‚¹è¢«ç½®ä¸ºå¤´èŠ‚ç‚¹</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1656-1024x395.png" alt="img"></p>
<p>äº‹æƒ…è¿˜æ²¡å®Œï¼Œåœ¨ setHeadAndPropagate æ–¹æ³•å†…è¿˜ä¼šæ£€æŸ¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯ sharedï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨ doReleaseShared() å°† head çš„çŠ¶æ€ä» -1 æ”¹ä¸º 0 å¹¶å”¤é†’è€äºŒï¼Œè¿™æ—¶ t3 åœ¨ doAcquireShared å†… parkAndCheckInterrupt() å¤„æ¢å¤è¿è¡Œ</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1657-1024x396.png" alt="img"></p>
<p>è¿™å›å†æ¥ä¸€æ¬¡ for (;;) æ‰§è¡Œ tryAcquireShared æˆåŠŸåˆ™è®©è¯»é”è®¡æ•°åŠ ä¸€</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1658-1024x415.png" alt="img"></p>
<p>è¿™æ—¶ t3 å·²ç»æ¢å¤è¿è¡Œï¼Œæ¥ä¸‹æ¥ t3 è°ƒç”¨ setHeadAndPropagate(node, 1)ï¼Œå®ƒåŸæœ¬æ‰€åœ¨èŠ‚ç‚¹è¢«ç½®ä¸ºå¤´èŠ‚ç‚¹</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1659-1024x515.png" alt="img"></p>
<p><strong>ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸æ˜¯ shared</strong> äº†ï¼Œå› æ­¤ä¸ä¼šç»§ç»­å”¤é†’ t4 æ‰€åœ¨èŠ‚ç‚¹</p>
<p>é˜¶æ®µ 5ï¼št2 å’Œ t3 åˆ†åˆ«é‡Šæ”¾è¯»é” <strong>t2 r.unlockï¼Œt3 r.unlock</strong></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1667.png" alt="img"></p>
<p>t2 è¿›å…¥ sync.releaseShared(1) ä¸­ï¼Œè°ƒç”¨ tryReleaseShared(1) è®©è®¡æ•°å‡ä¸€ï¼Œä½†ç”±äºè®¡æ•°è¿˜ä¸ä¸ºé›¶</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1660-1024x520.png" alt="img"></p>
<p>t3 è¿›å…¥ sync.releaseShared(1) ä¸­ï¼Œè°ƒç”¨ tryReleaseShared(1) è®©è®¡æ•°å‡ä¸€ï¼Œè¿™å›è®¡æ•°ä¸ºé›¶äº†ï¼Œè¿›å…¥ doReleaseShared() å°†å¤´èŠ‚ç‚¹ä» -1 æ”¹ä¸º 0 å¹¶å”¤é†’è€äºŒï¼Œå³</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1661-1024x541.png" alt="img"></p>
<p>é˜¶æ®µ 6ï¼št4 æ˜¯å†™é”è¯·æ±‚ï¼Œè¢«å”¤é†’åè·å–é”æˆåŠŸ</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1668.png" alt="img"></p>
<p>ä¹‹å t4 åœ¨ acquireQueued ä¸­ parkAndCheckInterrupt å¤„æ¢å¤è¿è¡Œï¼Œå†æ¬¡ for (;;) è¿™æ¬¡è‡ªå·±æ˜¯è€äºŒï¼Œå¹¶ä¸”æ²¡æœ‰å…¶ä»– ç«äº‰ï¼ŒtryAcquire(1) æˆåŠŸï¼Œä¿®æ”¹å¤´ç»“ç‚¹ï¼Œæµç¨‹ç»“æŸ</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1662.png" alt="img"></p>
<p>å…³é”®è¯ç†è§£</p>
<table>
<thead>
<tr>
<th>æ¦‚å¿µ</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>state</code></td>
<td>é«˜ 16 ä½æ˜¯è¯»é”è®¡æ•°ï¼Œä½ 16 ä½æ˜¯å†™é”è®¡æ•°</td>
</tr>
<tr>
<td><code>tryAcquireShared()</code></td>
<td>è¯»é”å°è¯•è·å–é€»è¾‘ï¼Œ-1 è¡¨ç¤ºå¤±è´¥</td>
</tr>
<tr>
<td><code>doAcquireShared()</code></td>
<td>è¯»é”å¤±è´¥åå…¥é˜Ÿï¼Œå¹¶é˜»å¡ç­‰å¾…</td>
</tr>
<tr>
<td><code>unparkSuccessor()</code></td>
<td>å”¤é†’é˜Ÿåˆ—ä¸­ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</td>
</tr>
<tr>
<td><code>setHeadAndPropagate()</code></td>
<td>è®¾ç½®æ–° head å¹¶ä¼ æ’­å”¤é†’</td>
</tr>
<tr>
<td><code>Node.SHARED</code></td>
<td>AQS å…±äº«èŠ‚ç‚¹æ ‡è®°</td>
</tr>
</tbody>
</table>
<p>ã€é˜¶æ®µ 1ã€‘t1 è·å–å†™é”æˆåŠŸ<br>
â”œâ”€â”€ çŠ¶æ€ï¼šstate = 0x0001ï¼ˆä½ 16 ä½ä¸ºå†™é”è®¡æ•° = 1ï¼‰<br>
â”œâ”€â”€ é”æŒæœ‰è€…ï¼št1ï¼ˆç‹¬å å†™é”ï¼‰<br>
â””â”€â”€ t2 å°è¯•è·å–è¯»é”å¤±è´¥ â†’ è¿›å…¥ AQS é˜Ÿåˆ—ï¼ˆå…±äº«æ¨¡å¼ï¼‰</p>
<p>å½“å‰é˜Ÿåˆ—ï¼šHead â†’ t2[å…±äº«]</p>
<hr>
<p>ã€é˜¶æ®µ 2ã€‘t3 å’Œ t4 ç›¸ç»§åŠ å…¥é˜Ÿåˆ—<br>
â”œâ”€â”€ t3 è·å–è¯»é”å¤±è´¥ â†’ åŠ å…¥ AQS é˜Ÿåˆ—ï¼ˆå…±äº«æ¨¡å¼ï¼‰<br>
â”œâ”€â”€ t4 è·å–å†™é”å¤±è´¥ â†’ åŠ å…¥ AQS é˜Ÿåˆ—ï¼ˆç‹¬å æ¨¡å¼ï¼‰<br>
â””â”€â”€ æ‰€æœ‰å°è¯•éƒ½ä¼š CAS ä¿®æ”¹å‰é©±èŠ‚ç‚¹çš„ waitStatus = SIGNAL å¹¶é˜»å¡</p>
<p>å½“å‰é˜Ÿåˆ—ï¼šHead â†’ t2[å…±äº«] â†’ t3[å…±äº«] â†’ t4[ç‹¬å ]</p>
<hr>
<p>ã€é˜¶æ®µ 3ã€‘t1 é‡Šæ”¾å†™é”ï¼ˆunlockï¼‰<br>
â”œâ”€â”€ tryRelease æˆåŠŸ â†’ state = 0x0000ï¼ˆå†™é”è®¡æ•°å½’ 0ï¼‰<br>
â”œâ”€â”€ è¿›å…¥ unparkSuccessor â†’ å”¤é†’ t2ï¼ˆç¬¬ä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹ï¼‰<br>
â””â”€â”€ t2 é†’æ¥åè°ƒç”¨ tryAcquireShared æˆåŠŸ â†’ è·å–è¯»é”</p>
<p>æ›´æ–°çŠ¶æ€ï¼š</p>
<ul>
<li>state = 0x00010000ï¼ˆé«˜ 16 ä½è¯»é”è®¡æ•° = 1ï¼‰</li>
<li>é”æŒæœ‰è€…ï¼št2ï¼ˆå…±äº«è¯»é”ï¼‰</li>
</ul>
<p>å½“å‰é˜Ÿåˆ—ï¼šHead â†’ t3[å…±äº«] â†’ t4[ç‹¬å ]</p>
<hr>
<p>ã€é˜¶æ®µ 4ã€‘t2 æ‰§è¡Œ setHeadAndPropagate<br>
â”œâ”€â”€ æŠŠè‡ªå·±è®¾ä¸ºæ–°çš„ head èŠ‚ç‚¹<br>
â”œâ”€â”€ åˆ¤æ–­ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ t3 æ˜¯å…±äº«æ¨¡å¼<br>
â””â”€â”€ ç›´æ¥å”¤é†’ t3ï¼ˆå…±äº«ä¼ æ’­ï¼‰</p>
<p>t3 é†’æ¥åï¼š</p>
<ul>
<li>å†æ¬¡å°è¯•è·å–è¯»é”ï¼ŒæˆåŠŸ</li>
<li>state = 0x00020000ï¼ˆè¯»é”è®¡æ•° +1ï¼‰</li>
<li>é”æŒæœ‰è€…ï¼št2ã€t3ï¼ˆå…±äº«ï¼‰</li>
</ul>
<p>å½“å‰é˜Ÿåˆ—ï¼šHead â†’ t4[ç‹¬å ]</p>
<hr>
<p>ã€é˜¶æ®µ 5ã€‘t2ã€t3 åˆ†åˆ«é‡Šæ”¾è¯»é”<br>
â”œâ”€â”€ t2 è°ƒç”¨ unlock â†’ state = 0x00010000ï¼ˆä»æœ‰ 1 ä¸ªè¯»é”ï¼‰<br>
â”‚ â””â”€â”€ ä¸ä¼ æ’­å”¤é†’<br>
â”œâ”€â”€ t3 è°ƒç”¨ unlock â†’ state = 0x00000000ï¼ˆå…¨éƒ¨è¯»é”é‡Šæ”¾ï¼‰<br>
â””â”€â”€ doReleaseShared() â†’ å”¤é†’åç»§èŠ‚ç‚¹ t4</p>
<p>å½“å‰é˜Ÿåˆ—ï¼šHead â†’ t4[ç‹¬å ]</p>
<hr>
<p>ã€é˜¶æ®µ 6ã€‘t4 è¢«å”¤é†’åè·å–å†™é”<br>
â”œâ”€â”€ t4 é†’æ¥åè°ƒç”¨ tryAcquireï¼ˆç‹¬å ï¼‰æˆåŠŸ<br>
â”œâ”€â”€ æ›´æ–° state = 0x0001ï¼ˆå†™é”è®¡æ•° = 1ï¼‰<br>
â””â”€â”€ é”æŒæœ‰è€…ï¼št4ï¼ˆç‹¬å å†™é”ï¼‰</p>
<p>AQS é˜Ÿåˆ—ä¸ºç©ºï¼Œæµç¨‹ç»“æŸ</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1670.png" alt="img"></p>
<h5 id="æºç åˆ†æ">æºç åˆ†æ</h5>
<p><strong>å†™é”ä¸Šé”æµç¨‹</strong>ï¼ˆéå…¬å¹³ï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonfairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤–éƒ¨ç±» WriteLock æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            <span class="comment">// å°è¯•è·å¾—å†™é”å¤±è´¥</span></span><br><span class="line">            !tryAcquire(arg) &amp;&amp;</span><br><span class="line">            <span class="comment">// å°†å½“å‰çº¿ç¨‹å…³è”åˆ°ä¸€ä¸ª Node å¯¹è±¡ä¸Š, æ¨¡å¼ä¸ºç‹¬å æ¨¡å¼</span></span><br><span class="line">            <span class="comment">// è¿›å…¥ AQS é˜Ÿåˆ—é˜»å¡</span></span><br><span class="line">            acquireQueued(addWaiter(Node.EXCLUSIVE), arg)</span><br><span class="line">        ) &#123;</span><br><span class="line">            selfInterrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="comment">// è·å¾—ä½ 16 ä½, ä»£è¡¨å†™é”çš„ state è®¡æ•°</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">w</span> <span class="operator">=</span> exclusiveCount(c);</span><br><span class="line">        <span class="comment">//è¡¨ç¤ºæœ‰å†™é”æˆ–è€…æœ‰è¯»é”</span></span><br><span class="line">        <span class="keyword">if</span> (c != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">                <span class="comment">// c != 0 and w == 0 è¡¨ç¤ºæœ‰è¯»é”, æˆ–è€…</span></span><br><span class="line">                w == <span class="number">0</span> ||</span><br><span class="line">                <span class="comment">// å¦‚æœ exclusiveOwnerThread ä¸æ˜¯è‡ªå·±</span></span><br><span class="line">                current != getExclusiveOwnerThread()</span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="comment">// è·å¾—é”å¤±è´¥</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å†™é”è®¡æ•°è¶…è¿‡ä½ 16 ä½, æŠ¥å¼‚å¸¸</span></span><br><span class="line">            <span class="keyword">if</span> (w + exclusiveCount(acquires) &gt; MAX_COUNT)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">            <span class="comment">// å†™é”é‡å…¥, è·å¾—é”æˆåŠŸ</span></span><br><span class="line">            setState(c + acquires);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            <span class="comment">// åˆ¤æ–­å†™é”æ˜¯å¦è¯¥é˜»å¡, æˆ–è€…</span></span><br><span class="line">            <span class="comment">//éå…¬å¹³é”ä¸‹ï¼Œæ€»æ˜¯è¿”å›false</span></span><br><span class="line">            writerShouldBlock() ||</span><br><span class="line">            <span class="comment">// å°è¯•æ›´æ”¹è®¡æ•°å¤±è´¥</span></span><br><span class="line">            !compareAndSetState(c, c + acquires)</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="comment">// è·å¾—é”å¤±è´¥</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è·å¾—é”æˆåŠŸ</span></span><br><span class="line">        setExclusiveOwnerThread(current);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éå…¬å¹³é” writerShouldBlock æ€»æ˜¯è¿”å› false, æ— éœ€é˜»å¡</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">writerShouldBlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ€»ç»“ï¼š</p>
<ul>
<li>
<pre><code>lock
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">-&gt; </span><br><span class="line"></span><br></pre></td></tr></table></figure>
syn.acquire
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">-&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
tryAquire
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">  -</span> å¦‚æœæœ‰é”ï¼š</span><br><span class="line"><span class="bullet">    -</span> å¦‚æœæ˜¯å†™é”æˆ–è€…é”æŒæœ‰è€…ä¸ä¸ºè‡ªå·±ï¼Œè¿”å›false</span><br><span class="line"><span class="bullet">    -</span> å¦‚æœæ—¶å†™é”ä¸”ä¸ºè‡ªå·±æŒæœ‰ï¼Œåˆ™é‡å…¥</span><br><span class="line"><span class="bullet">  -</span> å¦‚æœæ— é”ï¼š</span><br><span class="line"><span class="bullet">    -</span> åˆ¤æ–­æ— åºé˜»å¡å¹¶è®¾ç½®stateæˆåŠŸåï¼Œå°†ownerè®¾ä¸ºè‡ªå·±ï¼Œè¿”å›true</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> æˆåŠŸï¼Œåˆ™è·å¾—äº†é”</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> å¤±è´¥ï¼š</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> è°ƒç”¨<span class="code">`acquireQueued(addWaiter(Node.EXCLUSIVE), arg)`</span>è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå°†èŠ‚ç‚¹çŠ¶æ€è®¾ç½®ä¸ºEXCLUSIVEï¼Œä¹‹åçš„é€»è¾‘ä¸ä¹‹å‰çš„aquireQueuedç±»ä¼¼ã€‚</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1671.png</span>)</span><br><span class="line"></span><br><span class="line"><span class="strong">**å†™é”é‡Šæ”¾æµç¨‹**</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<p>static final class NonfairSync extends Sync {<br>
// â€¦ çœç•¥æ— å…³ä»£ç </p>
<pre><code>// WriteLock æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„
public void unlock() &#123;
    sync.release(1);
&#125;

// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„
public final boolean release(int arg) &#123;
    // å°è¯•é‡Šæ”¾å†™é”æˆåŠŸ
    if (tryRelease(arg)) &#123;
        // unpark AQS ä¸­ç­‰å¾…çš„çº¿ç¨‹
        Node h = head;
        if (h != null &amp;&amp; h.waitStatus != 0)
            unparkSuccessor(h);
        return true;
    &#125;
    return false;
&#125;

// Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„
protected final boolean tryRelease(int releases) &#123;
    if (!isHeldExclusively())
        throw new IllegalMonitorStateException();
    int nextc = getState() - releases;
    // å› ä¸ºå¯é‡å…¥çš„åŸå› , å†™é”è®¡æ•°ä¸º 0, æ‰ç®—é‡Šæ”¾æˆåŠŸ
    boolean free = exclusiveCount(nextc) == 0;
    if (free) &#123;
        setExclusiveOwnerThread(null);
    &#125;
    setState(nextc);
    return free;
&#125;
</code></pre>
<p>}</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">æ€»ç»“ï¼š</span><br><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  unlock</span><br></pre></td></tr></table></figure>
<p>-&gt;</p>
  <figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">syn.release</span><br></pre></td></tr></table></figure>
<p>-&gt;</p>
  <figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">tryRelease</span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>stateçŠ¶æ€å‡å°‘</p>
<ul>
<li>å¦‚æœå‡ä¸ºé›¶ï¼Œè¡¨ç¤ºè§£é”æˆåŠŸï¼Œè¿”å›true</li>
<li>æ²¡æœ‰å‡ä¸º0ï¼Œå½“å‰çº¿ç¨‹ä¾æ—§æŒæœ‰é”</li>
</ul>
</li>
<li>
<p>æˆåŠŸï¼šè§£é”æˆåŠŸ</p>
<ul>
<li>å¦‚æœASQé˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œåˆ™å”¤é†’ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ã€‚</li>
</ul>
</li>
<li>
<p>å¤±è´¥ï¼šè§£é”å¤±è´¥ã€‚</p>
</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1672.png" alt="img"></p>
<p><strong>è¯»é”ä¸Šé”æµç¨‹</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonfairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ReadLock æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.acquireShared(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="comment">// tryAcquireShared è¿”å›è´Ÿæ•°, è¡¨ç¤ºè·å–è¯»é”å¤±è´¥</span></span><br><span class="line">        <span class="comment">//å¤§äº0çš„æƒ…å†µåœ¨è¯»å†™é”è¿™é‡Œæ— åŒºåˆ«ï¼Œåé¢ä¿¡å·é‡ä¼šåšè¿›ä¸€æ­¥å¤„ç†ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            doAcquireShared(arg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">tryAcquireShared</span><span class="params">(<span class="type">int</span> unused)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯å…¶å®ƒçº¿ç¨‹æŒæœ‰å†™é”, è·å–è¯»é”å¤±è´¥</span></span><br><span class="line">        <span class="keyword">if</span> ( </span><br><span class="line">            exclusiveCount(c) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">            getExclusiveOwnerThread() != current</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> sharedCount(c);</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            <span class="comment">// è¯»é”ä¸è¯¥é˜»å¡(å¦‚æœè€äºŒæ˜¯å†™é”ï¼Œè¯»é”è¯¥é˜»å¡), å¹¶ä¸”</span></span><br><span class="line">            !readerShouldBlock() &amp;&amp;</span><br><span class="line">            <span class="comment">// å°äºè¯»é”è®¡æ•°, å¹¶ä¸”</span></span><br><span class="line">            r &lt; MAX_COUNT &amp;&amp;</span><br><span class="line">            <span class="comment">// å°è¯•å¢åŠ è®¡æ•°æˆåŠŸ</span></span><br><span class="line">            compareAndSetState(c, c + SHARED_UNIT)</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="comment">// ... çœç•¥ä¸é‡è¦çš„ä»£ç </span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fullTryAcquireShared(current);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éå…¬å¹³é” readerShouldBlock çœ‹ AQS é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯å†™é”</span></span><br><span class="line">    <span class="comment">// true åˆ™è¯¥é˜»å¡, false åˆ™ä¸é˜»å¡</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">readerShouldBlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> apparentlyFirstQueuedIsExclusive();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="comment">// ä¸ tryAcquireShared åŠŸèƒ½ç±»ä¼¼, ä½†ä¼šä¸æ–­å°è¯• for (;;) è·å–è¯»é”, æ‰§è¡Œè¿‡ç¨‹ä¸­æ— é˜»å¡</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">fullTryAcquireShared</span><span class="params">(Thread current)</span> &#123;</span><br><span class="line">        <span class="type">HoldCounter</span> <span class="variable">rh</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">            <span class="keyword">if</span> (exclusiveCount(c) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (getExclusiveOwnerThread() != current)</span><br><span class="line">                    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (readerShouldBlock()) &#123;</span><br><span class="line">                <span class="comment">// ... çœç•¥ä¸é‡è¦çš„ä»£ç </span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (sharedCount(c) == MAX_COUNT)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(c, c + SHARED_UNIT)) &#123;</span><br><span class="line">                <span class="comment">// ... çœç•¥ä¸é‡è¦çš„ä»£ç </span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doAcquireShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">        <span class="comment">// å°†å½“å‰çº¿ç¨‹å…³è”åˆ°ä¸€ä¸ª Node å¯¹è±¡ä¸Š, æ¨¡å¼ä¸ºå…±äº«æ¨¡å¼</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addWaiter(Node.SHARED);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">                <span class="keyword">if</span> (p == head) &#123;</span><br><span class="line">                    <span class="comment">// å†ä¸€æ¬¡å°è¯•è·å–è¯»é”</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> tryAcquireShared(arg);</span><br><span class="line">                    <span class="comment">// æˆåŠŸ</span></span><br><span class="line">                    <span class="keyword">if</span> (r &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// ãˆ </span></span><br><span class="line">                        <span class="comment">// r è¡¨ç¤ºå¯ç”¨èµ„æºæ•°, åœ¨è¿™é‡Œæ€»æ˜¯ 1 å…è®¸ä¼ æ’­</span></span><br><span class="line">                        <span class="comment">//ï¼ˆå”¤é†’ AQS ä¸­ä¸‹ä¸€ä¸ª Share èŠ‚ç‚¹ï¼‰</span></span><br><span class="line">                        setHeadAndPropagate(node, r);</span><br><span class="line">                        p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                        <span class="keyword">if</span> (interrupted)</span><br><span class="line">                            selfInterrupt();</span><br><span class="line">                        failed = <span class="literal">false</span>;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (</span><br><span class="line">                    <span class="comment">// æ˜¯å¦åœ¨è·å–è¯»é”å¤±è´¥æ—¶é˜»å¡ï¼ˆå‰ä¸€ä¸ªé˜¶æ®µ waitStatus == Node.SIGNALï¼‰</span></span><br><span class="line">                    shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                    <span class="comment">// park å½“å‰çº¿ç¨‹</span></span><br><span class="line">                    parkAndCheckInterrupt()</span><br><span class="line">                ) &#123;</span><br><span class="line">                    interrupted = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (failed)</span><br><span class="line">                cancelAcquire(node);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ  AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setHeadAndPropagate</span><span class="params">(Node node, <span class="type">int</span> propagate)</span> &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head; <span class="comment">// Record old head for check below</span></span><br><span class="line">        <span class="comment">// è®¾ç½®è‡ªå·±ä¸º head</span></span><br><span class="line">        setHead(node);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// propagate è¡¨ç¤ºæœ‰å…±äº«èµ„æºï¼ˆä¾‹å¦‚å…±äº«è¯»é”æˆ–ä¿¡å·é‡ï¼‰</span></span><br><span class="line">        <span class="comment">// åŸ head waitStatus == Node.SIGNAL æˆ– Node.PROPAGATE</span></span><br><span class="line">        <span class="comment">// ç°åœ¨ head waitStatus == Node.SIGNAL æˆ– Node.PROPAGATE</span></span><br><span class="line">        <span class="keyword">if</span> (propagate &gt; <span class="number">0</span> || h == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span> ||</span><br><span class="line">            (h = head) == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">            <span class="comment">// å¦‚æœæ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…æ˜¯ç­‰å¾…å…±äº«è¯»é”çš„èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (s == <span class="literal">null</span> || s.isShared()) &#123;</span><br><span class="line">                <span class="comment">// è¿›å…¥ ãˆ¡</span></span><br><span class="line">                doReleaseShared();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ãˆ¡ AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doReleaseShared</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœ head.waitStatus == Node.SIGNAL ==&gt; 0 æˆåŠŸ, ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unpark</span></span><br><span class="line">        <span class="comment">// å¦‚æœ head.waitStatus == 0 ==&gt; Node.PROPAGATE, ä¸ºäº†è§£å†³ bug, è§åé¢åˆ†æ</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">            <span class="comment">// é˜Ÿåˆ—è¿˜æœ‰èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h != tail) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> h.waitStatus;</span><br><span class="line">                <span class="keyword">if</span> (ws == Node.SIGNAL) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!compareAndSetWaitStatus(h, Node.SIGNAL, <span class="number">0</span>))</span><br><span class="line">                        <span class="keyword">continue</span>; <span class="comment">// loop to recheck cases</span></span><br><span class="line">                    <span class="comment">// ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unpark å¦‚æœæˆåŠŸè·å–è¯»é”</span></span><br><span class="line">                    <span class="comment">// å¹¶ä¸”ä¸‹ä¸‹ä¸ªèŠ‚ç‚¹è¿˜æ˜¯ shared, ç»§ç»­ doReleaseShared</span></span><br><span class="line">                    unparkSuccessor(h);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ws == <span class="number">0</span> &amp;&amp;</span><br><span class="line">                         !compareAndSetWaitStatus(h, <span class="number">0</span>, Node.PROPAGATE))</span><br><span class="line">                    <span class="keyword">continue</span>; <span class="comment">// loop on failed CAS</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (h == head) <span class="comment">// loop if head changed</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ€»ç»“ï¼š</p>
<ul>
<li>
<pre><code>lock
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">-&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
syn.acquireShare
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">-&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
tryAcquireShare
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">  -</span> å¦‚æœå…¶ä»–çº¿ç¨‹æŒæœ‰å†™é”ï¼šåˆ™å¤±è´¥ï¼Œè¿”å›-1</span><br><span class="line"><span class="bullet">  -</span> å¦åˆ™ï¼šåˆ¤æ–­æ— éœ€ç­‰å¾…åï¼Œå°†stateåŠ ä¸Šä¸€ä¸ªå†™é”çš„å•ä½ï¼Œè¿”å›1</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> è¿”å›å€¼å¤§äºç­‰äº0ï¼šæˆåŠŸ</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> è¿”å›å€¼å°äº0ï¼š</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> è°ƒç”¨doAcquireShareï¼Œç±»ä¼¼ä¹‹å‰çš„aquireQueued,å°†å½“å‰çº¿ç¨‹å…³è”èŠ‚ç‚¹ï¼ŒçŠ¶æ€è®¾ç½®ä¸ºSHAREï¼Œæ’å…¥AQSé˜Ÿåˆ—å°¾éƒ¨ã€‚åœ¨forå¾ªç¯ä¸­åˆ¤æ–­å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æ˜¯å¦ä¸ºå¤´èŠ‚ç‚¹</span><br><span class="line"></span><br><span class="line"><span class="bullet">    -</span> æ˜¯ï¼šè°ƒç”¨</span><br><span class="line"></span><br></pre></td></tr></table></figure>
    tryAcquireShare
    <figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">      -</span> å¦‚æœè¿”å›å€¼å¤§äºç­‰äº0ï¼Œåˆ™è·å–é”æˆåŠŸï¼Œå¹¶è°ƒç”¨<span class="code">`setHeadAndPropagate`</span>ï¼Œå‡ºé˜Ÿï¼Œå¹¶ä¸æ–­å”¤é†’AQSé˜Ÿåˆ—ä¸­çš„çŠ¶æ€ä¸ºSHAREçš„èŠ‚ç‚¹ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºEXCLUSIVEã€‚è®°å½•æ‰“æ–­æ ‡è®°ï¼Œä¹‹åé€€å‡ºæ–¹æ³•ï¼ˆä¸è¿”å›æ‰“æ–­æ ‡è®°ï¼‰</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> åˆ¤æ–­æ˜¯å¦åœ¨å¤±è´¥åé˜»å¡</span><br><span class="line"></span><br><span class="line"><span class="bullet">    -</span> æ˜¯ï¼šé˜»å¡ä½ï¼Œå¹¶ç›‘æµ‹æ‰“æ–­ä¿¡å·ã€‚</span><br><span class="line"><span class="bullet">    -</span> å¦åˆ™ï¼šå°†å‰é©±èŠ‚ç‚¹çŠ¶æ€è®¾ä¸º-1ã€‚ï¼ˆä¸‹ä¸€æ¬¡å¾ªç¯å°±åˆè¦é˜»å¡äº†ï¼‰</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1673.png</span>)</span><br><span class="line"></span><br><span class="line"><span class="strong">**è¯»é”é‡Šæ”¾æµç¨‹**</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<p>static final class NonfairSync extends Sync {</p>
<pre><code>// ReadLock æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„
public void unlock() &#123;
    sync.releaseShared(1);
&#125;

// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„
public final boolean releaseShared(int arg) &#123;
    if (tryReleaseShared(arg)) &#123;
        doReleaseShared();
        return true;
    &#125;
    return false;
&#125;

// Sync ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„
protected final boolean tryReleaseShared(int unused) &#123;
    // ... çœç•¥ä¸é‡è¦çš„ä»£ç 
    for (;;) &#123;
        int c = getState();
        int nextc = c - SHARED_UNIT;
        if (compareAndSetState(c, nextc)) &#123;
            // è¯»é”çš„è®¡æ•°ä¸ä¼šå½±å“å…¶å®ƒè·å–è¯»é”çº¿ç¨‹, ä½†ä¼šå½±å“å…¶å®ƒè·å–å†™é”çº¿ç¨‹
            // è®¡æ•°ä¸º 0 æ‰æ˜¯çœŸæ­£é‡Šæ”¾
            return nextc == 0;
        &#125;
    &#125;
&#125;

// AQS ç»§æ‰¿è¿‡æ¥çš„æ–¹æ³•, æ–¹ä¾¿é˜…è¯», æ”¾åœ¨æ­¤å¤„
private void doReleaseShared() &#123;
    // å¦‚æœ head.waitStatus == Node.SIGNAL ==&gt; 0 æˆåŠŸ, ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unpark
    // å¦‚æœ head.waitStatus == 0 ==&gt; Node.PROPAGATE 
    for (;;) &#123;
        Node h = head;
        if (h != null &amp;&amp; h != tail) &#123;
            int ws = h.waitStatus;
            // å¦‚æœæœ‰å…¶å®ƒçº¿ç¨‹ä¹Ÿåœ¨é‡Šæ”¾è¯»é”ï¼Œé‚£ä¹ˆéœ€è¦å°† waitStatus å…ˆæ”¹ä¸º 0
            // é˜²æ­¢ unparkSuccessor è¢«å¤šæ¬¡æ‰§è¡Œ
            if (ws == Node.SIGNAL) &#123;
                if (!compareAndSetWaitStatus(h, Node.SIGNAL, 0))
                    continue; // loop to recheck cases
                unparkSuccessor(h);
            &#125;
            // å¦‚æœå·²ç»æ˜¯ 0 äº†ï¼Œæ”¹ä¸º -3ï¼Œç”¨æ¥è§£å†³ä¼ æ’­æ€§ï¼Œè§åæ–‡ä¿¡å·é‡ bug åˆ†æ
            else if (ws == 0 &amp;&amp;
                     !compareAndSetWaitStatus(h, 0, Node.PROPAGATE))
                continue; // loop on failed CAS
        &#125;
        if (h == head) // loop if head changed
            break;
    &#125;
&#125; 
</code></pre>
<p>}</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">æ€»ç»“ï¼š</span><br><span class="line"></span><br><span class="line">- `unlock`-&gt;`releaseShared`-&gt;`tryReleaseShared`,å°†<span class="keyword">state</span>å‡å»ä¸€ä¸ªshareå•å…ƒï¼Œæœ€å<span class="keyword">state</span>ä¸º<span class="number">0</span>åˆ™è¿”å›trueï¼Œä¸ç„¶è¿”å›falseã€‚</span><br><span class="line">- è¿”å›tueï¼šè°ƒç”¨`doReleaseShare`,å”¤é†’é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹ã€‚</span><br><span class="line">- è¿”å›falseï¼šè§£é”ä¸å®Œå…¨ã€‚</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/<span class="number">2025</span>/<span class="number">07</span>/image-<span class="number">1674</span>.png)</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/<span class="number">2025</span>/<span class="number">07</span>/image-<span class="number">1675</span>.png)</span><br><span class="line"></span><br><span class="line">- [ å†™é”åŠ é”æµç¨‹ ]</span><br><span class="line">  WriteLock.lock()</span><br><span class="line">  â”‚</span><br><span class="line">  â”œâ”€â”€&gt; AQS.acquire(<span class="number">1</span>)</span><br><span class="line">  â”‚ â”‚</span><br><span class="line">  â”‚ â””â”€â”€&gt; tryAcquire(<span class="number">1</span>)</span><br><span class="line">  â”‚ â”œâ”€â”€ è‹¥ <span class="keyword">state</span> != <span class="number">0</span>ï¼š</span><br><span class="line">  â”‚ â”‚ â”œâ”€â”€ å½“å‰çº¿ç¨‹ä¸º ownerThread â†’ æ”¯æŒé‡å…¥ï¼ŒåŠ  <span class="keyword">state</span>ï¼ŒæˆåŠŸ</span><br><span class="line">  â”‚ â”‚ â””â”€â”€ å¦åˆ™ â†’ åŠ é”å¤±è´¥ï¼Œè¿›å…¥ AQS é˜Ÿåˆ—ç­‰å¾…</span><br><span class="line">  â”‚ â””â”€â”€ è‹¥ <span class="keyword">state</span> == <span class="number">0</span>ï¼š</span><br><span class="line">  â”‚ â”œâ”€â”€ CAS ä¿®æ”¹ <span class="keyword">state</span> æˆåŠŸ â†’ è·å¾—å†™é”ï¼Œè®¾ç½® ownerThread</span><br><span class="line">  â”‚ â””â”€â”€ å¤±è´¥ â†’ å…¥é˜Ÿç­‰å¾…</span><br><span class="line">  â”‚</span><br><span class="line">  â””â”€â”€ è·å–å†™é”æˆåŠŸ</span><br><span class="line">- [ å†™é”é‡Šæ”¾æµç¨‹ ]</span><br><span class="line">  WriteLock.unlock()</span><br><span class="line">  â”‚</span><br><span class="line">  â”œâ”€â”€&gt; AQS.release(<span class="number">1</span>)</span><br><span class="line">  â”‚ â”‚</span><br><span class="line">  â”‚ â””â”€â”€&gt; tryRelease(<span class="number">1</span>)</span><br><span class="line">  â”‚ â”œâ”€â”€ <span class="keyword">state</span> å‡ <span class="number">1</span>ï¼ˆå¯é‡å…¥é‡Šæ”¾ï¼‰</span><br><span class="line">  â”‚ â””â”€â”€ è‹¥ <span class="keyword">state</span> == <span class="number">0</span>ï¼š</span><br><span class="line">  â”‚ â”œâ”€â”€ æ¸…ç©º ownerThread</span><br><span class="line">  â”‚ â””â”€â”€ unparkSuccessor() å”¤é†’åç»§çº¿ç¨‹</span><br><span class="line">  â”‚</span><br><span class="line">  â””â”€â”€ å†™é”é‡Šæ”¾å®Œæˆï¼Œå”¤é†’ä¸‹ä¸€ä¸ªï¼ˆè¯»æˆ–å†™ï¼‰</span><br><span class="line">- [ è¯»é”åŠ é”æµç¨‹ ]</span><br><span class="line">  ReadLock.lock()</span><br><span class="line">  â”‚</span><br><span class="line">  â”œâ”€â”€&gt; AQS.acquireShared(<span class="number">1</span>)</span><br><span class="line">  â”‚ â”‚</span><br><span class="line">  â”‚ â””â”€â”€&gt; tryAcquireShared(<span class="number">1</span>)</span><br><span class="line">  â”‚ â”œâ”€â”€ è‹¥å­˜åœ¨å…¶å®ƒçº¿ç¨‹æŒæœ‰å†™é” â†’ è¿”å› -<span class="number">1</span>ï¼Œå¤±è´¥ï¼Œå…¥é˜Ÿç­‰å¾…</span><br><span class="line">  â”‚ â””â”€â”€ å¦åˆ™ï¼š</span><br><span class="line">  â”‚ â”œâ”€â”€ CAS å¢åŠ é«˜ <span class="number">16</span> ä½è¯»é”è®¡æ•°</span><br><span class="line">  â”‚ â””â”€â”€ è¿”å› <span class="number">1</span>ï¼Œè·å–æˆåŠŸ</span><br><span class="line">  â”‚</span><br><span class="line">  â”œâ”€â”€ è·å–è¯»é”æˆåŠŸ</span><br><span class="line">  â””â”€â”€ è°ƒç”¨ <span class="built_in">set</span>HeadAndPropagate()</span><br><span class="line">  â””â”€â”€ è‹¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å…±äº«æ¨¡å¼ â†’ ä¼ æ’­å”¤é†’ï¼ˆè¯»é”å…±äº«ï¼‰</span><br><span class="line">- [ è¯»é”é‡Šæ”¾æµç¨‹ ]</span><br><span class="line">  ReadLock.unlock()</span><br><span class="line">  â”‚</span><br><span class="line">  â”œâ”€â”€&gt; AQS.releaseShared(<span class="number">1</span>)</span><br><span class="line">  â”‚ â”‚</span><br><span class="line">  â”‚ â””â”€â”€&gt; tryReleaseShared(<span class="number">1</span>)</span><br><span class="line">  â”‚ â”œâ”€â”€ CAS å‡å°‘è¯»é”è®¡æ•°ï¼ˆé«˜ <span class="number">16</span> ä½ï¼‰</span><br><span class="line">  â”‚ â””â”€â”€ è‹¥ <span class="keyword">state</span> == <span class="number">0</span>ï¼ˆå…¨éƒ¨é‡Šæ”¾ï¼‰ï¼š</span><br><span class="line">  â”‚ â””â”€â”€ è°ƒç”¨ doReleaseShared()</span><br><span class="line">  â”‚ â””â”€â”€ å”¤é†’ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆå…±äº«æˆ–ç‹¬å ï¼‰</span><br><span class="line">  â”‚</span><br><span class="line">  â””â”€â”€ è¯»é”é‡Šæ”¾å®Œæˆï¼Œè‹¥ä¸ºæœ€åä¸€ä¸ªè¯»çº¿ç¨‹åˆ™å”¤é†’åç»§çº¿ç¨‹</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/<span class="number">2025</span>/<span class="number">07</span>/image-<span class="number">1676</span>.png)</span><br><span class="line"></span><br><span class="line"><span class="comment">### 4.è¯»å†™é”ä¹‹StampedLock</span></span><br><span class="line"></span><br><span class="line">`StampedLock`å®ƒæ˜¯ JDK <span class="number">8</span> ä¸­å¼•å…¥çš„ä¸€ç§**é«˜æ€§èƒ½è¯»å†™é”æœºåˆ¶**ï¼Œæ”¯æŒä¹è§‚è¯»ï¼Œå¹¶é€šè¿‡â€œæˆ³ï¼ˆstampï¼‰â€æœºåˆ¶å®ç°é”çŠ¶æ€çš„æ ¡éªŒå’Œæ§åˆ¶ã€‚</span><br><span class="line"></span><br><span class="line"><span class="comment">#### ä»€ä¹ˆæ˜¯ `StampedLock`</span></span><br><span class="line"></span><br><span class="line">`StampedLock` æ˜¯ `java.util.concurrent.locks` åŒ…ä¸‹çš„ç±»ï¼Œæä¾›äº†ï¼š</span><br><span class="line"></span><br><span class="line">- ç‹¬å å†™é” `writeLock()`</span><br><span class="line">- å…±äº«è¯»é” `readLock()`</span><br><span class="line">- **ä¹è§‚è¯»** `tryOptimisticRead()`</span><br><span class="line"></span><br><span class="line">åŒºåˆ«äº `ReentrantReadWriteLock` çš„æ˜¯ï¼Œå®ƒä½¿ç”¨ä¸€ä¸ª `long` ç±»å‹çš„æˆ³ï¼ˆstampï¼‰æ¥ä»£è¡¨é”çŠ¶æ€ï¼Œè€Œä¸æ˜¯ç›´æ¥ä¾èµ– `Lock` æ¥å£ã€‚</span><br><span class="line"></span><br><span class="line"><span class="comment">#### æ ¸å¿ƒæ€æƒ³ï¼šâ€œæˆ³ + æ ¡éªŒâ€</span></span><br><span class="line"></span><br><span class="line">ä¹è§‚è¯»</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>long stamp = lock.tryOptimisticRead();<br>
// è¯»å–æ•°æ®â€¦<br>
if (!lock.validate(stamp)) {<br>
// æˆ³æ ¡éªŒå¤±è´¥ï¼Œéœ€è¦å‡çº§ä¸ºè¯»é”<br>
}</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">- </span>ä¹è§‚è¯»ä¸ä¼šé˜»å¡å†™çº¿ç¨‹ï¼Œæ€§èƒ½é«˜</span><br><span class="line"><span class="bullet">- </span>ä½†éœ€è¦åœ¨è¯»å–å<span class="strong">**æ ¡éªŒæˆ³**</span>æ˜¯å¦ä»ç„¶æœ‰æ•ˆï¼ˆå³è¿™æ®µæ—¶é—´æœ‰æ²¡æœ‰å†™çº¿ç¨‹æ’å…¥ï¼‰</span><br><span class="line"></span><br><span class="line">é”å‡çº§</span><br><span class="line"></span><br><span class="line">å¦‚æœä¹è§‚è¯»å¤±è´¥ï¼ˆéªŒæˆ³å¤±è´¥ï¼‰ï¼Œå°±ä¼šå‡çº§æˆè¯»é”æ¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼š</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>stamp = lock.readLock();<br>
// â€¦è¯»å–æ•°æ®â€¦<br>
lock.unlockRead(stamp);</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### å®Œæ•´ç¤ºä¾‹è¯´æ˜</span><br><span class="line"></span><br><span class="line">æ•°æ®å®¹å™¨ç±»ï¼š`DataContainerStamped`</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>class DataContainerStamped {<br>
private int data;<br>
private final StampedLock lock = new StampedLock();</p>
<pre><code>public int read(int readTime) &#123;
    long stamp = lock.tryOptimisticRead();     // å°è¯•ä¹è§‚è¯»
    sleep(readTime);
    if (lock.validate(stamp)) &#123;                // æˆ³æ ¡éªŒ
        return data;                           // æ ¡éªŒé€šè¿‡ï¼Œç›´æ¥è¿”å›
    &#125;
    // æ ¡éªŒå¤±è´¥ï¼Œå‡çº§ä¸ºè¯»é”
    stamp = lock.readLock();
    try &#123;
        sleep(readTime);
        return data;
    &#125; finally &#123;
        lock.unlockRead(stamp);
    &#125;
&#125;

public void write(int newData) &#123;
    long stamp = lock.writeLock();             // åŠ å†™é”
    try &#123;
        sleep(2);
        this.data = newData;
    &#125; finally &#123;
        lock.unlockWrite(stamp);               // è§£å†™é”
    &#125;
&#125;
</code></pre>
<p>}</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### ä¸¤ç§æµ‹è¯•åœºæ™¯åˆ†æ</span><br><span class="line"></span><br><span class="line">åœºæ™¯ <span class="number">1</span>ï¼šè¯» - è¯»ï¼ˆä¹è§‚è¯»æˆåŠŸï¼‰</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>// t1 æ‰§è¡Œ read(1)ï¼Œt2 ç¨åæ‰§è¡Œ read(0)</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">07</span>/image-<span class="number">1677</span>.png)</span><br><span class="line"></span><br><span class="line">åœºæ™¯ <span class="number">2</span>ï¼šè¯» - å†™ï¼ˆä¹è§‚è¯»å¤±è´¥ â†’ å‡çº§ï¼‰</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>// t1 æ‰§è¡Œ read(1)ï¼Œä¸­é€” t2 æ‰§è¡Œ write(100)</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1678.png)</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1679.png)</span><br><span class="line"></span><br><span class="line">æ€»ç»“</span><br><span class="line"></span><br><span class="line">|<span class="string"> æ¨¡å¼                </span>|<span class="string"> ç‰¹ç‚¹             </span>|<span class="string"> ç”¨é€”                       </span>|</span><br><span class="line">|<span class="string"> ------------------- </span>|<span class="string"> ---------------- </span>|<span class="string"> -------------------------- </span>|</span><br><span class="line">|<span class="string"> writeLock()         </span>|<span class="string"> ç‹¬å ã€é˜»å¡       </span>|<span class="string"> ä¸¥æ ¼å†™å…¥æ§åˆ¶               </span>|</span><br><span class="line">|<span class="string"> readLock()          </span>|<span class="string"> å…±äº«ã€é˜»å¡       </span>|<span class="string"> å¤šçº¿ç¨‹è¯»                   </span>|</span><br><span class="line">|<span class="string"> tryOptimisticRead() </span>|<span class="string"> éé˜»å¡ã€ä¹è§‚ç­–ç•¥ </span>|<span class="string"> æé«˜è¯»æ€§èƒ½ï¼ˆè¯»å¤šå†™å°‘åœºæ™¯ï¼‰ </span>|</span><br><span class="line"></span><br><span class="line"><span class="comment">### 5.Semaphoreï¼ˆä¿¡å·é‡ï¼‰</span></span><br><span class="line"></span><br><span class="line">è¿™éƒ¨åˆ†å†…å®¹ä»‹ç»äº† Java å¹¶å‘å·¥å…·ç±» <span class="symbol">*</span><span class="symbol">*</span>`Semaphore`ï¼ˆä¿¡å·é‡ï¼‰<span class="symbol">*</span><span class="symbol">*</span> çš„åŸºæœ¬ç”¨æ³•ï¼Œå®ƒæ˜¯ä¸€ç§ç”¨äºé™åˆ¶åŒæ—¶è®¿é—®æŸèµ„æºçš„çº¿ç¨‹æ•°é‡çš„æœºåˆ¶ã€‚</span><br><span class="line"></span><br><span class="line"><span class="comment">#### Semaphore æ¦‚å¿µ</span></span><br><span class="line"></span><br><span class="line">- <span class="symbol">*</span><span class="symbol">*</span>ä¿¡å·é‡ï¼ˆSemaphoreï¼‰<span class="symbol">*</span><span class="symbol">*</span>ï¼šç”¨äºæ§åˆ¶åŒæ—¶è®¿é—®æŸä¸€èµ„æºçš„çº¿ç¨‹æ•°é‡ã€‚</span><br><span class="line">- å®ƒç»´æŠ¤ä¸€ä¸ª<span class="symbol">*</span><span class="symbol">*</span>è®¸å¯è®¡æ•°å™¨ permits<span class="symbol">*</span><span class="symbol">*</span>ï¼Œçº¿ç¨‹è·å–è®¸å¯æ‰èƒ½æ‰§è¡Œï¼Œå¦åˆ™å°±é˜»å¡ã€‚</span><br><span class="line">- å¯ç”¨äºå®ç°èµ„æºæ± ã€é™æµå™¨ã€è¿æ¥æ± ç­‰åœºæ™¯ã€‚</span><br><span class="line"></span><br><span class="line">æ¡ˆä¾‹ä»£ç è§£æ</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Semaphore semaphore = new Semaphore(3);</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">åˆå§‹åŒ–ä¿¡å·é‡ï¼Œæœ€å¤šå…è®¸ <span class="strong">**3 ä¸ªçº¿ç¨‹**</span>åŒæ—¶æ‰§è¡Œå…³é”®ä¸šåŠ¡ã€‚</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>for (int i = 0; i &lt; 10; i++) {<br>
new Thread(() -&gt; {<br>
try {<br>
semaphore.acquire();  // è·å–è®¸å¯<br>
} catch (InterruptedException e) {<br>
e.printStackTrace();<br>
}<br>
try {<br>
log.debug(â€œrunningâ€¦â€);<br>
sleep(1);<br>
log.debug(â€œendâ€¦â€);<br>
} finally {<br>
semaphore.release();  // é‡Šæ”¾è®¸å¯<br>
}<br>
}).start();<br>
}</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">æµç¨‹è§£é‡Šï¼š</span><br><span class="line"></span><br><span class="line"><span class="bullet">1.</span> åŒæ—¶å¯åŠ¨ 10 ä¸ªçº¿ç¨‹ï¼›</span><br><span class="line"><span class="bullet">2.</span> æœ€å¤šåªèƒ½æœ‰ 3 ä¸ªçº¿ç¨‹æˆåŠŸ <span class="code">`acquire()`</span> â†’ å¼€å§‹æ‰§è¡Œï¼›</span><br><span class="line"><span class="bullet">3.</span> å…¶ä½™çº¿ç¨‹è¢«é˜»å¡ï¼›</span><br><span class="line"><span class="bullet">4.</span> æ¯ä¸ªçº¿ç¨‹ <span class="code">`sleep(1ç§’)`</span> åé‡Šæ”¾è®¸å¯ â†’ å…¶ä»–çº¿ç¨‹ç»§ç»­è·å–è®¸å¯å¹¶è¿è¡Œï¼›</span><br><span class="line"><span class="bullet">5.</span> æœ€ç»ˆ 10 ä¸ªçº¿ç¨‹éƒ½æ‰§è¡Œå®Œæ¯•ã€‚</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1680.png</span>)</span><br><span class="line"></span><br><span class="line">æ„é€ å™¨è¡¥å……è¯´æ˜</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Semaphore(int permits)<br>
Semaphore(int permits, boolean fair)</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">|<span class="string"> å‚æ•°    </span>|<span class="string"> è¯´æ˜                          </span>|</span><br><span class="line">|<span class="string"> ------- </span>|<span class="string"> ----------------------------- </span>|</span><br><span class="line">|<span class="string"> permits </span>|<span class="string"> åŒæ—¶å…è®¸å¤šå°‘ä¸ªçº¿ç¨‹è®¿é—®        </span>|</span><br><span class="line">|<span class="string"> fair    </span>|<span class="string"> æ˜¯å¦å…¬å¹³ï¼ˆFIFO æ’é˜Ÿè·å–è®¸å¯ï¼‰ </span>|</span><br><span class="line"></span><br><span class="line">éå…¬å¹³æ¨¡å¼ï¼šæ€§èƒ½é«˜ï¼Œå¯èƒ½æ’é˜Ÿï¼›</span><br><span class="line"></span><br><span class="line">å…¬å¹³æ¨¡å¼ï¼šçº¿ç¨‹å…ˆæ¥å…ˆå¾—ï¼Œè°ƒåº¦å…¬å¹³ã€‚</span><br><span class="line"></span><br><span class="line">åº”ç”¨åœºæ™¯ä¸¾ä¾‹</span><br><span class="line"></span><br><span class="line">|<span class="string"> åœºæ™¯                   </span>|<span class="string"> ä½¿ç”¨ Semaphore çš„åŸå›          </span>|</span><br><span class="line">|<span class="string"> ---------------------- </span>|<span class="string"> ----------------------------- </span>|</span><br><span class="line">|<span class="string"> æ•°æ®åº“è¿æ¥æ±            </span>|<span class="string"> é™åˆ¶åŒæ—¶èƒ½è¿æ¥æ•°æ®åº“çš„è¿æ¥æ•°  </span>|</span><br><span class="line">|<span class="string"> é™æµæ§åˆ¶ï¼ˆå¦‚ä¸Šä¼ å¹¶å‘ï¼‰ </span>|<span class="string"> æ§åˆ¶æ¥å£åŒæ—¶æ‰§è¡Œçš„æœ€å¤§çº¿ç¨‹æ•°  </span>|</span><br><span class="line">|<span class="string"> èµ„æºè®¿é—®é™æµï¼ˆå¦‚IOï¼‰   </span>|<span class="string"> é™åˆ¶åŒæ—¶è®¿é—®ç¡¬ç›˜/ç½‘ç»œçš„çº¿ç¨‹æ•° </span>|</span><br><span class="line">|<span class="string"> é™å®šåœè½¦ä½ï¼ˆç»å…¸ä¾‹å­ï¼‰ </span>|<span class="string"> æ¯æ¬¡åªèƒ½åœå›ºå®šæ•°é‡çš„è½¦        </span>|</span><br><span class="line"></span><br><span class="line"><span class="comment">#### Semaphore åº”ç”¨-åœ¨**è¿æ¥æ± å®ç°ä¸­çš„åº”ç”¨**</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">semaphore é™åˆ¶å¯¹å…±äº«èµ„æºçš„ä½¿ç”¨ï¼ˆ`Semaphore` æ§åˆ¶èµ„æºè®¿é—®å¹¶é˜²æ­¢å¹¶å‘å†²çªï¼‰</span><br><span class="line"></span><br><span class="line">- ä½¿ç”¨ Semaphore é™æµï¼Œåœ¨è®¿é—®é«˜å³°æœŸæ—¶ï¼Œè®©è¯·æ±‚çº¿ç¨‹é˜»å¡ï¼Œé«˜å³°æœŸè¿‡å»å†é‡Šæ”¾è®¸å¯ï¼Œå½“ç„¶å®ƒåªé€‚åˆé™åˆ¶å•æœº çº¿ç¨‹æ•°é‡ï¼Œ<span class="symbol">*</span><span class="symbol">*</span>å¹¶ä¸”ä»…æ˜¯é™åˆ¶çº¿ç¨‹æ•°ï¼Œè€Œä¸æ˜¯é™åˆ¶èµ„æºæ•°<span class="symbol">*</span><span class="symbol">*</span>ï¼ˆä¾‹å¦‚è¿æ¥æ•°ï¼Œè¯·å¯¹æ¯” Tomcat LimitLatch çš„å®ç°ï¼‰</span><br><span class="line">- ç”¨ Semaphore å®ç°ç®€å•è¿æ¥æ± ï¼Œå¯¹æ¯”ã€äº«å…ƒæ¨¡å¼ã€ä¸‹çš„å®ç°ï¼ˆç”¨wait notifyï¼‰ï¼Œæ€§èƒ½å’Œå¯è¯»æ€§æ˜¾ç„¶æ›´å¥½ï¼Œ æ³¨æ„ä¸‹é¢çš„å®ç°ä¸­çº¿ç¨‹æ•°å’Œæ•°æ®åº“è¿æ¥æ•°æ˜¯ç›¸ç­‰çš„</span><br><span class="line"></span><br><span class="line">æˆ‘ä»¬éœ€è¦æ„å»ºä¸€ä¸ª<span class="symbol">*</span><span class="symbol">*</span>çº¿ç¨‹å®‰å…¨çš„è¿æ¥æ± ç±» `Pool`<span class="symbol">*</span><span class="symbol">*</span>ï¼š</span><br><span class="line"></span><br><span class="line">- åŒä¸€æ—¶åˆ»æœ€å¤šåªæœ‰ `N` ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®æ± ä¸­çš„èµ„æºï¼›</span><br><span class="line">- å¤šäº `N` çš„çº¿ç¨‹å¿…é¡»é˜»å¡ç­‰å¾…ï¼›</span><br><span class="line">- å½“èµ„æºå½’è¿˜åï¼Œå…¶ä»–çº¿ç¨‹å†ç»§ç»­è·å–ã€‚</span><br><span class="line"></span><br><span class="line">è¿™å°±æ˜¯ `Semaphore` æœ€é€‚åˆçš„ç”¨æ­¦ä¹‹åœ°ã€‚</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1681.png)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>@Slf4j(topic = â€œc.Poolâ€)<br>
class Pool {<br>
// 1. è¿æ¥æ± å¤§å°<br>
private final int poolSize;<br>
// 2. è¿æ¥å¯¹è±¡æ•°ç»„<br>
private Connection[] connections;<br>
// 3. è¿æ¥çŠ¶æ€æ•°ç»„ 0 è¡¨ç¤ºç©ºé—²ï¼Œ 1 è¡¨ç¤ºç¹å¿™<br>
private AtomicIntegerArray states;<br>
private Semaphore semaphore;<br>
// 4. æ„é€ æ–¹æ³•åˆå§‹åŒ–<br>
public Pool(int poolSize) {<br>
this.poolSize = poolSize;<br>
// è®©è®¸å¯æ•°ä¸èµ„æºæ•°ä¸€è‡´<br>
this.semaphore = new Semaphore(poolSize);<br>
this.connections = new Connection[poolSize];<br>
this.states = new AtomicIntegerArray(new int[poolSize]);<br>
for (int i = 0; i &lt; poolSize; i++) {<br>
connections[i] = new MockConnection(â€œè¿æ¥â€ + (i+1));<br>
}<br>
}<br>
// 5. å€Ÿè¿æ¥<br>
public Connection borrow() {// t1, t2, t3<br>
// è·å–è®¸å¯<br>
try {<br>
semaphore.acquire(); // æ²¡æœ‰è®¸å¯çš„çº¿ç¨‹ï¼Œåœ¨æ­¤ç­‰å¾…<br>
} catch (InterruptedException e) {<br>
e.printStackTrace();<br>
}<br>
for (int i = 0; i &lt; poolSize; i++) {<br>
// è·å–ç©ºé—²è¿æ¥<br>
if(states.get(i) == 0) {<br>
if (states.compareAndSet(i, 0, 1)) {<br>
log.debug(â€œborrow {}â€, connections[i]);<br>
return connections[i];<br>
}<br>
}<br>
}<br>
// ä¸ä¼šæ‰§è¡Œåˆ°è¿™é‡Œ<br>
return null;<br>
}<br>
// 6. å½’è¿˜è¿æ¥<br>
public void free(Connection conn) {<br>
for (int i = 0; i &lt; poolSize; i++) {<br>
if (connections[i] == conn) {<br>
states.set(i, 0);<br>
log.debug(â€œfree {}â€, conn);<br>
semaphore.release();<br>
break;<br>
}<br>
}<br>
}<br>
}</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ä½¿ç”¨æµç¨‹è¯¦è§£</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1682.png)</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1683.png)</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1684.png)</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1685.png)</span><br><span class="line"></span><br><span class="line"><span class="comment">#### Semaphore åŸç†</span></span><br><span class="line"></span><br><span class="line">Semaphore æ˜¯ä»€ä¹ˆï¼Ÿ</span><br><span class="line"></span><br><span class="line">- å®ƒæ˜¯ä¸€ç§<span class="symbol">*</span><span class="symbol">*</span>å…±äº«é”ï¼ˆShared Lockï¼‰<span class="symbol">*</span><span class="symbol">*</span>ï¼Œç”¨äºæ§åˆ¶åŒæ—¶è®¿é—®æŸä¸ªèµ„æºçš„çº¿ç¨‹æ•°é‡ï¼›</span><br><span class="line">- ç±»æ¯”â€œåœè½¦åœºâ€ï¼š`permits` å°±æ˜¯è½¦ä½ï¼Œçº¿ç¨‹è·å–èµ„æºå°±åƒæŠ¢è½¦ä½ï¼Œè·å–ä¸åˆ°å°±å¾—ç­‰ã€‚</span><br><span class="line"></span><br><span class="line"><span class="comment">#### åŠ é”è§£é”æµç¨‹</span></span><br><span class="line"></span><br><span class="line">Semaphoreæœ‰ç‚¹åƒä¸€ä¸ªåœè½¦åœºï¼Œpermitså°±å¥½åƒåœè½¦ä½æ•°é‡ï¼Œå½“çº¿ç¨‹è·å¾—äº†permitså°±åƒæ˜¯è·å¾—äº†åœè½¦ä½ï¼Œç„¶ååœè½¦åœºæ˜¾ç¤ºç©ºä½™è½¦ä½å‡ä¸€ã€‚</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1690.png)</span><br><span class="line"></span><br><span class="line">åˆšå¼€å§‹ï¼Œpermitsï¼ˆstateï¼‰ä¸º 3ï¼Œè¿™æ—¶ 5 ä¸ªçº¿ç¨‹æ¥è·å–èµ„æº</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1686-1024x555.png)</span><br><span class="line"></span><br><span class="line">å‡è®¾å…¶ä¸­ Thread-1ï¼ŒThread-2ï¼ŒThread-4 cas ç«äº‰æˆåŠŸï¼Œè€Œ Thread-0 å’Œ Thread-3 ç«äº‰å¤±è´¥ï¼Œè¿›å…¥ AQS é˜Ÿåˆ— park é˜»å¡</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1687-1024x276.png)</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1691.png)</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1692.png)</span><br><span class="line"></span><br><span class="line">è¿™æ—¶ Thread-4 é‡Šæ”¾äº† permitsï¼ŒçŠ¶æ€å¦‚ä¸‹</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1693.png)</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1688-1024x302.png)</span><br><span class="line"></span><br><span class="line">æ¥ä¸‹æ¥ Thread-0 ç«äº‰æˆåŠŸï¼Œpermits å†æ¬¡è®¾ç½®ä¸º 0ï¼Œè®¾ç½®è‡ªå·±ä¸º head èŠ‚ç‚¹ï¼Œæ–­å¼€åŸæ¥çš„ head èŠ‚ç‚¹ï¼Œunpark æ¥ä¸‹æ¥çš„ Thread-3 èŠ‚ç‚¹ï¼Œä½†ç”±äº permits æ˜¯ 0ï¼Œå› æ­¤ Thread-3 åœ¨å°è¯•ä¸æˆåŠŸåå†æ¬¡è¿›å…¥ park çŠ¶æ€</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1689-1024x371.png)</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1694.png)</span><br><span class="line"></span><br><span class="line">æ–¹æ³•å›é¡¾</span><br><span class="line"></span><br><span class="line">|<span class="string"> æ–¹æ³•                             </span>|<span class="string"> è¯´æ˜                                      </span>|</span><br><span class="line">|<span class="string"> -------------------------------- </span>|<span class="string"> ----------------------------------------- </span>|</span><br><span class="line">|<span class="string"> `acquire()`                      </span>|<span class="string"> è·å–ä¸€ä¸ªè®¸å¯ï¼Œé˜»å¡ç›´åˆ°æˆåŠŸ                </span>|</span><br><span class="line">|<span class="string"> `release()`                      </span>|<span class="string"> é‡Šæ”¾ä¸€ä¸ªè®¸å¯                              </span>|</span><br><span class="line">|<span class="string"> `tryAcquireShared()`             </span>|<span class="string"> éå…¬å¹³æŠ¢å è®¸å¯ï¼ˆCASï¼‰                     </span>|</span><br><span class="line">|<span class="string"> `doAcquireSharedInterruptibly()` </span>|<span class="string"> åŠ å…¥é˜Ÿåˆ—ç­‰å¾…                              </span>|</span><br><span class="line">|<span class="string"> `doReleaseShared()`              </span>|<span class="string"> å”¤é†’é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆå¦‚ Thread-0ï¼‰       </span>|</span><br><span class="line">|<span class="string"> `setHeadAndPropagate()`          </span>|<span class="string"> å°†å½“å‰æˆåŠŸçº¿ç¨‹è®¾ç½®ä¸ºæ–° headï¼Œç»§ç»­ä¼ æ’­å”¤é†’ </span>|</span><br><span class="line">|<span class="string"> `Node.SIGNAL`                    </span>|<span class="string"> å‰é©±èŠ‚ç‚¹å‘Šè¯‰åç»§èŠ‚ç‚¹è¦é˜»å¡                </span>|</span><br><span class="line">|<span class="string"> `Node.PROPAGATE`                 </span>|<span class="string"> ç”¨äºå…±äº«ä¼ æ’­å”¤é†’                          </span>|</span><br><span class="line"></span><br><span class="line">æ€»ç»“ï¼šSemaphore åŸç†</span><br><span class="line"></span><br><span class="line">|<span class="string"> æµç¨‹æ­¥éª¤     </span>|<span class="string"> è¡Œä¸º                                      </span>|</span><br><span class="line">|<span class="string"> ------------ </span>|<span class="string"> ----------------------------------------- </span>|</span><br><span class="line">|<span class="string"> è·å–è®¸å¯æˆåŠŸ </span>|<span class="string"> `CAS(state)` æˆåŠŸåç›´æ¥è¿”å›               </span>|</span><br><span class="line">|<span class="string"> è·å–è®¸å¯å¤±è´¥ </span>|<span class="string"> å…¥é˜Ÿåˆ—ï¼Œpark é˜»å¡                         </span>|</span><br><span class="line">|<span class="string"> è®¸å¯é‡Šæ”¾     </span>|<span class="string"> `state++`ï¼Œå”¤é†’ä¸‹ä¸€ä¸ªç­‰å¾…çº¿ç¨‹             </span>|</span><br><span class="line">|<span class="string"> å”¤é†’æµç¨‹     </span>|<span class="string"> `doReleaseShared()` + `unparkSuccessor()` </span>|</span><br><span class="line"></span><br><span class="line"><span class="comment">### 6.CountDownLatchï¼ˆå€’è®¡æ—¶å™¨ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### `CountDownLatch` æ˜¯ä»€ä¹ˆï¼Ÿ</span></span><br><span class="line"></span><br><span class="line">`CountDownLatch` æ˜¯ä¸€ä¸ªå€’è®¡æ—¶å™¨ï¼Œç”¨äº<span class="symbol">*</span><span class="symbol">*</span>ç­‰å¾…å¤šä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡åï¼Œå†ç»§ç»­ä¸»çº¿ç¨‹æˆ–å…¶ä»–ä»»åŠ¡çš„æ‰§è¡Œ<span class="symbol">*</span><span class="symbol">*</span>ã€‚</span><br><span class="line"></span><br><span class="line">æ ¸å¿ƒæ–¹æ³•è¯´æ˜</span><br><span class="line"></span><br><span class="line">|<span class="string"> æ–¹æ³•                    </span>|<span class="string"> ä½œç”¨è¯´æ˜                       </span>|</span><br><span class="line">|<span class="string"> ----------------------- </span>|<span class="string"> ------------------------------ </span>|</span><br><span class="line">|<span class="string"> `new CountDownLatch(n)` </span>|<span class="string"> åˆå§‹åŒ–å€’è®¡æ—¶å™¨ï¼Œå†…éƒ¨è®¡æ•°å™¨ä¸º n </span>|</span><br><span class="line">|<span class="string"> `countDown()`           </span>|<span class="string"> æ¯æ¬¡è°ƒç”¨å°†è®¡æ•°å™¨å‡ 1           </span>|</span><br><span class="line">|<span class="string"> `await()`               </span>|<span class="string"> é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°è®¡æ•°å™¨ä¸º 0   </span>|</span><br><span class="line"></span><br><span class="line">ä»£ç æ¼”ç¤º</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>public static void main(String[] args) throws InterruptedException {<br>
CountDownLatch latch = new CountDownLatch(3);<br>
new Thread(() -&gt; {<br>
log.debug(â€œbeginâ€¦â€);<br>
sleep(1);<br>
latch.countDown();<br>
log.debug(â€œendâ€¦{}â€, latch.getCount());<br>
}).start();<br>
new Thread(() -&gt; {<br>
log.debug(â€œbeginâ€¦â€);<br>
sleep(2);<br>
latch.countDown();<br>
log.debug(â€œendâ€¦{}â€, latch.getCount());<br>
}).start();<br>
new Thread(() -&gt; {<br>
log.debug(â€œbeginâ€¦â€);<br>
sleep(1.5);<br>
latch.countDown();<br>
log.debug(â€œendâ€¦{}â€, latch.getCount());<br>
}).start();<br>
log.debug(â€œwaitingâ€¦â€);<br>
latch.await();<br>
log.debug(â€œwait endâ€¦â€);<br>
}</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1695.png)</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1696.png)</span><br><span class="line"></span><br><span class="line"><span class="comment">#### å¯¹æ¯”ï¼šCountDownLatch vs join</span></span><br><span class="line"></span><br><span class="line">|<span class="string"> ç‰¹æ€§             </span>|<span class="string"> `CountDownLatch` </span>|<span class="string"> `join()`             </span>|</span><br><span class="line">|<span class="string"> ---------------- </span>|<span class="string"> ---------------- </span>|<span class="string"> -------------------- </span>|</span><br><span class="line">|<span class="string"> å¯ç»“åˆçº¿ç¨‹æ± ä½¿ç”¨ </span>|<span class="string"> âœ… æ˜¯             </span>|<span class="string"> âŒ ä¸æ”¯æŒ             </span>|</span><br><span class="line">|<span class="string"> æ§åˆ¶å¤šä¸ªçº¿ç¨‹åŒæ­¥ </span>|<span class="string"> âœ… æ›´çµæ´»         </span>|<span class="string"> â›” å¿…é¡»å¯¹æ¯ä¸ªçº¿ç¨‹è°ƒç”¨ </span>|</span><br><span class="line">|<span class="string"> ç¼–ç¨‹é£æ ¼         </span>|<span class="string"> é¢å‘ä»»åŠ¡         </span>|<span class="string"> é¢å‘çº¿ç¨‹             </span>|</span><br><span class="line"></span><br><span class="line">çº¿ç¨‹æ± åœºæ™¯ä¸‹ä½¿ç”¨</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1697.png)</span><br><span class="line"></span><br><span class="line"><span class="comment">#### CountDownLatchåº”ç”¨-åŒæ­¥ç­‰å¾…å¤šä¸ªçº¿ç¨‹å‡†å¤‡å®Œæ¯•</span></span><br><span class="line"></span><br><span class="line">æ¨¡æ‹Ÿåœºæ™¯ï¼šæ¸¸æˆåŠ è½½è¿›åº¦æ¡ï¼ˆç‹è€…è£è€€ï¼‰</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>AtomicInteger num = new AtomicInteger(0);<br>
ExecutorService service = Executors.newFixedThreadPool(10, Â® -&gt; {<br>
return new Thread(r, â€œtâ€ + num.getAndIncrement());<br>
});<br>
CountDownLatch latch = new CountDownLatch(10);<br>
String[] all = new String[10];<br>
Random r = new Random();<br>
for (int j = 0; j &lt; 10; j++) {<br>
int x = j;<br>
service.submit(() -&gt; {<br>
for (int i = 0; i &lt;= 100; i++) {<br>
try {<br>
//éšæœºä¼‘çœ ï¼Œæ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ<br>
Thread.sleep(r.nextInt(100));<br>
} catch (InterruptedException e) {<br>
}<br>
all[x] = Thread.currentThread().getName() + â€œ(â€ + (i + â€œ%â€) + â€œ)â€;<br>
//\rå¯ä»¥è®©å½“å‰è¾“å‡ºè¦†ç›–ä¸Šä¸€æ¬¡çš„è¾“å‡ºã€‚<br>
System.out.print(â€œ\râ€ + Arrays.toString(all));<br>
}<br>
latch.countDown();<br>
});<br>
}<br>
latch.await();<br>
System.out.println(â€œ\næ¸¸æˆå¼€å§‹â€¦â€);<br>
service.shutdown();</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ä¸­é—´è¾“å‡º</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>[t0(52%), t1(47%), t2(51%), t3(40%), t4(49%), t5(44%), t6(49%), t7(52%), t8(46%), t9(46%)]</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">æœ€åè¾“å‡º</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>[t0(100%), t1(100%), t2(100%), t3(100%), t4(100%), t5(100%), t6(100%), t7(100%), t8(100%),<br>
t9(100%)]<br>
æ¸¸æˆå¼€å§‹â€¦</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1698.png</span>)</span><br><span class="line"></span><br><span class="line">æ•ˆæœè¯´æ˜ï¼š</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹æ›´æ–°è‡ªå·±çš„è¿›åº¦ï¼›</span><br><span class="line"><span class="bullet">-</span> ä¸»çº¿ç¨‹é€šè¿‡ <span class="code">`await()`</span> ç­‰å¾…æ‰€æœ‰åŠ è½½å®Œæˆï¼›</span><br><span class="line"><span class="bullet">-</span> ç­‰åˆ° <span class="code">`count == 0`</span>ï¼Œä¸»çº¿ç¨‹æ‰“å°â€œæ¸¸æˆå¼€å§‹â€ã€‚</span><br><span class="line"></span><br><span class="line">è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„â€œ<span class="strong">**ç­‰å¾…å¤šä¸ªä»»åŠ¡å‡†å¤‡å®Œæ¯•å†å¼€å§‹**</span>â€çš„åœºæ™¯ã€‚</span><br><span class="line"></span><br><span class="line"><span class="section">#### CountDownLatchåº”ç”¨-åŒæ­¥ç­‰å¾…å¤šä¸ªè¿œç¨‹è°ƒç”¨ç»“æŸ</span></span><br><span class="line"></span><br><span class="line">æ¨¡æ‹Ÿåœºæ™¯ï¼šå¹¶å‘è°ƒç”¨å¤šä¸ª REST æ¥å£</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>@RestController<br>
public class TestCountDownlatchController {<br>
@GetMapping(â€œ/order/{id}â€)<br>
public Map&lt;String, Object&gt; order(@PathVariable int id) {<br>
HashMap&lt;String, Object&gt; map = new HashMap&lt;&gt;();<br>
map.put(â€œidâ€, id);<br>
map.put(â€œtotalâ€, â€œ2300.00â€);<br>
sleep(2000);<br>
return map;<br>
}<br>
@GetMapping(â€œ/product/{id}â€)<br>
public Map&lt;String, Object&gt; product(@PathVariable int id) {<br>
HashMap&lt;String, Object&gt; map = new HashMap&lt;&gt;();<br>
if (id == 1) {<br>
map.put(â€œnameâ€, â€œå°çˆ±éŸ³ç®±â€);<br>
map.put(â€œpriceâ€, 300);<br>
} else if (id == 2) {<br>
map.put(â€œnameâ€, â€œå°ç±³æ‰‹æœºâ€);<br>
map.put(â€œpriceâ€, 2000);<br>
}<br>
map.put(â€œidâ€, id);<br>
sleep(1000);<br>
return map;<br>
}<br>
@GetMapping(â€œ/logistics/{id}â€)<br>
public Map&lt;String, Object&gt; logistics(@PathVariable int id) {<br>
HashMap&lt;String, Object&gt; map = new HashMap&lt;&gt;();<br>
map.put(â€œidâ€, id);<br>
map.put(â€œnameâ€, â€œä¸­é€šå¿«é€’â€);<br>
sleep(2500);<br>
return map;<br>
}<br>
private void sleep(int millis) {<br>
try {<br>
Thread.sleep(millis);<br>
} catch (InterruptedException e) {<br>
e.printStackTrace();<br>
}<br>
}<br>
}</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">rest</span>è¿œç¨‹è°ƒç”¨</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>RestTemplate restTemplate = new RestTemplate();<br>
log.debug(â€œbeginâ€);<br>
ExecutorService service = Executors.newCachedThreadPool();<br>
CountDownLatch latch = new CountDownLatch(4);<br>
Future&lt;Map&lt;String,Object&gt;&gt; f1 = service.submit(() -&gt; {<br>
Map&lt;String, Object&gt; r =<br>
restTemplate.getForObject(â€œ<a target="_blank" rel="noopener" href="http://localhost:8080/order/%7B1%7D">http://localhost:8080/order/{1}</a>â€, Map.class, 1);<br>
return r;<br>
});<br>
Future&lt;Map&lt;String, Object&gt;&gt; f2 = service.submit(() -&gt; {<br>
Map&lt;String, Object&gt; r =<br>
restTemplate.getForObject(â€œ<a target="_blank" rel="noopener" href="http://localhost:8080/product/%7B1%7D">http://localhost:8080/product/{1}</a>â€, Map.class, 1);<br>
return r;<br>
});<br>
Future&lt;Map&lt;String, Object&gt;&gt; f3 = service.submit(() -&gt; {<br>
Map&lt;String, Object&gt; r =<br>
restTemplate.getForObject(â€œ<a target="_blank" rel="noopener" href="http://localhost:8080/product/%7B1%7D">http://localhost:8080/product/{1}</a>â€, Map.class, 2);<br>
return r;<br>
});<br>
Future&lt;Map&lt;String, Object&gt;&gt; f4 = service.submit(() -&gt; {<br>
Map&lt;String, Object&gt; r =<br>
restTemplate.getForObject(â€œ<a target="_blank" rel="noopener" href="http://localhost:8080/logistics/%7B1%7D">http://localhost:8080/logistics/{1}</a>â€, Map.class, 1);<br>
return r;<br>
});<br>
System.out.println(f1.get());<br>
System.out.println(f2.get());<br>
System.out.println(f3.get());<br>
System.out.println(f4.get());<br>
log.debug(â€œæ‰§è¡Œå®Œæ¯•â€);<br>
service.shutdown();</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">æ‰§è¡Œç»“æœ</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>19:51:39.711 c.TestCountDownLatch [main] - begin<br>
{total=2300.00, id=1}<br>
{price=300, name=å°çˆ±éŸ³ç®±, id=1}<br>
{price=2000, name=å°ç±³æ‰‹æœº, id=2}<br>
{name=ä¸­é€šå¿«é€’, id=1}<br>
19:51:42.407 c.TestCountDownLatch [main] - æ‰§è¡Œå®Œæ¯•</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">è¯´æ˜ï¼š</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> è¿™ç§ç­‰å¾…å¤šä¸ªå¸¦æœ‰è¿”å›å€¼çš„ä»»åŠ¡çš„åœºæ™¯ï¼Œè¿˜æ˜¯ç”¨futureæ¯”è¾ƒåˆé€‚ï¼ŒCountdownLatché€‚åˆä»»åŠ¡æ²¡æœ‰è¿”å›å€¼çš„åœºæ™¯ã€‚</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1699.png</span>)</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> æ¯ä¸ª <span class="code">`Future`</span> æ˜¯ä¸€ä¸ªå¼‚æ­¥è¯·æ±‚ï¼›</span><br><span class="line"><span class="bullet">-</span> <span class="code">`get()`</span> ä¼šé˜»å¡ç›´åˆ°è¯¥è¯·æ±‚ç»“æŸï¼›</span><br><span class="line"><span class="bullet">-</span> æ‰€ä»¥è™½ç„¶æ²¡æœ‰ç”¨ <span class="code">`CountDownLatch.await()`</span>ï¼Œä½†æ•ˆæœæ˜¯ç±»ä¼¼çš„ï¼›</span><br><span class="line"><span class="bullet">-</span> ä¸è¿‡æ­¤åœºæ™¯<span class="strong">**æ›´æ¨èä½¿ç”¨ `Future` æˆ– `CompletableFuture`**</span>ã€‚</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1700.png</span>)</span><br><span class="line"></span><br><span class="line">æ€»ç»“</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1701.png</span>)</span><br><span class="line"></span><br><span class="line"><span class="section">### 7.`CyclicBarrier`ï¼ˆå¾ªç¯æ …æ ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="section">#### ä¸ºä»€ä¹ˆéœ€è¦ `CyclicBarrier`ï¼Ÿ</span></span><br><span class="line"></span><br><span class="line">CountdownLatchçš„ç¼ºç‚¹åœ¨äºä¸èƒ½é‡ç”¨ï¼Œè§ä¸‹ï¼š</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>private static void test1() {<br>
ExecutorService service = Executors.newFixedThreadPool(5);<br>
for (int i = 0; i &lt; 3; i++) {<br>
CountDownLatch latch = new CountDownLatch(2);<br>
service.submit(() -&gt; {<br>
log.debug(â€œtask1 startâ€¦â€);<br>
sleep(1);<br>
latch.countDown();<br>
});<br>
service.submit(() -&gt; {<br>
log.debug(â€œtask2 startâ€¦â€);<br>
sleep(2);<br>
latch.countDown();<br>
});<br>
try {<br>
latch.await();<br>
} catch (InterruptedException e) {<br>
e.printStackTrace();<br>
}<br>
log.debug(â€œtask1 task2 finishâ€¦â€);<br>
}<br>
service.shutdown();<br>
}</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">07</span>/image-<span class="number">1702</span>.png)</span><br><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">07</span>/image-<span class="number">1703</span>.png)</span><br><span class="line"></span><br><span class="line">æƒ³è¦é‡å¤ä½¿ç”¨CountdownLatchè¿›è¡ŒåŒæ­¥ï¼Œå¿…é¡»åˆ›å»ºå¤šä¸ªCountDownLatchå¯¹è±¡ã€‚</span><br><span class="line"></span><br><span class="line">å¼•å…¥ CyclicBarrierï¼ˆå¾ªç¯å±éšœï¼‰</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>CyclicBarrier barrier = new CyclicBarrier(2);</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">-</span> æ„æ€æ˜¯ï¼š<span class="strong">**ç­‰åˆ°ä¸¤ä¸ªçº¿ç¨‹éƒ½æ‰§è¡Œåˆ° `barrier.await()` å¤„ï¼Œæ‰ä¼šç»§ç»­å‘ä¸‹æ‰§è¡Œ**</span>ï¼›</span><br><span class="line"><span class="bullet">-</span> è¾¾ä¸åˆ°æ•°é‡ï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½é˜»å¡ï¼›</span><br><span class="line"><span class="bullet">-</span> è¾¾åˆ°åä¸€èµ·ç»§ç»­ï¼Œå°±åƒâ€œäººæ»¡å‘è½¦â€ã€‚</span><br><span class="line"></span><br><span class="line"><span class="section">#### ä»£ç ç¤ºä¾‹</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>CyclicBarrier cb = new CyclicBarrier(2); // ä¸ªæ•°ä¸º2æ—¶æ‰ä¼šç»§ç»­æ‰§è¡Œ<br>
new Thread(()-&gt;{<br>
System.out.println(â€œçº¿ç¨‹1å¼€å§‹â€¦â€+new Date());<br>
try {<br>
cb.await(); // å½“ä¸ªæ•°ä¸è¶³æ—¶ï¼Œç­‰å¾…<br>
} catch (InterruptedException | BrokenBarrierException e) {<br>
e.printStackTrace();<br>
}<br>
System.out.println(â€œçº¿ç¨‹1ç»§ç»­å‘ä¸‹è¿è¡Œâ€¦â€+new Date());<br>
}).start();<br>
new Thread(()-&gt;{<br>
System.out.println(â€œçº¿ç¨‹2å¼€å§‹â€¦â€+new Date());<br>
try { Thread.sleep(2000); } catch (InterruptedException e) { }<br>
try {<br>
cb.await(); // 2 ç§’åï¼Œçº¿ç¨‹ä¸ªæ•°å¤Ÿ2ï¼Œç»§ç»­è¿è¡Œ<br>
} catch (InterruptedException | BrokenBarrierException e) {<br>
e.printStackTrace();<br>
}<br>
System.out.println(â€œçº¿ç¨‹2ç»§ç»­å‘ä¸‹è¿è¡Œâ€¦â€+new Date());<br>
}).start();</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">è¡Œä¸ºè¯´æ˜ï¼š</span><br><span class="line"></span><br><span class="line">- çº¿ç¨‹<span class="number">1</span>å…ˆè¿è¡Œï¼Œé‡åˆ° `await()` è¿›å…¥é˜»å¡ï¼›</span><br><span class="line">- çº¿ç¨‹<span class="number">2</span>å»¶è¿Ÿ<span class="number">2</span>ç§’åè¿è¡Œï¼Œè°ƒç”¨ `await()`ï¼›</span><br><span class="line">- æ­¤æ—¶åˆ°è¾¾<span class="number">2</span>ä¸ªçº¿ç¨‹ï¼Œ**å±éšœæ‰“å¼€**ï¼Œä¸¤çº¿ç¨‹ç»§ç»­è¿è¡Œï¼›</span><br><span class="line">- å®ç°äº†â€œ**é˜¶æ®µæ€§ç­‰å¾…åŒæ­¥**â€ã€‚</span><br><span class="line"></span><br><span class="line"><span class="title">![img](https:</span>//www.legendkiller.xyz/wp-content/uploads/<span class="number">2025</span>/<span class="number">07</span>/image-<span class="number">1704</span>.png)</span><br><span class="line"></span><br><span class="line">| å·¥å…·           | ç±»æ¯”è¯´æ˜                     |</span><br><span class="line">| -------------- | ---------------------------- |</span><br><span class="line">| CountDownLatch | ä¸€æ¬¡æ€§ä½¿ç”¨çš„é—¨é—©ï¼ˆä¸€æ¬¡å€’è®¡ï¼‰ |</span><br><span class="line">| CyclicBarrier  | è‡ªåŠ¨å¤ä½çš„æ …æ ï¼ˆäººæ»¡å†å‘è½¦ï¼‰ |</span><br><span class="line"></span><br><span class="line">ä½¿ç”¨åœºæ™¯ï¼š</span><br><span class="line"></span><br><span class="line">ä¾‹å¦‚è¿›è¡Œ <span class="number">3</span> è½®æ¯”èµ›ï¼Œæ¯è½®éƒ½ç­‰é€‰æ‰‹å‡†å¤‡å°±ç»ªå†å‡ºå‘ â†’ ç”¨ `CyclicBarrier` æœ€åˆé€‚ï¼</span><br><span class="line"></span><br><span class="line"><span class="title">![img](https:</span>//www.legendkiller.xyz/wp-content/uploads/<span class="number">2025</span>/<span class="number">07</span>/image-<span class="number">1705</span>.png)</span><br><span class="line"></span><br><span class="line">#### CyclicBarrierä¸`CountDownLatch`å¯¹æ¯”</span><br><span class="line"></span><br><span class="line">| ç‰¹æ€§           | `CountDownLatch`          | `CyclicBarrier`           |</span><br><span class="line">| -------------- | ------------------------- | ------------------------- |</span><br><span class="line">| èƒ½å¦å¤ç”¨       | âŒ ä¸€æ¬¡æ€§ä½¿ç”¨              | âœ… å¯é‡å¤ä½¿ç”¨              |</span><br><span class="line">| ä½¿ç”¨æ–¹å¼       | `countDown()` + `await()` | `await()` ç»Ÿä¸€é˜»å¡ç‚¹      |</span><br><span class="line">| æ˜¯å¦æœ‰å›è°ƒåŠŸèƒ½ | âŒ æ²¡æœ‰                    | âœ… å¯è®¾ç½® barrierAction    |</span><br><span class="line">| åº”ç”¨åœºæ™¯       | ä¸»çº¿ç¨‹ç­‰å¾…å­çº¿ç¨‹å®Œæˆ      | å¤šçº¿ç¨‹äº’ç›¸ç­‰å¾… â†’ åŒæ­¥ç»§ç»­ |</span><br><span class="line"></span><br><span class="line">- `CyclicBarrier` éå¸¸é€‚åˆ**é˜¶æ®µæ€§çº¿ç¨‹åŒæ­¥**ï¼›</span><br><span class="line">- å®ƒæ¯” `CountDownLatch` æ›´åŠ çµæ´»ï¼Œ**å¯å¤ç”¨ + å¯å›è°ƒ**ï¼›</span><br><span class="line">- åœ¨å¤šè½®ä»»åŠ¡åä½œã€å¤šäººæ¸¸æˆå‡†å¤‡å°±ç»ªã€æ‰¹é‡å¤„ç†åŒæ­¥ç­‰åœºæ™¯ä¸­éå¸¸å®ç”¨ã€‚</span><br><span class="line"></span><br><span class="line">### <span class="number">8</span>.çº¿ç¨‹å®‰å…¨é›†åˆç±»æ¦‚è¿°</span><br><span class="line"></span><br><span class="line"><span class="title">![img](https:</span>//www.legendkiller.xyz/wp-content/uploads/<span class="number">2025</span>/<span class="number">07</span>/image-<span class="number">1706</span>-<span class="number">1024</span>x220.png)</span><br><span class="line"></span><br><span class="line">çº¿ç¨‹å®‰å…¨é›†åˆç±»å¯ä»¥åˆ†ä¸ºä¸‰å¤§ç±»ï¼š</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>.é—ç•™ç±»ï¼ˆLegacyï¼‰</span><br><span class="line"></span><br><span class="line">- å¦‚ `Hashtable`ã€`Vector`</span><br><span class="line">- åœ¨æ–¹æ³•å±‚é¢ç›´æ¥ä½¿ç”¨ `synchronized` ä¿®é¥°ï¼Œçº¿ç¨‹å®‰å…¨</span><br><span class="line">- å®‰å…¨ï¼Œä½†å¹¶å‘æ€§èƒ½å·®ï¼ˆç«äº‰æ¿€çƒˆæ—¶æ€§èƒ½æ€¥å‰§ä¸‹é™ï¼‰</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>.Collections å·¥å…·ç±»åŒ…è£…</span><br><span class="line"></span><br><span class="line">é€šè¿‡ `Collections.synchronizedXXX()` å¯¹éçº¿ç¨‹å®‰å…¨çš„é›†åˆè¿›è¡ŒåŒ…è£…ï¼š</span><br><span class="line"></span><br><span class="line"><span class="title">![img](https:</span>//www.legendkiller.xyz/wp-content/uploads/<span class="number">2025</span>/<span class="number">07</span>/image-<span class="number">1708</span>.png)</span><br><span class="line"></span><br><span class="line">- `Collections.synchronizedCollection`</span><br><span class="line">- `Collections.synchronizedList`</span><br><span class="line">- `Collections.synchronizedMap`</span><br><span class="line">- `Collections.synchronizedSet`</span><br><span class="line">- `Collections.synchronizedNavigableMap`</span><br><span class="line">- `Collections.synchronizedNavigableSet`</span><br><span class="line">- `Collections.synchronizedSortedMap`</span><br><span class="line">- `Collections.synchronizedSortedSet`</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>.java.util.concurrent.*ï¼ˆJUCåŒ…ï¼‰</span><br><span class="line"></span><br><span class="line">è¿™æ˜¯ä¸»æµæ¨èç”¨æ³•ï¼Œæ”¯æŒæ›´é«˜æ€§èƒ½çš„å¹¶å‘é›†åˆç±»ã€‚åˆ†ä¸ºä¸‰ç±»ï¼š Blockingã€CopyOnWriteã€Concurrent</span><br><span class="line"></span><br><span class="line">- </span><br><span class="line"></span><br><span class="line">&gt; #### Blocking ç±»å‹</span><br><span class="line">&gt;</span><br><span class="line">&gt; - å¦‚ `BlockingQueue`ã€`BlockingDeque`</span><br><span class="line">&gt; - åŸºäºé”å®ç°ï¼Œæ”¯æŒ `put/take` ç­‰é˜»å¡æ–¹æ³•</span><br><span class="line">&gt; - åº”ç”¨äºï¼š**çº¿ç¨‹é—´é€šä¿¡/ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹**</span><br><span class="line"></span><br><span class="line">#### CopyOnWrite ç±»å‹</span><br><span class="line"></span><br><span class="line">- å¦‚ `CopyOnWriteArrayList`ã€`CopyOnWriteArraySet`</span><br><span class="line">- å†™æ“ä½œå¤åˆ¶æ•°æ®ï¼Œè¯»æ“ä½œæ— é”</span><br><span class="line">- åº”ç”¨äºï¼š**è¯»å¤šå†™å°‘**åœºæ™¯ï¼ˆå¦‚ç›‘å¬å™¨åˆ—è¡¨ï¼‰</span><br><span class="line"></span><br><span class="line">#### Concurrent ç±»å‹</span><br><span class="line"></span><br><span class="line">- å¦‚ `ConcurrentHashMap`ã€`ConcurrentLinkedQueue`</span><br><span class="line">- å†…éƒ¨å¤§é‡ä½¿ç”¨ **CAS + åˆ†æ®µé”**</span><br><span class="line">- æä¾›å¼±ä¸€è‡´æ€§ï¼ˆä¸‹æ–‡è¯¦è§£ï¼‰</span><br><span class="line"></span><br><span class="line">##### å¼±ä¸€è‡´æ€§è¯´æ˜ï¼ˆConcurrent ç³»åˆ—çš„ç‰¹æ€§ï¼‰</span><br><span class="line"></span><br><span class="line">| æ“ä½œ          | å«ä¹‰è¯´æ˜                                                     |</span><br><span class="line">| ------------- | ------------------------------------------------------------ |</span><br><span class="line">| éå†          | å¼±ä¸€è‡´æ€§è¿­ä»£å™¨ï¼šéå†ä¸­å®¹å™¨è¢«ä¿®æ”¹ï¼Œä»ç„¶å¯ä»¥ç»§ç»­è®¿é—®æ—§å€¼ï¼Œä¸æŠ¥é”™ |</span><br><span class="line">| size/contains | å¯èƒ½è¿”å›éç²¾ç¡®å€¼ï¼ˆå› ä¸ºæŸ¥è¯¢æ—¶æœªåŠ é”ï¼Œæˆ–æ•°æ®æ­£åœ¨å˜åŒ–ï¼‰         |</span><br><span class="line">| è¯»å–          | è¯»åˆ°çš„å¯èƒ½æ˜¯ç¨æ—©ä¹‹å‰çš„å€¼ï¼ˆéå¼ºä¸€è‡´æ€§ï¼‰                       |</span><br><span class="line"></span><br><span class="line">è¿™ç§è¡Œä¸ºå¯ä»¥æ¢æ¥æå¤§çš„ååæ€§èƒ½ï¼ˆæ¯”åŠ é”æ–¹å¼è½»é‡å¾ˆå¤šï¼‰ï¼Œé€‚åˆå¤šæ•°åœºæ™¯ã€‚</span><br><span class="line"></span><br><span class="line">#### éçº¿ç¨‹å®‰å…¨å®¹å™¨çš„ fail-fast æœºåˆ¶</span><br><span class="line"></span><br><span class="line">å½“ä½¿ç”¨éçº¿ç¨‹å®‰å…¨é›†åˆï¼ˆå¦‚ `ArrayList`ï¼‰è¿›è¡Œéå†æ—¶ï¼Œè‹¥å®¹å™¨è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼š</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Exception in thread â€œmainâ€ java.util.ConcurrentModificationException</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- åŸç†ï¼šå®¹å™¨ä¸­ç»´æŠ¤ä¸€ä¸ª `modCount` ä¿®æ”¹æ¬¡æ•°å­—æ®µï¼›</span><br><span class="line">- è¿­ä»£å™¨è®°å½•åˆå§‹å€¼ï¼Œéå†ä¸­æ£€æµ‹æ˜¯å¦å˜åŒ–ï¼›</span><br><span class="line">- å¦‚æœå‘ç°æœ‰æ”¹åŠ¨ â†’ æŠ¥é”™ã€‚</span><br><span class="line"></span><br><span class="line"><span class="comment">#### æ€»ç»“å¯¹æ¯”</span></span><br><span class="line"></span><br><span class="line">|<span class="string"> ç±»å‹                            </span>|<span class="string"> æ˜¯å¦çº¿ç¨‹å®‰å…¨ </span>|<span class="string"> æ˜¯å¦æ¨è </span>|<span class="string"> å¹¶å‘æ€§èƒ½       </span>|<span class="string"> ç‰¹ç‚¹                       </span>|</span><br><span class="line">|<span class="string"> ------------------------------- </span>|<span class="string"> ------------ </span>|<span class="string"> -------- </span>|<span class="string"> -------------- </span>|<span class="string"> -------------------------- </span>|</span><br><span class="line">|<span class="string"> `Hashtable` / `Vector`          </span>|<span class="string"> âœ… æ˜¯         </span>|<span class="string"> âŒ ä¸æ¨è </span>|<span class="string"> å·®             </span>|<span class="string"> ç²—ç²’åº¦é”ï¼Œæ€§èƒ½ä½           </span>|</span><br><span class="line">|<span class="string"> `Collections.synchronizedXXX()` </span>|<span class="string"> âœ… æ˜¯         </span>|<span class="string"> âŒ ä¸æ¨è </span>|<span class="string"> å·®             </span>|<span class="string"> åŒ…è£…å®ç°ï¼Œé”ä½æ•´ä¸ªå®¹å™¨æ–¹æ³• </span>|</span><br><span class="line">|<span class="string"> JUC å¹¶å‘é›†åˆç±»                  </span>|<span class="string"> âœ… æ˜¯         </span>|<span class="string"> âœ… æ¨è   </span>|<span class="string"> é«˜             </span>|<span class="string"> ç²¾ç»†é”ã€CASã€å¼±ä¸€è‡´æ€§      </span>|</span><br><span class="line">|<span class="string"> `CopyOnWriteXXX`                </span>|<span class="string"> âœ… æ˜¯         </span>|<span class="string"> âœ… ç‰¹æ®Šç”¨ </span>|<span class="string"> è¯»é«˜æ•ˆï¼Œå†™ä½æ•ˆ </span>|<span class="string"> é€‚åˆè¯»å¤šå†™å°‘               </span>|</span><br><span class="line">|<span class="string"> `BlockingQueue` ç­‰              </span>|<span class="string"> âœ… æ˜¯         </span>|<span class="string"> âœ… æ¨è   </span>|<span class="string"> é«˜             </span>|<span class="string"> æ”¯æŒé˜»å¡ã€çº¿ç¨‹é—´é€šä¿¡       </span>|</span><br><span class="line"></span><br><span class="line"><span class="comment">### 9.ConcurrentHashMap</span></span><br><span class="line"></span><br><span class="line">ConcurrentHashMap æ˜¯Javaä¸­ç”¨äºå¹¶å‘åœºæ™¯çš„å“ˆå¸Œè¡¨ï¼Œæä¾›çº¿ç¨‹å®‰å…¨çš„é”®å€¼å¯¹å­˜å‚¨åŠŸèƒ½ã€‚å…¶æ ¸å¿ƒè®¾è®¡å…¼é¡¾æ•ˆç‡ä¸å®‰å…¨æ€§ï¼Œä¸»è¦åº”ç”¨äºå¤šçº¿ç¨‹ç¯å¢ƒä»¥æå‡æ€§èƒ½ã€‚</span><br><span class="line"></span><br><span class="line"><span class="comment">#### åº”ç”¨ä¹‹å•è¯è®¡æ•°</span></span><br><span class="line"></span><br><span class="line">åº”ç”¨èƒŒæ™¯ï¼šå¹¶å‘ç»Ÿè®¡å•è¯å‡ºç°æ¬¡æ•°</span><br><span class="line"></span><br><span class="line">- å…± 26 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹ä»ä¸åŒçš„æ–‡ä»¶ä¸­è¯»å–å•è¯ï¼›</span><br><span class="line">- æŠŠæ‰€æœ‰å•è¯ç»Ÿè®¡è¿›ä¸€ä¸ªå…±äº«çš„ `Map` ä¸­ï¼›</span><br><span class="line">- ä½¿ç”¨äº† `CountDownLatch` æ¥ç¡®ä¿ä¸»çº¿ç¨‹ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆå†è¾“å‡ºç»“æœã€‚</span><br><span class="line"></span><br><span class="line"><span class="symbol">*</span><span class="symbol">*</span>æ­å»ºç»ƒä¹ ç¯å¢ƒï¼š<span class="symbol">*</span><span class="symbol">*</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>public class Test {<br>
public static void main(String[] args){<br>
//åœ¨mainæ–¹æ³•ä¸­å®ç°ä¸¤ä¸ªæ¥å£<br>
}</p>
<pre><code>//å¼€å¯26ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨getæ–¹æ³•è·å–mapï¼Œä»å¯¹åº”çš„æ–‡ä»¶è¯»å–å•è¯å¹¶å­˜å‚¨åˆ°listä¸­ï¼Œæœ€åè°ƒç”¨acceptæ–¹æ³•è¿›è¡Œç»Ÿè®¡ã€‚
public static &lt;V&gt; void  calculate(Supplier&lt;Map&lt;String,V&gt;&gt; supplier, BiConsumer&lt;Map&lt;String,V&gt;, List&lt;String&gt;&gt; consumer) &#123;
    Map&lt;String, V&gt; map = supplier.get();
    CountDownLatch count = new CountDownLatch(26);
    for (int i = 1; i &lt; 27; i++) &#123;
        int k = i;
        new Thread(()-&gt;&#123;
            ArrayList&lt;String&gt; list = new ArrayList&lt;&gt;();
            read(list,k);
            consumer.accept(map,list);
            count.countDown();
        &#125;).start();
    &#125;
    try &#123;
        count.await();
    &#125; catch (InterruptedException e) &#123;
        e.printStackTrace();
    &#125;
    System.out.println(map.toString());
&#125;
//è¯»å•è¯æ–¹æ³•çš„å®ç°
public static void read(List&lt;String&gt; list,int i)&#123;
    try&#123;
        String element;
        BufferedReader reader = new BufferedReader(new FileReader(i + &quot;.txt&quot;));
        while((element = reader.readLine()) != null)&#123;
            list.add(element);
        &#125;
    &#125;catch (IOException e)&#123;

    &#125;
&#125;
//ç”Ÿæˆæµ‹è¯•æ•°æ®
public void construct()&#123;
    String str = &quot;abcdefghijklmnopqrstuvwxyz&quot;;
    ArrayList&lt;String&gt; list = new ArrayList&lt;&gt;();
    for (int i = 0; i &lt; str.length(); i++) &#123;
        for (int j = 0; j &lt; 200; j++) &#123;
            list.add(String.valueOf(str.charAt(i)));
        &#125;
    &#125;
    Collections.shuffle(list);
    for (int i = 0; i &lt; 26; i++) &#123;
        try (PrintWriter out = new PrintWriter(new FileWriter(i + 1 + &quot;.txt&quot;))) &#123;
            String collect = list.subList(i * 200, (i + 1) * 200).stream().collect(Collectors.joining(&quot;\n&quot;));
            out.println(collect);
        &#125; catch (IOException e) &#123;
            e.printStackTrace();
        &#125;
    &#125;
&#125;
</code></pre>
<p>}</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">##### å®ç°ä¸€ï¼š</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>demo(<br>
// åˆ›å»º map é›†åˆ<br>
// åˆ›å»º ConcurrentHashMap å¯¹ä¸å¯¹ï¼Ÿ<br>
() -&gt; new ConcurrentHashMap&lt;String, Integer&gt;(),<br>
// è¿›è¡Œè®¡æ•°<br>
(map, words) -&gt; {<br>
for (String word : words) {<br>
Integer counter = map.get(word);<br>
int newValue = counter == null ? 1 : counter + 1;<br>
map.put(word, newValue);<br>
}<br>
}<br>
);</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">è¾“å‡ºï¼š</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>{a=186, b=192, c=187, d=184, e=185, f=185, g=176, h=185, i=193, j=189, k=187, l=157, m=189, n=181, o=180, p=178, q=185, r=188, s=181, t=183, u=177, v=186, w=188, x=178, y=189, z=186}<br>
47</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">é”™è¯¯åŸå› ï¼š</span><br><span class="line"></span><br><span class="line">- ConcurrentHashMapè™½ç„¶æ¯ä¸ªæ–¹æ³•éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯å¤šä¸ªæ–¹æ³•çš„ç»„åˆå¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ï¼ˆä½ getåˆ°ä¸€ä¸ªå€¼è¿™ä¸ªæ—¶å€™è‚¯å®šæ˜¯åŸå­çš„ ä½†æ˜¯å¦å¤–ä¸€ä¸ªçº¿ç¨‹æ¥çš„æ—¶å€™æŠŠä»–æ”¹äº† ä½ åˆåœ¨getçš„è¿™ä¸ªå€¼ä¸Šæ“ä½œè¿™ä¸ªæ—¶å€™å°±æ˜¯æœ‰é—®é¢˜äº†ï¼‰</span><br><span class="line"></span><br><span class="line">![img](https:<span class="comment">//www.legendkiller.xyz/wp-content/uploads/2025/07/image-1709.png)</span></span><br><span class="line"></span><br><span class="line">##### æ­£ç¡®ç­”æ¡ˆä¸€ï¼š</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>demo(<br>
() -&gt; new ConcurrentHashMap&lt;String, LongAdder&gt;(),<br>
(map, words) -&gt; {<br>
for (String word : words) {<br>
// æ³¨æ„ä¸èƒ½ä½¿ç”¨ putIfAbsentï¼Œæ­¤æ–¹æ³•è¿”å›çš„æ˜¯ä¸Šä¸€æ¬¡çš„ valueï¼Œé¦–æ¬¡è°ƒç”¨è¿”å› null<br>
map.computeIfAbsent(word, (key) -&gt; new LongAdder()).increment();<br>
}<br>
}<br>
);</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">è¯´æ˜ï¼š</span><br><span class="line"></span><br><span class="line">- computIfAbsentæ–¹æ³•çš„ä½œç”¨æ˜¯ï¼šå½“<span class="built_in">map</span>ä¸­ä¸å­˜åœ¨ä»¥å‚æ•°<span class="number">1</span>ä¸º<span class="built_in">key</span>å¯¹åº”çš„valueæ—¶ï¼Œä¼šå°†å‚æ•°<span class="number">2</span>å‡½æ•°å¼æ¥å£çš„è¿”å›å€¼ä½œä¸ºvalueï¼Œ<span class="built_in">put</span>è¿›<span class="built_in">map</span>ä¸­ï¼Œç„¶åè¿”å›è¯¥valueã€‚å¦‚æœå­˜åœ¨<span class="built_in">key</span>ï¼Œåˆ™ç›´æ¥è¿”å›value</span><br><span class="line">- ä»¥ä¸Šä¸¤éƒ¨å‡æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-<span class="built_in">content</span>/uploads/<span class="number">2025</span>/<span class="number">07</span>/<span class="built_in">image</span>-<span class="number">1710.</span>png)</span><br><span class="line"></span><br><span class="line">##### æ­£ç¡®ç­”æ¡ˆäºŒï¼š</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>demo(<br>
() -&gt; new ConcurrentHashMap&lt;String, Integer&gt;(),<br>
(map, words) -&gt; {<br>
for (String word : words) {<br>
// å‡½æ•°å¼ç¼–ç¨‹ï¼Œæ— éœ€åŸå­å˜é‡<br>
map.merge(word, 1, Integer::sum);<br>
}<br>
}<br>
);</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1711.png</span>)</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1712.png</span>)</span><br><span class="line"></span><br><span class="line"><span class="section">#### JDK 7 HashMap å¹¶å‘æ­»é“¾</span></span><br><span class="line"></span><br><span class="line">åœ¨è®²ConcurrentHashMap åŸç†å‰ï¼Œé¦–å…ˆå…ˆè®²è®²HashMapï¼Œå› ä¸ºé¢è¯•çš„æ—¶å€™ç»å¸¸ä¼šé—®åˆ°hashmapè¿™ç§ä¸å®Œå…¨çš„å®ç°ï¼Œå®ƒéƒ½æœ‰é‚£äº›å¹¶å‘é—®é¢˜</span><br><span class="line"></span><br><span class="line">é—®é¢˜èƒŒæ™¯ï¼šHashMap å¹¶å‘æ­»é“¾</span><br><span class="line"></span><br><span class="line">åœºæ™¯ï¼š</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> å¤šçº¿ç¨‹åŒæ—¶æ“ä½œåŒä¸€ä¸ª <span class="code">`HashMap`</span>ï¼›</span><br><span class="line"><span class="bullet">-</span> åœ¨è§¦å‘ <span class="strong">**æ‰©å®¹ï¼ˆresizeï¼‰**</span> çš„è¿‡ç¨‹ä¸­ï¼›</span><br><span class="line"><span class="bullet">-</span> ç”±äºé“¾è¡¨æ¬è¿é¡ºåºä¸åŒï¼Œå¯èƒ½å¯¼è‡´é“¾è¡¨å½¢æˆ <span class="strong">**ç¯å½¢ç»“æ„ï¼ˆæ­»é“¾ï¼‰**</span>ï¼›</span><br><span class="line"><span class="bullet">-</span> æœ€ç»ˆï¼š<span class="code">`put()`</span> æ­»å¾ªç¯ã€CPU é£™å‡ï¼Œç¨‹åºå¡æ­»ã€‚</span><br><span class="line"></span><br><span class="line"><span class="section">##### æ­»é“¾å¤ç°æ­¥éª¤ï¼ˆåŸºäº JDK 7ï¼‰</span></span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1713.png</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>public static void main(String[] args) {<br>
// æµ‹è¯• java 7 ä¸­å“ªäº›æ•°å­—çš„ hash ç»“æœç›¸ç­‰<br>
System.out.println(â€œé•¿åº¦ä¸º16æ—¶ï¼Œæ¡¶ä¸‹æ ‡ä¸º1çš„keyâ€);<br>
for (int i = 0; i &lt; 64; i++) {<br>
if (hash(i) % 16 == 1) {<br>
System.out.println(i);<br>
}<br>
}<br>
System.out.println(â€œé•¿åº¦ä¸º32æ—¶ï¼Œæ¡¶ä¸‹æ ‡ä¸º1çš„keyâ€);<br>
for (int i = 0; i &lt; 64; i++) {<br>
if (hash(i) % 32 == 1) {<br>
System.out.println(i);<br>
}<br>
}<br>
// 1, 35, 16, 50 å½“å¤§å°ä¸º16æ—¶ï¼Œå®ƒä»¬åœ¨ä¸€ä¸ªæ¡¶å†…<br>
final HashMap&lt;Integer, Integer&gt; map = new HashMap&lt;Integer, Integer&gt;();<br>
// æ”¾ 12 ä¸ªå…ƒç´ <br>
map.put(2, null);<br>
map.put(3, null);<br>
map.put(4, null);<br>
map.put(5, null);<br>
map.put(6, null);<br>
map.put(7, null);<br>
map.put(8, null);<br>
map.put(9, null);<br>
map.put(10, null);<br>
map.put(16, null);<br>
map.put(35, null);<br>
map.put(1, null);<br>
System.out.println(â€œæ‰©å®¹å‰å¤§å°[main]:â€+map.size());<br>
new Thread() {<br>
@Override<br>
public void run() {<br>
// æ”¾ç¬¬ 13 ä¸ªå…ƒç´ , å‘ç”Ÿæ‰©å®¹<br>
map.put(50, null);<br>
System.out.println(â€œæ‰©å®¹åå¤§å°[Thread-0]:â€+map.size());<br>
}<br>
}.start();<br>
new Thread() {<br>
@Override<br>
public void run() {<br>
// æ”¾ç¬¬ 13 ä¸ªå…ƒç´ , å‘ç”Ÿæ‰©å®¹<br>
map.put(50, null);<br>
System.out.println(â€œæ‰©å®¹åå¤§å°[Thread-1]:â€+map.size());<br>
}<br>
}.start();<br>
}<br>
final static int hash(Object k) {<br>
int h = 0;<br>
if (0 != h &amp;&amp; k instanceof String) {<br>
return sun.misc.Hashing.stringHash32((String) k);<br>
}<br>
h ^= k.hashCode();<br>
h ^= (h &gt;&gt;&gt; 20) ^ (h &gt;&gt;&gt; 12);<br>
return h ^ (h &gt;&gt;&gt; 7) ^ (h &gt;&gt;&gt; 4);<br>
}</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](https:<span class="comment">//www.legendkiller.xyz/wp-content/uploads/2025/07/image-1716.png)</span></span><br><span class="line"></span><br><span class="line">##### æ­»é“¾å¤ç°</span><br><span class="line"></span><br><span class="line">è°ƒè¯•å·¥å…·ä½¿ç”¨ idea</span><br><span class="line"></span><br><span class="line">åœ¨ HashMap æºç  <span class="number">590</span> è¡ŒåŠ æ–­ç‚¹</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>int newCapacity = newTable.length;</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">æ–­ç‚¹çš„æ¡ä»¶å¦‚ä¸‹ï¼Œç›®çš„æ˜¯è®© HashMap åœ¨æ‰©å®¹ä¸º <span class="number">32</span> æ—¶ï¼Œå¹¶ä¸”çº¿ç¨‹ä¸º <span class="keyword">Thread</span>-<span class="number">0</span> æˆ– <span class="keyword">Thread</span>-<span class="number">1</span> æ—¶åœä¸‹æ¥</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>newTable.length==32 &amp;&amp;<br>
(<br>
Thread.currentThread().getName().equals(â€œThread-0â€)||<br>
Thread.currentThread().getName().equals(â€œThread-1â€)<br>
)</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">æ–­ç‚¹æš‚åœæ–¹å¼é€‰æ‹© <span class="keyword">Thread</span>ï¼Œå¦åˆ™åœ¨è°ƒè¯• <span class="keyword">Thread</span>-<span class="number">0</span> æ—¶ï¼Œ<span class="keyword">Thread</span>-<span class="number">1</span> æ— æ³•æ¢å¤è¿è¡Œ</span><br><span class="line"></span><br><span class="line">è¿è¡Œä»£ç ï¼Œç¨‹åºåœ¨é¢„æ–™çš„æ–­ç‚¹ä½ç½®åœäº†ä¸‹æ¥ï¼Œè¾“å‡º</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>é•¿åº¦ä¸º16æ—¶ï¼Œæ¡¶ä¸‹æ ‡ä¸º1çš„key<br>
1<br>
16<br>
35<br>
50<br>
é•¿åº¦ä¸º32æ—¶ï¼Œæ¡¶ä¸‹æ ‡ä¸º1çš„key<br>
1<br>
35<br>
æ‰©å®¹å‰å¤§å°[main]:12</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">æ¥ä¸‹æ¥è¿›å…¥æ‰©å®¹æµç¨‹è°ƒè¯•</span><br><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">07</span>/image-<span class="number">1717</span>.png)</span><br><span class="line"></span><br><span class="line">åœ¨ HashMap æºç  <span class="number">594</span> è¡ŒåŠ æ–­ç‚¹</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Entry&lt;K,V&gt; next = e.next; // 593<br>
if (rehash) // 594<br>
// â€¦</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">è¿™æ˜¯ä¸ºäº†è§‚å¯Ÿ e èŠ‚ç‚¹å’Œ <span class="keyword">next</span> èŠ‚ç‚¹çš„çŠ¶æ€ï¼ŒThread-<span class="number">0</span> å•æ­¥æ‰§è¡Œåˆ° <span class="number">594</span> è¡Œï¼Œå† <span class="number">594</span> å¤„å†æ·»åŠ ä¸€ä¸ªæ–­ç‚¹ï¼ˆæ¡ä»¶ Thread.currentThread().getName().<span class="keyword">equals</span>(<span class="string">&quot;Thread-0&quot;</span>)ï¼‰</span><br><span class="line"></span><br><span class="line">è¿™æ—¶å¯ä»¥åœ¨ Variables é¢æ¿è§‚å¯Ÿåˆ° e å’Œ <span class="keyword">next</span> å˜é‡ï¼Œä½¿ç”¨`view <span class="keyword">as</span> -&gt; <span class="type">Object</span>`æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>e (1)-&gt;(35)-&gt;(16)-&gt;null<br>
next (35)-&gt;(16)-&gt;null</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">åœ¨ Threads é¢æ¿é€‰ä¸­ <span class="keyword">Thread</span>-<span class="number">1</span> æ¢å¤è¿è¡Œï¼Œå¯ä»¥çœ‹åˆ°æ§åˆ¶å°è¾“å‡ºæ–°çš„å†…å®¹å¦‚ä¸‹ï¼Œ<span class="keyword">Thread</span>-<span class="number">1</span> æ‰©å®¹å·²å®Œæˆ</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>newTable[1] (35)-&gt;(1)-&gt;null<br>
æ‰©å®¹åå¤§å°:13</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">è¿™æ—¶ <span class="built_in">Thread</span><span class="operator">-</span><span class="number">0</span> è¿˜åœåœ¨ <span class="number">594</span> å¤„ï¼Œ <span class="built_in">Variables</span> é¢æ¿å˜é‡çš„çŠ¶æ€å·²ç»å˜åŒ–ä¸º</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>e (1)-&gt;null<br>
next (35)-&gt;(1)-&gt;null</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ä¸ºä»€ä¹ˆå‘¢ï¼Œå› ä¸º <span class="keyword">Thread</span>-<span class="number">1</span> æ‰©å®¹æ—¶é“¾è¡¨ä¹Ÿæ˜¯ååŠ å…¥çš„å…ƒç´ æ”¾å…¥é“¾è¡¨å¤´ï¼Œå› æ­¤é“¾è¡¨å°±å€’è¿‡æ¥äº†ï¼Œä½† <span class="keyword">Thread</span>-<span class="number">1</span> è™½ç„¶ç»“ æœæ­£ç¡®ï¼Œä½†å®ƒç»“æŸå <span class="keyword">Thread</span>-<span class="number">0</span> è¿˜è¦ç»§ç»­è¿è¡Œ</span><br><span class="line"></span><br><span class="line">æ¥ä¸‹æ¥å°±å¯ä»¥å•æ­¥è°ƒè¯•ï¼ˆF8ï¼‰è§‚å¯Ÿæ­»é“¾çš„äº§ç”Ÿäº†</span><br><span class="line"></span><br><span class="line">ä¸‹ä¸€è½®å¾ªç¯åˆ° <span class="number">594</span>ï¼Œå°† e æ¬è¿åˆ° newTable é“¾è¡¨å¤´</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>newTable[1] (1)-&gt;null<br>
e (35)-&gt;(1)-&gt;null<br>
next (1)-&gt;null</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ä¸‹ä¸€è½®å¾ªç¯åˆ° 594ï¼Œå°† e æ¬è¿åˆ° newTable é“¾è¡¨å¤´</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>newTable[1] (35)-&gt;(1)-&gt;null<br>
e (1)-&gt;null<br>
next null</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">07</span>/image-<span class="number">1718</span>.png)</span><br><span class="line"></span><br><span class="line">å†çœ‹çœ‹æºç </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>e.next = newTable[1];<br>
// è¿™æ—¶ e (1,35)<br>
// è€Œ newTable[1] (35,1)-&gt;(1,35) å› ä¸ºæ˜¯åŒä¸€ä¸ªå¯¹è±¡<br>
newTable[1] = e;<br>
// å†å°è¯•å°† e ä½œä¸ºé“¾è¡¨å¤´, æ­»é“¾å·²æˆ<br>
e = next;<br>
// è™½ç„¶ next æ˜¯ null, ä¼šè¿›å…¥ä¸‹ä¸€ä¸ªé“¾è¡¨çš„å¤åˆ¶, ä½†æ­»é“¾å·²ç»å½¢æˆäº†</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">##### æ­»é“¾å½¢æˆæ¨¡æ‹Ÿè¿‡ç¨‹</span></span><br><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">07</span>/image-<span class="number">1722</span>.png)</span><br><span class="line"></span><br><span class="line">æ¨¡æ‹Ÿä¸¤ä¸ªçº¿ç¨‹ Thread-<span class="number">0</span> å’Œ Thread-<span class="number">1</span> çš„äº¤æ›¿è¿‡ç¨‹</span><br><span class="line"></span><br><span class="line">æˆ‘ä»¬ä»¥â€œæ–­ç‚¹â€æ–¹å¼æè¿°ï¼š</span><br><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">07</span>/image-<span class="number">1723</span>.png)</span><br><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">07</span>/image-<span class="number">1724</span>.png)</span><br><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">07</span>/image-<span class="number">1725</span>.png)</span><br><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">07</span>/image-<span class="number">1726</span>.png)</span><br><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">07</span>/image-<span class="number">1727</span>.png)</span><br><span class="line"></span><br><span class="line"><span class="comment">##### **æºç åˆ†æ**</span></span><br><span class="line"></span><br><span class="line">HashMap çš„å¹¶å‘æ­»é“¾å‘ç”Ÿåœ¨æ‰©å®¹æ—¶</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>// å°† table è¿ç§»è‡³ newTable<br>
void transfer(Entry[] newTable, boolean rehash) {<br>
int newCapacity = newTable.length;<br>
for (Entry&lt;K,V&gt; e : table) {<br>
while(null != e) {<br>
Entry&lt;K,V&gt; next = e.next;<br>
// 1 å¤„<br>
if (rehash) {<br>
e.hash = null == e.key ? 0 : hash(e.key);<br>
}<br>
int i = indexFor(e.hash, newCapacity);<br>
// 2 å¤„<br>
// å°†æ–°å…ƒç´ åŠ å…¥ newTable[i], åŸ newTable[i] ä½œä¸ºæ–°å…ƒç´ çš„ next<br>
e.next = newTable[i];<br>
newTable[i] = e;<br>
e = next;<br>
}<br>
}<br>
}</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">å‡è®¾ <span class="built_in">map</span> ä¸­åˆå§‹å…ƒç´ æ˜¯</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>åŸå§‹é“¾è¡¨ï¼Œæ ¼å¼ï¼š[ä¸‹æ ‡] (key,next)<br>
[1] (1,35)-&gt;(35,16)-&gt;(16,null)<br>
çº¿ç¨‹ a æ‰§è¡Œåˆ° 1 å¤„ ï¼Œæ­¤æ—¶å±€éƒ¨å˜é‡ e ä¸º (1,35)ï¼Œè€Œå±€éƒ¨å˜é‡ next ä¸º (35,16) çº¿ç¨‹ a æŒ‚èµ·<br>
çº¿ç¨‹ b å¼€å§‹æ‰§è¡Œ<br>
ç¬¬ä¸€æ¬¡å¾ªç¯<br>
[1] (1,null)<br>
ç¬¬äºŒæ¬¡å¾ªç¯<br>
[1] (35,1)-&gt;(1,null)<br>
ç¬¬ä¸‰æ¬¡å¾ªç¯<br>
[1] (35,1)-&gt;(1,null)<br>
[17] (16,null)<br>
åˆ‡æ¢å›çº¿ç¨‹ aï¼Œæ­¤æ—¶å±€éƒ¨å˜é‡ e å’Œ next è¢«æ¢å¤ï¼Œå¼•ç”¨æ²¡å˜ä½†å†…å®¹å˜äº†ï¼še çš„å†…å®¹è¢«æ”¹ä¸º (1,null)ï¼Œè€Œ next çš„å†…<br>
å®¹è¢«æ”¹ä¸º (35,1) å¹¶é“¾å‘ (1,null)<br>
ç¬¬ä¸€æ¬¡å¾ªç¯<br>
[1] (1,null)<br>
ç¬¬äºŒæ¬¡å¾ªç¯ï¼Œæ³¨æ„è¿™æ—¶ e æ˜¯ (35,1) å¹¶é“¾å‘ (1,null) æ‰€ä»¥ next åˆæ˜¯ (1,null)<br>
[1] (35,1)-&gt;(1,null)<br>
ç¬¬ä¸‰æ¬¡å¾ªç¯ï¼Œe æ˜¯ (1,null)ï¼Œè€Œ next æ˜¯ nullï¼Œä½† e è¢«æ”¾å…¥é“¾è¡¨å¤´ï¼Œè¿™æ · e.next å˜æˆäº† 35 ï¼ˆ2 å¤„ï¼‰<br>
[1] (1,35)-&gt;(35,1)-&gt;(1,35)<br>
å·²ç»æ˜¯æ­»é“¾äº†</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**å°ç»“**</span><br><span class="line"></span><br><span class="line">- ç©¶å…¶åŸå› ï¼Œæ˜¯å› ä¸ºåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä½¿ç”¨äº†éçº¿ç¨‹å®‰å…¨çš„ map é›†åˆ</span><br><span class="line">- JDK <span class="number">8</span> è™½ç„¶å°†æ‰©å®¹ç®—æ³•åšäº†è°ƒæ•´ï¼Œä¸å†å°†å…ƒç´ åŠ å…¥é“¾è¡¨å¤´ï¼ˆè€Œæ˜¯ä¿æŒä¸æ‰©å®¹å‰ä¸€æ ·çš„é¡ºåºï¼‰ï¼Œä½†ä»ä¸æ„å‘³ç€èƒ½ å¤Ÿåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹èƒ½å¤Ÿå®‰å…¨æ‰©å®¹ï¼Œè¿˜ä¼šå‡ºç°å…¶å®ƒé—®é¢˜ï¼ˆå¦‚æ‰©å®¹ä¸¢æ•°æ®ï¼‰</span><br><span class="line"></span><br><span class="line">![img](https:<span class="comment">//www.legendkiller.xyz/wp-content/uploads/2025/07/image-1719.png)</span></span><br><span class="line"></span><br><span class="line">![img](https:<span class="comment">//www.legendkiller.xyz/wp-content/uploads/2025/07/image-1720.png)</span></span><br><span class="line"></span><br><span class="line">![img](https:<span class="comment">//www.legendkiller.xyz/wp-content/uploads/2025/07/image-1721.png)</span></span><br><span class="line"></span><br><span class="line">#### JDK <span class="number">8</span> ConcurrentHashMapåŸç†</span><br><span class="line"></span><br><span class="line">##### é‡è¦å±æ€§å’Œå†…éƒ¨ç±»</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>// é»˜è®¤ä¸º 0<br>
// å½“åˆå§‹åŒ–æ—¶, ä¸º -1<br>
// å½“æ‰©å®¹æ—¶, ä¸º -(1 + æ‰©å®¹çº¿ç¨‹æ•°)<br>
// å½“åˆå§‹åŒ–æˆ–æ‰©å®¹å®Œæˆåï¼Œä¸º ä¸‹ä¸€æ¬¡çš„æ‰©å®¹çš„é˜ˆå€¼å¤§å°<br>
private transient volatile int sizeCtl;<br>
// æ•´ä¸ª ConcurrentHashMap å°±æ˜¯ä¸€ä¸ª Node[]<br>
static class Node&lt;K,V&gt; implements Map.Entry&lt;K,V&gt; {}<br>
// hash è¡¨<br>
transient volatile Node&lt;K,V&gt;[] table;<br>
// æ‰©å®¹æ—¶çš„ æ–° hash è¡¨<br>
private transient volatile Node&lt;K,V&gt;[] nextTable;<br>
// æ‰©å®¹æ—¶å¦‚æœæŸä¸ª bin è¿ç§»å®Œæ¯•, ç”¨ ForwardingNode ä½œä¸ºæ—§ table bin çš„å¤´ç»“ç‚¹<br>
static final class ForwardingNode&lt;K,V&gt; extends Node&lt;K,V&gt; {}<br>
// ç”¨åœ¨ compute ä»¥åŠ computeIfAbsent æ—¶, ç”¨æ¥å ä½, è®¡ç®—å®Œæˆåæ›¿æ¢ä¸ºæ™®é€š Node<br>
static final class ReservationNode&lt;K,V&gt; extends Node&lt;K,V&gt; {}<br>
// ä½œä¸º treebin çš„å¤´èŠ‚ç‚¹, å­˜å‚¨ root å’Œ first<br>
static final class TreeBin&lt;K,V&gt; extends Node&lt;K,V&gt; {}<br>
// ä½œä¸º treebin çš„èŠ‚ç‚¹, å­˜å‚¨ parent, left, right<br>
static final class TreeNode&lt;K,V&gt; extends Node&lt;K,V&gt; {}</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](https:<span class="comment">//www.legendkiller.xyz/wp-content/uploads/2025/07/image-1729.png)</span></span><br><span class="line"></span><br><span class="line">##### é‡è¦æ–¹æ³•</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>// è·å– Node[] ä¸­ç¬¬ i ä¸ª Node<br>
static final &lt;K,V&gt; Node&lt;K,V&gt; tabAt(Node&lt;K,V&gt;[] tab, int i)</p>
<p>// cas ä¿®æ”¹ Node[] ä¸­ç¬¬ i ä¸ª Node çš„å€¼, c ä¸ºæ—§å€¼, v ä¸ºæ–°å€¼<br>
static final &lt;K,V&gt; boolean casTabAt(Node&lt;K,V&gt;[] tab, int i, Node&lt;K,V&gt; c, Node&lt;K,V&gt; v)</p>
<p>// ç›´æ¥ä¿®æ”¹ Node[] ä¸­ç¬¬ i ä¸ª Node çš„å€¼, v ä¸ºæ–°å€¼<br>
static final &lt;K,V&gt; void setTabAt(Node&lt;K,V&gt;[] tab, int i, Node&lt;K,V&gt; v)</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">##### æ„é€ å™¨åˆ†æ</span><br><span class="line"></span><br><span class="line">initialCapacityåˆå§‹å®¹é‡ï¼Œfloat loadFactorè´Ÿè½½å› å­ï¼ŒconcurrencyLevelå¹¶å‘åº¦</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>public ConcurrentHashMap(int initialCapacity, float loadFactor, int concurrencyLevel) {<br>
if (!(loadFactor &gt; 0.0f) || initialCapacity &lt; 0 || concurrencyLevel &lt;= 0)<br>
throw new IllegalArgumentException();<br>
if (initialCapacity &lt; concurrencyLevel) // Use at least as many bins<br>
initialCapacity = concurrencyLevel; // as estimated threads<br>
long size = (long)(1.0 + (long)initialCapacity / loadFactor);<br>
// tableSizeFor ä»ç„¶æ˜¯ä¿è¯è®¡ç®—çš„å¤§å°æ˜¯ 2^n, å³ 16,32,64 â€¦<br>
int cap = (size &gt;= (long)MAXIMUM_CAPACITY) ?<br>
MAXIMUM_CAPACITY : tableSizeFor((int)size);<br>
this.sizeCtl = cap;<br>
}</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">åˆå§‹å®¹é‡å°äºå¹¶å‘åº¦çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠåˆå§‹å®¹é‡æ”¹æˆå¹¶å‘åº¦ï¼Œæœ€å°‘è¦ä¿è¯å¹¶å‘åº¦è¿™ä¹ˆå¤§</span><br><span class="line"></span><br><span class="line">è®¡ç®—å¤§å°çš„æ—¶å€™ï¼Œjdk8ConcurrentHashMapå®ç°äº†æ‡’æƒ°åˆå§‹åŒ–ï¼Œtableä¸æ˜¯ä¸€ä¸Šæ¥å°±æŠŠæ•°å­—åˆ›å»ºå‡ºæ¥ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­ä»…ä»…è®¡ç®—äº†ä¸‹ä¸€æ¬¡tableå®¹é‡çš„å¤§å°ï¼Œä»¥ååœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶æ‰ä¼šçœŸæ­£åˆ›å»ºï¼ˆåŒºåˆ«äºjdk7ï¼‰</span><br><span class="line"></span><br><span class="line">tableSizeForä¿è¯è®¡ç®—å‡ºæ¥çš„å¤§å°æ˜¯<span class="number">2</span>çš„næ¬¡æ–¹</span><br><span class="line"></span><br><span class="line">##### getæµç¨‹ï¼ˆæ— é”ï¼‰</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>public V get(Object key) {<br>
Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; int n, eh; K ek;<br>
// spread æ–¹æ³•èƒ½ç¡®ä¿è¿”å›ç»“æœæ˜¯æ­£æ•°<br>
int h = spread(key.hashCode());<br>
if ((tab = table) != null &amp;&amp; (n = tab.length) &gt; 0 &amp;&amp;<br>
(e = tabAt(tab, (n - 1) &amp; h)) != null) {<br>
// å¦‚æœå¤´ç»“ç‚¹å·²ç»æ˜¯è¦æŸ¥æ‰¾çš„ key<br>
if ((eh = e.hash) == h) {<br>
if ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))<br>
return e.val;<br>
}<br>
// hash ä¸ºè´Ÿæ•°è¡¨ç¤ºè¯¥ bin åœ¨æ‰©å®¹ä¸­æˆ–æ˜¯ treebin, è¿™æ—¶è°ƒç”¨ find æ–¹æ³•æ¥æŸ¥æ‰¾<br>
else if (eh &lt; 0)<br>
return (p = e.find(h, key)) != null ? p.val : null;<br>
// æ­£å¸¸éå†é“¾è¡¨, ç”¨ equals æ¯”è¾ƒ<br>
while ((e = e.next) != null) {<br>
if (e.hash == h &amp;&amp;<br>
((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek))))<br>
return e.val;<br>
}<br>
}<br>
return null;<br>
}</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">æ€»ç»“ï¼š</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> å¦‚æœtableä¸ä¸ºç©ºä¸”é•¿åº¦å¤§äº0ä¸”ç´¢å¼•ä½ç½®æœ‰å…ƒç´ </span><br><span class="line"><span class="bullet">-</span> if å¤´èŠ‚ç‚¹keyçš„hashå€¼ç›¸ç­‰</span><br><span class="line"><span class="bullet">  -</span> å¤´èŠ‚ç‚¹çš„keyæŒ‡å‘åŒä¸€ä¸ªåœ°å€æˆ–è€…equals</span><br><span class="line"><span class="bullet">  -</span> è¿”å›value</span><br><span class="line"><span class="bullet">-</span> else if å¤´èŠ‚ç‚¹çš„hashä¸ºè´Ÿæ•°ï¼ˆbinåœ¨æ‰©å®¹æˆ–è€…æ˜¯treebinï¼‰</span><br><span class="line"><span class="bullet">  -</span> è°ƒç”¨findæ–¹æ³•æŸ¥æ‰¾</span><br><span class="line"><span class="bullet">-</span> è¿›å…¥å¾ªç¯ï¼ˆeä¸ä¸ºç©ºï¼‰ï¼š</span><br><span class="line"><span class="bullet">  -</span> èŠ‚ç‚¹keyçš„hashå€¼ç›¸ç­‰ï¼Œä¸”keyæŒ‡å‘åŒä¸€ä¸ªåœ°å€æˆ–equals</span><br><span class="line"><span class="bullet">  -</span> è¿”å›value</span><br><span class="line"><span class="bullet">-</span> è¿”å›null</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1730.png</span>)</span><br><span class="line"></span><br><span class="line"><span class="section">##### put æµç¨‹</span></span><br><span class="line"></span><br><span class="line">ä»¥ä¸‹æ•°ç»„ç®€ç§°ï¼ˆtableï¼‰ï¼Œé“¾è¡¨ç®€ç§°ï¼ˆbinï¼‰</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>public V put(K key, V value) {<br>
return putVal(key, value, false);<br>
}<br>
final V putVal(K key, V value, boolean onlyIfAbsent) {<br>
if (key == null || value == null) throw new NullPointerException();<br>
// å…¶ä¸­ spread æ–¹æ³•ä¼šç»¼åˆé«˜ä½ä½ä½, å…·æœ‰æ›´å¥½çš„ hash æ€§<br>
int hash = spread(key.hashCode());<br>
int binCount = 0;<br>
for (Node&lt;K,V&gt;[] tab = table;;) {<br>
// f æ˜¯é“¾è¡¨å¤´èŠ‚ç‚¹<br>
// fh æ˜¯é“¾è¡¨å¤´ç»“ç‚¹çš„ hash<br>
// i æ˜¯é“¾è¡¨åœ¨ table ä¸­çš„ä¸‹æ ‡<br>
Node&lt;K,V&gt; f; int n, i, fh;<br>
// è¦åˆ›å»º table<br>
if (tab == null || (n = tab.length) == 0)<br>
// åˆå§‹åŒ– table ä½¿ç”¨äº† cas, æ— éœ€ synchronized åˆ›å»ºæˆåŠŸ, è¿›å…¥ä¸‹ä¸€è½®å¾ªç¯<br>
tab = initTable();<br>
// è¦åˆ›å»ºé“¾è¡¨å¤´èŠ‚ç‚¹<br>
else if ((f = tabAt(tab, i = (n - 1) &amp; hash)) == null) {<br>
// æ·»åŠ é“¾è¡¨å¤´ä½¿ç”¨äº† cas, æ— éœ€ synchronized<br>
if (casTabAt(tab, i, null,<br>
new Node&lt;K,V&gt;(hash, key, value, null)))<br>
break;<br>
}<br>
// å¸®å¿™æ‰©å®¹<br>
else if ((fh = f.hash) == MOVED)<br>
// å¸®å¿™ä¹‹å, è¿›å…¥ä¸‹ä¸€è½®å¾ªç¯<br>
tab = helpTransfer(tab, f);<br>
else {<br>
V oldVal = null;<br>
// é”ä½é“¾è¡¨å¤´èŠ‚ç‚¹<br>
synchronized (f) {<br>
// å†æ¬¡ç¡®è®¤é“¾è¡¨å¤´èŠ‚ç‚¹æ²¡æœ‰è¢«ç§»åŠ¨<br>
if (tabAt(tab, i) == f) {<br>
// é“¾è¡¨<br>
if (fh &gt;= 0) {<br>
binCount = 1;<br>
// éå†é“¾è¡¨<br>
for (Node&lt;K,V&gt; e = f;; ++binCount) {<br>
K ek;<br>
// æ‰¾åˆ°ç›¸åŒçš„ key<br>
if (e.hash == hash &amp;&amp;<br>
((ek = e.key) == key ||<br>
(ek != null &amp;&amp; key.equals(ek)))) {<br>
oldVal = e.val;<br>
// æ›´æ–°<br>
if (!onlyIfAbsent)<br>
e.val = value;<br>
break;<br>
}<br>
Node&lt;K,V&gt; pred = e;<br>
// å·²ç»æ˜¯æœ€åçš„èŠ‚ç‚¹äº†, æ–°å¢ Node, è¿½åŠ è‡³é“¾è¡¨å°¾<br>
if ((e = e.next) == null) {<br>
pred.next = new Node&lt;K,V&gt;(hash, key,<br>
value, null);<br>
break;<br>
}<br>
}<br>
}<br>
// çº¢é»‘æ ‘<br>
else if (f instanceof TreeBin) {<br>
Node&lt;K,V&gt; p;<br>
binCount = 2;<br>
// putTreeVal ä¼šçœ‹ key æ˜¯å¦å·²ç»åœ¨æ ‘ä¸­, æ˜¯, åˆ™è¿”å›å¯¹åº”çš„ TreeNode<br>
if ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,<br>
value)) != null) {<br>
oldVal = p.val;<br>
if (!onlyIfAbsent)<br>
p.val = value;<br>
}<br>
}<br>
}<br>
// é‡Šæ”¾é“¾è¡¨å¤´èŠ‚ç‚¹çš„é”<br>
}</p>
<pre><code>        if (binCount != 0) &#123; 
            if (binCount &gt;= TREEIFY_THRESHOLD)
                // å¦‚æœé“¾è¡¨é•¿åº¦ &gt;= æ ‘åŒ–é˜ˆå€¼(8), è¿›è¡Œé“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘
                treeifyBin(tab, i);
            if (oldVal != null)
                return oldVal;
            break;
        &#125;
    &#125;
&#125;
// å¢åŠ  size è®¡æ•°
addCount(1L, binCount);
return null;
</code></pre>
<p>}<br>
private final Node&lt;K,V&gt;[] initTable() {<br>
Node&lt;K,V&gt;[] tab; int sc;<br>
while ((tab = table) == null || tab.length == 0) {<br>
if ((sc = sizeCtl) &lt; 0)<br>
Thread.yield();<br>
// å°è¯•å°† sizeCtl è®¾ç½®ä¸º -1ï¼ˆè¡¨ç¤ºåˆå§‹åŒ– tableï¼‰<br>
else if (U.compareAndSwapInt(this, SIZECTL, sc, -1)) {<br>
// è·å¾—é”, åˆ›å»º table, è¿™æ—¶å…¶å®ƒçº¿ç¨‹ä¼šåœ¨ while() å¾ªç¯ä¸­ yield ç›´è‡³ table åˆ›å»º<br>
try {<br>
if ((tab = table) == null || tab.length == 0) {<br>
int n = (sc &gt; 0) ? sc : DEFAULT_CAPACITY;<br>
Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node<?,?>[n];<br>
table = tab = nt;<br>
sc = n - (n &gt;&gt;&gt; 2);<br>
}<br>
} finally {<br>
sizeCtl = sc;<br>
}<br>
break;<br>
}<br>
}<br>
return tab;<br>
}<br>
// check æ˜¯ä¹‹å‰ binCount çš„ä¸ªæ•°<br>
private final void addCount(long x, int check) {<br>
CounterCell[] as; long b, s;<br>
if (<br>
// å·²ç»æœ‰äº† counterCells, å‘ cell ç´¯åŠ <br>
(as = counterCells) != null ||<br>
// è¿˜æ²¡æœ‰, å‘ baseCount ç´¯åŠ <br>
!U.compareAndSwapLong(this, BASECOUNT, b = baseCount, s = b + x)<br>
) {<br>
CounterCell a; long v; int m;<br>
boolean uncontended = true;<br>
if (<br>
// è¿˜æ²¡æœ‰ counterCells<br>
as == null || (m = as.length - 1) &lt; 0 ||<br>
// è¿˜æ²¡æœ‰ cell<br>
(a = as[ThreadLocalRandom.getProbe() &amp; m]) == null ||<br>
// cell cas å¢åŠ è®¡æ•°å¤±è´¥<br>
!(uncontended = U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))<br>
) {<br>
// åˆ›å»ºç´¯åŠ å•å…ƒæ•°ç»„å’Œcell, ç´¯åŠ é‡è¯•<br>
fullAddCount(x, uncontended);<br>
return;<br>
}<br>
if (check &lt;= 1)<br>
return;<br>
// è·å–å…ƒç´ ä¸ªæ•°<br>
s = sumCount();<br>
}<br>
if (check &gt;= 0) {<br>
Node&lt;K,V&gt;[] tab, nt; int n, sc;<br>
while (s &gt;= (long)(sc = sizeCtl) &amp;&amp; (tab = table) != null &amp;&amp;<br>
(n = tab.length) &lt; MAXIMUM_CAPACITY) {<br>
int rs = resizeStamp(n);<br>
if (sc &lt; 0) {<br>
if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 ||<br>
sc == rs + MAX_RESIZERS || (nt = nextTable) == null ||<br>
transferIndex &lt;= 0)<br>
break;<br>
// newtable å·²ç»åˆ›å»ºäº†ï¼Œå¸®å¿™æ‰©å®¹<br>
if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1))<br>
transfer(tab, nt);<br>
}<br>
// éœ€è¦æ‰©å®¹ï¼Œè¿™æ—¶ newtable æœªåˆ›å»º<br>
else if (U.compareAndSwapInt(this, SIZECTL, sc,<br>
(rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2))<br>
transfer(tab, null);<br>
s = sumCount();<br>
}<br>
}<br>
}</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1731.png</span>)</span><br><span class="line"></span><br><span class="line">æ€»ç»“ï¼š</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> è¿›å…¥forå¾ªç¯ï¼š</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> if tableä¸ºnullæˆ–è€…é•¿åº¦ ä¸º0</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> åˆå§‹åŒ–è¡¨</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> else if ç´¢å¼•å¤„æ— èŠ‚ç‚¹</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> åˆ›å»ºèŠ‚ç‚¹ï¼Œå¡«å…¥keyå’Œvalueï¼Œæ”¾å…¥tableï¼Œé€€å‡ºå¾ªç¯</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> else if ç´¢å¼•å¤„èŠ‚ç‚¹çš„hashå€¼ä¸ºMOVEï¼ˆForwardingNodeï¼‰ï¼Œè¡¨ç¤ºæ­£åœ¨æ‰©å®¹å’Œè¿ç§»</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> å¸®å¿™</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> else</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> é”ä½å¤´èŠ‚ç‚¹</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> if å†æ¬¡ç¡®è®¤å¤´èŠ‚ç‚¹æ²¡æœ‰è¢«ç§»åŠ¨</span><br><span class="line"></span><br><span class="line"><span class="bullet">    -</span> if å¤´èŠ‚ç‚¹hashå€¼å¤§äº0ï¼ˆè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼‰</span><br><span class="line"></span><br><span class="line"><span class="bullet">    -</span> éå†é“¾è¡¨æ‰¾åˆ°å¯¹åº”keyï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºã€‚</span><br><span class="line"></span><br><span class="line"><span class="bullet">    -</span> else if èŠ‚ç‚¹ä¸ºçº¢é»‘æ ‘èŠ‚ç‚¹</span><br><span class="line"></span><br><span class="line"><span class="bullet">    -</span> è°ƒç”¨</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<pre><code>  putTreeVal
  <figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="code">      æŸ¥çœ‹æ˜¯å¦æœ‰å¯¹åº”keyçš„æ•°èŠ‚ç‚¹</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="bullet">      -</span> å¦‚æœæœ‰ä¸”ä¸ºè¦†ç›–æ¨¡å¼ï¼Œå°†å€¼è¦†ç›–ï¼Œè¿”å›æ—§å€¼</span><br><span class="line"><span class="bullet">      -</span> å¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºå¹¶æ’å…¥ï¼Œè¿”å›null</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> è§£é”</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> if binCountä¸ä¸º0</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> å¦‚æœbinCountå¤§äºæ ‘åŒ–é˜ˆå€¼8</span><br><span class="line"></span><br><span class="line"><span class="bullet">    -</span> æ ‘åŒ–</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> å¦‚æœæ—§å€¼ä¸ä¸ºnull</span><br><span class="line"></span><br><span class="line"><span class="bullet">    -</span> è¿”å›æ—§å€¼</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> break</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> å¢åŠ sizeè®¡æ•°</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> return null</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1733.png</span>)</span><br><span class="line"></span><br><span class="line"><span class="section">##### size è®¡ç®—æµç¨‹</span></span><br><span class="line"></span><br><span class="line">size è®¡ç®—å®é™…å‘ç”Ÿåœ¨ putï¼Œremove æ”¹å˜é›†åˆå…ƒç´ çš„æ“ä½œä¹‹ä¸­</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> æ²¡æœ‰ç«äº‰å‘ç”Ÿï¼Œå‘ baseCount ç´¯åŠ è®¡æ•°</span><br><span class="line"><span class="bullet">-</span> æœ‰ç«äº‰å‘ç”Ÿï¼Œæ–°å»º counterCellsï¼Œå‘å…¶ä¸­çš„ä¸€ä¸ª cell ç´¯åŠ è®¡</span><br><span class="line"><span class="bullet">-</span> counterCells åˆå§‹æœ‰ä¸¤ä¸ª cell</span><br><span class="line"><span class="bullet">-</span> å¦‚æœè®¡æ•°ç«äº‰æ¯”è¾ƒæ¿€çƒˆï¼Œä¼šåˆ›å»ºæ–°çš„ cell æ¥ç´¯åŠ è®¡æ•°</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</code></pre>
<p>public int size() {<br>
long n = sumCount();<br>
return ((n &lt; 0L) ? 0 :<br>
(n &gt; (long)Integer.MAX_VALUE) ? Integer.MAX_VALUE :<br>
(int)n);<br>
}<br>
final long sumCount() {<br>
CounterCell[] as = counterCells; CounterCell a;<br>
// å°† baseCount è®¡æ•°ä¸æ‰€æœ‰ cell è®¡æ•°ç´¯åŠ <br>
long sum = baseCount;<br>
if (as != null) {<br>
for (int i = 0; i &lt; as.length; ++i) {<br>
if ((a = as[i]) != null)<br>
sum += a.value;<br>
}<br>
}<br>
return sum;<br>
}</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1732.png)</span><br><span class="line"></span><br><span class="line"><span class="comment">##### æ€»ç»“</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">*</span><span class="symbol">*</span>Java 8<span class="symbol">*</span><span class="symbol">*</span> æ•°ç»„ï¼ˆNodeï¼‰ +ï¼ˆ é“¾è¡¨ Node |<span class="string"> çº¢é»‘æ ‘ TreeNode ï¼‰ ä»¥ä¸‹æ•°ç»„ç®€ç§°ï¼ˆtableï¼‰ï¼Œé“¾è¡¨ç®€ç§°ï¼ˆbinï¼‰</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- åˆå§‹åŒ–ï¼Œä½¿ç”¨ cas æ¥ä¿è¯å¹¶å‘å®‰å…¨ï¼Œæ‡’æƒ°åˆå§‹åŒ– table</span></span><br><span class="line"><span class="string">- æ ‘åŒ–ï¼Œå½“ table.length &lt; 64 æ—¶ï¼Œå…ˆå°è¯•æ‰©å®¹ï¼Œè¶…è¿‡ 64 æ—¶ï¼Œå¹¶ä¸” bin.length &gt; 8 æ—¶ï¼Œä¼šå°†é“¾è¡¨æ ‘åŒ–ï¼Œæ ‘åŒ–è¿‡ç¨‹ ä¼šç”¨ synchronized é”ä½é“¾è¡¨å¤´</span></span><br><span class="line"><span class="string">- putï¼Œå¦‚æœè¯¥ bin å°šæœªåˆ›å»ºï¼Œåªéœ€è¦ä½¿ç”¨ cas åˆ›å»º binï¼›å¦‚æœå·²ç»æœ‰äº†ï¼Œé”ä½é“¾è¡¨å¤´è¿›è¡Œåç»­ put æ“ä½œï¼Œå…ƒç´  æ·»åŠ è‡³ bin çš„å°¾éƒ¨</span></span><br><span class="line"><span class="string">- getï¼Œæ— é”æ“ä½œä»…éœ€è¦ä¿è¯å¯è§æ€§ï¼Œæ‰©å®¹è¿‡ç¨‹ä¸­ get æ“ä½œæ‹¿åˆ°çš„æ˜¯ ForwardingNode å®ƒä¼šè®© get æ“ä½œåœ¨æ–° table è¿›è¡Œæœç´¢</span></span><br><span class="line"><span class="string">- æ‰©å®¹ï¼Œæ‰©å®¹æ—¶ä»¥ bin ä¸ºå•ä½è¿›è¡Œï¼Œéœ€è¦å¯¹ bin è¿›è¡Œ synchronizedï¼Œä½†è¿™æ—¶å¦™çš„æ˜¯å…¶å®ƒç«äº‰çº¿ç¨‹ä¹Ÿä¸æ˜¯æ— äº‹å¯åšï¼Œå®ƒä»¬ä¼šå¸®åŠ©æŠŠå…¶å®ƒ bin è¿›è¡Œæ‰©å®¹ï¼Œæ‰©å®¹æ—¶å¹³å‡åªæœ‰ 1/6 çš„èŠ‚ç‚¹ä¼šæŠŠå¤åˆ¶åˆ°æ–° table ä¸­</span></span><br><span class="line"><span class="string">- sizeï¼Œå…ƒç´ ä¸ªæ•°ä¿å­˜åœ¨ baseCount ä¸­ï¼Œå¹¶å‘æ—¶çš„ä¸ªæ•°å˜åŠ¨ä¿å­˜åœ¨ CounterCell[] å½“ä¸­ã€‚æœ€åç»Ÿè®¡æ•°é‡æ—¶ç´¯åŠ  å³å¯</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">JDK8 `ConcurrentHashMap` ä¼˜åŠ¿</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span>|<span class="string"> ç‰¹æ€§             </span>|<span class="string"> è¯´æ˜                                   </span>|</span><br><span class="line">|<span class="string"> ---------------- </span>|<span class="string"> -------------------------------------- </span>|</span><br><span class="line">|<span class="string"> é«˜å¹¶å‘           </span>|<span class="string"> CAS + synchronized å±€éƒ¨åŠ é”ï¼ˆé” binï¼‰  </span>|</span><br><span class="line">|<span class="string"> åˆ†ç¦»é”           </span>|<span class="string"> é“¾è¡¨/çº¢é»‘æ ‘åŠ  synchronizedï¼Œé¿å…å…¨è¡¨é” </span>|</span><br><span class="line">|<span class="string"> æ”¯æŒåä½œæ‰©å®¹     </span>|<span class="string"> å¤šçº¿ç¨‹ä¸€èµ·æ¬è¿æ¡¶ä½ï¼Œæ•ˆç‡é«˜             </span>|</span><br><span class="line">|<span class="string"> æ— é”è¯»å–         </span>|<span class="string"> `get()` è¿‡ç¨‹æ— é”ï¼Œä¿è¯å¯è§æ€§å³å¯       </span>|</span><br><span class="line">|<span class="string"> åˆ†æ®µ size ç´¯åŠ å™¨ </span>|<span class="string"> é«˜æ•ˆç»Ÿè®¡å…ƒç´ ä¸ªæ•°ï¼Œé¿å…çƒ­ç‚¹ç«äº‰         </span>|</span><br><span class="line">|<span class="string"> çº¢é»‘æ ‘ä¼˜åŒ–       </span>|<span class="string"> é“¾è¡¨è¿‡é•¿è‡ªåŠ¨è½¬ä¸ºçº¢é»‘æ ‘ï¼Œæé«˜æŸ¥æ‰¾æ•ˆç‡   </span>|</span><br><span class="line"></span><br><span class="line"><span class="comment">#### JDK 7 ConcurrentHashMapåŸç†</span></span><br><span class="line"></span><br><span class="line">å®ƒç»´æŠ¤äº†ä¸€ä¸ª segment æ•°ç»„ï¼Œæ¯ä¸ª segment å¯¹åº”ä¸€æŠŠé”</span><br><span class="line"></span><br><span class="line">- ä¼˜ç‚¹ï¼šå¦‚æœå¤šä¸ªçº¿ç¨‹è®¿é—®ä¸åŒçš„ segmentï¼Œå®é™…æ˜¯æ²¡æœ‰å†²çªçš„ï¼Œè¿™ä¸ jdk8 ä¸­æ˜¯ç±»ä¼¼çš„</span><br><span class="line">- ç¼ºç‚¹ï¼šSegments æ•°ç»„é»˜è®¤å¤§å°ä¸º16ï¼Œè¿™ä¸ªå®¹é‡åˆå§‹åŒ–æŒ‡å®šåå°±ä¸èƒ½æ”¹å˜äº†ï¼Œå¹¶ä¸”ä¸æ˜¯æ‡’æƒ°åˆå§‹åŒ–</span><br><span class="line"></span><br><span class="line"><span class="comment">##### æ„é€ å™¨åˆ†æ</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>public ConcurrentHashMap(int initialCapacity, float loadFactor, int concurrencyLevel) {<br>
if (!(loadFactor &gt; 0) || initialCapacity &lt; 0 || concurrencyLevel &lt;= 0)<br>
throw new IllegalArgumentException();<br>
if (concurrencyLevel &gt; MAX_SEGMENTS)<br>
concurrencyLevel = MAX_SEGMENTS;<br>
// ssize å¿…é¡»æ˜¯ 2^n, å³ 2, 4, 8, 16 â€¦ è¡¨ç¤ºäº† segments æ•°ç»„çš„å¤§å°<br>
int sshift = 0;<br>
int ssize = 1;<br>
while (ssize &lt; concurrencyLevel) {<br>
++sshift;<br>
ssize &lt;&lt;= 1;<br>
}<br>
// segmentShift é»˜è®¤æ˜¯ 32 - 4 = 28<br>
this.segmentShift = 32 - sshift;<br>
// segmentMask é»˜è®¤æ˜¯ 15 å³ 0000 0000 0000 1111<br>
this.segmentMask = ssize - 1;<br>
if (initialCapacity &gt; MAXIMUM_CAPACITY)<br>
initialCapacity = MAXIMUM_CAPACITY;<br>
int c = initialCapacity / ssize;<br>
if (c * ssize &lt; initialCapacity)<br>
++c;<br>
int cap = MIN_SEGMENT_TABLE_CAPACITY;<br>
while (cap &lt; c)<br>
cap &lt;&lt;= 1;<br>
// åˆ›å»º segments and segments[0]<br>
Segment&lt;K,V&gt; s0 =<br>
new Segment&lt;K,V&gt;(loadFactor, (int)(cap * loadFactor),<br>
(HashEntry&lt;K,V&gt;[])new HashEntry[cap]);<br>
Segment&lt;K,V&gt;[] ss = (Segment&lt;K,V&gt;[])new Segment[ssize];<br>
UNSAFE.putOrderedObject(ss, SBASE, s0); // ordered write of segments[0]<br>
this.segments = ss;<br>
}</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">07</span>/image-<span class="number">1734</span>.png)</span><br><span class="line"></span><br><span class="line">æ„é€ å®Œæˆï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</span><br><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">07</span>/image-<span class="number">1735</span>.png)</span><br><span class="line"></span><br><span class="line">å¯ä»¥çœ‹åˆ° ConcurrentHashMap æ²¡æœ‰å®ç°æ‡’æƒ°åˆå§‹åŒ–ï¼Œç©ºé—´å ç”¨ä¸å‹å¥½</span><br><span class="line"></span><br><span class="line">å…¶ä¸­ this.segmentShift å’Œ this.segmentMask çš„ä½œç”¨æ˜¯å†³å®šå°† key çš„ hash ç»“æœåŒ¹é…åˆ°å“ªä¸ª segment</span><br><span class="line"></span><br><span class="line">ä¾‹å¦‚ï¼Œæ ¹æ®æŸä¸€ hash å€¼æ±‚ segment ä½ç½®ï¼Œå…ˆå°†é«˜ä½å‘ä½ä½ç§»åŠ¨ this.segmentShift ä½</span><br><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">07</span>/image-<span class="number">1736</span>.png)</span><br><span class="line"></span><br><span class="line">ç»“æœå†ä¸ this.segmentMask åšä½äºè¿ç®—ï¼Œæœ€ç»ˆå¾—åˆ° <span class="number">1010</span> å³ä¸‹æ ‡ä¸º <span class="number">10</span> çš„ segment</span><br><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">07</span>/image-<span class="number">1737</span>.png)</span><br><span class="line"></span><br><span class="line"><span class="comment">##### put æµç¨‹</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>public V put(K key, V value) {<br>
Segment&lt;K,V&gt; s;<br>
if (value == null)<br>
throw new NullPointerException();<br>
int hash = hash(key);<br>
// è®¡ç®—å‡º segment ä¸‹æ ‡<br>
int j = (hash &gt;&gt;&gt; segmentShift) &amp; segmentMask;</p>
<pre><code>// è·å¾— segment å¯¹è±¡, åˆ¤æ–­æ˜¯å¦ä¸º null, æ˜¯åˆ™åˆ›å»ºè¯¥ segment
if ((s = (Segment&lt;K,V&gt;)UNSAFE.getObject 
     (segments, (j &lt;&lt; SSHIFT) + SBASE)) == null) &#123;
    // è¿™æ—¶ä¸èƒ½ç¡®å®šæ˜¯å¦çœŸçš„ä¸º null, å› ä¸ºå…¶å®ƒçº¿ç¨‹ä¹Ÿå‘ç°è¯¥ segment ä¸º null,
    // å› æ­¤åœ¨ ensureSegment é‡Œç”¨ cas æ–¹å¼ä¿è¯è¯¥ segment å®‰å…¨æ€§
    s = ensureSegment(j);
&#125;
// è¿›å…¥ segment çš„put æµç¨‹
return s.put(key, hash, value, false);
</code></pre>
<p>}</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">segment</span> ç»§æ‰¿äº†å¯é‡å…¥é”ï¼ˆReentrantLockï¼‰ï¼Œå®ƒçš„ <span class="built_in">put</span> æ–¹æ³•ä¸º</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>final V put(K key, int hash, V value, boolean onlyIfAbsent) {<br>
// å°è¯•åŠ é”<br>
HashEntry&lt;K,V&gt; node = tryLock() ? null :<br>
// å¦‚æœä¸æˆåŠŸ, è¿›å…¥ scanAndLockForPut æµç¨‹<br>
// å¦‚æœæ˜¯å¤šæ ¸ cpu æœ€å¤š tryLock 64 æ¬¡, è¿›å…¥ lock æµç¨‹<br>
// åœ¨å°è¯•æœŸé—´, è¿˜å¯ä»¥é¡ºä¾¿çœ‹è¯¥èŠ‚ç‚¹åœ¨é“¾è¡¨ä¸­æœ‰æ²¡æœ‰, å¦‚æœæ²¡æœ‰é¡ºä¾¿åˆ›å»ºå‡ºæ¥<br>
scanAndLockForPut(key, hash, value);</p>
<pre><code>// æ‰§è¡Œåˆ°è¿™é‡Œ segment å·²ç»è¢«æˆåŠŸåŠ é”, å¯ä»¥å®‰å…¨æ‰§è¡Œ
V oldValue;
try &#123;
    HashEntry&lt;K,V&gt;[] tab = table;
    int index = (tab.length - 1) &amp; hash;
    HashEntry&lt;K,V&gt; first = entryAt(tab, index);
    for (HashEntry&lt;K,V&gt; e = first;;) &#123;
        if (e != null) &#123;
            // æ›´æ–°
            K k;
            if ((k = e.key) == key ||
                (e.hash == hash &amp;&amp; key.equals(k))) &#123; 
                oldValue = e.value;
                if (!onlyIfAbsent) &#123;
                    e.value = value;
                    ++modCount;
                &#125; break;
            &#125;
            e = e.next;
        &#125;
        else &#123;
            // æ–°å¢
            // 1) ä¹‹å‰ç­‰å¾…é”æ—¶, node å·²ç»è¢«åˆ›å»º, next æŒ‡å‘é“¾è¡¨å¤´
            if (node != null)
                node.setNext(first);
            else
                // 2) åˆ›å»ºæ–° node
                node = new HashEntry&lt;K,V&gt;(hash, key, value, first);
            int c = count + 1; 
            // 3) æ‰©å®¹
            if (c &gt; threshold &amp;&amp; tab.length &lt; MAXIMUM_CAPACITY)
                rehash(node);
            else
                // å°† node ä½œä¸ºé“¾è¡¨å¤´
                setEntryAt(tab, index, node);
            ++modCount;
            count = c;
            oldValue = null;
            break;
        &#125;
    &#125;
&#125; finally &#123;
    unlock();
&#125;
return oldValue;
</code></pre>
<p>}</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](https:<span class="comment">//www.legendkiller.xyz/wp-content/uploads/2025/07/image-1738.png)</span></span><br><span class="line"></span><br><span class="line">##### rehash æµç¨‹</span><br><span class="line"></span><br><span class="line">å‘ç”Ÿåœ¨ put ä¸­ï¼Œå› ä¸ºæ­¤æ—¶å·²ç»è·å¾—äº†é”ï¼Œå› æ­¤ rehash æ—¶ä¸éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>private void rehash(HashEntry&lt;K,V&gt; node) {<br>
HashEntry&lt;K,V&gt;[] oldTable = table;<br>
int oldCapacity = oldTable.length;<br>
int newCapacity = oldCapacity &lt;&lt; 1;<br>
threshold = (int)(newCapacity * loadFactor);<br>
HashEntry&lt;K,V&gt;[] newTable =<br>
(HashEntry&lt;K,V&gt;[]) new HashEntry[newCapacity];<br>
int sizeMask = newCapacity - 1;<br>
for (int i = 0; i &lt; oldCapacity ; i++) {<br>
HashEntry&lt;K,V&gt; e = oldTable[i];<br>
if (e != null) {<br>
HashEntry&lt;K,V&gt; next = e.next;<br>
int idx = e.hash &amp; sizeMask;<br>
if (next == null) // Single node on list<br>
newTable[idx] = e;<br>
else { // Reuse consecutive sequence at same slot<br>
HashEntry&lt;K,V&gt; lastRun = e;<br>
int lastIdx = idx;<br>
// è¿‡ä¸€éé“¾è¡¨, å°½å¯èƒ½æŠŠ rehash å idx ä¸å˜çš„èŠ‚ç‚¹é‡ç”¨<br>
for (HashEntry&lt;K,V&gt; last = next;<br>
last != null;<br>
last = last.next) {<br>
int k = last.hash &amp; sizeMask;<br>
if (k != lastIdx) {<br>
lastIdx = k;<br>
lastRun = last;<br>
}<br>
}<br>
newTable[lastIdx] = lastRun;<br>
// å‰©ä½™èŠ‚ç‚¹éœ€è¦æ–°å»º<br>
for (HashEntry&lt;K,V&gt; p = e; p != lastRun; p = p.next) {<br>
V v = p.value;<br>
int h = p.hash;<br>
int k = h &amp; sizeMask;<br>
HashEntry&lt;K,V&gt; n = newTable[k];<br>
newTable[k] = new HashEntry&lt;K,V&gt;(h, p.key, v, n);<br>
}<br>
}<br>
}<br>
}<br>
// æ‰©å®¹å®Œæˆ, æ‰åŠ å…¥æ–°çš„èŠ‚ç‚¹<br>
int nodeIndex = node.hash &amp; sizeMask; // add the new node<br>
node.setNext(newTable[nodeIndex]);<br>
newTable[nodeIndex] = node;</p>
<pre><code>// æ›¿æ¢ä¸ºæ–°çš„ HashEntry table
table = newTable;
</code></pre>
<p>}</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">07</span>/image-<span class="number">1739</span>.png)</span><br><span class="line"></span><br><span class="line">é™„ï¼Œè°ƒè¯•ä»£ç </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>public static void main(String[] args) {<br>
ConcurrentHashMap&lt;Integer, String&gt; map = new ConcurrentHashMap&lt;&gt;();<br>
for (int i = 0; i &lt; 1000; i++) {<br>
int hash = hash(i);<br>
int segmentIndex = (hash &gt;&gt;&gt; 28) &amp; 15;<br>
if (segmentIndex == 4 &amp;&amp; hash % 8 == 2) {<br>
System.out.println(i + â€œ\tâ€ + segmentIndex + â€œ\tâ€ + hash % 2 + â€œ\tâ€ + hash % 4 +<br>
â€œ\tâ€ + hash % 8);<br>
}<br>
}<br>
map.put(1, â€œvalueâ€);<br>
map.put(15, â€œvalueâ€); // 2 æ‰©å®¹ä¸º 4 15 çš„ hash%8 ä¸å…¶ä»–ä¸åŒ<br>
map.put(169, â€œvalueâ€);<br>
map.put(197, â€œvalueâ€); // 4 æ‰©å®¹ä¸º 8<br>
map.put(341, â€œvalueâ€);<br>
map.put(484, â€œvalueâ€);<br>
map.put(545, â€œvalueâ€); // 8 æ‰©å®¹ä¸º 16<br>
map.put(912, â€œvalueâ€);<br>
map.put(941, â€œvalueâ€);<br>
System.out.println(â€œokâ€);<br>
}<br>
private static int hash(Object k) {<br>
int h = 0;<br>
if ((0 != h) &amp;&amp; (k instanceof String)) {<br>
return sun.misc.Hashing.stringHash32((String) k);<br>
}<br>
h ^= k.hashCode();<br>
// Spread bits to regularize both segment and index locations,<br>
// using variant of single-word Wang/Jenkins hash.<br>
h += (h &lt;&lt; 15) ^ 0xffffcd7d;<br>
h ^= (h &gt;&gt;&gt; 10);<br>
h += (h &lt;&lt; 3);<br>
h ^= (h &gt;&gt;&gt; 6);<br>
h += (h &lt;&lt; 2) + (h &lt;&lt; 14);<br>
int v = h ^ (h &gt;&gt;&gt; 16);<br>
return v;<br>
}</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">##### get æµç¨‹ï¼ˆæ— é”ï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">get</span> æ—¶å¹¶æœªåŠ é”ï¼Œç”¨äº† UNSAFE æ–¹æ³•ä¿è¯äº†å¯è§æ€§ï¼Œæ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œ<span class="built_in">get</span> å…ˆå‘ç”Ÿå°±ä»æ—§è¡¨å–å†…å®¹ï¼Œ<span class="built_in">get</span> åå‘ç”Ÿå°±ä»æ–° è¡¨å–å†…å®¹</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>public V get(Object key) {<br>
Segment&lt;K,V&gt; s; // manually integrate access methods to reduce overhead<br>
HashEntry&lt;K,V&gt;[] tab;<br>
int h = hash(key);<br>
// u ä¸º segment å¯¹è±¡åœ¨æ•°ç»„ä¸­çš„åç§»é‡<br>
long u = (((h &gt;&gt;&gt; segmentShift) &amp; segmentMask) &lt;&lt; SSHIFT) + SBASE;<br>
// s å³ä¸º segment<br>
if ((s = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(segments, u)) != null &amp;&amp;<br>
(tab = s.table) != null) {<br>
for (HashEntry&lt;K,V&gt; e = (HashEntry&lt;K,V&gt;) UNSAFE.getObjectVolatile<br>
(tab, ((long)(((tab.length - 1) &amp; h)) &lt;&lt; TSHIFT) + TBASE);<br>
e != null; e = e.next) {<br>
K k;<br>
if ((k = e.key) == key || (e.hash == h &amp;&amp; key.equals(k)))<br>
return e.value;<br>
}<br>
}<br>
return null;<br>
}</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](https:<span class="comment">//www.legendkiller.xyz/wp-content/uploads/2025/07/image-1740.png)</span></span><br><span class="line"></span><br><span class="line">##### size è®¡ç®—æµç¨‹ï¼ˆé‡è¯•+åŠ é”ï¼‰</span><br><span class="line"></span><br><span class="line">- è®¡ç®—å…ƒç´ ä¸ªæ•°å‰ï¼Œå…ˆä¸åŠ é”è®¡ç®—ä¸¤æ¬¡ï¼Œå¦‚æœå‰åä¸¤æ¬¡ç»“æœå¦‚ä¸€æ ·ï¼Œè®¤ä¸ºä¸ªæ•°æ­£ç¡®è¿”å›</span><br><span class="line">- å¦‚æœä¸ä¸€æ ·ï¼Œè¿›è¡Œé‡è¯•ï¼Œé‡è¯•æ¬¡æ•°è¶…è¿‡ <span class="number">3</span>ï¼Œå°†æ‰€æœ‰ segment é”ä½ï¼Œé‡æ–°è®¡ç®—ä¸ªæ•°è¿”å›</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>public int size() {<br>
// Try a few times to get accurate count. On failure due to<br>
// continuous async changes in table, resort to locking.<br>
final Segment&lt;K,V&gt;[] segments = this.segments;<br>
int size;<br>
boolean overflow; // true if size overflows 32 bits<br>
long sum; // sum of modCounts<br>
long last = 0L; // previous sum<br>
int retries = -1; // first iteration isnâ€™t retry<br>
try {<br>
for (;;) {<br>
if (retries++ == RETRIES_BEFORE_LOCK) {<br>
// è¶…è¿‡é‡è¯•æ¬¡æ•°, éœ€è¦åˆ›å»ºæ‰€æœ‰ segment å¹¶åŠ é”<br>
for (int j = 0; j &lt; segments.length; ++j)<br>
ensureSegment(j).lock(); // force creation<br>
}<br>
sum = 0L;<br>
size = 0;<br>
overflow = false;<br>
for (int j = 0; j &lt; segments.length; ++j) {<br>
Segment&lt;K,V&gt; seg = segmentAt(segments, j);<br>
if (seg != null) {<br>
sum += seg.modCount;<br>
int c = seg.count;<br>
if (c &lt; 0 || (size += c) &lt; 0)<br>
overflow = true;<br>
}<br>
}<br>
if (sum == last)<br>
break;<br>
last = sum;<br>
}<br>
} finally {<br>
if (retries &gt; RETRIES_BEFORE_LOCK) {<br>
for (int j = 0; j &lt; segments.length; ++j)<br>
segmentAt(segments, j).unlock();<br>
}<br>
}<br>
return overflow ? Integer.MAX_VALUE : size;<br>
}</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1741.png)</span><br><span class="line"></span><br><span class="line"><span class="comment">##### ä¸ JDK8 çš„å·®å¼‚å¯¹æ¯”</span></span><br><span class="line"></span><br><span class="line">|<span class="string"> ç‰¹æ€§     </span>|<span class="string"> JDK7                     </span>|<span class="string"> JDK8                          </span>|</span><br><span class="line">|<span class="string"> -------- </span>|<span class="string"> ------------------------ </span>|<span class="string"> ----------------------------- </span>|</span><br><span class="line">|<span class="string"> é”ç²’åº¦   </span>|<span class="string"> Segment çº§ï¼ˆé” segmentï¼‰ </span>|<span class="string"> Node çº§ï¼ˆé” binï¼‰             </span>|</span><br><span class="line">|<span class="string"> å¹¶å‘çº§åˆ« </span>|<span class="string"> segment æ•°é‡ï¼ˆé»˜è®¤ 16ï¼‰  </span>|<span class="string"> æ— é™åˆ¶ï¼ˆç†è®ºä¸Šæ‰€æœ‰ bin å¹¶å‘ï¼‰ </span>|</span><br><span class="line">|<span class="string"> æ‰©å®¹     </span>|<span class="string"> segment è‡ªæ‰©å®¹           </span>|<span class="string"> æ•´ä½“ table åä½œæ‰©å®¹           </span>|</span><br><span class="line">|<span class="string"> æ‡’åŠ è½½   </span>|<span class="string"> âŒ segments å…¨éƒ¨åˆå§‹åŒ–    </span>|<span class="string"> âœ… table å»¶è¿Ÿåˆå§‹åŒ–            </span>|</span><br><span class="line">|<span class="string"> æ•°æ®ç»“æ„ </span>|<span class="string"> å“ˆå¸Œé“¾è¡¨                 </span>|<span class="string"> é“¾è¡¨ + çº¢é»‘æ ‘                 </span>|</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1742.png)</span><br><span class="line"></span><br><span class="line"><span class="comment">### 10.LinkedBlockingQueue åŸç†</span></span><br><span class="line"></span><br><span class="line">è¿™æ˜¯ä¸€ä¸ªåŸºäºé“¾è¡¨çš„é˜»å¡é˜Ÿåˆ—ï¼Œå¹¿æ³›ç”¨äºç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ä¸­ï¼Œæ”¯æŒ<span class="symbol">*</span><span class="symbol">*</span>é«˜å¹¶å‘å…¥é˜Ÿå’Œå‡ºé˜Ÿæ“ä½œ<span class="symbol">*</span><span class="symbol">*</span>ã€‚</span><br><span class="line"></span><br><span class="line"><span class="comment">#### æ•´ä½“ç»“æ„</span></span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1743.png)</span><br><span class="line"></span><br><span class="line">|<span class="string"> ç»„ä»¶       </span>|<span class="string"> æè¿°                                      </span>|</span><br><span class="line">|<span class="string"> ---------- </span>|<span class="string"> ----------------------------------------- </span>|</span><br><span class="line">|<span class="string"> `head`     </span>|<span class="string"> å“¨å…µèŠ‚ç‚¹ï¼Œä¸å­˜å®é™…æ•°æ®                    </span>|</span><br><span class="line">|<span class="string"> `last`     </span>|<span class="string"> æŒ‡å‘é˜Ÿå°¾çš„æœ€åä¸€ä¸ªå…ƒç´ èŠ‚ç‚¹                </span>|</span><br><span class="line">|<span class="string"> `count`    </span>|<span class="string"> å½“å‰å…ƒç´ ä¸ªæ•°ï¼Œ`AtomicInteger` å®ç°        </span>|</span><br><span class="line">|<span class="string"> `putLock`  </span>|<span class="string"> å…¥é˜Ÿæ“ä½œä½¿ç”¨çš„é”                          </span>|</span><br><span class="line">|<span class="string"> `takeLock` </span>|<span class="string"> å‡ºé˜Ÿæ“ä½œä½¿ç”¨çš„é”                          </span>|</span><br><span class="line">|<span class="string"> `notFull`  </span>|<span class="string"> æ¡ä»¶å˜é‡ï¼šé˜Ÿåˆ—æœªæ»¡ï¼Œç”¨äºé˜»å¡/å”¤é†’å…¥é˜Ÿçº¿ç¨‹ </span>|</span><br><span class="line">|<span class="string"> `notEmpty` </span>|<span class="string"> æ¡ä»¶å˜é‡ï¼šé˜Ÿåˆ—éç©ºï¼Œç”¨äºé˜»å¡/å”¤é†’å‡ºé˜Ÿçº¿ç¨‹ </span>|</span><br><span class="line"></span><br><span class="line"><span class="comment">#### åŸºæœ¬çš„å…¥é˜Ÿå‡ºé˜Ÿ</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>public class LinkedBlockingQueue<E> extends AbstractQueue<E><br>
implements BlockingQueue<E>, java.io.Serializable {<br>
static class Node<E> {<br>
E item;<br>
/**<br>
* ä¸‹åˆ—ä¸‰ç§æƒ…å†µä¹‹ä¸€<br>
* - çœŸæ­£çš„åç»§èŠ‚ç‚¹<br>
* - è‡ªå·±, å‘ç”Ÿåœ¨å‡ºé˜Ÿæ—¶<br>
* - null, è¡¨ç¤ºæ˜¯æ²¡æœ‰åç»§èŠ‚ç‚¹, æ˜¯æœ€åäº†<br>
*/<br>
Node<E> next;<br>
Node(E x) { item = x; }<br>
}<br>
}</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">##### åˆå§‹åŒ–é“¾è¡¨</span><br><span class="line"></span><br><span class="line">`last = head = new Node(null);`Dummy èŠ‚ç‚¹ç”¨æ¥å ä½ï¼Œitem ä¸º null</span><br><span class="line"></span><br><span class="line">![img](https:<span class="comment">//www.legendkiller.xyz/wp-content/uploads/2025/07/image-1744.png)</span></span><br><span class="line"></span><br><span class="line">##### å½“ä¸€ä¸ªèŠ‚ç‚¹å…¥é˜Ÿ</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>last = last.next = node;</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">07</span>/image-<span class="number">1745</span>-<span class="number">1024</span>x267.png)</span><br><span class="line"></span><br><span class="line">å†æ¥ä¸€ä¸ªèŠ‚ç‚¹å…¥é˜Ÿ`last = last.<span class="keyword">next</span> = node;`</span><br><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">07</span>/image-<span class="number">1746</span>.png)</span><br><span class="line"></span><br><span class="line"><span class="comment">##### å‡ºé˜Ÿ</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>//ä¸´æ—¶å˜é‡hç”¨æ¥æŒ‡å‘å“¨å…µ<br>
Node<E> h = head;<br>
//firstç”¨æ¥æŒ‡å‘ç¬¬ä¸€ä¸ªå…ƒç´ <br>
Node<E> first = h.next;<br>
h.next = h; // help GC<br>
//headèµ‹å€¼ä¸ºfirstï¼Œè¡¨ç¤ºfirstèŠ‚ç‚¹å°±æ˜¯ä¸‹ä¸€ä¸ªå“¨å…µã€‚<br>
head = first;<br>
E x = first.item;<br>
//åˆ é™¤firstèŠ‚ç‚¹ä¸­çš„æ•°æ®ï¼Œè¡¨ç¤ºçœŸæ­£æˆä¸ºäº†å“¨å…µï¼Œç¬¬ä¸€ä¸ªå…ƒç´ å‡ºé˜Ÿã€‚<br>
first.item = null;<br>
return x;<br>
h = head</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">07</span>/image-<span class="number">1747</span>.png)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>first = h.next</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">07</span>/image-<span class="number">1748</span>.png)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>h.next = h</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">07</span>/image-<span class="number">1749</span>.png)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>head = first</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">07</span>/image-<span class="number">1750</span>.png)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>E x = first.item;<br>
first.item = null;<br>
return x;</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1751.png</span>)</span><br><span class="line"></span><br><span class="line"><span class="section">#### åŠ é”åˆ†æ</span></span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1755.png</span>)</span><br><span class="line"></span><br><span class="line"><span class="strong">**é«˜æ˜ä¹‹å¤„**</span>åœ¨äºç”¨äº†ä¸¤æŠŠé”å’Œ dummy èŠ‚ç‚¹</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> ç”¨ä¸€æŠŠé”ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œæœ€å¤šåªå…è®¸æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼ˆç”Ÿäº§è€…æˆ–æ¶ˆè´¹è€…ï¼ŒäºŒé€‰ä¸€ï¼‰æ‰§è¡Œ</span><br><span class="line"><span class="bullet">-</span> ç”¨ä¸¤æŠŠé”ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œå¯ä»¥å…è®¸ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ï¼ˆä¸€ä¸ªç”Ÿäº§è€…ä¸ä¸€ä¸ªæ¶ˆè´¹è€…ï¼‰æ‰§è¡Œ</span><br><span class="line"><span class="bullet">  -</span> æ¶ˆè´¹è€…ä¸æ¶ˆè´¹è€…çº¿ç¨‹ä»ç„¶ä¸²è¡Œ</span><br><span class="line"><span class="bullet">  -</span> ç”Ÿäº§è€…ä¸ç”Ÿäº§è€…çº¿ç¨‹ä»ç„¶ä¸²è¡Œ</span><br><span class="line"></span><br><span class="line">çº¿ç¨‹å®‰å…¨åˆ†æ</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> å½“èŠ‚ç‚¹æ€»æ•°å¤§äº 2 æ—¶ï¼ˆåŒ…æ‹¬ dummy èŠ‚ç‚¹ï¼‰ï¼ŒputLock ä¿è¯çš„æ˜¯ last èŠ‚ç‚¹çš„çº¿ç¨‹å®‰å…¨ï¼ŒtakeLock ä¿è¯çš„æ˜¯ head èŠ‚ç‚¹çš„çº¿ç¨‹å®‰å…¨ã€‚ä¸¤æŠŠé”ä¿è¯äº†å…¥é˜Ÿå’Œå‡ºé˜Ÿæ²¡æœ‰ç«äº‰</span><br><span class="line"><span class="bullet">-</span> å½“èŠ‚ç‚¹æ€»æ•°ç­‰äº 2 æ—¶ï¼ˆå³ä¸€ä¸ª dummy èŠ‚ç‚¹ï¼Œä¸€ä¸ªæ­£å¸¸èŠ‚ç‚¹ï¼‰è¿™æ—¶å€™ï¼Œä»ç„¶æ˜¯ä¸¤æŠŠé”é”ä¸¤ä¸ªå¯¹è±¡ï¼Œä¸ä¼šç«äº‰</span><br><span class="line"><span class="bullet">-</span> å½“èŠ‚ç‚¹æ€»æ•°ç­‰äº 1 æ—¶ï¼ˆå°±ä¸€ä¸ª dummy èŠ‚ç‚¹ï¼‰è¿™æ—¶ take çº¿ç¨‹ä¼šè¢« notEmpty æ¡ä»¶é˜»å¡ï¼Œæœ‰ç«äº‰ï¼Œä¼šé˜»å¡</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>// ç”¨äº put(é˜»å¡) offer(éé˜»å¡)<br>
private final ReentrantLock putLock = new ReentrantLock();<br>
// ç”¨æˆ· take(é˜»å¡) poll(éé˜»å¡)<br>
private final ReentrantLock takeLock = new ReentrantLock();</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">put</span> æ“ä½œ</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>public void put(E e) throws InterruptedException {<br>
//LinkedBlockingQueueä¸æ”¯æŒç©ºå…ƒç´ <br>
if (e == null) throw new NullPointerException();<br>
int c = -1;<br>
Node<E> node = new Node<E>(e);<br>
final ReentrantLock putLock = this.putLock;<br>
// count ç”¨æ¥ç»´æŠ¤å…ƒç´ è®¡æ•°<br>
final AtomicInteger count = this.count;<br>
putLock.lockInterruptibly();<br>
try {<br>
// æ»¡äº†ç­‰å¾…<br>
while (count.get() == capacity) {<br>
// å€’è¿‡æ¥è¯»å°±å¥½: ç­‰å¾… notFull<br>
notFull.await();<br>
}<br>
// æœ‰ç©ºä½, å…¥é˜Ÿä¸”è®¡æ•°åŠ ä¸€<br>
enqueue(node);<br>
c = count.getAndIncrement();<br>
// é™¤äº†è‡ªå·± put ä»¥å¤–, é˜Ÿåˆ—è¿˜æœ‰ç©ºä½, ç”±è‡ªå·±å«é†’å…¶ä»– put çº¿ç¨‹<br>
if (c + 1 &lt; capacity)<br>
notFull.signal();<br>
} finally {<br>
putLock.unlock();<br>
}<br>
// å¦‚æœé˜Ÿåˆ—ä¸­æœ‰ä¸€ä¸ªå…ƒç´ , å«é†’ take çº¿ç¨‹<br>
if (c == 0)<br>
// è¿™é‡Œè°ƒç”¨çš„æ˜¯ notEmpty.signal() è€Œä¸æ˜¯ notEmpty.signalAll() æ˜¯ä¸ºäº†å‡å°‘ç«äº‰<br>
signalNotEmpty();<br>
}</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">07</span>/image-<span class="number">1756</span>.png)</span><br><span class="line"></span><br><span class="line">take æ“ä½œ</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>public E take() throws InterruptedException {<br>
E x;<br>
int c = -1;<br>
final AtomicInteger count = this.count;<br>
final ReentrantLock takeLock = this.takeLock;<br>
takeLock.lockInterruptibly();<br>
try {<br>
while (count.get() == 0) {<br>
notEmpty.await();<br>
}<br>
x = dequeue();<br>
c = count.getAndDecrement();<br>
if (c &gt; 1)<br>
notEmpty.signal();<br>
} finally {<br>
takeLock.unlock();<br>
}<br>
// å¦‚æœé˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªç©ºä½æ—¶, å«é†’ put çº¿ç¨‹<br>
// å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹è¿›è¡Œå‡ºé˜Ÿ, ç¬¬ä¸€ä¸ªçº¿ç¨‹æ»¡è¶³ c == capacity, ä½†åç»­çº¿ç¨‹ c &lt; capacity<br>
if (c == capacity)<br>
// è¿™é‡Œè°ƒç”¨çš„æ˜¯ notFull.signal() è€Œä¸æ˜¯ notFull.signalAll() æ˜¯ä¸ºäº†å‡å°‘ç«äº‰<br>
signalNotFull()<br>
return x;<br>
}</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&gt; ç”± put å”¤é†’ put æ˜¯ä¸ºäº†é¿å…ä¿¡å·ä¸è¶³</span><br><span class="line">&gt;</span><br><span class="line">&gt; ![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1757.png)</span><br><span class="line"></span><br><span class="line"><span class="comment">#### æ€§èƒ½æ¯”è¾ƒ</span></span><br><span class="line"></span><br><span class="line">ä¸»è¦åˆ—ä¸¾ LinkedBlockingQueue ä¸ ArrayBlockingQueue çš„æ€§èƒ½æ¯”è¾ƒ</span><br><span class="line"></span><br><span class="line">- Linked æ”¯æŒæœ‰ç•Œï¼ŒArray å¼ºåˆ¶æœ‰ç•Œ</span><br><span class="line">- Linked å®ç°æ˜¯é“¾è¡¨ï¼ŒArray å®ç°æ˜¯æ•°ç»„</span><br><span class="line">- Linked æ˜¯æ‡’æƒ°çš„ï¼Œè€Œ Array éœ€è¦æå‰åˆå§‹åŒ– Node æ•°ç»„</span><br><span class="line">- Linked æ¯æ¬¡å…¥é˜Ÿä¼šç”Ÿæˆæ–° Nodeï¼Œè€Œ Array çš„ Node æ˜¯æå‰åˆ›å»ºå¥½çš„</span><br><span class="line">- Linked ä¸¤æŠŠé”ï¼ŒArray ä¸€æŠŠé”</span><br><span class="line"></span><br><span class="line"><span class="comment">#### æ€»ç»“ï¼š</span></span><br><span class="line"></span><br><span class="line">|<span class="string"> ç‰¹ç‚¹     </span>|<span class="string"> LinkedBlockingQueue æè¿°                                     </span>|</span><br><span class="line">|<span class="string"> -------- </span>|<span class="string"> ------------------------------------------------------------ </span>|</span><br><span class="line">|<span class="string"> å†…éƒ¨ç»“æ„ </span>|<span class="string"> åŸºäºé“¾è¡¨å®ç°ï¼Œdummy èŠ‚ç‚¹å“¨å…µç»“æ„                             </span>|</span><br><span class="line">|<span class="string"> é”æœºåˆ¶   </span>|<span class="string"> ä¸¤æŠŠç‹¬ç«‹é”ï¼Œå…¥é˜Ÿé” `putLock`ï¼Œå‡ºé˜Ÿé” `takeLock`              </span>|</span><br><span class="line">|<span class="string"> çº¿ç¨‹å®‰å…¨ </span>|<span class="string"> å…¥é˜Ÿå‡ºé˜Ÿäº’ä¸å¹²æ‰°ï¼Œåˆ†åˆ«æ§åˆ¶ `last` å’Œ `head`                  </span>|</span><br><span class="line">|<span class="string"> ç­‰å¾…æœºåˆ¶ </span>|<span class="string"> ä½¿ç”¨ Condition çš„ `await` å’Œ `signal` è¿›è¡Œç²¾ç¡®çº¿ç¨‹é˜»å¡/å”¤é†’  </span>|</span><br><span class="line">|<span class="string"> æ€§èƒ½ä¼˜åŠ¿ </span>|<span class="string"> æ”¯æŒé«˜å¹¶å‘ä¸‹ä¸€ä¸ªçº¿ç¨‹å…¥é˜Ÿ + ä¸€ä¸ªçº¿ç¨‹å‡ºé˜ŸåŒæ—¶è¿›è¡Œï¼ˆæ¯”å•é”ç»“æ„é«˜æ•ˆï¼‰ </span>|</span><br><span class="line">|<span class="string"> å…¸å‹åº”ç”¨ </span>|<span class="string"> ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ä¸­çš„æ•°æ®ç¼“å†²åŒºã€å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ç­‰              </span>|</span><br><span class="line"></span><br><span class="line">|<span class="string"> ç‰¹æ€§               </span>|<span class="string"> LinkedBlockingQueue           </span>|<span class="string"> ArrayBlockingQueue </span>|</span><br><span class="line">|<span class="string"> ------------------ </span>|<span class="string"> ----------------------------- </span>|<span class="string"> ------------------ </span>|</span><br><span class="line">|<span class="string"> æ•°æ®ç»“æ„           </span>|<span class="string"> é“¾è¡¨                          </span>|<span class="string"> æ•°ç»„               </span>|</span><br><span class="line">|<span class="string"> å®¹é‡æ§åˆ¶           </span>|<span class="string"> å¯æ— ç•Œ / æœ‰ç•Œï¼ˆæ„é€ æŒ‡å®šå®¹é‡ï¼‰ </span>|<span class="string"> å¼ºåˆ¶æœ‰ç•Œ           </span>|</span><br><span class="line">|<span class="string"> é”æœºåˆ¶             </span>|<span class="string"> ä¸¤æŠŠé”ï¼ˆå…¥/å‡ºï¼‰               </span>|<span class="string"> ä¸€æŠŠé”             </span>|</span><br><span class="line">|<span class="string"> åˆå§‹åŒ–å¼€é”€         </span>|<span class="string"> æ‡’åŠ è½½                        </span>|<span class="string"> é¢„åˆ†é…æ•°ç»„         </span>|</span><br><span class="line">|<span class="string"> å…¥é˜Ÿå¼€é”€           </span>|<span class="string"> æ¯æ¬¡æ–°å»º Node                 </span>|<span class="string"> å¤ç”¨æ•°ç»„æ§½ä½       </span>|</span><br><span class="line">|<span class="string"> æ€§èƒ½ï¼ˆé«˜å¹¶å‘ååï¼‰ </span>|<span class="string"> è¾ƒé«˜ï¼ˆå…¥å‡ºåˆ†ç¦»ï¼‰              </span>|<span class="string"> ç•¥ä½ï¼ˆä¸²è¡Œï¼‰       </span>|</span><br><span class="line"></span><br><span class="line"><span class="comment">### 11.ConcurrentLinkedQueue</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### åŸºæœ¬ç‰¹ç‚¹</span></span><br><span class="line"></span><br><span class="line">å®ƒæ˜¯ Java æä¾›çš„ä¸€ç§<span class="symbol">*</span><span class="symbol">*</span>é«˜æ€§èƒ½æ— é”å¹¶å‘é˜Ÿåˆ—<span class="symbol">*</span><span class="symbol">*</span>ï¼Œé€‚ç”¨äºé«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ•°æ®å…±äº«ï¼Œå¦‚ Nettyã€Tomcat ä¸­å°±æœ‰å¹¿æ³›åº”ç”¨ã€‚</span><br><span class="line"></span><br><span class="line">ConcurrentLinkedQueue çš„è®¾è®¡ä¸ LinkedBlockingQueue éå¸¸åƒï¼Œä¹Ÿæ˜¯</span><br><span class="line"></span><br><span class="line">- ä¸¤æŠŠã€é”ã€‘ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œå¯ä»¥å…è®¸ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ï¼ˆä¸€ä¸ªç”Ÿäº§è€…ä¸ä¸€ä¸ªæ¶ˆè´¹è€…ï¼‰æ‰§è¡Œ</span><br><span class="line">- dummy èŠ‚ç‚¹çš„å¼•å…¥è®©ä¸¤æŠŠã€é”ã€‘å°†æ¥é”ä½çš„æ˜¯ä¸åŒå¯¹è±¡ï¼Œé¿å…ç«äº‰</span><br><span class="line">- åªæ˜¯è¿™ã€é”ã€‘ä½¿ç”¨äº† cas æ¥å®ç°</span><br><span class="line"></span><br><span class="line">|<span class="string"> ç‰¹æ€§       </span>|<span class="string"> æè¿°                                               </span>|</span><br><span class="line">|<span class="string"> ---------- </span>|<span class="string"> -------------------------------------------------- </span>|</span><br><span class="line">|<span class="string"> æ•°æ®ç»“æ„   </span>|<span class="string"> å•å‘é“¾è¡¨                                           </span>|</span><br><span class="line">|<span class="string"> çº¿ç¨‹å®‰å…¨æ€§ </span>|<span class="string"> æ— é”ï¼Œä½¿ç”¨ **CAS åŸå­æ“ä½œ** å®ç°å¹¶å‘å®‰å…¨           </span>|</span><br><span class="line">|<span class="string"> ç±»å‹       </span>|<span class="string"> **éé˜»å¡é˜Ÿåˆ—**ï¼ˆNon-blockingï¼‰ï¼Œé€‚ç”¨äºè‡ªæ—‹ç­‰å¾…åœºæ™¯ </span>|</span><br><span class="line">|<span class="string"> å†…éƒ¨æœºåˆ¶   </span>|<span class="string"> å¼•å…¥ **dummy å“¨å…µèŠ‚ç‚¹**ï¼ŒåŒºåˆ†å¤´å°¾ï¼Œå‡å°‘å¹¶å‘å†²çª    </span>|</span><br><span class="line">|<span class="string"> JDK åŒ…     </span>|<span class="string"> `java.util.concurrent.ConcurrentLinkedQueue`       </span>|</span><br><span class="line"></span><br><span class="line"><span class="comment">#### å†…éƒ¨ç»“æ„è®¾è®¡</span></span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1759.png)</span><br><span class="line"></span><br><span class="line"><span class="comment">#### å…¥é˜Ÿå’Œå‡ºé˜Ÿæµç¨‹</span></span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1760.png)</span><br><span class="line"></span><br><span class="line"><span class="comment">#### CAS æ›¿ä»£é”å¸¦æ¥çš„ä¼˜åŠ¿</span></span><br><span class="line"></span><br><span class="line">|<span class="string"> å¯¹æ¯”ç‚¹   </span>|<span class="string"> `LinkedBlockingQueue`     </span>|<span class="string"> `ConcurrentLinkedQueue` </span>|</span><br><span class="line">|<span class="string"> -------- </span>|<span class="string"> ------------------------- </span>|<span class="string"> ----------------------- </span>|</span><br><span class="line">|<span class="string"> åŒæ­¥æ–¹å¼ </span>|<span class="string"> ReentrantLock + Condition </span>|<span class="string"> **CAS åŸå­æ“ä½œ**        </span>|</span><br><span class="line">|<span class="string"> é˜»å¡æ€§   </span>|<span class="string"> é˜»å¡                      </span>|<span class="string"> éé˜»å¡                  </span>|</span><br><span class="line">|<span class="string"> å¹¶å‘æ€§èƒ½ </span>|<span class="string"> ä¸­                        </span>|<span class="string"> é«˜                      </span>|</span><br><span class="line">|<span class="string"> åœºæ™¯     </span>|<span class="string"> çº¿ç¨‹é€šä¿¡ï¼ˆç”Ÿäº§è€…æ¶ˆè´¹è€…ï¼‰  </span>|<span class="string"> é«˜å¹¶å‘å…±äº«æ•°æ®ä¼ é€’      </span>|</span><br><span class="line"></span><br><span class="line"><span class="comment">#### dummy èŠ‚ç‚¹çš„ä½œç”¨</span></span><br><span class="line"></span><br><span class="line">- åˆå§‹æ—¶ï¼Œ`head = tail = dummy` èŠ‚ç‚¹</span><br><span class="line">- å®é™…ç¬¬ä¸€ä¸ªå…ƒç´ ä¸º `head.next`</span><br><span class="line">- é¿å…è¾¹ç•Œåˆ¤æ–­ï¼Œæé«˜æ“ä½œä¸€è‡´æ€§</span><br><span class="line">- ä¾¿äº `CAS` æ“ä½œè¿›è¡Œæ¯”è¾ƒå’Œæ›¿æ¢</span><br><span class="line"></span><br><span class="line">å®é™…åº”ç”¨ï¼šTomcat ä¸­çš„ä½¿ç”¨</span><br><span class="line"></span><br><span class="line">åœ¨ Tomcat çš„ NIO æ¨¡å‹ä¸­ï¼š</span><br><span class="line"></span><br><span class="line">- Acceptor çº¿ç¨‹ä¸æ–­æ¥æ”¶æ–°çš„ SocketChannel</span><br><span class="line">- å¹¶é€šè¿‡ `ConcurrentLinkedQueue` ä¼ é€’ç»™ Poller</span><br><span class="line">- Poller å†æ³¨å†Œè¯»å†™äº‹ä»¶ï¼Œè¿›è¡Œä¸šåŠ¡å¤„ç†</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1758.png)</span><br><span class="line"></span><br><span class="line"><span class="comment">#### æ€»ç»“</span></span><br><span class="line"></span><br><span class="line">|<span class="string"> ç‰¹æ€§     </span>|<span class="string"> æè¿°                                </span>|</span><br><span class="line">|<span class="string"> -------- </span>|<span class="string"> ----------------------------------- </span>|</span><br><span class="line">|<span class="string"> æ— é”     </span>|<span class="string"> å…¨ç¨‹ä½¿ç”¨ `CAS`ï¼Œé¿å…çº¿ç¨‹æŒ‚èµ·ä¸å”¤é†’  </span>|</span><br><span class="line">|<span class="string"> é«˜æ€§èƒ½   </span>|<span class="string"> å…è®¸å¤šä¸ªçº¿ç¨‹å¹¶å‘è¯»å†™                </span>|</span><br><span class="line">|<span class="string"> éé˜»å¡   </span>|<span class="string"> çº¿ç¨‹ä¸ä¼šå› ä¸ºé˜Ÿåˆ—æ»¡æˆ–ç©ºè€Œé˜»å¡        </span>|</span><br><span class="line">|<span class="string"> åº”ç”¨åœºæ™¯ </span>|<span class="string"> çº¿ç¨‹é—´ä¼ é€’äº‹ä»¶/ä»»åŠ¡ï¼Œé«˜å¹¶å‘æ¶ˆæ¯é˜Ÿåˆ— </span>|</span><br><span class="line"></span><br><span class="line"><span class="comment">### 12.CopyOnWriteArrayList</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### ä»€ä¹ˆæ˜¯ CopyOnWriteArrayListï¼Ÿ</span></span><br><span class="line"></span><br><span class="line">`CopyOnWriteArrayList` æ˜¯ Java å¹¶å‘åŒ…ä¸­çš„ä¸€ç§çº¿ç¨‹å®‰å…¨é›†åˆï¼Œæ ¸å¿ƒç‰¹ç‚¹æ˜¯ï¼š</span><br><span class="line"></span><br><span class="line">- <span class="symbol">*</span><span class="symbol">*</span>è¯»å†™åˆ†ç¦»<span class="symbol">*</span><span class="symbol">*</span>ï¼šè¯»æ“ä½œæ— é”ï¼Œå†™æ“ä½œæ—¶å¤åˆ¶åŸæ•°ç»„ï¼Œæ“ä½œæ–°æ•°ç»„ã€‚</span><br><span class="line">- <span class="symbol">*</span><span class="symbol">*</span>å†™å…¥æ—¶å¤åˆ¶ï¼ˆCopy-On-Writeï¼‰<span class="symbol">*</span><span class="symbol">*</span>ï¼šæ¯æ¬¡å†™æ“ä½œå¦‚ `add/remove/set` éƒ½ä¼šåˆ›å»ºæ•°ç»„å‰¯æœ¬ã€‚</span><br><span class="line"></span><br><span class="line">å®ƒéå¸¸é€‚ç”¨äºã€Œè¯»å¤šå†™å°‘ã€çš„åœºæ™¯ï¼Œä¾‹å¦‚ï¼šé…ç½®åˆ—è¡¨ã€è§‚å¯Ÿè€…æ¨¡å¼ç­‰ã€‚</span><br><span class="line"></span><br><span class="line">`CopyOnWriteArraySet`æ˜¯å®ƒçš„é©¬ç”² åº•å±‚å®ç°é‡‡ç”¨äº† å†™å…¥æ—¶æ‹·è´ çš„æ€æƒ³ï¼Œå¢åˆ æ”¹æ“ä½œä¼šå°†åº•å±‚æ•°ç»„æ‹·è´ä¸€ä»½ï¼Œæ›´æ”¹æ“ä½œåœ¨æ–°æ•°ç»„ä¸Šæ‰§è¡Œï¼Œè¿™æ—¶ä¸å½±å“å…¶å®ƒçº¿ç¨‹çš„<span class="symbol">*</span><span class="symbol">*</span>å¹¶å‘è¯»<span class="symbol">*</span><span class="symbol">*</span>ï¼Œ<span class="symbol">*</span><span class="symbol">*</span>è¯»å†™åˆ†ç¦»<span class="symbol">*</span><span class="symbol">*</span>ã€‚</span><br><span class="line"></span><br><span class="line"><span class="comment">#### å†™æ—¶å¤åˆ¶æœºåˆ¶è¯¦è§£</span></span><br><span class="line"></span><br><span class="line"> ä»¥æ–°å¢ä¸ºä¾‹ï¼š</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>public boolean add(E e) {<br>
synchronized (lock) {<br>
// è·å–æ—§çš„æ•°ç»„<br>
Object[] es = getArray();<br>
int len = es.length;<br>
// æ‹·è´æ–°çš„æ•°ç»„ï¼ˆè¿™é‡Œæ˜¯æ¯”è¾ƒè€—æ—¶çš„æ“ä½œï¼Œä½†ä¸å½±å“å…¶å®ƒè¯»çº¿ç¨‹ï¼‰<br>
es = Arrays.copyOf(es, len + 1);<br>
// åœ¨æ–°æ•°ç»„æœ«å°¾æ·»åŠ å…ƒç´ <br>
es[len] = e;<br>
// ç”¨æ–°æ•°ç»„æ›¿æ¢æ—§æ•°ç»„<br>
setArray(es);<br>
return true;<br>
}<br>
}</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">æ³¨æ„ç‚¹ï¼š</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> å†™æ“ä½œä½¿ç”¨ <span class="code">`synchronized`</span>ï¼ˆJava 11 ç‰ˆæœ¬ï¼‰ï¼Œä¿è¯å†™æ“ä½œä¸²è¡Œã€‚</span><br><span class="line"><span class="bullet">-</span> å¤åˆ¶æ•°ç»„å¼€é”€è¾ƒå¤§ï¼Œä½†<span class="strong">**ä¸ä¼šå½±å“è¯»çº¿ç¨‹**</span>ï¼Œå› ä¸ºè¯»çº¿ç¨‹æ‹¿åˆ°çš„æ˜¯æ—§æ•°ç»„çš„å¼•ç”¨ã€‚</span><br><span class="line"><span class="bullet">-</span> <span class="code">`setArray()`</span> æ˜¯ä¸€ä¸ª <span class="code">`volatile`</span> å†™æ“ä½œï¼Œèƒ½ä¿è¯å†™åå¯¹å…¶å®ƒçº¿ç¨‹å¯è§ã€‚</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1762.png</span>)</span><br><span class="line"></span><br><span class="line">å…¶å®ƒè¯»æ“ä½œå¹¶æœªåŠ é”ï¼Œä¾‹å¦‚ï¼š</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>public void forEach(Consumer&lt;? super E&gt; action) {<br>
Objects.requireNonNull(action);<br>
for (Object x : getArray()) {<br>
@SuppressWarnings(â€œuncheckedâ€) E e = (E) x;<br>
action.accept(e);<br>
}<br>
}</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">é€‚åˆã€è¯»å¤šå†™å°‘ã€çš„åº”ç”¨åœºæ™¯</span><br><span class="line"></span><br><span class="line"><span class="comment">#### å¼±ä¸€è‡´æ€§é—®é¢˜ï¼ˆWeak Consistencyï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##### 1.get å¼±ä¸€è‡´æ€§</span></span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1761.png)</span><br><span class="line"></span><br><span class="line">å‡è®¾ä»¥ä¸‹æ—¶é—´ç‚¹ï¼š</span><br><span class="line"></span><br><span class="line">|<span class="string"> æ—¶é—´ç‚¹                                                  </span>|<span class="string"> æ“ä½œ                                          </span>|</span><br><span class="line">|<span class="string"> ------------------------------------------------------- </span>|<span class="string"> --------------------------------------------- </span>|</span><br><span class="line">|<span class="string"> T1 0æ‹¿æ•°æ®ï¼ˆæ­¤æ—¶è¿˜æ²¡æ‹¿åˆ°ï¼‰                              </span>|<span class="string"> Thread-0 è°ƒç”¨ `getArray()` æ‹¿åˆ°æ—§æ•°ç»„         </span>|</span><br><span class="line">|<span class="string"> T2  æ­¤æ—¶é—´ç‚¹1è¦è°ƒç”¨removeï¼Œå…ˆè¦æ‹·è´                     </span>|<span class="string"> Thread-1 è°ƒç”¨ `getArray()` æ‹¿åˆ°åŒä¸€ä¸ªæ•°ç»„å‰¯æœ¬ </span>|</span><br><span class="line">|<span class="string"> T3 åˆ é™¤å®Œåæ–°å¼•ç”¨æ›¿æ¢æ‰åŸæ¥çš„å¼•ç”¨                       </span>|<span class="string"> Thread-1 æ‰§è¡Œ `setArray()` æ›¿æ¢æˆæ–°æ•°ç»„       </span>|</span><br><span class="line">|<span class="string"> T4 0æ­¤æ—¶æ‹¿åˆ°äº†æ•°æ®å´è¿˜æ˜¯æ—§çš„è¿˜æ˜¯èƒ½æ‹¿åˆ°1è¿™ä¸ªè¢«åˆ é™¤çš„æ•°å­— </span>|<span class="string"> Thread-0 ç»§ç»­ä»æ—§æ•°ç»„ä¸­è¯»å…ƒç´                  </span>|</span><br><span class="line"></span><br><span class="line">&gt; æ­¤æ—¶ Thread-0 è¯»åˆ°çš„æ•°æ®å¯èƒ½æ˜¯æ—§å€¼ï¼Œ<span class="symbol">*</span><span class="symbol">*</span>è¿™å°±æ˜¯å¼±ä¸€è‡´æ€§<span class="symbol">*</span><span class="symbol">*</span>ã€‚</span><br><span class="line">&gt;</span><br><span class="line">&gt; ğŸ“Œ <span class="symbol">*</span><span class="symbol">*</span>è§£é‡Š<span class="symbol">*</span><span class="symbol">*</span>ï¼š</span><br><span class="line">&gt;</span><br><span class="line">&gt; - å¼±ä¸€è‡´æ€§ä¸æ˜¯ bugï¼Œæ˜¯è®¾è®¡ï¼šè¯»æ“ä½œæ€»æ˜¯æ‹¿å½“ä¸‹å¼•ç”¨çš„æ•°ç»„ã€‚</span><br><span class="line">&gt; - ä¸ä¿è¯è¯»åˆ°çš„æ˜¯æœ€æ–°æ•°æ®ï¼Œä½†è¯»æ˜¯å¿«é€Ÿã€å®‰å…¨çš„ã€‚</span><br><span class="line"></span><br><span class="line"><span class="comment">##### 2.è¿­ä»£å™¨å¼±ä¸€è‡´æ€§</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>CopyOnWriteArrayList<Integer> list = new CopyOnWriteArrayList&lt;&gt;();<br>
list.add(1);<br>
list.add(2);<br>
list.add(3);<br>
Iterator<Integer> iter = list.iterator();<br>
new Thread(() -&gt; {<br>
list.remove(0);// è§¦å‘å¤åˆ¶å¹¶æ›¿æ¢æ•°ç»„<br>
System.out.println(list);<br>
}).start();<br>
sleep1s();<br>
//æ­¤æ—¶ä¸»çº¿ç¨‹çš„iteratorä¾æ—§æŒ‡å‘æ—§çš„æ•°ç»„ã€‚<br>
while (iter.hasNext()) {<br>
System.out.println(iter.next());// ä¾æ—§éå†æ—§æ•°ç»„<br>
}</p>
<pre><code>
ç»“è®ºï¼š

- è¯»çš„æ˜¯æ—§æ•°æ®ï¼Œä½†**è¯»çš„è¡Œä¸ºæ˜¯å®‰å…¨çš„**ã€‚
- `iter` æ‹¿åˆ°çš„æ˜¯æ—§æ•°ç»„çš„å¿«ç…§ã€‚
- ä¸»çº¿ç¨‹ä¸ä¼šæŠ¥ `ConcurrentModificationException`ã€‚

![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1763.png)

#### ä¼˜ç¼ºç‚¹æ€»ç»“

| ä¼˜ç‚¹                 | è¯´æ˜                                   |
| -------------------- | -------------------------------------- |
| è¯»æ“ä½œæ— é”ï¼Œæ€§èƒ½é«˜   | æ‰€æœ‰è¯»å–æ“ä½œç›´æ¥è¯»æ•°ç»„                 |
| ä¸ä¼šå‡ºç°å¹¶å‘ä¿®æ”¹å¼‚å¸¸ | ä¸æŠ› `ConcurrentModificationException` |
| éé˜»å¡è¯»             | å†™ä¸å½±å“è¯»                             |
| ç®€å•æ˜“ç”¨             | çº¿ç¨‹å®‰å…¨ï¼Œä¸ä¾èµ–å¤æ‚æœºåˆ¶               |

| ç¼ºç‚¹         | è¯´æ˜                     |
| ------------ | ------------------------ |
| å†™æ“ä½œå¼€é”€å¤§ | æ¯æ¬¡å†™æ“ä½œéƒ½å¤åˆ¶æ•´ä¸ªæ•°ç»„ |
| å ç”¨å†…å­˜     | å†™é¢‘ç¹æ—¶æ—§æ•°ç»„ä¸å®¹æ˜“å›æ”¶ |
| ä¸€è‡´æ€§å¼±     | è¯»å–æ“ä½œè¯»åˆ°çš„ä¸æ˜¯æœ€æ–°å€¼ |

![img](https://www.legendkiller.xyz/wp-content/uploads/2025/07/image-1764.png)

# ä¸‹ç¯‡å®Œç»“</code></pre>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>JUCå¹¶å‘ç¼–ç¨‹ä¸‹ç¯‡</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://itgeqian.github.io/posts/29.html">https://itgeqian.github.io/posts/29.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>ä½œè€…</h><div class="post-copyright-cc-info"><h>geqian's BlogğŸ­</h></div></div><div class="post-copyright-c"><h>å‘å¸ƒäº</h><div class="post-copyright-cc-info"><h>2025-08-01</h></div></div><div class="post-copyright-u"><h>æ›´æ–°äº</h><div class="post-copyright-cc-info"><h>2025-08-03</h></div></div><div class="post-copyright-c"><h>è®¸å¯åè®®</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/JUC/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>JUC</a></div></div><link rel="stylesheet" href="/css/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">æŠ•å–‚ä½œè€…</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://java-geqian.oss-cn-beijing.aliyuncs.com/%E5%BE%AE%E4%BF%A1PAY.jpg" target="_blank"><img class="post-qr-code-img" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/%E5%BE%AE%E4%BF%A1PAY.jpg" alt="å¾®ä¿¡"/></a><div class="post-qr-code-desc">å¾®ä¿¡</div></li><li class="reward-item"><a href="https://java-geqian.oss-cn-beijing.aliyuncs.com/%E6%94%AF%E4%BB%98%E5%AE%9DPAY.jpg" target="_blank"><img class="post-qr-code-img" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/%E6%94%AF%E4%BB%98%E5%AE%9DPAY.jpg" alt="æ”¯ä»˜å®"/></a><div class="post-qr-code-desc">æ”¯ä»˜å®</div></li></ul></div></button></div><audio id="coinAudio" src="https://npm.elemecdn.com/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/js/coin.js"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/43.html"><img class="prev-cover" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">GQ Videoé¡¹ç›®ä¼˜åŒ–è®°å½•</div></div></a></div><div class="next-post pull-right"><a href="/posts/28.html"><img class="next-cover" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">JUCå¹¶å‘ç¼–ç¨‹ä¸­ç¯‡</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/posts/27.html" title="JUCå¹¶å‘ç¼–ç¨‹ä¸Šç¯‡"><img class="cover" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2025-07-28</div><div class="title">JUCå¹¶å‘ç¼–ç¨‹ä¸Šç¯‡</div></div></a></div><div><a href="/posts/28.html" title="JUCå¹¶å‘ç¼–ç¨‹ä¸­ç¯‡"><img class="cover" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2025-08-01</div><div class="title">JUCå¹¶å‘ç¼–ç¨‹ä¸­ç¯‡</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><svg class="meta_icon" style="width:22px;height:22px;position:relative;top:5px"><use xlink:href="#icon-mulu1"></use></svg><span style="font-weight:bold">ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%8B%E7%AF%87"><span class="toc-text">ä¸‹ç¯‡</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B%E4%B9%8B%E5%B7%A5%E5%85%B7"><span class="toc-text">8.å…±äº«æ¨¡å‹ä¹‹å·¥å…·</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-text">8.1çº¿ç¨‹æ± </span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E8%BF%B0"><span class="toc-text">åŸºæœ¬æ¦‚è¿°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-text">ä¸€ã€è‡ªå®šä¹‰çº¿ç¨‹æ± </span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%88%9B%E5%BB%BA%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%92%8C%E6%96%B9%E6%B3%95"><span class="toc-text">1.åˆ›å»ºåŸºæœ¬ç±»å’Œæ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%B8%A6%E8%B6%85%E6%97%B6%E7%9A%84%E9%98%BB%E5%A1%9E%E8%8E%B7%E5%8F%96"><span class="toc-text">2.å¸¦è¶…æ—¶çš„é˜»å¡è·å–</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E4%B8%8B%E9%9D%A2%E6%98%AF%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A1%86%E6%9E%B6%EF%BC%9A"><span class="toc-text">3.ä¸‹é¢æ˜¯çº¿ç¨‹æ± çš„åŸºæœ¬æ¡†æ¶ï¼š</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E5%AE%8C%E5%96%84%E4%BB%BB%E5%8A%A1%E6%8F%90%E4%BA%A4-Worker%E5%AE%9E%E7%8E%B0"><span class="toc-text">4.å®Œå–„ä»»åŠ¡æäº¤ Workerå®ç°</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-%E5%BD%93%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97%E5%B7%B2%E6%BB%A1"><span class="toc-text">5.å½“ä»»åŠ¡é˜Ÿåˆ—å·²æ»¡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-offer%E5%A2%9E%E5%BC%BA"><span class="toc-text">6. offerå¢å¼º</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-%E6%8B%92%E7%BB%9D%E7%AD%96%E7%95%A5"><span class="toc-text">7.æ‹’ç»ç­–ç•¥</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E3%80%81JDK%E4%B8%BA%E6%88%91%E4%BB%AC%E6%8F%90%E4%BE%9B%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%B1%A0ThreadPoolExecutor"><span class="toc-text">äºŒã€JDKä¸ºæˆ‘ä»¬æä¾›çš„çº¿ç¨‹æ± ThreadPoolExecutor</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%8A%B6%E6%80%81"><span class="toc-text">1.çº¿ç¨‹æ± çŠ¶æ€</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-text">2.æ„é€ æ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F"><span class="toc-text">3.å·¥ä½œæ–¹å¼</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-Executors-%E5%9B%BA%E5%AE%9A%E5%A4%A7%E5%B0%8F%E7%BA%BF%E7%A8%8B%E6%B1%A0newFixedThreadPool"><span class="toc-text">4.Executors å›ºå®šå¤§å°çº¿ç¨‹æ± newFixedThreadPool</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-Executors-%E5%B8%A6%E7%BC%93%E5%86%B2%E7%BA%BF%E7%A8%8B%E6%B1%A0newCachedThreadPool"><span class="toc-text">5. Executors å¸¦ç¼“å†²çº¿ç¨‹æ± newCachedThreadPool</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#6-Executors-%E5%8D%95%E7%BA%BF%E7%A8%8B%E7%BA%BF%E7%A8%8B%E6%B1%A0newSingleThreadExecutor"><span class="toc-text">6.Executors å•çº¿ç¨‹çº¿ç¨‹æ± newSingleThreadExecutor</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%80%BB%E7%BB%93Executors-%E5%B7%A5%E5%8E%82%E7%B1%BB%E6%8F%90%E4%BE%9B%E7%9A%84%E4%B8%89%E7%A7%8D%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%B7%A5%E5%85%B7%E6%96%B9%E6%B3%95"><span class="toc-text">æ€»ç»“Executors å·¥å‚ç±»æä¾›çš„ä¸‰ç§çº¿ç¨‹æ± å·¥å…·æ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#7-ThreadPoolExecutor-%E4%B8%AD%E4%BB%BB%E5%8A%A1%E7%9A%84%E6%8F%90%E4%BA%A4%E6%96%B9%E6%B3%95%EF%BC%88submit-invokeAll-invokeAny%EF%BC%89"><span class="toc-text">7.ThreadPoolExecutor ä¸­ä»»åŠ¡çš„æäº¤æ–¹æ³•ï¼ˆsubmit&#x2F;invokeAll&#x2F;invokeAnyï¼‰</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#8-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%85%B3%E9%97%AD%E6%9C%BA%E5%88%B6"><span class="toc-text">8.çº¿ç¨‹æ± å…³é—­æœºåˆ¶</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#9-%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-text">9.ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ± </span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#10-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B8%AD%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E5%A4%84%E7%90%86%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B%E4%B8%AD%E5%8F%91%E7%94%9F%E7%9A%84%E5%BC%82%E5%B8%B8"><span class="toc-text">10.çº¿ç¨‹æ± ä¸­å¦‚ä½•æ­£ç¡®å¤„ç†ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿçš„å¼‚å¸¸</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#11-%E5%BA%94%E7%94%A8%E4%B9%8B%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-text">11.åº”ç”¨ä¹‹å®šæ—¶ä»»åŠ¡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#12-Tomcat-%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-text">12.Tomcat çº¿ç¨‹æ± </span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89%E3%80%81Fork-Join"><span class="toc-text">ä¸‰ã€Fork&#x2F;Join</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-Fork-Join%E6%A6%82%E5%BF%B5"><span class="toc-text">1.Fork&#x2F;Joinæ¦‚å¿µ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E5%BA%94%E7%94%A8%E4%B9%8B%E6%B1%82%E5%92%8C"><span class="toc-text">2.åº”ç”¨ä¹‹æ±‚å’Œ</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A5%E5%85%85%EF%BC%9A%E5%BC%82%E6%AD%A5%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%B7%A5%E4%BD%9C%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%BC%8F"><span class="toc-text">è¡¥å……ï¼šå¼‚æ­¥æ¨¡å¼ä¹‹å·¥ä½œçº¿ç¨‹æ¨¡å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%BB%80%E4%B9%88%E6%98%AF-Worker-Thread-%E6%A8%A1%E5%BC%8F%EF%BC%9F"><span class="toc-text">1.ä»€ä¹ˆæ˜¯ Worker Thread æ¨¡å¼ï¼Ÿ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E9%A5%A5%E9%A5%BF%E9%97%AE%E9%A2%98%EF%BC%88Deadlock-like-starvation%EF%BC%89"><span class="toc-text">2.é¥¥é¥¿é—®é¢˜ï¼ˆDeadlock-like starvationï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%9A%E4%BB%BB%E5%8A%A1%E5%88%86%E7%B1%BB%EF%BC%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%88%86%E5%B7%A5"><span class="toc-text">3.è§£å†³æ–¹æ¡ˆï¼šä»»åŠ¡åˆ†ç±»ï¼Œçº¿ç¨‹æ± åˆ†å·¥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%A4%A7%E5%B0%8F%E5%A6%82%E4%BD%95%E8%AE%BE%E7%BD%AE%E6%9C%80%E5%90%88%E9%80%82%EF%BC%9F"><span class="toc-text">4.çº¿ç¨‹æ± å¤§å°å¦‚ä½•è®¾ç½®æœ€åˆé€‚ï¼Ÿ</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2JUC"><span class="toc-text">8.2JUC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-AQS%E5%8E%9F%E7%90%86"><span class="toc-text">1.AQSåŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-text">æ¦‚è¿°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%8D%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">è‡ªå®šä¹‰ä¸å¯é‡å…¥é”å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E8%87%AA%E5%AE%9A%E4%B9%89%E5%90%8C%E6%AD%A5%E5%99%A8-MySync-%E7%BB%A7%E6%89%BF-AQS%EF%BC%9A"><span class="toc-text">é€šè¿‡è‡ªå®šä¹‰åŒæ­¥å™¨ MySync ç»§æ‰¿ AQSï¼š</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%94%81"><span class="toc-text">è‡ªå®šä¹‰é”</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AQS-%E9%98%9F%E5%88%97%E6%A8%A1%E5%9E%8B%EF%BC%88%E5%9F%BA%E4%BA%8E-CLH%EF%BC%89"><span class="toc-text">AQS é˜Ÿåˆ—æ¨¡å‹ï¼ˆåŸºäº CLHï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87"><span class="toc-text">ç›®æ ‡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BE%E8%AE%A1"><span class="toc-text">è®¾è®¡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E7%94%A8%E5%88%B0-AQS-%E7%9A%84%E5%B9%B6%E5%8F%91%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-text">ä¸»è¦ç”¨åˆ° AQS çš„å¹¶å‘å·¥å…·ç±»</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-ReentrantLock-%E5%8E%9F%E7%90%86"><span class="toc-text">2.ReentrantLock åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%81%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">éå…¬å¹³é”å®ç°åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A0%E9%94%81%E8%A7%A3%E9%94%81%E6%B5%81%E7%A8%8B"><span class="toc-text">åŠ é”è§£é”æµç¨‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8A%A0%E9%94%81%E6%BA%90%E7%A0%81"><span class="toc-text">åŠ é”æºç </span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E9%94%81%E6%BA%90%E7%A0%81"><span class="toc-text">è§£é”æºç </span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%9D%9E%E5%85%AC%E5%B9%B3%E6%80%A7%E4%BD%93%E7%8E%B0%E5%9C%A8%E5%93%AA%EF%BC%9F"><span class="toc-text">éå…¬å¹³æ€§ä½“ç°åœ¨å“ªï¼Ÿ</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%AF%E9%87%8D%E5%85%A5%E5%8E%9F%E7%90%86"><span class="toc-text">å¯é‡å…¥åŸç†</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%AF%E6%89%93%E6%96%AD%E5%8E%9F%E7%90%86"><span class="toc-text">å¯æ‰“æ–­åŸç†</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%AC%E5%B9%B3%E9%94%81%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">å…¬å¹³é”å®ç°åŸç†</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8FCondition%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">æ¡ä»¶å˜é‡Conditionå®ç°åŸç†</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%AF%BB%E5%86%99%E9%94%81%E4%B9%8BReentrantReadWriteLock"><span class="toc-text">3.è¯»å†™é”ä¹‹ReentrantReadWriteLock</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ReentrantReadWriteLock%E4%BB%8B%E7%BB%8D"><span class="toc-text">ReentrantReadWriteLockä»‹ç»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ReentrantReadWriteLock%E5%BA%94%E7%94%A8%E5%88%B0%E7%BC%93%E5%AD%98"><span class="toc-text">ReentrantReadWriteLockåº”ç”¨åˆ°ç¼“å­˜</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5"><span class="toc-text">ç¼“å­˜æ›´æ–°ç­–ç•¥</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-ReentrantReadWriteLock-%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-text">ä½¿ç”¨ ReentrantReadWriteLock å®ç°ç¼“å­˜ä¸€è‡´æ€§</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ReentrantReadWriteLock%E5%8E%9F%E7%90%86"><span class="toc-text">ReentrantReadWriteLockåŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9B%BE%E8%A7%A3%E6%B5%81%E7%A8%8B"><span class="toc-text">å›¾è§£æµç¨‹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">æºç åˆ†æ</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-color: transparent;"><div id="footer-wrap"><div id="ft"><div class="ft-item-1"><div class="t-top"><div class="t-t-l"><p class="ft-t t-l-t">æ ¼è¨€ğŸ§¬</p><div class="bg-ad"><div>å†çœ‹çœ‹é‚£ä¸ªå…‰ç‚¹ï¼Œå®ƒå°±åœ¨è¿™é‡Œï¼Œè¿™æ˜¯å®¶å›­ï¼Œè¿™æ˜¯æˆ‘ä»¬ â€”â€” ä½ æ‰€çˆ±çš„æ¯ä¸€ä¸ªäººï¼Œä½ è®¤è¯†çš„ä¸€ä¸ªäººï¼Œä½ å¬è¯´è¿‡çš„æ¯ä¸€ä¸ªäººï¼Œæ›¾ç»æœ‰è¿‡çš„æ¯ä¸€ä¸ªäººï¼Œéƒ½åœ¨å®ƒä¸Šé¢åº¦è¿‡ä»–ä»¬çš„ä¸€ç”Ÿâœ¨</div><div class="btn-xz-box"><a class="btn-xz" target="_blank" rel="noopener" href="https://stellarium.org/">ç‚¹å‡»å¼€å¯æ˜Ÿè¾°ä¹‹æ—…</a></div></div></div><div class="t-t-r"><p class="ft-t t-l-t">çŒœä½ æƒ³çœ‹ğŸ’¡</p><ul class="ft-links"><li><a href="/comments/">ç•™ç‚¹ä»€ä¹ˆ</a><a href="/archives/">æ–‡ç« å½’æ¡£</a></li><li><a href="/categories/">æ–‡ç« åˆ†ç±»</a><a href="/tags/">æ–‡ç« æ ‡ç­¾</a></li><li><a href="/box/Gallery/">æˆ‘çš„ç”»å»Š</a><a href="/personal/bb/">æˆ‘çš„å” å¨</a></li><li><a href="/site/time/">å»ºè®¾è¿›ç¨‹</a><a href="/site/census/">ç½‘ç«™ç»Ÿè®¡</a></li></ul></div></div></div><div class="ft-item-2"><p class="ft-t">æ¨èå‹é“¾âŒ›</p><div class="ft-img-group"><div class="img-group-item"></div></div></div></div><div class="copyright"><span><b>&copy;2022-2025</b></span><span><b>&nbsp;&nbsp;By geqian's BlogğŸ­</b></span></div><div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=20230913" style="margin-inline:5px" title="æœ¬ç«™å·²åŠ å…¥èŒICPè±ªåå¥—é¤ï¼ŒèŒICPå¤‡20230913å·"><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/20230913.svg" alt=""/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button><button class="share" type="button" title="å³é”®æ¨¡å¼" onclick="changeMouseMode()"><i class="fas fa-mouse"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog right_side"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button class="share" type="button" title="åˆ†äº«é“¾æ¥" onclick="share()"><i class="fas fa-share-nodes"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button><button id="go-down" type="button" title="ç›´è¾¾åº•éƒ¨" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>å¤åˆ¶</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>ç™¾åº¦æœç´¢</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>ç²˜è´´</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span>ç©ºé™è¯„è®º</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>å¤åˆ¶æœ¬æ–‡åœ°å€</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>ä¿å­˜å›¾ç‰‡</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>åœ¨æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶å›¾ç‰‡é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:randomPost()"><i class="fa fa-paper-plane"></i><span>éšä¾¿é€›é€›</span></a><a class="rightMenu-item" href="javascript:switchNightMode();"><i class="fa fa-moon"></i><span>æ˜¼å¤œåˆ‡æ¢</span></a><a class="rightMenu-item" href="/personal/about/"><i class="fa fa-info-circle"></i><span>å…³äºåšå®¢</span></a><a class="rightMenu-item" href="javascript:toggleWinbox();"><i class="fas fa-cog"></i><span>ç¾åŒ–è®¾ç½®</span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span>åˆ‡æ¢å…¨å±</span></a><a class="rightMenu-item" href="javascript:window.print();"><i class="fa-solid fa-print"></i><span>æ‰“å°é¡µé¢</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000);
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: '',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: '',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.staticfile.org/twikoo/1.6.8/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script async src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script defer type="text/javascript" src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer src="https://cdn1.tianli0.top/gh/nextapps-de/winbox/dist/winbox.bundle.min.js"></script><script async src="//at.alicdn.com/t/c/font_3586335_hsivh70x0fm.js"></script><script async src="//at.alicdn.com/t/c/font_3636804_gr02jmjr3y9.js"></script><script async src="//at.alicdn.com/t/c/font_3612150_kfv55xn3u2g.js"></script><script async src="https://cdn.wpon.cn/2022-sucai/Gold-ingot.js"></script><canvas id="universe"></canvas><canvas id="snow"></canvas><script defer src="/js/fomal.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn1.tianli0.top/npm/js-heo@1.0.12/metingjs/Meting.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#web_bg",".js-pjax","#bibi","body > title","#app","#tag-echarts","#posts-echart","#categories-echarts"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/å­¦ä¹ ç¬”è®°/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¡ geqianã®å­¦ä¹ ç¬”è®° (10)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/æ‚é¡¹/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¼ geqianã®æ‚é¡¹ (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/é¡¹ç›®/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ‰ geqianã®é¡¹ç›®ç¬”è®° (6)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/AI/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¨ geqianã®AIå¤§æ¨¡å‹ (6)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/ç®—æ³•/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸŸ geqianã®ç®—æ³•å­¦ä¹ ç¬”è®° (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/é¢è¯•/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¥ geqianã®é¢è¯• (4)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/JUC/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸŒ geqianã®JUC (4)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/JVM/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸœ geqianã®JVM (5)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/äº‘åŸç”Ÿ/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ” geqianã®äº‘åŸç”Ÿç›¸å…³ (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/MQ/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ“± geqianã®æ¶ˆæ¯é˜Ÿåˆ— (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/å‰ç«¯/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ›ï¸ geqianã®å‰ç«¯å·¥ç¨‹ (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/mybatis-mybatis-plus/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¨ geqianã®mybatisç³»åˆ— (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/å¾®æœåŠ¡/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ—ºï¸ geqianã®SpringCloudç³»åˆ— (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/SSM/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ“– geqianã®SSM+SpringBootç³»åˆ— (7)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/ruoyi/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ“ geqianã®è‹¥ä¾æ¡†æ¶ (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/mysql/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">â“ geqianã®mysql (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/Redis/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ’– geqianã®Redis (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item" style="visibility: hidden"></div><a class="magnet_link_more"  href="https://itgeqian.github.io/categories/" style="flex:1;text-align: center;margin-bottom: 10px;">æŸ¥çœ‹æ›´å¤š...</a></div></div>';
    console.log('å·²æŒ‚è½½magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(33.333333333333336% - 5px);background: #e9e9e9;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: var(--text-bg-hover)}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/1.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-05-20</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/1.html&quot;);" href="javascript:void(0);" alt="">å®éªŒä¸‰ æ±½è½¦ç§Ÿèµç³»ç»Ÿçš„UMLè®¾è®¡å»ºæ¨¡ ï¼ˆå®Œç»“ï¼‰</a><div class="blog-slider__text">å…³äºæ±½è½¦ç§Ÿèµç³»ç»Ÿçš„UMLè®¾è®¡å»ºæ¨¡</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/1.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/2.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-10-06</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/2.html&quot;);" href="javascript:void(0);" alt="">GQ Videoé¡¹ç›®éƒ¨ç½²</a><div class="blog-slider__text">å¾®æœåŠ¡é¡¹ç›®GQ Videoé¡¹ç›®éƒ¨ç½²</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/2.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('å·²æŒ‚è½½butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper@1.0.12/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper@1.0.12/lib/swiper_init.js"></script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('gitZone');
      var item_html = '<div class="recent-post-item" id="gitcalendarBar" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 320px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('å·²æŒ‚è½½gitcalendar')
      }

    if( document.getElementById('gitZone') && (location.pathname ==='/site/census/'|| '/site/census/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("/api?null",['#d9e0df', '#c6e0dc', '#a8dcd4', '#9adcd2', '#89ded1', '#77e0d0', '#5fdecb', '#47dcc6', '#39dcc3', '#1fdabe', '#00dab9'],'null')
    }
  </script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>