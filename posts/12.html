<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><div id="myscoll"></div><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>速通SpringCloud微服务 | geqian's Blog🍭</title><meta name="keywords" content="微服务"><meta name="author" content="geqian's Blog🍭"><meta name="copyright" content="geqian's Blog🍭"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="尚硅谷速通SpringCloud微服务学习笔记（nacos+openfeign+sentinel+gateway+seata）">
<meta property="og:type" content="article">
<meta property="og:title" content="速通SpringCloud微服务">
<meta property="og:url" content="https://itgeqian.github.io/posts/12.html">
<meta property="og:site_name" content="geqian&#39;s Blog🍭">
<meta property="og:description" content="尚硅谷速通SpringCloud微服务学习笔记（nacos+openfeign+sentinel+gateway+seata）">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp">
<meta property="article:published_time" content="2025-06-15T01:19:03.000Z">
<meta property="article:modified_time" content="2025-06-25T09:12:00.000Z">
<meta property="article:author" content="geqian&#39;s Blog🍭">
<meta property="article:tag" content="微服务">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp"><link rel="shortcut icon" href="/"><link rel="canonical" href="https://itgeqian.github.io/posts/12"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '速通SpringCloud微服务',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-06-25 17:12:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><style id="themeColor"></style><style id="rightSide"></style><style id="transPercent"></style><style id="blurNum"></style><style id="settingStyle"></style><span id="fps"></span><style id="defineBg"></style><style id="menu_shadow"></style><script src="https://cdn.jsdelivr.net/npm/echarts@6/dist/echarts.min.js"></script><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper@1.0.12/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper@1.0.12/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="geqian's Blog🍭" type="application/atom+xml">
</head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/assets/avatar.png" onerror="onerror=null;src='/assets/r1.jpg'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">81</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">51</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">18</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> 首页</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> 休闲</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> 八音盒</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> 影院</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> 游戏</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xiangzi"></use></svg><span class="menu_word" style="font-size:17px"> 八宝箱</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-tubiaozhizuomoban">                   </use></svg><span class="menu_word" style="font-size:17px"> 画廊</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-nvwumao">                   </use></svg><span class="menu_word" style="font-size:17px"> 动画</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche">                   </use></svg><span class="menu_word" style="font-size:17px"> 网址导航</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> 社交</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> 网站</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> 网站统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> 文章统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> 旧时光</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">geqian's Blog🍭</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> 首页</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> 休闲</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> 八音盒</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> 影院</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> 游戏</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xiangzi"></use></svg><span class="menu_word" style="font-size:17px"> 八宝箱</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-tubiaozhizuomoban">                   </use></svg><span class="menu_word" style="font-size:17px"> 画廊</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-nvwumao">                   </use></svg><span class="menu_word" style="font-size:17px"> 动画</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche">                   </use></svg><span class="menu_word" style="font-size:17px"> 网址导航</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> 社交</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> 留言板</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> 友人帐</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> 网站</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> 网站统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> 文章统计</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> 旧时光</span></a></li></ul></div></div><center id="name-container"><a id="page-name" href="javascript:scrollToTop()">PAGE_NAME</a></center><div id="nav-right"><div id="search-button"><a class="search faa-parent animated-hover" title="检索站内任何你想要的信息"><svg class="faa-tada icon" style="height:24px;width:24px;fill:currentColor;position:relative;top:6px" aria-hidden="true"><use xlink:href="#icon-valentine_-search-love-find-heart"></use></svg><span> 搜索</span></a></div><a class="meihua faa-parent animated-hover" onclick="toggleWinbox()" title="美化设置-自定义你的风格" id="meihua-button"><svg class="faa-tada icon" style="height:26px;width:26px;fill:currentColor;position:relative;top:8px" aria-hidden="true"><use xlink:href="#icon-tupian1"></use></svg></a><a class="sun_moon faa-parent animated-hover" onclick="switchNightMode()" title="浅色和深色模式转换" id="nightmode-button"><svg class="faa-tada" style="height:25px;width:25px;fill:currentColor;position:relative;top:7px" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon">       </use></svg></a><div id="toggle-menu"><a><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-info"><h1 class="post-title">速通SpringCloud微服务</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><svg class="meta_icon post-meta-icon" style="width:30px;height:30px;position:relative;top:10px"><use xlink:href="#icon-rili"></use></svg><span class="post-meta-label">发表于 </span><time class="post-meta-date-created" datetime="2025-06-15T01:19:03.000Z" title="发表于 2025-06-15 09:19:03">2025-06-15</time><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-gengxin1"></use></svg><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-06-25T09:12:00.000Z" title="更新于 2025-06-25 17:12:00">2025-06-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-biaoqian"></use></svg><a class="post-meta-categories" href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:8px"><use xlink:href="#icon-charuword"></use></svg><span class="post-meta-label">字数总计:</span><span class="word-count">1.9w</span><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:20px;height:20px;position:relative;top:5px"><use xlink:href="#icon-shizhong"></use></svg><span class="post-meta-label">阅读时长:</span><span>70分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="速通SpringCloud微服务"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:5px"><use xlink:href="#icon-eye"></use></svg><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-527-1024x537.png" alt="img"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>了解单体架构，集群架构，分布式架构</p>
<h2 id="单体架构"><a href="#单体架构" class="headerlink" title="单体架构"></a>单体架构</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-528-1024x501.png" alt="img"></p>
<ul>
<li>域名：IP地址好记的名字</li>
<li>IP：在互联网上任何设备都是通过IP进行访问的</li>
<li>节点：一个服务器代表一个节点</li>
<li>在服务器节点上可以部署我们开发的应用与数据库</li>
</ul>
<p>单体架构</p>
<ul>
<li>优点：开发部署简单</li>
<li>缺点：单体架构性能有限，无法应对高并发</li>
</ul>
<h2 id="集群架构"><a href="#集群架构" class="headerlink" title="集群架构"></a>集群架构</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-529-1024x962.png" alt="img"></p>
<ul>
<li>副本：是项目的复制品</li>
<li>集群：多个节点服务器构成了集群</li>
<li>网关（Nginx）：网关并不能真正的处理业务请求，它的作用是把收来的所有请求转给下边真正能处理业务的服务器，网关是所有请求流量的入口</li>
<li>路由：网关要完成的功能</li>
<li>负载均衡：网关路由时通过负载均衡的算法，把请求的流量均摊给这些服务器</li>
<li>数据库请求多了一个数据库也是扛不住的，因此也需要数据库集群</li>
<li>扩容与缩容：如果并发流量继续增大，就可以对服务器再进行扩容。如果大并发访问已经过去了，多购买的服务器可以释放掉，节省资源，这便是缩容。</li>
<li>集群架构是解决大并发问题</li>
</ul>
<p>集群架构存在的问题？</p>
<p>1.模块化升级问题—例如一个订单功能，我们经常需要升级，即V1.0,V2.0,V3.0，如果想要把新的订单版本部署到服务器就需要对整个项目重新打包，然后把所有服务器的这些项目全部下线，然后重新部署。也就是说模块化升级会导致牵一发而动全身</p>
<p>2.多语言团队问题—有一天我们在这个项目中引入了直播功能，直播功能需要流媒体相关技术，而Java语言在这方面不专长，要用C++来开发，因此直播功能的调用就不能像以前java项目那样搞一个jar包来掉它的方法，这涉及到了多语言团队如何分工协作的问题</p>
<h2 id="分布式架构"><a href="#分布式架构" class="headerlink" title="分布式架构"></a>分布式架构</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-530-1024x496.png" alt="img"></p>
<ul>
<li>微服务：将项目应用拆分出来的每一个小应用称为微服务，每一个微服务可以独立部署</li>
<li>不仅应用可以拆分，数据库也可以，每一个微服务要做自己的业务只需要连接上对应的数据库即可，这样就做到了每一个微服务还能数据隔离，同时做到了每一个微服务是与语言无关的， 不同的小应用可以用不用的语言来开发。<strong>独立部署，数据隔离，语言无关</strong>，这便体现出微服务的自治（自己治理自己，自己管理自己）</li>
<li>分布式架构下每一个服务器不再部署完整的应用，而是部署应用拆分出来的每一个微服务</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-531-1024x505.png" alt="img"></p>
<ul>
<li>不推荐把所有的副本文件部署到同一个服务器中，容易出现<strong>单点故障</strong>，当这个服务器宕机，整个应用将无法提供完整的服务（鸡蛋不能放在一个篮子里）</li>
<li>远程调用：如果用户需要调用订单请求，但由于它们不是在同一台服务器中，这时候用户需要发送一个HTTP请求，订单给用户返回JSON数据，即<strong>远程调用</strong>（Remote Procedure Call  简称RPC），HTTP+JSON只是RPC的一种方式</li>
<li>用户是如何知道0.6服务器里有订单业务，如果哪天0.6服务器宕机了，用户又如何知道0.5服务器也有订单业务并重连0.5服务器呢，这便要基于两个机制：<strong>服务发现与服务注册</strong>，这两个功能一般由一个组件叫<strong>注册中心</strong>来提供</li>
<li>服务注册：如果某一个微服务部署到服务器上线了，它就会连上注册中心把自己的信息提供给注册中心（上下线消息）</li>
<li>服务发现:在远程调用之前，需要发现对方在哪，注册中心根据服务注册的清单给发起者返回信息告诉它对方在哪个服务器中</li>
<li>经过了服务发现后，发起者知道了需求的业务在哪些服务器中，就可以利用负载均衡的思想，把请求分摊给不同的服务器中</li>
<li>配置中心：一般的注册中心还有另一个功能，可以作为配置中心，我们希望每一个微服务可以将自己的配置保存到配置中心里边来，由配置中心统一管理这些配置，这样一来，改配置时，只需在配置中心里修改，修改后的配置由配置中心主动推送给指定的这个微服务（推送配置的变更）</li>
<li>服务熔断：一个微服务的卡顿会导致整个调用链的卡顿，一个人的卡顿导致百万的并发请求全部积压到这个卡顿的服务器，请求量持续加大导致服务器资源耗尽，最终导致<strong>服务雪崩</strong>，要解决服务雪崩的问题就需要引入服务熔断</li>
<li>服务熔断是一种快速失败机制，快速失败及时释放掉这些资源，就不会导致服务器资源耗尽</li>
</ul>
<p>理解一下什么是分布式？</p>
<p>答：一个大型应用被拆分成很多小应用分步部署在各个机器；每个服务器里边都跑一点小模块，最终形成了一个整体应用</p>
<p>区别一下分布式和集群的概念？</p>
<p>答：</p>
<ul>
<li>分布式是把大应用拆分为小应用，分步部署在各个机器，各个机器上的小应用可能不同，<strong>分布式是一种工作方式/架构方式</strong></li>
<li>集群：只要是一堆机器我们都可以叫集群，这一堆机器干的是同一件事，部署的是同一个应用，<strong>集群是一种物理形态</strong></li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-532-1024x855.png" alt="img"></p>
<p>流程介绍：如果用户需要查询订单的业务，网关配置了一个规则查询/order开头的业务，网关就会把这个请求转给和订单所在的服务器，但网关自己不知道订单在哪些服务器，因此在请求之前网关会问注册中心订单在哪，知道在哪后才会把请求往下转，转下去的请求由微服务自行处理即可，处理期间要操作数据库，就连上自己的数据库去操作，但操作时可能出现一个问题：例如用户下单物品成功后会加积分，订单存在订单库，积分存在用户库，这两个操作涉及到了事务，只有下单成功了才加积分，但在分布式架构中牵扯到多个数据库，每一个数据库都可能在不同服务器，在分布式里还要解决一个常见的问题：<strong>分布式事务</strong></p>
<h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><p>要做微服务可以用SpirngBoot快速创建出一个微服务，要做注册中心和配置中心，就用Spring Cloud Alibaba Nacos ，网关的实现用Spring Cloud Gateway,远程调用就要用到Spring Cloud OpenFeign这个组件，服务熔断就要用Spring Cloud Alibaba Sentinel，分布式事务就要用到Spring Cloud Alibaba Seata</p>
<h1 id="1-分布式基础"><a href="#1-分布式基础" class="headerlink" title="1.分布式基础"></a>1.分布式基础</h1><h2 id="1-1微服务"><a href="#1-1微服务" class="headerlink" title="1.1微服务"></a>1.1微服务</h2><p>微服务架构⻛格，就像是把⼀个单独的应⽤程序开发为⼀套⼩服务，每个⼩服务运⾏在⾃⼰的进程<br>中，并使⽤轻量级机制通信，通常是 HTTP API。这些服务围绕业务能⼒来构建， 并通过完全⾃<br>动化部署机制来独⽴部署。这些服务使⽤不同的编程语⾔书写，以及不同数据存储技术，并保持最<br>低限度的集中式管理。<br>简⽽⾔之：拒绝⼤型单体应⽤，基于业务边界进⾏服务微化拆分，各个服务独⽴部署运⾏</p>
<h2 id="1-2-集群-amp-分布式-amp-节点"><a href="#1-2-集群-amp-分布式-amp-节点" class="headerlink" title="1.2.集群&amp;分布式&amp;节点"></a>1.2.集群&amp;分布式&amp;节点</h2><p>集群是个物理形态，分布式是个⼯作⽅式。<br>只要是⼀堆机器，就可以叫集群，他们是不是⼀起协作着⼲活，这个谁也不知道；</p>
<p>《分布式系统原理与范型》定义：</p>
<ul>
<li>“分布式系统是若⼲独⽴计算机的集合，这些计算机对于⽤户来说就像单个相关系统”</li>
<li>分布式系统（distributed system）是建⽴在⽹络之上的软件系统。</li>
<li>分布式是指将不同的业务分布在不同的地⽅。</li>
<li>集群指的是将⼏台服务器集中在⼀起，实现同⼀业务。</li>
</ul>
<p>例如：京东是⼀个分布式系统，众多业务运⾏在不同的机器，所有业务构成⼀个⼤型的业务集群。<br>每⼀个⼩的业务，⽐如⽤户系统，访问压⼒⼤的时候⼀台服务器是不够的。我们就应该将⽤户系统<br>部署到多个服务器，也就是每⼀个业务系统也可以做集群化；<br>分布式中的每⼀个节点，都可以做集群。 ⽽集群并不⼀定就是分布式的。<br>节点：集群中的⼀个服务器</p>
<h2 id="1-3远程调⽤"><a href="#1-3远程调⽤" class="headerlink" title="1.3远程调⽤"></a>1.3远程调⽤</h2><p>在分布式系统中，各个服务可能处于不同主机，但是服务之间不可避免的需要互相调⽤，我们称为远程调⽤。 SpringCloud 中使⽤ HTTP+JSON 的⽅式完成远程调⽤</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-533.png" alt="img"></p>
<h2 id="1-4-负载均衡"><a href="#1-4-负载均衡" class="headerlink" title="1.4.负载均衡"></a>1.4.负载均衡</h2><p>介绍：分布式系统中，A 服务需要调⽤ B 服务，B 服务在多台机器中都存在，A 调⽤任意⼀个服务器均可完成功能。 为了使每⼀个服务器都不要太忙或者太闲，我们可以负载均衡的调⽤每⼀个服务器，提升⽹站的健壮性。</p>
<p>常⻅的负载均衡算法：</p>
<ul>
<li>轮询：为第⼀个请求选择健康池中的第⼀个后端服务器，然后按顺序往后依次选择，直到最后<br>⼀个，然后循环。</li>
<li>最⼩连接：优先选择连接数最少，也就是压⼒最⼩的后端服务器，在会话较⻓的情况下可以考<br>虑采取这种⽅式。</li>
<li>散列：根据请求源的 IP 的散列（hash）来选择要转发的服务器。这种⽅式可以⼀定程度上保<br>证特定⽤户能连接到相同的服务器。如果你的应⽤需要处理状态⽽要求⽤户能连接到和之前相<br>同的服务器，可以考虑采取这种⽅式</li>
</ul>
<h2 id="1-5服务注册-发现-amp-注册中⼼"><a href="#1-5服务注册-发现-amp-注册中⼼" class="headerlink" title="1.5服务注册/发现&amp;注册中⼼"></a>1.5服务注册/发现&amp;注册中⼼</h2><p>A 服务调⽤ B 服务，A 服务并不知道 B 服务当前在哪⼏台服务器有，哪些正常的，哪些服务已经<br>下线。解决这个问题可以引⼊注册中⼼</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-534.png" alt="img"></p>
<p>如果某些服务下线，我们其他⼈可以实时的感知到其他服务的状态，从⽽避免调⽤不可⽤的服务</p>
<h2 id="1-6配置中⼼"><a href="#1-6配置中⼼" class="headerlink" title="1.6配置中⼼"></a>1.6配置中⼼</h2><p>每⼀个服务最终都有⼤量的配置，并且每个服务都可能部署在多台机器上。我们经常需要变更配<br>置，我们可以让每个服务在配置中⼼获取⾃⼰的配置。<br>配置中⼼⽤来集中管理微服务的配置信息</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-535-1024x533.png" alt="img"></p>
<h2 id="1-7服务熔断-amp-服务降级"><a href="#1-7服务熔断-amp-服务降级" class="headerlink" title="1.7服务熔断&amp;服务降级"></a>1.7服务熔断&amp;服务降级</h2><p>在微服务架构中，微服务之间通过⽹络进⾏通信，存在相互依赖，当其中⼀个服务不可⽤时，有可能会造成<strong>雪崩效应</strong>。要防⽌这样的情况，必须要有容错机制来保护服务</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-536.png" alt="img"></p>
<p>1）、服务熔断<br>设置服务的超时，当被调⽤的服务经常失败到达某个阈值，我们可以开启断路保护机制，后来的请求不再去调⽤这个服务。本地直接返回默认的数据<br>2）、服务降级<br>在运维期间，当系统处于⾼峰期，系统资源紧张，我们可以让⾮核⼼业务降级运⾏。降级：某些服务不处理，或者简单处理【抛异常、返回 NULL、调⽤ Mock 数据、调⽤ Fallback 处理逻辑】</p>
<h2 id="1-8API-⽹关"><a href="#1-8API-⽹关" class="headerlink" title="1.8API ⽹关"></a>1.8API ⽹关</h2><p>在微服务架构中，API Gateway 作为整体架构的重要组件，它抽象了微服务中都需要的公共功能，同时提供了客户端负载均衡，服务⾃动熔断，灰度发布，统⼀认证，限流流控，⽇志统计等丰富的功能，帮助我们解决很多 API 管理难题。</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-537-1024x444.png" alt="img"></p>
<h1 id="2-创建一个Spring-Cloud项目"><a href="#2-创建一个Spring-Cloud项目" class="headerlink" title="2.创建一个Spring Cloud项目"></a>2.创建一个Spring Cloud项目</h1><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-538.png" alt="img"></p>
<p>本次课程选择:</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-539.png" alt="img"></p>
<p>项目结构如图：</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-540.png" alt="img"></p>
<p>idea结构如下：</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-541.png" alt="img"></p>
<p>创建⽗项⽬引⼊公共依赖（cloud-demo下的pom）</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>services<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.geqian<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>cloud-demo<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>cloud-demo<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>2023.0.3<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">spring-cloud-alibaba.version</span>&gt;</span>2023.0.3.2<span class="tag">&lt;/<span class="name">spring-cloud-alibaba.version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;spring-cloud.version&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;spring-cloud-alibaba.version&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>在service文件夹下的pom导入公共依赖测试</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">   <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--       服务发现--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--       远程调用--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-542-1024x664.png" alt="img"></p>
<p>公共依赖成功被子包继承</p>
<h1 id="3-Nacos-注册中心-amp-配置中心"><a href="#3-Nacos-注册中心-amp-配置中心" class="headerlink" title="3.Nacos-注册中心&amp;配置中心"></a>3.Nacos-注册中心&amp;配置中心</h1><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-544.png" alt="img"></p>
<h2 id="3-1注册中心基础入门"><a href="#3-1注册中心基础入门" class="headerlink" title="3.1注册中心基础入门"></a>3.1注册中心基础入门</h2><h3 id="3-1-1安装"><a href="#3-1-1安装" class="headerlink" title="3.1.1安装"></a>3.1.1安装</h3><p>官⽹：<a target="_blank" rel="noopener" href="https://nacos.io/zh-cn/docs/v2/quickstart/quick-start.html">https://nacos.io/zh-cn/docs/v2/quickstart/quick-start.html</a></p>
<p>Docker 安装</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker</span> run -d -p <span class="number">8848</span>:<span class="number">8848</span> -p <span class="number">9848</span>:<span class="number">9848</span> -e MODE=standalone --name nacos nac</span><br><span class="line"><span class="attribute">os</span>/nacos-server:v2.<span class="number">4</span>.<span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>下载软件包：</p>
<ul>
<li>nacos-server-2.4.3.zip</li>
<li>启动命令：startup.cmd -m standalone</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-545-1024x547.png" alt="img"></p>
<p>访问：<a target="_blank" rel="noopener" href="http://localhost:8848/nacos">http://localhost:8848/nacos</a> 可以看到服务已经注册上来；</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-546-1024x502.png" alt="img"></p>
<h3 id="3-1-2服务注册"><a href="#3-1-2服务注册" class="headerlink" title="3.1.2服务注册"></a>3.1.2服务注册</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-548-1024x320.png" alt="img"></p>
<p>在微服务项目中引入依赖：（这里以service-order为例，其他的微服务操作一样）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>nacos依赖在service.pom已经引入</p>
<p>在application.properties中配置如下</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.application.name</span>=service-order</span><br><span class="line"><span class="attr">server.port</span>=<span class="number">8000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.cloud.nacos.server-addr</span>=<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8848</span></span><br></pre></td></tr></table></figure>
<p>启动主启动类，进入nacos中发现这个service-order已经注册上来了，我们可以点进去看看</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-549-1024x503.png" alt="img"></p>
<p>模拟集群为order复制1份，product复制2份再全部启动</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-551.png" alt="img"></p>
<p>进入nacos可以看到实例数</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-552-1024x420.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-553-1024x484.png" alt="img"></p>
<h3 id="3-1-3服务发现"><a href="#3-1-3服务发现" class="headerlink" title="3.1.3服务发现"></a>3.1.3服务发现</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-554-1024x353.png" alt="img"></p>
<p>以商品服务为例</p>
<p>1.添加@EnableDiscoveryClient注解</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-555-1024x457.png" alt="img"></p>
<p>2.测试DiscoveryClient</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-556-1024x547.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-557-1024x371.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-558.png" alt="img"></p>
<p>3.测试NacosServiceDiscovery</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-560-1024x422.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-559.png" alt="img"></p>
<p>DiscoveryClient和NacosServiceDiscovery区别</p>
<p>一个是Spring官方提供的一个是Nacos自己提供的</p>
<h3 id="3-1-4远程调⽤"><a href="#3-1-4远程调⽤" class="headerlink" title="3.1.4远程调⽤"></a>3.1.4远程调⽤</h3><p>远程调用-基本流程</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-561.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-562-1024x677.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-563.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-565.png" alt="img"></p>
<p>创建对应的controller，bean，service及其实现类</p>
<p>1.order中</p>
<p>OrderController</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.geqian.com.geqian.order.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.geqian.com.geqian.order.bean.Order;</span><br><span class="line"><span class="keyword">import</span> com.geqian.com.geqian.order.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line">    <span class="comment">// 创建订单</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/create&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Order createOrder(<span class="meta">@RequestParam(<span class="string">&quot;userId&quot;</span>)</span> <span class="built_in">Long</span> userId,</span><br><span class="line">                             <span class="meta">@RequestParam(<span class="string">&quot;productId&quot;</span>)</span> <span class="built_in">Long</span> productId) &#123;</span><br><span class="line">        Order order = orderService.createOrder(productId, userId);</span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Order实体</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.geqian.com.geqian.order.bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Order</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal totalAmount;</span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="keyword">private</span> String nickName;</span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Object&gt;productList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>OrderService</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.geqian.com.geqian.order.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.geqian.com.geqian.order.bean.Order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    Order createOrder(<span class="built_in">Long</span> productId, <span class="built_in">Long</span> userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>及其实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.geqian.com.geqian.order.service.Impl;</span><br><span class="line"><span class="keyword">import</span> com.geqian.Order.bean.Order;</span><br><span class="line"><span class="keyword">import</span> com.geqian.Product.bean.Product;</span><br><span class="line"><span class="keyword">import</span> com.geqian.com.geqian.order.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.ServiceInstance;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.DiscoveryClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Order <span class="title function_">createOrder</span><span class="params">(Long productId, Long userId)</span> &#123;</span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> getProductFromRemote(productId);</span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Order</span>();</span><br><span class="line">        order.setId(<span class="number">1L</span>);</span><br><span class="line">        <span class="comment">//总金额</span></span><br><span class="line">        order.setTotalAmount( product.getPrice().multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(product.getNum())));</span><br><span class="line">        order.setUserId(userId);</span><br><span class="line">        order.setNickName(<span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">        order.setAddress(<span class="string">&quot;beijing&quot;</span>);</span><br><span class="line">        <span class="comment">//远程查询产品列表</span></span><br><span class="line">        order.setProductList(Arrays.asList(product));</span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Product <span class="title function_">getProductFromRemote</span><span class="params">(Long productId)</span> &#123;</span><br><span class="line">        <span class="comment">//1.获取到商品服务所在的所有机器IP+Port</span></span><br><span class="line">        List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">&quot;service-product&quot;</span>);</span><br><span class="line">        <span class="type">ServiceInstance</span> <span class="variable">instance</span> <span class="operator">=</span> instances.get(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">//http://localhost:9002/product/1</span></span><br><span class="line">        <span class="comment">//拼接远程的URL地址</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://&quot;</span>+instance.getHost() + <span class="string">&quot;:&quot;</span> + instance.getPort()+<span class="string">&quot;/product/&quot;</span>+productId;</span><br><span class="line">        log.info(<span class="string">&quot;远程的URL地址:&#123;&#125;&quot;</span>,url);</span><br><span class="line">        <span class="comment">//2.给远程发送请求</span></span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> restTemplate.getForObject(url, Product.class);</span><br><span class="line">        <span class="keyword">return</span> product;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.Product中</p>
<p>ProductController</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.geqian.product.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.geqian.product.bean.Product;</span><br><span class="line"><span class="keyword">import</span> com.geqian.product.service.ProductService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductService productService;</span><br><span class="line">    <span class="comment">// 查询商品</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/product/&#123;id&#125;&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Product getProduct(<span class="meta">@PathVariable(<span class="string">&quot;id&quot;</span>)</span> <span class="built_in">Long</span> productId) &#123;</span><br><span class="line">        Product product = productService.getProductById(productId);</span><br><span class="line">        <span class="keyword">return</span> product;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Product实体</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package com.geqian.<span class="built_in">product</span>.bean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.<span class="keyword">Data</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line">@<span class="keyword">Data</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="built_in">Product</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String productName;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ProductService</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">package com.geqian.<span class="built_in">product</span>.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.geqian.<span class="built_in">product</span>.bean.<span class="built_in">Product</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> ProductService &#123;</span><br><span class="line">    <span class="built_in">Product</span> getProductById(Long productId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>及其实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.geqian.product.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.geqian.Product.bean.Product;</span><br><span class="line"><span class="keyword">import</span> com.geqian.product.service.ProductService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ProductService</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Product <span class="title function_">getProductById</span><span class="params">(Long productId)</span> &#123;</span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Product</span>();</span><br><span class="line">        product.setId(productId);</span><br><span class="line">        product.setPrice(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;6999.00&quot;</span>));</span><br><span class="line">        product.setProductName(<span class="string">&quot;苹果&quot;</span>+productId);</span><br><span class="line">        product.setNum(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">return</span> product;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新建model模块存放order和product的bean，之后再service下的pom中导入lombok确保model包下的bean中@Data注解能生效</p>
<p>首先要注入</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-567.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-568.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-569.png" alt="img"></p>
<p>在order和product下分别建config包，里面写相关的配置项，这里我们把RestTemplate写在里面，方便远程调用不用再new一个新的</p>
<p>看看远程调用的方法</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-570-1024x302.png" alt="img"></p>
<p>测试</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-574.png" alt="img"></p>
<p>再看8000端口的控制台</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-573-1024x286.png" alt="img"></p>
<p>⼩结</p>
<ul>
<li>使⽤ RestTemplate 可以获取到远程数据</li>
<li>必须精确指定地址和端⼝</li>
<li>如果远程宕机将不可⽤</li>
<li>期望：可以负载均衡调⽤，不⽤担⼼远程宕机</li>
</ul>
<h3 id="3-1-5负载均衡需求"><a href="#3-1-5负载均衡需求" class="headerlink" title="3.1.5负载均衡需求"></a>3.1.5负载均衡需求</h3><p>1.依赖导⼊到order下的pom</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2.编写一个测试类</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.geqian.com.geqian.order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.ServiceInstance;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.DiscoveryClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.loadbalancer.LoadBalancerClient;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoadBalancerTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    LoadBalancerClient loadBalancerClient;</span><br><span class="line">    DiscoveryClient discoveryClient;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    void test()&#123;</span><br><span class="line">        ServiceInstance choose = loadBalancerClient.choose(<span class="string">&quot;service-product&quot;</span>);</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">&quot;choose =&quot;</span>+choose.getHost()+<span class="string">&quot;:&quot;</span>+choose.getPort());</span><br><span class="line">        choose = loadBalancerClient.choose(<span class="string">&quot;service-product&quot;</span>);</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">&quot;choose =&quot;</span>+choose.getHost()+<span class="string">&quot;:&quot;</span>+choose.getPort());</span><br><span class="line">        choose = loadBalancerClient.choose(<span class="string">&quot;service-product&quot;</span>);</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">&quot;choose =&quot;</span>+choose.getHost()+<span class="string">&quot;:&quot;</span>+choose.getPort());</span><br><span class="line">        choose = loadBalancerClient.choose(<span class="string">&quot;service-product&quot;</span>);</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">&quot;choose =&quot;</span>+choose.getHost()+<span class="string">&quot;:&quot;</span>+choose.getPort());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-575-1024x502.png" alt="img"></p>
<p>3.LoadBalancerClient</p>
<figure class="highlight stan"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">private Product getProductFromRemoteWithLoadBalancer(Long productId) &#123;</span><br><span class="line">        <span class="comment">//1.获取到商品服务所在的所有机器IP+Port</span></span><br><span class="line">        ServiceInstance <span class="built_in">choose</span>= loadBalancerClient.<span class="built_in">choose</span>(<span class="string">&quot;service-product&quot;</span>);</span><br><span class="line">        <span class="comment">//http://localhost:9002/product/1</span></span><br><span class="line">        <span class="comment">//拼接远程的URL地址</span></span><br><span class="line">        String url = <span class="string">&quot;http://&quot;</span>+<span class="built_in">choose</span>.getHost() + <span class="string">&quot;:&quot;</span> + <span class="built_in">choose</span>.getPort()+<span class="string">&quot;/product/&quot;</span>+productId;</span><br><span class="line">        <span class="built_in">log</span>.info(<span class="string">&quot;远程的URL地址:&#123;&#125;&quot;</span>,url);</span><br><span class="line">        <span class="comment">//2.给远程发送请求</span></span><br><span class="line">        Product product = restTemplate.getForObject(url, Product.class);</span><br><span class="line">        <span class="keyword">return</span> product;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>测试<a target="_blank" rel="noopener" href="http://localhost:8000/create?userId=4&amp;productId=100">localhost:8000/create?userId=4&amp;productId=100</a>多刷新几次</p>
<p>去控制台查看，发现每一次远程的URL地址都有变化，即负载均衡</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-576-1024x237.png" alt="img"></p>
<p>4.注解方式负载均衡</p>
<p>Spring自带一个注解 @LoadBalanced，只要把它标在配置类上就会自动负载均衡</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-579-1024x369.png" alt="img"></p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//进阶<span class="number">3</span>基于注解的负载均衡</span><br><span class="line">   <span class="keyword">private</span> <span class="built_in">Product</span> getProductFromRemoteWithLoadBalancerAnnotation(Long productId) &#123;</span><br><span class="line"></span><br><span class="line">       String url = <span class="string">&quot;http://service-product/product/&quot;</span>+productId;</span><br><span class="line">       <span class="built_in">log</span>.info(<span class="string">&quot;远程的URL地址:&#123;&#125;&quot;</span>,url);</span><br><span class="line">       //<span class="number">2.</span>给远程发送请求 service-<span class="built_in">product</span> 会被动态替换为真实的IP+Port</span><br><span class="line">       <span class="built_in">Product</span> <span class="built_in">product</span> = restTemplate.getForObject(url, <span class="built_in">Product</span>.<span class="keyword">class</span>);</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">product</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-578-1024x184.png" alt="img"></p>
<h3 id="3-1-6面试题：如果注册中心宕机，远程调用还能使用吗？"><a href="#3-1-6面试题：如果注册中心宕机，远程调用还能使用吗？" class="headerlink" title="3.1.6面试题：如果注册中心宕机，远程调用还能使用吗？"></a>3.1.6面试题：如果注册中心宕机，远程调用还能使用吗？</h3><p>先看看远程调用的流程</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-580-1024x525.png" alt="img"></p>
<p>当第一次发请求时需要依赖注册中心，并把信息保存到实例缓存中，当下一次调用时不再依赖注册中心从实例缓存中拿，注册中心的数据会实时同步到实例缓存</p>
<p>因此如果注册中心宕机，远程调用还能使用吗？</p>
<p>分两种情况：1.以前调用：此时有了实例缓存，就算注册中心宕机了，它只影响了同步更新的作用，但是以前的这些IP地址和端口号大概率依然能访问。即调用过的情况下，远程调用不再依赖注册中心</p>
<p>2.以前没有调用：第一次发起远程调用，就必须去注册中心要到微服务的地址列表，就不能通过</p>
<h2 id="3-2配置中心基础入门"><a href="#3-2配置中心基础入门" class="headerlink" title="3.2配置中心基础入门"></a>3.2配置中心基础入门</h2><h3 id="3-2-1基础配置"><a href="#3-2-1基础配置" class="headerlink" title="3.2.1基础配置"></a>3.2.1基础配置</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-581-1024x550.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-582-1024x503.png" alt="img"></p>
<p>1.引入依赖（service的pom下）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>2.配置⽂件</p>
<p>application.properties</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定配置中⼼地址</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.server-addr</span>=localhost:<span class="number">8848</span></span><br><span class="line"><span class="attr">spring.config.import</span>=nacos:service-order.properties</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-583-1024x531.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-584-851x1024.png" alt="img"></p>
<p>在ordercontroller中测试一下这两个配置是否被加载</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-585.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-586.png" alt="img"></p>
<p>成功从配置中心拿到数据</p>
<h3 id="3-2-2动态刷新"><a href="#3-2-2动态刷新" class="headerlink" title="3.2.2动态刷新"></a>3.2.2动态刷新</h3><h4 id="RefreshScope"><a href="#RefreshScope" class="headerlink" title="@RefreshScope"></a>@RefreshScope</h4><p>当我们在配置中心改变这两个配置刷新页面发现，页面的数据并没有改变，这是因为我们缺少了一个激活动态刷新的注解，加上这个注解就可以了</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RefreshScope</span><span class="comment">//动态刷新配置</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line">    <span class="meta">@Value(<span class="string">&quot;<span class="subst">$&#123;order.timeout&#125;</span>&quot;</span>)</span></span><br><span class="line">    String orderTimeout;</span><br><span class="line">    <span class="meta">@Value(<span class="string">&quot;<span class="subst">$&#123;order.auto-confirm&#125;</span>&quot;</span>)</span></span><br><span class="line">    String orderAutoConfirm;</span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/config&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> String config() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;order.timeout=&quot;</span>+orderTimeout+<span class="string">&quot;, order.auto-confirm=&quot;</span>+orderAutoConfirm;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建订单</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/create&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Order createOrder(<span class="meta">@RequestParam(<span class="string">&quot;userId&quot;</span>)</span> <span class="built_in">Long</span> userId,</span><br><span class="line">                             <span class="meta">@RequestParam(<span class="string">&quot;productId&quot;</span>)</span> <span class="built_in">Long</span> productId) &#123;</span><br><span class="line">        Order order = orderService.createOrder(productId, userId);</span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注：如果nacos配置中心作为公共依赖导入但目前用不上，需要在application.properties中加入</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#禁用导入检查</span></span><br><span class="line"><span class="attr">spring.cloud.nacos.config.import-check.enabled</span>=<span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>否则项目将无法启动</p>
<h4 id="ConfigurationProperties（推荐）"><a href="#ConfigurationProperties（推荐）" class="headerlink" title="@ConfigurationProperties（推荐）"></a>@ConfigurationProperties（推荐）</h4><p>nacos兼容springboot中的动态更新</p>
<p>把属性提取到properties包下的OrderProperties中</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    <span class="variable">@Component</span></span><br><span class="line">    <span class="variable">@ConfigurationProperties</span>(prefix = <span class="string">&quot;order&quot;</span>)</span><br><span class="line"><span class="comment">//配置批量绑定在nacos下，可以⽆需@RefreshScope就能实现⾃动刷新</span></span><br><span class="line">    <span class="variable">@Data</span></span><br><span class="line">    public class OrderProperties &#123;</span><br><span class="line">        <span class="selector-tag">String</span> <span class="selector-tag">timeout</span>;</span><br><span class="line">        <span class="selector-tag">String</span> <span class="selector-tag">autoConfirm</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>改造ordercontroller原本的方法</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//    @Value(&quot;$&#123;order.timeout&#125;&quot;)</span></span><br><span class="line"><span class="comment">//    String orderTimeout;</span></span><br><span class="line"><span class="comment">//    @Value(&quot;$&#123;order.auto-confirm&#125;&quot;)</span></span><br><span class="line"><span class="comment">//    String orderAutoConfirm;</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="title class_">OrderProperties</span> orderProperties;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">&quot;/config&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">config</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;order.timeout=&quot;</span>+orderProperties.<span class="title function_">getTimeout</span>()+<span class="string">&quot;, order.auto-confirm=&quot;</span>+orderProperties.<span class="title function_">getAutoConfirm</span>();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="NacosConfigManager监听配置变化"><a href="#NacosConfigManager监听配置变化" class="headerlink" title="@NacosConfigManager监听配置变化"></a>@NacosConfigManager监听配置变化</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">//1.项目启动就监听配置文件变化</span></span><br><span class="line">    <span class="comment">//2.发生变化后拿到变化值</span></span><br><span class="line">    <span class="comment">//3.发送邮件</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="title class_">ApplicationRunner</span> <span class="title function_">applicationRunner</span>(<span class="params"><span class="title class_">NacosConfigManager</span> nacosConfigManager</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> args -&gt; &#123;</span><br><span class="line">            <span class="title class_">ConfigService</span> configService = nacosConfigManager.<span class="title function_">getConfigService</span>();</span><br><span class="line">            configService.<span class="title function_">addListener</span>(<span class="string">&quot;service-order.properties&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;DEFAULT_GROUP&quot;</span>, <span class="keyword">new</span> <span class="title class_">Listener</span>() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="title class_">Executor</span> <span class="title function_">getExecutor</span>(<span class="params"></span>) &#123;</span><br><span class="line">                            <span class="keyword">return</span>  <span class="title class_">Executors</span>.<span class="title function_">newFixedThreadPool</span>(<span class="number">4</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">receiveConfigInfo</span>(<span class="params"><span class="title class_">String</span> configInfo</span>) &#123;</span><br><span class="line">                            <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;变化的配置信息 ： &quot;</span> + configInfo);</span><br><span class="line">                            <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;发送邮件&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; );</span><br><span class="line">   <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(<span class="string">&quot;=======================&quot;</span>);</span><br><span class="line">       &#125;;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试：</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-588-1024x233.png" alt="img"></p>
<h3 id="3-2-3面试题：Nacos中的数据集和application-properties有相同的配置项，哪个生效？"><a href="#3-2-3面试题：Nacos中的数据集和application-properties有相同的配置项，哪个生效？" class="headerlink" title="3.2.3面试题：Nacos中的数据集和application.properties有相同的配置项，哪个生效？"></a>3.2.3面试题：Nacos中的数据集和application.properties有相同的配置项，哪个生效？</h3><p>答：是以配置中心为准（先导入/先声明优先、外部优先）</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-589.png" alt="img"></p>
<h3 id="3-2-4数据隔离"><a href="#3-2-4数据隔离" class="headerlink" title="3.2.4数据隔离"></a>3.2.4数据隔离</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-590.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-592-1024x504.png" alt="img"></p>
<p>开发环境绑定开发的名称空间，测试环境绑定测试的名称空间，生产环境绑定生产的名称空间，想要让它们生效只需在项目启动时激活某一个环境</p>
<p>总结：用名称空间区分多套环境，用分组区分多种微服务，用数据集区分多种配置，用SpringBoot激活指定环境，激活这套配置</p>
<h4 id="名称空间"><a href="#名称空间" class="headerlink" title="名称空间"></a>名称空间</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-593.png" alt="img"></p>
<h4 id="groupId"><a href="#groupId" class="headerlink" title="groupId"></a>groupId</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-594-1024x498.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-595-1024x511.png" alt="img"></p>
<h4 id="按需加载"><a href="#按需加载" class="headerlink" title="按需加载"></a>按需加载</h4><p>创建一个新的application.yml文件把新配置放在这里面</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">server</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">port</span><span class="punctuation">:</span> <span class="string">8000</span></span><br><span class="line"><span class="attribute">spring</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">application</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">name</span><span class="punctuation">:</span> <span class="string">service-order</span></span><br><span class="line">  <span class="attribute">cloud</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">nacos</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">server-addr</span><span class="punctuation">:</span> <span class="string">127.0.0.1:8848</span></span><br><span class="line">      <span class="attribute">config</span><span class="punctuation">:</span></span><br><span class="line">        <span class="attribute">namespace</span><span class="punctuation">:</span> <span class="string">dev//在这里切换环境</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="attribute">config</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">import</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos:common.properties?group=order</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos:database.properties?group=order</span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-596-1024x330.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-597.png" alt="img"></p>
<p>改造yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev//在这里更改激活什么环境</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">service-order</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">$&#123;spring.profiles.active:public&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">import:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos:common.properties?group=order</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos:database.properties?group=order</span></span><br><span class="line">    <span class="attr">activate:</span></span><br><span class="line">      <span class="attr">on-profile:</span> <span class="string">dev</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">import:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos:common.properties?group=order</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos:database.properties?group=order</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos:redis.properties?group=order</span></span><br><span class="line">    <span class="attr">activate:</span></span><br><span class="line">      <span class="attr">on-profile:</span> <span class="string">test</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">import:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos:common.properties?group=order</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos:database.properties?group=order</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos:redis.properties?group=order</span></span><br><span class="line">    <span class="attr">activate:</span></span><br><span class="line">      <span class="attr">on-profile:</span> <span class="string">prod</span></span><br></pre></td></tr></table></figure>
<h2 id="3-3Nacos总结"><a href="#3-3Nacos总结" class="headerlink" title="3.3Nacos总结"></a>3.3Nacos总结</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-598-1024x489.png" alt="img"></p>
<h1 id="4-OpenFeign-远程调用"><a href="#4-OpenFeign-远程调用" class="headerlink" title="4.OpenFeign-远程调用"></a>4.OpenFeign-远程调用</h1><h2 id="4-1基础入门"><a href="#4-1基础入门" class="headerlink" title="4.1基础入门"></a>4.1基础入门</h2><p>官网：<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-openfeign/reference/spring-cloud-openfeign.html#spring-cloud-feign">Spring Cloud OpenFeign Features :: Spring Cloud Openfeign</a></p>
<p>介绍：OpenFeign 是⼀个<strong>声明式</strong>远程调⽤客户端；</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-599-1024x406.png" alt="img"></p>
<p>声明式对比编程式的好处就是用注解代替代码</p>
<h3 id="4-1-1引入依赖"><a href="#4-1-1引入依赖" class="headerlink" title="4.1.1引入依赖"></a>4.1.1引入依赖</h3><p>在service包下引入公共依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--       远程调用--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="4-1-2开启OpenFeign远程调用功能"><a href="#4-1-2开启OpenFeign远程调用功能" class="headerlink" title="4.1.2开启OpenFeign远程调用功能"></a>4.1.2开启OpenFeign远程调用功能</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@EnableFeignClients</span> <span class="comment">//开启Feign功能</span></span><br><span class="line"><span class="variable">@EnableDiscoveryClient</span></span><br><span class="line"><span class="variable">@SpringBootApplication</span></span><br><span class="line">public class OrderMainApplication &#123;</span><br><span class="line">    <span class="selector-tag">public</span> <span class="selector-tag">static</span> <span class="selector-tag">void</span> <span class="selector-tag">main</span>(String[] args) &#123;</span><br><span class="line">        <span class="selector-tag">SpringApplication</span><span class="selector-class">.run</span>(OrderMainApplication.class, args);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-1-3远程调用（这个远程调用是自动负载均衡的）"><a href="#4-1-3远程调用（这个远程调用是自动负载均衡的）" class="headerlink" title="4.1.3远程调用（这个远程调用是自动负载均衡的）"></a>4.1.3远程调用（这个远程调用是自动负载均衡的）</h3><p>编写ProductFeignClient接口</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-600.png" alt="img"></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.geqian.com.geqian.order.feign;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.geqian.Product.bean.Product;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.PathVariable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(value = <span class="string">&quot;server-product&quot;</span>)</span><span class="comment">//feign客户端</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ProductFeignClient</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// mvc注解的两套使用逻辑</span></span><br><span class="line">       <span class="comment">//1.标注在controller上，是接受这样的请求</span></span><br><span class="line">       <span class="comment">//2.标注在FeignClient接口上，是发送这样的请求</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/product/&#123;id&#125;&quot;</span>)</span></span><br><span class="line">    Product getProductById(<span class="meta">@PathVariable(<span class="string">&quot;id&quot;</span>)</span> <span class="built_in">Long</span> id);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在OrderServiceImpl中注入并调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"> ProductFeignClient productFeignClient;</span><br><span class="line">  <span class="comment">//使用Feign客户端完成远程调用</span></span><br><span class="line">     <span class="type">Product</span> <span class="variable">product</span>  <span class="operator">=</span> productFeignClient.getProductById(productId);</span><br></pre></td></tr></table></figure>
<h3 id="4-1-4远程调用第三方API"><a href="#4-1-4远程调用第三方API" class="headerlink" title="4.1.4远程调用第三方API"></a>4.1.4远程调用第三方API</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-601-1024x561.png" alt="img"></p>
<p>WeatherFeignClient</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-604-1024x257.png" alt="img"></p>
<p>编写测试类</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-603-1024x384.png" alt="img"></p>
<h3 id="4-1-5小技巧与面试题"><a href="#4-1-5小技巧与面试题" class="headerlink" title="4.1.5小技巧与面试题"></a>4.1.5小技巧与面试题</h3><h4 id="小技巧"><a href="#小技巧" class="headerlink" title="小技巧"></a>小技巧</h4><p>FeignClient远程调用自己写的业务API方法参数与Controller层方法参数一样，直接复制即可</p>
<p>如果调用第三方API参考第三方API文档</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-610.png" alt="img"></p>
<h4 id="面试题：客户端负载均衡与服务端负载均衡区别"><a href="#面试题：客户端负载均衡与服务端负载均衡区别" class="headerlink" title="面试题：客户端负载均衡与服务端负载均衡区别"></a>面试题：客户端负载均衡与服务端负载均衡区别</h4><p><strong>客户端负载均衡</strong></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-605.png" alt="img"></p>
<p>发起调用的这一端，自己根据负载均衡算法，选择一个对方的服务进行调用，负载均衡发生在了客户端的位置我们就叫做客户端负载均衡</p>
<ul>
<li>先从<strong>注册中心</strong>获取服务列表（即所有可用的商品服务实例）；</li>
<li>自己执行负载均衡算法（比如轮询、随机、加权等）；</li>
<li><p>选定一个服务实例，然后自己直接发起调用。</p>
</li>
<li><p><code>OpenFeign</code> 是客户端调用工具。</p>
</li>
<li>客户端要<strong>自己承担负载均衡的逻辑</strong>。</li>
<li>代表性组件：Spring Cloud LoadBalancer、Ribbon（已废弃）等。</li>
</ul>
<p><strong>总结：客户端要有能力和责任来选择服务实例，负载均衡发生在调用发起方。</strong></p>
<p><strong>服务端负载均衡</strong></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-606.png" alt="img"></p>
<p>客户端直接把请求发给某个服务（如墨迹天气）。</p>
<p><strong>墨迹天气服务作为“入口”，在服务端做负载均衡</strong>，它会：</p>
<ul>
<li><p>根据配置或注册中心信息，将请求转发给后端的具体“天气查询服务”实例之一。</p>
</li>
<li><p>客户端无需感知有多少个后端实例，<strong>只需请求入口服务</strong>。</p>
</li>
<li>服务端来统一做流量调度。</li>
<li><p>代表性工具：Nginx、Kong、Zuul、Gateway、负载均衡的 API 网关等。</p>
<p><strong>总结：服务端接收到请求后进行转发，负载均衡发生在服务提供方的入口。</strong></p>
</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th>对比点</th>
<th>客户端负载均衡</th>
<th>服务端负载均衡</th>
</tr>
</thead>
<tbody>
<tr>
<td>负载均衡位置</td>
<td>调用方（客户端）</td>
<td>服务方（入口服务）</td>
</tr>
<tr>
<td>客户端是否感知服务实例</td>
<td>是</td>
<td>否</td>
</tr>
<tr>
<td>灵活性</td>
<td>高（可自定义算法）</td>
<td>中（由网关或代理控制）</td>
</tr>
<tr>
<td>典型工具</td>
<td>OpenFeign + Ribbon / LoadBalancer</td>
<td>Nginx、API Gateway 等</td>
</tr>
<tr>
<td>网络路径</td>
<td>直接请求目标服务</td>
<td>通过代理/网关转发</td>
</tr>
</tbody>
</table>
</div>
<h2 id="4-2进阶配置"><a href="#4-2进阶配置" class="headerlink" title="4.2进阶配置"></a>4.2进阶配置</h2><h3 id="4-2-1-开启日志"><a href="#4-2-1-开启日志" class="headerlink" title="4.2.1.开启日志"></a>4.2.1.开启日志</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-607-1024x554.png" alt="img"></p>
<p>在application.yml中</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">logging</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">level</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">com.geqian.order.feign</span><span class="punctuation">:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>
<p>在orderConfig中</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Bean</span><br><span class="line"> Logger.<span class="keyword">Level</span> feignLoggerLevel() &#123;</span><br><span class="line"> <span class="keyword">return</span> Logger.<span class="keyword">Level</span>.<span class="keyword">FULL</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>重启项目时控制台就会打印远程调用时的日志了</p>
<h3 id="4-2-2超时控制"><a href="#4-2-2超时控制" class="headerlink" title="4.2.2超时控制"></a>4.2.2超时控制</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-611-1024x540.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-612.png" alt="img"></p>
<p>openFeign的默认连接超时和读取超时</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-613.png" alt="img"></p>
<p>超过时间控制台返回默认信息</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-614-1024x310.png" alt="img"></p>
<p>在applicationfeign.yml中</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"> <span class="attr">cloud:</span></span><br><span class="line">   <span class="attr">openfeign:</span></span><br><span class="line">     <span class="attr">client:</span></span><br><span class="line">       <span class="attr">config:</span></span><br><span class="line">         <span class="attr">default:</span></span><br><span class="line">           <span class="attr">logger-level:</span> <span class="string">full</span></span><br><span class="line">           <span class="attr">connect-timeout:</span> <span class="number">1000</span></span><br><span class="line">           <span class="attr">read-timeout:</span> <span class="number">2000</span></span><br><span class="line">         <span class="attr">service-product:</span></span><br><span class="line">           <span class="attr">logger-level:</span> <span class="string">full</span></span><br><span class="line">           <span class="attr">connect-timeout:</span> <span class="number">3000</span></span><br><span class="line">           <span class="attr">read-timeout:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>
<h3 id="4-2-3重试机制"><a href="#4-2-3重试机制" class="headerlink" title="4.2.3重试机制"></a>4.2.3重试机制</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-615.png" alt="img"></p>
<p>默认重试器：间隔100ms，最大间隔1s，最大尝试次数5次</p>
<p>在orderConfig中</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"> <span class="title class_">Retryer</span> <span class="title function_">retryer</span>(<span class="params"></span>)&#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Retryer</span>.<span class="title class_">Default</span>();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-2-4拦截器"><a href="#4-2-4拦截器" class="headerlink" title="4.2.4拦截器"></a>4.2.4拦截器</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-616-1024x593.png" alt="img"></p>
<h4 id="请求拦截器"><a href="#请求拦截器" class="headerlink" title="请求拦截器"></a>请求拦截器</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-617.png" alt="img"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.geqian.com.geqian.order.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> feign.RequestInterceptor;</span><br><span class="line"><span class="keyword">import</span> feign.RequestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TokenInterceptor</span> <span class="keyword">implements</span> <span class="title class_">RequestInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求拦截器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> template</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(RequestTemplate template)</span> &#123;</span><br><span class="line">        template.header(<span class="string">&quot;X-token&quot;</span>, UUID.randomUUID().toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-2-5-fallback-兜底返回"><a href="#4-2-5-fallback-兜底返回" class="headerlink" title="4.2.5.fallback - 兜底返回"></a>4.2.5.fallback - 兜底返回</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-618.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-619.png" alt="img"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.geqian.com.geqian.order.feign.fallback;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.geqian.Product.bean.Product;</span><br><span class="line"><span class="keyword">import</span> com.geqian.com.geqian.order.feign.ProductFeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">productFeignClientFallback</span> <span class="keyword">implements</span> <span class="title class_">ProductFeignClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Product <span class="title function_">getProductById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;兜底回调...&quot;</span>);</span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Product</span>();</span><br><span class="line">        product.setId(id);</span><br><span class="line">        product.setPrice(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">10</span>));</span><br><span class="line">        product.setProductName(<span class="string">&quot;未知商品&quot;</span>);</span><br><span class="line">        product.setNum(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> product;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在productFeignClient加入这个兜底回调</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-620-1024x424.png" alt="img"></p>
<p>导入sentinel的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>application-feign.yml：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">feign:</span></span><br><span class="line">  <span class="params">sentinel:</span></span><br><span class="line">    <span class="params">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h2 id="4-3总结"><a href="#4-3总结" class="headerlink" title="4.3总结"></a>4.3总结</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-621.png" alt="img"></p>
<h1 id="5-Sentinel-流量保护"><a href="#5-Sentinel-流量保护" class="headerlink" title="5.Sentinel-流量保护"></a>5.Sentinel-流量保护</h1><h2 id="5-1介绍"><a href="#5-1介绍" class="headerlink" title="5.1介绍"></a>5.1介绍</h2><p>官⽹：<a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/index.html">https://sentinelguard.io/zh-cn/index.html</a></p>
<p>wiki：<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki">https://github.com/alibaba/Sentinel/wiki</a><br>随着微服务的流⾏，服务和服务之间的稳定性变得越来越重要。Sentinel 以流量为切⼊点，从流<br>量控制、流量路由、熔断降级、系统⾃适应过载保护、热点流量防护等多个维度保护服务的稳定<br>性。<br>Sentinel 具有以下特征:</p>
<ul>
<li>丰富的应⽤场景：Sentinel 承接了阿⾥巴巴近 10 年的双⼗⼀⼤促流量的核⼼场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填⾕、集群流量控制、实时熔断下游不可⽤应⽤等。</li>
<li>完备的实时监控：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接⼊应⽤的单台机器秒级数据，甚⾄ 500 台以下规模的集群的汇总运⾏情况。</li>
<li>⼴泛的开源⽣态：Sentinel 提供开箱即⽤的与其它开源框架/库的整合模块，例如与 SpringCloud、Apache Dubbo、gRPC、Quarkus 的整合。您只需要引⼊相应的依赖并进⾏简单的配置即可快速地接⼊ Sentinel。同时 Sentinel 提供 Java/Go/C++ 等多语⾔的原⽣实现。</li>
<li>完善的 SPI 扩展机制：Sentinel 提供简单易⽤、完善的 SPI 扩展接⼝。您可以通过实现扩展接⼝来快速地定制逻辑。例如定制规则管理、适配动态数据源等</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-622-1024x476.png" alt="img"></p>
<h2 id="5-2架构原理"><a href="#5-2架构原理" class="headerlink" title="5.2架构原理"></a>5.2架构原理</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-623.png" alt="img"></p>
<p>假设一个应用里有很多微服务，每一个微服务里面有很多的资源需要我们保护，我们只需要引入sentinel的客户端，这些客户端就可以连上sentinel的控制台sentinel Dashboard ，在控制台里面可以对每一种资源的规则进行定义（限流规则，熔断降级规则，黑白名单….），定义的规则可以存到nacos，zookeeper这些配置中心，存到内存里也可以（只是重启时就失效了），如果这些规则发生了变更，sentinel的控制台还可以把这些规则实时推送给每一个微服务，我们每次访问资源时，sentinel客户端就会来检查每一种资源的规则是否违背了规则，没有违背就放行，违背了就拒绝服务</p>
<h3 id="5-2-1资源"><a href="#5-2-1资源" class="headerlink" title="5.2.1资源"></a>5.2.1资源</h3><p>定义<strong>资源</strong>：</p>
<ul>
<li>主流框架<strong>⾃动适配</strong>（Web Servlet、Dubbo、Spring Cloud、gRPC、Spring WebFlux、Reactor）；所有Web接⼝均为资源</li>
<li><strong>编程式</strong>：SphU API</li>
<li><strong>声明式</strong>：@SentinelResource</li>
</ul>
<h3 id="5-2-2规则"><a href="#5-2-2规则" class="headerlink" title="5.2.2规则"></a>5.2.2规则</h3><p>定义<strong>规则</strong>：</p>
<ul>
<li>流量控制规则</li>
<li>熔断降级规则</li>
<li>系统保护规则</li>
<li>来源访问控制规则</li>
<li>热点参数规则</li>
</ul>
<h3 id="5-2-3工作原理"><a href="#5-2-3工作原理" class="headerlink" title="5.2.3工作原理"></a>5.2.3工作原理</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-625-1024x802.png" alt="img"></p>
<h2 id="5-3sentinel整合"><a href="#5-3sentinel整合" class="headerlink" title="5.3sentinel整合"></a>5.3sentinel整合</h2><p>java -jar启动</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-626-1024x445.png" alt="img"></p>
<p>打开localhost：8080 默认账号密码都为sentinel</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-627-1024x686.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-628-1024x583.png" alt="img"></p>
<h2 id="5-4-环境搭建"><a href="#5-4-环境搭建" class="headerlink" title="5.4.环境搭建"></a>5.4.环境搭建</h2><h3 id="5-4-1-依赖"><a href="#5-4-1-依赖" class="headerlink" title="5.4.1.依赖"></a>5.4.1.依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="5-4-2配置连接"><a href="#5-4-2配置连接" class="headerlink" title="5.4.2配置连接"></a>5.4.2配置连接</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-629.png" alt="img"></p>
<p>连接成功</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-630-1024x609.png" alt="img"></p>
<h3 id="5-4-3对指定方法进行保护"><a href="#5-4-3对指定方法进行保护" class="headerlink" title="5.4.3对指定方法进行保护"></a>5.4.3对指定方法进行保护</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-631-1024x409.png" alt="img"></p>
<p>我们发送请求后</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-632.png" alt="img"></p>
<p>在控制台就可以看到</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-633-1024x732.png" alt="img"></p>
<p>给create方法创建一个流控规则</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-635.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-634.png" alt="img"></p>
<p>当我快速访问时会显示流量被sentinel限制了（规则生效了）</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-636.png" alt="img"></p>
<p>如何给前端返回这样的数据？</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-637.png" alt="img"></p>
<p>这牵扯到sentinel的异常处理机制（<strong>自定义BEN</strong>）</p>
<h2 id="5-5异常处理机制"><a href="#5-5异常处理机制" class="headerlink" title="5.5异常处理机制"></a>5.5异常处理机制</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-638.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-640.png" alt="img"></p>
<p>违背某一种规则就会抛出对应的异常</p>
<p>我们先看web接口方面的异常</p>
<h3 id="5-5-1⾃定义-BlockExceptionHandle"><a href="#5-5-1⾃定义-BlockExceptionHandle" class="headerlink" title="5.5.1⾃定义 BlockExceptionHandle"></a>5.5.1⾃定义 BlockExceptionHandle</h3><p>回归到这个问题</p>
<p>如何给前端返回这样的数据？</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-637.png" alt="img"></p>
<p>这牵扯到sentinel的异常处理机制（<strong>自定义BEN</strong>），需要我们自定义BlockExceptionHandle。</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-641.png" alt="img"></p>
<p>首先在model层创建一个统一相应模板</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-642.png" alt="img"></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">geqian</span>.<span class="property">common</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.<span class="property">Data</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">R</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> code;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> msg;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Object</span> data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> R <span class="title function_">ok</span>(<span class="params"></span>) &#123;</span><br><span class="line">        R r = <span class="keyword">new</span> <span class="title function_">R</span>();</span><br><span class="line">        r.<span class="title function_">setCode</span>(<span class="number">200</span>);</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> R <span class="title function_">ok</span>(<span class="params"><span class="title class_">String</span> msg, <span class="title class_">Object</span> data</span>) &#123;</span><br><span class="line">        R r = <span class="keyword">new</span> <span class="title function_">R</span>();</span><br><span class="line">        r.<span class="title function_">setCode</span>(<span class="number">200</span>);</span><br><span class="line">        r.<span class="title function_">setMsg</span>(msg);</span><br><span class="line">        r.<span class="title function_">setData</span>(data);</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> R <span class="title function_">error</span>(<span class="params"></span>) &#123;</span><br><span class="line">        R r = <span class="keyword">new</span> <span class="title function_">R</span>();</span><br><span class="line">        r.<span class="title function_">setCode</span>(<span class="number">500</span>);</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> R <span class="title function_">error</span>(<span class="params"><span class="title class_">Integer</span> code, <span class="title class_">String</span> msg</span>) &#123;</span><br><span class="line">        R r = <span class="keyword">new</span> <span class="title function_">R</span>();</span><br><span class="line">        r.<span class="title function_">setCode</span>(code);</span><br><span class="line">        r.<span class="title function_">setMsg</span>(msg);</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在自定义的MyBlockExceptionHandler中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.geqian.com.geqian.order.exception;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.adapter.spring.webmvc_v6x.callback.BlockExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.BlockException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> com.geqian.common.R;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBlockExceptionHandler</span> <span class="keyword">implements</span> <span class="title class_">BlockExceptionHandler</span> &#123;</span><br><span class="line"><span class="comment">//springMVC中ObjectMapper有个方法可以把对象转为字符串</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, String resourceName, BlockException e)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpServletResponse.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> httpServletResponse.getWriter();</span><br><span class="line">        <span class="type">R</span> <span class="variable">error</span> <span class="operator">=</span> R.error(<span class="number">500</span>,resourceName+<span class="string">&quot;被sentinel限制了，原因：&quot;</span>+e.getClass());</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> objectMapper.writeValueAsString(error);</span><br><span class="line">        writer.write(json);</span><br><span class="line"></span><br><span class="line">        writer.flush();</span><br><span class="line">        writer.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>自定义BEN完成</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-643.png" alt="img"></p>
<h3 id="5-5-2处理-SentinelResource的异常"><a href="#5-5-2处理-SentinelResource的异常" class="headerlink" title="5.5.2处理@SentinelResource的异常"></a>5.5.2处理@SentinelResource的异常</h3><p>为create-order新增流控规则，删除之前/create的规则</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-646.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-645.png" alt="img"></p>
<p>当多次刷新发现会报500错误</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-644.png" alt="img"></p>
<p>这个页面怎么来的？</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-647.png" alt="img"></p>
<p>从这个流程可以看出，我们只是标了@SentinelResource这个注解只给资源起了名，blockHandler,fallback和defaultFallback都没有，异常不断往上跑最后由SpringBoot全局异常处理来给出这个异常页面，这便是这个页面的由来</p>
<p>我们需要在注解上加上blockHandler</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-648.png" alt="img"></p>
<p>并补上兜底回调的方法</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//执行兜底回调</span></span><br><span class="line">    <span class="keyword">public</span> Order createOrderFallback(Long productId, Long userId, BlockException e) &#123;</span><br><span class="line">        Order <span class="keyword">order</span> = <span class="keyword">new</span> Order();</span><br><span class="line">        <span class="keyword">order</span>.setId(<span class="number">0</span>L);</span><br><span class="line">        <span class="keyword">order</span>.setTotalAmount(<span class="keyword">new</span> BigDecimal(<span class="number">0</span>));</span><br><span class="line">        <span class="keyword">order</span>.setUserId(userId);</span><br><span class="line">        <span class="keyword">order</span>.setNickName(<span class="string">&quot;未知用户&quot;</span>);</span><br><span class="line">        <span class="keyword">order</span>.setAddress(<span class="string">&quot;异常信息&quot;</span>+e.getClass());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">order</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>流程：当资源没有违背规则，会直接走OpenFeign远程调用商品信息</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-649-1024x471.png" alt="img"></p>
<p>当资源违背规则，则调用兜底回调</p>
<p>重新刷新后不走Springboot的全局异常处理了，返回的是我们设置的兜底回调</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-651.png" alt="img"></p>
<p>总结：@SentinelResource一般标注在非controller的这些层，想要给哪些方法加上保护就加上这个注解，一旦违背规则，由blockHandler指定兜底回调，没有兜底回调和其他fallback则有Springboot全局处理器处理</p>
<h3 id="5-5-3针对OpenFeign远程调用的异常处理"><a href="#5-5-3针对OpenFeign远程调用的异常处理" class="headerlink" title="5.5.3针对OpenFeign远程调用的异常处理"></a>5.5.3针对OpenFeign远程调用的异常处理</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-652.png" alt="img"></p>
<p>sentinel探测到了OpenFeign的远程调用</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-654-1024x472.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-653.png" alt="img"></p>
<p>当我们给这个请求加上流控规则，在进行测试如图</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-655.png" alt="img"></p>
<p>OpenFeign只要远程调用失败了，它有fallback兜底回调，因此调用了它的兜底回调，如果它没有兜底回调，最终也会由Springboot的全局异常处理器来抛出异常页面</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-656-1024x487.png" alt="img"></p>
<h3 id="5-5-4SphU硬编码异常处理-了解即可"><a href="#5-5-4SphU硬编码异常处理-了解即可" class="headerlink" title="5.5.4SphU硬编码异常处理(了解即可)"></a>5.5.4SphU硬编码异常处理(了解即可)</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-658.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-659-1024x431.png" alt="img"></p>
<h2 id="5-6-规则-流量控制"><a href="#5-6-规则-流量控制" class="headerlink" title="5.6.规则 - 流量控制"></a>5.6.规则 - 流量控制</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-660-1024x512.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-661.png" alt="img"></p>
<ul>
<li>QPS：统计每秒请求数  （推荐）</li>
<li>并发线程数：统计并发线程数，引入线程池，容易出现线程问题，性能比较低下</li>
<li>单机阈值写1表示每秒通过一个请求</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-662.png" alt="img"></p>
<p>当点击是否集群，就会有集群的设置</p>
<p>单机均摊：每一个节点，每秒最多都只能放行一个请求</p>
<p>总体阈值：每秒所有的节点合起来只能处理一个请求</p>
<h3 id="5-6-1流控模式"><a href="#5-6-1流控模式" class="headerlink" title="5.6.1流控模式"></a>5.6.1流控模式</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-663.png" alt="img"></p>
<p>调用关系包括调用方，被调用方；一个方法又可能会调用其他方法，形成一个调用链路的层次关系；有了调用链路的统计信息，我们可以衍生出多种流量控制手段。</p>
<h4 id="直接策略"><a href="#直接策略" class="headerlink" title="直接策略"></a>直接策略</h4><p>对某个资源直接控制</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-664.png" alt="img"></p>
<h4 id="链路策略"><a href="#链路策略" class="headerlink" title="链路策略"></a>链路策略</h4><p>根据不同的调用量来限制某一个调用量（比如下图对秒杀场景进行限流）</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-665.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-668.png" alt="img"></p>
<p>当一秒内访问过快就会开启限制</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-669.png" alt="img"></p>
<p>总结：这种规则仅对于某一路径下的访问生效</p>
<h4 id="关联策略"><a href="#关联策略" class="headerlink" title="关联策略"></a>关联策略</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-670.png" alt="img"></p>
<p>在数据库中，读写请求都操作数据库的同一个资源，我们希望当订单的写比较大时，我们对读进行一个限流，实现一个优先写，这便叫关联策略。仅在写的请求量比较大时读的限流才会触发</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-671.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-672.png" alt="img"></p>
<p>我们给readDb加一个流控规则，并关联到writeDb</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-673.png" alt="img"></p>
<p>我们频繁访问readDb，没有问题</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-674.png" alt="img"></p>
<p>当频繁访问writeDb时，再去访问readDb立马就被限制住了</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-675.png" alt="img"></p>
<p>总结：资源竞争用关联策略</p>
<h3 id="5-6-2流控效果"><a href="#5-6-2流控效果" class="headerlink" title="5.6.2流控效果"></a>5.6.2流控效果</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-676.png" alt="img"></p>
<h4 id="快速失败"><a href="#快速失败" class="headerlink" title="快速失败"></a>快速失败</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-680.png" alt="img"></p>
<p>快速失败的意思是如果没有超过这个阈值，则交给业务进行处理，如果超出了每秒一个，多余的请求直接会抛出一个block exception异常，这个异常由于我们做了处理，我们自定义的MyBlockExceptionHandler会返回给一个自定义的JSON数据</p>
<p>每秒多于的请求都会响应出这个错误的JSON数据</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-677.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-678-1024x420.png" alt="img"></p>
<p>我们自定义429响应码(MyBlockExceptionHandler中)便于一会压力测试</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpServletResponse.<span class="keyword">set</span>Status<span class="params">(429)</span>;<span class="string">//to</span> many requests</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-679-1024x531.png" alt="img"></p>
<h4 id="Warm-Up"><a href="#Warm-Up" class="headerlink" title="Warm Up"></a>Warm Up</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-681.png" alt="img"></p>
<p>让系统逐步的增加自己处理的能力，以适应突然来的高峰请求</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-682.png" alt="img"></p>
<p>Warm Up的设置有两个;第一个是QPS—你想让每秒通过几个请求；Period—冷启动的周期是几秒</p>
<p>比如Period是3，它先会从1/3处开始冷启动，也就是第一秒我先放一个请求过来，剩下三个丢弃，第二秒逐步增加变为2个，第三秒接受3个到达了你的峰值QPS，以后再来稳定的处理3个请求</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-683-1024x821.png" alt="img"></p>
<p>压测测试5秒，10个并发数</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-684-1024x534.png" alt="img"></p>
<p>这58个有啥规律呢</p>
<p>从一开始的4个下一秒的5个再下一秒的10个，之后稳定10个</p>
<p>总结：Warm Up类似于踩油门，速度慢慢向上，最后稳定在顶峰</p>
<h4 id="匀速排队"><a href="#匀速排队" class="headerlink" title="匀速排队"></a>匀速排队</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-685.png" alt="img"></p>
<p>QPS=2，每秒放两个，多余的请求以前会丢在，但在匀速排队下会在这排队，等这两个请求过去了，下播再来两个，有一个最大等待时间，如果超出了最大等待时间就排队失败被丢弃</p>
<p>相当于去排队看病，医生每10十分钟看2个，没排到的排队，最大等待时间相当于医生的下班时间，超过了下班时间，没排上队的就撤了</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-686.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-687-1024x827.png" alt="img"></p>
<p>压测</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-688-1024x521.png" alt="img"></p>
<p>成功18个，去控制台看到的效果是每500毫秒一个，相当于每秒2个，没排上队的超过最大等待时间就会被丢弃了</p>
<h2 id="5-7规则-熔断规则"><a href="#5-7规则-熔断规则" class="headerlink" title="5.7规则-熔断规则"></a>5.7规则-熔断规则</h2><h3 id="5-7-1断路器工作原理"><a href="#5-7-1断路器工作原理" class="headerlink" title="5.7.1断路器工作原理"></a>5.7.1断路器工作原理</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-691-1024x587.png" alt="img"></p>
<p>死道友不死频道</p>
<p>熔断降级作为保护自身的手段，通常在客户端（调用端）进行配置</p>
<p>断路器</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-692.png" alt="img"></p>
<p>熔断降级去保护系统稳定性的工作原理（依靠断路器）：</p>
<p>如果服务B是稳定的，调用就应该通过，所以断路器的默认状态是闭合状态，此时所有的远程调用都会通过。如果某一天B服务炸了，我们断路器就可以打开，一打开我们的调用就不会通过，A就不会真正的发起远程调用，当A发请求时断路器开着，会快速得到一个错误返回，快速返回保证了请求积压不了，系统就具有很强的稳定性。</p>
<p>那么B如果哪天恢复了，A怎么知道B恢复了呢？断路器有种状态就半开，会先放请求试一试就能知道B是否恢复了</p>
<p>断路器的工作原理：</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-693-1024x524.png" alt="img"></p>
<p>断路器有 <strong>三种状态</strong>：</p>
<ul>
<li><strong>Closed（关闭）</strong>：<br>一切正常，请求可以正常发送到服务B。</li>
<li><strong>Open（打开）</strong>：<br>服务B被认为不可用，所有请求都立即失败，不再发送。</li>
<li><strong>Half-Open（半开）</strong>：<br>断路器试着“放一个请求”到服务B进行探测，判断是否恢复。</li>
</ul>
<p><strong>断路器的触发条件：</strong></p>
<p>在 <strong>关闭状态</strong> 下，会监控一些指标：</p>
<ul>
<li><strong>慢调用比例</strong>（比如：超过1秒才响应的请求）</li>
<li><strong>异常比例</strong></li>
<li><strong>异常请求数</strong></li>
</ul>
<p>只有满足两个条件才会触发统计：</p>
<ol>
<li>达到设定的 <strong>统计时长</strong>（如5秒）</li>
<li>达到 <strong>最小请求数</strong>（如5个请求）</li>
</ol>
<p>举例：</p>
<ul>
<li>如果在5秒内有100个请求，其中70个超过了“慢调用阈值”，就认为慢调用比例是70%；</li>
<li>如果这个比例超过设定的阈值（如70%），断路器就“<strong>打开</strong>”。</li>
</ul>
<p><strong>打开（Open）状态行为：</strong></p>
<ul>
<li>一旦进入 Open 状态，所有对B的请求都被拒绝（快速失败）；</li>
<li>会保持打开一段 <strong>熔断时长</strong>（如30秒）；</li>
<li>在这段时间内，不会再尝试调用服务B。</li>
</ul>
<p><strong>半开（Half-Open）状态行为：</strong></p>
<ul>
<li><p>熔断时长结束后，断路器会进入半开状态；</p>
</li>
<li><p>只允许一个请求</p>
<p>过去试探服务B是否恢复；</p>
<ul>
<li>如果<strong>成功</strong>：断路器变回关闭状态，恢复正常调用；</li>
<li>如果<strong>失败</strong>：断路器再次进入打开状态，继续熔断30秒。</li>
</ul>
</li>
</ul>
<p><strong>循环机制：</strong></p>
<p>断路器会在 “关闭 → 打开 → 半开 → 关闭/打开” 之间循环：</p>
<ul>
<li>成功 → 回到正常（关闭）</li>
<li>失败 → 再次熔断（打开）</li>
</ul>
<p>而且即便是关闭状态，也会继续统计指标。如果又超过阈值，就会重新触发熔断。</p>
<p><strong>总结一句话：</strong></p>
<blockquote>
<p>断路器是一个<strong>防止雪崩</strong>的机制，当调用方A发现被调服务B表现不佳（比如慢响应/出错），就会暂时停止调用，等服务恢复后再恢复正常调用。</p>
</blockquote>
<h3 id="5-7-2熔断策略-慢调用比例"><a href="#5-7-2熔断策略-慢调用比例" class="headerlink" title="5.7.2熔断策略-慢调用比例"></a>5.7.2熔断策略-慢调用比例</h3><p>给远程调用配置慢调用比例</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-694-1024x516.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-696-1024x617.png" alt="img"></p>
<p>RT：response time 响应时间</p>
<p>5秒内如果有80%的请求响应时间超过最大响应时间1s就是慢调用，一旦发生了慢调用我们就开启熔断，熔断时长30s（断路器打开30s），这30s内的所有请求都不会发给远程服务，最小请求数为5表示至少发五个以上的请求，样本量先上去才有统计的必要</p>
<p>测试一下慢调用比例规则</p>
<p>修改一下ProductController，让它休眠两秒再返回数据，这样便于测试</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-697-1024x701.png" alt="img"></p>
<p>这样几乎每一个接口都会超出最大响应时间，便于我们检测熔断规则是否有效</p>
<p>当熔断后返回兜底数据</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-698.png" alt="img"></p>
<h3 id="5-7-3熔断策略-异常比例"><a href="#5-7-3熔断策略-异常比例" class="headerlink" title="5.7.3熔断策略-异常比例"></a>5.7.3熔断策略-异常比例</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-699-1024x569.png" alt="img"></p>
<p>无熔断规则和有熔断规则的相同点在于远程一旦有问题都会执行兜底回调，但是有熔断规则的好处在于远程出问题，会有一段时间就不理远程了，不给远程发请求，这样就节约了远程调用时间，节约了很多的资源。</p>
<p>所以虽然没有熔断的情况下，还能正常兜底回调，但是配了熔断系统更快，在分布式系统中，只有更快，雪崩才跟不上你</p>
<p>接下来给远程调用配置异常比例</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-700-1024x611.png" alt="img"></p>
<p>5秒内至少5个请求才开始统计，当5s内的请求80%都出现了远程调用异常，熔断30s</p>
<p>触发熔断规则，熔断30s，返回兜底数据</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-701.png" alt="img"></p>
<h3 id="5-7-4熔断策略-异常数"><a href="#5-7-4熔断策略-异常数" class="headerlink" title="5.7.4熔断策略-异常数"></a>5.7.4熔断策略-异常数</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-702-1024x621.png" alt="img"></p>
<p>类似于异常比例，这是这里把比例换成了具体的数字</p>
<p>效果与上面一样，这里就不做测试了</p>
<h2 id="5-8规则-热点规则"><a href="#5-8规则-热点规则" class="headerlink" title="5.8规则-热点规则"></a>5.8规则-热点规则</h2><h3 id="5-8-1搭建环境"><a href="#5-8-1搭建环境" class="headerlink" title="5.8.1搭建环境"></a>5.8.1搭建环境</h3><p>在热点规则里边，我们可以精确到访问这个资源的时候，比如带了5个参数，我对哪些参数满足什么规则以后我进行限制，相当于一个更细致的限流规则</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-704-1024x509.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-707-1024x78.png" alt="img"></p>
<p>这里的Web指的是我们在Controller中写的接口，如果非要在Web接口上启用热点参数限流规则需要自定义埋点，自定义埋点的资源名不能和接口名重复</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-708-1024x509.png" alt="img"></p>
<h3 id="5-8-2为秒杀创建订单添加热点参数规则"><a href="#5-8-2为秒杀创建订单添加热点参数规则" class="headerlink" title="5.8.2为秒杀创建订单添加热点参数规则"></a>5.8.2为秒杀创建订单添加热点参数规则</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-709.png" alt="img"></p>
<h4 id="需求一"><a href="#需求一" class="headerlink" title="需求一"></a>需求一</h4><p>把useId作为参数索引，单机阈值设为1，我无论你userId是几，你每秒都只能有一个</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-710-1024x715.png" alt="img"></p>
<p>测试需求一</p>
<p>1号用户刷快了被流控</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-711.png" alt="img"></p>
<p>不带userId疯狂刷新不被流控，</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-713-1024x96.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-712.png" alt="img"></p>
<p>总结：需求一，携带此参数的参与流控，不携带不流控</p>
<h4 id="需求二（不限制6号用户）"><a href="#需求二（不限制6号用户）" class="headerlink" title="需求二（不限制6号用户）"></a>需求二（不限制6号用户）</h4><p>把6号用户加到参数例外项中</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-714-1024x831.png" alt="img"></p>
<p>测试需求二：</p>
<p>6号疯狂刷新不被限流</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-715.png" alt="img"></p>
<h4 id="需求三（666号商品下架了，不允许访问）"><a href="#需求三（666号商品下架了，不允许访问）" class="headerlink" title="需求三（666号商品下架了，不允许访问）"></a>需求三（666号商品下架了，不允许访问）</h4><p>因为商品ID是第二个参数，这时候我们不能修改以前的热点规则我们只能再创一个热点规则</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-716-1024x878.png" alt="img"></p>
<p>再编辑这个热点规则，把666号商品ID加到例外项中即可</p>
<p>测试需求三，规则生效，666号商品无法访问，被流控</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-717-1024x344.png" alt="img"></p>
<h4 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h4><p>我们写了兜底回调却没有回调，却返回了默认的错误页面，原因在于兜底回调有两种写法，BlockHandler这个可以专门处理被流控的异常</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-718.png" alt="img"></p>
<p>改为blockHandler就可以了</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-719-1024x476.png" alt="img"></p>
<p>之前我们讲过SentinelResource处理异常的规则是有Block优先用Block，没有指定Block才走fallback，fallback比Block的最大好处就是它还处理业务异常，比如业务期间出现了int i = 10/0，这样的话它就不属于block exception的这种情况我们只需改一下方法签名，就可以处理所有的异常</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-720-1024x481.png" alt="img"></p>
<h2 id="5-9规则-授权规则（很少使用）"><a href="#5-9规则-授权规则（很少使用）" class="headerlink" title="5.9规则-授权规则（很少使用）"></a>5.9规则-授权规则（很少使用）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-721-1024x476.png" alt="img"></p>
<p>指定哪个应用才能访问createOrder这个资源，白名单指仅我列出的可以访问，黑名单相反</p>
<h2 id="5-10规则-系统规则（很少使用）"><a href="#5-10规则-系统规则（很少使用）" class="headerlink" title="5.10规则-系统规则（很少使用）"></a>5.10规则-系统规则（很少使用）</h2><p>举个例子</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-722-1024x399.png" alt="img"></p>
<p>整个系统后台线程超过10个以后，新来的请求就限制住了</p>
<p>LOAD：系统负载</p>
<h2 id="5-11总结"><a href="#5-11总结" class="headerlink" title="5.11总结"></a>5.11总结</h2><p><strong>怎么保证重启规则还在</strong>？</p>
<p>我们在测试过程中发现我们配的规则一重启就失效，因为Sentinel并没有对这些规则做持久化，数据都是存在内存里边而且是伴随着每一个应用自己存储自己的规则，所以未来Sentinel可以结合Nacos把这些规则配置以后让它存到Nacos，而Nacos又可以连上MySQL数据库，把这些规则最终持久化，最终实现我们配置的规则重启也不丢失</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-724-1024x456.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-723-1024x545.png" alt="img"></p>
<h1 id="6-Gateway-网关"><a href="#6-Gateway-网关" class="headerlink" title="6.Gateway-网关"></a>6.Gateway-网关</h1><h2 id="6-1网关功能"><a href="#6-1网关功能" class="headerlink" title="6.1网关功能"></a>6.1网关功能</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-726.png" alt="img"></p>
<p>网关在分布式系统中扮演者非常重要的角色，它可以完成众多功能。第一，统一入口，所有请求的流量入口全部都是网关，它就像我们地铁站的安检闸机入口一样。第二，网关可以完成请求路由，交给网关的请求网关会自动判断该给谁，第三，在路由的时候网关也可以融入负载均衡算法，去来均衡集群中每一个服务器的负载量。第四，网关还能做流量控制，像我以前学习的sentinel可以融合到每一个微服务里面去控制微服务的QPS而且它还可以融入网关，由于网关是统一入口，所以一旦跟网关整合以后，可以在入口处对全局的QPS等进行统一限流。第五，网关也可以做一些身份认证，有请求过来以后，网关发现这个是未登录的用户，而我们将要访问你的资源必须登录，那我就可以把这个请求打回，让他重新登录，或者这是一些非法攻击请求，那么就把这些不往后台转了。第六，它也能完成协议转换，比如前端给网关发的请求，带的数据是一个JSON，后台微服务远程调用又需要用到GRPC协议，那网关就可以把这个JSON数据转换为GRPC通用的数据模型再往下转。第七，网关能完成系统监控，由于所有的入口都在这，那我就可以监控每一个请求从收到到结束处理了多长时间去来统计全局的慢请求，去来统计当天的访问总量等等。第八，网关还可以做安全防护，从网关层我们可以配置上一些防止跨站请求伪造，跨站脚本攻击，SQL注入等这些常见的安全问题等等</p>
<p>接下来看看Spring Cloud提供的网关</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-727-1024x543.png" alt="img"></p>
<p>分为两个版本，第一个是基于响应式编程做的网关，它可以占用少量资源，就能实现高并发。第二个是个传统的网关，用的是以前serverlet API这一套，一般后来推荐第一种</p>
<h2 id="6-2创建网关"><a href="#6-2创建网关" class="headerlink" title="6.2创建网关"></a>6.2创建网关</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-729-1024x591.png" alt="img"></p>
<p>6.2.1创建项目</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-730-1024x1006.png" alt="img"></p>
<p>6.2.2引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>为什么要引入nacos注册中心？ </p>
<p>根据网关的原理要做路由转发还需要用到注册中心</p>
<p>6.2.3创建Main方法</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">geqian</span>.<span class="property">gateway</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">SpringApplication</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">autoconfigure</span>.<span class="property">SpringBootApplication</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayMainApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="title function_">main</span>(<span class="params"><span class="title class_">String</span>[] args</span>) &#123;</span><br><span class="line">        <span class="title class_">SpringApplication</span>.<span class="title function_">run</span>(<span class="title class_">GatewayMainApplication</span>.<span class="property">class</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置application.yml</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">spring</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">application</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">name</span><span class="punctuation">:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attribute">cloud</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">nacos</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">server-addr</span><span class="punctuation">:</span> <span class="string">127.0.0.1:8848</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#localhost/api/order</span></span><br><span class="line"><span class="attribute">server</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">port</span><span class="punctuation">:</span> <span class="string">80</span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-731-1024x650.png" alt="img"></p>
<p>网关在nacos里面已经注册上来了</p>
<h2 id="6-3网关配置规则"><a href="#6-3网关配置规则" class="headerlink" title="6.3网关配置规则"></a>6.3网关配置规则</h2><p>两种方式：1.在配置文件里配置 2使用编码的方式编写路由规则  这里我们演示第一种</p>
<h3 id="用配置文件配置规则"><a href="#用配置文件配置规则" class="headerlink" title="用配置文件配置规则"></a>用配置文件配置规则</h3><p>重新建一个application-route.yml，记得在application.yml引入</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-732.png" alt="img"></p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">spring</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">cloud</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">gateway</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">routes</span><span class="punctuation">:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">id: order-route</span></span><br><span class="line">          <span class="attribute">uri</span><span class="punctuation">:</span> <span class="string">lb://service-order</span></span><br><span class="line">          <span class="attribute">predicates</span><span class="punctuation">:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/order/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">id: product-route</span></span><br><span class="line">          <span class="attribute">uri</span><span class="punctuation">:</span> <span class="string">lb://service-product</span></span><br><span class="line">          <span class="attribute">predicates</span><span class="punctuation">:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/product/**</span></span><br></pre></td></tr></table></figure>
<p>id就是给这个路由起个名字就叫order-route</p>
<p>uri，要把请求转给哪里 lb是load balancer的缩写代表着负载均衡，也就是接下来负载均衡的转给service-order（微服务名）</p>
<p>predicates（断言）定义了你遵循哪个规则时转</p>
<p>第一规则叫路径，如果你以api/order请求开头的所有请求我都转个server-order这个微服务</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-734.png" alt="img"></p>
<p>这里是可以写的更多的扩展配置</p>
<p>注意一个坑点：由于SpringCloud新版将负载均衡单独抽取了出来，因此还要单独引入负载均衡的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-735-1024x472.png" alt="img"></p>
<p>在OrderController加入@RequestMapping(“/api/order”)，代表这个类以后所有请求都以api/order开始，同样的商品服务和ProductFeignClient都加上@RequestMapping(“/api/product”) </p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-737.png" alt="img"></p>
<p>我们刷新4次，发现8000端口调用2次，8001端口调用2次，符合负载均衡的要求</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-738-1024x513.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-739-1024x477.png" alt="img"></p>
<h2 id="6-4路由的基础原理"><a href="#6-4路由的基础原理" class="headerlink" title="6.4路由的基础原理"></a>6.4路由的基础原理</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-741.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-742-1024x447.png" alt="img"></p>
<p>简述一下流程：当请求交给网关，网关先在它的路由表规则里边使用断言机制进行匹配，匹配到哪个规则就按照这个规则把请求准备转给指定的目的地，但是在转之前，它再会拿到这个规则配置的所有Filter，底层是通过这两个组件进行配合，网关里边有一个Handler Mapping 称为请求映射，在Handler Mapping 里边它知道某些规则要转给哪，但是怎么转它又会使用一个WebHandler叫处理器，处理器就会调用整个Filter链路把请求挨个转下去，因为请求和响应是一个双向关系，所以请求往下转的时候先经过Filter的前置方法转给目的地，目的地处理完了以后把响应交给网关，再倒序经过每一个Filter最终把响应交给指定的客户端</p>
<p>🔁 Spring Cloud Gateway 的请求处理流程梳理：</p>
<p>1️⃣ 请求进入网关</p>
<p>客户端发出请求，请求首先被 Spring Cloud Gateway 接收到。</p>
<p>2️⃣ 网关根据路由规则匹配请求</p>
<p>网关内部维护了一张 <strong>路由规则表</strong>（Route）：</p>
<ul>
<li>每条规则包含三部分：<ul>
<li><strong>Predicate（断言）</strong>：判断请求是否匹配，比如路径是否是 <code>/user/**</code></li>
<li><strong>URI（目的地）</strong>：匹配成功后请求要转发到哪里</li>
<li><strong>Filter（过滤器）</strong>：请求经过的拦截处理器，比如鉴权、日志、限流等</li>
</ul>
</li>
</ul>
<blockquote>
<p>✅ 匹配成功后，网关准备把请求转发到目的地。</p>
</blockquote>
<p>3️⃣ HandlerMapping 与 WebHandler 协作处理</p>
<p>这两个是网关的底层组件：</p>
<ul>
<li><strong>HandlerMapping</strong>：根据请求匹配路由规则</li>
<li><strong>WebHandler</strong>：根据匹配的规则执行请求转发和过滤器调用</li>
</ul>
<p>4️⃣ 请求流经 Filter 链（过滤器链）</p>
<p>Filter 有两个阶段：</p>
<ul>
<li><strong>前置处理（pre）</strong>：在转发前做事情（如鉴权、限流、修改请求头等）</li>
<li><strong>后置处理（post）</strong>：响应返回时再做事（如日志、加密响应数据等）</li>
</ul>
<p>整个过程像“洋葱模型”一样包裹处理：</p>
<ul>
<li>请求流经所有 Filter → 到达目的服务；</li>
<li>响应回来时，再反向流经所有 Filter → 返回客户端。</li>
</ul>
<p>5️⃣ 响应返回客户端</p>
<p>目的服务处理完请求，返回响应，经过 Filter 链倒序处理，最后交回给客户端。</p>
<p><strong>总结一句话：</strong></p>
<blockquote>
<p>Spring Cloud Gateway 会先<strong>匹配路由规则</strong> → 执行<strong>过滤器链</strong> → 将请求<strong>转发到目标服务</strong>，响应回来的时候再<strong>倒序通过过滤器</strong>返回给客户端。</p>
</blockquote>
<h4 id="理解一下拦截器的作用"><a href="#理解一下拦截器的作用" class="headerlink" title="理解一下拦截器的作用"></a>理解一下拦截器的作用</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-743.png" alt="img"></p>
<p>由于是按照顺序匹配，即使此时我们给订单发请求，也会被第一个规则所拦截，直接访问到了第一个bing的目的地</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-744-1024x798.png" alt="img"></p>
<p>为了解决顺序这个问题我们可以加入order这个项，order越小优先级越高</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-745.png" alt="img"></p>
<p>此时请求就又能转给Db了</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-746.png" alt="img"></p>
<h2 id="6-5断言"><a href="#6-5断言" class="headerlink" title="6.5断言"></a>6.5断言</h2><h3 id="6-5-1断言的写法"><a href="#6-5-1断言的写法" class="headerlink" title="6.5.1断言的写法"></a>6.5.1断言的写法</h3><p>断言的写法有两种短写法和全写法</p>
<p>短写法：</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-748.png" alt="img"></p>
<p>全写法：</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-749.png" alt="img"></p>
<p>把短写法改造为全写法</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">Path=/api/order/**</span></span><br><span class="line">          <span class="attribute">predicates</span><span class="punctuation">:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">name: Path</span></span><br><span class="line">              <span class="attribute">args</span><span class="punctuation">:</span></span><br><span class="line">                <span class="attribute">patterns</span><span class="punctuation">:</span> <span class="string">/api/order/**</span></span><br><span class="line">                <span class="attribute">matchTrailingSlash</span><span class="punctuation">:</span> <span class="string">true</span></span><br></pre></td></tr></table></figure>
<p> pattern：规则，满足什么规则？</p>
<p>matchTrailingSlash：默认为true，表示匹配后面的/，例如/red/1和/red/1/是同一个路径，当false时表示是不同的路径</p>
<h3 id="6-5-2断言规则"><a href="#6-5-2断言规则" class="headerlink" title="6.5.2断言规则"></a>6.5.2断言规则</h3><p>有多少种断言机制？</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-747-1024x1013.png" alt="img"></p>
<p>每一个在官方文档都有详细的示例，这里只演示一个Query</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-750.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-751.png" alt="img"></p>
<p>当每个规则都匹配时网关才能把请求转给bing</p>
<h3 id="6-5-3自定义断言工厂"><a href="#6-5-3自定义断言工厂" class="headerlink" title="6.5.3自定义断言工厂"></a>6.5.3自定义断言工厂</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-752.png" alt="img"></p>
<p>需求：Vip 用户才能访问</p>
<p>代码仿照原有的断言源码（用AI写）</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">gateway</span>.<span class="property">predicate</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="property">validation</span>.<span class="property">constraints</span>.<span class="property">NotEmpty</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">cloud</span>.<span class="property">gateway</span>.<span class="property">handler</span>.<span class="property">predicate</span>.<span class="property">AbstractRoutePredicateFactory</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">cloud</span>.<span class="property">gateway</span>.<span class="property">handler</span>.<span class="property">predicate</span>.<span class="property">GatewayPredicate</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">cloud</span>.<span class="property">gateway</span>.<span class="property">handler</span>.<span class="property">predicate</span>.<span class="property">QueryRoutePredicateFactory</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">http</span>.<span class="property">server</span>.<span class="property">reactive</span>.<span class="property">ServerHttpRequest</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">stereotype</span>.<span class="property">Component</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">util</span>.<span class="property">StringUtils</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">validation</span>.<span class="property">annotation</span>.<span class="property">Validated</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">web</span>.<span class="property">server</span>.<span class="property">ServerWebExchange</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">Arrays</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">List</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">function</span>.<span class="property">Predicate</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VipRoutePredicateFactory</span> <span class="keyword">extends</span> <span class="title class_ inherited__">AbstractRoutePredicateFactory</span>&lt;<span class="title class_">VipRoutePredicateFactory</span>.<span class="property">Config</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">VipRoutePredicateFactory</span>() &#123;</span><br><span class="line">        <span class="variable language_">super</span>(<span class="title class_">Config</span>.<span class="property">class</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Predicate</span>&lt;<span class="title class_">ServerWebExchange</span>&gt; <span class="title function_">apply</span>(<span class="params"><span class="title class_">Config</span> config</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GatewayPredicate</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">boolean</span> <span class="title function_">test</span>(<span class="params"><span class="title class_">ServerWebExchange</span> serverWebExchange</span>) &#123;</span><br><span class="line">                <span class="comment">// localhost/search?q=haha&amp;user=leifengyang</span></span><br><span class="line">                <span class="title class_">ServerHttpRequest</span> request = serverWebExchange.<span class="title function_">getRequest</span>();</span><br><span class="line"></span><br><span class="line">                <span class="title class_">String</span> first = request.<span class="title function_">getQueryParams</span>().<span class="title function_">getFirst</span>(config.<span class="property">param</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="title class_">StringUtils</span>.<span class="title function_">hasText</span>(first) &amp;&amp; first.<span class="title function_">equals</span>(config.<span class="property">value</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">List</span>&lt;<span class="title class_">String</span>&gt; <span class="title function_">shortcutFieldOrder</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Arrays</span>.<span class="title function_">asList</span>(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 可以配置的参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Validated</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Config</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@NotEmpty</span></span><br><span class="line">        <span class="keyword">private</span> <span class="title class_">String</span> param;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="meta">@NotEmpty</span></span><br><span class="line">        <span class="keyword">private</span> <span class="title class_">String</span> value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="meta">@NotEmpty</span> <span class="title class_">String</span> <span class="title function_">getParam</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> param;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setParam</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="title class_">String</span> param</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">param</span> = param;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="meta">@NotEmpty</span> <span class="title class_">String</span> <span class="title function_">getValue</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setValue</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="title class_">String</span> value</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">value</span> = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-754.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-757-1024x340.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-758-1024x511.png" alt="img"></p>
<h2 id="6-6Filter-过滤器"><a href="#6-6Filter-过滤器" class="headerlink" title="6.6Filter-过滤器"></a>6.6Filter-过滤器</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-759-1024x618.png" alt="img"></p>
<h3 id="6-6-1路径重写Filter"><a href="#6-6-1路径重写Filter" class="headerlink" title="6.6.1路径重写Filter"></a>6.6.1路径重写Filter</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-760-1024x589.png" alt="img"></p>
<p>之前每个controller上加@RequestMapping(“/api/order”)有点麻烦，这里可以通过路径重写来解决这个问题，在配置文件中来加过滤器</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-761.png" alt="img"></p>
<p>这样配置后就不用加基准路径@RequestMapping(“/api/order”)了</p>
<h3 id="6-6-2过滤规则"><a href="#6-6-2过滤规则" class="headerlink" title="6.6.2过滤规则"></a>6.6.2过滤规则</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-762-1024x558.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-763.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-764.png" alt="img"></p>
<h3 id="6-6-3默认Filter"><a href="#6-6-3默认Filter" class="headerlink" title="6.6.3默认Filter"></a>6.6.3默认Filter</h3><p>default-filters</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-765-1024x473.png" alt="img"></p>
<p>加入默认Filter后商品虽然没有AddResponseHeader这个规则，但也会生效</p>
<h3 id="6-6-4Global-Filters"><a href="#6-6-4Global-Filters" class="headerlink" title="6.6.4Global Filters"></a>6.6.4Global Filters</h3><p>为响应时间写一个全局的Filter</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-766-1024x533.png" alt="img"></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">package com.atguigu.gateway.<span class="keyword">filter</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.<span class="keyword">filter</span>.GatewayFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.<span class="keyword">filter</span>.GlobalFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.<span class="keyword">server</span>.reactive.ServerHttpRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.<span class="keyword">server</span>.reactive.ServerHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.<span class="keyword">server</span>.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">@Slf4j</span><br><span class="line"><span class="built_in">public</span> <span class="keyword">class</span> RtGlobalFilter implements GlobalFilter, Ordered &#123;</span><br><span class="line">    @Override</span><br><span class="line">    <span class="built_in">public</span> Mono&lt;<span class="type">Void</span>&gt; <span class="keyword">filter</span>(ServerWebExchange exchange, GatewayFilterChain chain) &#123;</span><br><span class="line">        ServerHttpRequest request = exchange.getRequest();</span><br><span class="line">        ServerHttpResponse response = exchange.getResponse();</span><br><span class="line"></span><br><span class="line">        String uri = request.getURI().toString();</span><br><span class="line">        long start = <span class="keyword">System</span>.currentTimeMillis();</span><br><span class="line">        <span class="keyword">log</span>.<span class="keyword">info</span>(&quot;请求【&#123;&#125;】开始：时间：&#123;&#125;&quot;,uri,<span class="keyword">start</span>);</span><br><span class="line">        //========================以上是前置逻辑=========================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Mono&lt;<span class="type">Void</span>&gt; <span class="keyword">filter</span> = chain.<span class="keyword">filter</span>(exchange)</span><br><span class="line">                .doFinally((result)-&gt;&#123;</span><br><span class="line">                    //=======================以下是后置逻辑=========================</span><br><span class="line">                    long end = <span class="keyword">System</span>.currentTimeMillis();</span><br><span class="line">                    <span class="keyword">log</span>.<span class="keyword">info</span>(&quot;请求【&#123;&#125;】结束：时间：&#123;&#125;，耗时：&#123;&#125;ms&quot;,uri,<span class="keyword">end</span>,<span class="keyword">end</span>-<span class="keyword">start</span>);</span><br><span class="line">                &#125;); //放行   <span class="number">10</span>s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">filter</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="built_in">public</span> <span class="type">int</span> getOrder() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-767-1024x125.png" alt="img"></p>
<h3 id="6-6-5自定义过滤器工厂"><a href="#6-6-5自定义过滤器工厂" class="headerlink" title="6.6.5自定义过滤器工厂"></a>6.6.5自定义过滤器工厂</h3><p>代码仿照原有的断言源码（用AI写）</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-768-1024x413.png" alt="img"></p>
<p>自定义的过滤器名字是方法的前缀</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-769.png" alt="img"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.gateway.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.factory.AbstractNameValueGatewayFilterFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.server.reactive.ServerHttpResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OnceTokenGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title class_">AbstractNameValueGatewayFilterFactory</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> GatewayFilter <span class="title function_">apply</span><span class="params">(NameValueConfig config)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GatewayFilter</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">                <span class="comment">//每次响应之前，添加一个一次性令牌，支持 uuid，jwt等各种格式</span></span><br><span class="line">                <span class="keyword">return</span> chain.filter(exchange).then(Mono.fromRunnable(()-&gt;&#123;</span><br><span class="line">                    <span class="type">ServerHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> exchange.getResponse();</span><br><span class="line">                    <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> response.getHeaders();</span><br><span class="line">                    <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> config.getValue();</span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">&quot;uuid&quot;</span>.equalsIgnoreCase(value))&#123;</span><br><span class="line">                        value = UUID.randomUUID().toString();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">&quot;jwt&quot;</span>.equalsIgnoreCase(value))&#123;</span><br><span class="line">                        value = <span class="string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    headers.add(config.getName(),value);</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-770-1024x503.png" alt="img"></p>
<h2 id="6-7跨域-CORS-配置"><a href="#6-7跨域-CORS-配置" class="headerlink" title="6.7跨域(CORS)配置"></a>6.7跨域(CORS)配置</h2><h3 id="6-7-1全局跨域"><a href="#6-7-1全局跨域" class="headerlink" title="6.7.1全局跨域"></a>6.7.1全局跨域</h3><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">spring</span><span class="punctuation">:</span></span><br><span class="line"> <span class="attribute">cloud</span><span class="punctuation">:</span></span><br><span class="line">   <span class="attribute">gateway</span><span class="punctuation">:</span></span><br><span class="line">     <span class="attribute">globalcors</span><span class="punctuation">:</span></span><br><span class="line">       <span class="attribute">cors-configurations</span><span class="punctuation">:</span></span><br><span class="line">         <span class="attribute">&#x27;[/**]&#x27;</span><span class="punctuation">:</span></span><br><span class="line">           <span class="attribute">allowed-origin-patterns</span><span class="punctuation">:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">           <span class="attribute">allowed-headers</span><span class="punctuation">:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">           <span class="attribute">allowed-methods</span><span class="punctuation">:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-771.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-772-1024x174.png" alt="img"></p>
<h3 id="6-7-2局部跨域"><a href="#6-7-2局部跨域" class="headerlink" title="6.7.2局部跨域"></a>6.7.2局部跨域</h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">spring:</span></span><br><span class="line"><span class="symbol"> cloud:</span></span><br><span class="line"><span class="symbol">   gateway:</span></span><br><span class="line"><span class="symbol">     routes:</span></span><br><span class="line">     - id: cors_route</span><br><span class="line"><span class="symbol">       uri:</span> https:<span class="comment">//example.org</span></span><br><span class="line"><span class="symbol">       predicates:</span></span><br><span class="line">       - P<span class="attr">ath</span><span class="operator">=</span><span class="keyword">/service/</span>**</span><br><span class="line"><span class="symbol">       metadata:</span></span><br><span class="line"><span class="symbol">         cors:</span></span><br><span class="line"><span class="symbol">           allowedOrigins:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="symbol">           allowedMethods:</span></span><br><span class="line">             - GET</span><br><span class="line">             - POST</span><br><span class="line"><span class="symbol">           allowedHeaders:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="symbol">           maxAge:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>
<h2 id="6-8总结"><a href="#6-8总结" class="headerlink" title="6.8总结"></a>6.8总结</h2><p>面试题：微服务之间的调用经过网关吗？</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-773.png" alt="img"></p>
<p>不经过，但如果你想要过网关也是可以实现的（不建议）</p>
<p><strong>微服务之间的调用</strong>是否经过网关，要看具体的业务场景和架构设计。</p>
<p>🔹 <strong>通常情况下，网关主要用于外部客户端访问微服务</strong>，作为统一入口，提供鉴权、路由、限流、日志等功能。</p>
<p>🔹 <strong>微服务之间的内部调用（服务与服务之间），一般不会经过网关</strong>，而是通过 <strong>服务注册与发现</strong>（如 Nacos、Eureka）加上 <strong>负载均衡组件</strong>（如 Ribbon、Feign、RestTemplate）进行直连调用，效率更高、开销更小。</p>
<p>当然，如果企业对 <strong>链路监控、安全控制</strong> 有统一规范，也可能让微服务间的调用也经过网关，但这并不常见，会带来额外的网络和性能开销。</p>
<h1 id="7-Seata-分布式事务"><a href="#7-Seata-分布式事务" class="headerlink" title="7.Seata-分布式事务"></a>7.Seata-分布式事务</h1><p>官⽹：<a target="_blank" rel="noopener" href="https://seata.apache.org/zh-cn/">https://seata.apache.org/zh-cn/</a></p>
<h2 id="7-1环境准备"><a href="#7-1环境准备" class="headerlink" title="7.1环境准备"></a>7.1环境准备</h2><p>下载 seata ⼯程⽂件，导⼊到项⽬中，并在services中添加module聚合</p>
<p>导入SQL</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE IF <span class="literal">NOT</span> EXISTS `storage_db`;</span><br><span class="line"></span><br><span class="line">USE `storage_db`;</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS `storage_tbl`;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `storage_tbl` (</span><br><span class="line"></span><br><span class="line">                `id` int(<span class="number">11</span>) <span class="literal">NOT</span> NULL AUTO_INCREMENT,</span><br><span class="line"></span><br><span class="line">                `commodity_code` varchar(<span class="number">255</span>) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">                `count` int(<span class="number">11</span>) DEFAULT <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">                PRIMARY KEY (`id`),</span><br><span class="line"></span><br><span class="line">                UNIQUE KEY (`commodity_code`)</span><br><span class="line"></span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">INSERT INTO storage_tbl (commodity_code, count) VALUES (&#x27;P0001&#x27;, <span class="number">100</span>)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">INSERT INTO storage_tbl (commodity_code, count) VALUES (&#x27;B1234&#x27;, <span class="number">10</span>)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">-- 注意此处<span class="number">0.3</span>.<span class="number">0</span>+ 增加唯一索引 ux_undo_log</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS `undo_log`;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `undo_log` (</span><br><span class="line"></span><br><span class="line">              `id` bigint(<span class="number">20</span>) <span class="literal">NOT</span> NULL AUTO_INCREMENT,</span><br><span class="line"></span><br><span class="line">              `branch_id` bigint(<span class="number">20</span>) <span class="literal">NOT</span> NULL,</span><br><span class="line"></span><br><span class="line">              `xid` varchar(<span class="number">100</span>) <span class="literal">NOT</span> NULL,</span><br><span class="line"></span><br><span class="line">              `context` varchar(<span class="number">128</span>) <span class="literal">NOT</span> NULL,</span><br><span class="line"></span><br><span class="line">              `rollback_info` longblob <span class="literal">NOT</span> NULL,</span><br><span class="line"></span><br><span class="line">              `log_status` int(<span class="number">11</span>) <span class="literal">NOT</span> NULL,</span><br><span class="line"></span><br><span class="line">              `log_created` datetime <span class="literal">NOT</span> NULL,</span><br><span class="line"></span><br><span class="line">              `log_modified` datetime <span class="literal">NOT</span> NULL,</span><br><span class="line"></span><br><span class="line">              `ext` varchar(<span class="number">100</span>) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">              PRIMARY KEY (`id`),</span><br><span class="line"></span><br><span class="line">              UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)</span><br><span class="line"></span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=<span class="number">1</span> DEFAULT CHARSET=utf8<span class="comment">;</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">CREATE DATABASE IF <span class="literal">NOT</span> EXISTS `order_db`;</span><br><span class="line"></span><br><span class="line">USE `order_db`;</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS `order_tbl`;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `order_tbl` (</span><br><span class="line"></span><br><span class="line">               `id` int(<span class="number">11</span>) <span class="literal">NOT</span> NULL AUTO_INCREMENT,</span><br><span class="line"></span><br><span class="line">               `user_id` varchar(<span class="number">255</span>) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">               `commodity_code` varchar(<span class="number">255</span>) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">               `count` int(<span class="number">11</span>) DEFAULT <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">               `money` int(<span class="number">11</span>) DEFAULT <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">               PRIMARY KEY (`id`)</span><br><span class="line"></span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">-- 注意此处<span class="number">0.3</span>.<span class="number">0</span>+ 增加唯一索引 ux_undo_log</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS `undo_log`;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `undo_log` (</span><br><span class="line"></span><br><span class="line">              `id` bigint(<span class="number">20</span>) <span class="literal">NOT</span> NULL AUTO_INCREMENT,</span><br><span class="line"></span><br><span class="line">              `branch_id` bigint(<span class="number">20</span>) <span class="literal">NOT</span> NULL,</span><br><span class="line"></span><br><span class="line">              `xid` varchar(<span class="number">100</span>) <span class="literal">NOT</span> NULL,</span><br><span class="line"></span><br><span class="line">              `context` varchar(<span class="number">128</span>) <span class="literal">NOT</span> NULL,</span><br><span class="line"></span><br><span class="line">              `rollback_info` longblob <span class="literal">NOT</span> NULL,</span><br><span class="line"></span><br><span class="line">              `log_status` int(<span class="number">11</span>) <span class="literal">NOT</span> NULL,</span><br><span class="line"></span><br><span class="line">              `log_created` datetime <span class="literal">NOT</span> NULL,</span><br><span class="line"></span><br><span class="line">              `log_modified` datetime <span class="literal">NOT</span> NULL,</span><br><span class="line"></span><br><span class="line">              `ext` varchar(<span class="number">100</span>) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">              PRIMARY KEY (`id`),</span><br><span class="line"></span><br><span class="line">              UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)</span><br><span class="line"></span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=<span class="number">1</span> DEFAULT CHARSET=utf8<span class="comment">;</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">CREATE DATABASE IF <span class="literal">NOT</span> EXISTS `account_db`;</span><br><span class="line"></span><br><span class="line">USE `account_db`;</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS `account_tbl`;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `account_tbl` (</span><br><span class="line"></span><br><span class="line">                `id` int(<span class="number">11</span>) <span class="literal">NOT</span> NULL AUTO_INCREMENT,</span><br><span class="line"></span><br><span class="line">                `user_id` varchar(<span class="number">255</span>) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">                `money` int(<span class="number">11</span>) DEFAULT <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">                PRIMARY KEY (`id`)</span><br><span class="line"></span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">INSERT INTO account_tbl (user_id, money) VALUES (&#x27;<span class="number">1</span>&#x27;, <span class="number">10000</span>)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">-- 注意此处<span class="number">0.3</span>.<span class="number">0</span>+ 增加唯一索引 ux_undo_log</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS `undo_log`;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `undo_log` (</span><br><span class="line"></span><br><span class="line">              `id` bigint(<span class="number">20</span>) <span class="literal">NOT</span> NULL AUTO_INCREMENT,</span><br><span class="line"></span><br><span class="line">              `branch_id` bigint(<span class="number">20</span>) <span class="literal">NOT</span> NULL,</span><br><span class="line"></span><br><span class="line">              `xid` varchar(<span class="number">100</span>) <span class="literal">NOT</span> NULL,</span><br><span class="line"></span><br><span class="line">              `context` varchar(<span class="number">128</span>) <span class="literal">NOT</span> NULL,</span><br><span class="line"></span><br><span class="line">              `rollback_info` longblob <span class="literal">NOT</span> NULL,</span><br><span class="line"></span><br><span class="line">              `log_status` int(<span class="number">11</span>) <span class="literal">NOT</span> NULL,</span><br><span class="line"></span><br><span class="line">              `log_created` datetime <span class="literal">NOT</span> NULL,</span><br><span class="line"></span><br><span class="line">              `log_modified` datetime <span class="literal">NOT</span> NULL,</span><br><span class="line"></span><br><span class="line">              `ext` varchar(<span class="number">100</span>) DEFAULT NULL,</span><br><span class="line"></span><br><span class="line">              PRIMARY KEY (`id`),</span><br><span class="line"></span><br><span class="line">              UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)</span><br><span class="line"></span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=<span class="number">1</span> DEFAULT CHARSET=utf8<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<h2 id="7-2打通远程链路"><a href="#7-2打通远程链路" class="headerlink" title="7.2打通远程链路"></a>7.2打通远程链路</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-777.png" alt="img"></p>
<p>1.扣减库存</p>
<p>StorageFeignClient中</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">package</span> <span class="selector-tag">com</span><span class="selector-class">.atguigu</span><span class="selector-class">.business</span><span class="selector-class">.feign</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.cloud</span><span class="selector-class">.openfeign</span><span class="selector-class">.FeignClient</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.web</span><span class="selector-class">.bind</span><span class="selector-class">.annotation</span><span class="selector-class">.GetMapping</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.web</span><span class="selector-class">.bind</span><span class="selector-class">.annotation</span><span class="selector-class">.RequestParam</span>;</span><br><span class="line"></span><br><span class="line">@<span class="selector-tag">FeignClient</span>(value = <span class="string">&quot;seata-storage&quot;</span>)</span><br><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">interface</span> <span class="selector-tag">StorageFeignClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扣减库存</span></span><br><span class="line"><span class="comment">     * @param commodityCode</span></span><br><span class="line"><span class="comment">     * @param count</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="variable">@GetMapping</span>(<span class="string">&quot;/deduct&quot;</span>)</span><br><span class="line">    String <span class="built_in">deduct</span>(<span class="variable">@RequestParam</span>(<span class="string">&quot;commodityCode&quot;</span>) String commodityCode,</span><br><span class="line">                         <span class="variable">@RequestParam</span>(<span class="string">&quot;count&quot;</span>) Integer count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BusinessService</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.business.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BusinessService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 采购</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId            用户id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> commodityCode     商品编号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderCount        购买数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">purchase</span><span class="params">(String userId, String commodityCode, <span class="keyword">int</span> orderCount)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BusinessServiceImpl</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.business.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.business.feign.OrderFeignClient;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.business.feign.StorageFeignClient;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.business.service.BusinessService;</span><br><span class="line"><span class="keyword">import</span> org.apache.seata.spring.annotation.GlobalTransactional;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_"><span class="keyword">class</span> <span class="title">BusinessServiceImpl</span> <span class="keyword"><span class="keyword">implements</span> <span class="type">BusinessService</span></span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    StorageFeignClient storageFeignClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    OrderFeignClient orderFeignClient;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GlobalTransactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> void purchase(<span class="keyword">String</span> userId, <span class="keyword">String</span> commodityCode, int orderCount) &#123;</span><br><span class="line">        <span class="comment">//1. 扣减库存</span></span><br><span class="line">        storageFeignClient.deduct(commodityCode, orderCount);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 创建订单</span></span><br><span class="line">        orderFeignClient.create(userId, commodityCode, orderCount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.创建订单</p>
<p>OrderFeignClient中</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">package</span> <span class="selector-tag">com</span><span class="selector-class">.atguigu</span><span class="selector-class">.business</span><span class="selector-class">.feign</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.cloud</span><span class="selector-class">.openfeign</span><span class="selector-class">.FeignClient</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.web</span><span class="selector-class">.bind</span><span class="selector-class">.annotation</span><span class="selector-class">.GetMapping</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.web</span><span class="selector-class">.bind</span><span class="selector-class">.annotation</span><span class="selector-class">.RequestParam</span>;</span><br><span class="line"></span><br><span class="line">@<span class="selector-tag">FeignClient</span>(value = <span class="string">&quot;seata-order&quot;</span>)</span><br><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">interface</span> <span class="selector-tag">OrderFeignClient</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建订单</span></span><br><span class="line"><span class="comment">     * @param userId</span></span><br><span class="line"><span class="comment">     * @param commodityCode</span></span><br><span class="line"><span class="comment">     * @param orderCount</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="variable">@GetMapping</span>(<span class="string">&quot;/create&quot;</span>)</span><br><span class="line">    String <span class="built_in">create</span>(<span class="variable">@RequestParam</span>(<span class="string">&quot;userId&quot;</span>) String userId,</span><br><span class="line">                         <span class="variable">@RequestParam</span>(<span class="string">&quot;commodityCode&quot;</span>) String commodityCode,</span><br><span class="line">                         <span class="variable">@RequestParam</span>(<span class="string">&quot;count&quot;</span>) int orderCount);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.减余额</p>
<p>AccountFeignClient</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">package</span> <span class="selector-tag">com</span><span class="selector-class">.atguigu</span><span class="selector-class">.order</span><span class="selector-class">.feign</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.cloud</span><span class="selector-class">.openfeign</span><span class="selector-class">.FeignClient</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.web</span><span class="selector-class">.bind</span><span class="selector-class">.annotation</span><span class="selector-class">.GetMapping</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">org</span><span class="selector-class">.springframework</span><span class="selector-class">.web</span><span class="selector-class">.bind</span><span class="selector-class">.annotation</span><span class="selector-class">.RequestParam</span>;</span><br><span class="line"></span><br><span class="line">@<span class="selector-tag">FeignClient</span>(value = <span class="string">&quot;seata-account&quot;</span>)</span><br><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">interface</span> <span class="selector-tag">AccountFeignClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扣减账户余额</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="variable">@GetMapping</span>(<span class="string">&quot;/debit&quot;</span>)</span><br><span class="line">    String <span class="built_in">debit</span>(<span class="variable">@RequestParam</span>(<span class="string">&quot;userId&quot;</span>) String userId,</span><br><span class="line">                        <span class="variable">@RequestParam</span>(<span class="string">&quot;money&quot;</span>) int money);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>OrderServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.order.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.order.bean.OrderTbl;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.order.feign.AccountFeignClient;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.order.mapper.OrderTblMapper;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.order.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    OrderTblMapper orderTblMapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    AccountFeignClient accountFeignClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> OrderTbl <span class="title function_">create</span><span class="params">(String userId, String commodityCode, <span class="type">int</span> orderCount)</span> &#123;</span><br><span class="line">        <span class="comment">//1、计算订单价格</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">orderMoney</span> <span class="operator">=</span> calculate(commodityCode, orderCount);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2、扣减账户余额</span></span><br><span class="line">        accountFeignClient.debit(userId, orderMoney);</span><br><span class="line">        <span class="comment">//3、保存订单</span></span><br><span class="line">        <span class="type">OrderTbl</span> <span class="variable">orderTbl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderTbl</span>();</span><br><span class="line">        orderTbl.setUserId(userId);</span><br><span class="line">        orderTbl.setCommodityCode(commodityCode);</span><br><span class="line">        orderTbl.setCount(orderCount);</span><br><span class="line">        orderTbl.setMoney(orderMoney);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3、保存订单</span></span><br><span class="line">        orderTblMapper.insert(orderTbl);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">10</span>/<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> orderTbl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算价格</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">calculate</span><span class="params">(String commodityCode, <span class="type">int</span> orderCount)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">9</span>*orderCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试：下一个订单</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-779-1024x488.png" alt="img"></p>
<p>去表里看一下，发现库存扣了2个，账户余额减了18，远程调用链是通的</p>
<p>但是如果在最后一步加入一个异常，创建订单时没有成功，但发现库存扣了，余额也扣了即部分回滚，这便是分布式系统下出现的分布式事务没有一起提交没有一起回滚出现的数据不一致问题</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-780.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-781-1024x496.png" alt="img"></p>
<h2 id="7-3架构原理-Seata-的分布式事务处理原理"><a href="#7-3架构原理-Seata-的分布式事务处理原理" class="headerlink" title="7.3架构原理(Seata 的分布式事务处理原理)"></a>7.3架构原理(<strong>Seata 的分布式事务处理原理</strong>)</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-782-1024x510.png" alt="img"></p>
<p>TC:相当于项目经理，TC去来感知全局事务和分支事务的状态，基于它们的状态，然后驱动谁来提交，谁来回滚，TC是一个中间件，需要下载TC服务器启动起来</p>
<ul>
<li>管理所有事务（全局 + 分支）状态；</li>
<li>决定：谁提交、谁回滚；</li>
<li>是一个中间件，需要独立部署；</li>
<li>所有 RM、TM 都要和 TC 通信。</li>
</ul>
<p>TM：负责发起任务，开启全局事务，全局事务要调用每一个微服务，做自己的分支事情</p>
<p>是全局事务的发起者；</p>
<p>一般存在于<strong>业务服务</strong>（如：下单服务、支付服务）中；</p>
<p>负责：</p>
<ul>
<li>开启一个 <strong>全局事务</strong>；</li>
<li>调用多个子服务（每个服务执行自己的“分支事务”）；</li>
<li>最终由 TC 统一控制提交或回滚。</li>
</ul>
<p>RM：每一个微服务里面去控制事务的在Seata中称为RM资源管理器，只管理自己的资源，它的作用就是处理好它的分支事务，它分支事务的提交回滚都是RM来做，RM也要跟TC及时通信，去来及时的报告它的事务状态，方便TC进行总体管控</p>
<p>每个微服务里负责<strong>自己的本地数据库事务</strong>；</p>
<p>与 TC 通信：</p>
<ul>
<li>注册自己的分支事务；</li>
<li>上报自己的事务状态；</li>
</ul>
<p>接收 TC 的命令：<strong>提交 or 回滚分支事务</strong>；</p>
<p>通过 <strong>undo_log</strong> 实现回滚（哪怕之前已经提交，也能改回来）。</p>
<p>简述一下流程：整个工作流程就是：首先全局事务如果要开始，业务的入口会开启一个global transaction（全局事务），全局事务的开启也要告诉TC，TC知道我们要开始做一个全局事务了，接下来我们每调用的一个远程微服务它们就是一个分支事务，如果它们的事务开始，它们要注册自己的分支事务给TC，那么TC也知道我们当前全局事务的当前状态正在做某一个分支事务，而且这个分支事务的状态也要汇报给TC（分支事务是提交了还是回滚了），每一个微服务都一样，那这样的话如果某一个环节出现问题例如accout，TC就会要求那个出问题的微服务accout对他的事务进行回滚，而且由于TC知道accout出了问题，而其他微服务可能不知道，它们可能已经提交了，但就算你提交了,TC会要求你们把提交的数据再改回去，已提交的事务怎么改回去，它是基于一个undo_log机制，Seata的工作原理就是这样的</p>
<p>🟡<strong>步骤 1：开始全局事务（TM 发起）</strong></p>
<ul>
<li>比如业务入口是 <code>Business</code> 服务（下单）；</li>
<li>TM 开启一个 Global Transaction（全局事务）；</li>
<li>并通知 TC：我们开始做全局事务了。</li>
</ul>
<p><strong>🟡 步骤 2：调用其他微服务（产生分支事务）</strong></p>
<ul>
<li>TM 在事务中调用了 Storage、Order、Account 等服务；</li>
<li>每个服务的 RM 会：<ul>
<li><strong>注册自己的分支事务到 TC</strong>；</li>
<li><strong>执行自己的本地事务（如扣库存）</strong>；</li>
<li><strong>上报执行状态（成功/失败）给 TC</strong>。</li>
</ul>
</li>
</ul>
<p><strong>🟡 步骤 3：TC 做决策（统一协调）</strong></p>
<ul>
<li>如果所有分支都成功 → TC 通知所有 RM 执行 <strong>提交</strong>；</li>
<li>如果有一个服务失败（比如 Account 余额不足） → TC 通知所有服务 <strong>回滚</strong>。</li>
</ul>
<p>🟡 <strong>步骤 4：RM 根据命令执行提交/回滚</strong></p>
<ul>
<li>即使某个服务已经提交了事务，只要 TC 要求回滚；</li>
<li>RM 会用 undo_log 把已提交的数据“改回去”；</li>
<li>保证全局事务的最终一致性。</li>
</ul>
<p><strong>总结一句话：</strong></p>
<blockquote>
<p>Seata 就像一个指挥系统，<strong>TM 发起事务，RM 执行本地操作，TC 统一管理事务命运（提交或回滚）</strong>，通过 undo_log 实现真正的分布式事务一致性。</p>
</blockquote>
<h2 id="7-4整合Seata"><a href="#7-4整合Seata" class="headerlink" title="7.4整合Seata"></a>7.4整合Seata</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-783-1024x324.png" alt="img"></p>
<h3 id="7-4-1-引入Seata依赖"><a href="#7-4-1-引入Seata依赖" class="headerlink" title="7.4.1.引入Seata依赖"></a>7.4.1.引入Seata依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">&lt;/dependency</span><br></pre></td></tr></table></figure>
<h3 id="7-4-2-每个微服务创建file-conf⽂件"><a href="#7-4-2-每个微服务创建file-conf⽂件" class="headerlink" title="7.4.2.每个微服务创建file.conf⽂件"></a>7.4.2.每个微服务创建file.conf⽂件</h3><p>完整内容如下；<br>【微服务只需要复制service块配置即可】</p>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">service</span> &#123;</span><br><span class="line">  <span class="comment">#transaction service group mapping</span></span><br><span class="line">  vgroupMapping.default_tx_group = <span class="string">&quot;default&quot;</span></span><br><span class="line">  <span class="comment">#only support when registry.type=file, please don&#x27;t set multiple addresses</span></span><br><span class="line">  <span class="keyword">default</span>.grouplist = <span class="string">&quot;127.0.0.1:8091&quot;</span></span><br><span class="line">  <span class="comment">#degrade, current not support</span></span><br><span class="line">  enableDegrade = <span class="keyword">false</span></span><br><span class="line">  <span class="comment">#disable seata</span></span><br><span class="line">  disableGlobalTransaction = <span class="keyword">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>file.conf</code> 的配置核心目的是让每个微服务知道：“我属于哪个事务分组？我的 TC 协调器在哪里？我是否启用全局事务？”</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">vgroupMapping.default_tx_group</span> = <span class="string">&quot;default&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>作用：</strong><br>映射 <strong>事务分组名</strong> 到 TC 服务集群名。</li>
<li><p><code>default.grouplist = &quot;127.0.0.1:8091&quot;</code></p>
</li>
<li><p><strong>作用：</strong><br>给上面那个 <code>default</code> 分组指定具体的 TC 地址和端口。</p>
</li>
<li><p><code>enableDegrade = false</code></p>
</li>
<li><p><strong>作用：</strong><br>是否开启 <strong>事务降级机制</strong>（当前版本不支持，一般设为 false）。</p>
</li>
<li><p><code>disableGlobalTransaction = false</code></p>
</li>
<li><p><strong>作用：</strong><br>是否禁用全局事务。</p>
</li>
</ul>
<h3 id="7-4-3标注全局事务注解-GlobalTransactional"><a href="#7-4-3标注全局事务注解-GlobalTransactional" class="headerlink" title="7.4.3标注全局事务注解@GlobalTransactional"></a>7.4.3标注全局事务注解@GlobalTransactional</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-784-914x1024.png" alt="img"></p>
<p>完成了这三步之后回过头来再进行之前的测试，发现这次分布式事务被Seata成功控住了，没有出现数据不一致的现象，订单每创建，库存和金额也没被减</p>
<h2 id="7-5Seata-二阶提交协议"><a href="#7-5Seata-二阶提交协议" class="headerlink" title="7.5Seata-二阶提交协议"></a>7.5Seata-二阶提交协议</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-785.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-786-675x1024.png" alt="img"></p>
<p>二阶事务的第一阶段就是每一个分支事务先去自己的数据库本地提交，但是要提交两个东西：第一个你业务修改后的数据和第二个undo_log回滚日志，这样Seata（TC服务器）就知道谁在第一阶段成了，谁在第一阶段败了</p>
<p>第二阶段，如果每个分支事务都成了，TC会通知每个微服务，告知它们可以提交本次分支事务，而每一个微服务只需要把自己的undo_log日志一删就可以了。如果某个事务失败了，Seata就会通知每一个已经成功本地提交的微服务去回滚，一旦每一个微服务收到了Seata服务器的回滚通知该怎么办，那么每一个微服务就会开启一个回滚任务，这个任务也是一个事务，主要做这么几件事：第一件步，找到undo_log记录（根据全局事务id和分支事务id）我的undo_log记录我的前镜像和后镜像。第二步，做一个数据校验，后镜像和当前数据进行一个对比，如果一致就可以放心大胆的回滚，如果不一致，说明外部有一些其他渠道修改了，需要在Seata里配置相应的策略（只要编码正确的话一般不会出现这种情况）。第三步，数据校验完成，回滚数据，拿到它的前镜像，执行修改，完成后删除undo_log</p>
<p>只要我们的总事务没有执行完成，总事务期间用到的所有全局锁都不会被释放，在并发的情况下很有效。</p>
<h3 id="一阶段：执行本地业务并生成回滚日志"><a href="#一阶段：执行本地业务并生成回滚日志" class="headerlink" title="一阶段：执行本地业务并生成回滚日志"></a><strong>一阶段：执行本地业务并生成回滚日志</strong></h3><p>每个微服务（分支事务）要做以下几件事：</p>
<ol>
<li><strong>执行业务操作</strong>（例如减库存、扣余额、创建订单）；</li>
<li><strong>查询并记录前镜像数据</strong>（操作前的快照）；</li>
<li><strong>执行 SQL 修改数据</strong>；</li>
<li><strong>记录后镜像数据</strong>；</li>
<li><strong>将前镜像和后镜像写入 undo_log 表</strong>；</li>
<li><strong>向 TC 注册分支事务并锁定数据（记录全局锁）</strong>；</li>
<li><strong>提交本地事务：业务数据 + undo_log 一起提交</strong>；</li>
<li><strong>将执行结果上报给 TC（成功/失败）</strong>。</li>
</ol>
<p>👉 此时，数据已修改，但可以“回滚”，因为 undo_log 记录了变更前后状态。</p>
<h3 id="二阶段：根据-TC-指令提交或回滚"><a href="#二阶段：根据-TC-指令提交或回滚" class="headerlink" title="二阶段：根据 TC 指令提交或回滚"></a><strong>二阶段：根据 TC 指令提交或回滚</strong></h3><h4 id="✅-情况一：所有分支事务都成功"><a href="#✅-情况一：所有分支事务都成功" class="headerlink" title="✅ 情况一：所有分支事务都成功"></a><strong>✅ 情况一：所有分支事务都成功</strong></h4><ol>
<li>TC 统一发出 “提交” 通知；</li>
<li>各服务在本地执行：<ul>
<li>删除对应的 undo_log 日志；</li>
<li>表示数据最终确认生效；</li>
</ul>
</li>
<li>无需其他额外操作。</li>
</ol>
<p>📌 注意：<strong>提交是非常轻量的操作，只是删除日志。</strong></p>
<h4 id="❌-情况二：某个分支事务失败，需要全局回滚"><a href="#❌-情况二：某个分支事务失败，需要全局回滚" class="headerlink" title="❌ 情况二：某个分支事务失败，需要全局回滚"></a><strong>❌ 情况二：某个分支事务失败，需要全局回滚</strong></h4><ol>
<li><p>TC 向所有已经成功提交的服务发送 “回滚” 指令；</p>
</li>
<li><p>每个微服务执行“回滚事务”，包含：</p>
<ul>
<li><p><strong>找日志</strong>：根据全局事务 ID（XID）+ 分支事务 ID 定位 undo_log；</p>
</li>
<li><p>数据校验</p>
<p>：</p>
<ul>
<li>把 undo_log 的“后镜像”与数据库当前值做对比；</li>
<li>如果一致，说明数据没有被修改过，可以安全回滚；</li>
<li>如果不一致，要根据配置策略判断如何处理（可能是并发或手动干预导致）；</li>
</ul>
</li>
<li><p><strong>数据还原</strong>：用“前镜像”覆盖当前数据，完成回滚；</p>
</li>
<li><p><strong>删除 undo_log</strong>，表示回滚完成。</p>
</li>
</ul>
</li>
</ol>
<h3 id="全局锁说明"><a href="#全局锁说明" class="headerlink" title="全局锁说明"></a><strong>全局锁说明</strong></h3><blockquote>
<p>在整个全局事务未完成前（无论提交还是回滚），相关数据持有<strong>全局锁</strong>，不能被其他事务访问，确保数据一致性。</p>
</blockquote>
<h3 id="总结一句话："><a href="#总结一句话：" class="headerlink" title="总结一句话："></a>总结一句话：</h3><blockquote>
<p><strong>Seata 的 2PC 模型中，一阶段提交业务数据+回滚日志，二阶段根据 TC 决定是删除日志（提交）还是回滚数据（根据日志还原），最终实现分布式事务的一致性。</strong></p>
</blockquote>
<h2 id="7-6undo-log"><a href="#7-6undo-log" class="headerlink" title="7.6undo_log"></a>7.6undo_log</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-787-1024x556.png" alt="img"></p>
<h2 id="7-7Seata的四种事务模式"><a href="#7-7Seata的四种事务模式" class="headerlink" title="7.7Seata的四种事务模式"></a>7.7Seata的四种事务模式</h2><h3 id="7-7-1-Seata-AT模式（默认）"><a href="#7-7-1-Seata-AT模式（默认）" class="headerlink" title="7.7.1 Seata AT模式（默认）"></a>7.7.1 Seata AT模式（默认）</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-788-1024x639.png" alt="img"></p>
<h3 id="7-7-2XA模式"><a href="#7-7-2XA模式" class="headerlink" title="7.7.2XA模式"></a>7.7.2XA模式</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-790-1024x646.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-791-1024x650.png" alt="img"></p>
<p>XA模式也是一种二阶提交协议，不同的是第一阶段它并不会给本地数据库真正的提交数据，它会阻塞住这个事务请求，只有在第二阶段确认要提交以后才会真正去提交</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-792-1024x401.png" alt="img"></p>
<p>补充：AT-&gt;XA(不推荐)</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-793-1024x151.png" alt="img"></p>
<h3 id="7-7-3TCC模式"><a href="#7-7-3TCC模式" class="headerlink" title="7.7.3TCC模式"></a>7.7.3TCC模式</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-794-1024x325.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-795-1024x569.png" alt="img"></p>
<p>第一阶段叫准备，我该给数据库里面存什么或删什么，第一阶段给它执行完</p>
<p>第二阶段提交或回滚，大家都成了提交，有一个败了回滚 这里的prepare，commit，rollback需要程序员去定义每一个阶段的实现代码</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-796-1024x359.png" alt="img"></p>
<p>TCC模式适合于一些夹杂了非数据库的事务代码。需要我们全程手写，TC服务器仅帮我们协调调用每一个阶段</p>
<h3 id="7-7-4Saga模式"><a href="#7-7-4Saga模式" class="headerlink" title="7.7.4Saga模式"></a>7.7.4Saga模式</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-797-1024x251.png" alt="img"></p>
<p>例如请假审批等一系列流程不适用于其他三个模式，会导致锁长期锁在业务里，对系统是非常大的一种阻塞，Saga模式是Seata结合消息队列实现的</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-798.png" alt="img"></p>
<h1 id="8-总结"><a href="#8-总结" class="headerlink" title="8.总结"></a>8.总结</h1><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-800-1024x741.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-802-1024x811.png" alt="img"></p>
<h1 id="SpringCloud完结"><a href="#SpringCloud完结" class="headerlink" title="SpringCloud完结"></a>SpringCloud完结</h1></article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>速通SpringCloud微服务</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://itgeqian.github.io/posts/12.html">https://itgeqian.github.io/posts/12.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>作者</h><div class="post-copyright-cc-info"><h>geqian's Blog🍭</h></div></div><div class="post-copyright-c"><h>发布于</h><div class="post-copyright-cc-info"><h>2025-06-15</h></div></div><div class="post-copyright-u"><h>更新于</h><div class="post-copyright-cc-info"><h>2025-06-25</h></div></div><div class="post-copyright-c"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>微服务</a></div></div><link rel="stylesheet" href="/css/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">投喂作者</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://java-geqian.oss-cn-beijing.aliyuncs.com/%E5%BE%AE%E4%BF%A1PAY.jpg" target="_blank"><img class="post-qr-code-img" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/%E5%BE%AE%E4%BF%A1PAY.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://java-geqian.oss-cn-beijing.aliyuncs.com/%E6%94%AF%E4%BB%98%E5%AE%9DPAY.jpg" target="_blank"><img class="post-qr-code-img" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/%E6%94%AF%E4%BB%98%E5%AE%9DPAY.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></button></div><audio id="coinAudio" src="https://npm.elemecdn.com/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/js/coin.js"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/9.html"><img class="prev-cover" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">mysql基础篇</div></div></a></div><div class="next-post pull-right"><a href="/posts/41.html"><img class="next-cover" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">GQ Video单服务改造微服务</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><svg class="meta_icon" style="width:22px;height:22px;position:relative;top:5px"><use xlink:href="#icon-mulu1"></use></svg><span style="font-weight:bold">目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="toc-text">单体架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84"><span class="toc-text">集群架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84"><span class="toc-text">分布式架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%EF%BC%9A"><span class="toc-text">总结：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-%E5%88%86%E5%B8%83%E5%BC%8F%E5%9F%BA%E7%A1%80"><span class="toc-text">1.分布式基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-text">1.1微服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E9%9B%86%E7%BE%A4-amp-%E5%88%86%E5%B8%83%E5%BC%8F-amp-%E8%8A%82%E7%82%B9"><span class="toc-text">1.2.集群&amp;分布式&amp;节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3%E8%BF%9C%E7%A8%8B%E8%B0%83%E2%BD%A4"><span class="toc-text">1.3远程调⽤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">1.4.负载均衡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C-%E5%8F%91%E7%8E%B0-amp-%E6%B3%A8%E5%86%8C%E4%B8%AD%E2%BC%BC"><span class="toc-text">1.5服务注册&#x2F;发现&amp;注册中⼼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-6%E9%85%8D%E7%BD%AE%E4%B8%AD%E2%BC%BC"><span class="toc-text">1.6配置中⼼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-7%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD-amp-%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"><span class="toc-text">1.7服务熔断&amp;服务降级</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-8API-%E2%BD%B9%E5%85%B3"><span class="toc-text">1.8API ⽹关</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AASpring-Cloud%E9%A1%B9%E7%9B%AE"><span class="toc-text">2.创建一个Spring Cloud项目</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Nacos-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83-amp-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-text">3.Nacos-注册中心&amp;配置中心</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8"><span class="toc-text">3.1注册中心基础入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1%E5%AE%89%E8%A3%85"><span class="toc-text">3.1.1安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-2%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C"><span class="toc-text">3.1.2服务注册</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-3%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-text">3.1.3服务发现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-4%E8%BF%9C%E7%A8%8B%E8%B0%83%E2%BD%A4"><span class="toc-text">3.1.4远程调⽤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-5%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%9C%80%E6%B1%82"><span class="toc-text">3.1.5负载均衡需求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-6%E9%9D%A2%E8%AF%95%E9%A2%98%EF%BC%9A%E5%A6%82%E6%9E%9C%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E5%AE%95%E6%9C%BA%EF%BC%8C%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E8%BF%98%E8%83%BD%E4%BD%BF%E7%94%A8%E5%90%97%EF%BC%9F"><span class="toc-text">3.1.6面试题：如果注册中心宕机，远程调用还能使用吗？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8"><span class="toc-text">3.2配置中心基础入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="toc-text">3.2.1基础配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0"><span class="toc-text">3.2.2动态刷新</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RefreshScope"><span class="toc-text">@RefreshScope</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ConfigurationProperties%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="toc-text">@ConfigurationProperties（推荐）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NacosConfigManager%E7%9B%91%E5%90%AC%E9%85%8D%E7%BD%AE%E5%8F%98%E5%8C%96"><span class="toc-text">@NacosConfigManager监听配置变化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-3%E9%9D%A2%E8%AF%95%E9%A2%98%EF%BC%9ANacos%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E9%9B%86%E5%92%8Capplication-properties%E6%9C%89%E7%9B%B8%E5%90%8C%E7%9A%84%E9%85%8D%E7%BD%AE%E9%A1%B9%EF%BC%8C%E5%93%AA%E4%B8%AA%E7%94%9F%E6%95%88%EF%BC%9F"><span class="toc-text">3.2.3面试题：Nacos中的数据集和application.properties有相同的配置项，哪个生效？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-4%E6%95%B0%E6%8D%AE%E9%9A%94%E7%A6%BB"><span class="toc-text">3.2.4数据隔离</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8D%E7%A7%B0%E7%A9%BA%E9%97%B4"><span class="toc-text">名称空间</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#groupId"><span class="toc-text">groupId</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%89%E9%9C%80%E5%8A%A0%E8%BD%BD"><span class="toc-text">按需加载</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3Nacos%E6%80%BB%E7%BB%93"><span class="toc-text">3.3Nacos总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-OpenFeign-%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="toc-text">4.OpenFeign-远程调用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8"><span class="toc-text">4.1基础入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-1%E5%BC%95%E5%85%A5%E4%BE%9D%E8%B5%96"><span class="toc-text">4.1.1引入依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-2%E5%BC%80%E5%90%AFOpenFeign%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E5%8A%9F%E8%83%BD"><span class="toc-text">4.1.2开启OpenFeign远程调用功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-3%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%EF%BC%88%E8%BF%99%E4%B8%AA%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E6%98%AF%E8%87%AA%E5%8A%A8%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%EF%BC%89"><span class="toc-text">4.1.3远程调用（这个远程调用是自动负载均衡的）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-4%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9API"><span class="toc-text">4.1.4远程调用第三方API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-5%E5%B0%8F%E6%8A%80%E5%B7%A7%E4%B8%8E%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="toc-text">4.1.5小技巧与面试题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E6%8A%80%E5%B7%A7"><span class="toc-text">小技巧</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E9%A2%98%EF%BC%9A%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E4%B8%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%8C%BA%E5%88%AB"><span class="toc-text">面试题：客户端负载均衡与服务端负载均衡区别</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2%E8%BF%9B%E9%98%B6%E9%85%8D%E7%BD%AE"><span class="toc-text">4.2进阶配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-%E5%BC%80%E5%90%AF%E6%97%A5%E5%BF%97"><span class="toc-text">4.2.1.开启日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2%E8%B6%85%E6%97%B6%E6%8E%A7%E5%88%B6"><span class="toc-text">4.2.2超时控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-3%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6"><span class="toc-text">4.2.3重试机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-4%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-text">4.2.4拦截器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-text">请求拦截器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-5-fallback-%E5%85%9C%E5%BA%95%E8%BF%94%E5%9B%9E"><span class="toc-text">4.2.5.fallback - 兜底返回</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3%E6%80%BB%E7%BB%93"><span class="toc-text">4.3总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-Sentinel-%E6%B5%81%E9%87%8F%E4%BF%9D%E6%8A%A4"><span class="toc-text">5.Sentinel-流量保护</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1%E4%BB%8B%E7%BB%8D"><span class="toc-text">5.1介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86"><span class="toc-text">5.2架构原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1%E8%B5%84%E6%BA%90"><span class="toc-text">5.2.1资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-2%E8%A7%84%E5%88%99"><span class="toc-text">5.2.2规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-3%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-text">5.2.3工作原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3sentinel%E6%95%B4%E5%90%88"><span class="toc-text">5.3sentinel整合</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-text">5.4.环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-1-%E4%BE%9D%E8%B5%96"><span class="toc-text">5.4.1.依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-2%E9%85%8D%E7%BD%AE%E8%BF%9E%E6%8E%A5"><span class="toc-text">5.4.2配置连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-3%E5%AF%B9%E6%8C%87%E5%AE%9A%E6%96%B9%E6%B3%95%E8%BF%9B%E8%A1%8C%E4%BF%9D%E6%8A%A4"><span class="toc-text">5.4.3对指定方法进行保护</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%BA%E5%88%B6"><span class="toc-text">5.5异常处理机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-1%E2%BE%83%E5%AE%9A%E4%B9%89-BlockExceptionHandle"><span class="toc-text">5.5.1⾃定义 BlockExceptionHandle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-2%E5%A4%84%E7%90%86-SentinelResource%E7%9A%84%E5%BC%82%E5%B8%B8"><span class="toc-text">5.5.2处理@SentinelResource的异常</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-3%E9%92%88%E5%AF%B9OpenFeign%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-text">5.5.3针对OpenFeign远程调用的异常处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-4SphU%E7%A1%AC%E7%BC%96%E7%A0%81%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86-%E4%BA%86%E8%A7%A3%E5%8D%B3%E5%8F%AF"><span class="toc-text">5.5.4SphU硬编码异常处理(了解即可)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-6-%E8%A7%84%E5%88%99-%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6"><span class="toc-text">5.6.规则 - 流量控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-1%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F"><span class="toc-text">5.6.1流控模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E7%AD%96%E7%95%A5"><span class="toc-text">直接策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%93%BE%E8%B7%AF%E7%AD%96%E7%95%A5"><span class="toc-text">链路策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E8%81%94%E7%AD%96%E7%95%A5"><span class="toc-text">关联策略</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-2%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C"><span class="toc-text">5.6.2流控效果</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%A4%B1%E8%B4%A5"><span class="toc-text">快速失败</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Warm-Up"><span class="toc-text">Warm Up</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%80%E9%80%9F%E6%8E%92%E9%98%9F"><span class="toc-text">匀速排队</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-7%E8%A7%84%E5%88%99-%E7%86%94%E6%96%AD%E8%A7%84%E5%88%99"><span class="toc-text">5.7规则-熔断规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7-1%E6%96%AD%E8%B7%AF%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-text">5.7.1断路器工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7-2%E7%86%94%E6%96%AD%E7%AD%96%E7%95%A5-%E6%85%A2%E8%B0%83%E7%94%A8%E6%AF%94%E4%BE%8B"><span class="toc-text">5.7.2熔断策略-慢调用比例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7-3%E7%86%94%E6%96%AD%E7%AD%96%E7%95%A5-%E5%BC%82%E5%B8%B8%E6%AF%94%E4%BE%8B"><span class="toc-text">5.7.3熔断策略-异常比例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7-4%E7%86%94%E6%96%AD%E7%AD%96%E7%95%A5-%E5%BC%82%E5%B8%B8%E6%95%B0"><span class="toc-text">5.7.4熔断策略-异常数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-8%E8%A7%84%E5%88%99-%E7%83%AD%E7%82%B9%E8%A7%84%E5%88%99"><span class="toc-text">5.8规则-热点规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-8-1%E6%90%AD%E5%BB%BA%E7%8E%AF%E5%A2%83"><span class="toc-text">5.8.1搭建环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-8-2%E4%B8%BA%E7%A7%92%E6%9D%80%E5%88%9B%E5%BB%BA%E8%AE%A2%E5%8D%95%E6%B7%BB%E5%8A%A0%E7%83%AD%E7%82%B9%E5%8F%82%E6%95%B0%E8%A7%84%E5%88%99"><span class="toc-text">5.8.2为秒杀创建订单添加热点参数规则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E4%B8%80"><span class="toc-text">需求一</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E4%BA%8C%EF%BC%88%E4%B8%8D%E9%99%90%E5%88%B66%E5%8F%B7%E7%94%A8%E6%88%B7%EF%BC%89"><span class="toc-text">需求二（不限制6号用户）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E4%B8%89%EF%BC%88666%E5%8F%B7%E5%95%86%E5%93%81%E4%B8%8B%E6%9E%B6%E4%BA%86%EF%BC%8C%E4%B8%8D%E5%85%81%E8%AE%B8%E8%AE%BF%E9%97%AE%EF%BC%89"><span class="toc-text">需求三（666号商品下架了，不允许访问）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%A5%E5%85%85"><span class="toc-text">补充</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-9%E8%A7%84%E5%88%99-%E6%8E%88%E6%9D%83%E8%A7%84%E5%88%99%EF%BC%88%E5%BE%88%E5%B0%91%E4%BD%BF%E7%94%A8%EF%BC%89"><span class="toc-text">5.9规则-授权规则（很少使用）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-10%E8%A7%84%E5%88%99-%E7%B3%BB%E7%BB%9F%E8%A7%84%E5%88%99%EF%BC%88%E5%BE%88%E5%B0%91%E4%BD%BF%E7%94%A8%EF%BC%89"><span class="toc-text">5.10规则-系统规则（很少使用）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-11%E6%80%BB%E7%BB%93"><span class="toc-text">5.11总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-Gateway-%E7%BD%91%E5%85%B3"><span class="toc-text">6.Gateway-网关</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1%E7%BD%91%E5%85%B3%E5%8A%9F%E8%83%BD"><span class="toc-text">6.1网关功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2%E5%88%9B%E5%BB%BA%E7%BD%91%E5%85%B3"><span class="toc-text">6.2创建网关</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3%E7%BD%91%E5%85%B3%E9%85%8D%E7%BD%AE%E8%A7%84%E5%88%99"><span class="toc-text">6.3网关配置规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E9%85%8D%E7%BD%AE%E8%A7%84%E5%88%99"><span class="toc-text">用配置文件配置规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4%E8%B7%AF%E7%94%B1%E7%9A%84%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86"><span class="toc-text">6.4路由的基础原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%90%86%E8%A7%A3%E4%B8%80%E4%B8%8B%E6%8B%A6%E6%88%AA%E5%99%A8%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-text">理解一下拦截器的作用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5%E6%96%AD%E8%A8%80"><span class="toc-text">6.5断言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-1%E6%96%AD%E8%A8%80%E7%9A%84%E5%86%99%E6%B3%95"><span class="toc-text">6.5.1断言的写法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-2%E6%96%AD%E8%A8%80%E8%A7%84%E5%88%99"><span class="toc-text">6.5.2断言规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-3%E8%87%AA%E5%AE%9A%E4%B9%89%E6%96%AD%E8%A8%80%E5%B7%A5%E5%8E%82"><span class="toc-text">6.5.3自定义断言工厂</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-6Filter-%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-text">6.6Filter-过滤器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-1%E8%B7%AF%E5%BE%84%E9%87%8D%E5%86%99Filter"><span class="toc-text">6.6.1路径重写Filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-2%E8%BF%87%E6%BB%A4%E8%A7%84%E5%88%99"><span class="toc-text">6.6.2过滤规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-3%E9%BB%98%E8%AE%A4Filter"><span class="toc-text">6.6.3默认Filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-4Global-Filters"><span class="toc-text">6.6.4Global Filters</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-5%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%87%E6%BB%A4%E5%99%A8%E5%B7%A5%E5%8E%82"><span class="toc-text">6.6.5自定义过滤器工厂</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-7%E8%B7%A8%E5%9F%9F-CORS-%E9%85%8D%E7%BD%AE"><span class="toc-text">6.7跨域(CORS)配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7-1%E5%85%A8%E5%B1%80%E8%B7%A8%E5%9F%9F"><span class="toc-text">6.7.1全局跨域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7-2%E5%B1%80%E9%83%A8%E8%B7%A8%E5%9F%9F"><span class="toc-text">6.7.2局部跨域</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-8%E6%80%BB%E7%BB%93"><span class="toc-text">6.8总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-Seata-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-text">7.Seata-分布式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">7.1环境准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2%E6%89%93%E9%80%9A%E8%BF%9C%E7%A8%8B%E9%93%BE%E8%B7%AF"><span class="toc-text">7.2打通远程链路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86-Seata-%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%A4%84%E7%90%86%E5%8E%9F%E7%90%86"><span class="toc-text">7.3架构原理(Seata 的分布式事务处理原理)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-4%E6%95%B4%E5%90%88Seata"><span class="toc-text">7.4整合Seata</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-1-%E5%BC%95%E5%85%A5Seata%E4%BE%9D%E8%B5%96"><span class="toc-text">7.4.1.引入Seata依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-2-%E6%AF%8F%E4%B8%AA%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%88%9B%E5%BB%BAfile-conf%E2%BD%82%E4%BB%B6"><span class="toc-text">7.4.2.每个微服务创建file.conf⽂件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-3%E6%A0%87%E6%B3%A8%E5%85%A8%E5%B1%80%E4%BA%8B%E5%8A%A1%E6%B3%A8%E8%A7%A3-GlobalTransactional"><span class="toc-text">7.4.3标注全局事务注解@GlobalTransactional</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-5Seata-%E4%BA%8C%E9%98%B6%E6%8F%90%E4%BA%A4%E5%8D%8F%E8%AE%AE"><span class="toc-text">7.5Seata-二阶提交协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%89%A7%E8%A1%8C%E6%9C%AC%E5%9C%B0%E4%B8%9A%E5%8A%A1%E5%B9%B6%E7%94%9F%E6%88%90%E5%9B%9E%E6%BB%9A%E6%97%A5%E5%BF%97"><span class="toc-text">一阶段：执行本地业务并生成回滚日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E9%98%B6%E6%AE%B5%EF%BC%9A%E6%A0%B9%E6%8D%AE-TC-%E6%8C%87%E4%BB%A4%E6%8F%90%E4%BA%A4%E6%88%96%E5%9B%9E%E6%BB%9A"><span class="toc-text">二阶段：根据 TC 指令提交或回滚</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9C%85-%E6%83%85%E5%86%B5%E4%B8%80%EF%BC%9A%E6%89%80%E6%9C%89%E5%88%86%E6%94%AF%E4%BA%8B%E5%8A%A1%E9%83%BD%E6%88%90%E5%8A%9F"><span class="toc-text">✅ 情况一：所有分支事务都成功</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9D%8C-%E6%83%85%E5%86%B5%E4%BA%8C%EF%BC%9A%E6%9F%90%E4%B8%AA%E5%88%86%E6%94%AF%E4%BA%8B%E5%8A%A1%E5%A4%B1%E8%B4%A5%EF%BC%8C%E9%9C%80%E8%A6%81%E5%85%A8%E5%B1%80%E5%9B%9E%E6%BB%9A"><span class="toc-text">❌ 情况二：某个分支事务失败，需要全局回滚</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E9%94%81%E8%AF%B4%E6%98%8E"><span class="toc-text">全局锁说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E4%B8%80%E5%8F%A5%E8%AF%9D%EF%BC%9A"><span class="toc-text">总结一句话：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-6undo-log"><span class="toc-text">7.6undo_log</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-7Seata%E7%9A%84%E5%9B%9B%E7%A7%8D%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%BC%8F"><span class="toc-text">7.7Seata的四种事务模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-7-1-Seata-AT%E6%A8%A1%E5%BC%8F%EF%BC%88%E9%BB%98%E8%AE%A4%EF%BC%89"><span class="toc-text">7.7.1 Seata AT模式（默认）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-7-2XA%E6%A8%A1%E5%BC%8F"><span class="toc-text">7.7.2XA模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-7-3TCC%E6%A8%A1%E5%BC%8F"><span class="toc-text">7.7.3TCC模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-7-4Saga%E6%A8%A1%E5%BC%8F"><span class="toc-text">7.7.4Saga模式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-%E6%80%BB%E7%BB%93"><span class="toc-text">8.总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringCloud%E5%AE%8C%E7%BB%93"><span class="toc-text">SpringCloud完结</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background-color: transparent;"><div id="footer-wrap"><div id="ft"><div class="ft-item-1"><div class="t-top"><div class="t-t-l"><p class="ft-t t-l-t">格言🧬</p><div class="bg-ad"><div>再看看那个光点，它就在这里，这是家园，这是我们 —— 你所爱的每一个人，你认识的一个人，你听说过的每一个人，曾经有过的每一个人，都在它上面度过他们的一生✨</div><div class="btn-xz-box"><a class="btn-xz" target="_blank" rel="noopener" href="https://stellarium.org/">点击开启星辰之旅</a></div></div></div><div class="t-t-r"><p class="ft-t t-l-t">猜你想看💡</p><ul class="ft-links"><li><a href="/comments/">留点什么</a><a href="/archives/">文章归档</a></li><li><a href="/categories/">文章分类</a><a href="/tags/">文章标签</a></li><li><a href="/box/Gallery/">我的画廊</a><a href="/personal/bb/">我的唠叨</a></li><li><a href="/site/time/">建设进程</a><a href="/site/census/">网站统计</a></li></ul></div></div></div><div class="ft-item-2"><p class="ft-t">推荐友链⌛</p><div class="ft-img-group"><div class="img-group-item"></div></div></div></div><div class="copyright"><span><b>&copy;2022-2025</b></span><span><b>&nbsp;&nbsp;By geqian's Blog🍭</b></span></div><div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=20230913" style="margin-inline:5px" title="本站已加入萌ICP豪华套餐，萌ICP备20230913号"><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/20230913.svg" alt=""/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="浅色和深色模式转换"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><button class="share" type="button" title="右键模式" onclick="changeMouseMode()"><i class="fas fa-mouse"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog right_side"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button class="share" type="button" title="分享链接" onclick="share()"><i class="fas fa-share-nodes"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button><button id="go-down" type="button" title="直达底部" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>复制</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>百度搜索</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>转到链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>粘贴</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span>空降评论</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>复制本文地址</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>新窗口打开</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>转到链接</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制链接</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>保存图片</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>在新窗口打开</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>复制图片链接</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:randomPost()"><i class="fa fa-paper-plane"></i><span>随便逛逛</span></a><a class="rightMenu-item" href="javascript:switchNightMode();"><i class="fa fa-moon"></i><span>昼夜切换</span></a><a class="rightMenu-item" href="/personal/about/"><i class="fa fa-info-circle"></i><span>关于博客</span></a><a class="rightMenu-item" href="javascript:toggleWinbox();"><i class="fas fa-cog"></i><span>美化设置</span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span>切换全屏</span></a><a class="rightMenu-item" href="javascript:window.print();"><i class="fa-solid fa-print"></i><span>打印页面</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000);
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: '',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: '',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.staticfile.org/twikoo/1.6.8/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script async src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script defer type="text/javascript" src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer src="https://cdn1.tianli0.top/gh/nextapps-de/winbox/dist/winbox.bundle.min.js"></script><script async src="//at.alicdn.com/t/c/font_3586335_hsivh70x0fm.js"></script><script async src="//at.alicdn.com/t/c/font_3636804_gr02jmjr3y9.js"></script><script async src="//at.alicdn.com/t/c/font_3612150_kfv55xn3u2g.js"></script><script async src="https://cdn.wpon.cn/2022-sucai/Gold-ingot.js"></script><canvas id="universe"></canvas><canvas id="snow"></canvas><script defer src="/js/fomal.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn1.tianli0.top/npm/js-heo@1.0.12/metingjs/Meting.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#web_bg",".js-pjax","#bibi","body > title","#app","#tag-echarts","#posts-echart","#categories-echarts"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/学习笔记/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🍡 geqianの学习笔记 (10)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/杂项/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🍼 geqianの杂项 (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/项目/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🍉 geqianの项目笔记 (6)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/AI/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🍨 geqianのAI大模型 (6)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/算法/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🍟 geqianの算法学习笔记 (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/面试/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🍥 geqianの面试 (18)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/JUC/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🌏 geqianのJUC (4)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/JVM/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🍜 geqianのJVM (5)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/云原生/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🔐 geqianの云原生相关 (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/MQ/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📱 geqianの消息队列 (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/前端/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🏛️ geqianの前端工程 (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/mybatis-mybatis-plus/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🎨 geqianのmybatis系列 (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/微服务/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🗺️ geqianのSpringCloud系列 (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/SSM/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📖 geqianのSSM+SpringBoot系列 (7)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/ruoyi/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">📞 geqianの若依框架 (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/mysql/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">❓ geqianのmysql (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/Redis/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">💖 geqianのRedis (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item" style="visibility: hidden"></div><a class="magnet_link_more"  href="https://itgeqian.github.io/categories/" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>';
    console.log('已挂载magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(33.333333333333336% - 5px);background: #e9e9e9;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: var(--text-bg-hover)}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/60.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-09-30</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/60.html&quot;);" href="javascript:void(0);" alt="">速通Spring AI Alibaba </a><div class="blog-slider__text">速通Spring AI Alibaba 完结</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/60.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/37.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-04-02</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/37.html&quot;);" href="javascript:void(0);" alt="">GQ Video单服务版本记录</a><div class="blog-slider__text">GQ Video单服务版本记录（完整记录GQ Video从0到1的全记录）</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/37.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/1.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-05-20</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/1.html&quot;);" href="javascript:void(0);" alt="">实验三 汽车租赁系统的UML设计建模 （完结）</a><div class="blog-slider__text">关于汽车租赁系统的UML设计建模</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/1.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/74.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-09-06</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/74.html&quot;);" href="javascript:void(0);" alt="">Mysql相关面试题</a><div class="blog-slider__text">我对mysql的相关理解</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/74.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/77.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-10-07</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/77.html&quot;);" href="javascript:void(0);" alt="">javase+集合相关面试题</a><div class="blog-slider__text">我对java基础和集合类的相关理解</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/77.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/68.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-10-01</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/68.html&quot;);" href="javascript:void(0);" alt="">JUC面试题</a><div class="blog-slider__text">我对JUC的理解</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/68.html&quot;);" href="javascript:void(0);" alt="">详情       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper@1.0.12/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper@1.0.12/lib/swiper_init.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('gitZone');
      var item_html = '<div class="recent-post-item" id="gitcalendarBar" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 320px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('已挂载gitcalendar')
      }

    if( document.getElementById('gitZone') && (location.pathname ==='/site/census/'|| '/site/census/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("/api?null",['#d9e0df', '#c6e0dc', '#a8dcd4', '#9adcd2', '#89ded1', '#77e0d0', '#5fdecb', '#47dcc6', '#39dcc3', '#1fdabe', '#00dab9'],'null')
    }
  </script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>