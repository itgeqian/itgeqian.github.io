<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><div id="myscoll"></div><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Rediså®æˆ˜ç¯‡ | geqian's BlogğŸ­</title><meta name="keywords" content="Redis"><meta name="author" content="geqian's BlogğŸ­"><meta name="copyright" content="geqian's BlogğŸ­"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Redisä¸‰éƒ¨æ›²ä¸­ç¯‡-å®æˆ˜ç¯‡é»‘é©¬ç‚¹è¯„">
<meta property="og:type" content="article">
<meta property="og:title" content="Rediså®æˆ˜ç¯‡">
<meta property="og:url" content="https://itgeqian.github.io/posts/6.html">
<meta property="og:site_name" content="geqian&#39;s BlogğŸ­">
<meta property="og:description" content="Redisä¸‰éƒ¨æ›²ä¸­ç¯‡-å®æˆ˜ç¯‡é»‘é©¬ç‚¹è¯„">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://java-geqian.oss-cn-beijing.aliyuncs.com/geqian-Blos/67.jpg">
<meta property="article:published_time" content="2024-09-14T01:19:03.000Z">
<meta property="article:modified_time" content="2024-09-17T13:12:00.000Z">
<meta property="article:author" content="geqian&#39;s BlogğŸ­">
<meta property="article:tag" content="Redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://java-geqian.oss-cn-beijing.aliyuncs.com/geqian-Blos/67.jpg"><link rel="shortcut icon" href="/"><link rel="canonical" href="https://itgeqian.github.io/posts/6"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Rediså®æˆ˜ç¯‡',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-09-17 21:12:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><style id="themeColor"></style><style id="rightSide"></style><style id="transPercent"></style><style id="blurNum"></style><style id="settingStyle"></style><span id="fps"></span><style id="defineBg"></style><style id="menu_shadow"></style><script src="https://cdn.jsdelivr.net/npm/echarts@6/dist/echarts.min.js"></script><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper@1.0.12/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper@1.0.12/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="geqian's BlogğŸ­" type="application/atom+xml">
</head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/assets/avatar.png" onerror="onerror=null;src='/assets/r1.jpg'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">83</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">51</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">18</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> ä¼‘é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> å…«éŸ³ç›’</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½±é™¢</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xiangzi"></use></svg><span class="menu_word" style="font-size:17px"> å…«å®ç®±</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-tubiaozhizuomoban">                   </use></svg><span class="menu_word" style="font-size:17px"> ç”»å»Š</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-nvwumao">                   </use></svg><span class="menu_word" style="font-size:17px"> åŠ¨ç”»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘å€å¯¼èˆª</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> æœ‹å‹åœˆ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> å‹äººå¸</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> æ—§æ—¶å…‰</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">geqian's BlogğŸ­</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> ä¼‘é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> å…«éŸ³ç›’</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½±é™¢</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xiangzi"></use></svg><span class="menu_word" style="font-size:17px"> å…«å®ç®±</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-tubiaozhizuomoban">                   </use></svg><span class="menu_word" style="font-size:17px"> ç”»å»Š</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-nvwumao">                   </use></svg><span class="menu_word" style="font-size:17px"> åŠ¨ç”»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘å€å¯¼èˆª</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> æœ‹å‹åœˆ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> å‹äººå¸</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> æ—§æ—¶å…‰</span></a></li></ul></div></div><center id="name-container"><a id="page-name" href="javascript:scrollToTop()">PAGE_NAME</a></center><div id="nav-right"><div id="search-button"><a class="search faa-parent animated-hover" title="æ£€ç´¢ç«™å†…ä»»ä½•ä½ æƒ³è¦çš„ä¿¡æ¯"><svg class="faa-tada icon" style="height:24px;width:24px;fill:currentColor;position:relative;top:6px" aria-hidden="true"><use xlink:href="#icon-valentine_-search-love-find-heart"></use></svg><span> æœç´¢</span></a></div><a class="meihua faa-parent animated-hover" onclick="toggleWinbox()" title="ç¾åŒ–è®¾ç½®-è‡ªå®šä¹‰ä½ çš„é£æ ¼" id="meihua-button"><svg class="faa-tada icon" style="height:26px;width:26px;fill:currentColor;position:relative;top:8px" aria-hidden="true"><use xlink:href="#icon-tupian1"></use></svg></a><a class="sun_moon faa-parent animated-hover" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢" id="nightmode-button"><svg class="faa-tada" style="height:25px;width:25px;fill:currentColor;position:relative;top:7px" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon">       </use></svg></a><div id="toggle-menu"><a><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-info"><h1 class="post-title">Rediså®æˆ˜ç¯‡</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><svg class="meta_icon post-meta-icon" style="width:30px;height:30px;position:relative;top:10px"><use xlink:href="#icon-rili"></use></svg><span class="post-meta-label">å‘è¡¨äº </span><time class="post-meta-date-created" datetime="2024-09-14T01:19:03.000Z" title="å‘è¡¨äº 2024-09-14 09:19:03">2024-09-14</time><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-gengxin1"></use></svg><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2024-09-17T13:12:00.000Z" title="æ›´æ–°äº 2024-09-17 21:12:00">2024-09-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-biaoqian"></use></svg><a class="post-meta-categories" href="/categories/Redis/">Redis</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:8px"><use xlink:href="#icon-charuword"></use></svg><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">4.5w</span><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:20px;height:20px;position:relative;top:5px"><use xlink:href="#icon-shizhong"></use></svg><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>162åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Rediså®æˆ˜ç¯‡"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:5px"><use xlink:href="#icon-eye"></use></svg><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>å¯¼è¯»ï¼šå®æˆ˜ç¯‡æˆ‘ä»¬è¦å­¦ä¹ ä¸€äº›ä»€ä¹ˆæ ·çš„å†…å®¹</p>
<ul>
<li>çŸ­ä¿¡ç™»å½•</li>
</ul>
<p>è¿™ä¸€å—æˆ‘ä»¬ä¼šä½¿ç”¨rediså…±äº«sessionæ¥å®ç°</p>
<ul>
<li>å•†æˆ·æŸ¥è¯¢ç¼“å­˜</li>
</ul>
<p>é€šè¿‡æœ¬ç« èŠ‚ï¼Œæˆ‘ä»¬ä¼šç†è§£ç¼“å­˜å‡»ç©¿ï¼Œç¼“å­˜ç©¿é€ï¼Œç¼“å­˜é›ªå´©ç­‰é—®é¢˜ï¼Œè®©å°ä¼™ä¼´çš„å¯¹äºè¿™äº›æ¦‚å¿µçš„ç†è§£ä¸ä»…ä»…æ˜¯åœç•™åœ¨æ¦‚å¿µä¸Šï¼Œæ›´æ˜¯èƒ½åœ¨ä»£ç ä¸­çœ‹åˆ°å¯¹åº”çš„å†…å®¹</p>
<ul>
<li>ä¼˜æƒ å·ç§’æ€</li>
</ul>
<p>é€šè¿‡æœ¬ç« èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥å­¦ä¼šRedisçš„è®¡æ•°å™¨åŠŸèƒ½ï¼Œ ç»“åˆLuaå®Œæˆé«˜æ€§èƒ½çš„redisæ“ä½œï¼ŒåŒæ—¶å­¦ä¼šRedisåˆ†å¸ƒå¼é”çš„åŸç†ï¼ŒåŒ…æ‹¬Redisçš„ä¸‰ç§æ¶ˆæ¯é˜Ÿåˆ—</p>
<ul>
<li>é™„è¿‘çš„å•†æˆ·</li>
</ul>
<p>æˆ‘ä»¬åˆ©ç”¨Redisçš„GEOHashæ¥å®Œæˆå¯¹äºåœ°ç†åæ ‡çš„æ“ä½œ</p>
<ul>
<li>UVç»Ÿè®¡</li>
</ul>
<p>ä¸»è¦æ˜¯ä½¿ç”¨Redisæ¥å®Œæˆç»Ÿè®¡åŠŸèƒ½</p>
<ul>
<li>ç”¨æˆ·ç­¾åˆ°</li>
</ul>
<p>ä½¿ç”¨Redisçš„BitMapæ•°æ®ç»Ÿè®¡åŠŸèƒ½</p>
<ul>
<li>å¥½å‹å…³æ³¨</li>
</ul>
<p>åŸºäºSeté›†åˆçš„å…³æ³¨ã€å–æ¶ˆå…³æ³¨ï¼Œå…±åŒå…³æ³¨ç­‰ç­‰åŠŸèƒ½ï¼Œè¿™ä¸€å—çŸ¥è¯†å’±ä»¬ä¹‹å‰å°±è®²è¿‡ï¼Œè¿™æ¬¡æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­æ¥ä½¿ç”¨ä¸€ä¸‹</p>
<ul>
<li>æ‰“äººæ¢åº—</li>
</ul>
<p>åŸºäºListæ¥å®Œæˆç‚¹èµåˆ—è¡¨çš„æ“ä½œï¼ŒåŒæ—¶åŸºäºSortedSetæ¥å®Œæˆç‚¹èµçš„æ’è¡Œæ¦œåŠŸèƒ½</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-24-1024x590.png" alt="img"></p>
<h2 id="1ã€çŸ­ä¿¡ç™»å½•">1ã€çŸ­ä¿¡ç™»å½•</h2>
<h3 id="1-1ã€å¯¼å…¥é»‘é©¬ç‚¹è¯„é¡¹ç›®">1.1ã€å¯¼å…¥é»‘é©¬ç‚¹è¯„é¡¹ç›®</h3>
<h4 id="1-1-1-ã€å¯¼å…¥SQLï¼ˆMysqlç‰ˆæœ¬å¤§äº5-7ï¼‰">1.1.1 ã€å¯¼å…¥SQLï¼ˆMysqlç‰ˆæœ¬å¤§äº5.7ï¼‰</h4>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-25.png" alt="img"></p>
<h4 id="1-1-2ã€æœ‰å…³å½“å‰æ¨¡å‹">1.1.2ã€æœ‰å…³å½“å‰æ¨¡å‹</h4>
<p>æ‰‹æœºæˆ–è€…appç«¯å‘èµ·è¯·æ±‚ï¼Œè¯·æ±‚æˆ‘ä»¬çš„nginxæœåŠ¡å™¨ï¼ŒnginxåŸºäºä¸ƒå±‚æ¨¡å‹èµ°çš„äº‹HTTPåè®®ï¼Œå¯ä»¥å®ç°åŸºäºLuaç›´æ¥ç»•å¼€tomcatè®¿é—®redisï¼Œä¹Ÿå¯ä»¥ä½œä¸ºé™æ€èµ„æºæœåŠ¡å™¨ï¼Œè½»æ¾æ‰›ä¸‹ä¸Šä¸‡å¹¶å‘ï¼Œ è´Ÿè½½å‡è¡¡åˆ°ä¸‹æ¸¸tomcatæœåŠ¡å™¨ï¼Œæ‰“æ•£æµé‡ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ä¸€å°4æ ¸8Gçš„tomcatï¼Œåœ¨ä¼˜åŒ–å’Œå¤„ç†ç®€å•ä¸šåŠ¡çš„åŠ æŒä¸‹ï¼Œå¤§ä¸äº†å°±å¤„ç†1000å·¦å³çš„å¹¶å‘ï¼Œ ç»è¿‡nginxçš„è´Ÿè½½å‡è¡¡åˆ†æµåï¼Œåˆ©ç”¨é›†ç¾¤æ”¯æ’‘èµ·æ•´ä¸ªé¡¹ç›®ï¼ŒåŒæ—¶nginxåœ¨éƒ¨ç½²äº†å‰ç«¯é¡¹ç›®åï¼Œæ›´æ˜¯å¯ä»¥åšåˆ°åŠ¨é™åˆ†ç¦»ï¼Œè¿›ä¸€æ­¥é™ä½tomcatæœåŠ¡çš„å‹åŠ›ï¼Œè¿™äº›åŠŸèƒ½éƒ½å¾—é nginxèµ·ä½œç”¨ï¼Œæ‰€ä»¥nginxæ˜¯æ•´ä¸ªé¡¹ç›®ä¸­é‡è¦çš„ä¸€ç¯ã€‚</p>
<p>åœ¨tomcatæ”¯æ’‘èµ·å¹¶å‘æµé‡åï¼Œæˆ‘ä»¬å¦‚æœè®©tomcatç›´æ¥å»è®¿é—®Mysqlï¼Œæ ¹æ®ç»éªŒMysqlä¼ä¸šçº§æœåŠ¡å™¨åªè¦ä¸Šç‚¹å¹¶å‘ï¼Œä¸€èˆ¬æ˜¯16æˆ–32 æ ¸å¿ƒcpuï¼Œ32 æˆ–64Gå†…å­˜ï¼Œåƒä¼ä¸šçº§mysqlåŠ ä¸Šå›ºæ€ç¡¬ç›˜èƒ½å¤Ÿæ”¯æ’‘çš„å¹¶å‘ï¼Œå¤§æ¦‚å°±æ˜¯4000èµ·~7000å·¦å³ï¼Œä¸Šä¸‡å¹¶å‘ï¼Œ ç¬é—´å°±ä¼šè®©MysqlæœåŠ¡å™¨çš„cpuï¼Œç¡¬ç›˜å…¨éƒ¨æ‰“æ»¡ï¼Œå®¹æ˜“å´©æºƒï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œä¼šé€‰æ‹©ä½¿ç”¨mysqlé›†ç¾¤ï¼ŒåŒæ—¶ä¸ºäº†è¿›ä¸€æ­¥é™ä½Mysqlçš„å‹åŠ›ï¼ŒåŒæ—¶å¢åŠ è®¿é—®çš„æ€§èƒ½ï¼Œæˆ‘ä»¬ä¹Ÿä¼šåŠ å…¥Redisï¼ŒåŒæ—¶ä½¿ç”¨Redisé›†ç¾¤ä½¿å¾—Rediså¯¹å¤–æä¾›æ›´å¥½çš„æœåŠ¡ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-26-1024x432.png" alt="img"></p>
<p>1.1.3ã€å¯¼å…¥åç«¯é¡¹ç›®</p>
<p>æ³¨æ„è¦ä¿®æ”¹application.yamlæ–‡ä»¶é‡Œçš„mysqlï¼Œredisåœ°å€ä¿¡æ¯</p>
<p>1.1.4ã€å¯¼å…¥å‰ç«¯å·¥ç¨‹</p>
<p>1.1.5 è¿è¡Œå‰ç«¯é¡¹ç›®</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">localhost</span>ï¼š<span class="number">8080</span></span><br></pre></td></tr></table></figure>
<h3 id="1-2-ã€åŸºäºSessionå®ç°ç™»å½•æµç¨‹">1.2 ã€åŸºäºSessionå®ç°ç™»å½•æµç¨‹</h3>
<p><strong>å‘é€éªŒè¯ç ï¼š</strong></p>
<p>ç”¨æˆ·åœ¨æäº¤æ‰‹æœºå·åï¼Œä¼šæ ¡éªŒæ‰‹æœºå·æ˜¯å¦åˆæ³•ï¼Œå¦‚æœä¸åˆæ³•ï¼Œåˆ™è¦æ±‚ç”¨æˆ·é‡æ–°è¾“å…¥æ‰‹æœºå·</p>
<p>å¦‚æœæ‰‹æœºå·åˆæ³•ï¼Œåå°æ­¤æ—¶ç”Ÿæˆå¯¹åº”çš„éªŒè¯ç ï¼ŒåŒæ—¶å°†éªŒè¯ç è¿›è¡Œä¿å­˜ï¼Œç„¶åå†é€šè¿‡çŸ­ä¿¡çš„æ–¹å¼å°†éªŒè¯ç å‘é€ç»™ç”¨æˆ·</p>
<p><strong>çŸ­ä¿¡éªŒè¯ç ç™»å½•ã€æ³¨å†Œï¼š</strong></p>
<p>ç”¨æˆ·å°†éªŒè¯ç å’Œæ‰‹æœºå·è¿›è¡Œè¾“å…¥ï¼Œåå°ä»sessionä¸­æ‹¿åˆ°å½“å‰éªŒè¯ç ï¼Œç„¶åå’Œç”¨æˆ·è¾“å…¥çš„éªŒè¯ç è¿›è¡Œæ ¡éªŒï¼Œå¦‚æœä¸ä¸€è‡´ï¼Œåˆ™æ— æ³•é€šè¿‡æ ¡éªŒï¼Œå¦‚æœä¸€è‡´ï¼Œåˆ™åå°æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·ï¼Œå¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ™ä¸ºç”¨æˆ·åˆ›å»ºè´¦å·ä¿¡æ¯ï¼Œä¿å­˜åˆ°æ•°æ®åº“ï¼Œæ— è®ºæ˜¯å¦å­˜åœ¨ï¼Œéƒ½ä¼šå°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°sessionä¸­ï¼Œæ–¹ä¾¿åç»­è·å¾—å½“å‰ç™»å½•ä¿¡æ¯</p>
<p><strong>æ ¡éªŒç™»å½•çŠ¶æ€:</strong></p>
<p>ç”¨æˆ·åœ¨è¯·æ±‚æ—¶å€™ï¼Œä¼šä»cookieä¸­æºå¸¦è€…JsessionIdåˆ°åå°ï¼Œåå°é€šè¿‡JsessionIdä»sessionä¸­æ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰sessionä¿¡æ¯ï¼Œåˆ™è¿›è¡Œæ‹¦æˆªï¼Œå¦‚æœæœ‰sessionä¿¡æ¯ï¼Œåˆ™å°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°threadLocalä¸­ï¼Œå¹¶ä¸”æ”¾è¡Œ</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-27-1024x494.png" alt="img"></p>
<h3 id="1-3å®ç°å‘é€çŸ­ä¿¡éªŒè¯ç ">1.3å®ç°å‘é€çŸ­ä¿¡éªŒè¯ç </h3>
<p><strong>é¡µé¢æµç¨‹</strong></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-29-1024x443.png" alt="img"></p>
<p>å…·ä½“ä»£ç å¦‚ä¸‹</p>
<ul>
<li>*<strong>å‘é€éªŒè¯ç *</strong></li>
</ul>
<p>UserController</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å‘é€æ‰‹æœºéªŒè¯ç </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@PostMapping</span>(<span class="string">&quot;code&quot;</span>)</span><br><span class="line">public Result <span class="built_in">sendCode</span>(<span class="variable">@RequestParam</span>(<span class="string">&quot;phone&quot;</span>) String phone, HttpSession session) &#123;</span><br><span class="line">    <span class="comment">// TODO å‘é€çŸ­ä¿¡éªŒè¯ç å¹¶ä¿å­˜éªŒè¯ç </span></span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">userService</span><span class="selector-class">.sendCode</span>(phone, session);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>IUserService</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUserService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;<span class="title class_">User</span>&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å‘é€éªŒè¯ç </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> <span class="variable">phone</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> <span class="variable">session</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="title class_">Result</span> <span class="title function_">sendCode</span>(<span class="title class_">String</span> phone, <span class="title class_">HttpSession</span> session);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">IUserServiceImpl</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å‘é€éªŒè¯ç </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">phone</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">session</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> <span class="title class_">Result</span> <span class="title function_">sendCode</span>(<span class="params"><span class="title class_">String</span> phone, <span class="title class_">HttpSession</span> session</span>) &#123;</span><br><span class="line"> <span class="comment">// 1.æ ¡éªŒæ‰‹æœºå·</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="title class_">RegexUtils</span>.<span class="title function_">isPhoneInvalid</span>(phone)) &#123;</span><br><span class="line"> <span class="comment">// 2.å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line"> <span class="keyword">return</span> <span class="title class_">Result</span>.<span class="title function_">fail</span>(<span class="string">&quot;æ‰‹æœºå·æ ¼å¼é”™è¯¯ï¼&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// 3.ç¬¦åˆï¼Œç”ŸæˆéªŒè¯ç </span></span><br><span class="line"> <span class="title class_">String</span> code = <span class="title class_">RandomUtil</span>.<span class="title function_">randomNumbers</span>(<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 4.ä¿å­˜éªŒè¯ç åˆ° session</span></span><br><span class="line"> session.<span class="title function_">setAttribute</span>(<span class="string">&quot;code&quot;</span>,code);</span><br><span class="line"> <span class="comment">// 5.å‘é€éªŒè¯ç </span></span><br><span class="line"> log.<span class="title function_">debug</span>(<span class="string">&quot;å‘é€çŸ­ä¿¡éªŒè¯ç æˆåŠŸï¼ŒéªŒè¯ç ï¼š&#123;&#125;&quot;</span>, code);</span><br><span class="line"> <span class="comment">// è¿”å›ok</span></span><br><span class="line"> <span class="keyword">return</span> <span class="title class_">Result</span>.<span class="title function_">ok</span>();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>*<strong>ç™»å½•*</strong></li>
</ul>
<p>UserController</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç™»å½•åŠŸèƒ½</span></span><br><span class="line"><span class="comment"> * @param loginForm ç™»å½•å‚æ•°ï¼ŒåŒ…å«æ‰‹æœºå·ã€éªŒè¯ç ï¼›æˆ–è€…æ‰‹æœºå·ã€å¯†ç </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@PostMapping</span>(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line">public Result <span class="built_in">login</span>(<span class="variable">@RequestBody</span> LoginFormDTO loginForm, HttpSession session)&#123;</span><br><span class="line">    <span class="comment">// å®ç°ç™»å½•åŠŸèƒ½</span></span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">userService</span><span class="selector-class">.login</span>(loginForm, session);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>IUserService</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç™»å½•åŠŸèƒ½</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> loginForm</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Result <span class="title">login</span><span class="params">(LoginFormDTO loginForm, HttpSession session)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>IUserServiceImpl</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç”¨æˆ·ç™»å½•</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">loginForm</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">session</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">Result</span> <span class="title function_">login</span>(<span class="params"><span class="title class_">LoginFormDTO</span> loginForm, <span class="title class_">HttpSession</span> session</span>) &#123;</span><br><span class="line">    <span class="comment">//1.æ ¡éªŒæ‰‹æœºå·</span></span><br><span class="line">    <span class="title class_">String</span> phone = loginForm.<span class="title function_">getPhone</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">RegexUtils</span>.<span class="title function_">isPhoneInvalid</span>(phone)) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Result</span>.<span class="title function_">fail</span>(<span class="string">&quot;æ‰‹æœºå·æ ¼å¼é”™è¯¯&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.æ ¡éªŒéªŒè¯ç </span></span><br><span class="line">    <span class="title class_">Object</span> cacheCode = session.<span class="title function_">getAttribute</span>(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">    <span class="title class_">String</span> code = loginForm.<span class="title function_">getCode</span>();</span><br><span class="line">    <span class="keyword">if</span> (cacheCode == <span class="literal">null</span> || !cacheCode.<span class="title function_">toString</span>().<span class="title function_">equals</span>(code)) &#123;</span><br><span class="line">        <span class="comment">//3.ä¸ä¸€è‡´ï¼Œç›´æ¥è¿”å›é”™è¯¯ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Result</span>.<span class="title function_">fail</span>(<span class="string">&quot;éªŒè¯ç é”™è¯¯&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4.ä¸€è‡´ï¼Œæ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ· select * from tb_user where phone = ?</span></span><br><span class="line">    <span class="title class_">User</span> user = <span class="title function_">query</span>().<span class="title function_">eq</span>(<span class="string">&quot;phone&quot;</span>, phone).<span class="title function_">one</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//6ã€‚ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·å¹¶ä¿å­˜</span></span><br><span class="line">        user = <span class="title function_">createUserWithPhone</span>(phone);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//7.å­˜åœ¨ï¼Œä¿å­˜ç”¨æˆ·åˆ°session</span></span><br><span class="line">    session.<span class="title function_">setAttribute</span>(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//8.è¿”å›ç™»å½•æˆåŠŸçš„ç»“æœ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Result</span>.<span class="title function_">ok</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="title class_">User</span> <span class="title function_">createUserWithPhone</span>(<span class="params"><span class="title class_">String</span> phone</span>) &#123;</span><br><span class="line">    <span class="comment">//1.åˆ›å»ºç”¨æˆ·</span></span><br><span class="line">    <span class="title class_">User</span> user = <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.<span class="title function_">setPhone</span>(phone);</span><br><span class="line">    user.<span class="title function_">setNickName</span>(<span class="variable constant_">USER_NICK_NAME_PREFIX</span>+<span class="title class_">RandomUtil</span>.<span class="title function_">randomString</span>(<span class="number">10</span>));</span><br><span class="line">    <span class="comment">//2.ä¿å­˜ç”¨æˆ·åˆ°æ•°æ®åº“ insert into tb_user values (null, ?, null)</span></span><br><span class="line">    <span class="title function_">save</span>(user);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-4-æ˜¾ç¤ºç™»å½•æ‹¦æˆª">1.4 æ˜¾ç¤ºç™»å½•æ‹¦æˆª</h3>
<p><strong>tomcatçš„è¿è¡ŒåŸç†</strong></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-53-1024x599.png" alt="img"></p>
<h4 id="1-å»ºç«‹è¿æ¥"><strong>1. å»ºç«‹è¿æ¥</strong></h4>
<ul>
<li><strong>ç”¨æˆ·ï¼ˆå®¢æˆ·ç«¯ï¼‰</strong> å‘èµ·ä¸€ä¸ª HTTP è¯·æ±‚ï¼Œé¦–å…ˆä¼šé€šè¿‡æµè§ˆå™¨æˆ–å…¶ä»–å®¢æˆ·ç«¯å‘èµ· <strong>TCP è¿æ¥</strong>ã€‚</li>
<li>è¿™ä¸ªè¿æ¥ç”±ç”¨æˆ·çš„ <strong>socket</strong> å»ºç«‹ï¼Œè¿æ¥åˆ°æœåŠ¡å™¨ä¸ŠæŒ‡å®šçš„ <strong>ç«¯å£å·</strong>ï¼ˆTomcat æ³¨å†Œçš„ç«¯å£ï¼Œå¦‚é»˜è®¤çš„ 8080ï¼‰ã€‚</li>
<li>Tomcat åœ¨å¯åŠ¨æ—¶ï¼Œä¼šå¼€å¯ä¸€ä¸ª <strong>ç›‘å¬çº¿ç¨‹</strong>ï¼ˆAcceptorï¼‰ï¼Œä¸“é—¨è´Ÿè´£ç›‘å¬è¯¥ç«¯å£ï¼Œç­‰å¾…æ¥å…¥çš„ socket è¿æ¥ã€‚</li>
</ul>
<h4 id="2-åˆ†å‘è¯·æ±‚"><strong>2. åˆ†å‘è¯·æ±‚</strong></h4>
<ul>
<li>ä¸€æ—¦ç›‘å¬çº¿ç¨‹ç›‘å¬åˆ°å®¢æˆ·ç«¯å‘æ¥çš„è¿æ¥è¯·æ±‚ï¼Œå®ƒå°±ä¼šï¼š
<ul>
<li><strong>æ¥æ”¶ socket è¿æ¥</strong></li>
<li>å°†è¿™ä¸ªè¿æ¥äº¤ç»™ <strong>å·¥ä½œçº¿ç¨‹æ± ï¼ˆWorker Thread Poolï¼‰</strong> ä¸­çš„ä¸€ä¸ªçº¿ç¨‹å»å¤„ç†ã€‚</li>
</ul>
</li>
<li>è¿™ä¸€æ­¥å¾ˆå…³é”®ï¼š
<ul>
<li>æ¯ä¸ªè¯·æ±‚éƒ½è¢«åˆ†å‘ç»™çº¿ç¨‹æ± ä¸­çš„ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œ<strong>å®ç°äº†å¤šçº¿ç¨‹å¹¶å‘å¤„ç†</strong>ã€‚</li>
<li>è¿™ä¸ªçº¿ç¨‹éšåä¼šè´Ÿè´£æ•´ä¸ªè¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸã€‚</li>
</ul>
</li>
</ul>
<h4 id="3-å¤„ç†è¯·æ±‚"><strong>3. å¤„ç†è¯·æ±‚</strong></h4>
<ul>
<li>
<p>å·¥ä½œçº¿ç¨‹æ¥æ‰‹åï¼Œå®ƒä¼šï¼š</p>
<ul>
<li>è¯»å–å®¢æˆ·ç«¯å‘é€çš„ HTTP è¯·æ±‚æ•°æ®ã€‚</li>
<li>æŠŠè¿™äº›æ•°æ®è§£ææˆæ ‡å‡†çš„ <strong><code>HttpServletRequest</code></strong> å¯¹è±¡ï¼Œå¹¶å‡†å¤‡å¥½ä¸€ä¸ªç©ºçš„ <strong><code>HttpServletResponse</code></strong>ã€‚</li>
</ul>
</li>
<li>
<p>ç„¶åè¯·æ±‚è¿›å…¥ä½ éƒ¨ç½²åœ¨ Tomcat ä¸­çš„</p>
<p>WebApp</p>
<p>ï¼ˆSpringMVCã€Servlet åº”ç”¨ç­‰ï¼‰ï¼š</p>
<ul>
<li>ä¾æ¬¡ç»è¿‡ï¼š
<ul>
<li><strong>Controller</strong>ï¼ˆæ¥æ”¶è¯·æ±‚ï¼Œè·¯ç”±åˆ†å‘ï¼‰</li>
<li><strong>Service</strong>ï¼ˆå¤„ç†ä¸šåŠ¡é€»è¾‘ï¼‰</li>
<li><strong>DAO</strong>ï¼ˆè®¿é—®æ•°æ®åº“ï¼Œè·å–æˆ–ä¿®æ”¹æ•°æ®ï¼‰</li>
</ul>
</li>
</ul>
</li>
<li>
<p>æ•°æ®å¤„ç†å®Œæˆåï¼Œè¿”å›å€¼ä¼šå°è£…åˆ° <code>response</code> ä¸­ã€‚</p>
</li>
</ul>
<h4 id="4-è¿”å›å“åº”"><strong>4. è¿”å›å“åº”</strong></h4>
<ul>
<li>ä¸€æ—¦ä¸šåŠ¡å¤„ç†å®Œæ¯•ï¼Œçº¿ç¨‹å°†å“åº”å†…å®¹å†™å…¥ <code>HttpServletResponse</code>ã€‚</li>
<li>ç„¶åå†é€šè¿‡æœ€åˆå»ºç«‹çš„ <strong>socket è¿æ¥</strong>ï¼ŒæŠŠå“åº”æ•°æ®å‘é€å›å®¢æˆ·ç«¯ï¼ˆç”¨æˆ·ï¼‰ã€‚</li>
<li>è‡³æ­¤ï¼Œ<strong>ä¸€ä¸ªè¯·æ±‚-å“åº”ç”Ÿå‘½å‘¨æœŸå®Œæˆ</strong>ï¼Œsocket è¿æ¥å¯èƒ½è¢«å…³é—­æˆ–å¤ç”¨ï¼ˆæ ¹æ®æ˜¯å¦ä½¿ç”¨ keep-aliveï¼‰ã€‚</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-54-1024x522.png" alt="img"></p>
<p>preHandleå‰ç½®æ‹¦æˆªï¼š</p>
<p>postHandleåç½®æ‹¦æˆªï¼š</p>
<p>afterCompletionè§†å›¾æ¸²æŸ“ä¹‹åè¿”å›ç»™ç”¨æˆ·ä¹‹å‰ï¼š</p>
<p>åœ¨utilsä¸‹é¢ç¼–å†™ä¸€ä¸ªLoginInterceptorç±»ï¼Œå®ç°preHandleå’ŒafterCompletionè¿™ä¸¤ä¸ªæ–¹æ³•ï¼ˆè¿™é‡ŒUserå’ŒUserDtoçš„é—®é¢˜ï¼Œæˆ‘æ¨èçš„æ˜¯ç»Ÿä¸€ä½¿ç”¨UserDtoï¼Œé‡‡ç”¨BeanUtilsé‡Œçš„copyæ–¹æ³•å³å¯ï¼‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//è·å–session</span></span><br><span class="line">        <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession();</span><br><span class="line">        <span class="comment">//è·å–ç”¨æˆ·</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) session.getAttribute(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="comment">//åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span>(user==<span class="literal">null</span>)&#123;</span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserDTO</span>();</span><br><span class="line">        BeanUtils.copyProperties(user,userDTO);</span><br><span class="line">        <span class="comment">//å­˜åœ¨ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯çš„ThreadLocal</span></span><br><span class="line">        UserHolder.saveUser(userDTO);</span><br><span class="line">        <span class="comment">//æ”¾è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//ç§»é™¤ç”¨æˆ·</span></span><br><span class="line">        UserHolder.removeUser();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>â€‹<br>
åœ¨configä¸‹é¢åˆ›å»ºä¸€ä¸ªMvcConfigç±»ï¼š</p>
<p>é€šè¿‡addInterceptorsæ–¹æ³•æ¥æ·»åŠ æ‹¦æˆªå™¨ï¼Œregistryæ˜¯æ‹¦æˆªå™¨çš„æ³¨å†Œå™¨ã€‚</p>
<p>ç”¨.excludePathPatternsæ¥æ’é™¤ä¸éœ€è¦æ‹¦æˆªçš„è·¯å¾„ã€‚åœ¨è¿™é‡Œcodeã€loginã€bloghotã€shopã€shopTypeã€uploadå’Œvoucherç­‰éƒ½ä¸éœ€è¦æ‹¦æˆªã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">StringRedisTemplate</span> stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">addInterceptors</span>(<span class="params"><span class="title class_">InterceptorRegistry</span> registry</span>) &#123;</span><br><span class="line">        <span class="comment">// ç™»å½•æ‹¦æˆªå™¨</span></span><br><span class="line">        registry.<span class="title function_">addInterceptor</span>(<span class="keyword">new</span> <span class="title class_">LoginInterceptor</span>())</span><br><span class="line">                .<span class="title function_">excludePathPatterns</span>(</span><br><span class="line">                        <span class="string">&quot;/shop/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/voucher/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop-type/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/upload/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/blog/hot&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/user/code&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/user/login&quot;</span></span><br><span class="line">                ).<span class="title function_">order</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// tokenåˆ·æ–°çš„æ‹¦æˆªå™¨</span></span><br><span class="line">        registry.<span class="title function_">addInterceptor</span>(<span class="keyword">new</span> <span class="title class_">RefreshTokenInterceptor</span>(stringRedisTemplate)).<span class="title function_">addPathPatterns</span>(<span class="string">&quot;/**&quot;</span>).<span class="title function_">order</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å…¥æ‰‹æœºå·ç ç‚¹å‡»è·å–éªŒè¯ç ï¼Œå†™å…¥è¿”å›åç«¯çš„éªŒè¯ç ï¼Œå‹¾é€‰åè®®ä¹‹åï¼Œç™»å½•ä¼šç›´æ¥è¿”å›é¦–é¡µï¼Œæ­¤æ—¶çœ‹æˆ‘çš„ä¸ªäººä¸»é¡µæ²¡é—®é¢˜ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-55.png" alt="img"></p>
<h3 id="1-5ã€éšè—ç”¨æˆ·æ•æ„Ÿä¿¡æ¯">1.5ã€éšè—ç”¨æˆ·æ•æ„Ÿä¿¡æ¯</h3>
<p>æˆ‘ä»¬é€šè¿‡æµè§ˆå™¨è§‚å¯Ÿåˆ°æ­¤æ—¶ç”¨æˆ·çš„å…¨éƒ¨ä¿¡æ¯éƒ½åœ¨ï¼Œè¿™æ ·æä¸ºä¸é è°±ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”å½“åœ¨è¿”å›ç”¨æˆ·ä¿¡æ¯ä¹‹å‰ï¼Œå°†ç”¨æˆ·çš„æ•æ„Ÿä¿¡æ¯è¿›è¡Œéšè—ï¼Œé‡‡ç”¨çš„æ ¸å¿ƒæ€è·¯å°±æ˜¯ä¹¦å†™ä¸€ä¸ªUserDtoå¯¹è±¡ï¼Œè¿™ä¸ªUserDtoå¯¹è±¡å°±æ²¡æœ‰æ•æ„Ÿä¿¡æ¯äº†ï¼Œæˆ‘ä»¬åœ¨è¿”å›å‰ï¼Œå°†æœ‰ç”¨æˆ·æ•æ„Ÿä¿¡æ¯çš„Userå¯¹è±¡è½¬åŒ–æˆæ²¡æœ‰æ•æ„Ÿä¿¡æ¯çš„UserDtoå¯¹è±¡ï¼Œé‚£ä¹ˆå°±èƒ½å¤Ÿé¿å…è¿™ä¸ªå°´å°¬çš„é—®é¢˜äº†</p>
<p>åœ¨1.4å·²å°†Userè½¬ä¸ºUserDTOè¿”å›ç»™å‰ç«¯ã€‚</p>
<h3 id="1-6ã€sessionå…±äº«é—®é¢˜">1.6ã€sessionå…±äº«é—®é¢˜</h3>
<p><strong>æ ¸å¿ƒæ€è·¯åˆ†æï¼š</strong></p>
<p>æ¯ä¸ªtomcatä¸­éƒ½æœ‰ä¸€ä»½å±äºè‡ªå·±çš„session,å‡è®¾ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®ç¬¬ä¸€å°tomcatï¼Œå¹¶ä¸”æŠŠè‡ªå·±çš„ä¿¡æ¯å­˜æ”¾åˆ°ç¬¬ä¸€å°æœåŠ¡å™¨çš„sessionä¸­ï¼Œä½†æ˜¯ç¬¬äºŒæ¬¡è¿™ä¸ªç”¨æˆ·è®¿é—®åˆ°äº†ç¬¬äºŒå°tomcatï¼Œé‚£ä¹ˆåœ¨ç¬¬äºŒå°æœåŠ¡å™¨ä¸Šï¼Œè‚¯å®šæ²¡æœ‰ç¬¬ä¸€å°æœåŠ¡å™¨å­˜æ”¾çš„sessionï¼Œæ‰€ä»¥æ­¤æ—¶ æ•´ä¸ªç™»å½•æ‹¦æˆªåŠŸèƒ½å°±ä¼šå‡ºç°é—®é¢˜ï¼Œæˆ‘ä»¬èƒ½å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿæ—©æœŸçš„æ–¹æ¡ˆæ˜¯<strong>sessionæ‹·è´</strong>ï¼Œå°±æ˜¯è¯´è™½ç„¶æ¯ä¸ªtomcatä¸Šéƒ½æœ‰ä¸åŒçš„sessionï¼Œä½†æ˜¯æ¯å½“ä»»æ„ä¸€å°æœåŠ¡å™¨çš„sessionä¿®æ”¹æ—¶ï¼Œéƒ½ä¼šåŒæ­¥ç»™å…¶ä»–çš„TomcatæœåŠ¡å™¨çš„sessionï¼Œè¿™æ ·çš„è¯ï¼Œå°±å¯ä»¥å®ç°sessionçš„å…±äº«äº†</p>
<p>ä½†æ˜¯è¿™ç§æ–¹æ¡ˆå…·æœ‰<strong>ä¸¤ä¸ªå¤§é—®é¢˜</strong></p>
<p>1ã€æ¯å°æœåŠ¡å™¨ä¸­éƒ½æœ‰å®Œæ•´çš„ä¸€ä»½sessionæ•°æ®ï¼Œ<strong>æœåŠ¡å™¨å‹åŠ›è¿‡å¤§ã€‚</strong></p>
<p>2ã€sessionæ‹·è´æ•°æ®æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°<strong>å»¶è¿Ÿ</strong></p>
<p>æ‰€ä»¥å’±ä»¬åæ¥é‡‡ç”¨çš„æ–¹æ¡ˆéƒ½æ˜¯<strong>åŸºäºredisæ¥å®Œæˆ</strong>ï¼Œæˆ‘ä»¬æŠŠsessionæ¢æˆredisï¼Œ<strong>redisæ•°æ®æœ¬èº«å°±æ˜¯å…±äº«çš„</strong>ï¼Œå°±å¯ä»¥é¿å…sessionå…±äº«çš„é—®é¢˜äº†</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-56-1024x444.png" alt="img"></p>
<h3 id="1-7-Redisä»£æ›¿sessionçš„ä¸šåŠ¡æµç¨‹">1.7 Redisä»£æ›¿sessionçš„ä¸šåŠ¡æµç¨‹</h3>
<p>æ€è€ƒä¸€ä¸‹åˆ©ç”¨redisæ¥å­˜å‚¨æ•°æ®ï¼Œé‚£ä¹ˆåˆ°åº•ä½¿ç”¨å“ªç§ç»“æ„å‘¢</p>
<p>æƒ³è¦ä¿å­˜ç”¨æˆ·çš„ç™»å½•ä¿¡æ¯æœ‰2ç§æ–¹æ³•ï¼š1.ç”¨Stringç±»å‹ã€‚2.ç”¨Hashç±»å‹ã€‚</p>
<p>å¦‚ä¸‹å›¾ï¼Œå¦‚æœä½¿ç”¨Stringï¼Œæ³¨æ„ä»–çš„valueï¼Œç”¨å¤šå ç”¨ä¸€ç‚¹ç©ºé—´ï¼Œå¦‚æœä½¿ç”¨å“ˆå¸Œï¼Œåˆ™ä»–çš„valueä¸­åªä¼šå­˜å‚¨ä»–æ•°æ®æœ¬èº«ï¼Œå¦‚æœä¸æ˜¯ç‰¹åˆ«åœ¨æ„å†…å­˜ï¼Œå…¶å®ä½¿ç”¨Stringå°±å¯ä»¥å•¦ã€‚</p>
<p>Stringç±»å‹æ˜¯ä»¥JSONå­—ç¬¦ä¸²æ ¼å¼æ¥ä¿å­˜ï¼Œæ¯”è¾ƒç®€å•ç›´è§‚ï¼Œä½†æ˜¯å ç”¨å†…å­˜æ¯”è¾ƒå¤šï¼ˆå› ä¸ºæœ‰nameå’Œageè¿™ç±»çš„jsonæ ¼å¼ï¼‰ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-59.png" alt="img"></p>
<p>Hashç»“æ„å¯ä»¥å°†å¯¹è±¡ä¸­çš„æ¯ä¸ªå­—æ®µç‹¬ç«‹å­˜å‚¨ï¼Œå¯ä»¥é’ˆå¯¹å•ä¸ªå­—æ®µåšCRUDï¼Œå¹¶ä¸”å†…å­˜å ç”¨æ›´å°‘ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-58.png" alt="img"></p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Stringç»“æ„ï¼Œå°±æ˜¯ä¸€ä¸ªç®€å•çš„keyï¼Œvalueé”®å€¼å¯¹çš„æ–¹å¼ï¼Œä½†æ˜¯å…³äºkeyçš„å¤„ç†ï¼Œsessionä»–æ˜¯æ¯ä¸ªç”¨æˆ·éƒ½æœ‰è‡ªå·±çš„sessionï¼Œä½†æ˜¯redisçš„keyæ˜¯å…±äº«çš„ï¼Œå’±ä»¬å°±ä¸èƒ½ä½¿ç”¨codeäº†</p>
<h4 id="1-7-1åœ¨è®¾è®¡è¿™ä¸ªkeyçš„æ—¶å€™ï¼Œéœ€è¦æ»¡è¶³ä¸¤ç‚¹">1.7.1åœ¨è®¾è®¡è¿™ä¸ªkeyçš„æ—¶å€™ï¼Œéœ€è¦æ»¡è¶³ä¸¤ç‚¹</h4>
<p>1ã€keyè¦å…·æœ‰å”¯ä¸€æ€§</p>
<p>2ã€keyè¦æ–¹ä¾¿æºå¸¦</p>
<p>å¦‚æœæˆ‘ä»¬é‡‡ç”¨phoneï¼šæ‰‹æœºå·è¿™ä¸ªçš„æ•°æ®æ¥å­˜å‚¨å½“ç„¶æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯å¦‚æœæŠŠè¿™æ ·çš„æ•æ„Ÿæ•°æ®å­˜å‚¨åˆ°redisä¸­å¹¶ä¸”ä»é¡µé¢ä¸­å¸¦è¿‡æ¥æ¯•ç«Ÿä¸å¤ªåˆé€‚ï¼Œ<strong>æ‰€ä»¥æˆ‘ä»¬åœ¨åå°ç”Ÿæˆä¸€ä¸ªéšæœºä¸²token</strong>ï¼Œç„¶åè®©å‰ç«¯å¸¦æ¥è¿™ä¸ªtokenå°±èƒ½å®Œæˆæˆ‘ä»¬çš„æ•´ä½“é€»è¾‘äº†</p>
<h4 id="1-7-2-æ•´ä½“è®¿é—®æµç¨‹">1.7.2 æ•´ä½“è®¿é—®æµç¨‹</h4>
<p>å½“æ³¨å†Œå®Œæˆåï¼Œç”¨æˆ·å»ç™»å½•ä¼šå»æ ¡éªŒç”¨æˆ·æäº¤çš„æ‰‹æœºå·å’ŒéªŒè¯ç ï¼Œæ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´ï¼Œåˆ™æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œä¸å­˜åœ¨åˆ™æ–°å»ºï¼Œæœ€åå°†ç”¨æˆ·æ•°æ®ä¿å­˜åˆ°redisï¼Œå¹¶ä¸”ç”Ÿæˆtokenä½œä¸ºredisçš„keyï¼Œå½“æˆ‘ä»¬æ ¡éªŒç”¨æˆ·æ˜¯å¦ç™»å½•æ—¶ï¼Œä¼šå»æºå¸¦ç€tokenè¿›è¡Œè®¿é—®ï¼Œä»redisä¸­å–å‡ºtokenå¯¹åº”çš„valueï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨è¿™ä¸ªæ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ‹¦æˆªï¼Œå¦‚æœå­˜åœ¨åˆ™å°†å…¶ä¿å­˜åˆ°threadLocalä¸­ï¼Œå¹¶ä¸”æ”¾è¡Œã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-60-1024x557.png" alt="img"></p>
<h3 id="1-8-åŸºäºRediså®ç°çŸ­ä¿¡ç™»å½•">1.8 åŸºäºRediså®ç°çŸ­ä¿¡ç™»å½•</h3>
<p>åœ¨UserServiceImplä¸­å†™å…¥å¦‚ä¸‹ä»£ç ï¼ˆè°ƒç”¨StringRedisTemplateä¸­çš„setæ–¹æ³•è¿›è¡Œæ•°æ®æ’å…¥ï¼Œæœ€å¥½åœ¨keyçš„å‰é¢åŠ å…¥ä¸šåŠ¡å‰ç¼€ä»¥ç¤ºåŒºåˆ†ï¼Œå½¢æˆåŒºåˆ†ï¼‰ï¼š</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Resource</span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate <span class="built_in">string</span>RedisTemplate;</span><br></pre></td></tr></table></figure>
<p>åœ¨sendCodeè¿™ä¸ªæ–¹æ³•é‡Œå°†ä¿å­˜éªŒè¯ç çš„ä»£ç æ›¿æ¢ä¸ºä¸‹é¢ï¼š</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¿å­˜éªŒè¯ç åˆ°redis</span></span><br><span class="line"><span class="symbol">stringRedisTemplate.opsForValue</span>()<span class="meta">.set</span>(LOGIN_CODE_KEY+phone,<span class="meta">code</span>,LOGIN_CODE_TTL, TimeUnit.MINUTES)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>åœ¨loginè¿™ä¸ªæ–¹æ³•é‡Œè¿›è¡Œå¦‚ä¸‹2å¤„ä¿®æ”¹ï¼š</p>
<p>é¦–å…ˆæ˜¯æ ¡éªŒéªŒè¯ç ï¼š</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ ¡éªŒéªŒè¯ç </span></span><br><span class="line"><span class="built_in">String</span> cacheCode = stringRedisTemplate.opsForValue().<span class="keyword">get</span>(LOGIN_CODE_KEY + phone);</span><br></pre></td></tr></table></figure>
<p>ç„¶åæ˜¯æ·»åŠ æŠŠç”¨æˆ·ä¿¡æ¯æ·»åŠ åˆ°Redisçš„é€»è¾‘</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 7.ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ° redisä¸­</span></span><br><span class="line">    <span class="comment">// 7.1.éšæœºç”Ÿæˆtokenï¼Œä½œä¸ºç™»å½•ä»¤ç‰Œ</span></span><br><span class="line">    <span class="built_in">String</span> token = UUID.randomUUID().toString(<span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// 7.2.å°†Userå¯¹è±¡è½¬ä¸ºHashMapå­˜å‚¨</span></span><br><span class="line">    UserDTO userDTO = BeanUtil.copyProperties(user, UserDTO.<span class="keyword">class</span>);</span><br><span class="line">    <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt; userMap = BeanUtil.beanToMap(userDTO, <span class="keyword">new</span> HashMap&lt;&gt;(),</span><br><span class="line">            CopyOptions.create()</span><br><span class="line">                    .setIgnoreNullValue(<span class="keyword">true</span>)</span><br><span class="line">                    .setFieldValueEditor((fieldName, fieldValue) -&gt; fieldValue.toString()));</span><br><span class="line">    <span class="comment">// 7.3.å­˜å‚¨</span></span><br><span class="line">    <span class="built_in">String</span> tokenKey = LOGIN_USER_KEY + token;</span><br><span class="line">    stringRedisTemplate.opsForHash().putAll(tokenKey, userMap);</span><br><span class="line">    <span class="comment">// 7.4.è®¾ç½®tokenæœ‰æ•ˆæœŸ</span></span><br><span class="line">    stringRedisTemplate.expire(tokenKey, LOGIN_USER_TTL, TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 8.è¿”å›token</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(token);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨MvcConfigç±»ä¸Šæœ‰@Configurationæ³¨è§£ï¼Œè¯´æ˜æ˜¯ç”±Springæ¥è´Ÿè´£ä¾èµ–æ³¨å…¥ã€‚</p>
<p>åœ¨MvcConfigç±»ä¸­è¦ç¼–å†™å¦‚ä¸‹çš„ä»£ç ï¼š</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">StringRedisTemplate</span> stringRedisTemplate;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">addInterceptors</span>(<span class="params"><span class="title class_">InterceptorRegistry</span> registry</span>)&#123;</span><br><span class="line">        registry.<span class="title function_">addInterceptor</span>(<span class="keyword">new</span> <span class="title class_">LoginInterceptor</span>(stringRedisTemplate))</span><br><span class="line">                .<span class="title function_">excludePathPatterns</span>(</span><br><span class="line">                        <span class="string">&quot;/user/code&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/user/login&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/upload/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/blog/hot&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop-type/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/voucher/**&quot;</span></span><br><span class="line">                );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨utilsä¸‹çš„LoginInterceptorä¸­å†™å…¥å¦‚ä¸‹ä»£ç </p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginInterceptor</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object <span class="keyword">handler</span>)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//TODOï¼›1.è·å–è¯·æ±‚å¤´ä¸­çš„token</span></span><br><span class="line">        String token = request.getHeader(<span class="string">&quot;authorization&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(StrUtil.isBlank(token))&#123;</span><br><span class="line">            <span class="comment">//ä¸å­˜åœ¨ï¼Œæ‹¦æˆªï¼Œè¿”å›401çŠ¶æ€ç </span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//TODOï¼š2.åŸºäºTOKENè·å–redisçš„ç”¨æˆ·</span></span><br><span class="line">        Map&lt;Object, Object&gt; userMap = stringRedisTemplate.opsForHash().entries(LOGIN_USER_KEY + token);</span><br><span class="line">        <span class="comment">//åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span>(userMap.isEmpty())&#123;</span><br><span class="line">            <span class="comment">//ä¸å­˜åœ¨ï¼Œæ‹¦æˆªï¼Œè¿”å›401çŠ¶æ€ç </span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//TODOï¼š3.å°†æŸ¥è¯¢åˆ°çš„Hashæ•°æ®è½¬åŒ–ä¸ºUserDTOå¯¹è±¡</span></span><br><span class="line">        UserDTO userDTO = BeanUtil.fillBeanWithMap(userMap, <span class="keyword">new</span> UserDTO(), <span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">//TODOï¼š4.å­˜åœ¨ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯çš„ThreadLocal</span></span><br><span class="line">        UserHolder.saveUser(userDTO);</span><br><span class="line">        <span class="comment">//TODOï¼š5.åˆ·æ–°tokenæœ‰æ•ˆæœŸ</span></span><br><span class="line">        stringRedisTemplate.expire(LOGIN_USER_KEY + token,RedisConstants.LOGIN_USER_TTL, TimeUnit.MINUTES);</span><br><span class="line">        <span class="comment">//æ”¾è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object <span class="keyword">handler</span>, Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//ç§»é™¤ç”¨æˆ·</span></span><br><span class="line">        UserHolder.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ï¼šé¦–å…ˆæŠŠRediså’Œæ•°æ®åº“éƒ½å¯åŠ¨ã€‚ åŸå§‹çš„é¡¹ç›®çš„Redisçš„æœåŠ¡å™¨IDéœ€è¦æ›´æ”¹ä¸ºè‡ªå·±çš„ã€‚ç‚¹å‡»å‘é€éªŒè¯ç ï¼Œredisä¸­æœ‰è®°å½•ï¼Œæ²¡é—®é¢˜ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-61-1024x369.png" alt="img"></p>
<p>ä½†ç‚¹å‡»ç™»å½•çš„æ—¶å€™ä¼šæŠ¥ä¸€ä¸ªæ— æ³•å°†Longè½¬Stringçš„é”™è¯¯ã€‚å› ä¸ºç”¨çš„æ˜¯stringRedisTemplateè¦æ±‚æ‰€æœ‰çš„å­—æ®µéƒ½æ˜¯stringç±»å‹çš„ã€‚</p>
<p>éœ€è¦å¯¹UserServiceImplä¸­å¦‚ä¸‹çš„ä½ç½®è¿›è¡Œä¿®æ”¹ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-62-1024x471.png" alt="img"></p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt; userMap = BeanUtil.beanToMap(userDTO,<span class="keyword">new</span> HashMap&lt;&gt;(),</span><br><span class="line">        CopyOptions.create()</span><br><span class="line">                .setIgnoreNullValue(<span class="literal">true</span>)</span><br><span class="line">                .setFieldValueEditor<span class="function"><span class="params">((fieldName,fieldValue)-&gt;fieldValue.toString())</span>);</span></span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-63-1024x391.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-64-1024x249.png" alt="img"></p>
<h3 id="1-9-è§£å†³çŠ¶æ€ç™»å½•åˆ·æ–°é—®é¢˜">1.9 è§£å†³çŠ¶æ€ç™»å½•åˆ·æ–°é—®é¢˜</h3>
<h4 id="1-9-1-åˆå§‹æ–¹æ¡ˆæ€è·¯æ€»ç»“ï¼š">1.9.1 åˆå§‹æ–¹æ¡ˆæ€è·¯æ€»ç»“ï¼š</h4>
<p>åœ¨è¿™ä¸ªæ–¹æ¡ˆä¸­ï¼Œä»–ç¡®å®å¯ä»¥ä½¿ç”¨å¯¹åº”è·¯å¾„çš„æ‹¦æˆªï¼ŒåŒæ—¶åˆ·æ–°ç™»å½•tokenä»¤ç‰Œçš„å­˜æ´»æ—¶é—´ï¼Œä½†æ˜¯ç°åœ¨è¿™ä¸ªæ‹¦æˆªå™¨ä»–åªæ˜¯æ‹¦æˆªéœ€è¦è¢«æ‹¦æˆªçš„è·¯å¾„ï¼Œ<strong>å‡è®¾å½“å‰ç”¨æˆ·è®¿é—®äº†ä¸€äº›ä¸éœ€è¦æ‹¦æˆªçš„è·¯å¾„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ‹¦æˆªå™¨å°±ä¸ä¼šç”Ÿæ•ˆï¼Œæ‰€ä»¥æ­¤æ—¶ä»¤ç‰Œåˆ·æ–°çš„åŠ¨ä½œå®é™…ä¸Šå°±ä¸ä¼šæ‰§è¡Œ</strong>ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ¡ˆä»–æ˜¯å­˜åœ¨é—®é¢˜çš„</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-65-1024x571.png" alt="img"></p>
<h4 id="1-9-2-ä¼˜åŒ–æ–¹æ¡ˆ">1.9.2 ä¼˜åŒ–æ–¹æ¡ˆ</h4>
<p>æ—¢ç„¶ä¹‹å‰çš„æ‹¦æˆªå™¨æ— æ³•å¯¹ä¸éœ€è¦æ‹¦æˆªçš„è·¯å¾„ç”Ÿæ•ˆï¼Œ<strong>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œåœ¨ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨ä¸­æ‹¦æˆªæ‰€æœ‰çš„è·¯å¾„ï¼ŒæŠŠç¬¬äºŒä¸ªæ‹¦æˆªå™¨åšçš„äº‹æƒ…æ”¾å…¥åˆ°ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨ä¸­ï¼ŒåŒæ—¶åˆ·æ–°ä»¤ç‰Œ</strong>ï¼Œå› ä¸ºç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨æœ‰äº†threadLocalçš„æ•°æ®ï¼Œæ‰€ä»¥æ­¤æ—¶ç¬¬äºŒä¸ªæ‹¦æˆªå™¨åªéœ€è¦åˆ¤æ–­æ‹¦æˆªå™¨ä¸­çš„userå¯¹è±¡æ˜¯å¦å­˜åœ¨å³å¯ï¼Œå®Œæˆæ•´ä½“åˆ·æ–°åŠŸèƒ½ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-66-1024x507.png" alt="img"></p>
<h4 id="1-9-3-ä»£ç ">1.9.3 ä»£ç </h4>
<p>å¤åˆ¶LoginInterceptorå˜æˆä¸€ä»½æ–°çš„RefreshTokenInterceptorï¼ŒæŠŠä¸‹é¢å‡ å¤„åœ°æ–¹æ”¹ä¸ºreturn trueå³å¯ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-67-1024x725.png" alt="img"></p>
<p>LoginInterceptorçš„ä»£ç å˜æˆå¦‚ä¸‹ï¼š</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object <span class="keyword">handler</span>)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//1.åˆ¤æ–­æ˜¯å¦éœ€è¦æ‹¦æˆªï¼ˆThreadLocalä¸­æ˜¯å¦æœ‰ç”¨æˆ·ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span>(UserHolder.getUser()==<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="comment">//æ²¡æœ‰ï¼Œéœ€è¦æ‹¦æˆªï¼Œè®¾ç½®çŠ¶æ€ç </span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="comment">//æ‹¦æˆª</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ”¾è¡Œ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object <span class="keyword">handler</span>, Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//ç§»é™¤ç”¨æˆ·</span></span><br><span class="line">        UserHolder.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨è¿˜éœ€è¦åœ¨MvcConfigé‡Œé¢å¯¹æ‹¦æˆªå™¨è¿›è¡Œæ›´æ–°é…ç½®ï¼Œéœ€è¦ï¼ˆç”¨orderï¼‰è°ƒæ•´æ‹¦æˆªå™¨çš„æ‰§è¡Œé¡ºåºï¼š</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">StringRedisTemplate</span> stringRedisTemplate;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">addInterceptors</span>(<span class="params"><span class="title class_">InterceptorRegistry</span> registry</span>)&#123;</span><br><span class="line">        registry.<span class="title function_">addInterceptor</span>(<span class="keyword">new</span> <span class="title class_">LoginInterceptor</span>())</span><br><span class="line">                .<span class="title function_">excludePathPatterns</span>(</span><br><span class="line">                        <span class="string">&quot;/user/code&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/user/login&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/upload/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/blog/hot&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop-type/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/voucher/**&quot;</span></span><br><span class="line">                ).<span class="title function_">order</span>(<span class="number">1</span>);</span><br><span class="line">        registry.<span class="title function_">addInterceptor</span>(<span class="keyword">new</span> <span class="title class_">RefreshTokenInterceptor</span>(stringRedisTemplate))</span><br><span class="line">                .<span class="title function_">addPathPatterns</span>(<span class="string">&quot;/**&quot;</span>).<span class="title function_">order</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2ã€å•†æˆ·æŸ¥è¯¢ç¼“å­˜">2ã€å•†æˆ·æŸ¥è¯¢ç¼“å­˜</h2>
<h3 id="2-1ä»€ä¹ˆæ˜¯ç¼“å­˜">2.1ä»€ä¹ˆæ˜¯ç¼“å­˜</h3>
<p><strong>ç¼“å­˜(<strong>Cache),å°±æ˜¯æ•°æ®äº¤æ¢çš„</strong>ç¼“å†²åŒº</strong>,ä¿—ç§°çš„ç¼“å­˜å°±æ˜¯<strong>ç¼“å†²åŒºå†…çš„æ•°æ®</strong>,ä¸€èˆ¬ä»æ•°æ®åº“ä¸­è·å–,å­˜å‚¨äºæœ¬åœ°ä»£ç ä¸€èˆ¬<strong>è¯»å†™æ€§èƒ½è¾ƒé«˜</strong>ï¼Œ</p>
<p>ä¾‹å¦‚:</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ä¾‹<span class="number">1</span>:Static <span class="keyword">final</span> ConcurrentHashMap&lt;K,V&gt; map = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(); æœ¬åœ°ç”¨äºé«˜å¹¶å‘</span><br><span class="line"></span><br><span class="line">ä¾‹<span class="number">2</span>:<span class="type">static</span> <span class="keyword">final</span> Cache&lt;K,V&gt; USER_CACHE = CacheBuilder.<span class="built_in">newBuilder</span>().<span class="built_in">build</span>(); ç”¨äºredisç­‰ç¼“å­˜</span><br><span class="line"></span><br><span class="line">ä¾‹<span class="number">3</span>:Static <span class="keyword">final</span> Map&lt;K,V&gt; map =  <span class="keyword">new</span> <span class="built_in">HashMap</span>(); æœ¬åœ°ç¼“å­˜</span><br></pre></td></tr></table></figure>
<p>ç”±äºå…¶è¢«<strong>Static</strong>ä¿®é¥°,æ‰€ä»¥éšç€ç±»çš„åŠ è½½è€Œè¢«åŠ è½½åˆ°<strong>å†…å­˜ä¹‹ä¸­</strong>,ä½œä¸ºæœ¬åœ°ç¼“å­˜,ç”±äºå…¶åˆè¢«<strong>final</strong>ä¿®é¥°,æ‰€ä»¥å…¶å¼•ç”¨(ä¾‹3:map)å’Œå¯¹è±¡(ä¾‹3:new HashMap())ä¹‹é—´çš„å…³ç³»æ˜¯å›ºå®šçš„,ä¸èƒ½æ”¹å˜,å› æ­¤ä¸ç”¨æ‹…å¿ƒèµ‹å€¼(=)å¯¼è‡´ç¼“å­˜å¤±æ•ˆ;</p>
<p><strong>ç¼“å­˜ä½œç”¨</strong>ï¼šé™ä½åç«¯è´Ÿè½½ï¼›æé«˜è¯»å†™çš„æ•ˆç‡ï¼Œé™ä½å“åº”æ—¶é—´ã€‚</p>
<p><strong>ç¼“å­˜æˆæœ¬</strong>ï¼šæ•°æ®ä¸€è‡´æ€§æˆæœ¬ï¼ˆæ•°æ®åº“é‡Œçš„æ•°æ®å¦‚æœå‘ç”Ÿå˜åŒ–ï¼Œå®¹æ˜“ä¸ç¼“å­˜ä¸­çš„æ•°æ®å½¢æˆä¸ä¸€è‡´ï¼‰ã€‚ä»£ç ç»´æŠ¤æˆæœ¬é«˜ï¼ˆæ­å»ºé›†ç¾¤ï¼‰ã€‚è¿è¥æˆæœ¬é«˜ã€‚</p>
<p><strong>å¦‚ä½•ä½¿ç”¨ç¼“å­˜</strong></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-68-1024x432.png" alt="img"></p>
<h3 id="2-2-æ·»åŠ å•†æˆ·ç¼“å­˜">2.2 æ·»åŠ å•†æˆ·ç¼“å­˜</h3>
<p>æ ‡å‡†çš„æ“ä½œæ–¹å¼å°±æ˜¯æŸ¥è¯¢æ•°æ®åº“ä¹‹å‰å…ˆæŸ¥è¯¢ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜æ•°æ®å­˜åœ¨ï¼Œåˆ™ç›´æ¥ä»ç¼“å­˜ä¸­è¿”å›ï¼Œå¦‚æœç¼“å­˜æ•°æ®ä¸å­˜åœ¨ï¼Œå†æŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶åå°†æ•°æ®å­˜å…¥redisã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-77.png" alt="img"></p>
<p>åœ¨ShopControllerç±»çš„queryShopByIdæ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@GetMapping</span>(<span class="string">&quot;/&#123;id&#125;&quot;</span>)</span><br><span class="line">public Result <span class="built_in">queryShopById</span>(<span class="variable">@PathVariable</span>(<span class="string">&quot;id&quot;</span>) Long id) &#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">Result</span><span class="selector-class">.ok</span>(shopService.<span class="built_in">queryById</span>(id));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨IShopServiceæ¥å£ä¸­ç¼–å†™å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="symbol">IShopService</span> <span class="symbol">extends</span> <span class="symbol">IService</span>&lt;<span class="symbol">Shop</span>&gt; &#123;</span><br><span class="line">    Object queryById(Long id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ShopServiceImplç±»çš„queryByIdæ–¹æ³•ä¸­ç¼–å†™å…·ä½“ä»£ç ï¼š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ShopServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl&lt;ShopMapper</span>, <span class="title">Shop&gt;</span> <span class="title">implements</span> <span class="title">IShopService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">StringRedisTemplate</span> stringRedisTemplate;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public <span class="type">Object</span> queryById(<span class="type">Long</span> id) &#123;</span><br><span class="line">        <span class="type">String</span> key = <span class="type">CACHE_SHOP_KEY</span> + id;</span><br><span class="line">        <span class="comment">//1.ä»RedisæŸ¥è¯¢ç¼“å­˜</span></span><br><span class="line">        <span class="type">String</span> shopJson = stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="comment">//2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="type">StrUtil</span>.isNotBlank(shopJson))&#123;</span><br><span class="line">            <span class="comment">//3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="type">Shop</span> shop = <span class="type">JSONUtil</span>.toBean(shopJson, <span class="type">Shop</span>.<span class="keyword">class</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="type">Result</span>.ok(shop);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//4.ä¸å­˜åœ¨ï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">        <span class="type">Shop</span> shop = getById(id);</span><br><span class="line">        <span class="comment">//5.ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯</span></span><br><span class="line">        <span class="keyword">if</span>(shop==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="type">Result</span>.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨ï¼&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//6.å­˜åœ¨ï¼Œå†™å…¥Redis</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, <span class="type">JSONUtil</span>.toJsonStr(shop));</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Result</span>.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¸å¿ƒæ˜¯é€šè¿‡è°ƒç”¨hutoolå·¥å…·åŒ…ä¸­çš„JSONUtilç±»æ¥å®ç°å¯¹è±¡è½¬JSONï¼ˆæ–¹æ³•ï¼štoJsonStr(å¯¹è±¡)ï¼‰å’ŒJSONè½¬å¯¹è±¡ï¼ˆæ–¹æ³•ï¼štoBean(json,Beançš„ç±»å‹)ï¼‰</p>
<p>TODOï¼šå¯¹åˆ†ç±»è¿›è¡Œç¼“å­˜ã€‚</p>
<p>åœ¨ShopControllerç±»çš„queryShopByListæ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">&quot;list&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="function">Result <span class="title">queryTypeList</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//        List&lt;ShopType&gt; typeList = typeService</span></span><br><span class="line"><span class="comment">//                .query().orderByAsc(&quot;sort&quot;).list();</span></span><br><span class="line">        List&lt;ShopType&gt; typeList = typeService.queryTypeList();</span><br><span class="line">        <span class="function"><span class="keyword">return</span> Result.<span class="title">ok</span><span class="params">(typeList)</span></span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨IShopServiceæ¥å£ä¸­ç¼–å†™å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="symbol">IShopTypeService</span> <span class="symbol">extends</span> <span class="symbol">IService</span>&lt;<span class="symbol">ShopType</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;ShopType&gt; queryTypeList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ShopTypeServiceImplï¼š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ShopTypeServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl&lt;ShopTypeMapper</span>, <span class="title">ShopType&gt;</span> <span class="title">implements</span> <span class="title">IShopTypeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">StringRedisTemplate</span> stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public <span class="type">List</span>&lt;<span class="type">ShopType</span>&gt; queryTypeList() &#123;</span><br><span class="line">        <span class="type">String</span> key = <span class="string">&quot;login:type&quot;</span>;</span><br><span class="line"><span class="comment">//        SetOperations&lt;String, String&gt; setOps = redisTemplate.opsForSet();</span></span><br><span class="line">        <span class="comment">// 1. ä»redisæŸ¥è¯¢å•†é“ºç¼“å­˜</span></span><br><span class="line"><span class="comment">//        String shopTypeJson = setOps.members(key).toString();</span></span><br><span class="line">        <span class="type">String</span> shopTypeJson = stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="comment">// 2. åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="type">StrUtil</span>.isNotBlank(shopTypeJson)) &#123;</span><br><span class="line">            <span class="comment">// 3. å­˜åœ¨ï¼Œè½¬åŒ–ä¸ºListè¿”å›</span></span><br><span class="line"><span class="comment">//            return objectMapper.readValue(shopTypeJson, new TypeReference&lt;List&lt;ShopType&gt;&gt;()&#123;&#125;);</span></span><br><span class="line">            <span class="keyword">return</span> <span class="type">JSONUtil</span>.toList(shopTypeJson, <span class="type">ShopType</span>.<span class="keyword">class</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4. ä¸å­˜åœ¨ï¼ŒæŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">        <span class="type">List</span>&lt;<span class="type">ShopType</span>&gt; typeList = <span class="keyword">this</span>.query().orderByAsc(<span class="string">&quot;sort&quot;</span>).list();</span><br><span class="line">        <span class="comment">// 5. ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºåˆ—è¡¨</span></span><br><span class="line">        <span class="keyword">if</span> (typeList.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">ArrayList</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 6. å­˜åœ¨ï¼Œå†™å…¥redis</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, <span class="type">JSONUtil</span>.toJsonStr(typeList));</span><br><span class="line">        <span class="comment">// 7. è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> typeList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-3-ç¼“å­˜æ›´æ–°ç­–ç•¥">2.3 ç¼“å­˜æ›´æ–°ç­–ç•¥</h3>
<p>ç¼“å­˜æ›´æ–°æ˜¯<strong>redisä¸ºäº†èŠ‚çº¦å†…å­˜è€Œè®¾è®¡å‡ºæ¥çš„ä¸€ä¸ªä¸œè¥¿</strong>ï¼Œä¸»è¦æ˜¯å› ä¸ºå†…å­˜æ•°æ®å®è´µï¼Œå½“æˆ‘ä»¬å‘redisæ’å…¥å¤ªå¤šæ•°æ®ï¼Œæ­¤æ—¶å°±å¯èƒ½ä¼šå¯¼è‡´ç¼“å­˜ä¸­çš„æ•°æ®è¿‡å¤šï¼Œæ‰€ä»¥<strong>redisä¼šå¯¹éƒ¨åˆ†æ•°æ®è¿›è¡Œæ›´æ–°</strong>ï¼Œæˆ–è€…æŠŠä»–å«ä¸ºæ·˜æ±°æ›´åˆé€‚ã€‚</p>
<ul>
<li><strong>å†…å­˜æ·˜æ±°ï¼šredisè‡ªåŠ¨è¿›è¡Œ</strong>ï¼Œå½“rediså†…å­˜è¾¾åˆ°å’±ä»¬è®¾å®šçš„max-memeryçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨è§¦å‘æ·˜æ±°æœºåˆ¶ï¼Œæ·˜æ±°æ‰ä¸€äº›ä¸é‡è¦çš„æ•°æ®(å¯ä»¥è‡ªå·±è®¾ç½®ç­–ç•¥æ–¹å¼)</li>
<li>**è¶…æ—¶å‰”é™¤ï¼š**å½“æˆ‘ä»¬ç»™redisè®¾ç½®äº†è¿‡æœŸæ—¶é—´ttlä¹‹åï¼Œ<strong>redisä¼šå°†è¶…æ—¶çš„æ•°æ®è¿›è¡Œåˆ é™¤</strong>ï¼Œæ–¹ä¾¿å’±ä»¬ç»§ç»­ä½¿ç”¨ç¼“å­˜</li>
<li><strong>ä¸»åŠ¨æ›´æ–°ï¼š<strong>æˆ‘ä»¬å¯ä»¥</strong>æ‰‹åŠ¨è°ƒç”¨æ–¹æ³•</strong>æŠŠç¼“å­˜åˆ æ‰ï¼Œé€šå¸¸ç”¨äºè§£å†³ç¼“å­˜å’Œæ•°æ®åº“ä¸ä¸€è‡´é—®é¢˜</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-88.png" alt="img"></p>
<h4 id="2-3-1-æ•°æ®åº“ç¼“å­˜ä¸ä¸€è‡´è§£å†³æ–¹æ¡ˆï¼š">2.3.1 æ•°æ®åº“ç¼“å­˜ä¸ä¸€è‡´è§£å†³æ–¹æ¡ˆï¼š</h4>
<p><strong>ç¼“å­˜çš„æ•°æ®æºæ¥è‡ªäºæ•°æ®åº“</strong>,è€Œæ•°æ®åº“çš„<strong>æ•°æ®æ˜¯ä¼šå‘ç”Ÿå˜åŒ–çš„</strong>,å› æ­¤,å¦‚æœå½“æ•°æ®åº“ä¸­<strong>æ•°æ®å‘ç”Ÿå˜åŒ–,è€Œç¼“å­˜å´æ²¡æœ‰åŒæ­¥</strong>,æ­¤æ—¶å°±ä¼šæœ‰<strong>ä¸€è‡´æ€§é—®é¢˜å­˜åœ¨</strong>ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-89.png" alt="img"></p>
<h4 id="2-3-2-æ•°æ®åº“å’Œç¼“å­˜ä¸ä¸€è‡´é‡‡ç”¨ä»€ä¹ˆæ–¹æ¡ˆ">2.3.2 æ•°æ®åº“å’Œç¼“å­˜ä¸ä¸€è‡´é‡‡ç”¨ä»€ä¹ˆæ–¹æ¡ˆ</h4>
<p>é€‰æ‹©æ–¹æ¡ˆä¸€ï¼šä½†æ˜¯æ–¹æ¡ˆä¸€è°ƒç”¨è€…å¦‚ä½•å¤„ç†å‘¢ï¼Ÿè¿™é‡Œæœ‰å‡ ä¸ªé—®é¢˜æ“ä½œç¼“å­˜å’Œæ•°æ®åº“æ—¶æœ‰ä¸‰ä¸ªé—®é¢˜éœ€è¦è€ƒè™‘ï¼š</p>
<p>1.é€‰æ‹©åˆ é™¤ç¼“å­˜è¿˜æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ</p>
<ul>
<li>æ›´æ–°ç¼“å­˜ï¼šæ¯æ¬¡æ›´æ–°æ•°æ®åº“éƒ½ä¼šæ›´æ–°ç¼“å­˜ï¼Œæ— æ•ˆçš„å†™æ“ä½œæ¯”è¾ƒå¤šã€‚</li>
<li>åˆ é™¤ç¼“å­˜ï¼šæ›´æ–°æ•°æ®åº“æ—¶è®©ç¼“å­˜å¤±æ•ˆï¼ŒæŸ¥è¯¢æ—¶å†æ›´æ–°ç¼“å­˜ã€‚</li>
</ul>
<p>2.å¦‚ä½•ä¿è¯ç¼“å­˜ä¸æ•°æ®åº“çš„æ“ä½œçš„åŒæ—¶æˆåŠŸæˆ–å¤±è´¥ï¼Ÿ</p>
<ul>
<li>å•ä½“ç³»ç»Ÿï¼Œå°†ç¼“å­˜ä¸æ•°æ®åº“æ“ä½œæ”¾åœ¨ä¸€ä¸ªäº‹åŠ¡</li>
<li>åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œåˆ©ç”¨TCCç­‰åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆ</li>
</ul>
<p>3.å…ˆæ“ä½œç¼“å­˜è¿˜æ˜¯å…ˆæ“ä½œæ•°æ®åº“ï¼Ÿ</p>
<ul>
<li>å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ“ä½œæ•°æ®åº“</li>
<li>å…ˆæ“ä½œæ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜</li>
</ul>
<p>ç­”ï¼šæˆ‘ä»¬åº”å½“æ˜¯<strong>å…ˆæ“ä½œæ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜</strong>ï¼ŒåŸå› åœ¨äºï¼Œå¦‚æœä½ é€‰æ‹©ç¬¬ä¸€ç§æ–¹æ¡ˆï¼Œåœ¨ä¸¤ä¸ªçº¿ç¨‹å¹¶å‘æ¥è®¿é—®æ—¶ï¼Œå‡è®¾çº¿ç¨‹1å…ˆæ¥ï¼Œä»–å…ˆæŠŠç¼“å­˜åˆ äº†ï¼Œæ­¤æ—¶çº¿ç¨‹2è¿‡æ¥ï¼Œä»–æŸ¥è¯¢ç¼“å­˜æ•°æ®å¹¶ä¸å­˜åœ¨ï¼Œæ­¤æ—¶ä»–å†™å…¥ç¼“å­˜ï¼Œå½“ä»–å†™å…¥ç¼“å­˜åï¼Œçº¿ç¨‹1å†æ‰§è¡Œæ›´æ–°åŠ¨ä½œæ—¶ï¼Œå®é™…ä¸Šå†™å…¥çš„å°±æ˜¯æ—§çš„æ•°æ®ï¼Œæ–°çš„æ•°æ®è¢«æ—§æ•°æ®è¦†ç›–äº†ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-90.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-91.png" alt="img"></p>
<h3 id="2-4-å®ç°å•†é“ºå’Œç¼“å­˜ä¸æ•°æ®åº“åŒå†™ä¸€è‡´">2.4 å®ç°å•†é“ºå’Œç¼“å­˜ä¸æ•°æ®åº“åŒå†™ä¸€è‡´</h3>
<p>ç»™æŸ¥è¯¢å•†é“ºçš„ç¼“å­˜æ·»åŠ è¶…æ—¶å‰”é™¤å’Œä¸»åŠ¨æ›´æ–°çš„ç­–ç•¥ã€‚</p>
<p>ä¿®æ”¹ShopControllerä¸­çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ»¡è¶³ä¸‹é¢è¦æ±‚ï¼š</p>
<p>1.æ ¹æ®idæŸ¥è¯¢å•†é“ºæ—¶ï¼Œå¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå°†æ•°æ®åº“ç»“æœå†™å…¥ç¼“å­˜ï¼Œå¹¶è®¾ç½®è¶…æ—¶æ—¶é—´ã€‚</p>
<p>2.æ ¹æ®idä¿®æ”¹åº—é“ºæ—¶ï¼Œå…ˆä¿®æ”¹æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ã€‚</p>
<p>é¦–å…ˆä¿®æ”¹ShopServiceImplçš„redisè¿‡æœŸæ—¶é—´ï¼š</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stringRedisTemplate.opsForValue()<span class="meta">.set</span>(key, <span class="keyword">JSONUtil.toJsonStr(shop),CACHE_SHOP_TTL, </span>TimeUnit.MINUTES);</span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹ShopControllerä¸­çš„updateShopæ–¹æ³•ï¼š</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@PutMapping</span></span><br><span class="line">public Result <span class="built_in">updateShop</span>(<span class="variable">@RequestBody</span> Shop shop) &#123;</span><br><span class="line">    <span class="comment">// å†™å…¥æ•°æ®åº“</span></span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">Result</span><span class="selector-class">.ok</span>(shopService.<span class="built_in">update</span>(shop));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‘IShopServiceæ¥å£ä¸­æ·»åŠ updateæ–¹æ³•ï¼š</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable"><span class="class">Object</span></span> <span class="function"><span class="title">update</span>(<span class="variable">Shop</span> <span class="variable">shop</span>);</span></span><br></pre></td></tr></table></figure>
<p>å‘ShopServiceImplç±»ä¸­æ·»åŠ updateæ–¹æ³•ï¼š</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function">Object <span class="title">update</span><span class="params">(Shop shop)</span> </span>&#123;</span><br><span class="line">    Long id = shop.getId();</span><br><span class="line">    <span class="keyword">if</span>(id == <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;å•†é“ºidä¸å­˜åœ¨&quot;</span>)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    updateById(shop);</span><br><span class="line">    stringRedisTemplate.delete(CACHE_SHOP_KEY + id);</span><br><span class="line">    <span class="function"><span class="keyword">return</span> Result.<span class="title">ok</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ï¼šé¦–å…ˆåˆ é™¤ç¼“å­˜ä¸­çš„æ•°æ®ï¼Œç„¶åçœ‹SQLè¯­å¥æ˜¯å¦æ‰§è¡Œï¼Œæ˜¯å¦åŠ ä¸Šäº†TTLè¿‡æœŸæ—¶é—´ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-92.png" alt="img"></p>
<p>è®¿é—®http://localhost:8081/shopï¼Œç„¶åä¿®æ”¹101èŒ¶é¤å…ä¸º102èŒ¶é¤å…ï¼š</p>
<p>æ³¨æ„è¦å‘é€çš„æ˜¯PUTè¯·æ±‚ï¼Œè¯·æ±‚çš„å†…å®¹å¦‚ä¸‹ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-93.png" alt="img"></p>
<p>ç„¶åå»æ•°æ®åº“çœ‹æ˜¯å¦åç§°æ›´æ–°ä¸º102èŒ¶é¤å…ï¼Œç„¶åçœ‹ç¼“å­˜ä¸­çš„æ•°æ®æ˜¯å¦è¢«åˆ é™¤ï¼Œç”¨æˆ·åˆ·æ–°é¡µé¢çœ‹åˆ°102èŒ¶é¤å…ï¼Œç¼“å­˜ä¸­ä¼šæœ‰æœ€æ–°çš„æ•°æ®ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-94.png" alt="img"></p>
<h3 id="2-5-ç¼“å­˜ç©¿é€é—®é¢˜çš„è§£å†³æ€è·¯">2.5 ç¼“å­˜ç©¿é€é—®é¢˜çš„è§£å†³æ€è·¯</h3>
<p>ç¼“å­˜ç©¿é€ ï¼š<strong>ç¼“å­˜ç©¿é€æ˜¯æŒ‡å®¢æˆ·ç«¯è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜ä¸­å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œè¿™æ ·ç¼“å­˜æ°¸è¿œä¸ä¼šç”Ÿæ•ˆï¼Œè¿™äº›è¯·æ±‚éƒ½ä¼šæ‰“åˆ°æ•°æ®åº“ã€‚</strong></p>
<p>å¸¸è§çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>ç¼“å­˜ç©ºå¯¹è±¡</li>
<li>ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œç»´æŠ¤æ–¹ä¾¿</li>
<li>ç¼ºç‚¹ï¼š
<ul>
<li>é¢å¤–çš„å†…å­˜æ¶ˆè€—</li>
<li>å¯èƒ½é€ æˆçŸ­æœŸçš„ä¸ä¸€è‡´</li>
</ul>
</li>
<li>å¸ƒéš†è¿‡æ»¤</li>
<li>ä¼˜ç‚¹ï¼šå†…å­˜å ç”¨è¾ƒå°‘ï¼Œæ²¡æœ‰å¤šä½™key</li>
<li>ç¼ºç‚¹ï¼š
<ul>
<li>å®ç°å¤æ‚</li>
<li>å­˜åœ¨è¯¯åˆ¤å¯èƒ½</li>
</ul>
</li>
</ul>
<p>ç¼“å­˜ç©ºå¯¹è±¡ï¼š</p>
<p>å½“æˆ‘ä»¬å®¢æˆ·ç«¯è®¿é—®ä¸å­˜åœ¨çš„æ•°æ®æ—¶ï¼Œå…ˆè¯·æ±‚redisï¼Œä½†æ˜¯æ­¤æ—¶redisä¸­æ²¡æœ‰æ•°æ®ï¼Œæ­¤æ—¶ä¼šè®¿é—®åˆ°æ•°æ®åº“ï¼Œä½†æ˜¯æ•°æ®åº“ä¸­ä¹Ÿæ²¡æœ‰æ•°æ®ï¼Œè¿™ä¸ªæ•°æ®ç©¿é€äº†ç¼“å­˜ï¼Œç›´å‡»æ•°æ®åº“ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“æ•°æ®åº“èƒ½å¤Ÿæ‰¿è½½çš„å¹¶å‘ä¸å¦‚redisè¿™ä¹ˆé«˜ï¼Œå¦‚æœå¤§é‡çš„è¯·æ±‚åŒæ—¶è¿‡æ¥è®¿é—®è¿™ç§ä¸å­˜åœ¨çš„æ•°æ®ï¼Œè¿™äº›è¯·æ±‚å°±éƒ½ä¼šè®¿é—®åˆ°æ•°æ®åº“ï¼Œ<strong>ç®€å•çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯å“ªæ€•è¿™ä¸ªæ•°æ®åœ¨æ•°æ®åº“ä¸­ä¹Ÿä¸å­˜åœ¨ï¼Œæˆ‘ä»¬ä¹ŸæŠŠè¿™ä¸ªæ•°æ®å­˜å…¥åˆ°redisä¸­å»ï¼Œè¿™æ ·ï¼Œä¸‹æ¬¡ç”¨æˆ·è¿‡æ¥è®¿é—®è¿™ä¸ªä¸å­˜åœ¨çš„æ•°æ®ï¼Œé‚£ä¹ˆåœ¨redisä¸­ä¹Ÿèƒ½æ‰¾åˆ°è¿™ä¸ªæ•°æ®å°±ä¸ä¼šè¿›å…¥åˆ°ç¼“å­˜äº†</strong></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-95.png" alt="img"></p>
<p>å¸ƒéš†è¿‡æ»¤ï¼š</p>
<p>å¸ƒéš†è¿‡æ»¤å™¨å…¶å®é‡‡ç”¨çš„æ˜¯<strong>å“ˆå¸Œæ€æƒ³</strong>æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé€šè¿‡ä¸€ä¸ªåºå¤§çš„äºŒè¿›åˆ¶æ•°ç»„ï¼Œèµ°å“ˆå¸Œæ€æƒ³å»åˆ¤æ–­å½“å‰è¿™ä¸ªè¦æŸ¥è¯¢çš„è¿™ä¸ªæ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­å­˜åœ¨ï¼Œåˆ™æ”¾è¡Œï¼Œè¿™ä¸ªè¯·æ±‚ä¼šå»è®¿é—®redisï¼Œå“ªæ€•æ­¤æ—¶redisä¸­çš„æ•°æ®è¿‡æœŸäº†ï¼Œä½†æ˜¯æ•°æ®åº“ä¸­ä¸€å®šå­˜åœ¨è¿™ä¸ªæ•°æ®ï¼Œåœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæ¥è¿™ä¸ªæ•°æ®åï¼Œå†å°†å…¶æ”¾å…¥åˆ°redisä¸­ï¼Œ</p>
<p>å‡è®¾å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­è¿™ä¸ªæ•°æ®ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›</p>
<p>è¿™ç§æ–¹å¼<strong>ä¼˜ç‚¹åœ¨äºèŠ‚çº¦å†…å­˜ç©ºé—´</strong>ï¼Œ<strong>ç¼ºç‚¹æ˜¯å­˜åœ¨è¯¯åˆ¤</strong>ï¼Œè¯¯åˆ¤åŸå› åœ¨äºï¼š<strong>å¸ƒéš†è¿‡æ»¤å™¨èµ°çš„æ˜¯å“ˆå¸Œæ€æƒ³ï¼Œåªè¦å“ˆå¸Œæ€æƒ³ï¼Œå°±å¯èƒ½å­˜åœ¨å“ˆå¸Œå†²çª</strong></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-96.png" alt="img"></p>
<h3 id="2-6-ç¼–ç è§£å†³å•†å“æŸ¥è¯¢çš„ç¼“å­˜ç©¿é€é—®é¢˜ï¼š">2.6 ç¼–ç è§£å†³å•†å“æŸ¥è¯¢çš„ç¼“å­˜ç©¿é€é—®é¢˜ï¼š</h3>
<p>ä¸‹å›¾æ˜¯åŸå§‹çš„ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-97.png" alt="img"></p>
<p>åœ¨åŸæ¥çš„é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬å¦‚æœå‘ç°è¿™ä¸ªæ•°æ®åœ¨mysqlä¸­ä¸å­˜åœ¨ï¼Œç›´æ¥å°±è¿”å›404äº†ï¼Œ<strong>è¿™æ ·æ˜¯ä¼šå­˜åœ¨ç¼“å­˜ç©¿é€é—®é¢˜çš„</strong></p>
<p>æ›´æ”¹åçš„æ–¹æ¡ˆï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-98.png" alt="img"></p>
<p>å¦‚æœè¿™ä¸ªæ•°æ®ä¸å­˜åœ¨ï¼Œæˆ‘ä»¬ä¸ä¼šè¿”å›404 ï¼Œè¿˜æ˜¯<strong>ä¼šæŠŠè¿™ä¸ªæ•°æ®å†™å…¥åˆ°Redisä¸­ï¼Œå¹¶ä¸”å°†valueè®¾ç½®ä¸ºç©º</strong>ï¼Œå½“å†æ¬¡å‘èµ·æŸ¥è¯¢æ—¶ï¼Œæˆ‘ä»¬å¦‚æœå‘ç°å‘½ä¸­ä¹‹åï¼Œ<strong>åˆ¤æ–­è¿™ä¸ªvalueæ˜¯å¦æ˜¯nullï¼Œå¦‚æœæ˜¯nullï¼Œåˆ™æ˜¯ä¹‹å‰å†™å…¥çš„æ•°æ®ï¼Œè¯æ˜æ˜¯ç¼“å­˜ç©¿é€æ•°æ®ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ç›´æ¥è¿”å›æ•°æ®ã€‚</strong></p>
<p>åœ¨ShopServiceImplç±»é‡Œå¯¹queryByIdæ–¹æ³•è¿›è¡Œä¿®æ”¹ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object queryById(<span class="built_in">Long</span> id) &#123;</span><br><span class="line">    String key = CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="comment">//1.ä»RedisæŸ¥è¯¢ç¼“å­˜</span></span><br><span class="line">    String shopJson = stringRedisTemplate.opsForValue().<span class="keyword">get</span>(key);</span><br><span class="line">    <span class="comment">//2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span>(StrUtil.isNotBlank(shopJson))&#123;</span><br><span class="line">        <span class="comment">//3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        Shop shop = JSONUtil.toBean(shopJson, Shop.<span class="keyword">class</span>);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä¸Šé¢æ˜¯æœ‰å€¼çš„æƒ…å†µï¼Œä¸‹é¢æ˜¯æ— å€¼çš„2ç§æƒ…å†µï¼šAï¼šç©ºå­—ç¬¦ä¸²ã€‚Bï¼šnullã€‚</span></span><br><span class="line">    <span class="keyword">if</span>(shopJson != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¿¡æ¯ä¸å­˜åœ¨ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4.ä¸å­˜åœ¨ï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">    Shop shop = getById(id);</span><br><span class="line">    <span class="comment">//5.ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯</span></span><br><span class="line">    <span class="keyword">if</span>(shop==<span class="literal">null</span>)&#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().<span class="keyword">set</span>(key,<span class="string">&quot;&quot;</span>,CACHE_NULL_TTL,TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6.å­˜åœ¨ï¼Œå†™å…¥Redis</span></span><br><span class="line">    stringRedisTemplate.opsForValue().<span class="keyword">set</span>(key, JSONUtil.toJsonStr(shop),CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ï¼š</p>
<p>localhost:8080/api/shop/1æ­¤æ—¶æ˜¯å‘½ä¸­æ•°æ®ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-99.png" alt="img"></p>
<p>localhost:8080/api/shop/0æ­¤æ—¶æœªå‘½ä¸­æ•°æ®ã€‚æ‰“å¼€ç¼“å­˜å¯ä»¥çœ‹åˆ°ç¼“å­˜çš„æ˜¯ç©ºï¼Œå¹¶ä¸”TTLæ˜¯200ç§’</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-100.png" alt="img"></p>
<p><strong>å°æ€»ç»“ï¼š</strong></p>
<p>1.ç¼“å­˜ç©¿é€äº§ç”Ÿçš„åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>ç­”ï¼š<strong>ç”¨æˆ·è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜ä¸­å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ï¼Œä¸æ–­å‘èµ·è¿™æ ·çš„è¯·æ±‚ï¼Œç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§å‹åŠ›</strong></p>
<p>2.ç¼“å­˜ç©¿é€çš„è§£å†³æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿ</p>
<p>ç­”ï¼š</p>
<ul>
<li>ç¼“å­˜nullå€¼</li>
<li>å¸ƒéš†è¿‡æ»¤</li>
<li>å¢å¼ºidçš„å¤æ‚åº¦ï¼Œé¿å…è¢«çŒœæµ‹idè§„å¾‹</li>
<li>åšå¥½æ•°æ®çš„åŸºç¡€æ ¼å¼æ ¡éªŒ</li>
<li>åŠ å¼ºç”¨æˆ·æƒé™æ ¡éªŒ</li>
<li>åšå¥½çƒ­ç‚¹å‚æ•°çš„é™æµ</li>
</ul>
<h3 id="2-7-ç¼“å­˜é›ªå´©é—®é¢˜åŠè§£å†³æ€è·¯">2.7 ç¼“å­˜é›ªå´©é—®é¢˜åŠè§£å†³æ€è·¯</h3>
<p>1.ä»€ä¹ˆæ˜¯ç¼“å­˜é›ªå´©ï¼Ÿ</p>
<p>ç­”ï¼š<strong>ç¼“å­˜é›ªå´©æ˜¯æŒ‡åœ¨åŒä¸€æ—¶æ®µå¤§é‡çš„ç¼“å­˜keyåŒæ—¶å¤±æ•ˆæˆ–è€…RedisæœåŠ¡å®•æœºï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚åˆ°è¾¾æ•°æ®åº“ï¼Œå¸¦æ¥å·¨å¤§å‹åŠ›ã€‚</strong></p>
<p>2.ç¼“å­˜é›ªå´©çš„è§£å†³æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿ</p>
<p>ç­”ï¼š</p>
<ul>
<li>ç»™ä¸šåŠ¡æ·»åŠ å¤šçº§ç¼“å­˜</li>
<li>ç»™ä¸åŒçš„Keyçš„TTLæ·»åŠ éšæœºå€¼ï¼ˆè§£å†³å¤§é‡ç¼“å­˜keyåŒæ—¶å¤±æ•ˆï¼‰</li>
<li>åˆ©ç”¨Redisé›†ç¾¤æé«˜æœåŠ¡çš„å¯ç”¨æ€§ï¼ˆè§£å†³Rediså®•æœºï¼‰</li>
<li>ç»™ç¼“å­˜ä¸šåŠ¡æ·»åŠ é™çº§é™æµç­–ç•¥</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-102.png" alt="img"></p>
<h3 id="2-8-ç¼“å­˜å‡»ç©¿é—®é¢˜åŠè§£å†³æ€è·¯">2.8 ç¼“å­˜å‡»ç©¿é—®é¢˜åŠè§£å†³æ€è·¯</h3>
<p>1.ä»€ä¹ˆæ˜¯ç¼“å­˜å‡»ç©¿ï¼Ÿ</p>
<p>ç­”ï¼šç¼“å­˜å‡»ç©¿é—®é¢˜ä¹Ÿå«çƒ­ç‚¹Keyé—®é¢˜ï¼Œ<strong>å°±æ˜¯ä¸€ä¸ªè¢«é«˜å¹¶å‘è®¿é—®å¹¶ä¸”ç¼“å­˜é‡å»ºä¸šåŠ¡è¾ƒå¤æ‚çš„keyçªç„¶å¤±æ•ˆäº†ï¼Œæ— æ•°çš„è¯·æ±‚è®¿é—®ä¼šåœ¨ç¬é—´ç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§çš„å†²å‡»ã€‚</strong></p>
<p>2.ç¼“å­˜å‡»ç©¿çš„è§£å†³æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿ</p>
<p>ç­”ï¼šå¸¸è§çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§</p>
<ul>
<li>äº’æ–¥é”</li>
<li>é€»è¾‘è¿‡æœŸ</li>
</ul>
<p>åˆ†æï¼šå‡è®¾çº¿ç¨‹1åœ¨æŸ¥è¯¢ç¼“å­˜ä¹‹åï¼Œæœ¬æ¥åº”è¯¥å»æŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶åæŠŠè¿™ä¸ªæ•°æ®é‡æ–°åŠ è½½åˆ°ç¼“å­˜çš„ï¼Œæ­¤æ—¶åªè¦çº¿ç¨‹1èµ°å®Œè¿™ä¸ªé€»è¾‘ï¼Œå…¶ä»–çº¿ç¨‹å°±éƒ½èƒ½ä»ç¼“å­˜ä¸­åŠ è½½è¿™äº›æ•°æ®äº†ï¼Œä½†æ˜¯å‡è®¾åœ¨çº¿ç¨‹1æ²¡æœ‰èµ°å®Œçš„æ—¶å€™ï¼Œåç»­çš„çº¿ç¨‹2ï¼Œçº¿ç¨‹3ï¼Œçº¿ç¨‹4åŒæ—¶è¿‡æ¥è®¿é—®å½“å‰è¿™ä¸ªæ–¹æ³•ï¼Œ é‚£ä¹ˆè¿™äº›çº¿ç¨‹éƒ½ä¸èƒ½ä»ç¼“å­˜ä¸­æŸ¥è¯¢åˆ°æ•°æ®ï¼Œé‚£ä¹ˆä»–ä»¬å°±ä¼šåŒä¸€æ—¶åˆ»æ¥è®¿é—®æŸ¥è¯¢ç¼“å­˜ï¼Œéƒ½æ²¡æŸ¥åˆ°ï¼Œæ¥ç€åŒä¸€æ—¶é—´å»è®¿é—®æ•°æ®åº“ï¼ŒåŒæ—¶çš„å»æ‰§è¡Œæ•°æ®åº“ä»£ç ï¼Œå¯¹æ•°æ®åº“è®¿é—®å‹åŠ›è¿‡å¤§</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-103.png" alt="img"></p>
<p><strong>è§£å†³æ–¹æ¡ˆä¸€  ä½¿ç”¨é”äº’æ–¥é”æ¥è§£å†³ï¼š</strong></p>
<p>æˆ‘ä»¬å¯ä»¥é‡‡ç”¨tryLockæ–¹æ³• + double checkæ¥è§£å†³è¿™æ ·çš„é—®é¢˜ã€‚</p>
<p>åˆ†æï¼šå‡è®¾ç°åœ¨çº¿ç¨‹1è¿‡æ¥è®¿é—®ï¼Œä»–æŸ¥è¯¢ç¼“å­˜æ²¡æœ‰å‘½ä¸­ï¼Œä½†æ˜¯æ­¤æ—¶ä»–è·å¾—åˆ°äº†é”çš„èµ„æºï¼Œé‚£ä¹ˆçº¿ç¨‹1å°±ä¼šä¸€ä¸ªäººå»æ‰§è¡Œé€»è¾‘ï¼Œå‡è®¾ç°åœ¨çº¿ç¨‹2è¿‡æ¥ï¼Œçº¿ç¨‹2åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¹¶æ²¡æœ‰è·å¾—åˆ°é”ï¼Œé‚£ä¹ˆçº¿ç¨‹2å°±å¯ä»¥è¿›è¡Œåˆ°ä¼‘çœ ï¼Œç›´åˆ°çº¿ç¨‹1æŠŠé”é‡Šæ”¾åï¼Œçº¿ç¨‹2è·å¾—åˆ°é”ï¼Œç„¶åå†æ¥æ‰§è¡Œé€»è¾‘ï¼Œæ­¤æ—¶å°±èƒ½å¤Ÿä»ç¼“å­˜ä¸­æ‹¿åˆ°æ•°æ®äº†ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-104.png" alt="img"></p>
<p><strong>è§£å†³æ–¹æ¡ˆäºŒ é€»è¾‘è¿‡æœŸæ–¹æ¡ˆ</strong></p>
<p>æ–¹æ¡ˆåˆ†æï¼šæˆ‘ä»¬ä¹‹æ‰€ä»¥ä¼šå‡ºç°è¿™ä¸ªç¼“å­˜å‡»ç©¿é—®é¢˜ï¼Œä¸»è¦åŸå› æ˜¯åœ¨äºæˆ‘ä»¬å¯¹keyè®¾ç½®äº†è¿‡æœŸæ—¶é—´ï¼Œå‡è®¾æˆ‘ä»¬ä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå…¶å®å°±ä¸ä¼šæœ‰ç¼“å­˜å‡»ç©¿çš„é—®é¢˜ï¼Œä½†æ˜¯ä¸è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·æ•°æ®ä¸å°±ä¸€ç›´å ç”¨æˆ‘ä»¬å†…å­˜äº†å—ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨é€»è¾‘è¿‡æœŸæ–¹æ¡ˆã€‚</p>
<p>æˆ‘ä»¬æŠŠè¿‡æœŸæ—¶é—´è®¾ç½®åœ¨ redisçš„valueä¸­ï¼Œæ³¨æ„ï¼š<strong>è¿™ä¸ªè¿‡æœŸæ—¶é—´å¹¶ä¸ä¼šç›´æ¥ä½œç”¨äºredisï¼Œè€Œæ˜¯æˆ‘ä»¬åç»­é€šè¿‡é€»è¾‘å»å¤„ç†</strong>ã€‚å‡è®¾çº¿ç¨‹1å»æŸ¥è¯¢ç¼“å­˜ï¼Œç„¶åä»valueä¸­åˆ¤æ–­å‡ºæ¥å½“å‰çš„æ•°æ®å·²ç»è¿‡æœŸäº†ï¼Œæ­¤æ—¶çº¿ç¨‹1å»è·å¾—äº’æ–¥é”ï¼Œé‚£ä¹ˆå…¶ä»–çº¿ç¨‹ä¼šè¿›è¡Œé˜»å¡ï¼Œè·å¾—äº†é”çš„çº¿ç¨‹ä»–ä¼šå¼€å¯ä¸€ä¸ª çº¿ç¨‹å»è¿›è¡Œ ä»¥å‰çš„é‡æ„æ•°æ®çš„é€»è¾‘ï¼Œç›´åˆ°æ–°å¼€çš„çº¿ç¨‹å®Œæˆè¿™ä¸ªé€»è¾‘åï¼Œæ‰é‡Šæ”¾é”ï¼Œ è€Œçº¿ç¨‹1ç›´æ¥è¿›è¡Œè¿”å›ï¼Œå‡è®¾ç°åœ¨çº¿ç¨‹3è¿‡æ¥è®¿é—®ï¼Œç”±äºçº¿ç¨‹çº¿ç¨‹2æŒæœ‰ç€é”ï¼Œæ‰€ä»¥çº¿ç¨‹3æ— æ³•è·å¾—é”ï¼Œçº¿ç¨‹3ä¹Ÿç›´æ¥è¿”å›æ•°æ®ï¼Œåªæœ‰ç­‰åˆ°æ–°å¼€çš„çº¿ç¨‹2æŠŠé‡å»ºæ•°æ®æ„å»ºå®Œåï¼Œå…¶ä»–çº¿ç¨‹æ‰èƒ½èµ°è¿”å›æ­£ç¡®çš„æ•°æ®ã€‚</p>
<p>è¿™ç§æ–¹æ¡ˆå·§å¦™åœ¨äºï¼Œå¼‚æ­¥çš„æ„å»ºç¼“å­˜ï¼Œç¼ºç‚¹åœ¨äºåœ¨æ„å»ºå®Œç¼“å­˜ä¹‹å‰ï¼Œè¿”å›çš„éƒ½æ˜¯è„æ•°æ®ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-105.png" alt="img"></p>
<p>è¿›è¡Œå¯¹æ¯”</p>
<p><strong>äº’æ–¥é”æ–¹æ¡ˆï¼š<strong>ç”±äº</strong>ä¿è¯äº†äº’æ–¥æ€§ï¼Œæ‰€ä»¥æ•°æ®ä¸€è‡´</strong>ï¼Œä¸”å®ç°ç®€å•ï¼Œå› ä¸ºä»…ä»…åªéœ€è¦åŠ ä¸€æŠŠé”è€Œå·²ï¼Œä¹Ÿæ²¡å…¶ä»–çš„äº‹æƒ…éœ€è¦æ“å¿ƒï¼Œæ‰€ä»¥<strong>æ²¡æœ‰é¢å¤–çš„å†…å­˜æ¶ˆè€—</strong>ï¼Œç¼ºç‚¹åœ¨äºæœ‰é”å°±æœ‰<strong>æ­»é”é—®é¢˜çš„å‘ç”Ÿ</strong>ï¼Œä¸”<strong>åªèƒ½ä¸²è¡Œæ‰§è¡Œ</strong>æ€§èƒ½è‚¯å®šå—åˆ°å½±å“</p>
<p><strong>é€»è¾‘è¿‡æœŸæ–¹æ¡ˆï¼š</strong> çº¿ç¨‹è¯»å–è¿‡ç¨‹ä¸­ä¸éœ€è¦ç­‰å¾…ï¼Œ<strong>æ€§èƒ½å¥½ï¼Œæœ‰ä¸€ä¸ªé¢å¤–çš„çº¿ç¨‹æŒæœ‰é”å»è¿›è¡Œé‡æ„æ•°æ®</strong>ï¼Œ<strong>ä½†æ˜¯åœ¨é‡æ„æ•°æ®å®Œæˆå‰ï¼Œå…¶ä»–çš„çº¿ç¨‹åªèƒ½è¿”å›ä¹‹å‰çš„æ•°æ®</strong>ï¼Œä¸”å®ç°èµ·æ¥éº»çƒ¦</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-106.png" alt="img"></p>
<h3 id="2-9-åˆ©ç”¨äº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜">2.9 åˆ©ç”¨äº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</h3>
<p>æ€è·¯ï¼šç›¸è¾ƒäºåŸæ¥ä»ç¼“å­˜ä¸­æŸ¥è¯¢ä¸åˆ°æ•°æ®åç›´æ¥æŸ¥è¯¢æ•°æ®åº“è€Œè¨€ï¼Œç°åœ¨çš„æ–¹æ¡ˆæ˜¯è¿›è¡ŒæŸ¥è¯¢ä¹‹åï¼Œå¦‚æœä»ç¼“å­˜æ²¡æœ‰æŸ¥è¯¢åˆ°æ•°æ®ï¼Œåˆ™è¿›è¡Œäº’æ–¥é”çš„è·å–ï¼Œè·å–äº’æ–¥é”åï¼Œåˆ¤æ–­æ˜¯å¦è·å¾—åˆ°äº†é”ï¼Œå¦‚æœæ²¡æœ‰è·å¾—åˆ°ï¼Œåˆ™ä¼‘çœ ï¼Œè¿‡ä¸€ä¼šå†è¿›è¡Œå°è¯•ï¼Œç›´åˆ°è·å–åˆ°é”ä¸ºæ­¢ï¼Œæ‰èƒ½è¿›è¡ŒæŸ¥è¯¢</p>
<p>å¦‚æœè·å–åˆ°äº†é”çš„çº¿ç¨‹ï¼Œå†å»è¿›è¡ŒæŸ¥è¯¢ï¼ŒæŸ¥è¯¢åå°†æ•°æ®å†™å…¥redisï¼Œå†é‡Šæ”¾é”ï¼Œè¿”å›æ•°æ®ï¼Œåˆ©ç”¨äº’æ–¥é”å°±èƒ½ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œæ“ä½œæ•°æ®åº“çš„é€»è¾‘ï¼Œé˜²æ­¢ç¼“å­˜å‡»ç©¿</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-107.png" alt="img"></p>
<p><strong>æ“ä½œé”çš„ä»£ç ï¼š</strong></p>
<p>æ ¸å¿ƒæ€è·¯å°±æ˜¯åˆ©ç”¨redisçš„setnxæ–¹æ³•æ¥è¡¨ç¤ºè·å–é”ï¼Œè¯¥æ–¹æ³•å«ä¹‰æ˜¯redisä¸­å¦‚æœæ²¡æœ‰è¿™ä¸ªkeyï¼Œåˆ™æ’å…¥æˆåŠŸï¼Œè¿”å›1ï¼Œåœ¨stringRedisTemplateä¸­è¿”å›trueï¼Œ å¦‚æœæœ‰è¿™ä¸ªkeyåˆ™æ’å…¥å¤±è´¥ï¼Œåˆ™è¿”å›0ï¼Œåœ¨stringRedisTemplateè¿”å›falseï¼Œ<strong>æˆ‘ä»¬å¯ä»¥é€šè¿‡trueï¼Œæˆ–è€…æ˜¯falseï¼Œæ¥è¡¨ç¤ºæ˜¯å¦æœ‰çº¿ç¨‹æˆåŠŸæ’å…¥keyï¼ŒæˆåŠŸæ’å…¥çš„keyçš„çº¿ç¨‹æˆ‘ä»¬è®¤ä¸ºä»–å°±æ˜¯è·å¾—åˆ°é”çš„çº¿ç¨‹</strong>ã€‚</p>
<p>åœ¨ShopServiceImplç±»ä¸­å®šä¹‰ä¸€ä¸ªtryLockæ–¹æ³•ï¼ˆåœ¨Redisä¸­çš„setnxç›¸å½“äºsetIfAbsentæ–¹æ³•ã€‚ï¼‰</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">boolean</span> <span class="title function_">tryLock</span>(<span class="params"><span class="title class_">String</span> key</span>)&#123;</span><br><span class="line">    <span class="title class_">Boolean</span> flag = stringRedisTemplate.<span class="title function_">opsForValue</span>().<span class="title function_">setIfAbsent</span>(key, <span class="string">&quot;1&quot;</span>, <span class="number">10</span>, <span class="title class_">TimeUnit</span>.<span class="property">SECONDS</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">BooleanUtil</span>.<span class="title function_">isTrue</span>(flag);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ShopServiceImplç±»ä¸­å®šä¹‰ä¸€ä¸ªunLockæ–¹æ³•ç”¨äºè§£é”ã€‚</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unLock</span>(<span class="built_in">String</span> <span class="built_in">key</span>)&#123;</span><br><span class="line">    stringRedisTemplate.<span class="property">delete</span>(<span class="built_in">key</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ShopServiceImplç±»ä¸­å®šä¹‰ä¸€ä¸ªqueryWithPassThroughæ–¹æ³•ã€‚</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Shop queryWithPassThrough(<span class="built_in">Long</span> id)&#123;</span><br><span class="line">    String key = CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="comment">//1.ä»RedisæŸ¥è¯¢ç¼“å­˜</span></span><br><span class="line">    String shopJson = stringRedisTemplate.opsForValue().<span class="keyword">get</span>(key);</span><br><span class="line">    <span class="comment">//2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span>(StrUtil.isNotBlank(shopJson))&#123;</span><br><span class="line">        <span class="comment">//3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        Shop shop = JSONUtil.toBean(shopJson, Shop.<span class="keyword">class</span>);</span><br><span class="line">        <span class="keyword">return</span> shop;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä¸Šé¢æ˜¯æœ‰å€¼çš„æƒ…å†µï¼Œä¸‹é¢æ˜¯æ— å€¼çš„2ç§æƒ…å†µï¼šAï¼šç©ºå­—ç¬¦ä¸²ã€‚Bï¼šnullã€‚</span></span><br><span class="line">    <span class="keyword">if</span>(shopJson != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4.ä¸å­˜åœ¨ï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">    Shop shop = getById(id);</span><br><span class="line">    <span class="comment">//5.ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯</span></span><br><span class="line">    <span class="keyword">if</span>(shop==<span class="literal">null</span>)&#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().<span class="keyword">set</span>(key,<span class="string">&quot;&quot;</span>,CACHE_NULL_TTL,TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6.å­˜åœ¨ï¼Œå†™å…¥Redis</span></span><br><span class="line">    stringRedisTemplate.opsForValue().<span class="keyword">set</span>(key, JSONUtil.toJsonStr(shop),CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    <span class="keyword">return</span> shop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ShopServiceImplç±»ä¸­å®šä¹‰ä¸€ä¸ªqueryWithMutexæ–¹æ³•ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Shop queryWithMutex(<span class="built_in">Long</span> id)&#123;</span><br><span class="line">    String key = CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="comment">//1.ä»RedisæŸ¥è¯¢ç¼“å­˜</span></span><br><span class="line">    String shopJson = stringRedisTemplate.opsForValue().<span class="keyword">get</span>(key);</span><br><span class="line">    <span class="comment">//2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span>(StrUtil.isNotBlank(shopJson))&#123;</span><br><span class="line">        <span class="comment">//3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        Shop shop = JSONUtil.toBean(shopJson, Shop.<span class="keyword">class</span>);</span><br><span class="line">        <span class="keyword">return</span> shop;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä¸Šé¢æ˜¯æœ‰å€¼çš„æƒ…å†µï¼Œä¸‹é¢æ˜¯æ— å€¼çš„2ç§æƒ…å†µï¼šAï¼šç©ºå­—ç¬¦ä¸²ã€‚Bï¼šnullã€‚</span></span><br><span class="line">    <span class="keyword">if</span>(shopJson != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4.å®ç°ç¼“å­˜é‡å»º</span></span><br><span class="line">    <span class="comment">//4.1 è·å–äº’æ–¥é”</span></span><br><span class="line">    String lockKey = LOCK_SHOP_KEY+id;</span><br><span class="line">    Shop shop = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        boolean isLock = tryLock(lockKey);</span><br><span class="line">        <span class="comment">//4.2 åˆ¤æ–­æ˜¯å¦è·å–æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span>(!isLock)&#123;</span><br><span class="line">            <span class="comment">//4.3 å¤±è´¥ï¼Œåˆ™ä¼‘çœ å¹¶é‡è¯•</span></span><br><span class="line">            Thread.sleep(<span class="number">50</span>);</span><br><span class="line">            <span class="keyword">return</span> queryWithMutex(id);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//4.4 è·å–äº’æ–¥é”æˆåŠŸï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">        shop = getById(id);</span><br><span class="line">        <span class="comment">//æ¨¡æ‹Ÿé‡å»ºçš„å»¶æ—¶</span></span><br><span class="line">        Thread.sleep(<span class="number">200</span>);</span><br><span class="line">        <span class="comment">//5.æ•°æ®åº“æŸ¥è¯¢å¤±è´¥ï¼Œè¿”å›é”™è¯¯</span></span><br><span class="line">        <span class="keyword">if</span>(shop==<span class="literal">null</span>)&#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().<span class="keyword">set</span>(key,<span class="string">&quot;&quot;</span>,CACHE_NULL_TTL,TimeUnit.MINUTES);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//6.å­˜åœ¨ï¼Œå†™å…¥Redis</span></span><br><span class="line">        stringRedisTemplate.opsForValue().<span class="keyword">set</span>(key, JSONUtil.toJsonStr(shop),CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> new RuntimeException(e);</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//7.é‡Šæ”¾äº’æ–¥é”</span></span><br><span class="line">        unLock(lockKey);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//8.è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> shop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ShopServiceImplç±»ä¸­ä¿®æ”¹queryByIdï¼Œè°ƒç”¨queryWithMutexï¼š</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title class_">Object</span> <span class="title function_">queryById</span>(<span class="params"><span class="title class_">Long</span> id</span>) &#123;</span><br><span class="line">    <span class="comment">//ç¼“å­˜ç©¿é€</span></span><br><span class="line">    <span class="comment">//Shop shop = queryWithPassThrough(id);</span></span><br><span class="line">    <span class="comment">//äº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿</span></span><br><span class="line">    <span class="title class_">Shop</span> shop = <span class="title function_">queryWithMutex</span>(id);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Result</span>.<span class="title function_">ok</span>(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-10-åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜">2.10  åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</h3>
<p><strong>éœ€æ±‚ï¼šä¿®æ”¹æ ¹æ®idæŸ¥è¯¢å•†é“ºçš„ä¸šåŠ¡ï¼ŒåŸºäºé€»è¾‘è¿‡æœŸæ–¹å¼æ¥è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</strong></p>
<p>æ€è·¯åˆ†æï¼šå½“ç”¨æˆ·å¼€å§‹æŸ¥è¯¢redisæ—¶ï¼Œåˆ¤æ–­æ˜¯å¦å‘½ä¸­ï¼Œå¦‚æœæ²¡æœ‰å‘½ä¸­åˆ™ç›´æ¥è¿”å›ç©ºæ•°æ®ï¼Œä¸æŸ¥è¯¢æ•°æ®åº“ï¼Œè€Œä¸€æ—¦å‘½ä¸­åï¼Œå°†valueå–å‡ºï¼Œåˆ¤æ–­valueä¸­çš„è¿‡æœŸæ—¶é—´æ˜¯å¦æ»¡è¶³ï¼Œå¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œåˆ™ç›´æ¥è¿”å›redisä¸­çš„æ•°æ®ï¼Œå¦‚æœè¿‡æœŸï¼Œåˆ™åœ¨å¼€å¯ç‹¬ç«‹çº¿ç¨‹åç›´æ¥è¿”å›ä¹‹å‰çš„æ•°æ®ï¼Œç‹¬ç«‹çº¿ç¨‹å»é‡æ„æ•°æ®ï¼Œé‡æ„å®Œæˆåé‡Šæ”¾äº’æ–¥é”ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-108.png" alt="img"></p>
<p>å¦‚æœå°è£…æ•°æ®ï¼Œæ·»åŠ é€»è¾‘è¿‡æœŸå­—æ®µï¼šå› ä¸ºç°åœ¨redisä¸­å­˜å‚¨çš„æ•°æ®çš„valueéœ€è¦å¸¦ä¸Šè¿‡æœŸæ—¶é—´ï¼Œæ­¤æ—¶è¦ä¹ˆä½ å»ä¿®æ”¹åŸæ¥çš„å®ä½“ç±»</p>
<p>ç­”ï¼šå¯ä»¥åœ¨utilsåŒ…ä¸‹å®šä¹‰RedisDataç±»ï¼ˆå¯ä»¥è®©Shopç»§æ‰¿RedisDataç±»ï¼‰ï¼Œä¹Ÿå¯ä»¥åœ¨RedisDataä¸­è®¾ç½®ä¸€ä¸ªShopç±»çš„dataå±æ€§ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisData</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime expireTime;</span><br><span class="line">    <span class="keyword">private</span> Object <span class="keyword">data</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ShopServiceImplç±»ä¸­å®šä¹‰saveShop2Redisæ–¹æ³•ï¼š</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> saveShop2Redis(Long <span class="built_in">id</span>,Long expireSeconds)&#123;</span><br><span class="line">    <span class="comment">//1.æŸ¥è¯¢åº—é“ºæ•°æ®</span></span><br><span class="line">    Shop shop <span class="operator">=</span> getById(<span class="built_in">id</span>);</span><br><span class="line">    <span class="comment">//2.å°è£…é€»è¾‘è¿‡æœŸæ—¶é—´</span></span><br><span class="line">    RedisData redisData <span class="operator">=</span> <span class="keyword">new</span> RedisData();</span><br><span class="line">    redisData.setData(shop);</span><br><span class="line">    redisData.setExpireTime(LocalDateTime.now().plusSeconds(expireSeconds));</span><br><span class="line">    <span class="comment">//3.å†™å…¥Redis</span></span><br><span class="line">    stringRedisTemplate.opsForValue().<span class="built_in">set</span>(CACHE_SHOP_KEY<span class="operator">+</span><span class="built_in">id</span>,JSONUtil.toJsonStr(redisData));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å•å…ƒæµ‹è¯•ï¼Œåœ¨teståŒ…ä¸‹çš„HmDianPingApplicationTestsä¸­åˆ›å»ºtestSaveShopç±»å†™å…¥æµ‹è¯•ä»£ç ï¼ˆè¿™é‡Œè¦æ³¨æ„çš„æ˜¯è¾“å…¥alt+insertä¹‹åé€‰æ‹©Test Methodè¦é€‰æ‹©Junit 5æ¥è¿›è¡Œæµ‹è¯•æ–¹æ³•çš„ç¼–å†™ï¼‰ï¼š</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HmDianPingApplicationTests</span> </span>&#123;</span><br><span class="line">    <span class="variable">@Resource</span></span><br><span class="line">    private ShopServiceImpl shopService;</span><br><span class="line"> </span><br><span class="line">    <span class="variable">@Test</span></span><br><span class="line">    void testSaveShop() &#123;</span><br><span class="line">        shopService.saveShop2Redis(1L,10L);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°redisä¸­ç¡®å®å­˜å…¥äº†æ•°æ®ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-109.png" alt="img"></p>
<p>åœ¨ShopServiceImplä¸­å¤åˆ¶ä¸€ä»½ç¼“å­˜ç©¿é€çš„ä»£ç ï¼Œæ›´æ”¹åç§°ä¸ºqueryWithLogicalExpireï¼š</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> final <span class="title class_">ExecutorService</span> <span class="variable constant_">CACHE_REBUILD_EXECUTOR</span> = <span class="title class_">Executors</span>.<span class="title function_">newFixedThreadPool</span>(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="title class_">Shop</span> <span class="title function_">queryWithLogicalExpire</span>(<span class="params"><span class="title class_">Long</span> id</span>)&#123;</span><br><span class="line">    <span class="title class_">String</span> key = <span class="variable constant_">CACHE_SHOP_KEY</span> + id;</span><br><span class="line">    <span class="comment">//1.ä»RedisæŸ¥è¯¢ç¼“å­˜</span></span><br><span class="line">    <span class="title class_">String</span> shopJson = stringRedisTemplate.<span class="title function_">opsForValue</span>().<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="comment">//2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">StrUtil</span>.<span class="title function_">isBlank</span>(shopJson))&#123;</span><br><span class="line">        <span class="comment">//3.ä¸å­˜åœ¨ï¼Œè¿”å›ç©º</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4.å‘½ä¸­ï¼Œéœ€è¦å…ˆæŠŠjsonååºåˆ—åŒ–ä¸ºå¯¹è±¡</span></span><br><span class="line">    <span class="title class_">RedisData</span> redisData = <span class="title class_">JSON</span>Util.<span class="title function_">toBean</span>(shopJson, <span class="title class_">RedisData</span>.<span class="property">class</span>);</span><br><span class="line">    <span class="title class_">JSON</span><span class="built_in">Object</span> data = (<span class="title class_">JSON</span><span class="built_in">Object</span>) redisData.<span class="title function_">getData</span>();</span><br><span class="line">    <span class="title class_">Shop</span> shop = <span class="title class_">JSON</span>Util.<span class="title function_">toBean</span>(data, <span class="title class_">Shop</span>.<span class="property">class</span>);</span><br><span class="line">    <span class="comment">//5.åˆ¤æ–­æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">    <span class="comment">//5.1 æœªè¿‡æœŸç›´æ¥è¿”å›åº—é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="title class_">LocalDateTime</span> expireTime = redisData.<span class="title function_">getExpireTime</span>();</span><br><span class="line">    <span class="keyword">if</span>(expireTime.<span class="title function_">isAfter</span>(<span class="title class_">LocalDateTime</span>.<span class="title function_">now</span>()))&#123;</span><br><span class="line">        <span class="keyword">return</span> shop;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//5.2 å·²è¿‡æœŸé‡å»ºç¼“å­˜</span></span><br><span class="line">    <span class="comment">//6.ç¼“å­˜é‡å»º</span></span><br><span class="line">    <span class="comment">//6.1.è·å–äº’æ–¥é”</span></span><br><span class="line">    <span class="title class_">String</span> lockKey = <span class="variable constant_">LOCK_SHOP_KEY</span> + id;</span><br><span class="line">    <span class="built_in">boolean</span> isLock = <span class="title function_">tryLock</span>(lockKey);</span><br><span class="line">    <span class="comment">//6.2.åˆ¤æ–­æ˜¯å¦è·å–äº’æ–¥é”æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span>(isLock)&#123;</span><br><span class="line">        <span class="comment">//6.3.æˆåŠŸï¼Œå¼€å¯ç‹¬ç«‹çº¿ç¨‹ï¼Œå®ç°ç¼“å­˜é‡å»º</span></span><br><span class="line">        <span class="variable constant_">CACHE_REBUILD_EXECUTOR</span>.<span class="title function_">submit</span>(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="title function_">saveShop2Redis</span>(id,20L); <span class="comment">//å®é™…ä¸­åº”è¯¥è®¾ç½®ä¸º30åˆ†é’Ÿ</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="title function_">unLock</span>(lockKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6.4.å¤±è´¥ï¼Œè¿”å›è¿‡æœŸçš„å•†é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">return</span> shop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ï¼š</p>
<p>å…ˆåˆ°æ•°æ®åº“æŠŠ102èŒ¶é¤å…æ”¹ä¸º103èŒ¶é¤å…ï¼ˆå› ä¸ºRedisä¹‹å‰æ’å…¥äº†ä¸€æ¡ç¼“å­˜ä¸º102èŒ¶é¤å…ï¼Œå¹¶ä¸”å·²ç»è¿‡æœŸï¼Œæ­¤æ—¶æ•°æ®åº“ä¸ç¼“å­˜ä¸ä¸€è‡´ï¼‰ï¼Œæ–°çš„HTTPè¯·æ±‚ä¼šå°†é€»è¾‘è¿‡æœŸçš„æ•°æ®åˆ é™¤ï¼Œç„¶åæ›´æ–°ç¼“å­˜ã€‚</p>
<p>çº¿ç¨‹æ•°è®¾ç½®ä¸º100ï¼ŒRamp-upæ—¶é—´è®¾ç½®ä¸º1</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-110.png" alt="img"></p>
<p>åœ¨æŸ¥çœ‹ç»“æœæ ‘é‡Œé¢åˆ°ä¸­é—´æŸä¸ªHTTPè¯·æ±‚ä¼šå®Œæˆé‡å»ºï¼Œå“åº”æ•°æ®ä¼šæ”¹å˜ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-111.png" alt="img"></p>
<p>1.å®‰å…¨æ€§é—®é¢˜ï¼šåœ¨é«˜å¹¶å‘æƒ…å†µä¸‹æ˜¯å¦ä¼šæœ‰å¾ˆå¤šçº¿ç¨‹æ¥åšé‡å»ºã€‚</p>
<p>2.ä¸€è‡´æ€§é—®é¢˜ï¼šåœ¨é‡å»ºå®Œæˆä¹‹å‰å¾—åˆ°çš„æ˜¯å¦æ˜¯æ—§çš„æ•°æ®ã€‚</p>
<h3 id="2-11-å°è£…Redis-å·¥å…·ç±»">2.11 å°è£…Redis å·¥å…·ç±»</h3>
<p>èƒŒæ™¯ï¼šåœ¨é«˜å¹¶å‘ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ Redis ç¼“å­˜æ•°æ®åº“æŸ¥è¯¢ç»“æœï¼Œå‡è½»æ•°æ®åº“å‹åŠ›ã€‚ä½†å¦‚æœç›´æ¥ä½¿ç”¨ Redisï¼Œå¯èƒ½ä¼šé‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼š</p>
<ol>
<li><strong>ç¼“å­˜ç©¿é€</strong>ï¼šè¯·æ±‚çš„æ•°æ®æ—¢ä¸åœ¨ç¼“å­˜é‡Œï¼Œä¹Ÿä¸åœ¨æ•°æ®åº“é‡Œï¼Œä¼šé¢‘ç¹æ‰“æ•°æ®åº“ã€‚</li>
<li><strong>ç¼“å­˜å‡»ç©¿</strong>ï¼šçƒ­ç‚¹keyçªç„¶å¤±æ•ˆï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚åŒæ—¶æ‰“åˆ°æ•°æ®åº“ã€‚</li>
<li><strong>ç¼“å­˜é›ªå´©</strong>ï¼šå¤§é‡keyåŒæ—¶è¿‡æœŸï¼Œå¼•èµ·ç¬æ—¶æµé‡æ‰“æ»¡æ•°æ®åº“ã€‚</li>
</ol>
<p>å› æ­¤æˆ‘ä»¬åŸºäºStringRedisTemplateå°è£…ä¸€ä¸ªç¼“å­˜å·¥å…·ç±»ï¼Œæ»¡è¶³ä¸‹åˆ—éœ€æ±‚ï¼š</p>
<ul>
<li>æ–¹æ³•1ï¼šå°†ä»»æ„Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºjsonå¹¶å­˜å‚¨åœ¨stringç±»å‹çš„keyä¸­ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®TTLè¿‡æœŸæ—¶é—´</li>
<li>æ–¹æ³•2ï¼šå°†ä»»æ„Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºjsonå¹¶å­˜å‚¨åœ¨stringç±»å‹çš„keyä¸­ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®é€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œç”¨äºå¤„ç†ç¼“å­˜å‡»ç©¿é—®é¢˜</li>
<li>æ–¹æ³•3ï¼šæ ¹æ®æŒ‡å®šçš„keyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œåˆ©ç”¨ç¼“å­˜ç©ºå€¼çš„æ–¹å¼è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜</li>
<li>æ–¹æ³•4ï¼šæ ¹æ®æŒ‡å®šçš„keyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œéœ€è¦åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</li>
</ul>
<p><strong>å…·ä½“å®ç°</strong>ï¼š</p>
<p>åœ¨utilsåŒ…ä¸‹åˆ›å»ºCacheClientç±»ï¼Œå…ˆå†™å…¥å¦‚ä¸‹åŸºç¡€çš„ä»£ç ï¼š</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheClient</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> final <span class="title class_">StringRedisTemplate</span> stringRedisTemplate;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">CacheClient</span>(<span class="title class_">StringRedisTemplate</span> stringRedisTemplate) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">stringRedisTemplate</span> = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">set</span>(<span class="params"><span class="title class_">String</span> key, <span class="title class_">Object</span> value, <span class="title class_">Long</span> time, <span class="title class_">TimeUnit</span> unit</span>)&#123;</span><br><span class="line">        stringRedisTemplate.<span class="title function_">opsForValue</span>().<span class="title function_">set</span>(key,<span class="title class_">JSON</span>Util.<span class="title function_">toJsonStr</span>(value),time,unit);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setWithLogicalExpire</span>(<span class="params"><span class="title class_">String</span> key, <span class="title class_">Object</span> value,<span class="title class_">Long</span> expire,<span class="title class_">TimeUnit</span> unit</span>)&#123;</span><br><span class="line">        <span class="comment">//è®¾ç½®é€»è¾‘è¿‡æœŸ</span></span><br><span class="line">        <span class="title class_">RedisData</span> redisData = <span class="keyword">new</span> <span class="title class_">RedisData</span>();</span><br><span class="line">        redisData.<span class="title function_">setExpireTime</span>(<span class="title class_">LocalDateTime</span>.<span class="title function_">now</span>().<span class="title function_">plusSeconds</span>(unit.<span class="title function_">toSeconds</span>(expire)));</span><br><span class="line">        redisData.<span class="title function_">setData</span>(value);</span><br><span class="line">        stringRedisTemplate.<span class="title function_">opsForValue</span>().<span class="title function_">set</span>(key,<span class="title class_">JSON</span>Util.<span class="title function_">toJsonStr</span>(redisData));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-119.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-120.png" alt="img"></p>
<p>åœ¨CacheClientç±»ä¸­ç¼–å†™ç¼“å­˜ç©¿é€çš„å…±æ€§æ–¹æ³•queryWithPassThroughï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;R,ID&gt; R queryWithPassThrough(String keyPrefix, ID id, Class&lt;R&gt; type,</span><br><span class="line">                                     Function&lt;ID,R&gt; dbFallBack,<span class="built_in">Long</span> time,TimeUnit unit)&#123;</span><br><span class="line">    String key = keyPrefix + id;</span><br><span class="line">    <span class="comment">//1.ä»RedisæŸ¥è¯¢ç¼“å­˜</span></span><br><span class="line">    String shopJson = stringRedisTemplate.opsForValue().<span class="keyword">get</span>(key);</span><br><span class="line">    <span class="comment">//2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span>(StrUtil.isNotBlank(shopJson))&#123;</span><br><span class="line">        <span class="comment">//3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> JSONUtil.toBean(shopJson, type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä¸Šé¢æ˜¯æœ‰å€¼çš„æƒ…å†µï¼Œä¸‹é¢æ˜¯æ— å€¼çš„2ç§æƒ…å†µï¼šAï¼šç©ºå­—ç¬¦ä¸²ã€‚Bï¼šnullã€‚</span></span><br><span class="line">    <span class="keyword">if</span>(shopJson != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4.ä¸å­˜åœ¨ï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">    R r = dbFallBack.apply(id);</span><br><span class="line">    <span class="comment">//5.ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯</span></span><br><span class="line">    <span class="keyword">if</span>(r==<span class="literal">null</span>)&#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().<span class="keyword">set</span>(key,<span class="string">&quot;&quot;</span>,CACHE_NULL_TTL,TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6.å­˜åœ¨ï¼Œå†™å…¥Redis</span></span><br><span class="line">    <span class="keyword">this</span>.<span class="keyword">set</span>(key,r,time,unit);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-121.png" alt="img"></p>
<p>ç¼–å†™å®ŒqueryWithPassThroughä¹‹åå¯ä»¥åˆ°ShopServiceImplä¸­ç›´æ¥è°ƒç”¨æ–°çš„æ–¹æ³•ï¼ˆè®°å¾—å¼•å…¥CacheClientç±»ï¼‰ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> CacheClient cacheClient;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object queryById(<span class="built_in">Long</span> id) &#123;</span><br><span class="line">    <span class="comment">//è°ƒç”¨å·¥å…·ç±»è§£å†³ç¼“å­˜å‡»ç©¿</span></span><br><span class="line">    Shop shop = cacheClient.queryWithPassThrough(CACHE_SHOP_KEY, id, Shop.<span class="keyword">class</span>, <span class="keyword">this</span>::getById, CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    <span class="keyword">if</span>(shop==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;åº—é“ºä¸å­˜åœ¨ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ï¼šæˆåŠŸä¼šå¯¹ä¸å­˜åœ¨çš„åº—é“ºç©ºå€¼è¿›è¡Œç¼“å­˜ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-113.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-115.png" alt="img"></p>
<p>æ¥ä¸‹æ¥æ‹·è´queryWithLogicalExpireçš„ä»£ç åˆ°CacheClientç±»ä¸­è¿›è¡Œæ”¹å†™ï¼š</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> final <span class="title class_">ExecutorService</span> <span class="variable constant_">CACHE_REBUILD_EXECUTOR</span> = <span class="title class_">Executors</span>.<span class="title function_">newFixedThreadPool</span>(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">public</span> &lt;R,<span class="variable constant_">ID</span>&gt; R <span class="title function_">queryWithLogicalExpire</span>(<span class="params"><span class="title class_">String</span> keyPrefix,ID id,<span class="title class_">Class</span>&lt;R&gt; <span class="keyword">type</span>,<span class="title class_">Function</span>&lt;ID,R&gt; dbFallBack,<span class="title class_">Long</span> time,<span class="title class_">TimeUnit</span> unit</span>)&#123;</span><br><span class="line">    <span class="title class_">String</span> key = keyPrefix + id;</span><br><span class="line">    <span class="comment">//1.ä»RedisæŸ¥è¯¢ç¼“å­˜</span></span><br><span class="line">    <span class="title class_">String</span> shopJson = stringRedisTemplate.<span class="title function_">opsForValue</span>().<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="comment">//2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">StrUtil</span>.<span class="title function_">isBlank</span>(shopJson))&#123;</span><br><span class="line">        <span class="comment">//3.ä¸å­˜åœ¨ï¼Œè¿”å›ç©º</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4.å‘½ä¸­ï¼Œéœ€è¦å…ˆæŠŠjsonååºåˆ—åŒ–ä¸ºå¯¹è±¡</span></span><br><span class="line">    <span class="title class_">RedisData</span> redisData = <span class="title class_">JSON</span>Util.<span class="title function_">toBean</span>(shopJson, <span class="title class_">RedisData</span>.<span class="property">class</span>);</span><br><span class="line">    <span class="title class_">JSON</span><span class="built_in">Object</span> data = (<span class="title class_">JSON</span><span class="built_in">Object</span>) redisData.<span class="title function_">getData</span>();</span><br><span class="line">    R r = <span class="title class_">JSON</span>Util.<span class="title function_">toBean</span>(data, <span class="keyword">type</span>);</span><br><span class="line">    <span class="comment">//5.åˆ¤æ–­æ˜¯å¦è¿‡æœŸ</span></span><br><span class="line">    <span class="comment">//5.1 æœªè¿‡æœŸç›´æ¥è¿”å›åº—é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="title class_">LocalDateTime</span> expireTime = redisData.<span class="title function_">getExpireTime</span>();</span><br><span class="line">    <span class="keyword">if</span>(expireTime.<span class="title function_">isAfter</span>(<span class="title class_">LocalDateTime</span>.<span class="title function_">now</span>()))&#123;</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//5.2 å·²è¿‡æœŸé‡å»ºç¼“å­˜</span></span><br><span class="line">    <span class="comment">//6.ç¼“å­˜é‡å»º</span></span><br><span class="line">    <span class="comment">//6.1.è·å–äº’æ–¥é”</span></span><br><span class="line">    <span class="title class_">String</span> lockKey = <span class="variable constant_">LOCK_SHOP_KEY</span> + id;</span><br><span class="line">    <span class="built_in">boolean</span> isLock = <span class="title function_">tryLock</span>(lockKey);</span><br><span class="line">    <span class="comment">//6.2.åˆ¤æ–­æ˜¯å¦è·å–äº’æ–¥é”æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span>(isLock)&#123;</span><br><span class="line">        <span class="comment">//6.3.æˆåŠŸï¼Œå¼€å¯ç‹¬ç«‹çº¿ç¨‹ï¼Œå®ç°ç¼“å­˜é‡å»º</span></span><br><span class="line">        <span class="variable constant_">CACHE_REBUILD_EXECUTOR</span>.<span class="title function_">submit</span>(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//æŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">                R r1 = dbFallBack.<span class="title function_">apply</span>(id);</span><br><span class="line">                <span class="comment">//å†™å…¥redis</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">setWithLogicalExpire</span>(key,r1,time,unit);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="title function_">unLock</span>(lockKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6.4.å¤±è´¥ï¼Œè¿”å›è¿‡æœŸçš„å•†é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">boolean</span> <span class="title function_">tryLock</span>(<span class="params"><span class="title class_">String</span> key</span>)&#123;</span><br><span class="line">    <span class="title class_">Boolean</span> flag = stringRedisTemplate.<span class="title function_">opsForValue</span>().<span class="title function_">setIfAbsent</span>(key, <span class="string">&quot;1&quot;</span>, <span class="number">10</span>, <span class="title class_">TimeUnit</span>.<span class="property">SECONDS</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">BooleanUtil</span>.<span class="title function_">isTrue</span>(flag);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">unLock</span>(<span class="params"><span class="title class_">String</span> key</span>)&#123;</span><br><span class="line">    stringRedisTemplate.<span class="title function_">delete</span>(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-125.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-126.png" alt="img"></p>
<p>æ”¹å†™testä¸‹çš„HmDianPingApplicationTestsç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HmDianPingApplicationTests</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> CacheClient cacheClient;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ShopServiceImpl shopService;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testSaveShop</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> shopService.getById(<span class="number">1L</span>);</span><br><span class="line">        cacheClient.setWithLogicalExpire(CACHE_SHOP_KEY+<span class="number">1L</span>,shop,<span class="number">10L</span>,TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ï¼šé¦–å…ˆè¿è¡ŒHmDianPingApplicationTestsç±»é‡Œçš„æµ‹è¯•æ–¹æ³•ï¼Œ10ç§’åé€»è¾‘è¿‡æœŸï¼Œæ­¤æ—¶è¿è¡Œåå°ç¨‹åºï¼Œä¿®æ”¹æ•°æ®åº“1å·å•†é“ºçš„nameå­—æ®µï¼Œæ­¤æ—¶è®¿é—®ï¼šlocalhost:8080/api/shop/1 ä¼šå‡ºç°æ•ˆæœç¬¬1æ¬¡è®¿é—®ä¸ºç¼“å­˜æ—§å€¼ï¼Œç„¶åå‘ç°ç¼“å­˜è¿‡æœŸå¼€å§‹é‡å»ºï¼Œç¬¬2æ¬¡è®¿é—®å¼€å§‹å°±æ˜¯æ–°å€¼ã€‚æ•°æ®åº“ä¹Ÿåªæœ‰1æ¬¡é‡å»ºã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-116.png" alt="img"></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-117.png" alt="img"></p>
<h2 id="3ã€ä¼˜æƒ å·ç§’æ€">3ã€ä¼˜æƒ å·ç§’æ€</h2>
<h3 id="3-1-å…¨å±€å”¯ä¸€ID">3.1 -å…¨å±€å”¯ä¸€ID</h3>
<p>æ¯ä¸ªåº—é“ºéƒ½å¯ä»¥å‘å¸ƒä¼˜æƒ åˆ¸ï¼Œå½“ç”¨æˆ·æŠ¢è´­æ—¶ï¼Œå°±ä¼šç”Ÿæˆè®¢å•å¹¶ä¿å­˜åˆ°tb_voucher_orderè¿™å¼ è¡¨ä¸­ï¼Œè€Œè®¢å•è¡¨å¦‚æœä½¿ç”¨æ•°æ®åº“è‡ªå¢IDä¼šå­˜åœ¨ä¸€äº›é—®é¢˜ã€‚</p>
<p>1.idçš„è§„å¾‹æ€§å¤ªæ˜æ˜¾ã€‚</p>
<p>2.å—å•è¡¨æ•°æ®é‡çš„é™åˆ¶ï¼ˆåˆ†è¡¨ä¹‹åæ¯å¼ è¡¨éƒ½è‡ªå¢é•¿ï¼Œidä¼šå‡ºç°é‡å¤ï¼‰ã€‚</p>
<p><strong>å…¨å±€IDç”Ÿæˆå™¨</strong>ï¼šæ˜¯ä¸€ç§åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ç”¨æ¥ç”Ÿæˆå…¨å±€å”¯ä¸€IDçš„å·¥å…·ï¼Œä¸€èˆ¬è¦æ»¡è¶³ä¸‹åˆ—ç‰¹æ€§ï¼š</p>
<p>1.å”¯ä¸€æ€§ã€‚2.é«˜å¯ç”¨ã€‚3.é«˜æ€§èƒ½ã€‚4.é€’å¢æ€§ã€‚5.å®‰å…¨æ€§ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-127.png" alt="img"></p>
<p>ä¸ºäº†å¢åŠ IDçš„å®‰å…¨æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ç›´æ¥ä½¿ç”¨Redisè‡ªå¢çš„æ•°å€¼ï¼Œè€Œæ˜¯æ‹¼æ¥ä¸€äº›å…¶å®ƒä¿¡æ¯ï¼š</p>
<p>IDçš„ç»„æˆéƒ¨åˆ†ï¼šç¬¦å·ä½ï¼š1bitï¼Œæ°¸è¿œä¸º0ä»£è¡¨æ•´æ•°</p>
<p>æ—¶é—´æˆ³ï¼š31bitï¼Œä»¥ç§’ä¸ºå•ä½ï¼Œå®šä¹‰äº†ä¸€ä¸ªèµ·å§‹æ—¶é—´ï¼Œç”¨å½“å‰æ—¶é—´å‡èµ·å§‹æ—¶é—´ï¼Œé¢„ä¼°å¯ä»¥ä½¿ç”¨69å¹´ã€‚</p>
<p>åºåˆ—å·ï¼š32bitï¼Œç§’å†…çš„è®¡æ•°å™¨ï¼Œæ”¯æŒæ¯ç§’äº§ç”Ÿ2^32ä¸ªä¸åŒID</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-128.png" alt="img"></p>
<h3 id="3-2-Rediså®ç°å…¨å±€å”¯ä¸€Id">3.2 -Rediså®ç°å…¨å±€å”¯ä¸€Id</h3>
<p>åœ¨utilsåŒ…ä¸‹å®šä¹‰ä¸€ä¸ªRedisWorkerç±»ï¼Œæ˜¯ä¸€ä¸ªåŸºäºRedisçš„IDç”Ÿæˆå™¨ã€‚</p>
<p>å¦‚æœåªä½¿ç”¨ä¸€ä¸ªkeyæ¥è‡ªå¢è®°å½•æœ‰ä¸€ä¸ªåå¤„ï¼Œæœ€ç»ˆkeyçš„è‡ªå¢æ•°é‡ä¼šçªç ´å®¹é‡çš„ä¸Šé™ï¼Œå‡å¦‚è‡ªå¢è¶…è¿‡32ä½å½¼æ—¶ä¾¿æ— æ³•å†å­˜å‚¨æ–°çš„æ•°æ®ï¼Œè§£å†³çš„æ–¹æ¡ˆæ˜¯é‡‡ç”¨æ‹¼æ¥æ—¥æœŸã€‚</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisIdWorker</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="built_in">long</span> BEGIN_TIMESTAMP = <span class="number">1640995200</span>L;</span><br><span class="line">    <span class="comment">//åºåˆ—å·çš„ä½æ•°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="built_in">int</span> COUNT_BITS=<span class="number">32</span>;</span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> RedisIdWorker(StringRedisTemplate stringRedisTemplate) &#123;</span><br><span class="line">        <span class="keyword">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span>  <span class="built_in">long</span> nextId(String keyPrefix)&#123;</span><br><span class="line">        <span class="comment">//1.ç”Ÿæˆæ—¶é—´æˆ³</span></span><br><span class="line">        LocalDateTime now = LocalDateTime.now();</span><br><span class="line">        <span class="built_in">long</span> timeStamp = now.toEpochSecond(ZoneOffset.UTC) - BEGIN_TIMESTAMP;</span><br><span class="line">        <span class="comment">//2.ç”Ÿæˆåºåˆ—å·</span></span><br><span class="line">        <span class="comment">//2.1è·å–å½“å‰æ—¥æœŸï¼Œç²¾ç¡®åˆ°å¤©</span></span><br><span class="line">        String <span class="built_in">date</span> = now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy:MM:dd&quot;</span>));</span><br><span class="line">        <span class="comment">//2.2è‡ªå¢é•¿</span></span><br><span class="line">        <span class="built_in">long</span> <span class="keyword">count</span> = stringRedisTemplate.opsForValue().increment(<span class="string">&quot;icr:&quot;</span> + keyPrefix + <span class="string">&quot;:&quot;</span> + <span class="built_in">date</span>);</span><br><span class="line">        <span class="comment">//3.æ‹¼æ¥å¹¶è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> timeStamp &lt;&lt; COUNT_BITS | <span class="keyword">count</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨HmDianPingApplicationTestsä¸­å†™å…¥å¦‚ä¸‹çš„æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Resource</span><br><span class="line"><span class="keyword">private</span> ShopServiceImpl shopService;</span><br><span class="line">@Resource</span><br><span class="line"><span class="keyword">private</span> RedisIdWorker redisIdWorker;</span><br><span class="line"><span class="keyword">private</span> ExecutorService es = Executors.<span class="built_in">newFixedThreadPool</span>(<span class="number">500</span>);</span><br><span class="line">@<span class="function">Test</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">testIdWorker</span><span class="params">()</span> throws InterruptedException </span>&#123;</span><br><span class="line">    CountDownLatch latch = <span class="keyword">new</span> <span class="built_in">CountDownLatch</span>(<span class="number">300</span>);</span><br><span class="line">    Runnable task = ()-&gt;&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">            <span class="type">long</span> id = redisIdWorker.<span class="built_in">nextId</span>(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">            System.out.<span class="built_in">println</span>(<span class="string">&quot;id=&quot;</span>+id);</span><br><span class="line">        &#125;</span><br><span class="line">        latch.<span class="built_in">countDown</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">long</span> begin = System.<span class="built_in">currentTimeMillis</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">300</span>;i++)&#123;</span><br><span class="line">        es.<span class="built_in">submit</span>(task);</span><br><span class="line">    &#125;</span><br><span class="line">    latch.<span class="built_in">await</span>();</span><br><span class="line">    <span class="type">long</span> end = System.<span class="built_in">currentTimeMillis</span>();</span><br><span class="line">    System.out.<span class="built_in">println</span>(<span class="string">&quot;Result Time = &quot;</span> + (end-begin));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œä¹‹åå¯ä»¥çœ‹åˆ°ä»¥åè¿›åˆ¶è¾“å‡ºçš„æ‰€æœ‰ç¼–å·</p>
<p>å¯ä»¥åœ¨Redisä¸­çœ‹åˆ°è‡ªå¢é•¿çš„ç»“æœï¼Œ1æ¬¡æ˜¯30000ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-130.png" alt="img"></p>
<p>å¤§æ¦‚2ç§’å¯ä»¥ç”Ÿæˆ3ä¸‡æ¡ï¼Œé€Ÿåº¦è¿˜æ˜¯å¯ä»¥çš„ã€‚</p>
<p>å…¨å±€å”¯ä¸€IDç”Ÿæˆç­–ç•¥ï¼š</p>
<p>1.UUIDåˆ©ç”¨JDKè‡ªå¸¦çš„å·¥å…·ç±»å³å¯ç”Ÿæˆï¼Œç”Ÿæˆçš„æ˜¯16è¿›åˆ¶çš„å­—ç¬¦ä¸²ï¼Œæ— å•è°ƒé€’å¢çš„ç‰¹æ€§ã€‚</p>
<p>2.Redisè‡ªå¢ï¼ˆæ¯å¤©ä¸€ä¸ªkeyï¼Œæ–¹ä¾¿ç»Ÿè®¡è®¢å•é‡ã€‚æ—¶é—´æˆ³+è®¡æ•°å™¨çš„æ ¼å¼ã€‚ï¼‰</p>
<p>3.snowflakeé›ªèŠ±ç®—æ³•ï¼ˆä¸ä¾èµ–äºRedisï¼Œæ€§èƒ½æ›´å¥½ï¼Œå¯¹äºæ—¶é’Ÿä¾èµ–ï¼‰</p>
<p>4.æ•°æ®åº“è‡ªå¢</p>
<h2 id="ğŸ§©-ä¸å…¶ä»–-ID-ç”Ÿæˆæ–¹æ¡ˆå¯¹æ¯”">ğŸ§© ä¸å…¶ä»– ID ç”Ÿæˆæ–¹æ¡ˆå¯¹æ¯”</h2>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>ç‰¹ç‚¹</th>
<th>ä¼˜ç¼ºç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>UUID</strong></td>
<td>é€šè¿‡ JDK æä¾› <code>UUID.randomUUID()</code></td>
<td>ä¿è¯å”¯ä¸€ï¼Œä½†æ— åºã€é•¿åº¦å¤§ï¼Œä¸é€‚åˆæ’åºå’Œæ•°æ®åº“ä¸»é”®</td>
</tr>
<tr>
<td><strong>Redis è‡ªå¢ï¼ˆæœ¬ä¾‹ï¼‰</strong></td>
<td>æ—¶é—´æˆ³ + è‡ªå¢</td>
<td>å¹¶å‘é«˜ï¼Œæ˜“äºæ§åˆ¶å’Œæ‹†åˆ†ï¼Œä½†ä¾èµ– Redis</td>
</tr>
<tr>
<td><strong>é›ªèŠ±ç®—æ³•ï¼ˆSnowflakeï¼‰</strong></td>
<td>Twitter å¼€æºçš„åˆ†å¸ƒå¼ ID æ–¹æ¡ˆ</td>
<td>æ€§èƒ½é«˜ï¼Œä¸ä¾èµ– Redisï¼Œä½†éœ€è¦ç²¾ç¡®çš„æœºå™¨æ—¶é—´</td>
</tr>
<tr>
<td><strong>æ•°æ®åº“è‡ªå¢ä¸»é”®</strong></td>
<td>åˆ©ç”¨æ•°æ®åº“ä¸»é”®è‡ªå¢</td>
<td>ç®€å•ä½†æ€§èƒ½å·®ï¼Œåˆ†å¸ƒå¼ä¸‹æ˜“å†²çªæˆ–å¤±æ•ˆ</td>
</tr>
</tbody>
</table>
<h3 id="3-3-æ·»åŠ ä¼˜æƒ å·">3.3 æ·»åŠ ä¼˜æƒ å·</h3>
<p>æ¯ä¸ªåº—é“ºéƒ½å¯ä»¥å‘æ”¾ä¼˜æƒ åˆ¸ï¼Œåˆ†ä¸ºå¹³ä»·åˆ¸å’Œç‰¹ä»·åˆ¸ã€‚å¹³ä»·åˆ¸å¯ä»¥ä»»æ„æŠ¢è´­ï¼Œç‰¹ä»·åˆ¸éœ€è¦ç§’æ€æŠ¢è´­ã€‚</p>
<p>tb_voucherï¼šä¼˜æƒ åˆ¸åŸºæœ¬ä¿¡æ¯ï¼Œä¼˜æƒ é‡‘é¢ï¼Œä½¿ç”¨è§„åˆ™ç­‰ã€‚</p>
<p>tb_seckill_voucherï¼šä¼˜æƒ åˆ¸çš„åº“å­˜ï¼Œå¼€å§‹æŠ¢è´­æ—¶é—´ï¼Œç»“æŸæŠ¢è´­æ—¶é—´ï¼Œåªæœ‰ç‰¹ä»·ä¼˜æƒ åˆ¸æ‰éœ€è¦å¡«å†™è¿™äº›ä¿¡æ¯ã€‚</p>
<p>è€Œä»£é‡‘åˆ¸ç”±äºä¼˜æƒ åŠ›åº¦å¤§ï¼Œæ‰€ä»¥åƒç¬¬äºŒç§å·ï¼Œå°±å¾—é™åˆ¶æ•°é‡ï¼Œä»è¡¨ç»“æ„ä¸Šä¹Ÿèƒ½çœ‹å‡ºï¼Œç‰¹ä»·å·é™¤äº†å…·æœ‰ä¼˜æƒ å·çš„åŸºæœ¬ä¿¡æ¯ä»¥å¤–ï¼Œè¿˜å…·æœ‰åº“å­˜ï¼ŒæŠ¢è´­æ—¶é—´ï¼Œç»“æŸæ—¶é—´ç­‰ç­‰å­—æ®µ</p>
<p>è¯·æ±‚çš„ä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;shopId&quot;</span>:<span class="number">1</span>,</span><br><span class="line"><span class="string">&quot;title&quot;</span>:<span class="string">&quot;100å…ƒä»£é‡‘åˆ¸&quot;</span>,</span><br><span class="line"><span class="string">&quot;subTitle&quot;</span>:<span class="string">&quot;å‘¨ä¸€è‡³å‘¨äº”å‡å¯ä½¿ç”¨&quot;</span>,</span><br><span class="line"><span class="string">&quot;rules&quot;</span>:<span class="string">&quot;å…¨åœºé€šç”¨<span class="char escape_">\n</span>æ— éœ€é¢„çº¦<span class="char escape_">\n</span>å¯æ— é™å åŠ <span class="char escape_">\ä¸</span>å…‘ç°ã€ä¸æ‰¾é›¶<span class="char escape_">\n</span>ä»…é™å ‚é£Ÿ&quot;</span>,</span><br><span class="line"><span class="string">&quot;payValue&quot;</span>:<span class="number">8000</span>,</span><br><span class="line"><span class="string">&quot;actualValue&quot;</span>:<span class="number">10000</span>,</span><br><span class="line"><span class="string">&quot;type&quot;</span>:<span class="number">1</span>,</span><br><span class="line"><span class="string">&quot;stock&quot;</span>:<span class="number">100</span>,</span><br><span class="line"><span class="string">&quot;beginTime&quot;</span>:<span class="string">&quot;2024-04-10T10:09:17&quot;</span>,</span><br><span class="line"><span class="string">&quot;endTime&quot;</span>:<span class="string">&quot;2024-04-11T12:09:04&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ–°å¢æ™®é€šå·ä»£ç ï¼š</strong></p>
<p>VoucherController</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@PostMapping</span></span><br><span class="line">public Result <span class="built_in">addVoucher</span>(<span class="variable">@RequestBody</span> Voucher voucher) &#123;</span><br><span class="line">    <span class="selector-tag">voucherService</span><span class="selector-class">.save</span>(voucher);</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">Result</span><span class="selector-class">.ok</span>(voucher.<span class="built_in">getId</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ–°å¢ç§’æ€å·ä»£ç ï¼š</strong></p>
<p><strong>VoucherController</strong></p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@PostMapping</span>(<span class="string">&quot;seckill&quot;</span>)</span><br><span class="line">public Result <span class="built_in">addSeckillVoucher</span>(<span class="variable">@RequestBody</span> Voucher voucher) &#123;</span><br><span class="line">    <span class="selector-tag">voucherService</span><span class="selector-class">.addSeckillVoucher</span>(voucher);</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">Result</span><span class="selector-class">.ok</span>(voucher.<span class="built_in">getId</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>VoucherServiceImpl</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSeckillVoucher</span><span class="params">(Voucher voucher)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¿å­˜ä¼˜æƒ åˆ¸</span></span><br><span class="line">    save(voucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€ä¿¡æ¯</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillVoucher</span>();</span><br><span class="line">    seckillVoucher.setVoucherId(voucher.getId());</span><br><span class="line">    seckillVoucher.setStock(voucher.getStock());</span><br><span class="line">    seckillVoucher.setBeginTime(voucher.getBeginTime());</span><br><span class="line">    seckillVoucher.setEndTime(voucher.getEndTime());</span><br><span class="line">    seckillVoucherService.save(seckillVoucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€åº“å­˜åˆ°Redisä¸­</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(SECKILL_STOCK_KEY + voucher.getId(), voucher.getStock().toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-4-å®ç°ç§’æ€ä¸‹å•">3.4 å®ç°ç§’æ€ä¸‹å•</h3>
<p>ä¸‹å•æ ¸å¿ƒæ€è·¯ï¼šå½“æˆ‘ä»¬ç‚¹å‡»æŠ¢è´­æ—¶ï¼Œä¼šè§¦å‘å³ä¾§çš„è¯·æ±‚ï¼Œæˆ‘ä»¬åªéœ€è¦ç¼–å†™å¯¹åº”çš„controllerå³å¯</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-132.png" alt="img"></p>
<p>ç§’æ€ä¸‹å•åº”è¯¥æ€è€ƒçš„å†…å®¹ï¼š</p>
<p>ä¸‹å•æ—¶éœ€è¦åˆ¤æ–­ä¸¤ç‚¹ï¼š</p>
<ul>
<li>ç§’æ€æ˜¯å¦å¼€å§‹æˆ–ç»“æŸï¼Œå¦‚æœå°šæœªå¼€å§‹æˆ–å·²ç»ç»“æŸåˆ™æ— æ³•ä¸‹å•</li>
<li>åº“å­˜æ˜¯å¦å……è¶³ï¼Œä¸è¶³åˆ™æ— æ³•ä¸‹å•</li>
</ul>
<p>ä¸‹å•æ ¸å¿ƒé€»è¾‘åˆ†æï¼š</p>
<p>å½“ç”¨æˆ·å¼€å§‹è¿›è¡Œä¸‹å•ï¼Œæˆ‘ä»¬åº”å½“å»æŸ¥è¯¢ä¼˜æƒ å·ä¿¡æ¯ï¼ŒæŸ¥è¯¢åˆ°ä¼˜æƒ å·ä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯å¦æ»¡è¶³ç§’æ€æ¡ä»¶</p>
<p>æ¯”å¦‚æ—¶é—´æ˜¯å¦å……è¶³ï¼Œå¦‚æœæ—¶é—´å……è¶³ï¼Œåˆ™è¿›ä¸€æ­¥åˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚æœä¸¤è€…éƒ½æ»¡è¶³ï¼Œåˆ™æ‰£å‡åº“å­˜ï¼Œåˆ›å»ºè®¢å•ï¼Œç„¶åè¿”å›è®¢å•idï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ¡ä»¶ä¸æ»¡è¶³åˆ™ç›´æ¥ç»“æŸã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-134.png" alt="img"></p>
<p>åœ¨VouchrOrderControllerç±»ä¸­ï¼š</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@RestController</span></span><br><span class="line"><span class="variable">@RequestMapping</span>(<span class="string">&quot;/voucher-order&quot;</span>)</span><br><span class="line">public class VoucherOrderController &#123;</span><br><span class="line">  <span class="variable">@Resource</span></span><br><span class="line">   private IVoucherService voucherService;</span><br><span class="line">   <span class="variable">@PostMapping</span>(<span class="string">&quot;seckill/&#123;id&#125;&quot;</span>)</span><br><span class="line">    public Result <span class="built_in">seckillVoucher</span>(<span class="variable">@PathVariable</span>(<span class="string">&quot;id&quot;</span>) Long voucherId) &#123;</span><br><span class="line">           <span class="selector-tag">return</span> <span class="selector-tag">voucherService</span><span class="selector-class">.seckillVoucher</span>(voucherId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨IVoucherOrderServiceä¸­å†™å…¥å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">interface</span> <span class="symbol">IVoucherOrderService</span> <span class="symbol">extends</span> <span class="symbol">IService</span> &#123;</span><br><span class="line">        Result seckillVoucher(Long voucherId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨VoucherOrderServiceImplä¸­å†™å…¥å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VoucherOrderServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">VoucherOrderMapper</span>, <span class="title">VoucherOrder</span>&gt; <span class="keyword">implements</span> <span class="title">IVoucherOrderService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisIdWorker redisIdWorker;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">Result <span class="title">seckillVoucher</span><span class="params">(Long voucherId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1.æŸ¥è¯¢ä¼˜æƒ åˆ¸ä¿¡æ¯</span></span><br><span class="line">        SeckillVoucher voucher = seckillVoucherService.getById(voucherId);</span><br><span class="line">        <span class="comment">//2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">        <span class="comment">//2.1ç§’æ€å°šæœªå¼€å§‹è¿”å›å¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">if</span>(voucher.getBeginTime().isAfter(LocalDateTime.now()))&#123;</span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//2.2ç§’æ€å·²ç»“æŸè¿”å›å¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">if</span>(voucher.getEndTime().isBefore(LocalDateTime.now()))&#123;</span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸ&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">        <span class="keyword">if</span>(voucher.getStock()&lt;<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="comment">//3.1åº“å­˜ä¸è¶³è¿”å›å¼‚å¸¸</span></span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.2åº“å­˜å……è¶³æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="keyword">boolean</span> success = seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).update();</span><br><span class="line">        <span class="keyword">if</span>(!success)&#123;</span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//4.åˆ›å»ºè®¢å•ï¼Œè¿”å›è®¢å•id</span></span><br><span class="line">        VoucherOrder voucherOrder = <span class="keyword">new</span> VoucherOrder();</span><br><span class="line">        <span class="keyword">long</span> orderId = redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);<span class="comment">//è®¢å•id</span></span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        Long userId = UserHolder.getUser().getId();<span class="comment">//ç”¨æˆ·id</span></span><br><span class="line">        voucherOrder.setUserId(userId);</span><br><span class="line">        voucherOrder.setVoucherId(voucherId);<span class="comment">//ä»£é‡‘åˆ¸id</span></span><br><span class="line">        save(voucherOrder);</span><br><span class="line">        <span class="function"><span class="keyword">return</span> Result.<span class="title">ok</span><span class="params">(orderId)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-5-åº“å­˜è¶…å–é—®é¢˜åˆ†æ">3.5 åº“å­˜è¶…å–é—®é¢˜åˆ†æ</h3>
<p>å‡è®¾çº¿ç¨‹1è¿‡æ¥æŸ¥è¯¢åº“å­˜ï¼Œåˆ¤æ–­å‡ºæ¥åº“å­˜å¤§äº1ï¼Œæ­£å‡†å¤‡å»æ‰£å‡åº“å­˜ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æ¥å¾—åŠå»æ‰£å‡ï¼Œæ­¤æ—¶çº¿ç¨‹2è¿‡æ¥ï¼Œçº¿ç¨‹2ä¹Ÿå»æŸ¥è¯¢åº“å­˜ï¼Œå‘ç°è¿™ä¸ªæ•°é‡ä¸€å®šä¹Ÿå¤§äº1ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªçº¿ç¨‹éƒ½ä¼šå»æ‰£å‡åº“å­˜ï¼Œæœ€ç»ˆå¤šä¸ªçº¿ç¨‹ç›¸å½“äºä¸€èµ·å»æ‰£å‡åº“å­˜ï¼Œæ­¤æ—¶å°±ä¼šå‡ºç°åº“å­˜çš„è¶…å–é—®é¢˜ã€‚</p>
<p>æ­£å¸¸é€»è¾‘ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-137.png" alt="img"></p>
<p>éæ­£å¸¸é€»è¾‘ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-135.png" alt="img"></p>
<p>è¶…å–é—®é¢˜æ˜¯å…¸å‹çš„å¤šçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œé’ˆå¯¹è¿™ä¸€é—®é¢˜çš„å¸¸è§è§£å†³æ–¹æ¡ˆå°±æ˜¯åŠ é”ï¼šè€Œå¯¹äºåŠ é”ï¼Œæˆ‘ä»¬é€šå¸¸æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼šè§ä¸‹å›¾ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-138.png" alt="img"></p>
<p><strong>æ‚²è§‚é”ï¼š</strong></p>
<p>æ‚²è§‚é”å¯ä»¥å®ç°å¯¹äºæ•°æ®çš„ä¸²è¡ŒåŒ–æ‰§è¡Œï¼Œæ¯”å¦‚synï¼Œå’Œlockéƒ½æ˜¯æ‚²è§‚é”çš„ä»£è¡¨ï¼ŒåŒæ—¶ï¼Œæ‚²è§‚é”ä¸­åˆå¯ä»¥å†ç»†åˆ†ä¸ºå…¬å¹³é”ï¼Œéå…¬å¹³é”ï¼Œå¯é‡å…¥é”ï¼Œç­‰ç­‰</p>
<p><strong>ä¹è§‚é”ï¼š</strong></p>
<p>ä¹è§‚é”ï¼šä¼šæœ‰ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œæ¯æ¬¡æ“ä½œæ•°æ®ä¼šå¯¹ç‰ˆæœ¬å·+1ï¼Œå†æäº¤å›æ•°æ®æ—¶ï¼Œä¼šå»æ ¡éªŒæ˜¯å¦æ¯”ä¹‹å‰çš„ç‰ˆæœ¬å¤§1 ï¼Œå¦‚æœå¤§1 ï¼Œåˆ™è¿›è¡Œæ“ä½œæˆåŠŸï¼Œè¿™å¥—æœºåˆ¶çš„æ ¸å¿ƒé€»è¾‘åœ¨äºï¼Œå¦‚æœåœ¨æ“ä½œè¿‡ç¨‹ä¸­ï¼Œç‰ˆæœ¬å·åªæ¯”åŸæ¥å¤§1 ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€æ“ä½œè¿‡ç¨‹ä¸­æ²¡æœ‰äººå¯¹ä»–è¿›è¡Œè¿‡ä¿®æ”¹ï¼Œä»–çš„æ“ä½œå°±æ˜¯å®‰å…¨çš„ï¼Œå¦‚æœä¸å¤§1ï¼Œåˆ™æ•°æ®è¢«ä¿®æ”¹è¿‡ï¼Œå½“ç„¶ä¹è§‚é”è¿˜æœ‰ä¸€äº›å˜ç§çš„å¤„ç†æ–¹å¼æ¯”å¦‚cas</p>
<p>ä¹è§‚é”çš„å…¸å‹ä»£è¡¨ï¼šå°±æ˜¯casï¼Œåˆ©ç”¨casè¿›è¡Œæ— é”åŒ–æœºåˆ¶åŠ é”ï¼Œvar5 æ˜¯æ“ä½œå‰è¯»å–çš„å†…å­˜å€¼ï¼Œwhileä¸­çš„var1+var2 æ˜¯é¢„ä¼°å€¼ï¼Œå¦‚æœé¢„ä¼°å€¼ == å†…å­˜å€¼ï¼Œåˆ™ä»£è¡¨ä¸­é—´æ²¡æœ‰è¢«äººä¿®æ”¹è¿‡ï¼Œæ­¤æ—¶å°±å°†æ–°å€¼å»æ›¿æ¢ å†…å­˜å€¼</p>
<p>å…¶ä¸­do while æ˜¯ä¸ºäº†åœ¨æ“ä½œå¤±è´¥æ—¶ï¼Œå†æ¬¡è¿›è¡Œè‡ªæ—‹æ“ä½œï¼Œå³æŠŠä¹‹å‰çš„é€»è¾‘å†æ“ä½œä¸€æ¬¡ã€‚</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">int var5;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    var5 = <span class="keyword">this</span>.getIntVolatile(var1, var2);</span><br><span class="line">&#125; <span class="keyword">while</span>(!<span class="keyword">this</span>.compareAndSwapInt(var1, var2, var5, var5 + var4));</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> var5;</span><br></pre></td></tr></table></figure>
<p><strong>è¯¾ç¨‹ä¸­çš„ä½¿ç”¨æ–¹å¼ï¼š</strong></p>
<p>è¯¾ç¨‹ä¸­çš„ä½¿ç”¨æ–¹å¼æ˜¯æ²¡æœ‰åƒcasä¸€æ ·å¸¦è‡ªæ—‹çš„æ“ä½œï¼Œä¹Ÿæ²¡æœ‰å¯¹versionçš„ç‰ˆæœ¬å·+1 ï¼Œä»–çš„æ“ä½œé€»è¾‘æ˜¯åœ¨æ“ä½œæ—¶ï¼Œå¯¹ç‰ˆæœ¬å·è¿›è¡Œ+1 æ“ä½œï¼Œç„¶åè¦æ±‚version å¦‚æœæ˜¯1 çš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½æ“ä½œï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªçº¿ç¨‹åœ¨æ“ä½œåï¼Œæ•°æ®åº“ä¸­çš„versionå˜æˆäº†2ï¼Œä½†æ˜¯ä»–è‡ªå·±æ»¡è¶³version=1 ï¼Œæ‰€ä»¥æ²¡æœ‰é—®é¢˜ï¼Œæ­¤æ—¶çº¿ç¨‹2æ‰§è¡Œï¼Œçº¿ç¨‹2 æœ€åä¹Ÿéœ€è¦åŠ ä¸Šæ¡ä»¶version =1 ï¼Œä½†æ˜¯ç°åœ¨ç”±äºçº¿ç¨‹1å·²ç»æ“ä½œè¿‡äº†ï¼Œæ‰€ä»¥çº¿ç¨‹2ï¼Œæ“ä½œæ—¶å°±ä¸æ»¡è¶³version=1 çš„æ¡ä»¶äº†ï¼Œæ‰€ä»¥çº¿ç¨‹2æ— æ³•æ‰§è¡ŒæˆåŠŸ</p>
<p><strong>ç‰ˆæœ¬å·æ³•ï¼š</strong></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-139.png" alt="img"></p>
<p><strong>CASæ³•</strong>ï¼ˆç‰ˆæœ¬å·æ³•çš„ç®€åŒ–ç‰ˆï¼‰ï¼šæŸ¥è¯¢çš„æ—¶å€™æŠŠåº“å­˜æŸ¥å‡ºæ¥ï¼Œæ›´æ–°çš„æ—¶å€™åˆ¤æ–­åº“å­˜å’Œä¹‹å‰æŸ¥åˆ°çš„åº“å­˜æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´åˆ™æ›´æ–°æ•°æ®ã€‚</p>
<h3 id="3-6-ä¹è§‚é”è§£å†³è¶…å–é—®é¢˜">3.6 ä¹è§‚é”è§£å†³è¶…å–é—®é¢˜</h3>
<p>åªéœ€åŠ ä¸Šä¸‹é¢è¿™æ®µä»£ç å³å¯ï¼š.eq(â€œstockâ€,voucher.getStock()) ã€‚ç”¨äºæ¯”è¾ƒå½“å‰æ•°æ®åº“çš„åº“å­˜å€¼å’Œä¹‹å‰æŸ¥è¯¢åˆ°çš„åº“å­˜å€¼æ˜¯å¦ç›¸åŒï¼Œåªæœ‰ç›¸åŒæ—¶æ‰å¯ä»¥æ‰§è¡Œsetè¯­å¥ã€‚</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//<span class="number">3.2</span>åº“å­˜å……è¶³æ‰£å‡åº“å­˜</span><br><span class="line">boolean success = seckillVoucherService.update()</span><br><span class="line">        .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>) //ç›¸å½“äºsetæ¡ä»¶ set stock = stock - <span class="number">1</span></span><br><span class="line">        .e<span class="string">q(&quot;voucher_id&quot;, voucherId)</span> //ç›¸å½“äºwhereæ¡ä»¶ where id = ? <span class="keyword">and</span> stock = ?</span><br><span class="line">        .e<span class="string">q(&quot;stock&quot;,voucher.getStock()</span>).update();</span><br></pre></td></tr></table></figure>
<p>ä½†ç»è¿‡æµ‹è¯•ç°åœ¨å‡ºç°äº†å¼‚å¸¸å€¼åé«˜çš„é—®é¢˜ï¼Œæ­£å¸¸çš„è¯·æ±‚å¤§çº¦åªå 10%ã€‚</p>
<p>åŸç†æ˜¯å› ä¸ºï¼šå‡å¦‚ä¸€æ¬¡æœ‰30ä¸ªçº¿ç¨‹æ¶Œå…¥ï¼ŒæŸ¥è¯¢åˆ°åº“å­˜å€¼ä¸º100ï¼Œåªæœ‰1ä¸ªçº¿ç¨‹èƒ½æŠŠå€¼æ”¹ä¸º99ï¼Œå…¶å®ƒ29ä¸ªçº¿ç¨‹æ¯”å¯¹åº“å­˜å€¼99å‘ç°å’Œè‡ªå·±æŸ¥è¯¢åˆ°çš„åº“å­˜å€¼100ä¸åŒï¼Œæ‰€ä»¥éƒ½è®¤ä¸ºæ•°æ®å·²ç»è¢«ä¿®æ”¹è¿‡ï¼Œæ‰€ä»¥éƒ½å¤±è´¥äº†ã€‚</p>
<p>ç°åœ¨åªéœ€è¦ä¿è¯stock&gt;0å³å¯ï¼Œåªè¦å­˜é‡å¤§äº0å°±å¯ä»¥ä»»æ„æ‰£å‡ã€‚</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> success = seckillVoucherService.<span class="keyword">update</span>()</span><br><span class="line">        .setSql(&quot;stock = stock - 1&quot;) //ç›¸å½“äº<span class="keyword">set</span>æ¡ä»¶ <span class="keyword">set</span> stock = stock - <span class="number">1</span></span><br><span class="line">        .eq(&quot;voucher_id&quot;, voucherId) //ç›¸å½“äº<span class="keyword">where</span>æ¡ä»¶ <span class="keyword">where</span> id = ? <span class="keyword">and</span> stock = ?</span><br><span class="line">        .gt(&quot;stock&quot;,<span class="number">0</span>).<span class="keyword">update</span>();</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-141.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-143.png" alt="img"></p>
<p>ä¹è§‚é”ç¼ºé™·ï¼š</p>
<p>éœ€è¦å¤§é‡å¯¹æ•°æ®åº“è¿›è¡Œè®¿é—®ï¼Œå®¹æ˜“å¯¼è‡´æ•°æ®åº“çš„å´©æºƒã€‚</p>
<p>æ€»ç»“ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-144.png" alt="img"></p>
<h3 id="3-7ä¼˜æƒ åˆ¸ç§’æ€-ä¸€äººä¸€å•">3.7ä¼˜æƒ åˆ¸ç§’æ€-ä¸€äººä¸€å•</h3>
<p>éœ€æ±‚ï¼šä¿®æ”¹ç§’æ€ä¸šåŠ¡ï¼Œè¦æ±‚åŒä¸€ä¸ªä¼˜æƒ åˆ¸ï¼Œä¸€ä¸ªç”¨æˆ·åªèƒ½ä¸‹ä¸€å•</p>
<p>é—®é¢˜åˆ†æï¼šä¼˜æƒ å·æ˜¯ä¸ºäº†å¼•æµï¼Œä½†æ˜¯ç›®å‰çš„æƒ…å†µæ˜¯ï¼Œä¸€ä¸ªäººå¯ä»¥æ— é™åˆ¶çš„æŠ¢è¿™ä¸ªä¼˜æƒ å·ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”å½“å¢åŠ ä¸€å±‚é€»è¾‘ï¼Œè®©ä¸€ä¸ªç”¨æˆ·åªèƒ½ä¸‹ä¸€ä¸ªå•ï¼Œè€Œä¸æ˜¯è®©ä¸€ä¸ªç”¨æˆ·ä¸‹å¤šä¸ªå•</p>
<p>å…·ä½“æ“ä½œé€»è¾‘å¦‚ä¸‹ï¼šæ¯”å¦‚æ—¶é—´æ˜¯å¦å……è¶³ï¼Œå¦‚æœæ—¶é—´å……è¶³ï¼Œåˆ™è¿›ä¸€æ­¥åˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿï¼Œç„¶åå†æ ¹æ®ä¼˜æƒ å·idå’Œç”¨æˆ·idæŸ¥è¯¢æ˜¯å¦å·²ç»ä¸‹è¿‡è¿™ä¸ªè®¢å•ï¼Œå¦‚æœä¸‹è¿‡è¿™ä¸ªè®¢å•ï¼Œåˆ™ä¸å†ä¸‹å•ï¼Œå¦åˆ™è¿›è¡Œä¸‹å•</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-156.png" alt="img"></p>
<p>âŒ é”™è¯¯æ–¹å¼ï¼šé”æ•´ä¸ªæ–¹æ³•ï¼ˆæ¯”å¦‚ <code>synchronized public void createVoucherOrder()</code>ï¼‰</p>
<p><strong>é—®é¢˜</strong>ï¼šæ‰€æœ‰ç”¨æˆ·éƒ½ä¼šç«äº‰åŒä¸€ä¸ªé”ï¼Œç³»ç»Ÿæ€§èƒ½ä¼šå¾ˆå·®ï¼ˆä¸²è¡Œæ‰§è¡Œï¼Œæ•ˆç‡æä½ï¼‰</p>
<p>âœ… æ­£ç¡®æ–¹å¼ï¼šåªå¯¹åŒä¸€ä¸ªç”¨æˆ·åŠ é”</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">synchronized</span>(<span class="params">userId.toString().intern()</span>) &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p><code>.intern()</code> ä¼šè®©å­—ç¬¦ä¸²å¼•ç”¨å˜æˆå¸¸é‡æ± ä¸­çš„å…±äº«å¯¹è±¡ï¼Œç›¸åŒå†…å®¹å°±æ˜¯åŒä¸€ä¸ªé”ã€‚</p>
<p><strong>ä¸ºä»€ä¹ˆç”¨ <code>.intern()</code>ï¼Ÿ</strong></p>
<p>å› ä¸º <code>toString()</code> æ¯æ¬¡æ˜¯æ–°å¯¹è±¡ï¼Œé”ä¸ç”Ÿæ•ˆã€‚</p>
<p>ä½†æ˜¯å› ä¸ºäº‹åŠ¡æ˜¯åœ¨å‡½æ•°æ‰§è¡Œç»“æŸä¹‹åç”±Springè¿›è¡Œæäº¤ï¼Œå¦‚æœæŠŠé”åŠ åœ¨createVoucherOrderå†…éƒ¨å…¶å®æœ‰ç‚¹å°â€”â€”å› ä¸ºå¦‚æœè§£é”ä¹‹åï¼Œå…¶å®ƒçº¿ç¨‹å¯ä»¥è¿›å…¥ï¼Œè€Œæ­¤æ—¶äº‹åŠ¡å°šæœªæäº¤ï¼Œä»ç„¶ä¼šå¯¼è‡´å®‰å…¨æ€§é—®é¢˜ã€‚</p>
<h3 id="ğŸ”-äº‹åŠ¡æ§åˆ¶æ³¨æ„äº‹é¡¹">ğŸ” <strong>äº‹åŠ¡æ§åˆ¶æ³¨æ„äº‹é¡¹</strong></h3>
<p><strong>é—®é¢˜ç‚¹</strong>ï¼šSpring çš„ <code>@Transactional</code> åªå¯¹ä»£ç†å¯¹è±¡ç”Ÿæ•ˆã€‚</p>
<p><strong>é”™è¯¯æ–¹å¼</strong>ï¼šç›´æ¥åœ¨å½“å‰ç±»ä¸­å†…éƒ¨è°ƒç”¨ <code>createVoucherOrder()</code>ï¼Œäº‹åŠ¡ä¸ç”Ÿæ•ˆï¼</p>
<p><strong>è§£å†³æ–¹å¼</strong>ï¼š</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IVoucherOrderService proxy <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy()<span class="comment">;</span></span><br><span class="line">return proxy.createVoucherOrder(voucherId)<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>è¿™å°±æ˜¯ç”¨å½“å‰çº¿ç¨‹çš„ä»£ç†å¯¹è±¡æ¥è°ƒç”¨æ–¹æ³•ï¼Œäº‹åŠ¡æ‰èƒ½èµ·ä½œç”¨ã€‚</p>
<p><strong>å› æ­¤æœ€ç»ˆæ–¹æ¡ˆ</strong>æ˜¯æŠŠsynchronizedåŠ åœ¨createVoucherOrderçš„æ–¹æ³•å¤–éƒ¨ï¼Œé”ä½çš„æ˜¯ç”¨æˆ·idã€‚</p>
<p><code>seckillVoucher()</code> æ–¹æ³•ï¼ˆå¤–å±‚é€»è¾‘ + åŠ é” + äº‹åŠ¡ä»£ç†è°ƒç”¨ï¼‰</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">synchronized (userId.toString().intern()) &#123;</span><br><span class="line">    IVoucherOrderService proxy <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy()<span class="comment">;</span></span><br><span class="line">    return proxy.createVoucherOrder(voucherId)<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="createVoucherOrder-æ–¹æ³•ï¼ˆçœŸæ­£åˆ›å»ºè®¢å•çš„é€»è¾‘ï¼Œå¸¦äº‹åŠ¡ï¼‰"><code>createVoucherOrder()</code> æ–¹æ³•ï¼ˆçœŸæ­£åˆ›å»ºè®¢å•çš„é€»è¾‘ï¼Œå¸¦äº‹åŠ¡ï¼‰</h4>
<ul>
<li>å…ˆæŸ¥è¯¢æ˜¯å¦å·²ç»æœ‰è®¢å•ï¼ˆä¿è¯ä¸€äººä¸€å•ï¼‰ã€‚</li>
<li>å¦‚æœæ²¡æœ‰ï¼Œå†æ‰£åº“å­˜ã€‚</li>
<li>ç„¶ååˆ›å»ºè®¢å•å¹¶ä¿å­˜ã€‚</li>
</ul>
<p>æ€»ç»“ï¼šå…³äºä»£ç†å¯¹è±¡äº‹åŠ¡çš„é—®é¢˜ï¼šé€šå¸¸æƒ…å†µä¸‹ï¼Œå½“ä¸€ä¸ªä½¿ç”¨äº†@Transactionalæ³¨è§£çš„æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼ŒSpringä¼šä»ä¸Šä¸‹æ–‡ä¸­è·å–ä¸€ä¸ªä»£ç†å¯¹è±¡æ¥ç®¡ç†äº‹åŠ¡ã€‚</p>
<p>ä½†æ˜¯å¦‚æœåŠ @Transactionalæ–¹æ³•æ˜¯è¢«åŒä¸€ä¸ªç±»ä¸­çš„å¦ä¸€ä¸ªæ–¹æ³•è°ƒç”¨æ—¶ï¼ŒSpringä¸ä¼šä½¿ç”¨ä»£ç†å¯¹è±¡ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå¯¼è‡´äº‹åŠ¡æ³¨è§£å¤±æ•ˆã€‚</p>
<p>ä¸ºé¿å…è¿™ç§æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨AopContext.currentProxyæ–¹æ³•è·å–å½“å‰çš„ä»£ç†å¯¹è±¡ï¼Œç„¶åé€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨è¢«@Transactionalæ³¨è§£ä¿®é¥°çš„æ–¹æ³•ï¼Œç¡®ä¿äº‹åŠ¡ç”Ÿæ•ˆã€‚</p>
<p>åœ¨VoucherOrderServiceImplä¸­å†™å…¥å¦‚ä¸‹ä»£ç ï¼ˆæ³¨æ„ï¼šctrl+alt+må¯ä»¥æŠŠå«æœ‰returnçš„ä»£ç æ®µè¿›è¡Œæå–ï¼‰ï¼š</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VoucherOrderServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">VoucherOrderMapper</span>, <span class="title">VoucherOrder</span>&gt; <span class="keyword">implements</span> <span class="title">IVoucherOrderService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisIdWorker redisIdWorker;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">Result <span class="title">seckillVoucher</span><span class="params">(Long voucherId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1.æŸ¥è¯¢ä¼˜æƒ åˆ¸ä¿¡æ¯</span></span><br><span class="line">        SeckillVoucher voucher = seckillVoucherService.getById(voucherId);</span><br><span class="line">        <span class="comment">//2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">        <span class="comment">//2.1ç§’æ€å°šæœªå¼€å§‹è¿”å›å¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">if</span>(voucher.getBeginTime().isAfter(LocalDateTime.now()))&#123;</span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//2.2ç§’æ€å·²ç»“æŸè¿”å›å¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">if</span>(voucher.getEndTime().isBefore(LocalDateTime.now()))&#123;</span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸ&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        voucher = seckillVoucherService.getById(voucherId);</span><br><span class="line">        <span class="comment">//3.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">        <span class="keyword">if</span>(voucher.getStock()&lt;<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="comment">//3.1åº“å­˜ä¸è¶³è¿”å›å¼‚å¸¸</span></span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Long userId = UserHolder.getUser().getId();</span><br><span class="line">        <span class="keyword">synchronized</span> (userId.toString().intern())&#123;</span><br><span class="line">            <span class="comment">//è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line">            IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">            <span class="function"><span class="keyword">return</span> proxy.<span class="title">createVoucherOrder</span><span class="params">(voucherId)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">Result <span class="title">createVoucherOrder</span><span class="params">(Long voucherId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//6.ä¸€äººä¸€å•</span></span><br><span class="line">        Long userId = UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//6.1æŸ¥è¯¢è®¢å•</span></span><br><span class="line">        <span class="keyword">int</span> count = query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();</span><br><span class="line">        <span class="comment">//6.2åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">        <span class="keyword">if</span>(count&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">//ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span></span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.2åº“å­˜å……è¶³æ‰£å‡åº“å­˜</span></span><br><span class="line">        <span class="keyword">boolean</span> success = seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>) <span class="comment">//ç›¸å½“äºsetæ¡ä»¶ set stock = stock - 1</span></span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId) <span class="comment">//ç›¸å½“äºwhereæ¡ä»¶ where id = ? and stock = ?</span></span><br><span class="line">                .gt(<span class="string">&quot;stock&quot;</span>,<span class="number">0</span>).update();</span><br><span class="line">        <span class="keyword">if</span>(!success)&#123;</span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//4.åˆ›å»ºè®¢å•ï¼Œè¿”å›è®¢å•id</span></span><br><span class="line">        VoucherOrder voucherOrder = <span class="keyword">new</span> VoucherOrder();</span><br><span class="line">        <span class="keyword">long</span> orderId = redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);<span class="comment">//è®¢å•id</span></span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        voucherOrder.setUserId(userId);</span><br><span class="line">        voucherOrder.setVoucherId(voucherId);<span class="comment">//ä»£é‡‘åˆ¸id</span></span><br><span class="line">        save(voucherOrder);</span><br><span class="line">        <span class="function"><span class="keyword">return</span> Result.<span class="title">ok</span><span class="params">(orderId)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨IVoucherOrderServiceæ¥å£ä¸­åŠ å…¥ä¸‹é¢è¿™ä¸ªæ–¹æ³•ï¼š</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable"><span class="class">Result</span></span> <span class="function"><span class="title">createVoucherOrder</span>(<span class="variable">Long</span> <span class="variable">voucherId</span>);</span></span><br></pre></td></tr></table></figure>
<p>åœ¨pom.xmlä¸­å¼•å…¥å¦‚ä¸‹çš„ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>åœ¨å¯åŠ¨ç±»HmDianPingApplicationä¸ŠåŠ å¦‚ä¸‹æ³¨è§£ï¼š</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAspectJAutoProxy</span>(exposeProxy = <span class="keyword">true</span>)</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ï¼š æˆåŠŸå®ç°ä¸€åç”¨æˆ·åªèƒ½é¢†å–ä¸€å¼ ä¼˜æƒ åˆ¸ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-157-1024x137.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-158-1024x111.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-159.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-160.png" alt="img"></p>
<h3 id="3-8-é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜">3.8 é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜</h3>
<p>é€šè¿‡åŠ é”å¯ä»¥è§£å†³åœ¨å•æœºæƒ…å†µä¸‹çš„ä¸€äººä¸€å•å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯åœ¨é›†ç¾¤æ¨¡å¼ä¸‹å°±ä¸è¡Œäº†ã€‚</p>
<p>å¦‚ä¸‹å›¾å¯ä»¥è®¾ç½®é¡¹ç›®å¯åŠ¨çš„ç«¯å£å·ï¼Œç¡®ä¿å¯åŠ¨çš„é¡¹ç›®ä¹‹é—´ç«¯å£å·ä¸åŒ:</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-164.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-163.png" alt="img"></p>
<p>åœ¨nginx.confä¸­æ”¾å¼€8082çš„è¿™ä¸ªé…ç½®ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-165.png" alt="img"></p>
<p>å‘ä¸‹é¢è¿™ä¸ªé¡µé¢å‘é€è¯·æ±‚ï¼š</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost:<span class="number">8080</span><span class="regexp">/api/</span>voucher<span class="regexp">/list/</span><span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è¯·æ±‚ä¼šåˆ†åˆ«è¢«8082å’Œ8081æ¥æ”¶ï¼Œæ˜¯è½®è¯¢çš„æ•ˆæœï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-166.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-167.png" alt="img"></p>
<p>é¦–å…ˆåˆ°tb_voucher_orderæŠŠä¹‹å‰çš„è®¢å•åˆ é™¤ï¼Œåˆ°tb_seckill_voucherä¸­æŠŠstocké‡æ–°æ”¹å›100ã€‚</p>
<p>å‡†å¤‡2ä¸ªç›¸åŒçš„ç§’æ€è¯·æ±‚ï¼šè¦æ³¨æ„è¯·æ±‚çš„åœ°å€æ˜¯ï¼š<a target="_blank" rel="noopener" href="http://localhost:8080/api/voucher-order/seckill/13">http://localhost:8080/api/voucher-order/seckill/13</a></p>
<p>æˆ‘è¿™é‡Œç›´æ¥ç”¨Jemeteræ¥è¿›è¡Œæµ‹è¯•ï¼Œæ¨¡æ‹Ÿé«˜å¹¶å‘åœºæ™¯ï¼š</p>
<p>ä¸‹é¢æ˜¯æ•ˆæœï¼šå¯ä»¥çœ‹åˆ°å¹¶å‘è¯·æ±‚èƒ½å¤ŸåŒæ—¶è¿›å…¥é›†ç¾¤çš„æ¯å°ç»“ç‚¹ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-169.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-170.png" alt="img"></p>
<p>æ­£å¸¸æƒ…å†µï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-172.png" alt="img"></p>
<h3 id="å•æœºä¸‹çš„é”æ§åˆ¶ï¼ˆç¬¬ä¸€å¼ å›¾ï¼‰">å•æœºä¸‹çš„é”æ§åˆ¶ï¼ˆç¬¬ä¸€å¼ å›¾ï¼‰</h3>
<p>è¿™ä¸€å¼ å›¾å±•ç¤ºäº†å¤šä¸ªçº¿ç¨‹åœ¨åŒä¸€ä¸ª JVM ä¸­æ“ä½œçš„åœºæ™¯ï¼Œç”¨æ¥è¯´æ˜å•æœºä¸‹é€šè¿‡ <code>synchronized</code> é”å¯¹è±¡æ§åˆ¶ä¸€äººä¸€å•çš„æœºåˆ¶ <strong>æ˜¯æœ‰æ•ˆçš„</strong>ã€‚</p>
<h4 id="âœ…-å…³é”®æµç¨‹ï¼š">âœ… å…³é”®æµç¨‹ï¼š</h4>
<ol>
<li><strong>çº¿ç¨‹1 å’Œ çº¿ç¨‹2</strong> åˆ†åˆ«å°è¯•ä¸ºåŒä¸€ç”¨æˆ·ä¸‹è®¢å•ã€‚</li>
<li>çº¿ç¨‹1 æ‹¿åˆ°äº†é”ï¼Œæ‰§è¡Œå®Œâ€œæŸ¥è¯¢æ˜¯å¦å·²æœ‰è®¢å•â€ï¼Œåˆ¤æ–­æ²¡æœ‰ï¼Œäºæ˜¯åˆ›å»ºæ–°è®¢å•ï¼Œé‡Šæ”¾é”ã€‚</li>
<li>çº¿ç¨‹2 æ­¤æ—¶ç­‰å¾…çº¿ç¨‹1é‡Šæ”¾é”ï¼Œå†åšåŒæ ·çš„æµç¨‹ã€‚</li>
<li>ä½†çº¿ç¨‹2æ‰§è¡Œåˆ°æŸ¥è¯¢è®¢å•æ—¶ï¼Œå·²ç»èƒ½æŸ¥åˆ°è®¢å•ï¼Œ<strong>æ‰€ä»¥ä¸ä¼šé‡å¤ä¸‹å•</strong>ã€‚</li>
</ol>
<h4 id="âœ…-ç»“è®ºï¼š">âœ… ç»“è®ºï¼š</h4>
<blockquote>
<p>å• JVM ä¸‹ï¼ŒåŒä¸€ä¸ªç”¨æˆ·åŠ é”æ˜¯ç”Ÿæ•ˆçš„ï¼Œèƒ½æœ‰æ•ˆé˜²æ­¢å¹¶å‘æ—¶çš„é‡å¤ä¸‹å•ã€‚</p>
</blockquote>
<p>ç”±äºç°åœ¨æˆ‘ä»¬éƒ¨ç½²äº†å¤šä¸ªtomcatï¼Œæ¯ä¸ªtomcatéƒ½æœ‰ä¸€ä¸ªå±äºè‡ªå·±çš„jvmï¼Œé‚£ä¹ˆå‡è®¾åœ¨æœåŠ¡å™¨Açš„tomcatå†…éƒ¨ï¼Œæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹ç”±äºä½¿ç”¨çš„æ˜¯åŒä¸€ä»½ä»£ç ï¼Œé‚£ä¹ˆä»–ä»¬çš„é”å¯¹è±¡æ˜¯åŒä¸€ä¸ªï¼Œæ˜¯å¯ä»¥å®ç°äº’æ–¥çš„ï¼Œä½†æ˜¯å¦‚æœç°åœ¨æ˜¯æœåŠ¡å™¨Bçš„tomcatå†…éƒ¨ï¼Œåˆæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯ä»–ä»¬çš„é”å¯¹è±¡å†™çš„è™½ç„¶å’ŒæœåŠ¡å™¨Aä¸€æ ·ï¼Œä½†æ˜¯é”å¯¹è±¡å´ä¸æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥çº¿ç¨‹3å’Œçº¿ç¨‹4å¯ä»¥å®ç°äº’æ–¥ï¼Œä½†æ˜¯å´æ— æ³•å’Œçº¿ç¨‹1å’Œçº¿ç¨‹2å®ç°äº’æ–¥ï¼Œè¿™å°±æ˜¯ é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œsyné”å¤±æ•ˆçš„åŸå› ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-173.png" alt="img"></p>
<h3 id="âŒ-é›†ç¾¤ä¸‹çš„é”å¤±æ•ˆé—®é¢˜ï¼ˆç¬¬äºŒå¼ å›¾ï¼‰">âŒ é›†ç¾¤ä¸‹çš„é”å¤±æ•ˆé—®é¢˜ï¼ˆç¬¬äºŒå¼ å›¾ï¼‰</h3>
<h4 id="å·¦ä¾§ï¼šJVM1ï¼ˆTomcat-Aï¼‰">å·¦ä¾§ï¼šJVM1ï¼ˆTomcat Aï¼‰</h4>
<ul>
<li>çº¿ç¨‹1 åŠ é”æˆåŠŸï¼Œæ­£åœ¨ä¸‹å•ï¼›</li>
<li>çº¿ç¨‹2 æ¥äº†ï¼Œåœ¨ç­‰å¾…é‡Šæ”¾é”ã€‚</li>
</ul>
<h4 id="å³ä¾§ï¼šJVM2ï¼ˆTomcat-Bï¼‰">å³ä¾§ï¼šJVM2ï¼ˆTomcat Bï¼‰</h4>
<ul>
<li>çº¿ç¨‹3 æ˜¯åŒä¸€ä¸ªç”¨æˆ·çš„è¯·æ±‚ï¼Œä½†ç”±äº JVM2 çš„é”å¯¹è±¡å’Œ JVM1 çš„é”å¯¹è±¡<strong>ä¸æ˜¯åŒä¸€ä¸ªå®ä¾‹</strong>ï¼Œæ‰€ä»¥ä¹Ÿèƒ½åŠ é”æˆåŠŸï¼›</li>
<li>åŒæ ·çº¿ç¨‹4 è·Ÿè¿›ç­‰å¾…çº¿ç¨‹3ï¼›</li>
</ul>
<h4 id="ğŸ§¨-é—®é¢˜äº§ç”Ÿï¼š">ğŸ§¨ é—®é¢˜äº§ç”Ÿï¼š</h4>
<p>è™½ç„¶çº¿ç¨‹1å’Œçº¿ç¨‹3é”çš„<strong>ä»£ç </strong>çœ‹èµ·æ¥æ˜¯ä¸€æ ·çš„ï¼Œä½†å› ä¸º<strong>JVMä¸ä¸€æ ·ï¼Œé”å¯¹è±¡ä¸æ˜¯åŒä¸€ä¸ª</strong>ï¼Œæ‰€ä»¥çº¿ç¨‹3å¹¶ä¸çŸ¥é“çº¿ç¨‹1å·²ç»åœ¨å¤„ç†ä¸‹å•é€»è¾‘äº†ã€‚</p>
<p>ç»“æœï¼š</p>
<ul>
<li>JVM1 å’Œ JVM2 å„è‡ªéƒ½åˆ›å»ºäº†ä¸€ä»½è®¢å•ï¼Œ<strong>è¿åäº†ä¸€äººä¸€å•çš„è§„åˆ™</strong>ï¼</li>
</ul>
<p>ç°åœ¨å°±è¦å®ç°è®©å¤šä¸ªJVMä½¿ç”¨çš„æ˜¯åŒä¸€æŠŠé”ã€‚è·¨JVMã€è·¨è¿›ç¨‹çš„é”ã€‚</p>
<h2 id="4ã€åˆ†å¸ƒå¼é”">4ã€åˆ†å¸ƒå¼é”</h2>
<h3 id="4-1-ã€åŸºæœ¬åŸç†å’Œå®ç°æ–¹å¼å¯¹æ¯”">4.1 ã€åŸºæœ¬åŸç†å’Œå®ç°æ–¹å¼å¯¹æ¯”</h3>
<p>ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”?</p>
<p>æ»¡è¶³åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–é›†ç¾¤æ¨¡å¼ä¸‹å¤šè¿›ç¨‹å¯è§å¹¶ä¸”äº’æ–¥çš„é”.(æ‰€æœ‰æœåŠ¡å™¨éƒ½èƒ½è®¿é—®çš„å…±äº«é”ç³»ç»Ÿ)</p>
<p>åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯è®©å¤§å®¶éƒ½ä½¿ç”¨åŒä¸€æŠŠé”ï¼Œåªè¦å¤§å®¶ä½¿ç”¨çš„æ˜¯åŒä¸€æŠŠé”ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½é”ä½çº¿ç¨‹ï¼Œä¸è®©çº¿ç¨‹è¿›è¡Œï¼Œè®©ç¨‹åºä¸²è¡Œæ‰§è¡Œï¼Œè¿™å°±æ˜¯åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæ€è·¯</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-174.png" alt="img"></p>
<p>é‚£ä¹ˆåˆ†å¸ƒå¼é”ä»–åº”è¯¥æ»¡è¶³ä¸€äº›ä»€ä¹ˆæ ·çš„æ¡ä»¶å‘¢ï¼Ÿ</p>
<ul>
<li>å¯è§æ€§ï¼šå¤šä¸ªçº¿ç¨‹éƒ½èƒ½çœ‹åˆ°ç›¸åŒçš„ç»“æœï¼Œæ³¨æ„ï¼šè¿™ä¸ªåœ°æ–¹è¯´çš„å¯è§æ€§å¹¶ä¸æ˜¯å¹¶å‘ç¼–ç¨‹ä¸­æŒ‡çš„å†…å­˜å¯è§æ€§ï¼Œåªæ˜¯è¯´å¤šä¸ªè¿›ç¨‹ä¹‹é—´éƒ½èƒ½æ„ŸçŸ¥åˆ°å˜åŒ–çš„æ„æ€</li>
<li>äº’æ–¥ï¼šäº’æ–¥æ˜¯åˆ†å¸ƒå¼é”çš„æœ€åŸºæœ¬çš„æ¡ä»¶ï¼Œä½¿å¾—ç¨‹åºä¸²è¡Œæ‰§è¡Œ</li>
<li>é«˜å¯ç”¨ï¼šç¨‹åºä¸æ˜“å´©æºƒï¼Œæ—¶æ—¶åˆ»åˆ»éƒ½ä¿è¯è¾ƒé«˜çš„å¯ç”¨æ€§</li>
<li>é«˜æ€§èƒ½ï¼šç”±äºåŠ é”æœ¬èº«å°±è®©æ€§èƒ½é™ä½ï¼Œæ‰€æœ‰å¯¹äºåˆ†å¸ƒå¼é”æœ¬èº«éœ€è¦ä»–å°±è¾ƒé«˜çš„åŠ é”æ€§èƒ½å’Œé‡Šæ”¾é”æ€§èƒ½</li>
<li>å®‰å…¨æ€§ï¼šå®‰å…¨ä¹Ÿæ˜¯ç¨‹åºä¸­å¿…ä¸å¯å°‘çš„ä¸€ç¯</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-175.png" alt="img"></p>
<p>å¸¸è§çš„åˆ†å¸ƒå¼é”æœ‰ä¸‰ç§</p>
<ul>
<li>Mysqlï¼šmysqlæœ¬èº«å°±å¸¦æœ‰é”æœºåˆ¶ï¼Œä½†æ˜¯ç”±äºmysqlæ€§èƒ½æœ¬èº«ä¸€èˆ¬ï¼Œæ‰€ä»¥é‡‡ç”¨åˆ†å¸ƒå¼é”çš„æƒ…å†µä¸‹ï¼Œå…¶å®ä½¿ç”¨mysqlä½œä¸ºåˆ†å¸ƒå¼é”æ¯”è¾ƒå°‘è§</li>
<li>Redisï¼šredisä½œä¸ºåˆ†å¸ƒå¼é”æ˜¯éå¸¸å¸¸è§çš„ä¸€ç§ä½¿ç”¨æ–¹å¼ï¼Œç°åœ¨ä¼ä¸šçº§å¼€å‘ä¸­åŸºæœ¬éƒ½ä½¿ç”¨redisæˆ–è€…zookeeperä½œä¸ºåˆ†å¸ƒå¼é”ï¼Œåˆ©ç”¨setnxè¿™ä¸ªæ–¹æ³•ï¼Œå¦‚æœæ’å…¥keyæˆåŠŸï¼Œåˆ™è¡¨ç¤ºè·å¾—åˆ°äº†é”ï¼Œå¦‚æœæœ‰äººæ’å…¥æˆåŠŸï¼Œå…¶ä»–äººæ’å…¥å¤±è´¥åˆ™è¡¨ç¤ºæ— æ³•è·å¾—åˆ°é”ï¼Œåˆ©ç”¨è¿™å¥—é€»è¾‘æ¥å®ç°åˆ†å¸ƒå¼é”</li>
<li>Zookeeperï¼šzookeeperä¹Ÿæ˜¯ä¼ä¸šçº§å¼€å‘ä¸­è¾ƒå¥½çš„ä¸€ä¸ªå®ç°åˆ†å¸ƒå¼é”çš„æ–¹æ¡ˆï¼Œç”±äºæœ¬å¥—è§†é¢‘å¹¶ä¸è®²è§£zookeeperçš„åŸç†å’Œåˆ†å¸ƒå¼é”çš„å®ç°ï¼Œæ‰€ä»¥ä¸è¿‡å¤šé˜è¿°</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-176.png" alt="img"></p>
<h3 id="4-2-ã€Redisåˆ†å¸ƒå¼é”çš„å®ç°æ ¸å¿ƒæ€è·¯">4.2 ã€Redisåˆ†å¸ƒå¼é”çš„å®ç°æ ¸å¿ƒæ€è·¯</h3>
<p>ä½ å¯ä»¥æŠŠå®ƒç†è§£æˆåœ¨ Redis é‡Œâ€œå ä¸€ä¸ªä½ç½®â€ï¼Œè°å…ˆå ä¸Šå°±æœ‰æ‰§è¡Œæƒï¼Œå…¶å®ƒäººå°±å¾—ç­‰ã€‚</p>
<p>å®ç°åˆ†å¸ƒå¼é”æ—¶éœ€è¦å®ç°çš„ä¸¤ä¸ªåŸºæœ¬æ–¹æ³•ï¼š</p>
<h4 id="4-2-1å®ç°-Redis-é”æœ€æ ¸å¿ƒçš„å°±ä¸¤ä¸ªæŒ‡ä»¤ï¼š">4.2.1å®ç° Redis é”æœ€æ ¸å¿ƒçš„å°±ä¸¤ä¸ªæŒ‡ä»¤ï¼š</h4>
<p><strong>1. <code>SETNX</code>ï¼ˆSet if Not Existsï¼‰</strong></p>
<figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SETNX <span class="keyword">lock</span> thread1</span><br></pre></td></tr></table></figure>
<p>æ„æ€æ˜¯ï¼šâ€œå¦‚æœè¿™ä¸ª <code>lock</code> é”®ä¸å­˜åœ¨ï¼Œå°±è®¾ç½®ä¸º <code>thread1</code>ã€‚â€</p>
<ul>
<li><strong>æˆåŠŸè¿”å› 1</strong>ï¼šè¯´æ˜ä½ æ‹¿åˆ°é”äº†ï¼›</li>
<li><strong>å¤±è´¥è¿”å› 0</strong>ï¼šè¯´æ˜åˆ«äººå·²ç»æŠ¢å…ˆæ‹¿åˆ°é”ã€‚</li>
</ul>
<h3 id="2-DELï¼šé‡Šæ”¾é”">2. <code>DEL</code>ï¼šé‡Šæ”¾é”</h3>
<figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEL <span class="keyword">lock</span></span><br></pre></td></tr></table></figure>
<p>é‡Šæ”¾é”ï¼Œè¡¨ç¤ºä»»åŠ¡åšå®Œäº†ï¼Œåˆ«äººå¯ä»¥æ¥äº†ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-177.png" alt="img"></p>
<h4 id="4-2-2è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé¿å…æ­»é”">4.2.2è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé¿å…æ­»é”</h4>
<h3 id="ä¸ºä»€ä¹ˆéœ€è¦åŠ -EXPIREï¼Ÿ">ä¸ºä»€ä¹ˆéœ€è¦åŠ  <code>EXPIRE</code>ï¼Ÿ</h3>
<p>å‡è®¾ï¼š</p>
<ul>
<li>çº¿ç¨‹1 æ‹¿åˆ°äº†é”ï¼›</li>
<li>ä½†å®ƒå´©æºƒäº†ï¼Œæ²¡æ¥å¾—åŠé‡Šæ”¾é”ï¼ˆ<code>DEL</code> æ²¡æ‰§è¡Œï¼‰ï¼›</li>
<li>é‚£è¿™æŠŠé”å°±<strong>æ°¸è¿œå¡åœ¨é‚£é‡Œ</strong>äº†ï¼Œåˆ«äººéƒ½æ‹¿ä¸åˆ°ï¼</li>
</ul>
<p>è§£å†³åŠæ³•ï¼š<strong>è®¾ç½®é”çš„è‡ªåŠ¨è¿‡æœŸæ—¶é—´</strong>ï¼Œä¾‹å¦‚ 5 ç§’é’Ÿï¼š</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">EXPIRE</span> lock <span class="number">5</span></span><br></pre></td></tr></table></figure>
<p>ç„¶åå¯ä»¥ç”¨ <code>TTL lock</code> æŸ¥çœ‹é”å‰©ä¸‹å¤šå°‘ç§’ï¼š</p>
<ul>
<li>æ­£å¸¸è¿”å›å‰©ä½™æ—¶é—´ï¼›</li>
<li>å¦‚æœè¿”å› -1ï¼Œè¯´æ˜æ²¡æœ‰è¿‡æœŸæ—¶é—´ï¼Œä¼šæ­»é”ï¼›</li>
<li>å¦‚æœè¿”å› -2ï¼Œè¯´æ˜é”å·²ç»ä¸å­˜åœ¨ã€‚</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-178.png" alt="img"></p>
<h4 id="4-2-3é¿å…-SETNX-å’Œ-EXPIRE-ä¹‹é—´çš„é—´éš™">4.2.3é¿å… <code>SETNX</code> å’Œ <code>EXPIRE</code> ä¹‹é—´çš„é—´éš™</h4>
<p>é—®é¢˜æ¥äº†ï¼š<br>
å¦‚æœä½ åˆ†ä¸¤æ­¥æ‰§è¡Œâ€”â€”å…ˆ <code>SETNX</code> æ‹¿é”ï¼Œå† <code>EXPIRE</code> è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œåœ¨è¿™ä¸­é—´ä¸€æ—¦å®•æœºï¼Œå°±ä¼šå‡ºé—®é¢˜ã€‚</p>
<p>æ­£ç¡®åšæ³•ï¼šç”¨ Redis çš„ä¸€æ¡åŸå­æŒ‡ä»¤</p>
<figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">lock</span> thread EX <span class="number">10</span> NX</span><br></pre></td></tr></table></figure>
<p>è§£é‡Šï¼š</p>
<ul>
<li><code>EX 10</code>ï¼šè®¾ç½®è¿‡æœŸæ—¶é—´ 10 ç§’ï¼›</li>
<li><code>NX</code>ï¼šåªæœ‰åœ¨ key ä¸å­˜åœ¨æ—¶æ‰è®¾ç½®ï¼›</li>
<li>è¿™æ˜¯ Redis çš„åŸå­æ“ä½œï¼Œ<strong>è®¾ç½®å€¼+è¿‡æœŸ+äº’æ–¥ä¸€æ¬¡å®Œæˆ</strong>ï¼</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-179.png" alt="img"></p>
<p>åŠ é”æ•ˆæœæ¼”ç¤º</p>
<figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">lock</span> thread EX <span class="number">10</span> NXOK</span><br></pre></td></tr></table></figure>
<p>è¯´æ˜åŠ é”æˆåŠŸã€‚</p>
<figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">lock</span> thread EX <span class="number">10</span> NXnull</span><br></pre></td></tr></table></figure>
<p>è¯´æ˜é”å·²å­˜åœ¨ï¼ŒåŠ é”å¤±è´¥ã€‚</p>
<figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TTL <span class="keyword">lock</span></span><br><span class="line"><span class="number">7</span></span><br></pre></td></tr></table></figure>
<p>è¯´æ˜é”è¿˜æœ‰ 7 ç§’å°±ä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚</p>
<h4 id="4-2-4åŠ é”ä¸é‡Šæ”¾çš„æ­£ç¡®æµç¨‹æ€»ç»“">4.2.4åŠ é”ä¸é‡Šæ”¾çš„æ­£ç¡®æµç¨‹æ€»ç»“</h4>
<ul>
<li>è·å–é”ï¼š
<ul>
<li>äº’æ–¥æ€§ï¼šç¡®ä¿åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–é”æˆåŠŸ</li>
<li>éé˜»å¡ï¼šå°è¯•ä¸€æ¬¡ï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›false</li>
<li>è‡ªåŠ¨è¿‡æœŸï¼šé¿å…æ­»é”</li>
</ul>
</li>
<li>é‡Šæ”¾é”ï¼š
<ul>
<li>æ‰‹åŠ¨é‡Šæ”¾ï¼ˆä¸šåŠ¡å®Œæˆå <code>DEL</code>ï¼‰</li>
<li>è¶…æ—¶é‡Šæ”¾ï¼šè·å–é”æ—¶æ·»åŠ ä¸€ä¸ªè¶…æ—¶æ—¶é—´</li>
</ul>
</li>
</ul>
<h3 id="4-3-å®ç°åˆ†å¸ƒå¼é”ç‰ˆæœ¬ä¸€">4.3 å®ç°åˆ†å¸ƒå¼é”ç‰ˆæœ¬ä¸€</h3>
<p>åœ¨utilsä¸‹é¢åˆ›å»ºä¸€ä¸ªILockæ¥å£ï¼š</p>
<p>è¿™ä¸€æ­¥æ˜¯åšæ¥å£ç¼–ç¨‹ï¼Œä¾¿äºåæœŸæ‰©å±•ï¼ˆæ¯”å¦‚æ¢ Redisson æˆ– ZooKeeper é”æ—¶ï¼Œä¸æ”¹ä¸šåŠ¡é€»è¾‘ï¼‰</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ILock</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å°è¯•è·å–é”</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(<span class="keyword">long</span> timeoutSec)</span></span>;</span><br><span class="line">    <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨utilsä¸‹é¢å®ç°SimpleRedisLockç±»ï¼š</p>
<h3 id="ç»†èŠ‚è§£é‡Šï¼š">ç»†èŠ‚è§£é‡Šï¼š</h3>
<ul>
<li><code>threadId</code>ï¼šå½“å‰çº¿ç¨‹çš„å”¯ä¸€æ ‡è¯†ï¼Œè®¾ç½®ä¸ºé”çš„å€¼ï¼Œä¾¿äºåæœŸæ‰©å±•å®‰å…¨æ€§ï¼›</li>
<li><code>setIfAbsent</code>ï¼šå°±æ˜¯ Redis çš„ <code>SET key value NX EX</code> æ“ä½œï¼›</li>
<li><code>timeoutSec</code>ï¼šè‡ªåŠ¨è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é”ï¼›</li>
<li><code>delete</code>ï¼šé‡Šæ”¾é”ï¼Œç›´æ¥åˆ æ‰å¯¹åº” Redis keyã€‚</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleRedisLock</span> <span class="keyword">implements</span> <span class="title class_">ILock</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> name;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">StringRedisTemplate</span> stringRedisTemplate;</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">SimpleRedisLock</span>(<span class="title class_">String</span> name, <span class="title class_">StringRedisTemplate</span> stringRedisTemplate) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">stringRedisTemplate</span> = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> final <span class="title class_">String</span> <span class="variable constant_">KEY_PREFIX</span> = <span class="string">&quot;lock:&quot;</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">boolean</span> <span class="title function_">tryLock</span>(<span class="params">long timeoutSec</span>) &#123;</span><br><span class="line">        <span class="comment">//è·å–çº¿ç¨‹æ ‡ç¤º</span></span><br><span class="line">        long threadId = <span class="title class_">Thread</span>.<span class="title function_">currentThread</span>().<span class="title function_">getId</span>();</span><br><span class="line">        <span class="title class_">Boolean</span> success = stringRedisTemplate.<span class="title function_">opsForValue</span>().<span class="title function_">setIfAbsent</span>(<span class="variable constant_">KEY_PREFIX</span>+name,threadId+<span class="string">&quot;&quot;</span>,timeoutSec, <span class="title class_">TimeUnit</span>.<span class="property">SECONDS</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Boolean</span>.<span class="property">TRUE</span>.<span class="title function_">equals</span>(success);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">unlock</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">        stringRedisTemplate.<span class="title function_">delete</span>(<span class="variable constant_">KEY_PREFIX</span>+name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ›´æ”¹VoucherOrderServiceImplç±»ä¸­çš„seckillVoucheræ–¹æ³•çš„ä»£ç ï¼š</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedisIdWorker redisIdWorker;</span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function">Result <span class="title">seckillVoucher</span><span class="params">(Long voucherId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1.æŸ¥è¯¢ä¼˜æƒ åˆ¸ä¿¡æ¯</span></span><br><span class="line">    SeckillVoucher voucher = seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">//2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">    <span class="comment">//2.1ç§’æ€å°šæœªå¼€å§‹è¿”å›å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span>(voucher.getBeginTime().isAfter(LocalDateTime.now()))&#123;</span><br><span class="line">        <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹&quot;</span>)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.2ç§’æ€å·²ç»“æŸè¿”å›å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span>(voucher.getEndTime().isBefore(LocalDateTime.now()))&#123;</span><br><span class="line">        <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸ&quot;</span>)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    voucher = seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">//3.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">    <span class="keyword">if</span>(voucher.getStock()&lt;<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="comment">//3.1åº“å­˜ä¸è¶³è¿”å›å¼‚å¸¸</span></span><br><span class="line">        <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Long userId = UserHolder.getUser().getId();</span><br><span class="line">    SimpleRedisLock lock = <span class="keyword">new</span> SimpleRedisLock(<span class="string">&quot;order:&quot;</span>+userId,stringRedisTemplate);</span><br><span class="line">    <span class="keyword">boolean</span> isLock = lock.tryLock(<span class="number">1200</span>);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span>(!isLock) &#123;</span><br><span class="line">        <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;</span>)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line">        IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">        <span class="function"><span class="keyword">return</span> proxy.<span class="title">createVoucherOrder</span><span class="params">(voucherId)</span></span>;</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ ¸å¿ƒä»£ç ï¼š</strong></p>
<p>åœ¨ <code>VoucherOrderServiceImpl</code> é‡Œæ›¿æ¢åŸæ¥çš„åŠ é”æ–¹å¼ï¼Œæ”¹ç”¨ <code>SimpleRedisLock</code>ï¼š</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SimpleRedisLock <span class="keyword">lock</span> = <span class="built_in">new</span> SimpleRedisLock(&quot;order:&quot; + userId, stringRedisTemplate);</span><br><span class="line"><span class="type">boolean</span> isLock = <span class="keyword">lock</span>.tryLock(<span class="number">1200</span>);</span><br></pre></td></tr></table></figure>
<p>å¦‚æœåŠ é”æˆåŠŸï¼Œå°±è°ƒç”¨ä»£ç†å¯¹è±¡åˆ›å»ºè®¢å•ï¼›å¤±è´¥å°±è¯´æ˜è¿™ä¸ªç”¨æˆ·å·²ç»åœ¨å¤„ç†ä¸­ï¼Œæ‹’ç»é‡å¤ä¸‹å•ã€‚</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;</span>)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">    <span class="function"><span class="keyword">return</span> proxy.<span class="title">createVoucherOrder</span><span class="params">(voucherId)</span></span>;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»æµ‹è¯•å¤šå°èŠ‚ç‚¹ç›¸åŒç”¨æˆ·åªèƒ½è·å–åŒä¸€å¼ ä¼˜æƒ åˆ¸æˆåŠŸï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-180.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-181.png" alt="img"></p>
<p>ç›®å‰è¿™ä¸ªé”å®ç° <strong>ä»æœ‰é£é™©</strong>ï¼š</p>
<ul>
<li>â—ï¸ç›´æ¥ delete keyï¼Œ<strong>æ²¡æœ‰éªŒè¯æ˜¯å¦æ˜¯è‡ªå·±åŠ çš„é”å°±åˆ äº†</strong>ï¼ˆå®¹æ˜“è¯¯åˆ åˆ«äººçš„é”ï¼‰ï¼›</li>
<li>â—ï¸å¦‚æœæ‰§è¡Œæ—¶é—´è¶…è¿‡äº†è¿‡æœŸæ—¶é—´ï¼ˆæ¯”å¦‚ 2 ç§’ï¼‰ï¼Œé”ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œä½†ä»»åŠ¡è¿˜æ²¡åšå®Œï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å°±å¯èƒ½æŠ¢åˆ°é”å¹¶é‡å¤æ‰§è¡Œï¼</li>
</ul>
<p>è¿™äº›é—®é¢˜åé¢ä¼šé€šè¿‡åŠ <strong>å”¯ä¸€æ ‡è¯† + Lua è„šæœ¬é‡Šæ”¾é”</strong>æ–¹å¼æ”¹è¿›ã€‚</p>
<h3 id="4-4Redisåˆ†å¸ƒå¼é”è¯¯åˆ æƒ…å†µè¯´æ˜">4.4Redisåˆ†å¸ƒå¼é”è¯¯åˆ æƒ…å†µè¯´æ˜</h3>
<p>å¦‚æœä½ æ²¡æœ‰æ ¡éªŒâ€œè¿™æŠŠé”æ˜¯ä¸æ˜¯æˆ‘åŠ çš„â€ï¼Œå°±å¯èƒ½ä¼šå‘ç”Ÿè¿™ç§é”™è¯¯ï¼š</p>
<blockquote>
<p>ä¸€ä¸ªçº¿ç¨‹å› ä¸ºå¡é¡¿æˆ–ç½‘ç»œé—®é¢˜ï¼Œ<strong>ç­‰å®ƒé†’æ¥æ—¶ï¼Œè¿™æŠŠé”å·²ç»è¢«åˆ«äººæ‹¿èµ°äº†ï¼Œä½†å®ƒè¿˜ä»¥ä¸ºæ˜¯è‡ªå·±çš„ï¼Œå°±æŠŠåˆ«äººçš„é”åˆ äº†ï¼</strong></p>
</blockquote>
<p>é€»è¾‘è¯´æ˜ï¼š</p>
<p>æŒæœ‰é”çš„çº¿ç¨‹åœ¨é”çš„å†…éƒ¨å‡ºç°äº†é˜»å¡ï¼Œå¯¼è‡´ä»–çš„é”è‡ªåŠ¨é‡Šæ”¾ï¼Œè¿™æ—¶å…¶ä»–çº¿ç¨‹ï¼Œçº¿ç¨‹2æ¥å°è¯•è·å¾—é”ï¼Œå°±æ‹¿åˆ°äº†è¿™æŠŠé”ï¼Œç„¶åçº¿ç¨‹2åœ¨æŒæœ‰é”æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹1ååº”è¿‡æ¥ï¼Œç»§ç»­æ‰§è¡Œï¼Œè€Œçº¿ç¨‹1æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œèµ°åˆ°äº†åˆ é™¤é”é€»è¾‘ï¼Œæ­¤æ—¶å°±ä¼šæŠŠæœ¬åº”è¯¥å±äºçº¿ç¨‹2çš„é”è¿›è¡Œåˆ é™¤ï¼Œè¿™å°±æ˜¯è¯¯åˆ åˆ«äººé”çš„æƒ…å†µè¯´æ˜</p>
<p>è§£å†³æ–¹æ¡ˆï¼šè§£å†³æ–¹æ¡ˆå°±æ˜¯åœ¨æ¯ä¸ªçº¿ç¨‹é‡Šæ”¾é”çš„æ—¶å€™ï¼Œå»åˆ¤æ–­ä¸€ä¸‹å½“å‰è¿™æŠŠé”æ˜¯å¦å±äºè‡ªå·±ï¼Œå¦‚æœå±äºè‡ªå·±ï¼Œåˆ™ä¸è¿›è¡Œé”çš„åˆ é™¤ï¼Œå‡è®¾è¿˜æ˜¯ä¸Šè¾¹çš„æƒ…å†µï¼Œçº¿ç¨‹1å¡é¡¿ï¼Œé”è‡ªåŠ¨é‡Šæ”¾ï¼Œçº¿ç¨‹2è¿›å…¥åˆ°é”çš„å†…éƒ¨æ‰§è¡Œé€»è¾‘ï¼Œæ­¤æ—¶çº¿ç¨‹1ååº”è¿‡æ¥ï¼Œç„¶ååˆ é™¤é”ï¼Œä½†æ˜¯çº¿ç¨‹1ï¼Œä¸€çœ‹å½“å‰è¿™æŠŠé”ä¸æ˜¯å±äºè‡ªå·±ï¼Œäºæ˜¯ä¸è¿›è¡Œåˆ é™¤é”é€»è¾‘ï¼Œå½“çº¿ç¨‹2èµ°åˆ°åˆ é™¤é”é€»è¾‘æ—¶ï¼Œå¦‚æœæ²¡æœ‰å¡è¿‡è‡ªåŠ¨é‡Šæ”¾é”çš„æ—¶é—´ç‚¹ï¼Œåˆ™åˆ¤æ–­å½“å‰è¿™æŠŠé”æ˜¯å±äºè‡ªå·±çš„ï¼Œäºæ˜¯åˆ é™¤è¿™æŠŠé”ã€‚</p>
<p><strong>æ€»ç»“ä¸€å¥è¯å°±æ˜¯</strong>ï¼š<strong>ä¸è¦ç”¨ <code>delete</code> ç›´æ¥é‡Šæ”¾é”</strong>ï¼Œä¸€å®šè¦æ£€æŸ¥â€œè¿™æŠŠé”æ˜¯ä¸æ˜¯æˆ‘åŠ çš„â€å†åˆ ï¼Œ<strong>ç”¨ Lua è„šæœ¬ä¿è¯åŸå­æ€§</strong>ï¼Œå¦åˆ™å°±ä¼šåœ¨å¤šçº¿ç¨‹æˆ–å¤šæœºå™¨ç¯å¢ƒä¸‹åˆ é”™åˆ«äººçš„é”ï¼</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-183-1024x428.png" alt="img"></p>
<h4 id="å›¾ä¸­æµç¨‹è¯¦è§£">å›¾ä¸­æµç¨‹è¯¦è§£</h4>
<h4 id="â–¶-çº¿ç¨‹1ï¼š">â–¶ çº¿ç¨‹1ï¼š</h4>
<ul>
<li>æˆåŠŸåŠ é”å¹¶æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼›</li>
<li>ä¸­é€”â€œå¡ä½äº†â€ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œã€GC ç­‰å¡é¡¿ï¼‰ï¼›</li>
<li>é”è¿‡æœŸåï¼Œ<strong>è‡ªåŠ¨é‡Šæ”¾</strong>ï¼›</li>
<li>çº¿ç¨‹1 åç»­æ¢å¤ï¼Œ<strong>ç»§ç»­æ‰§è¡Œ delete</strong>ï¼Œä½†è¿™æ—¶é”å·²ç»ä¸æ˜¯å®ƒçš„äº†ï¼</li>
</ul>
<h4 id="â–¶-çº¿ç¨‹2ï¼š">â–¶ çº¿ç¨‹2ï¼š</h4>
<ul>
<li>çº¿ç¨‹1å¡ä½æ—¶ï¼Œé”è¿‡æœŸï¼›</li>
<li>å®ƒå°è¯•åŠ é”ï¼ŒæˆåŠŸï¼ˆå› ä¸º Redis å·²è‡ªåŠ¨é‡Šæ”¾ï¼‰ï¼›</li>
<li>å®ƒå¼€å§‹æ‰§è¡Œè‡ªå·±çš„ä¸šåŠ¡ã€‚</li>
</ul>
<h4 id="â–¶-é—®é¢˜æ¥äº†ï¼š">â–¶ é—®é¢˜æ¥äº†ï¼š</h4>
<ul>
<li>çº¿ç¨‹1 <strong>åçŸ¥åè§‰</strong>åœ°æ¢å¤å¹¶æ‰§è¡Œ <code>DEL lock</code>ï¼›</li>
<li>æ­¤æ—¶é”çš„å€¼å·²å˜æˆçº¿ç¨‹2çš„æ ‡è¯†ï¼›</li>
<li>ä½†å®ƒä»ç„¶æ‰§è¡Œ deleteï¼Œ<strong>è¯¯åˆ äº†çº¿ç¨‹2çš„é”</strong>ï¼</li>
<li>çº¿ç¨‹3 ä¹Ÿè¿›æ¥äº†ï¼Œå®ƒå°±èƒ½è·å–é”ï¼Œé€ æˆå¹¶å‘è®¿é—®ï¼Œ<strong>é€»è¾‘é”™ä¹±</strong>ï¼</li>
</ul>
<h3 id="4-5-è§£å†³Redisåˆ†å¸ƒå¼é”è¯¯åˆ é—®é¢˜">4.5 è§£å†³Redisåˆ†å¸ƒå¼é”è¯¯åˆ é—®é¢˜</h3>
<p>ç›®æ ‡ï¼šé”é‡Šæ”¾å‰å…ˆæ ¡éªŒâ€œé”æ˜¯æˆ‘åŠ çš„â€</p>
<p>æ–°éœ€æ±‚ï¼š</p>
<ul>
<li>åŠ é”æ—¶ï¼šå­˜å…¥<strong>çº¿ç¨‹æ ‡è¯†</strong>ï¼ˆå¦‚ï¼šUUID + Thread IDï¼‰ï¼›</li>
<li>è§£é”æ—¶ï¼šå…ˆå–å‡º Redis é‡Œçš„æ ‡è¯†ï¼›
<ul>
<li>å¦‚æœå’Œå½“å‰çº¿ç¨‹ä¸€è‡´ï¼šæ‰èƒ½åˆ é”ï¼›</li>
<li>å¦åˆ™ï¼šä¸åˆ ï¼Œé˜²æ­¢è¯¯åˆ ã€‚</li>
</ul>
</li>
</ul>
<p>æ ¸å¿ƒé€»è¾‘ï¼šåœ¨å­˜å…¥é”æ—¶ï¼Œæ”¾å…¥è‡ªå·±çº¿ç¨‹çš„æ ‡è¯†ï¼Œåœ¨åˆ é™¤é”æ—¶ï¼Œåˆ¤æ–­å½“å‰è¿™æŠŠé”çš„æ ‡è¯†æ˜¯ä¸æ˜¯è‡ªå·±å­˜å…¥çš„ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿›è¡Œåˆ é™¤ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ä¸è¿›è¡Œåˆ é™¤ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-184.png" alt="img"></p>
<p>é¦–å…ˆè¦ä¿®æ”¹SimpleRedisLocké‡Œé¢çš„å¦‚ä¸‹ä»£ç ï¼Œä¸»è¦æ˜¯è°ƒç”¨hutoolå·¥å…·åŒ…ç”ŸæˆUUIDï¼ˆæ¯æ¬¡çº¿ç¨‹è°ƒç”¨éƒ½ä¼šç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„UUIDï¼‰ï¼Œè®©Redisçš„å‰ç¼€å˜æˆUUID+çº¿ç¨‹IDï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ID_PREFIX</span> <span class="operator">=</span> UUID.fastUUID().toString(<span class="literal">true</span>)+<span class="string">&quot;-&quot;</span>;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span> &#123;</span><br><span class="line">    <span class="comment">//è·å–çº¿ç¨‹æ ‡ç¤º</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">threadId</span> <span class="operator">=</span> ID_PREFIX + Thread.currentThread().getId();</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">success</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(KEY_PREFIX+name,threadId,timeoutSec, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">return</span> Boolean.TRUE.equals(success);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨è¦ä¿®æ”¹çš„æ˜¯SimpleRedisLockç±»é‡Œé¢çš„unlockæ–¹æ³•ï¼Œä¸»è¦æ˜¯æ¯”è¾ƒå½“å‰çº¿ç¨‹çš„æ ‡ç¤ºå’ŒRedisä¸­é”çš„æ ‡ç¤ºæ˜¯å¦ä¸€è‡´ï¼Œåªæœ‰æ ‡ç¤ºä¸€è‡´æ‰èƒ½é‡Šæ”¾é”ï¼š</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">unlock</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//è·å–çº¿ç¨‹æ ‡ç¤º</span></span><br><span class="line">    <span class="title class_">String</span> threadId = <span class="variable constant_">ID_PREFIX</span> + <span class="title class_">Thread</span>.<span class="title function_">currentThread</span>().<span class="title function_">getId</span>();</span><br><span class="line">    <span class="comment">//è·å–é”ä¸­çš„æ ‡ç¤º</span></span><br><span class="line">    <span class="title class_">String</span> id = stringRedisTemplate.<span class="title function_">opsForValue</span>().<span class="title function_">get</span>(<span class="variable constant_">KEY_PREFIX</span> + name);</span><br><span class="line">    <span class="keyword">if</span>(threadId.<span class="title function_">equals</span>(id))&#123;</span><br><span class="line">        <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">        stringRedisTemplate.<span class="title function_">delete</span>(<span class="variable constant_">KEY_PREFIX</span>+name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ€»ç»“ä¸€å¥è¯ï¼šé€šè¿‡åŠ â€œçº¿ç¨‹å”¯ä¸€æ ‡è¯†â€ï¼Œå¹¶åœ¨é‡Šæ”¾é”æ—¶æ¯”å¯¹è¿™ä¸ªæ ‡è¯†ï¼ŒæˆåŠŸè§£å†³ Redis åˆ†å¸ƒå¼é”çš„<strong>è¯¯åˆ é—®é¢˜</strong>ï¼Œç¡®ä¿åªæœ‰â€œåŠ é”è€…â€æ‰èƒ½â€œè§£é”â€ã€‚</p>
<h3 id="4-6-åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜">4.6 åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜</h3>
<p>æ›´ä¸ºæç«¯çš„è¯¯åˆ é€»è¾‘è¯´æ˜ï¼š</p>
<p>çº¿ç¨‹1ç°åœ¨æŒæœ‰é”ä¹‹åï¼Œåœ¨æ‰§è¡Œä¸šåŠ¡é€»è¾‘è¿‡ç¨‹ä¸­ï¼Œä»–æ­£å‡†å¤‡åˆ é™¤é”ï¼Œè€Œä¸”å·²ç»èµ°åˆ°äº†æ¡ä»¶åˆ¤æ–­çš„è¿‡ç¨‹ä¸­ï¼Œæ¯”å¦‚ä»–å·²ç»æ‹¿åˆ°äº†å½“å‰è¿™æŠŠé”ç¡®å®æ˜¯å±äºä»–è‡ªå·±çš„ï¼Œæ­£å‡†å¤‡åˆ é™¤é”ï¼Œä½†æ˜¯æ­¤æ—¶ä»–çš„é”åˆ°æœŸäº†ï¼Œé‚£ä¹ˆæ­¤æ—¶çº¿ç¨‹2è¿›æ¥ï¼Œä½†æ˜¯çº¿ç¨‹1ä»–ä¼šæ¥ç€å¾€åæ‰§è¡Œï¼Œå½“ä»–å¡é¡¿ç»“æŸåï¼Œä»–ç›´æ¥å°±ä¼šæ‰§è¡Œåˆ é™¤é”é‚£è¡Œä»£ç ï¼Œç›¸å½“äºæ¡ä»¶åˆ¤æ–­å¹¶æ²¡æœ‰èµ·åˆ°ä½œç”¨ï¼Œè¿™å°±æ˜¯åˆ é”æ—¶çš„åŸå­æ€§é—®é¢˜ï¼Œä¹‹æ‰€ä»¥æœ‰è¿™ä¸ªé—®é¢˜ï¼Œæ˜¯å› ä¸ºçº¿ç¨‹1çš„æ‹¿é”ï¼Œæ¯”é”ï¼Œåˆ é”ï¼Œå®é™…ä¸Šå¹¶ä¸æ˜¯åŸå­æ€§çš„ï¼Œæˆ‘ä»¬è¦é˜²æ­¢åˆšæ‰çš„æƒ…å†µå‘ç”Ÿï¼Œ</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-186-1024x441.png" alt="img"></p>
<ul>
<li><strong>çº¿ç¨‹1</strong> è·å–é”æˆåŠŸï¼ˆé”æ ‡è¯†æ˜¯çº¿ç¨‹1çš„ UUIDï¼‰ï¼›</li>
<li>æ‰§è¡Œä¸šåŠ¡ï¼›</li>
<li>å‡†å¤‡é‡Šæ”¾é”ï¼Œ<strong>æ­£åœ¨åˆ¤æ–­é”æ˜¯ä¸æ˜¯è‡ªå·±çš„</strong>ï¼ˆè¿™ä¸ªæ—¶å€™åˆ¤æ–­æˆåŠŸï¼‰ï¼›</li>
<li>ä½†æ˜¯ï¼<strong>å°±åœ¨è¿™ä¸€æ­¥ä¹‹åçº¿ç¨‹1çªç„¶è¢«å¡ä½</strong>ï¼ˆé˜»å¡æˆ–å®•æœºï¼‰ï¼›</li>
<li>é”è¶…æ—¶åè¢« Redis è‡ªåŠ¨é‡Šæ”¾ï¼›</li>
<li><strong>çº¿ç¨‹2ã€çº¿ç¨‹3</strong> å…ˆåè·å–é”å¹¶æ‰§è¡Œä¸šåŠ¡ï¼›</li>
<li>çº¿ç¨‹1 é†’æ¥ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œ deleteï¼Œ<strong>æŠŠçº¿ç¨‹2æˆ–3çš„é”åˆ æ‰äº†</strong>ï¼ï¼</li>
</ul>
<h4 id="å…³é”®é—®é¢˜ï¼šåˆ¤æ–­-åˆ é™¤ä¸æ˜¯åŸå­æ“ä½œ">å…³é”®é—®é¢˜ï¼š<strong>åˆ¤æ–­ + åˆ é™¤ä¸æ˜¯åŸå­æ“ä½œ</strong></h4>
<p>è¿™ä¸¤ä¸ªæ“ä½œä¹‹é—´ä¸€æ—¦å‡ºç°â€œå¡é¡¿ã€å»¶è¿Ÿã€è°ƒåº¦åˆ‡æ¢â€ç­‰éé¢„æœŸæƒ…å†µï¼Œå°±å¯èƒ½å¯¼è‡´ä½ <strong>è¯¯åˆ äº†åˆ«äººçš„é”</strong>ï¼Œå³ä¾¿ä½ ä¹‹å‰å·²ç»åšäº†çº¿ç¨‹æ ‡è¯†æ ¡éªŒã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼š<strong>ç”¨ Lua è„šæœ¬è®©â€œåˆ¤æ–­+åˆ é™¤â€åŸå­æ‰§è¡Œ</strong></p>
<h3 id="4-7-Luaè„šæœ¬è§£å†³å¤šæ¡å‘½ä»¤åŸå­æ€§é—®é¢˜">4.7 Luaè„šæœ¬è§£å†³å¤šæ¡å‘½ä»¤åŸå­æ€§é—®é¢˜</h3>
<h4 id="ä¸ºä»€ä¹ˆç”¨-Luaï¼Ÿ">ä¸ºä»€ä¹ˆç”¨ Luaï¼Ÿ</h4>
<blockquote>
<p>ç­”ï¼šRedis æä¾›çš„ <code>EVAL</code> å‘½ä»¤æ”¯æŒåœ¨æœåŠ¡ç«¯è¿è¡Œ Lua è„šæœ¬ï¼Œèƒ½è®©å¤šä¸ª Redis å‘½ä»¤ç»„æˆ <strong>ä¸€ä¸ªä¸å¯æ‹†åˆ†çš„åŸå­æ“ä½œ</strong>ã€‚</p>
</blockquote>
<p>Redisæä¾›Luaè„šæœ¬åŠŸèƒ½ï¼Œåœ¨ä¸€ä¸ªè„šæœ¬ä¸­ç¼–å†™å¤šæ¡Rediså‘½ä»¤ï¼Œç¡®ä¿å¤šæ¡å‘½ä»¤æ‰§è¡Œæ—¶çš„åŸå­æ€§ã€‚</p>
<p>Luaæ˜¯ä¸€ç§ç¼–ç¨‹è¯­è¨€ï¼Œå®ƒçš„åŸºæœ¬è¯­æ³•å¯ä»¥å‚è€ƒç½‘ç«™ï¼š<a target="_blank" rel="noopener" href="https://www.runoob.com/lua/lua-tutorial.html">https://www.runoob.com/lua/lua-tutorial.html</a></p>
<h4 id="4-7-1Lua-è„šæœ¬åŸºæœ¬è¯­æ³•">4.7.1Lua è„šæœ¬åŸºæœ¬è¯­æ³•</h4>
<p>è¿™é‡Œé‡ç‚¹ä»‹ç»Redisæä¾›çš„è°ƒç”¨å‡½æ•°ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.<span class="built_in">call</span>(<span class="string">&#x27;å‘½ä»¤åç§°&#x27;</span>, <span class="string">&#x27;key&#x27;</span>, <span class="string">&#x27;å…¶å®ƒå‚æ•°&#x27;</span>, ...)</span><br></pre></td></tr></table></figure>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦æ‰§è¡Œset name jackï¼Œåˆ™è„šæœ¬æ˜¯è¿™æ ·ï¼š</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># æ‰§è¡Œ <span class="keyword">set</span> <span class="type">name</span> jack</span><br><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;jack&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦å…ˆæ‰§è¡Œset name Roseï¼Œå†æ‰§è¡Œget nameï¼Œåˆ™è„šæœ¬å¦‚ä¸‹ï¼š</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># å…ˆæ‰§è¡Œ <span class="keyword">set</span> <span class="type">name</span> jack</span><br><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;Rose&#x27;</span>)</span><br><span class="line"># å†æ‰§è¡Œ <span class="keyword">get</span> <span class="type">name</span></span><br><span class="line"><span class="keyword">local</span> <span class="type">name</span> = redis.<span class="keyword">call</span>(<span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;name&#x27;</span>)</span><br><span class="line"># è¿”å›</span><br><span class="line"><span class="keyword">return</span> <span class="type">name</span></span><br></pre></td></tr></table></figure>
<h4 id="4-7-2-ä½¿ç”¨-EVAL-è°ƒç”¨è„šæœ¬">4.7.2 ä½¿ç”¨ EVAL è°ƒç”¨è„šæœ¬</h4>
<p>å†™å¥½è„šæœ¬ä»¥åï¼Œéœ€è¦ç”¨Rediså‘½ä»¤æ¥è°ƒç”¨è„šæœ¬ï¼Œè°ƒç”¨è„šæœ¬çš„å¸¸è§å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">EVAL</span> <span class="string">&quot;è„šæœ¬å†…å®¹&quot;</span> numkeys key1 [key2 â€¦] arg1 [arg2 â€¦]</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-187-1024x233.png" alt="img"></p>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦æ‰§è¡Œ redis.call(â€˜setâ€™, â€˜nameâ€™, â€˜jackâ€™) è¿™ä¸ªè„šæœ¬ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-188.png" alt="img"></p>
<h4 id="4-7-3-å‚æ•°åŠ¨æ€ä¼ å…¥æ–¹å¼">4.7.3. å‚æ•°åŠ¨æ€ä¼ å…¥æ–¹å¼</h4>
<p>å¦‚æœè„šæœ¬ä¸­çš„keyã€valueä¸æƒ³å†™æ­»ï¼Œå¯ä»¥ä½œä¸ºå‚æ•°ä¼ é€’ã€‚keyç±»å‹å‚æ•°ä¼šæ”¾å…¥KEYSæ•°ç»„ï¼Œå…¶å®ƒå‚æ•°ä¼šæ”¾å…¥ARGVæ•°ç»„ï¼Œåœ¨è„šæœ¬ä¸­å¯ä»¥ä»KEYSå’ŒARGVæ•°ç»„è·å–è¿™äº›å‚æ•°ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-189-1024x137.png" alt="img"></p>
<ul>
<li><code>1</code>ï¼šè¡¨ç¤ºæœ‰ä¸€ä¸ª key å‚æ•°</li>
<li><code>KEYS[1] = name</code>ï¼Œ<code>ARGV[1] = Rose</code></li>
</ul>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å›ä¸€ä¸‹æˆ‘ä»¬é‡Šæ”¾é”çš„é€»è¾‘ï¼š</p>
<p>ç›®æ ‡ï¼šè®©ä»¥ä¸‹é€»è¾‘å˜æˆä¸€ä¸ªåŸå­æ“ä½œï¼š</p>
<ol>
<li>è¯»å–é”çš„å€¼</li>
<li>æ¯”è¾ƒå€¼æ˜¯å¦ç­‰äºå½“å‰çº¿ç¨‹æ ‡è¯†</li>
<li>å¦‚æœä¸€è‡´ï¼Œé‡Šæ”¾é”</li>
<li>å¦‚æœä¸ä¸€è‡´ï¼Œä¸åšä»»ä½•æ“ä½œ</li>
</ol>
<p>å¦‚æœç”¨Luaè„šæœ¬æ¥è¡¨ç¤ºåˆ™æ˜¯è¿™æ ·çš„ï¼š</p>
<p>æœ€ç»ˆæˆ‘ä»¬æ“ä½œredisçš„æ‹¿é”æ¯”é”åˆ é”çš„luaè„šæœ¬å°±ä¼šå˜æˆè¿™æ ·</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- è¿™é‡Œçš„ KEYS[1] å°±æ˜¯é”çš„keyï¼Œè¿™é‡Œçš„ARGV[1] å°±æ˜¯å½“å‰çº¿ç¨‹æ ‡ç¤º</span></span><br><span class="line"><span class="comment">-- è·å–é”ä¸­çš„æ ‡ç¤ºï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹æ ‡ç¤ºä¸€è‡´</span></span><br><span class="line"><span class="keyword">if</span> (redis.<span class="keyword">call</span>(<span class="string">&#x27;GET&#x27;</span>, KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>]) <span class="keyword">then</span></span><br><span class="line">  <span class="comment">-- ä¸€è‡´ï¼Œåˆ™åˆ é™¤é”</span></span><br><span class="line">  <span class="keyword">return</span> redis.<span class="keyword">call</span>(<span class="string">&#x27;DEL&#x27;</span>, KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- ä¸ä¸€è‡´ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h4 id="æ€»ç»“ä¸€å¥è¯">æ€»ç»“ä¸€å¥è¯</h4>
<blockquote>
<p>æŠŠâ€œåˆ¤æ–­æ˜¯ä¸æ˜¯è‡ªå·± + åˆ é™¤é”â€è¿™ä¸¤æ­¥æ”¾è¿› Lua è„šæœ¬ä¸­äº¤ç»™ Redis åŸå­æ‰§è¡Œï¼Œå½»åº•è§£å†³åˆ†å¸ƒå¼é”çš„å¹¶å‘å®‰å…¨é—®é¢˜ã€‚</p>
<h3 id="4-8-åˆ©ç”¨Javaä»£ç è°ƒç”¨Luaè„šæœ¬æ”¹é€ åˆ†å¸ƒå¼é”">4.8 åˆ©ç”¨Javaä»£ç è°ƒç”¨Luaè„šæœ¬æ”¹é€ åˆ†å¸ƒå¼é”</h3>
<p>åœ¨SimpleRedisLockä¸­å†™å…¥å¦‚ä¸‹çš„ä»£ç ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›çš„æ˜¯åœ¨ä¸€å¼€å§‹å°±å°†Luaçš„è„šæœ¬åŠ è½½å¥½ï¼Œè€Œä¸æ˜¯ç­‰åˆ°è¦è°ƒç”¨é‡Šæ”¾é”çš„æ—¶å€™å†å»åŠ è½½Luaè„šæœ¬ï¼Œæ‰€ä»¥é‡‡ç”¨é™æ€å˜é‡å’Œé™æ€ä»£ç å—ï¼Œè¿™äº›éƒ¨åˆ†åœ¨ç±»åˆå§‹åŒ–çš„æ—¶å€™å°±ä¼šè¢«åŠ è½½ï¼š</p>
</blockquote>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultRedisScript&lt;<span class="keyword">Long</span>&gt; UNLOCK_SCRIPT;</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">     UNLOCK_SCRIPT = <span class="keyword">new</span> DefaultRedisScript&lt;&gt;();</span><br><span class="line">     UNLOCK_SCRIPT.setLocation(<span class="keyword">new</span> ClassPathResource(<span class="string">&quot;unlock.lua&quot;</span>));</span><br><span class="line">     UNLOCK_SCRIPT.setResultType(<span class="keyword">Long</span>.<span class="keyword">class</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è¯´æ˜ï¼š">è¯´æ˜ï¼š</h3>
<ul>
<li><code>DefaultRedisScript</code> æ˜¯ Spring æä¾›çš„ç±»ï¼›</li>
<li><code>setLocation</code> æ˜¯åŠ è½½ Lua è„šæœ¬æ–‡ä»¶ï¼›</li>
<li><code>setResultType</code> æ˜¯å‘Šè¯‰ Redis ä½ è¿™ä¸ªè„šæœ¬è¦è¿”å›ä»€ä¹ˆç±»å‹ã€‚</li>
</ul>
<blockquote>
<p>åœ¨SimpleRedisLockç±»çš„unlockæ–¹æ³•ä¸­å†™å…¥å¦‚ä¸‹çš„ä»£ç ï¼š</p>
<p>åœ¨ <code>SimpleRedisLock</code> çš„ <code>unlock()</code> æ–¹æ³•ä¸­ï¼Œæ›¿æ¢åŸæ¥çš„ delete é€»è¾‘ï¼š</p>
</blockquote>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Override</span></span><br><span class="line">public void <span class="built_in">unlock</span>() &#123;</span><br><span class="line">    <span class="selector-tag">stringRedisTemplate</span><span class="selector-class">.execute</span>(UNLOCK_SCRIPT,</span><br><span class="line">            Collections.<span class="built_in">singletonList</span>(KEY_PREFIX+name),</span><br><span class="line">            ID_PREFIX + Thread.<span class="built_in">currentThread</span>().<span class="built_in">getId</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç åœ¨æ‰§è¡Œ Lua è„šæœ¬æ—¶ï¼š</p>
<ul>
<li><code>KEYS[1] = lock:order:xxx</code>ï¼ˆé”çš„ keyï¼‰ï¼›</li>
<li><code>ARGV[1] = UUID-threadId</code>ï¼ˆé”çš„å€¼ï¼Œç”¨äºèº«ä»½éªŒè¯ï¼‰ï¼›</li>
</ul>
<p><strong>RedisTemplate æ˜¯å¦‚ä½•æ‰§è¡Œ Lua çš„ï¼Ÿ</strong></p>
<p>æˆ‘ä»¬çš„RedisTemplateä¸­ï¼Œå¯ä»¥åˆ©ç”¨executeæ–¹æ³•å»æ‰§è¡Œluaè„šæœ¬ï¼Œå‚æ•°å¯¹åº”å…³ç³»å°±å¦‚ä¸‹å›¾è‚¡</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-190-1024x476.png" alt="img"></p>
<p><strong>æµ‹è¯•é€»è¾‘ï¼š</strong></p>
<p>ç¬¬ä¸€ä¸ªçº¿ç¨‹è¿›æ¥ï¼Œå¾—åˆ°äº†é”ï¼Œæ‰‹åŠ¨åˆ é™¤é”ï¼Œæ¨¡æ‹Ÿé”è¶…æ—¶äº†ï¼Œå…¶ä»–çº¿ç¨‹ä¼šæ‰§è¡Œluaæ¥æŠ¢é”ï¼Œå½“ç¬¬ä¸€å¤©çº¿ç¨‹åˆ©ç”¨luaåˆ é™¤é”æ—¶ï¼Œluaèƒ½ä¿è¯ä»–ä¸èƒ½åˆ é™¤ä»–çš„é”ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹åˆ é™¤é”æ—¶ï¼Œåˆ©ç”¨luaåŒæ ·å¯ä»¥ä¿è¯ä¸ä¼šåˆ é™¤åˆ«äººçš„é”ï¼ŒåŒæ—¶è¿˜èƒ½ä¿è¯åŸå­æ€§ã€‚</p>
<p>åœ¨ç¨‹åº1å’Œç¨‹åº2çš„ä¸‹é¢è¿™ä¸ªä½ç½®æ‰“ä¸Šæ–­ç‚¹ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-191.png" alt="img"></p>
<p>åœ¨æµ‹è¯•APIä¸­æµ‹è¯•è®¿é—®å¦‚ä¸‹çš„URLï¼š</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost:<span class="number">8080</span><span class="regexp">/api/</span>voucher-order<span class="regexp">/seckill/</span><span class="number">14</span></span><br></pre></td></tr></table></figure>
<p>åˆ†åˆ«æµ‹è¯•ç§’æ€ä¼˜æƒ åˆ¸1å’Œ2ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-192.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-193.png" alt="img"></p>
<p>åœ¨Redisä¸­èƒ½çœ‹åˆ°ç¨‹åº1è·å–é”æˆåŠŸï¼Œç„¶åç›´æ¥æŠŠlocké”åˆ æ‰ï¼Œæ¨¡æ‹Ÿè¶…æ—¶é‡Šæ”¾çš„æƒ…å†µï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-194.png" alt="img"></p>
<p>ç„¶åè®©ç¨‹åº2å¾€ä¸‹èµ°ä¸€æ­¥ï¼Œå¯ä»¥çœ‹åˆ°ç¨‹åº2è·å–åˆ°äº†é”</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-195.png" alt="img"></p>
<p>ç„¶åå¯ä»¥ç›´æ¥æ”¾è¡Œç¨‹åº1ï¼Œä¼šçœ‹åˆ°ç»“æœæ˜¯ç¨‹åº2åŠ çš„é”æ²¡æœ‰è¢«åˆ é™¤ã€‚</p>
<p>æœ€åæ”¾è¡Œç¨‹åº2ï¼Œä¼šçœ‹åˆ°ç¨‹åº2åŠ çš„é”è¢«åˆ é™¤ã€‚</p>
<p>å°æ€»ç»“ï¼š</p>
<p>åŸºäºRedisçš„åˆ†å¸ƒå¼é”å®ç°æ€è·¯ï¼š</p>
<ul>
<li>åˆ©ç”¨set nx exè·å–é”ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä¿å­˜çº¿ç¨‹æ ‡ç¤º</li>
<li>é‡Šæ”¾é”æ—¶å…ˆåˆ¤æ–­çº¿ç¨‹æ ‡ç¤ºæ˜¯å¦ä¸è‡ªå·±ä¸€è‡´ï¼Œä¸€è‡´åˆ™åˆ é™¤é”</li>
<li>ç‰¹æ€§ï¼š
<ul>
<li>åˆ©ç”¨set nxæ»¡è¶³äº’æ–¥æ€§</li>
<li>åˆ©ç”¨set exä¿è¯æ•…éšœæ—¶é”ä¾ç„¶èƒ½é‡Šæ”¾ï¼Œé¿å…æ­»é”ï¼Œæé«˜å®‰å…¨æ€§</li>
<li>åˆ©ç”¨Redisé›†ç¾¤ä¿è¯é«˜å¯ç”¨å’Œé«˜å¹¶å‘ç‰¹æ€§</li>
</ul>
</li>
</ul>
<p>ç¬”è€…æ€»ç»“ï¼šæˆ‘ä»¬ä¸€è·¯èµ°æ¥ï¼Œåˆ©ç”¨æ·»åŠ è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é”é—®é¢˜çš„å‘ç”Ÿï¼Œä½†æ˜¯æœ‰äº†è¿‡æœŸæ—¶é—´ä¹‹åï¼Œå¯èƒ½å‡ºç°è¯¯åˆ åˆ«äººé”çš„é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜æˆ‘ä»¬å¼€å§‹æ˜¯åˆ©ç”¨åˆ ä¹‹å‰ é€šè¿‡æ‹¿é”ï¼Œæ¯”é”ï¼Œåˆ é”è¿™ä¸ªé€»è¾‘æ¥è§£å†³çš„ï¼Œä¹Ÿå°±æ˜¯åˆ ä¹‹å‰åˆ¤æ–­ä¸€ä¸‹å½“å‰è¿™æŠŠé”æ˜¯å¦æ˜¯å±äºè‡ªå·±çš„ï¼Œä½†æ˜¯ç°åœ¨è¿˜æœ‰åŸå­æ€§é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ²¡æ³•ä¿è¯æ‹¿é”æ¯”é”åˆ é”æ˜¯ä¸€ä¸ªåŸå­æ€§çš„åŠ¨ä½œï¼Œæœ€åé€šè¿‡luaè¡¨è¾¾å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜</p>
<p>å·²ç»æŠŠ Redis åˆ†å¸ƒå¼é”ä»â€œèƒ½ç”¨â€ä¼˜åŒ–åˆ°â€œé«˜å¹¶å‘å¯å®‰å…¨ç”¨â€çš„ç‰ˆæœ¬ï¼Œä½¿ç”¨ Lua è„šæœ¬åœ¨ Java ä¸­åŸå­é‡Šæ”¾é”ï¼Œæ˜¯å®ç°è¿™ä¸€åˆ‡çš„å…³é”®ä¸€æ­¥ã€‚</p>
<p>ä½†æ˜¯ç›®å‰è¿˜å‰©ä¸‹ä¸€ä¸ªé—®é¢˜é”ä¸ä½ï¼Œä»€ä¹ˆæ˜¯é”ä¸ä½å‘¢ï¼Œä½ æƒ³ä¸€æƒ³ï¼Œå¦‚æœå½“è¿‡æœŸæ—¶é—´åˆ°äº†ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ç»™ä»–ç»­æœŸä¸€ä¸‹ï¼Œæ¯”å¦‚ç»­ä¸ª30sï¼Œå°±å¥½åƒæ˜¯ç½‘å§ä¸Šç½‘ï¼Œ ç½‘è´¹åˆ°äº†ä¹‹åï¼Œç„¶åè¯´ï¼Œæ¥ï¼Œç½‘ç®¡ï¼Œå†ç»™æˆ‘æ¥10å—çš„ï¼Œæ˜¯ä¸æ˜¯åè¾¹çš„é—®é¢˜éƒ½ä¸ä¼šå‘ç”Ÿäº†ï¼Œé‚£ä¹ˆç»­æœŸé—®é¢˜æ€ä¹ˆè§£å†³å‘¢ï¼Œå¯ä»¥ä¾èµ–äºæˆ‘ä»¬æ¥ä¸‹æ¥è¦å­¦ä¹ redissionå•¦</p>
<h2 id="5ã€åˆ†å¸ƒå¼é”-redission">5ã€åˆ†å¸ƒå¼é”-redission</h2>
<h3 id="5-1-åˆ†å¸ƒå¼é”-redissionåŠŸèƒ½ä»‹ç»">5.1 åˆ†å¸ƒå¼é”-redissionåŠŸèƒ½ä»‹ç»</h3>
<p>åŸºäºsetnxå®ç°çš„åˆ†å¸ƒå¼é”å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š</p>
<ol>
<li><strong>ä¸å¯é‡å…¥</strong></li>
</ol>
<ul>
<li>
<p>å«ä¹‰ï¼šåŒä¸€ä¸ªçº¿ç¨‹åœ¨è¿˜æ²¡é‡Šæ”¾é”æ—¶ï¼Œåˆæƒ³å†æ¬¡è·å–è¿™ä¸ªé”ï¼Œä¸èƒ½æˆåŠŸï¼ˆä¼šè¢«è‡ªå·±é˜»å¡ï¼‰ï¼›</p>
</li>
<li>
<p>ä¸¾ä¾‹ï¼šå°±åƒä½ åœ¨æ–¹æ³• A æ‹¿äº†é”ï¼Œç„¶åæ–¹æ³• A åˆè°ƒç”¨äº† Bï¼Œè€Œ B åˆè¦æ‹¿åŒä¸€æŠŠé”ï¼Œå°±æŒ‚ä½äº†ï¼›</p>
</li>
<li>
<p><strong>é£é™©</strong>ï¼šé€’å½’è°ƒç”¨/å¤šå±‚å°è£…ä¸‹å®¹æ˜“æ­»é”ï¼›</p>
</li>
<li>
<p><code>synchronized</code>/<code>ReentrantLock</code> æ˜¯å¯é‡å…¥çš„ï¼Œè€ŒåŸå§‹ Redis å®ç°ä¸æ˜¯ã€‚</p>
</li>
<li>
<p><strong>ä¸å¯é‡è¯•</strong></p>
</li>
<li>
<p>å«ä¹‰ï¼šè·å–å¤±è´¥ä¸€æ¬¡å°±æ”¾å¼ƒï¼Œæ²¡æœ‰â€œç­‰å¾…+é‡è¯•â€æœºåˆ¶ï¼›</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šå¹¶å‘ç¯å¢ƒä¸‹ï¼Œå¾ˆå¤šçº¿ç¨‹æŠ¢é”å¤±è´¥åç«‹åˆ»è¿”å›ï¼Œ<strong>ä¸èƒ½ç­‰å¾…æ’é˜Ÿ</strong>ï¼Œä¸šåŠ¡ä½“éªŒå·®ã€‚</p>
</li>
<li>
<p><strong>è¶…æ—¶é‡Šæ”¾æœ‰é£é™©</strong></p>
</li>
<li>
<p>åŠ é”æ—¶è®¾ç½®äº†è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é”ï¼›</p>
</li>
<li>
<p><strong>ä½†</strong>ï¼šå¦‚æœä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œé”å…ˆè¿‡æœŸäº†ï¼›</p>
</li>
<li>
<p>åˆ«äººè¿›æ¥æŠ¢é”ï¼Œä½ ä¸šåŠ¡è¿˜æ²¡åšå®Œï¼›</p>
</li>
<li>
<p>å³ä½¿ä½ ç”¨ Lua åˆ¤æ–­ + åˆ é™¤ï¼Œä¹Ÿåªèƒ½é¿å…è¯¯åˆ ï¼Œä½†<strong>æ— æ³•ä¿è¯é”ä¸€å®šæœ‰æ•ˆåˆ°ä½ ä¸šåŠ¡çœŸæ­£æ‰§è¡Œå®Œæ¯•</strong>ï¼›</p>
</li>
<li>
<p><strong>ç»“è®º</strong>ï¼šéœ€è¦â€œé”ç»­æœŸæœºåˆ¶â€æ¥ä¿æŒé”æœ‰æ•ˆï¼</p>
</li>
<li>
<p><strong>ä¸»ä»ä¸€è‡´æ€§é—®é¢˜ï¼ˆåˆ†å¸ƒå¼é›†ç¾¤ï¼‰</strong></p>
</li>
<li>
<p>Redis ä½¿ç”¨ä¸»ä»é›†ç¾¤æ—¶ï¼Œå†™å…¥æ•°æ®æ˜¯å…ˆå†™ä¸»èŠ‚ç‚¹ï¼Œå†åŒæ­¥ç»™ä»èŠ‚ç‚¹ï¼›</p>
</li>
<li>
<p>å¦‚æœåœ¨å†™æˆåŠŸå‰ä¸»èŠ‚ç‚¹æŒ‚äº†ï¼Œä½†ä»èŠ‚ç‚¹æ²¡æœ‰æ‹¿åˆ°åŒæ­¥æ•°æ®ï¼Œ<strong>ä»èŠ‚ç‚¹ä¼šè®¤ä¸ºé”æ²¡è¢«åŠ ï¼Œå¯¼è‡´é”è¢«é‡å¤åŠ </strong>ï¼›</p>
</li>
<li>
<p><strong>ç»“æœï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›å…¥ä¸´ç•ŒåŒºï¼Œé”å½¢åŒè™šè®¾</strong>ï¼›</p>
</li>
<li>
<p>è¿™ä¸ªé—®é¢˜æ˜¯ Redis æœ¬èº«æ¶æ„çš„å¼±ç‚¹ï¼Œå•é ä½ æ‰‹å†™é€»è¾‘ä¸å¥½å¤„ç†ã€‚</p>
</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-196.png" alt="img"></p>
<h4 id="æ€»ç»“ä¸€å¥è¯ï¼š">æ€»ç»“ä¸€å¥è¯ï¼š</h4>
<blockquote>
<p>è‡ªå·±å†™çš„ Redis åˆ†å¸ƒå¼é”ï¼Œè™½ç„¶èƒ½ç”¨ï¼Œä½†å­˜åœ¨ <strong>ä¸å¯é‡å…¥ã€ä¸å¯ç»­æœŸã€æ— æ’é˜Ÿã€ä¸ç¨³å®š</strong> ç­‰é—®é¢˜ï¼Œåœ¨çœŸæ­£ç”Ÿäº§ç¯å¢ƒé‡Œä¸å¤Ÿå¥å£®ã€‚</p>
</blockquote>
<p><strong>ä»€ä¹ˆæ˜¯Redissionå‘¢</strong></p>
<p>Redisson æ˜¯ä¸€ä¸ªåŸºäº Redis çš„ Java å®¢æˆ·ç«¯æ¡†æ¶ï¼Œå®ƒå°è£…äº†å¾ˆå¤šåˆ†å¸ƒå¼æœåŠ¡ï¼Œå…¶ä¸­åŒ…æ‹¬å„ç§ç±»å‹çš„ <strong>åˆ†å¸ƒå¼é”å®ç°</strong>ï¼Œè¿˜å¸¦æœ‰â€œè‡ªåŠ¨ç»­æœŸâ€ã€â€œå¯é‡å…¥â€ã€â€œå…¬å¹³é”â€ã€â€œè¯»å†™é”â€ç­‰é«˜çº§åŠŸèƒ½ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-203.png" alt="img"></p>
<h3 id="5-2-åˆ†å¸ƒå¼é”-Redissionå¿«é€Ÿå…¥é—¨">5.2 åˆ†å¸ƒå¼é”-Redissionå¿«é€Ÿå…¥é—¨</h3>
<p>ç¬¬1æ­¥ï¼Œå…ˆå¼•å…¥ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.13.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>ç¬¬2æ­¥ï¼Œåœ¨configåŒ…ä¸‹åˆ›å»ºRedissonConfigç±»ï¼Œå†™å…¥å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    @<span class="function">Bean</span></span><br><span class="line"><span class="function">    <span class="keyword">public</span> RedissonClient <span class="title">redissonClient</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// é…ç½®</span></span><br><span class="line">        Config config = <span class="keyword">new</span> <span class="built_in">Config</span>();</span><br><span class="line">        config.<span class="built_in">useSingleServer</span>().<span class="built_in">setAddress</span>(<span class="string">&quot;redis://192.168.150.101:6379&quot;</span>)</span><br><span class="line">            .<span class="built_in">setPassword</span>(<span class="string">&quot;123321&quot;</span>);</span><br><span class="line">        <span class="comment">// åˆ›å»ºRedissonClientå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> Redisson.<span class="built_in">create</span>(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="è¯´æ˜ï¼š-2">è¯´æ˜ï¼š</h3>
<ul>
<li>åˆ›å»ºå¹¶æ³¨å†Œ <code>RedissonClient</code> Beanï¼›</li>
<li>ä½¿ç”¨ <code>useSingleServer()</code> è¡¨ç¤ºä½ ä½¿ç”¨çš„æ˜¯å•æœº Redisï¼ˆåæœŸå¯ä»¥åˆ‡æ¢ä¸ºé›†ç¾¤æ¨¡å¼ï¼‰ï¼›</li>
<li>æ³¨æ„åœ°å€å‰ç¼€æ˜¯ <code>redis://</code>ï¼›</li>
<li>å¯†ç å¦‚æœ Redis æ²¡è®¾å¯ä»¥ä¸å†™ <code>.setPassword(...)</code>ã€‚</li>
</ul>
<p>ç¬¬3æ­¥ï¼Œå¼•å…¥RedissonClientï¼Œè°ƒç”¨getLockè·å–é”å¯¹è±¡ï¼Œç„¶åç”¨tryLockè·å–é”ã€‚</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Resource</span><br><span class="line"><span class="keyword">private</span> RedissionClient redissonClient;</span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testRedisson</span>() throws Exception</span>&#123;</span><br><span class="line">    <span class="comment">//è·å–é”(å¯é‡å…¥)ï¼ŒæŒ‡å®šé”çš„åç§°</span></span><br><span class="line">    RLock <span class="keyword">lock</span> = redissonClient.getLock(<span class="string">&quot;anyLock&quot;</span>);</span><br><span class="line">    <span class="comment">//å°è¯•è·å–é”ï¼Œå‚æ•°åˆ†åˆ«æ˜¯ï¼šè·å–é”çš„æœ€å¤§ç­‰å¾…æ—¶é—´(æœŸé—´ä¼šé‡è¯•)ï¼Œé”è‡ªåŠ¨é‡Šæ”¾æ—¶é—´ï¼Œæ—¶é—´å•ä½</span></span><br><span class="line">    boolean isLock = <span class="keyword">lock</span>.tryLock(<span class="number">1</span>,<span class="number">10</span>,TimeUnit.SECONDS);</span><br><span class="line">    <span class="comment">//åˆ¤æ–­è·å–é”æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span>(isLock)&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            System.<span class="keyword">out</span>.println(<span class="string">&quot;æ‰§è¡Œä¸šåŠ¡&quot;</span>);          </span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">            <span class="keyword">lock</span>.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‚æ•°è¯´æ˜ï¼š</p>
<p><code>tryLock(1, 10, TimeUnit.SECONDS)</code>ï¼š</p>
<ul>
<li><strong>1 ç§’å†…å°è¯•è·å–é”</strong>ï¼ˆæŠ¢ä¸åˆ°å°±æ”¾å¼ƒï¼‰ï¼›</li>
<li>é”æŒæœ‰ <strong>10 ç§’åè‡ªåŠ¨é‡Šæ”¾</strong>ï¼›</li>
</ul>
<p><code>lock.unlock()</code>ï¼šå®‰å…¨é‡Šæ”¾é”ï¼Œé˜²æ­¢é˜»å¡ï¼›</p>
<p>Redisson å†…éƒ¨å·²ç»è‡ªåŠ¨å®ç°äº†çº¿ç¨‹æ ‡è¯†ã€é˜²è¯¯åˆ ã€è‡ªåŠ¨ç»­æœŸç­‰é€»è¾‘ã€‚</p>
<p>åœ¨ VoucherOrderServiceImpl</p>
<p>æ³¨å…¥RedissonClient</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function">Result <span class="title">seckillVoucher</span><span class="params">(Long voucherId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span></span><br><span class="line">        SeckillVoucher voucher = seckillVoucherService.getById(voucherId);</span><br><span class="line">        <span class="comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">            <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">            <span class="comment">// å°šæœªå¼€å§‹</span></span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// åº“å­˜ä¸è¶³</span></span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Long userId = UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//åˆ›å»ºé”å¯¹è±¡ è¿™ä¸ªä»£ç ä¸ç”¨äº†ï¼Œå› ä¸ºæˆ‘ä»¬ç°åœ¨è¦ä½¿ç”¨åˆ†å¸ƒå¼é”</span></span><br><span class="line">        <span class="comment">//SimpleRedisLock lock = new SimpleRedisLock(&quot;order:&quot; + userId, stringRedisTemplate);</span></span><br><span class="line">        RLock lock = redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span> + userId);</span><br><span class="line">        <span class="comment">//è·å–é”å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">boolean</span> isLock = lock.tryLock();</span><br><span class="line">       </span><br><span class="line">        <span class="comment">//åŠ é”å¤±è´¥</span></span><br><span class="line">        <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//è·å–ä»£ç†å¯¹è±¡(äº‹åŠ¡)</span></span><br><span class="line">            IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">            <span class="function"><span class="keyword">return</span> proxy.<span class="title">createVoucherOrder</span><span class="params">(voucherId)</span></span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="è¯´æ˜ï¼š-3">è¯´æ˜ï¼š</h3>
<ul>
<li><code>lock:order:userId</code>ï¼šç»™æ¯ä¸ªç”¨æˆ·è®¾ç½®å”¯ä¸€çš„é”ï¼Œé˜²æ­¢åŒä¸€ç”¨æˆ·é‡å¤ä¸‹å•ï¼›</li>
<li>ä½¿ç”¨ <code>tryLock()</code> è·å–é”ï¼ˆé»˜è®¤ç«‹å³å°è¯•è·å–ä¸€æ¬¡ï¼‰ï¼›</li>
<li>Redisson è‡ªåŠ¨å¤„ç†ç»­æœŸå’Œçº¿ç¨‹éš”ç¦»ï¼ˆä¸éœ€è¦ä½ æ‰‹åŠ¨åˆ¤æ–­ UUID + çº¿ç¨‹ IDï¼‰ï¼›</li>
<li>é‡Šæ”¾é”ç›´æ¥è°ƒç”¨ <code>.unlock()</code>ï¼Œæ›´ç®€å•æ›´å®‰å…¨ã€‚</li>
</ul>
<p>ç¬¬4æ­¥ï¼Œå¯åŠ¨æœåŠ¡</p>
<p>å‘é€ä¸‹é¢çš„è¯·æ±‚ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-198.png" alt="img"></p>
<p>åœ¨æ‰§è¡Œé‡Šæ”¾é”çš„è¯­å¥å‰ï¼Œå¯ä»¥çœ‹åˆ°Redisä¸­æœ‰é”çš„è®°å½•ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-199.png" alt="img"></p>
<p>ç”¨jmeteræ¥æµ‹è¯•ï¼Œå¯ä»¥å‘ç°æ²¡æœ‰å‡ºç°å¹¶å‘å®‰å…¨é—®é¢˜ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-200.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-201.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-202.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-204.png" alt="img"></p>
<h3 id="5-3-åˆ†å¸ƒå¼é”-redissionå¯é‡å…¥é”åŸç†">5.3 åˆ†å¸ƒå¼é”-redissionå¯é‡å…¥é”åŸç†</h3>
<h4 id="5-3-1é‡å…¥é”çš„æ¦‚å¿µï¼ˆæœ¬åœ°é”å’Œåˆ†å¸ƒå¼é”é€šç”¨ï¼‰">5.3.1<strong>é‡å…¥é”çš„æ¦‚å¿µï¼ˆæœ¬åœ°é”å’Œåˆ†å¸ƒå¼é”é€šç”¨ï¼‰</strong></h4>
<p>å¯é‡å…¥é”ï¼ˆReentrant Lockï¼‰å…è®¸ <strong>åŒä¸€ä¸ªçº¿ç¨‹é‡å¤è·å–åŒä¸€æŠŠé”</strong>ã€‚</p>
<ul>
<li>ä¾‹å¦‚ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†ä¸¤æ¬¡ <code>lock.lock()</code>ï¼Œåªè¦çº¿ç¨‹ä¸€è‡´ï¼Œä¸ä¼šæ­»é”ã€‚è§£é”æ—¶å¿…é¡»è§£é”ä¸¤æ¬¡æ‰å½»åº•é‡Šæ”¾ã€‚</li>
</ul>
<h4 id="5-3-2æœ¬åœ°é”ï¼ˆå¦‚-Java-ReentrantLockï¼‰çš„å®ç°æœºåˆ¶">5.3.2<strong>æœ¬åœ°é”ï¼ˆå¦‚ Java ReentrantLockï¼‰çš„å®ç°æœºåˆ¶</strong></h4>
<ul>
<li>
<p>é€šè¿‡ä¸€ä¸ª</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatile <span class="keyword">state</span></span><br></pre></td></tr></table></figure>
<p>çŠ¶æ€å˜é‡æ§åˆ¶é‡å…¥æ¬¡æ•°ã€‚</p>
<ul>
<li>åˆå§‹çŠ¶æ€ï¼š<code>state = 0</code> è¡¨ç¤ºæ²¡äººæŒæœ‰ã€‚</li>
<li>ç¬¬ä¸€æ¬¡è·å–ï¼š<code>state = 1</code></li>
<li>åŒä¸€çº¿ç¨‹å†æ¬¡è·å–ï¼š<code>state += 1</code></li>
<li>æ¯æ¬¡é‡Šæ”¾ï¼š<code>state -= 1</code></li>
<li>å½“ <code>state == 0</code>ï¼Œé”é‡Šæ”¾æˆåŠŸã€‚</li>
</ul>
</li>
</ul>
<h4 id="5-3-3Redisson-å¯é‡å…¥åˆ†å¸ƒå¼é”å®ç°åŸç†">5.3.3<strong>Redisson å¯é‡å…¥åˆ†å¸ƒå¼é”å®ç°åŸç†</strong></h4>
<h4 id="1-Redis-ä¸­å¦‚ä½•å­˜å‚¨é”ï¼Ÿ">1. Redis ä¸­å¦‚ä½•å­˜å‚¨é”ï¼Ÿ</h4>
<ul>
<li>
<p>ä½¿ç”¨</p>
<p>Hash ç»“æ„</p>
<p>å­˜å‚¨ï¼š</p>
<ul>
<li>Keyï¼šé”çš„åç§°ï¼ˆå¦‚ <code>&quot;lock&quot;</code>ï¼‰</li>
<li>Fieldï¼ˆå°keyï¼‰ï¼š<code>UUID:ThreadId</code> è¡¨ç¤ºå“ªä¸ªçº¿ç¨‹æŒæœ‰é”</li>
<li>Valueï¼šé‡å…¥æ¬¡æ•°ï¼Œä¾‹å¦‚ <code>1</code> è¡¨ç¤ºåŠ é”äº†ä¸€æ¬¡</li>
</ul>
</li>
</ul>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lock &#123;</span><br><span class="line">  thread1 : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2.é”çš„è·å–é€»è¾‘</strong></p>
<p>æƒ…å†µ1ï¼šé”ä¸å­˜åœ¨ï¼Œç›´æ¥åŠ é”</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> redis.<span class="keyword">call</span>(<span class="string">&#x27;exists&#x27;</span>, KEYS[<span class="number">1</span>]) == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">  redis.<span class="keyword">call</span>(<span class="string">&#x27;hset&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>], <span class="number">1</span>);</span><br><span class="line">  redis.<span class="keyword">call</span>(<span class="string">&#x27;pexpire&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">return</span> nil;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<ul>
<li>åˆ¤æ–­é”æ˜¯å¦å­˜åœ¨ï¼ˆ<code>exists</code>ï¼‰</li>
<li>å¦‚æœä¸å­˜åœ¨ï¼Œè®¾ç½® hash <code>field = threadId</code>ï¼Œå€¼ä¸º 1ï¼ˆåŠ é”ä¸€æ¬¡ï¼‰</li>
<li>è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆé˜²æ­¢æ­»é”ï¼‰</li>
<li>è¿”å› <code>nil</code>ï¼Œè¡¨ç¤ºåŠ é”æˆåŠŸ</li>
</ul>
<p>æƒ…å†µ2ï¼šé”å­˜åœ¨ï¼Œä¸”æ˜¯è‡ªå·±çº¿ç¨‹æŒæœ‰ï¼ˆå¯é‡å…¥ï¼‰</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if redis.call(<span class="string">&#x27;hexists&#x27;</span>, <span class="symbol">KEYS</span>[<span class="number">1</span>], <span class="symbol">ARGV</span>[<span class="number">2</span>]) == <span class="number">1</span> then</span><br><span class="line">  redis.call(<span class="string">&#x27;hincrby&#x27;</span>, <span class="symbol">KEYS</span>[<span class="number">1</span>], <span class="symbol">ARGV</span>[<span class="number">2</span>], <span class="number">1</span>);</span><br><span class="line">  redis.call(<span class="string">&#x27;pexpire&#x27;</span>, <span class="symbol">KEYS</span>[<span class="number">1</span>], <span class="symbol">ARGV</span>[<span class="number">1</span>]);</span><br><span class="line">  return nil;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<ul>
<li>åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦å·²æŒæœ‰ï¼ˆ<code>hexists</code>ï¼‰</li>
<li>å¦‚æœæ˜¯ï¼š<code>hincrby</code> é”è®¡æ•° +1</li>
<li>ç»­æœŸï¼ˆ<code>pexpire</code>ï¼‰</li>
<li>è¿”å› <code>nil</code> è¡¨ç¤ºåŠ é”æˆåŠŸï¼ˆé‡å…¥ï¼‰</li>
</ul>
<p>æƒ…å†µ3ï¼šé”è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">return</span> redis.<span class="title">call</span><span class="params">(<span class="string">&#x27;pttl&#x27;</span>, KEYS[<span class="number">1</span>])</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>è¿”å›å‰©ä½™è¿‡æœŸæ—¶é—´</li>
<li>Java ç«¯æ ¹æ®è¿”å›å€¼æ˜¯å¦æ˜¯ <code>null</code> åˆ¤æ–­æ˜¯å¦åŠ é”æˆåŠŸï¼Œå¦‚æœå¤±è´¥ä¼šè¿›è¡Œ <strong>è‡ªæ—‹é‡è¯•</strong>ï¼ˆwhile(true) å¾ªç¯ï¼‰</li>
</ul>
<p>å®Œæ•´ä»£ç </p>
<figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;if (redis.call(&#x27;</span>exists&#x27;, KEYS[<span class="number">1</span>]) == <span class="number">0</span>) <span class="keyword">then</span> <span class="string">&quot; +</span></span><br><span class="line"><span class="string">                  &quot;</span>redis.call(<span class="string">&#x27;hset&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>], <span class="number">1</span>); <span class="string">&quot; +</span></span><br><span class="line"><span class="string">                  &quot;</span>redis.call(<span class="string">&#x27;pexpire&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>]); <span class="string">&quot; +</span></span><br><span class="line"><span class="string">                  &quot;</span><span class="keyword">return</span> nil; <span class="string">&quot; +</span></span><br><span class="line"><span class="string">              &quot;</span><span class="keyword">end</span>; <span class="string">&quot; +</span></span><br><span class="line"><span class="string">              &quot;</span><span class="keyword">if</span> (redis.call(<span class="string">&#x27;hexists&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>]) == <span class="number">1</span>) <span class="keyword">then</span> <span class="string">&quot; +</span></span><br><span class="line"><span class="string">                  &quot;</span>redis.call(<span class="string">&#x27;hincrby&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>], <span class="number">1</span>); <span class="string">&quot; +</span></span><br><span class="line"><span class="string">                  &quot;</span>redis.call(<span class="string">&#x27;pexpire&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>]); <span class="string">&quot; +</span></span><br><span class="line"><span class="string">                  &quot;</span><span class="keyword">return</span> nil; <span class="string">&quot; +</span></span><br><span class="line"><span class="string">              &quot;</span><span class="keyword">end</span>; <span class="string">&quot; +</span></span><br><span class="line"><span class="string">              &quot;</span><span class="keyword">return</span> redis.call(<span class="string">&#x27;pttl&#x27;</span>, KEYS[<span class="number">1</span>]);<span class="string">&quot;</span></span><br></pre></td></tr></table></figure>
<p>5.3.4 é‡Šæ”¾é”çš„é€»è¾‘</p>
<ul>
<li>åˆ¤æ–­é”æ˜¯ä¸æ˜¯è‡ªå·±åŠ çš„ï¼ˆåˆ¤æ–­ field æ˜¯å¦æ˜¯è‡ªå·±ï¼‰</li>
<li><code>hincrby</code> æŠŠé”å€¼å‡1</li>
<li>å¦‚æœå‡å®Œä¸º0ï¼Œä½¿ç”¨ <code>del</code> åˆ é™¤æ•´ä¸ªé”</li>
<li>è‹¥ä¸æ˜¯è‡ªå·±çº¿ç¨‹ï¼ŒåŠ é”å¤±è´¥</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-205-1024x443.png" alt="img"></p>
<p>ä»£ç è¯´æ˜ï¼š</p>
<ul>
<li>ç¬¬ä¸€æ¬¡ <code>tryLock()</code> æˆåŠŸåï¼Œè°ƒç”¨ <code>method2()</code> å†åŠ ä¸€æ¬¡é”ï¼Œä¹ŸæˆåŠŸï¼Œä½“ç° <strong>å¯é‡å…¥æ€§</strong>ã€‚</li>
<li>æ¯æ¬¡ <code>unlock()</code> åªæ˜¯è®© <code>value -1</code>ï¼Œç›´åˆ°ä¸º0ï¼Œæ‰é‡Šæ”¾ Redis ä¸­çš„é”ã€‚</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-207-1024x514.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-206-1024x468.png" alt="img"></p>
<h3 id="5-4-åˆ†å¸ƒå¼é”-redissioné”é‡è¯•å’ŒWatchDogæœºåˆ¶">5.4 åˆ†å¸ƒå¼é”-redissioné”é‡è¯•å’ŒWatchDogæœºåˆ¶</h3>
<h4 id="5-4-1Redisson-åˆ†å¸ƒå¼é”ä¸­-tryLock-é‡è¯•-WatchDog-è‡ªåŠ¨ç»­æœŸçš„æºç æœºåˆ¶ã€‚">5.4.1Redisson åˆ†å¸ƒå¼é”ä¸­ tryLock é‡è¯• + WatchDog è‡ªåŠ¨ç»­æœŸçš„æºç æœºåˆ¶ã€‚</h4>
<p>ä¸‹é¢æ˜¯å¯¹å«æœ‰waitTimeï¼ˆç­‰å¾…æ—¶é—´ï¼‰çš„tryLockçš„è·Ÿè¸ªï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-208.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-209.png" alt="img"></p>
<p><strong>ä¸»é¢˜ï¼š<code>tryLock(long waitTime, TimeUnit unit)</code> çš„æºç è°ƒç”¨é“¾ + é»˜è®¤çœ‹é—¨ç‹—æ—¶é—´ä¸º 30 ç§’</strong></p>
<p>ä½ è°ƒç”¨çš„æ˜¯ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">tryLock</span><span class="params">(waitTime, unit)</span></span></span><br></pre></td></tr></table></figure>
<p>å®é™…ä¼šè°ƒç”¨é‡è½½æ–¹æ³•ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">tryLock</span><span class="params">(waitTime, -<span class="number">1</span>L, unit)</span></span> <span class="comment">// -1 è¡¨ç¤ºæœªæŒ‡å®šè¶…æ—¶æ—¶é—´</span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-210.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-211-1024x378.png" alt="img"></p>
<p>é‡ç‚¹å«ä¹‰ï¼š</p>
<p><code>leaseTime = -1</code> è§¦å‘ <strong>WatchDog çœ‹é—¨ç‹—æœºåˆ¶</strong></p>
<p>é»˜è®¤é…ç½® this.lockWatchdogTimeout = 30000L // 30ç§’</p>
<p>Lua è„šæœ¬è¯´æ˜</p>
<p>return redis.call(â€˜pttlâ€™, KEYS[1]);</p>
<ul>
<li>è¿”å›å½“å‰é”å‰©ä½™æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</li>
<li>å¦‚æœé”è¢«å ç”¨ï¼Œåˆ™ Redisson ç”¨è¿™ä¸ªå€¼åˆ¤æ–­æ˜¯å¦è‡ªæ—‹é‡è¯•</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-212.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-213.png" alt="img"></p>
<p><strong>ä¸»é¢˜ï¼šé”çš„è·å–æµç¨‹å’Œé‡Šæ”¾é”çš„ Lua è„šæœ¬å®ç°é€»è¾‘</strong></p>
<p>è·å–é”é€»è¾‘ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ttl == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// åŠ é”æˆåŠŸ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦åˆ™è¿›å…¥å‰©ä½™æ—¶é—´åˆ¤æ–­ï¼šæ˜¯å¦è¿˜æœ‰ç­‰å¾…æœºä¼šã€‚</p>
<p>é‡Šæ”¾é”é€»è¾‘ï¼ˆRedis è„šæœ¬ï¼‰</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;del&#x27;</span>, KEYS[<span class="number">1</span>]);</span><br><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;publish&#x27;</span>, KEYS[<span class="number">2</span>], ARGV[<span class="number">1</span>]); <span class="comment">// å‘å¸ƒè§£é”é€šçŸ¥</span></span><br></pre></td></tr></table></figure>
<p>å½“é”é‡Šæ”¾æ—¶ï¼Œé€šè¿‡ Redis <code>publish</code> å‘æ¶ˆæ¯ï¼Œé€šçŸ¥å…¶ä»–çº¿ç¨‹â€œé”å·²é‡Šæ”¾â€ï¼Œä»¥å”¤é†’å®ƒä»¬ç»§ç»­æŠ¢é”ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-214.png" alt="img"></p>
<p>è¯´æ˜ subscriberFuture.awaitï¼š</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">subscriberFuture.await(<span class="built_in">time</span>, TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure>
<ul>
<li>ç­‰å¾…ä¸€æ®µæ—¶é—´å†…æ˜¯å¦èƒ½æ”¶åˆ°é”é‡Šæ”¾çš„é€šçŸ¥ï¼ˆè®¢é˜…æ¨¡å¼ï¼‰</li>
<li>å¦‚æœ <code>false</code>ï¼Œè¡¨ç¤º<strong>è¶…æ—¶æœªæ”¶åˆ°é€šçŸ¥</strong></li>
</ul>
<p>åç»­ç»§ç»­æŠ¢é”ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">tryAcquire</span><span class="params">(waitTime, leaseTime, unit, threadId)</span></span></span><br></pre></td></tr></table></figure>
<p>ä¼šå†è°ƒç”¨è¿™ä¸ªæ–¹æ³•å°è¯•é‡æ–°è·å–é”ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-215.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-216.png" alt="img"></p>
<p>Redisson å¹¶éæ­»ç­‰ï¼Œè€Œæ˜¯ç»“åˆâ€œç­‰å¾…å‘å¸ƒ+ä¸»åŠ¨æŠ¢é”â€ï¼Œé¿å…èµ„æºæµªè´¹ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-217.png" alt="img"></p>
<p>ä¸»é¢˜ï¼šè§¦å‘ WatchDog ç»­æœŸçš„é€»è¾‘ï¼ˆé‡ç‚¹ï¼‰</p>
<p>æ¡ä»¶åˆ¤æ–­ï¼š</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (leaseTime <span class="operator">=</span><span class="operator">=</span> -<span class="number">1</span>) // è¡¨ç¤ºæœªæŒ‡å®šé”æ—¶é—´</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆ Redisson å°†é»˜è®¤ä½¿ç”¨ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">getLockWatchdogTimeout</span><span class="params">()</span></span> = <span class="number">30</span>_000 ms</span><br></pre></td></tr></table></figure>
<p>æˆåŠŸåŠ é”åè°ƒç”¨ï¼š</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">scheduleExpirationRenewal</span>(threadId); <span class="comment">// å¼€å¯ç»­çº¦æœºåˆ¶</span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-218.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-219.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-220.png" alt="img"></p>
<p>ä¸»é¢˜ï¼šWatchDog å®šæ—¶ä»»åŠ¡å¦‚ä½•æ¯ 10 ç§’è‡ªåŠ¨ç»­æœŸ</p>
<p>æ ¸å¿ƒé€»è¾‘ï¼š</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.<span class="built_in">int</span>ernalLockLeaseTime / <span class="number">3</span></span><br></pre></td></tr></table></figure>
<p>é»˜è®¤é”æ—¶é—´æ˜¯ 30 ç§’ï¼Œæ‰€ä»¥æ¯ <strong>10ç§’è°ƒç”¨ä¸€æ¬¡</strong> <code>renewExpiration()</code>ï¼Œå®ç°æŒç»­ç»­æœŸã€‚</p>
<p>Luaè„šæœ¬ä¸­çš„ç»­æœŸæ“ä½œï¼š</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;pexpire&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>]); <span class="comment">// ç»­æœŸé”æœ‰æ•ˆæ—¶é—´</span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-221.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-222.png" alt="img"></p>
<p>ä¸»é¢˜ï¼šå–æ¶ˆçœ‹é—¨ç‹—ç»­æœŸä»»åŠ¡ï¼ˆé‡Šæ”¾é”æ—¶è§¦å‘ï¼‰</p>
<p>è§£é”åè°ƒç”¨ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.cancelExpirationRenewal(threadId)</span><br></pre></td></tr></table></figure>
<ul>
<li>ä½œç”¨ï¼šåœæ­¢å®šæ—¶å™¨ï¼Œé‡Šæ”¾çº¿ç¨‹èµ„æº</li>
<li>åªæœ‰å½“é”çœŸæ­£é‡Šæ”¾æˆ–è€…çº¿ç¨‹ç»“æŸæ—¶ï¼Œæ‰ä¼šå–æ¶ˆç»­æœŸé€»è¾‘ï¼Œç¡®ä¿èµ„æºä¸æµªè´¹</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-223.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-224.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-225-1024x524.png" alt="img"></p>
<h4 id="åŠ é”é€»è¾‘æ€»ç»“ï¼š">åŠ é”é€»è¾‘æ€»ç»“ï¼š</h4>
<ul>
<li>
<p>ttl == null</p>
<p>ï¼šè·å–é”æˆåŠŸ</p>
<ul>
<li>leaseTime == -1ï¼šå¼€å¯è‡ªåŠ¨ç»­æœŸï¼ˆWatchDogï¼‰</li>
<li>leaseTime != -1ï¼šå®šæ—¶é‡Šæ”¾é”ï¼Œä¸ç»­æœŸ</li>
</ul>
</li>
<li>
<p>ttl != null</p>
<p>ï¼šè·å–é”å¤±è´¥</p>
<ul>
<li>å‰©ä½™æ—¶é—´ &gt; 0ï¼šè®¢é˜…è§£é”ä¿¡å·</li>
<li>ç­‰å¾…å¹¶åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œè¿›è¡Œä¸‹ä¸€è½®å°è¯•</li>
</ul>
</li>
</ul>
<h4 id="è§£é”é€»è¾‘ï¼š">è§£é”é€»è¾‘ï¼š</h4>
<ul>
<li>æˆåŠŸé‡Šæ”¾åï¼Œ<code>publish</code> å‘å¸ƒæ¶ˆæ¯é€šçŸ¥ç­‰å¾…çº¿ç¨‹</li>
<li>å–æ¶ˆç»­çº¦ä»»åŠ¡ï¼Œæ¸…ç† <code>EXIPRATION_RENEWAL_MAP</code></li>
</ul>
<p><strong>æ€»ç»“ä¸€å¥è¯ï¼šRedisson åˆ†å¸ƒå¼é” = <code>Redis + Lua + Javaå®šæ—¶ä»»åŠ¡</code> å®ç°äº†ä¸€ä¸ª å¯é‡å…¥ã€è‡ªåŠ¨ç»­æœŸã€å¸¦å‘å¸ƒé€šçŸ¥æœºåˆ¶çš„åˆ†å¸ƒå¼é”ç³»ç»Ÿï¼Œå¥å£®ä¸”é«˜æ€§èƒ½ã€‚</strong></p>
<h4 id="5-4-2Redisson-çš„ä¸¤ç§åŠ é”æ–¹å¼">5.4.2Redisson çš„ä¸¤ç§åŠ é”æ–¹å¼</h4>
<p>Redisson çš„ <code>lock()</code> æ–¹æ³•åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>lock(long leaseTime, TimeUnit unit)</code></td>
<td><strong>æŒ‡å®šé”çš„è¶…æ—¶æ—¶é—´</strong>ï¼Œä¸ä¼šå¯åŠ¨çœ‹é—¨ç‹—</td>
</tr>
<tr>
<td><code>lock()</code>ï¼ˆæ— å‚ï¼‰</td>
<td><strong>æœªæŒ‡å®šé”è¶…æ—¶æ—¶é—´</strong>ï¼ŒRedisson ä¼šè‡ªåŠ¨å¯åŠ¨ <strong>WatchDog</strong> å®šæ—¶ç»­çº¦æœºåˆ¶</td>
</tr>
</tbody>
</table>
<h4 id="5-4-3lock-åŠ é”æµç¨‹å›é¡¾">5.4.3lock() åŠ é”æµç¨‹å›é¡¾</h4>
<p>1.è·å–å½“å‰çº¿ç¨‹ ID</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">long threadId <span class="operator">=</span> Thread.currentThread().getId()<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>2.å°è¯•åŠ é”ï¼ˆtryAcquireï¼‰</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Long</span> ttl = tryAcquire(-<span class="number">1</span>, leaseTime, unit, threadId);</span><br><span class="line"><span class="keyword">if</span> (ttl == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>; <span class="comment">// åŠ é”æˆåŠŸæˆ–é‡å…¥æˆåŠŸ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è‹¥è¿”å›å€¼ä¸º <code>null</code>ï¼Œè¡¨ç¤ºåŠ é”æˆåŠŸï¼ˆæˆ–æ˜¯å½“å‰çº¿ç¨‹é‡å…¥ï¼‰<br>
è‹¥è¿”å› <code>ttl</code>ï¼ˆè¿‡æœŸæ—¶é—´ï¼‰ï¼Œè¡¨ç¤ºé”è¢«å…¶ä»–çº¿ç¨‹å ç”¨ï¼Œè¿›å…¥ <code>while(true)</code> è‡ªæ—‹é‡è¯•é€»è¾‘</p>
<h4 id="5-4-4ä¸‰ç§åŠ é”åœºæ™¯é€»è¾‘åˆ¤æ–­ï¼ˆtryAcquire-å†…éƒ¨ï¼‰">5.4.4ä¸‰ç§åŠ é”åœºæ™¯é€»è¾‘åˆ¤æ–­ï¼ˆtryAcquire å†…éƒ¨ï¼‰</h4>
<table>
<thead>
<tr>
<th>æƒ…å†µ</th>
<th>Redis é€»è¾‘</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>é”ä¸å­˜åœ¨</td>
<td><code>hset</code> + <code>pexpire</code></td>
<td>ç›´æ¥åŠ é”æˆåŠŸ</td>
</tr>
<tr>
<td>é”æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰</td>
<td><code>hincrby</code> + <code>pexpire</code></td>
<td>å¯é‡å…¥ï¼Œè®¡æ•°+1</td>
</tr>
<tr>
<td>é”å­˜åœ¨ï¼Œéå½“å‰çº¿ç¨‹</td>
<td>è¿”å›å‰©ä½™è¿‡æœŸæ—¶é—´</td>
<td>åŠ é”å¤±è´¥ï¼Œç­‰å¾…è‡ªæ—‹é‡è¯•</td>
</tr>
</tbody>
</table>
<h4 id="5-4-5-é‡è¯•æœºåˆ¶ï¼ˆå¾ªç¯æŠ¢é”ï¼‰">5.4.5 é‡è¯•æœºåˆ¶ï¼ˆå¾ªç¯æŠ¢é”ï¼‰</h4>
<p>å¦‚æœåˆå§‹åŠ é”å¤±è´¥ï¼Œä¼šè¿›å…¥ä»¥ä¸‹é€»è¾‘ï¼š</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    tryAcquire() <span class="comment">// ä¸æ–­å°è¯•è·å–é”</span></span><br><span class="line">    <span class="params">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Redisson ä¼šè‡ªæ—‹å°è¯•ï¼Œç›´åˆ°è·å–é”æˆåŠŸæˆ–è¶…æ—¶ã€‚</p>
<h4 id="5-4-6-çœ‹é—¨ç‹—æœºåˆ¶ï¼ˆWatchDogï¼‰">5.4.6 çœ‹é—¨ç‹—æœºåˆ¶ï¼ˆWatchDogï¼‰</h4>
<h4 id="é€‚ç”¨åœºæ™¯ï¼š">é€‚ç”¨åœºæ™¯ï¼š</h4>
<p>è°ƒç”¨ <code>lock()</code> <strong>æ— å‚</strong>ç‰ˆæœ¬æ—¶ï¼Œä¸æŒ‡å®š <code>leaseTime</code>ï¼ŒRedisson é»˜è®¤è®¾ç½®é”æœ‰æ•ˆæœŸä¸º <strong>30ç§’</strong>ï¼Œå¹¶ä¼šå¯åŠ¨ <strong>è‡ªåŠ¨ç»­æœŸæœºåˆ¶</strong>ã€‚</p>
<p>WatchDog å®ç°æ ¸å¿ƒé€»è¾‘ï¼š</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ttlRemainingFuture.onComplete<span class="function"><span class="params">((ttlRemaining, e) -&gt; &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">if</span> (ttlRemaining == <span class="literal">null</span>) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        scheduleExpirationRenewal(threadId);</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;)</span>;</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœåŠ é”æˆåŠŸï¼Œå°±è°ƒç”¨ <code>scheduleExpirationRenewal()</code>ï¼Œè§¦å‘è‡ªåŠ¨ç»­æœŸã€‚</p>
<h4 id="5-4-7-ç»­çº¦æœºåˆ¶æºç åˆ†æï¼ˆrenewExpirationï¼‰">5.4.7 ç»­çº¦æœºåˆ¶æºç åˆ†æï¼ˆrenewExpirationï¼‰</h4>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">void</span> <span class="title function_">renewExpiration</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// æ¯æ¬¡ç»­æœŸéƒ½ä¼šé‡æ–°åˆ›å»ºä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼ˆ10ç§’åè§¦å‘ï¼‰</span></span><br><span class="line">    <span class="title class_">Timeout</span> task = commandExecutor.<span class="title function_">getConnectionManager</span>().<span class="title function_">newTimeout</span>(<span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">run</span>(<span class="params"><span class="title class_">Timeout</span> timeout</span>) &#123;</span><br><span class="line">            <span class="comment">// ä»æŒæœ‰é” -&gt; å†ç»­æœŸ30s</span></span><br><span class="line">            <span class="title function_">renewExpirationAsync</span>(threadId).<span class="title function_">onComplete</span>((res, e) -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (res) &#123;</span><br><span class="line">                    <span class="title function_">renewExpiration</span>(); <span class="comment">// é€’å½’è®¾ç½®ä¸‹æ¬¡ç»­æœŸ</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, internalLockLeaseTime / <span class="number">3</span>, <span class="title class_">TimeUnit</span>.<span class="property">MILLISECONDS</span>); <span class="comment">// é»˜è®¤æ˜¯æ¯10ç§’æ‰§è¡Œä¸€æ¬¡ï¼ˆ30/3ï¼‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="æ•´ä½“è¿‡ç¨‹ï¼š">æ•´ä½“è¿‡ç¨‹ï¼š</h4>
<ol>
<li><strong>é»˜è®¤é”æœ‰æ•ˆæ—¶é—´ï¼š30ç§’</strong></li>
<li><strong>æ¯ 10 ç§’ï¼ˆ30/3ï¼‰å¯åŠ¨ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ç»­æœŸ</strong></li>
<li>å¦‚æœçº¿ç¨‹è¿˜æ´»ç€ä¸”ä»æŒæœ‰é” â†’ é‡ç½®é”çš„è¿‡æœŸæ—¶é—´ä¸º 30ç§’</li>
<li>å¦‚æœçº¿ç¨‹æŒ‚äº†ï¼ˆå¦‚å®•æœºã€å¼‚å¸¸ï¼‰ â†’ ä¸å†ç»­æœŸï¼Œé”è‡ªåŠ¨è¿‡æœŸé‡Šæ”¾</li>
</ol>
<h4 id="5-4-8-æ€»ç»“ï¼šRedisson-é”çš„æ ¸å¿ƒæœºåˆ¶">5.4.8 æ€»ç»“ï¼šRedisson é”çš„æ ¸å¿ƒæœºåˆ¶</h4>
<table>
<thead>
<tr>
<th>æœºåˆ¶</th>
<th>åŠŸèƒ½</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>tryAcquire()</code></td>
<td>å°è¯•åŠ é”é€»è¾‘ï¼Œåˆ¤æ–­é”çŠ¶æ€</td>
</tr>
<tr>
<td><code>while(true)</code></td>
<td>è‡ªæ—‹é‡è¯•æœºåˆ¶ï¼Œç›´åˆ°åŠ é”æˆåŠŸ</td>
</tr>
<tr>
<td><code>WatchDog</code>ï¼ˆçœ‹é—¨ç‹—ï¼‰</td>
<td>è‡ªåŠ¨ç»­æœŸï¼Œé˜²æ­¢é”æå‰é‡Šæ”¾</td>
</tr>
<tr>
<td><code>renewExpiration()</code></td>
<td>å¯åŠ¨å®šæ—¶ä»»åŠ¡æ¯ 10 ç§’ç»­ä¸€æ¬¡æœŸ</td>
</tr>
<tr>
<td>é”è‡ªåŠ¨é‡Šæ”¾</td>
<td>çº¿ç¨‹æŒ‚æ‰ä¸ä¼šç»­æœŸï¼Œé”30ç§’åè‡ªåŠ¨é‡Šæ”¾</td>
</tr>
</tbody>
</table>
<ul>
<li>çœ‹é—¨ç‹—æœºåˆ¶æ˜¯ <strong>çº¿ç¨‹æŒæœ‰é”è‡ªåŠ¨ç»­æœŸçš„ä¿éšœ</strong>ï¼›</li>
<li>ä½¿ç”¨ <code>lock()</code>ï¼ˆæ— å‚ï¼‰æ—¶ <strong>ä¸è¦æ‹…å¿ƒæ­»é”</strong>ï¼Œå³ä½¿å¿˜äº†é‡Šæ”¾é”ï¼Œ30ç§’åä¹Ÿä¼šé‡Šæ”¾ï¼›</li>
<li>ä¸ä¼  <code>leaseTime</code> æ‰ä¼šè§¦å‘ WatchDogï¼›</li>
<li>Redisson çš„é‡å…¥é”ä¾é  <code>Hashç»“æ„ + çº¿ç¨‹id + è®¡æ•°</code> å®ç°ã€‚</li>
</ul>
<h3 id="5-5-åˆ†å¸ƒå¼é”-redissioné”çš„MutiLockåŸç†">5.5 åˆ†å¸ƒå¼é”-redissioné”çš„MutiLockåŸç†</h3>
<p><strong>ä¸ºä»€ä¹ˆéœ€è¦ MultiLockï¼ŸRedisson é”ä¸¢å¤±çš„èƒŒæ™¯</strong></p>
<p>ä¸ºäº†æé«˜redisçš„å¯ç”¨æ€§ï¼Œæˆ‘ä»¬ä¼šæ­å»ºé›†ç¾¤æˆ–è€…ä¸»ä»ï¼Œç°åœ¨ä»¥ä¸»ä»ä¸ºä¾‹</p>
<p>ä¸»ä»åŒæ­¥å»¶è¿Ÿ + å®•æœºå¯¼è‡´é”ä¸¢å¤±</p>
<p>å›¾ä¸­æè¿°çš„æ˜¯ä»¥ä¸‹åœºæ™¯ï¼š</p>
<ol>
<li>Java åº”ç”¨å°è¯•è·å– Redis é”ï¼š<code>SET lock thread1 NX EX 10</code>ï¼ˆè®¾ç½®é”ï¼‰</li>
<li>é”æˆåŠŸè®¾ç½®åˆ° Redis <strong>ä¸»èŠ‚ç‚¹</strong>ï¼ˆMasterï¼‰</li>
<li>Redis ä¸»èŠ‚ç‚¹è¿˜æœªå°†é”åŒæ­¥åˆ°ä»èŠ‚ç‚¹ï¼ˆSlaveï¼‰</li>
<li>æ­¤æ—¶ä¸»èŠ‚ç‚¹å®•æœºäº†</li>
<li>Redis è‡ªåŠ¨ä» Slave ä¸­é€‰å‡ºä¸€ä¸ªæ–°çš„ Masterï¼ˆåŸæ¥çš„ä»èŠ‚ç‚¹ï¼‰</li>
<li>ç”±äºæ–° Master ä¸Š <strong>æ²¡æœ‰é”æ•°æ®</strong> â†’ é”ä¸¢å¤±ï¼ğŸ’¥</li>
</ol>
<p>è¿™æ„å‘³ç€ï¼š<strong>å³ä½¿ä½ åˆšåŠ å®Œé”ï¼Œé”ä¿¡æ¯ä¹Ÿå¯èƒ½å› ä¸ºä¸»ä»æœªåŒæ­¥å°±ä¸¢å¤±ï¼Œé€ æˆå¹¶å‘å®‰å…¨éšæ‚£ï¼</strong></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-226-1024x487.png" alt="img"></p>
<p>ä¸ºäº†é¿å…ä¸Šè¿°é”ä¸¢å¤±é—®é¢˜ï¼Œ<strong>Redisson æå‡ºäº† MultiLock</strong>ï¼Œä¹Ÿå«â€œå¤šèŠ‚ç‚¹é”â€æˆ–â€œè”åˆé”â€ã€‚</p>
<h4 id="MultiLock-æ ¸å¿ƒåŸç†ï¼š">MultiLock æ ¸å¿ƒåŸç†ï¼š</h4>
<ul>
<li>å¦‚æœä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹å¤±è´¥ï¼Œåˆ™å¤±è´¥çš„é”ä¼šå›æ»šå¹¶é‡Šæ”¾</li>
<li>åŒæ—¶å‘å¤šä¸ª Redis ä¸»èŠ‚ç‚¹åŠ é”ï¼ˆæ¯”å¦‚ Redis ä¸»æœºé›†ç¾¤ï¼‰</li>
<li>åªæœ‰ <strong>æ‰€æœ‰èŠ‚ç‚¹éƒ½åŠ é”æˆåŠŸ</strong>ï¼Œæ‰ç®—çœŸæ­£è·å–åˆ°é”</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-227-1024x371.png" alt="img"></p>
<p>é‚£ä¹ˆMutiLock åŠ é”åŸç†æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿç¬”è€…ç”»äº†ä¸€å¹…å›¾æ¥è¯´æ˜:å½“æˆ‘ä»¬å»è®¾ç½®äº†å¤šä¸ªé”æ—¶ï¼Œredissionä¼šå°†å¤šä¸ªé”æ·»åŠ åˆ°ä¸€ä¸ªé›†åˆä¸­ï¼Œç„¶åç”¨whileå¾ªç¯å»ä¸åœå»å°è¯•æ‹¿é”ï¼Œä½†æ˜¯ä¼šæœ‰ä¸€ä¸ªæ€»å…±çš„åŠ é”æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´æ˜¯ç”¨éœ€è¦åŠ é”çš„ä¸ªæ•° * 1500ms ï¼Œå‡è®¾æœ‰3ä¸ªé”ï¼Œé‚£ä¹ˆæ—¶é—´å°±æ˜¯4500msï¼Œå‡è®¾åœ¨è¿™4500mså†…ï¼Œæ‰€æœ‰çš„é”éƒ½åŠ é”æˆåŠŸï¼Œ é‚£ä¹ˆæ­¤æ—¶æ‰ç®—æ˜¯åŠ é”æˆåŠŸï¼Œå¦‚æœåœ¨4500msæœ‰çº¿ç¨‹åŠ é”å¤±è´¥ï¼Œåˆ™ä¼šå†æ¬¡å»è¿›è¡Œé‡è¯•.</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/1653553093967-1-1024x311.png" alt="img"></p>
<ol>
<li>æ”¶é›†å¤šä¸ªé”</li>
</ol>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LockList.<span class="built_in">add</span>(lock1, lock2, lock3)</span><br></pre></td></tr></table></figure>
<ul>
<li>æ”¶é›†æ‰€æœ‰å¾…åŠ é”çš„ Redis å®ä¾‹</li>
<li>è®¾ç½®æ€»åŠ é”æ—¶é—´ï¼š</li>
</ul>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æ€»è¶…æ—¶æ—¶é—´ <span class="operator">=</span> é”æ•°é‡ * <span class="number">1500</span>ms</span><br></pre></td></tr></table></figure>
<ul>
<li>ä¾‹å¦‚ï¼š3 ä¸ªé” â†’ è¶…æ—¶æ—¶é—´ä¸º 4500ms</li>
<li>åŠ é”æµç¨‹ï¼ˆä¼ªä»£ç ï¼‰ï¼š</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (tryLock(waitTime, leaseTime, TimeUnit.MILLISECONDS)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åŠ é”å¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>éå†æ¯ä¸ªé”ï¼Œé€ä¸€å°è¯•åŠ é”</li>
</ol>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">lock</span> <span class="keyword">in</span> LockList) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        boolean locked = <span class="keyword">lock</span>.tryLock(<span class="number">4500</span>ms, <span class="number">-1</span>); <span class="comment">// -1ï¼šè¡¨ç¤ºè§¦å‘è‡ªåŠ¨ç»­æœŸ</span></span><br><span class="line">        <span class="keyword">if</span> (locked) &#123;</span><br><span class="line">            acquiredLocks.<span class="keyword">add</span>(<span class="keyword">lock</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">break</span>; <span class="comment">// åŠ é”å¤±è´¥ä¸­æ–­</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-æˆåŠŸåˆ¤å®šæ¡ä»¶ï¼š">5. æˆåŠŸåˆ¤å®šæ¡ä»¶ï¼š</h4>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å¦‚æœ acquiredLocks.size == LockList.size <span class="comment">// æ‰€æœ‰é”éƒ½æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<h4 id="6-å¦‚æœæœ‰é”å¤±è´¥ï¼Œå›æ»šæ‰€æœ‰å·²è·å–çš„é”ï¼š">6. å¦‚æœæœ‰é”å¤±è´¥ï¼Œå›æ»šæ‰€æœ‰å·²è·å–çš„é”ï¼š</h4>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unlockInner(acquiredLocks); <span class="comment">// é‡Šæ”¾æ‰€æœ‰å·²åŠ é”çš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-230.png" alt="img"></p>
<h2 id="6ã€ç§’æ€ä¼˜åŒ–">6ã€ç§’æ€ä¼˜åŒ–</h2>
<h3 id="6-1-ç§’æ€ä¼˜åŒ–-å¼‚æ­¥ç§’æ€æ€è·¯">6.1 ç§’æ€ä¼˜åŒ–-å¼‚æ­¥ç§’æ€æ€è·¯</h3>
<p>æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹ä¸‹å•æµç¨‹</p>
<p>å½“ç”¨æˆ·å‘èµ·è¯·æ±‚ï¼Œæ­¤æ—¶ä¼šè¯·æ±‚nginxï¼Œnginxä¼šè®¿é—®åˆ°tomcatï¼Œè€Œtomcatä¸­çš„ç¨‹åºï¼Œä¼šè¿›è¡Œä¸²è¡Œæ“ä½œï¼Œåˆ†æˆå¦‚ä¸‹å‡ ä¸ªæ­¥éª¤</p>
<ul>
<li>1ã€æŸ¥è¯¢ä¼˜æƒ å·</li>
<li>2ã€åˆ¤æ–­ç§’æ€åº“å­˜æ˜¯å¦è¶³å¤Ÿ</li>
<li>3ã€æŸ¥è¯¢è®¢å•</li>
<li>4ã€æ ¡éªŒæ˜¯å¦æ˜¯ä¸€äººä¸€å•</li>
<li>5ã€æ‰£å‡åº“å­˜</li>
<li>6ã€åˆ›å»ºè®¢å•</li>
</ul>
<p>åœ¨è¿™å…­æ­¥æ“ä½œä¸­ï¼Œåˆæœ‰å¾ˆå¤šæ“ä½œæ˜¯è¦å»æ“ä½œæ•°æ®åº“çš„ï¼Œè€Œä¸”è¿˜æ˜¯ä¸€ä¸ªçº¿ç¨‹ä¸²è¡Œæ‰§è¡Œï¼Œ è¿™æ ·å°±ä¼šå¯¼è‡´æˆ‘ä»¬çš„ç¨‹åºæ‰§è¡Œçš„å¾ˆæ…¢ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¼‚æ­¥ç¨‹åºæ‰§è¡Œï¼Œé‚£ä¹ˆå¦‚ä½•åŠ é€Ÿå‘¢ï¼Ÿ</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-231-1024x503.png" alt="img"></p>
<p>åŸå§‹ç§’æ€æµç¨‹ï¼ˆæœªä¼˜åŒ–ï¼‰</p>
<p>è¿™å¼ å›¾æè¿°çš„æ˜¯ä¼ ç»Ÿçš„ç§’æ€è¯·æ±‚å¤„ç†æµç¨‹ï¼š</p>
<p>æµç¨‹æ­¥éª¤ï¼š</p>
<ol>
<li>ç”¨æˆ·å‘èµ·ç§’æ€è¯·æ±‚ï¼Œè¯·æ±‚è¢« Nginx æ¥æ”¶å¹¶è½¬å‘åˆ° Tomcat</li>
<li>Tomcat ä¸­æ‰§è¡Œä¸²è¡Œé€»è¾‘ï¼ˆæ¯ä¸€æ­¥éƒ½è®¿é—®æ•°æ®åº“ï¼‰ï¼š
<ul>
<li>æŸ¥è¯¢ä¼˜æƒ åˆ¸</li>
<li>åˆ¤æ–­åº“å­˜</li>
<li>æŸ¥è¯¢è®¢å•ï¼ˆæ˜¯å¦é‡å¤ï¼‰</li>
<li>æ ¡éªŒä¸€äººä¸€å•</li>
<li>æ‰£å‡åº“å­˜</li>
<li>åˆ›å»ºè®¢å•</li>
</ul>
</li>
</ol>
<p>é—®é¢˜ï¼š</p>
<ul>
<li>æ‰€æœ‰æ“ä½œéƒ½åœ¨ä¸»çº¿ç¨‹ä¸­ä¸²è¡Œæ‰§è¡Œï¼Œè®¿é—®æ•°æ®åº“é¢‘ç¹</li>
<li>è¯·æ±‚é«˜å³°æœŸï¼Œæ•°æ®åº“å‹åŠ›çˆ†ç‚¸ï¼Œå“åº”é€Ÿåº¦æ…¢</li>
<li>å®¹æ˜“å¼•å‘ <strong>è¶…å–</strong> æˆ– <strong>æ€§èƒ½ç“¶é¢ˆ</strong></li>
</ul>
<p>ä¼˜åŒ–æ–¹æ¡ˆï¼šæˆ‘ä»¬å°†è€—æ—¶æ¯”è¾ƒçŸ­çš„é€»è¾‘åˆ¤æ–­æ”¾å…¥åˆ°redisä¸­ï¼Œæ¯”å¦‚æ˜¯å¦åº“å­˜è¶³å¤Ÿï¼Œæ¯”å¦‚æ˜¯å¦ä¸€äººä¸€å•ï¼Œè¿™æ ·çš„æ“ä½œï¼Œåªè¦è¿™ç§é€»è¾‘å¯ä»¥å®Œæˆï¼Œå°±æ„å‘³ç€æˆ‘ä»¬æ˜¯ä¸€å®šå¯ä»¥ä¸‹å•å®Œæˆçš„ï¼Œæˆ‘ä»¬åªéœ€è¦è¿›è¡Œå¿«é€Ÿçš„é€»è¾‘åˆ¤æ–­ï¼Œæ ¹æœ¬å°±ä¸ç”¨ç­‰ä¸‹å•é€»è¾‘èµ°å®Œï¼Œæˆ‘ä»¬ç›´æ¥ç»™ç”¨æˆ·è¿”å›æˆåŠŸï¼Œ å†åœ¨åå°å¼€ä¸€ä¸ªçº¿ç¨‹ï¼Œåå°çº¿ç¨‹æ…¢æ…¢çš„å»æ‰§è¡Œqueueé‡Œè¾¹çš„æ¶ˆæ¯ï¼Œè¿™æ ·ç¨‹åºä¸å°±è¶…çº§å¿«äº†å—ï¼Ÿè€Œä¸”ä¹Ÿä¸ç”¨æ‹…å¿ƒçº¿ç¨‹æ± æ¶ˆè€—æ®†å°½çš„é—®é¢˜ï¼Œå› ä¸ºè¿™é‡Œæˆ‘ä»¬çš„ç¨‹åºä¸­å¹¶æ²¡æœ‰æ‰‹åŠ¨ä½¿ç”¨ä»»ä½•çº¿ç¨‹æ± ï¼Œå½“ç„¶è¿™é‡Œè¾¹æœ‰ä¸¤ä¸ªéš¾ç‚¹</p>
<p>ç¬¬ä¸€ä¸ªéš¾ç‚¹æ˜¯æˆ‘ä»¬æ€ä¹ˆåœ¨redisä¸­å»å¿«é€Ÿæ ¡éªŒä¸€äººä¸€å•ï¼Œè¿˜æœ‰åº“å­˜åˆ¤æ–­</p>
<p>ç¬¬äºŒä¸ªéš¾ç‚¹æ˜¯ç”±äºæˆ‘ä»¬æ ¡éªŒå’Œtomctä¸‹å•æ˜¯ä¸¤ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•çŸ¥é“åˆ°åº•å“ªä¸ªå•ä»–æœ€åæ˜¯å¦æˆåŠŸï¼Œæˆ–è€…æ˜¯ä¸‹å•å®Œæˆï¼Œä¸ºäº†å®Œæˆè¿™ä»¶äº‹æˆ‘ä»¬åœ¨redisæ“ä½œå®Œä¹‹åï¼Œæˆ‘ä»¬ä¼šå°†ä¸€äº›ä¿¡æ¯è¿”å›ç»™å‰ç«¯ï¼ŒåŒæ—¶ä¹Ÿä¼šæŠŠè¿™äº›ä¿¡æ¯ä¸¢åˆ°å¼‚æ­¥queueä¸­å»ï¼Œåç»­æ“ä½œä¸­ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªidæ¥æŸ¥è¯¢æˆ‘ä»¬tomcatä¸­çš„ä¸‹å•é€»è¾‘æ˜¯å¦å®Œæˆäº†ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-232-1024x484.png" alt="img"></p>
<p>å‰ç«¯è¯·æ±‚æµç¨‹å˜æ›´ï¼š</p>
<ol>
<li>
<p>ç”¨æˆ·è¯·æ±‚å‘é€åˆ° Nginx</p>
</li>
<li>
<p>Nginx å°†è¯·æ±‚å‘ç»™ Redis è¿›è¡Œ</p>
<p>å¿«é€Ÿåˆ¤æ–­</p>
<p>ï¼š</p>
<ul>
<li>ç§’æ€åº“å­˜æ˜¯å¦è¶³å¤Ÿ</li>
<li>æ˜¯å¦ä¸€äººä¸€å•</li>
</ul>
</li>
</ol>
<blockquote>
<p>3.è¿™ä¸¤ä¸ªé€»è¾‘åœ¨ Redis ä¸­æ‰§è¡Œï¼Œå“åº”æå¿«ï¼Œé¿å… Tomcat é˜»å¡ã€‚</p>
</blockquote>
<p>4.åå° Tomcat æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ•°æ®ï¼Œæ‰§è¡ŒçœŸæ­£çš„ä¸‹å•æµç¨‹ï¼ˆæ…¢æ…¢å®Œæˆï¼‰</p>
<p>5.åˆ¤æ–­é€šè¿‡åï¼ŒRedis å°† <strong>userIdã€orderId ç­‰ä¿¡æ¯</strong> å­˜å…¥ <strong>æ¶ˆæ¯é˜Ÿåˆ—</strong></p>
<p>ä¼˜åŠ¿ï¼š</p>
<ul>
<li>é«˜å¹¶å‘ä¸‹ä¸ä¼šå‹å®æ•°æ®åº“</li>
<li>ç§’æ€æ“ä½œè¿‘ä¼¼â€œæ— é”â€ï¼Œååé«˜</li>
<li>ç”¨æˆ·ä½“éªŒå¥½ï¼ˆå¿«é€Ÿå“åº”ï¼‰</li>
<li>å¯æ‰©å±•æ€§å¼ºï¼ˆå¼‚æ­¥å¤„ç†æ˜“äºä¼¸ç¼©ï¼‰</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-233-1024x482.png" alt="img"></p>
<p>Redis Lua è„šæœ¬ä¿éšœ <strong>åº“å­˜åˆ¤æ–­ + ä¸€äººä¸€å•åˆ¤æ–­ + å†™å…¥çŠ¶æ€</strong> çš„<strong>åŸå­æ€§</strong>ï¼Œè¿™æ˜¯å…³é”®ï¼</p>
<p>Redis æ•°æ®ç»“æ„è®¾è®¡</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>stock:vid:7</code></td>
<td>ç§’æ€åº“å­˜ï¼ˆä¾‹å¦‚100ï¼‰</td>
</tr>
<tr>
<td><code>order:vid:7</code></td>
<td>ç”¨æˆ·IDåˆ—è¡¨ï¼ˆå¦‚Set/Streamï¼‰è®°å½•ä¸‹å•äºº</td>
</tr>
</tbody>
</table>
<p>Lua è„šæœ¬é€»è¾‘å›¾ï¼ˆå·¦ä¸‹ï¼‰ï¼š</p>
<ol>
<li>åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ï¼ˆ<code>if stock &lt;= 0</code>ï¼‰</li>
<li>åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ä¸‹å•ï¼ˆæ˜¯å¦åœ¨ set é›†åˆä¸­ï¼‰</li>
<li>è‹¥å‡é€šè¿‡ï¼š
<ul>
<li>æ‰£å‡åº“å­˜</li>
<li>å°†ç”¨æˆ·åŠ å…¥ set é›†åˆï¼ˆé˜²æ­¢é‡å¤ï¼‰</li>
<li>è¿”å›æˆåŠŸç  <code>0</code></li>
</ul>
</li>
</ol>
<p>åç»­å¤„ç†ï¼ˆå³ä¾§æµç¨‹ï¼‰ï¼š</p>
<ol>
<li>æ‰§è¡Œ Lua è„šæœ¬</li>
<li>å¦‚æœè¿”å›ç»“æœä¸º 0ï¼Œè¯´æ˜å¯ä»¥ä¸‹å•</li>
<li>å°† couponIdã€userIdã€orderId åŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—</li>
<li>åå°çº¿ç¨‹æ¶ˆè´¹æ¶ˆæ¯ï¼Œæ‰§è¡ŒçœŸæ­£çš„ï¼š
<ul>
<li>æ ¡éªŒåº“å­˜ï¼ˆå¯é€‰ï¼‰</li>
<li>åˆ›å»ºè®¢å•</li>
<li>æŒä¹…åŒ–å…¥æ•°æ®åº“</li>
</ul>
</li>
</ol>
<h3 id="6-2-ç§’æ€ä¼˜åŒ–-Rediså®Œæˆç§’æ€èµ„æ ¼åˆ¤æ–­">6.2 ç§’æ€ä¼˜åŒ–-Rediså®Œæˆç§’æ€èµ„æ ¼åˆ¤æ–­</h3>
<p>éœ€æ±‚ï¼š</p>
<ul>
<li>æ–°å¢ç§’æ€ä¼˜æƒ åˆ¸çš„åŒæ—¶ï¼Œå°†ä¼˜æƒ åˆ¸ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­</li>
<li>åŸºäºLuaè„šæœ¬ï¼Œåˆ¤æ–­ç§’æ€åº“å­˜ã€ä¸€äººä¸€å•ï¼Œå†³å®šç”¨æˆ·æ˜¯å¦æŠ¢è´­æˆåŠŸ</li>
<li>å¦‚æœæŠ¢è´­æˆåŠŸï¼Œå°†ä¼˜æƒ åˆ¸idå’Œç”¨æˆ·idå°è£…åå­˜å…¥é˜»å¡é˜Ÿåˆ—</li>
<li>å¼€å¯çº¿ç¨‹ä»»åŠ¡ï¼Œä¸æ–­ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä¿¡æ¯ï¼Œå®ç°å¼‚æ­¥ä¸‹å•åŠŸèƒ½</li>
</ul>
<p>è¿™ä¸ªé˜¶æ®µæˆ‘ä»¬è¦å®ç°çš„æ˜¯ï¼š</p>
<table>
<thead>
<tr>
<th>åŠŸèƒ½</th>
<th>æŠ€æœ¯æ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç§’æ€èµ„æ ¼åˆ¤æ–­ï¼ˆåº“å­˜ &amp; ä¸€äººä¸€å•ï¼‰</td>
<td>ä½¿ç”¨ Redis + Lua è„šæœ¬ï¼ŒåŸå­åˆ¤æ–­</td>
</tr>
<tr>
<td>å¼‚æ­¥ä¸‹å•å¤„ç†</td>
<td>Redis Stream é˜Ÿåˆ— + åå°çº¿ç¨‹æ¶ˆè´¹</td>
</tr>
<tr>
<td>å¿«é€Ÿå“åº”ç”¨æˆ·</td>
<td>Redis è„šæœ¬ç«‹å³è¿”å›ç»“æœï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰</td>
</tr>
<tr>
<td>å»¶è¿Ÿè½åº“</td>
<td>åå°çº¿ç¨‹æ ¹æ®æ¶ˆæ¯å†…å®¹æ‰§è¡ŒçœŸæ­£çš„ä¸‹å•æ“ä½œ</td>
</tr>
</tbody>
</table>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-234.png" alt="img"></p>
<p>åœ¨VoucherServiceImplçš„addSeckillVoucheræ–¹æ³•çš„æœ«å°¾æ·»åŠ ä¸‹é¢è¿™æ®µä»£ç æŠŠç§’æ€çš„åº“å­˜ä¿å­˜åˆ°Redisä¸­ï¼š</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¿å­˜ç§’æ€çš„åº“å­˜åˆ°Redis</span></span><br><span class="line">stringRedisTemplate<span class="selector-class">.opsForValue</span>()<span class="selector-class">.set</span>(RedisConstants.SECKILL_STOCK_KEY +voucher.getId(),voucher<span class="selector-class">.getStock</span>()<span class="selector-class">.toString</span>());</span><br></pre></td></tr></table></figure>
<p>è¯´æ˜ï¼š</p>
<ul>
<li><code>SECKILL_STOCK_KEY</code> å‰ç¼€å¸¸é‡ä¸º <code>&quot;seckill:stock:&quot;</code></li>
<li>Redis ä¸­ä¼šç”Ÿæˆä¸€ä¸ª Keyï¼Œä¾‹å¦‚ï¼š<code>seckill:stock:17</code>ï¼Œå€¼ä¸ºåº“å­˜æ•°é‡</li>
<li>ç›¸å½“äºç§’æ€åˆ¸ä¸€ä¸Šæ¶ï¼Œå°±æŠŠåº“å­˜åŒæ­¥åˆ°äº† Redis é‡Œï¼Œåç»­ä¸å†è®¿é—®æ•°æ®åº“åˆ¤æ–­åº“å­˜</li>
</ul>
<p>å‘é€è¯·æ±‚ï¼Œæ–°å¢ä¸€ä»½ä¼˜æƒ åˆ¸ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-236.png" alt="img"></p>
<p>å¯ä»¥çœ‹åˆ°åœ¨Redisä¸­è®°å½•äº†ä¼˜æƒ åˆ¸çš„è®°å½•ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-238.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-239.png" alt="img"></p>
<p>å®Œæ•´çš„VoucherServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSeckillVoucher</span><span class="params">(Voucher voucher)</span> &#123;</span><br><span class="line">    <span class="comment">// ä¿å­˜ä¼˜æƒ åˆ¸</span></span><br><span class="line">    save(voucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€ä¿¡æ¯</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillVoucher</span>();</span><br><span class="line">    seckillVoucher.setVoucherId(voucher.getId());</span><br><span class="line">    seckillVoucher.setStock(voucher.getStock());</span><br><span class="line">    seckillVoucher.setBeginTime(voucher.getBeginTime());</span><br><span class="line">    seckillVoucher.setEndTime(voucher.getEndTime());</span><br><span class="line">    seckillVoucherService.save(seckillVoucher);</span><br><span class="line">    <span class="comment">// ä¿å­˜ç§’æ€åº“å­˜åˆ°Redisä¸­</span></span><br><span class="line">    <span class="comment">//SECKILL_STOCK_KEY è¿™ä¸ªå˜é‡å®šä¹‰åœ¨RedisConstansä¸­</span></span><br><span class="line">    <span class="comment">//private static final String SECKILL_STOCK_KEY =&quot;seckill:stock:&quot;</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(SECKILL_STOCK_KEY + voucher.getId(), voucher.getStock().toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®Œæ•´luaè¡¨è¾¾å¼</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1.å‚æ•°åˆ—è¡¨</span></span><br><span class="line"><span class="comment">-- 1.1.ä¼˜æƒ åˆ¸id</span></span><br><span class="line"><span class="keyword">local</span> voucherId = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="comment">-- 1.2.ç”¨æˆ·id</span></span><br><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">2</span>]</span><br><span class="line"><span class="comment">-- 1.3.è®¢å•id</span></span><br><span class="line"><span class="keyword">local</span> orderId = ARGV[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2.æ•°æ®key</span></span><br><span class="line"><span class="comment">-- 2.1.åº“å­˜key</span></span><br><span class="line"><span class="keyword">local</span> stockKey = <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId</span><br><span class="line"><span class="comment">-- 2.2.è®¢å•key</span></span><br><span class="line"><span class="keyword">local</span> orderKey = <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3.è„šæœ¬ä¸šåŠ¡</span></span><br><span class="line"><span class="comment">-- 3.1.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ get stockKey</span></span><br><span class="line"><span class="keyword">if</span>(tonumber(redis.<span class="keyword">call</span>(<span class="string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 3.2.åº“å­˜ä¸è¶³ï¼Œè¿”å›1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 3.2.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å• SISMEMBER orderKey userId</span></span><br><span class="line"><span class="keyword">if</span>(redis.<span class="keyword">call</span>(<span class="string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 3.3.å­˜åœ¨ï¼Œè¯´æ˜æ˜¯é‡å¤ä¸‹å•ï¼Œè¿”å›2</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 3.4.æ‰£åº“å­˜ incrby stockKey -1</span></span><br><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;incrby&#x27;</span>, stockKey, <span class="number">-1</span>)</span><br><span class="line"><span class="comment">-- 3.5.ä¸‹å•ï¼ˆä¿å­˜ç”¨æˆ·ï¼‰sadd orderKey userId</span></span><br><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;sadd&#x27;</span>, orderKey, userId)</span><br><span class="line"><span class="comment">-- 3.6.å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ä¸­ï¼Œ XADD stream.orders * k1 v1 k2 v2 ...</span></span><br><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;xadd&#x27;</span>, <span class="string">&#x27;stream.orders&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;userId&#x27;</span>, userId, <span class="string">&#x27;voucherId&#x27;</span>, voucherId, <span class="string">&#x27;id&#x27;</span>, orderId)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h4 id="è§£æä¸€ä¸‹è¿™ä¸ªluaè„šæ­¥">è§£æä¸€ä¸‹è¿™ä¸ªluaè„šæ­¥</h4>
<p>ï¼ˆ1ï¼‰<strong>åˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿ</strong></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="number">0</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">1</span> <span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<ul>
<li>åº“å­˜ä¸è¶³è¿”å› 1ï¼Œç»“æŸé€»è¾‘</li>
</ul>
<p>ï¼ˆ2ï¼‰<strong>åˆ¤æ–­æ˜¯å¦é‡å¤ä¸‹å•</strong></p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> redis.<span class="keyword">call</span>(<span class="string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">2</span> <span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>orderKey</code> æ˜¯ <code>seckill:order:&lt;voucherId&gt;</code>ï¼Œç”¨ Set ä¿å­˜å·²ä¸‹å•ç”¨æˆ·</li>
</ul>
<p>ï¼ˆ3ï¼‰<strong>æ‰£åº“å­˜ã€è®°å½•ä¸‹å•ç”¨æˆ·</strong></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis.<span class="built_in">call</span>(<span class="string">&#x27;incrby&#x27;</span>, stockKey, <span class="number">-1</span>)</span><br><span class="line">redis.<span class="built_in">call</span>(<span class="string">&#x27;sadd&#x27;</span>, orderKey, userId)</span><br></pre></td></tr></table></figure>
<p>ï¼ˆ4ï¼‰<strong>å†™å…¥æ¶ˆæ¯é˜Ÿåˆ— Stream</strong></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.<span class="built_in">call</span>(<span class="string">&#x27;xadd&#x27;</span>, <span class="string">&#x27;stream.orders&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;userId&#x27;</span>, userId, <span class="string">&#x27;voucherId&#x27;</span>, voucherId, <span class="string">&#x27;id&#x27;</span>, orderId)</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ Redis Stream ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œåç»­åå°çº¿ç¨‹ä»è¿™é‡Œæ¶ˆè´¹æ•°æ®ï¼Œå®ç°å¼‚æ­¥ä¸‹å•ã€‚</p>
<p>å½“ä»¥ä¸Šluaè¡¨è¾¾å¼æ‰§è¡Œå®Œæ¯•åï¼Œå‰©ä¸‹çš„å°±æ˜¯æ ¹æ®æ­¥éª¤3,4æ¥æ‰§è¡Œæˆ‘ä»¬æ¥ä¸‹æ¥çš„ä»»åŠ¡äº†</p>
<p>VoucherOrderServiceImpl</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function">Result <span class="title">seckillVoucher</span><span class="params">(Long voucherId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//è·å–ç”¨æˆ·</span></span><br><span class="line">    Long userId = UserHolder.getUser().getId();</span><br><span class="line">    <span class="keyword">long</span> orderId = redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    <span class="comment">// 1.æ‰§è¡Œluaè„šæœ¬</span></span><br><span class="line">    Long result = stringRedisTemplate.execute(</span><br><span class="line">            SECKILL_SCRIPT,</span><br><span class="line">            Collections.emptyList(),</span><br><span class="line">            voucherId.toString(), userId.toString(), String.valueOf(orderId)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">int</span> r = result.intValue();</span><br><span class="line">    <span class="comment">// 2.åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0</span></span><br><span class="line">    <span class="keyword">if</span> (r != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 2.1.ä¸ä¸º0 ï¼Œä»£è¡¨æ²¡æœ‰è´­ä¹°èµ„æ ¼</span></span><br><span class="line">        <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(r == <span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//TODO ä¿å­˜é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="comment">// 3.è¿”å›è®¢å•id</span></span><br><span class="line">    <span class="function"><span class="keyword">return</span> Result.<span class="title">ok</span><span class="params">(orderId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è„šæœ¬æ‰§è¡Œåè¿”å›å€¼å«ä¹‰ï¼š</p>
<table>
<thead>
<tr>
<th>è¿”å›å€¼</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>1</code></td>
<td>åº“å­˜ä¸è¶³</td>
</tr>
<tr>
<td><code>2</code></td>
<td>é‡å¤ä¸‹å•</td>
</tr>
<tr>
<td><code>0</code></td>
<td>æœ‰ç§’æ€èµ„æ ¼ï¼ŒæˆåŠŸå…¥é˜Ÿï¼Œå¼‚æ­¥ä¸‹å•ä¸­</td>
</tr>
</tbody>
</table>
<p>æµ‹è¯•ï¼š</p>
<p>åœ¨Apifoxä¸­å‘é€æµ‹è¯•æ•°æ®ï¼Œç§’æ€ä¸‹å•ï¼ŒæˆåŠŸåè¿”å›è®¢å•idï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-240-1024x601.png" alt="img"></p>
<p>åœ¨Redisä¸­åº“å­˜æˆåŠŸæ‰£å‡1ï¼Œorderæœ‰ç¼“å­˜</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-241.png" alt="img"></p>
<p>å¦‚æœå†æ¬¡å‘é€ä¼šæç¤ºä¸èƒ½é‡å¤ä¸‹å•ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-242-1024x600.png" alt="img"></p>
<p>å‡†å¤‡åœ¨Jemeterä¸­æµ‹è¯•ï¼Œé¦–å…ˆæŠŠç¼“å­˜ä¸­çš„ä¼˜æƒ åˆ¸åº“å­˜æ”¹ä¸º200ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-243.png" alt="img"></p>
<p>æµ‹è¯•ååº“å­˜å‡ä¸º0ï¼Œæ–°å¢200æ¡è®¢å•è®°å½•ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-244.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-245.png" alt="img"></p>
<p>å¯ä»¥çœ‹åˆ°å¹³å‡å“åº”æ—¶é—´å‡å°‘10å€ï¼Œæœ€å¿«å“åº”æ—¶é—´å‡å°‘60å€ï¼Œæœ€å¤§å“åº”æ—¶é—´ç¼©çŸ­ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-246-1024x491.png" alt="img"></p>
<h3 id="6-3-ç§’æ€ä¼˜åŒ–-åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€ä¼˜åŒ–">6.3 ç§’æ€ä¼˜åŒ–-åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€ä¼˜åŒ–</h3>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-235.png" alt="img"></p>
<p>é˜»å¡é˜Ÿåˆ—ï¼šå°è¯•ä»é˜Ÿåˆ—è·å–å…ƒç´ ï¼Œå¦‚æœæ²¡æœ‰å…ƒç´ ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰å…ƒç´ æ‰ä¼šè¢«å”¤é†’ï¼Œè·å–å…ƒç´ ã€‚</p>
<p>åªè¦ç±»ä¸€å¯åŠ¨ï¼Œç”¨æˆ·éšæ—¶éƒ½æœ‰å¯èƒ½æ¥æŠ¢è´­ï¼Œå› æ­¤VoucherOrderHandlerè¿™ä¸ªç±»çš„åˆå§‹åŒ–å¿…é¡»åœ¨ç±»åˆå§‹åŒ–åæ‰§è¡Œã€‚</p>
<p>åœ¨VoucherOrderServiceImplç±»ä¸­ï¼Œé¦–å…ˆè¦æ–°å¢ä¸€ä¸ªorderTasksé˜»å¡é˜Ÿåˆ—ï¼Œç„¶åè®¾ç½®ä¸€ä¸ªçº¿ç¨‹æ± å’Œrunæ–¹æ³•ã€‚</p>
<p>åœ¨runæ–¹æ³•ä¸­è°ƒç”¨é˜»å¡é˜Ÿåˆ—çš„takeæ–¹æ³•ï¼ŒorderTasks.takeæ–¹æ³•æ˜¯ä¸€ä¸ªé˜»å¡æ–¹æ³•ï¼Œå¦‚æœé˜Ÿåˆ—ä¸­æœ‰å…ƒç´ ä¼šè·å–ï¼Œå¦‚æœé˜Ÿåˆ—ä¸­æ— å…ƒç´ åˆ™é˜»å¡ç­‰å¾…ã€‚</p>
<p>è¿™é‡Œç›¸å½“äºæ˜¯å¼€å¯äº†ä¸€ä¸ªå…¨æ–°çš„çº¿ç¨‹æ¥æ‰§è¡Œè·å–é˜Ÿåˆ—ä¸­è®¢å•ä¿¡æ¯å’Œå¼‚æ­¥åˆ›å»ºè®¢å•çš„ä»»åŠ¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> BlockingQueue&lt;VoucherOrder&gt; orderTasks = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">1024</span>*<span class="number">1024</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ExecutorService</span> <span class="variable">seckill_order_executor</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"><span class="comment">/**orderTasks æ˜¯ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ï¼Œç”¨æ¥å­˜å‚¨å¾…å¤„ç†çš„è®¢å•ã€‚seckill_order_executor æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„æ‰§è¡Œå™¨ï¼Œç”¨æ¥å¤„ç†é˜Ÿåˆ—ä¸­çš„è®¢å•ä»»åŠ¡ã€‚**/</span></span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">    seckill_order_executor.submit(<span class="keyword">new</span> <span class="title class_">VoucherOrderHandler</span>());</span><br><span class="line">&#125;<span class="comment">//åœ¨ @PostConstruct æ³¨è§£çš„æ–¹æ³•ä¸­ï¼Œå¯åŠ¨äº†ä¸€ä¸ªæ–°çº¿ç¨‹æ¥ä¸æ–­åœ°ä»é˜Ÿåˆ—ä¸­å–å‡ºè®¢å•ä¿¡æ¯å¹¶å¤„ç†ï¼š</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//1.è·å–é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯</span></span><br><span class="line">                <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> orderTasks.take();</span><br><span class="line">                <span class="comment">//2.åˆ›å»ºè®¢å•</span></span><br><span class="line">                handleVoucherOrder(voucherOrder);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;å¤„ç†è®¢å•å¼‚å¸¸&quot;</span>,e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//take() æ–¹æ³•æ˜¯é˜»å¡çš„ï¼Œåªæœ‰é˜Ÿåˆ—ä¸­æœ‰å…ƒç´ æ—¶æ‰ä¼šè¿”å›ï¼Œå¦‚æœæ²¡æœ‰å…ƒç´ ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰æ–°å…ƒç´ åŠ å…¥é˜Ÿåˆ—ã€‚</span></span><br></pre></td></tr></table></figure>
<p>ç„¶åæ–°å¢ä¸€ä¸ªhandleVoucherOrderæ–¹æ³•ï¼Œï¼Œé¦–å…ˆé€šè¿‡ <strong>Redisson åˆ†å¸ƒå¼é”</strong> æ¥ç¡®ä¿ <strong>ä¸€äººä¸€å•</strong> é€»è¾‘çš„åŸå­æ€§ï¼Œé˜²æ­¢åŒä¸€ä¸ªç”¨æˆ·å¤šæ¬¡ä¸‹å•ã€‚ï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> IVoucherOrderService proxy ;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleVoucherOrder</span>(<span class="params">VoucherOrder voucherOrder</span>)</span> &#123;</span><br><span class="line">    <span class="comment">//1.è·å–ç”¨æˆ·</span></span><br><span class="line">    Long userId = voucherOrder.getUserId();</span><br><span class="line">    <span class="comment">//2.åˆ›å»ºé”å¯¹è±¡</span></span><br><span class="line">    RLock <span class="keyword">lock</span> = redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span>+userId);</span><br><span class="line">    <span class="comment">//3.è·å–é”</span></span><br><span class="line">    boolean isLock = <span class="keyword">lock</span>.tryLock();</span><br><span class="line">    <span class="comment">//4.åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span>(!isLock) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line">        proxy.createVoucherOrder(voucherOrder);</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">lock</span>.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>è·å–é”åï¼Œè°ƒç”¨ <code>createVoucherOrder</code> æ–¹æ³•æ¥æ‰£å‡åº“å­˜å¹¶ä¿å­˜è®¢å•ã€‚</li>
<li>å¦‚æœé”è·å–å¤±è´¥ï¼Œè¯´æ˜è¯¥ç”¨æˆ·å·²ç»ä¸‹å•ï¼Œç›´æ¥è¿”å›ã€‚</li>
</ul>
<p>createVoucherOrderæ–¹æ³•ä¸»è¦æ˜¯ç”¨æ¥å¯¹æ•°æ®åº“æ“ä½œï¼Œæ¯”å¦‚æ‰£å‡åº“å­˜ï¼Œç„¶åä¿å­˜è®¢å•çš„ä¿¡æ¯åˆ°æ•°æ®åº“ï¼Œä¼šæœ‰é¢å¤–çš„å¯¹ä¸€äººä¸€å•å’Œåº“å­˜æ•°é‡çš„åˆ¤æ–­ï¼Œè™½ç„¶è¿™äº›åœ¨Redisä¸­å·²ç»åˆ¤æ–­è¿‡ï¼Œä½†è¿™é‡Œæ˜¯åŒé‡ä¿é™©ã€‚</p>
<p>å¼‚æ­¥å¤„ç†ä¸éœ€è¦å†è¿”å›ç»™å‰ç«¯ä»»ä½•ä¸œè¥¿ã€‚</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">@Transactional</span><br><span class="line">public void createVoucherOrder(VoucherOrder voucherOrder) &#123;</span><br><span class="line">    <span class="comment">//6.ä¸€äººä¸€å•</span></span><br><span class="line">    Long userId = voucherOrder.getUserId();</span><br><span class="line">    <span class="comment">//6.1æŸ¥è¯¢è®¢å•</span></span><br><span class="line">    int <span class="keyword">count</span> = <span class="keyword">query</span>().<span class="keyword">eq</span>(<span class="string">&quot;user_id&quot;</span>, userId).<span class="keyword">eq</span>(<span class="string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId()).<span class="keyword">count</span>();</span><br><span class="line">    <span class="comment">//6.2åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">count</span>&gt;0)&#123;</span><br><span class="line">        <span class="comment">//ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span></span><br><span class="line">        <span class="keyword">log</span>.<span class="keyword">error</span>(<span class="string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3.2åº“å­˜å……è¶³æ‰£å‡åº“å­˜</span></span><br><span class="line">    boolean success = seckillVoucherService.<span class="keyword">update</span>()</span><br><span class="line">            .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>) <span class="comment">//ç›¸å½“äºsetæ¡ä»¶ set stock = stock - 1</span></span><br><span class="line">            .<span class="keyword">eq</span>(<span class="string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId()) <span class="comment">//ç›¸å½“äºwhereæ¡ä»¶ where id = ? and stock = ?</span></span><br><span class="line">            .gt(<span class="string">&quot;stock&quot;</span>,0).<span class="keyword">update</span>();</span><br><span class="line">    <span class="keyword">if</span>(!success)&#123;</span><br><span class="line">        <span class="keyword">log</span>.<span class="keyword">error</span>(<span class="string">&quot;åº“å­˜ä¸è¶³!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    long orderId = redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);<span class="comment">//è®¢å•id</span></span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    voucherOrder.setUserId(userId);</span><br><span class="line">    voucherOrder.setVoucherId(voucherOrder.getVoucherId());<span class="comment">//ä»£é‡‘åˆ¸id</span></span><br><span class="line">    <span class="keyword">save</span>(voucherOrder);</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line">ä¸‹é¢æ˜¯å¯¹seckillVoucherçš„ç®€å•ä¿®æ”¹ï¼šseckillVoucher æ–¹æ³•åœ¨æ‰§è¡Œ Lua è„šæœ¬åï¼Œåˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰ç§’æ€èµ„æ ¼ã€‚å¦‚æœæœ‰ï¼Œåˆ™å°†è®¢å•ä¿¡æ¯å°è£…å¹¶æ·»åŠ åˆ°é˜»å¡é˜Ÿåˆ—ä¸­</span><br></pre></td></tr></table></figure>
<p>public Result seckillVoucher(Long voucherId) {</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">//1.æ‰§è¡ŒLuaè„šæœ¬</span></span><br><span class="line">Long result = stringRedisTemplate.execute(</span><br><span class="line">        SECKILL_SCRIPT,</span><br><span class="line">        Collections.emptyList(),</span><br><span class="line">        voucherId.toString(),</span><br><span class="line">        UserHolder.getUser().getId().toString()</span><br><span class="line">);</span><br><span class="line"><span class="keyword">int</span> r = result.intValue();</span><br><span class="line"><span class="keyword">if</span>(r != <span class="number">0</span>)&#123; <span class="comment">//2.åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0,ä¸ä¸º0,ä»£è¡¨æ²¡æœ‰è´­ä¹°èµ„æ ¼</span></span><br><span class="line">    <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(r==<span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>:<span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//2.2.ä¸º0,æœ‰è´­ä¹°èµ„æ ¼,æŠŠä¸‹å•ä¿¡æ¯ä¿å­˜åˆ°é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">long</span> orderId = redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line"><span class="comment">//å°è£…</span></span><br><span class="line">VoucherOrder voucherOrder = <span class="keyword">new</span> VoucherOrder();</span><br><span class="line">voucherOrder.setId(orderId);<span class="comment">//è®¢å•id</span></span><br><span class="line">voucherOrder.setUserId(UserHolder.getUser().getId());<span class="comment">//ç”¨æˆ·id</span></span><br><span class="line">voucherOrder.setVoucherId(voucherId);<span class="comment">//ä»£é‡‘åˆ¸id</span></span><br><span class="line"><span class="comment">//ä¿å­˜é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">orderTasks.add(voucherOrder);</span><br><span class="line"><span class="comment">//è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line">proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line"><span class="comment">//3.è¿”å›è®¢å•id</span></span><br><span class="line"><span class="function"><span class="keyword">return</span> Result.<span class="title">ok</span><span class="params">(orderId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµç¨‹æ€»ç»“</p>
<ul>
<li><strong>ç§’æ€èµ„æ ¼åˆ¤æ–­</strong>ï¼šé€šè¿‡ Lua è„šæœ¬åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ã€æ˜¯å¦é‡å¤ä¸‹å•ã€‚</li>
<li><strong>å°è£…è®¢å•ä¿¡æ¯</strong>ï¼šå¦‚æœæœ‰èµ„æ ¼ï¼Œå°è£…è®¢å•ä¿¡æ¯å¹¶ä¿å­˜åˆ°é˜»å¡é˜Ÿåˆ—ã€‚</li>
<li><strong>å¼‚æ­¥ä¸‹å•</strong>ï¼šé€šè¿‡æ–°çº¿ç¨‹å¼‚æ­¥å¤„ç†è®¢å•ï¼Œé˜²æ­¢é˜»å¡å‰ç«¯ã€‚</li>
<li><strong>åŒé‡ä¿é™©</strong>ï¼šRedis å’Œæ•°æ®åº“ä¸­éƒ½è¿›è¡Œåº“å­˜ä¸ä¸€äººä¸€å•çš„åˆ¤æ–­ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§</li>
</ul>
<p>æµ‹è¯•ï¼š</p>
<p>å…ˆæŠŠtb_voucher_orderå†…å®¹æ¸…ç©ºã€‚æŠŠtb_seckill_voucherçš„stockåº“å­˜æ”¹ä¸º200ã€‚</p>
<p>ç„¶åæŠŠRedisä¸­å¯¹åº”ä¼˜æƒ åˆ¸çš„åº“å­˜æ”¹ä¸º200ã€‚æ¸…ç©ºä¹‹å‰ç”Ÿæˆçš„è®¢å•ã€‚æ£€æŸ¥æ˜¯å¦æœ‰1000ä¸ªç”¨æˆ·çš„tokenã€‚</p>
<p>å…ˆç”¨Apifoxè¿›è¡Œæµ‹è¯•ï¼Œæµ‹è¯•ä¸€äººä¸€å•çš„æƒ…å†µï¼šç¬¬2æ¬¡ä¸‹å•æ˜¾ç¤ºä¸èƒ½é‡å¤ä¸‹å•ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-247.png" alt="img"></p>
<p>æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å¤š1æ¡è®¢å•è®°å½•ï¼Œåº“å­˜æ˜¯å¦å‡å°‘1ï¼Œç¼“å­˜ä¸­åº“å­˜æ˜¯å¦å‡å°‘1ã€‚</p>
<p>æ¥ä¸‹æ¥ç”¨Jemeterè¿›è¡Œæµ‹è¯•ï¼Œä¼šå‘ç°åº“å­˜æ‰£å‡ä¸º0ï¼Œæ•°æ®åº“ä¸­å¤š200æ¡æ•°æ®ï¼Œç¼“å­˜ä¸­çš„åº“å­˜ä¹Ÿæ‰£å‡åˆ°0ã€‚</p>
<p>çœ‹èšåˆæŠ¥å‘Šçš„ç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-248-1024x240.png" alt="img"></p>
<p>å› ä¸ºåšäº†å¼‚æ­¥ä¸‹å•ï¼Œä¼šå ç”¨ä¸€å®šçš„CPUï¼Œæ‰€ä»¥å¹³å‡å€¼è¦æ¯”ç¬¬2æ¬¡æ›´é•¿ã€‚</p>
<p>å’Œä¸‹é¢å‰2æ¬¡çš„ç»“æœè¿›è¡Œå¯¹æ¯”å¯ä»¥å‘ç°ï¼Œå“åº”çš„å¹³å‡å€¼æ¯”æœ€åˆæé«˜10å€ï¼Œæœ€å¿«å“åº”æ—¶é—´æé«˜äº†80å€ï¼Œæœ€æ…¢å“åº”æ—¶é—´æé«˜äº†6å€ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-249-1024x475.png" alt="img"></p>
<p>ç§’æ€ä¸šåŠ¡çš„ä¼˜åŒ–æ€è·¯ï¼š</p>
<p>1.å…ˆåˆ©ç”¨Rediså®Œæˆåº“å­˜é‡ã€ä¸€äººä¸€å•çš„åˆ¤æ–­ï¼Œå®ŒæˆæŠ¢å•ä¸šåŠ¡ã€‚</p>
<p>2.å°†ä¸‹å•ä¸šåŠ¡æ”¾å…¥é˜»å¡é˜Ÿåˆ—ï¼Œåˆ©ç”¨ç‹¬ç«‹çº¿ç¨‹å¼‚æ­¥ä¸‹å•ã€‚</p>
<p>åŸºäºé˜»å¡é˜Ÿåˆ—çš„å¼‚æ­¥ç§’æ€å­˜åœ¨å“ªäº›é—®é¢˜ï¼š</p>
<p>1.å†…å­˜é™åˆ¶é—®é¢˜ã€‚ä½¿ç”¨çš„æ˜¯jdkæä¾›çš„é˜»å¡é˜Ÿåˆ—ï¼Œä½¿ç”¨çš„æ˜¯JVMçš„å†…å­˜ï¼Œåœ¨ä¸€å¼€å§‹å†™æ­»äº†é˜Ÿåˆ—ç©ºé—´çš„å¤§å°ï¼Œå¦‚æœåœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œé˜Ÿåˆ—å¾ˆå¿«ä¼šè¢«å æ»¡ï¼Œå¦‚æœä¸å¯¹é˜Ÿåˆ—çš„ç©ºé—´åŠ ä»¥é™åˆ¶ï¼Œå¾ˆå®¹æ˜“é€ æˆå†…å­˜çš„æº¢å‡ºã€‚</p>
<p>2.æ•°æ®å®‰å…¨é—®é¢˜ã€‚ç¼ºä¹æŒä¹…åŒ–æœºåˆ¶ï¼Œæ˜¯åŸºäºå†…å­˜æ¥ä¿å­˜ä¿¡æ¯ï¼Œå¦‚æœæœåŠ¡çªç„¶å®•æœºï¼Œå†…å­˜ä¸­ä¿å­˜çš„ä¿¡æ¯éƒ½ä¼šä¸¢å¤±ã€‚å¦‚æœä»»åŠ¡è¢«å–å‡ºï¼Œä½†ç”±äºçªç„¶å‘ç”Ÿäº‹æ•…å¼‚å¸¸ï¼Œå¯¼è‡´ä»»åŠ¡æ²¡æœ‰è¢«æ¶ˆè´¹ï¼Œä»»åŠ¡ä¸¢å¤±ï¼Œä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚</p>
<h2 id="7ã€Redisæ¶ˆæ¯é˜Ÿåˆ—">7ã€Redisæ¶ˆæ¯é˜Ÿåˆ—</h2>
<h3 id="7-1-Redisæ¶ˆæ¯é˜Ÿåˆ—-è®¤è¯†æ¶ˆæ¯é˜Ÿåˆ—">7.1 Redisæ¶ˆæ¯é˜Ÿåˆ—-è®¤è¯†æ¶ˆæ¯é˜Ÿåˆ—</h3>
<p>ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼š</p>
<p><strong>æ¶ˆæ¯é˜Ÿåˆ—</strong> æ˜¯ä¸€ç§ä»¥å¼‚æ­¥é€šä¿¡ä¸ºåŸºç¡€çš„æœºåˆ¶ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­åº”ç”¨å¹¿æ³›ã€‚å®ƒçš„ä½œç”¨å°±æ˜¯ <strong>å­˜å‚¨å’Œç®¡ç†æ¶ˆæ¯</strong>ï¼Œå¹¶é€šè¿‡ <strong>æ¶ˆæ¯ä¸­é—´ä»¶ï¼ˆMessage Brokerï¼‰</strong> æ¥å®ç°æ¶ˆæ¯çš„ä¼ é€’ã€‚æœ€åŸºæœ¬çš„æ¶ˆæ¯é˜Ÿåˆ—åŒ…å«äº†ä¸‰ä¸ªä¸»è¦è§’è‰²ï¼š</p>
<ol>
<li><strong>ç”Ÿäº§è€…ï¼ˆProducerï¼‰</strong>ï¼šå‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ã€‚</li>
<li><strong>æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰</strong>ï¼šå­˜å‚¨å’Œç®¡ç†æ¶ˆæ¯ã€‚</li>
<li><strong>æ¶ˆè´¹è€…ï¼ˆConsumerï¼‰</strong>ï¼šä»é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯å¹¶è¿›è¡Œå¤„ç†ã€‚</li>
</ol>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-250.png" alt="img"></p>
<p><strong>ç¤ºä¾‹è¯´æ˜ï¼š</strong></p>
<p>é€šè¿‡ç”Ÿæ´»ä¸­çš„ä¾‹å­æ¥å¸®åŠ©ç†è§£æ¶ˆæ¯é˜Ÿåˆ—çš„ä½œç”¨ï¼š</p>
<ul>
<li><strong>ç”Ÿäº§è€…</strong>ï¼šå°±åƒä¸€ä¸ª <strong>å¿«é€’å‘˜</strong>ï¼Œä»–è´Ÿè´£å°†å¿«é€’ä»å•†å®¶æ‹¿åˆ°å¿«é€’ç«™ç‚¹ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰ï¼Œç­‰å¾…é€è´§ã€‚</li>
<li><strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼šå¿«é€’ç«™ç‚¹ï¼Œåœ¨è¿™é‡Œæ‰€æœ‰çš„å¿«é€’éƒ½æš‚æ—¶å­˜æ”¾ï¼Œç­‰å¾…è¢«æ´¾é€åˆ°æ¶ˆè´¹è€…ã€‚</li>
<li><strong>æ¶ˆè´¹è€…</strong>ï¼šç±»ä¼¼ <strong>æ”¶ä»¶äºº</strong>ï¼Œä»–ä»¬æ¥æ”¶åˆ°å¿«é€’ï¼Œå¤„ç†è‡ªå·±çš„éœ€æ±‚ã€‚</li>
</ul>
<p>ä¸ºä»€ä¹ˆä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ</p>
<p><strong>æé«˜æ•ˆç‡</strong>ï¼šæ¶ˆæ¯é˜Ÿåˆ—å¸®åŠ©ç³»ç»Ÿå¤„ç†å¹¶å‘ï¼Œç”Ÿäº§è€…å¯ä»¥å¿«é€Ÿå‘é€æ¶ˆæ¯ï¼Œè€Œæ¶ˆè´¹è€…ä¼šå¼‚æ­¥å¤„ç†ã€‚</p>
<p><strong>è§£è€¦</strong>ï¼šç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å·¥ä½œå¯ä»¥è§£è€¦å¼€ï¼Œç”Ÿäº§è€…æ— éœ€å…³å¿ƒæ¶ˆè´¹è€…çš„å¤„ç†é€Ÿåº¦ï¼Œåä¹‹äº¦ç„¶ã€‚</p>
<p>è¿™ç§åœºæ™¯åœ¨æˆ‘ä»¬ç§’æ€ä¸­å°±å˜æˆäº†ï¼š</p>
<ol>
<li><strong>ç”¨æˆ·å‘èµ·ç§’æ€è¯·æ±‚</strong>ï¼šç”¨æˆ·ç‚¹å‡»ç§’æ€æŒ‰é’®ï¼Œç³»ç»Ÿä½œä¸º <strong>ç”Ÿäº§è€…</strong> å°†ç§’æ€è¯·æ±‚ï¼ˆæ¶ˆæ¯ï¼‰å‘é€åˆ° Redis æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
<li><strong>ç³»ç»Ÿåˆ¤æ–­åº“å­˜</strong>ï¼šé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯è¿›å…¥å¤„ç†æµç¨‹ï¼Œç”± <strong>æ¶ˆè´¹è€…</strong> è´Ÿè´£ä» Redis æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºæ¶ˆæ¯å¹¶æ‰§è¡Œç›¸åº”çš„å¤„ç†ï¼Œå¦‚åˆ¤æ–­åº“å­˜ã€ç”Ÿæˆè®¢å•ç­‰ã€‚</li>
<li><strong>å¼‚æ­¥å¤„ç†</strong>ï¼šæ¶ˆè´¹è€…å¤„ç†å®Œæ¶ˆæ¯åï¼Œæœ€ç»ˆç»“æœä¼šå¼‚æ­¥è¿”å›åˆ°</li>
</ol>
<p>Redisæä¾›äº†3ç§ä¸åŒçš„æ–¹å¼æ¥å®ç°æ¶ˆæ¯é˜Ÿåˆ—ï¼š</p>
<ul>
<li>1.listç»“æ„ï¼šåŸºäºListç»“æ„æ¨¡æ‹Ÿæ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
<li>2.PubSubï¼ˆå‘å¸ƒè®¢é˜…ï¼‰ï¼šåŸºæœ¬çš„ç‚¹å¯¹ç‚¹æ¶ˆæ¯æ¨¡å‹ã€‚</li>
<li>3.Streamï¼šæ¯”è¾ƒå®Œå–„çš„åŠŸèƒ½å¼ºå¤§çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹ã€‚</li>
</ul>
<h3 id="7-2-Redisæ¶ˆæ¯é˜Ÿåˆ—-åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—">7.2 Redisæ¶ˆæ¯é˜Ÿåˆ—-åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—</h3>
<p><strong>åŸºäºListç»“æ„æ¨¡æ‹Ÿæ¶ˆæ¯é˜Ÿåˆ—</strong></p>
<p>æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰ï¼Œå­—é¢æ„æ€å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ã€‚è€ŒRedisçš„listæ•°æ®ç»“æ„æ˜¯ä¸€ä¸ª<strong>åŒå‘é“¾è¡¨</strong>ï¼Œå› æ­¤æ”¯æŒä»ä¸¤ç«¯è¿›è¡Œæ“ä½œï¼Œèƒ½å¤Ÿå®ç°é˜Ÿåˆ—çš„ <strong>å…ˆè¿›å…ˆå‡º</strong>ï¼ˆFIFOï¼‰æ¨¡å¼ã€‚</p>
<p>å…³é”®å‘½ä»¤ï¼š</p>
<ul>
<li><strong>LPUSH</strong>ï¼šå°†ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ æ’å…¥åˆ°åˆ—è¡¨çš„ <strong>å¤´éƒ¨</strong>ã€‚ç”¨äºç”Ÿäº§è€…å°†æ¶ˆæ¯å‘é€åˆ°é˜Ÿåˆ—ã€‚</li>
<li><strong>RPOP</strong>ï¼šç§»é™¤å¹¶è¿”å›åˆ—è¡¨çš„ <strong>å°¾éƒ¨</strong> å…ƒç´ ã€‚ç”¨äºæ¶ˆè´¹è€…ä»é˜Ÿåˆ—è·å–æ¶ˆæ¯ã€‚</li>
<li><strong>BRPOP</strong>ï¼šå½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œé˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æœ‰æ¶ˆæ¯åŠ å…¥é˜Ÿåˆ—ä¸­</li>
</ul>
<h4 id="å…³é”®ç‚¹ï¼š">å…³é”®ç‚¹ï¼š</h4>
<ul>
<li><code>BRPOP</code> å’Œ <code>RPOP</code> å‘½ä»¤åœ¨é˜Ÿåˆ—ä¸ºç©ºæ—¶ä¼šè¿”å› <code>null</code>ï¼Œè¿™ä¸ <strong>JVM é˜»å¡é˜Ÿåˆ—</strong> ä¸åŒï¼ŒJVM é˜»å¡é˜Ÿåˆ—ä¼šç›´æ¥é˜»å¡çº¿ç¨‹ï¼Œç›´åˆ°é˜Ÿåˆ—æœ‰å¯ç”¨å…ƒç´ ã€‚</li>
<li>Redis ä¸­ä½¿ç”¨ <code>BRPOP</code> æ¥å®ç° <strong>é˜»å¡å¼é˜Ÿåˆ—</strong>ï¼Œä½¿å¾—æ¶ˆè´¹è€…å¯ä»¥åœ¨é˜Ÿåˆ—ä¸ºç©ºæ—¶é˜»å¡ç­‰å¾…ã€‚</li>
</ul>
<p>é˜Ÿåˆ—æ˜¯å…¥å£å’Œå‡ºå£ä¸åœ¨ä¸€è¾¹ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ï¼šLPUSH ç»“åˆ RPOPã€æˆ–è€… RPUSH ç»“åˆ LPOPæ¥å®ç°ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-252.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-253.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-251.png" alt="img"></p>
<p>åŸºäºListçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ ä¼˜ç‚¹ï¼š</p>
<ul>
<li><strong>åˆ©ç”¨ Redis å­˜å‚¨</strong>ï¼Œä¸ä¾èµ–äº JVM å†…å­˜ä¸­çš„é˜Ÿåˆ—ï¼Œä¿è¯äº†æ¶ˆæ¯é˜Ÿåˆ—çš„ <strong>æŒä¹…æ€§</strong> å’Œ <strong>é«˜å¯ç”¨æ€§</strong>ã€‚</li>
<li><strong>è·¨è¿›ç¨‹ã€è·¨å¹³å°</strong>ï¼šRedis å¯ä»¥ç”¨äºå¤šå°æœºå™¨é—´çš„æ¶ˆæ¯ä¼ é€’ï¼Œé€‚ç”¨äºåˆ†å¸ƒå¼ç³»ç»Ÿã€‚</li>
<li><strong>å®‰å…¨æ€§</strong>ï¼šæ•°æ®å­˜å‚¨åœ¨ Redis ä¸­ï¼Œç¡®ä¿äº†æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼Œç‰¹åˆ«æ˜¯åœ¨ <strong>Redis æŒä¹…åŒ–</strong>ï¼ˆAOF æˆ– RDBï¼‰å¼€å¯çš„æƒ…å†µä¸‹ã€‚</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li><strong>æ— æ³•å¼ºåˆ¶æ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯çš„é¡ºåº</strong>ï¼šå› ä¸º Redis æ˜¯åŸºäº List å®ç°çš„ï¼Œæ‰€ä»¥ <strong>å¤šä¸ªæ¶ˆè´¹è€…</strong> å¯èƒ½ä¼šé”™è¿‡æŸäº›æ¶ˆæ¯ï¼Œæˆ–æ¶ˆè´¹é¡ºåºä¸ä¿è¯ã€‚</li>
<li><strong>æ²¡æœ‰å†…å»ºçš„æ¶ˆæ¯ç¡®è®¤æœºåˆ¶</strong>ï¼šæ¶ˆè´¹è€…å¯èƒ½ä¼šæ¶ˆè´¹åŒä¸€ä¸ªæ¶ˆæ¯ï¼Œè‹¥å¤„ç†å¤±è´¥æ—¶ç¼ºä¹è¡¥å¿æœºåˆ¶ã€‚</li>
</ul>
<h3 id="7-3-Redisæ¶ˆæ¯é˜Ÿåˆ—-åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—">7.3 Redisæ¶ˆæ¯é˜Ÿåˆ—-åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—</h3>
<p>PubSubï¼ˆå‘å¸ƒè®¢é˜…ï¼‰æ˜¯Redis2.0ç‰ˆæœ¬å¼•å…¥çš„æ¶ˆæ¯ä¼ é€’æ¨¡å‹ã€‚é¡¾åæ€ä¹‰ï¼Œæ¶ˆè´¹è€…å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªchannelï¼Œç”Ÿäº§è€…å‘å¯¹åº”channelå‘é€æ¶ˆæ¯åï¼Œæ‰€æœ‰è®¢é˜…è€…éƒ½èƒ½æ”¶åˆ°ç›¸å…³æ¶ˆæ¯ã€‚</p>
<p>SUBSCRIBE channel [channel] ï¼šè®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“ PUBLISH channel msg ï¼šå‘ä¸€ä¸ªé¢‘é“å‘é€æ¶ˆæ¯ PSUBSCRIBE pattern[pattern] ï¼šè®¢é˜…ä¸patternæ ¼å¼åŒ¹é…çš„æ‰€æœ‰é¢‘é“</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-254.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-255.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-257.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-256.png" alt="img"></p>
<p>åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ ä¼˜ç‚¹ï¼š</p>
<ul>
<li><strong>æ”¯æŒå¤šç”Ÿäº§è€…ã€å¤šæ¶ˆè´¹è€…</strong>ï¼šä¸€ä¸ªé¢‘é“å¯ä»¥æœ‰å¤šä¸ªç”Ÿäº§è€…å‘å¸ƒæ¶ˆæ¯ï¼Œå¤šä¸ªæ¶ˆè´¹è€…è®¢é˜…å¹¶å¤„ç†è¿™äº›æ¶ˆæ¯ã€‚</li>
<li><strong>çµæ´»çš„è®¢é˜…æ–¹å¼</strong>ï¼šå¯ä»¥ç²¾ç¡®è®¢é˜…æŸä¸ªé¢‘é“ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ¨¡å¼åŒ¹é…ï¼ˆPSUBSCRIBEï¼‰è®¢é˜…å¤šä¸ªé¢‘é“ã€‚</li>
<li><strong>å®æ—¶æ€§é«˜</strong>ï¼šä¸€æ—¦æ¶ˆæ¯å‘å¸ƒï¼Œæ‰€æœ‰è®¢é˜…è€…å¯ä»¥å³æ—¶æ”¶åˆ°ï¼Œé€‚ç”¨äºå¯¹å®æ—¶æ€§è¦æ±‚é«˜çš„åœºæ™¯ã€‚</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li><strong>ä¸æ”¯æŒæ•°æ®æŒä¹…åŒ–</strong>ï¼šRedis Pub/Sub ä¸ä¼šå°†æ¶ˆæ¯æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œæ•°æ®ä¸¢å¤±é£é™©è¾ƒå¤§ã€‚</li>
<li><strong>æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±</strong>ï¼šå¦‚æœæ¶ˆè´¹è€…åœ¨è®¢é˜…æ—¶æ²¡æœ‰å‡†å¤‡å¥½ï¼Œæˆ– Redis æœåŠ¡é‡å¯ç­‰åŸå› ï¼Œä¼šä¸¢å¤±æ¶ˆæ¯ã€‚</li>
<li><strong>æ¶ˆæ¯å †ç§¯æœ‰é™åˆ¶</strong>ï¼šå¦‚æœæ¶ˆæ¯é˜Ÿåˆ—å †ç§¯è¿‡å¤šï¼Œè¶…å‡ºäº† Redis çš„å†…å­˜é™åˆ¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ã€‚</li>
</ul>
<h3 id="7-4-Redisæ¶ˆæ¯é˜Ÿåˆ—-åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—">7.4 Redisæ¶ˆæ¯é˜Ÿåˆ—-åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—</h3>
<p>Stream æ˜¯ Redis 5.0 å¼•å…¥çš„ä¸€ç§æ–°æ•°æ®ç±»å‹ï¼Œå¯ä»¥å®ç°ä¸€ä¸ªåŠŸèƒ½éå¸¸å®Œå–„çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p>
<p>å‘é€æ¶ˆæ¯çš„å‘½ä»¤ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-258-1024x150.png" alt="img"></p>
<ul>
<li><strong>key</strong>ï¼šæŒ‡å®š Stream çš„åç§°ã€‚</li>
<li><strong>field</strong> å’Œ <strong>value</strong>ï¼šæ¶ˆæ¯çš„å­—æ®µå’Œå€¼ï¼Œæ¯æ¡æ¶ˆæ¯ä¼šæœ‰å¤šä¸ªå­—æ®µå’Œå€¼ã€‚</li>
</ul>
<p>ä¾‹å¦‚ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-259.png" alt="img"></p>
<p>è¿™æ¡å‘½ä»¤ä¼šå°† <code>&quot;name&quot;</code> å’Œ <code>&quot;age&quot;</code> è¿™ä¸¤ä¸ªå­—æ®µåŠå…¶å¯¹åº”çš„å€¼ <code>&quot;jack&quot;</code> å’Œ <code>&quot;21&quot;</code> æ·»åŠ åˆ°åä¸º <code>users</code> çš„ Stream ä¸­ï¼ŒåŒæ—¶ Redis ä¼šè‡ªåŠ¨ä¸ºè¯¥æ¶ˆæ¯ç”Ÿæˆä¸€ä¸ª <strong>å”¯ä¸€çš„ ID</strong>ï¼ˆå¦‚ <code>1644085070523-0</code>ï¼‰ã€‚</p>
<p>è¯»å–æ¶ˆæ¯çš„æ–¹å¼ä¹‹ä¸€ï¼šXREADï¼Œéœ€è¦æ³¨æ„çš„æ˜¯keyå’Œ*|IDä¸­é—´é‚£ä¿©å‚æ•°æ˜¯<strong>å¯é€‰å‚æ•°</strong>ï¼Œä¸€ä¸ªæ˜¯ç”¨æ¥åˆ¤æ–­æ˜¯å¦è‡ªåŠ¨åˆ›å»ºé˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯ç”¨æ¥è®¾ç½®é˜Ÿåˆ—æœ€å¤§æ¶ˆæ¯æ•°é‡ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-260.png" alt="img"></p>
<p>ä¾‹å¦‚ï¼Œä½¿ç”¨XREADè¯»å–ç¬¬ä¸€ä¸ªæ¶ˆæ¯ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-261.png" alt="img"></p>
<p>è¿™æ¡å‘½ä»¤ä¼šä»åä¸º <code>users</code> çš„ Stream ä¸­è¯»å–æ¶ˆæ¯ï¼Œä» ID ä¸º <code>0</code> çš„ä½ç½®å¼€å§‹ï¼Œæœ€å¤šè¯»å– 1 æ¡æ¶ˆæ¯ã€‚</p>
<p>XREADé˜»å¡æ–¹å¼ï¼Œè¯»å–æœ€æ–°çš„æ¶ˆæ¯ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-262.png" alt="img"></p>
<ul>
<li><strong>BLOCK 1000</strong> è¡¨ç¤ºé˜»å¡ç­‰å¾…æœ€å¤š 1000 æ¯«ç§’ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰æ–°çš„æ¶ˆæ¯ï¼Œæˆ–è¶…æ—¶ã€‚</li>
<li><strong>$</strong> ä»£è¡¨è¯»å–æœ€æ–°çš„æ¶ˆæ¯ã€‚</li>
</ul>
<p>åœ¨ä¸šåŠ¡å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾ªç¯çš„è°ƒç”¨XREADé˜»å¡æ–¹å¼æ¥æŸ¥è¯¢æœ€æ–°æ¶ˆæ¯ï¼Œä»è€Œå®ç°æŒç»­ç›‘å¬é˜Ÿåˆ—çš„æ•ˆæœï¼Œä¼ªä»£ç å¦‚ä¸‹</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-263.png" alt="img"></p>
<ul>
<li>è¯¥å¾ªç¯ä¼šä¸æ–­æ‰§è¡Œ <code>XREAD</code> å‘½ä»¤ï¼Œç›´åˆ°æœ‰æ–°æ¶ˆæ¯è¿›å…¥é˜Ÿåˆ—ã€‚</li>
<li>æ¯æ¬¡ä» Stream ä¸­è¯»å–æ¶ˆæ¯å¹¶æ‰§è¡Œ <code>handleMessage()</code> å¤„ç†æ¶ˆæ¯ã€‚</li>
</ul>
<p>æ³¨æ„ï¼šå½“æˆ‘ä»¬æŒ‡å®šèµ·å§‹IDä¸º$æ—¶ï¼Œä»£è¡¨è¯»å–æœ€æ–°çš„æ¶ˆæ¯ï¼Œå¦‚æœæˆ‘ä»¬å¤„ç†ä¸€æ¡æ¶ˆæ¯çš„è¿‡ç¨‹ä¸­ï¼Œåˆæœ‰è¶…è¿‡1æ¡ä»¥ä¸Šçš„æ¶ˆæ¯åˆ°è¾¾é˜Ÿåˆ—ï¼Œåˆ™ä¸‹æ¬¡è·å–æ—¶ä¹Ÿåªèƒ½è·å–åˆ°æœ€æ–°çš„ä¸€æ¡ï¼Œä¼šå‡ºç°æ¼è¯»æ¶ˆæ¯çš„é—®é¢˜</p>
<p>STREAMç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADå‘½ä»¤ç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ¶ˆæ¯å¯å›æº¯</li>
<li>ä¸€ä¸ªæ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…è¯»å–</li>
<li>å¯ä»¥é˜»å¡è¯»å–</li>
<li>æœ‰æ¶ˆæ¯æ¼è¯»çš„é£é™©</li>
</ul>
<h3 id="7-5-Redisæ¶ˆæ¯é˜Ÿåˆ—-åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„">7.5 Redisæ¶ˆæ¯é˜Ÿåˆ—-åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„</h3>
<p>æ¶ˆè´¹è€…ç»„ï¼ˆConsumer Groupï¼‰ï¼šå°†å¤šä¸ªæ¶ˆè´¹è€…åˆ’åˆ†åˆ°ä¸€ä¸ªç»„ä¸­ï¼Œç›‘å¬åŒä¸€ä¸ªé˜Ÿåˆ—ã€‚æ¶ˆè´¹è€…ä¹‹é—´æ˜¯ç«äº‰å…³ç³»ã€‚</p>
<p>å…·å¤‡ä¸‹åˆ—ç‰¹ç‚¹ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-264.png" alt="img"></p>
<p>åˆ›å»ºæ¶ˆè´¹è€…ç»„ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-265.png" alt="img"></p>
<ul>
<li>keyï¼šé˜Ÿåˆ—åç§°</li>
<li>groupNameï¼šæ¶ˆè´¹è€…ç»„åç§°</li>
<li>IDï¼šèµ·å§‹IDæ ‡ç¤ºï¼Œ$ä»£è¡¨é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªæ¶ˆæ¯ï¼Œ0åˆ™ä»£è¡¨é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªæ¶ˆæ¯</li>
<li>MKSTREAMï¼šé˜Ÿåˆ—ä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»ºé˜Ÿåˆ—</li>
</ul>
<p>å…¶å®ƒå¸¸è§å‘½ä»¤ï¼š</p>
<p><strong>åˆ é™¤æŒ‡å®šçš„æ¶ˆè´¹è€…ç»„</strong></p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">XGROUP DESTORY key groupName</span></span><br></pre></td></tr></table></figure>
<p><strong>ç»™æŒ‡å®šçš„æ¶ˆè´¹è€…ç»„æ·»åŠ æ¶ˆè´¹</strong></p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">XGROUP CREATECONSUMER key groupname consumername</span></span><br></pre></td></tr></table></figure>
<p><strong>åˆ é™¤æ¶ˆè´¹è€…ç»„ä¸­çš„æŒ‡å®šæ¶ˆè´¹è€…</strong></p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">XGROUP DELCONSUMER key groupname consumername</span></span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºæ¶ˆè´¹è€…ç»„ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-269.png" alt="img"></p>
<p><strong>ä»æ¶ˆè´¹è€…ç»„è¯»å–æ¶ˆæ¯ï¼š</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XREADGROUP GROUP group consumer <span class="selector-attr">[COUNT count]</span> <span class="selector-attr">[BLOCK milliseconds]</span> <span class="selector-attr">[NOACK]</span> STREAMS key <span class="selector-attr">[key ...]</span> ID <span class="selector-attr">[ID ...]</span></span><br></pre></td></tr></table></figure>
<ul>
<li>groupï¼šæ¶ˆè´¹ç»„åç§°</li>
<li>consumerï¼šæ¶ˆè´¹è€…åç§°ï¼Œå¦‚æœæ¶ˆè´¹è€…ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€…</li>
<li>countï¼šæœ¬æ¬¡æŸ¥è¯¢çš„æœ€å¤§æ•°é‡</li>
<li>BLOCK millisecondsï¼šå½“æ²¡æœ‰æ¶ˆæ¯æ—¶æœ€é•¿ç­‰å¾…æ—¶é—´</li>
<li>NOACKï¼šæ— éœ€æ‰‹åŠ¨ACKï¼Œè·å–åˆ°æ¶ˆæ¯åè‡ªåŠ¨ç¡®è®¤</li>
<li>STREAMS keyï¼šæŒ‡å®šé˜Ÿåˆ—åç§°</li>
<li>IDï¼šè·å–æ¶ˆæ¯çš„èµ·å§‹IDï¼š</li>
</ul>
<p>å¯ä»¥å‘ç°åœ¨åŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„é‡Œçš„æ¶ˆè´¹è€…å¯¹æ¶ˆæ¯ä¸ä¼šé‡å¤è¯»å–ï¼Œè€Œæ˜¯ä¾æ¬¡è¯»å–ï¼Œå·²è¢«è¯»å–çš„æ¶ˆæ¯ä¸ä¼šå†æ¬¡è¢«è¯»å–ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-270.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-271.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-272.png" alt="img"></p>
<p><strong>æ¶ˆè´¹è€…ç¡®è®¤æ¶ˆæ¯ï¼š</strong></p>
<p>XACK key group ID</p>
<ul>
<li>keyï¼šæ˜¯é˜Ÿåˆ—åç§°ã€‚</li>
<li>groupï¼šæ˜¯æ¶ˆè´¹è€…ç»„åç§°ã€‚</li>
<li>IDï¼šæ˜¯æ¥æ”¶åˆ°çš„æ¶ˆæ¯çš„IDã€‚</li>
</ul>
<p><strong>æŸ¥çœ‹Pending-listé˜Ÿåˆ—çš„ä¿¡æ¯ï¼š</strong></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-273.png" alt="img"></p>
<ul>
<li>keyï¼šæ˜¯é˜Ÿåˆ—åç§°ã€‚</li>
<li>groupï¼šæ˜¯ç»„åç§°ã€‚</li>
</ul>
<p>ä¸‹é¢æ˜¯æ¶ˆæ¯ç¡®è®¤ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-274.png" alt="img"></p>
<p>å¯¹æ¶ˆæ¯è¿›è¡Œç¡®è®¤ï¼Œç¡®è®¤å®Œæ¶ˆæ¯ä¼šè¢«ç§»é™¤ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-275.png" alt="img"></p>
<p>Pending-listé˜Ÿåˆ—é‡Œé¢å­˜å‚¨çš„æ˜¯å·²ç»è¯»å–ï¼Œä½†æ˜¯è¿˜æ²¡ç¡®è®¤çš„æ¶ˆæ¯ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-276.png" alt="img"></p>
<p>å‡å¦‚ä¸€å°èŠ‚ç‚¹è¯»å–å®Œæ¶ˆæ¯è¿˜æ²¡å´æ¥å¾—åŠç¡®è®¤å°±å®•æœºäº†ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹çš„æ–¹æ³•è§£å†³ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-277.png" alt="img"></p>
<p>æ­£å¸¸æƒ…å†µä¸‹å…ˆç”¨&gt;ï¼Œå¦‚æœå‡ºç°å¼‚å¸¸ï¼Œä¿¡æ¯ä¼šè¿›å…¥åˆ°Pending-listï¼ŒæŠŠIDä»&gt;æ”¹ä¸º0ï¼Œæ­¤æ—¶å–çš„å°±æ˜¯åœ¨Pending-listé‡Œçš„æ¶ˆæ¯ã€‚</p>
<p>æ¶ˆè´¹è€…ç›‘å¬æ¶ˆæ¯çš„åŸºæœ¬æ€è·¯ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-266.png" alt="img"></p>
<p>STREAMç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADGROUPå‘½ä»¤ç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ¶ˆæ¯å¯å›æº¯</li>
<li>å¯ä»¥å¤šæ¶ˆè´¹è€…äº‰æŠ¢æ¶ˆæ¯ï¼ŒåŠ å¿«æ¶ˆè´¹é€Ÿåº¦</li>
<li>å¯ä»¥é˜»å¡è¯»å–</li>
<li>æ²¡æœ‰æ¶ˆæ¯æ¼è¯»çš„é£é™©</li>
<li>æœ‰æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼Œä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡</li>
<li>æ”¯æŒæ¶ˆæ¯æŒä¹…åŒ–</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-267.png" alt="img"></p>
<h3 id="7-6-åŸºäºRedisçš„Streamç»“æ„ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ç°å¼‚æ­¥ç§’æ€ä¸‹å•">7.6 åŸºäºRedisçš„Streamç»“æ„ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ç°å¼‚æ­¥ç§’æ€ä¸‹å•</h3>
<p>éœ€æ±‚ï¼šåœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ <strong>Redis Stream</strong> æ¥å®ç°ä¸€ä¸ª <strong>å¼‚æ­¥ç§’æ€ä¸‹å•</strong> çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ªStreamç±»å‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåä¸ºstream.orders</li>
<li>ä¿®æ”¹ä¹‹å‰çš„ç§’æ€ä¸‹å•Luaè„šæœ¬ï¼Œåœ¨è®¤å®šæœ‰æŠ¢è´­èµ„æ ¼åï¼Œç›´æ¥å‘stream.ordersä¸­æ·»åŠ æ¶ˆæ¯ï¼Œå†…å®¹åŒ…å«voucherIdã€userIdã€orderId</li>
<li>é¡¹ç›®å¯åŠ¨æ—¶ï¼Œå¼€å¯ä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡ï¼Œå°è¯•è·å–stream.ordersä¸­çš„æ¶ˆæ¯ï¼Œå®Œæˆä¸‹å•</li>
</ul>
<p>ç›´æ¥é€šè¿‡æ§åˆ¶å°åˆ›å»ºä¸€ä¸ªstream.ordersé˜Ÿåˆ—ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-278.png" alt="img"></p>
<p>ç›´æ¥åœ¨Luaè„šæœ¬ä¸­ç¼–å†™ä»£ç ï¼ˆä¸»è¦å¢åŠ ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼‰</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--1.å‚æ•°åˆ—è¡¨</span></span><br><span class="line"><span class="comment">--1.1.ä¼˜æƒ åˆ¸id</span></span><br><span class="line"><span class="keyword">local</span> voucherId = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="comment">--1.2.ç”¨æˆ·id</span></span><br><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">2</span>]</span><br><span class="line"><span class="comment">--1.3.è®¢å•id</span></span><br><span class="line"><span class="keyword">local</span> orderId = ARGV[<span class="number">3</span>]</span><br><span class="line"> </span><br><span class="line"><span class="comment">--2.æ•°æ®key</span></span><br><span class="line"><span class="comment">--2.1.åº“å­˜key</span></span><br><span class="line"><span class="keyword">local</span> stockKey = <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId</span><br><span class="line"><span class="comment">--2.2.è®¢å•key</span></span><br><span class="line"><span class="keyword">local</span> orderKey = <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId</span><br><span class="line"> </span><br><span class="line"><span class="comment">--3.è„šæœ¬ä¸šåŠ¡</span></span><br><span class="line"><span class="comment">--3.1.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ get stockKey</span></span><br><span class="line"><span class="keyword">if</span>(tonumber(redis.<span class="keyword">call</span>(<span class="string">&#x27;get&#x27;</span>,stockKey)) &lt;= <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">--3.1.2.åº“å­˜ä¸è¶³ï¼Œè¿”å›1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--3.2.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å• SISMEMBER orderKey userId</span></span><br><span class="line"><span class="keyword">if</span>(redis.<span class="keyword">call</span>(<span class="string">&#x27;sismember&#x27;</span>,orderKey,userId)==<span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">--3.2.1.å­˜åœ¨ï¼Œè¯´æ˜æ˜¯é‡å¤ä¸‹å•ï¼Œè¿”å›2</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--3.3.æ‰£åº“å­˜ incrby stockKey -1</span></span><br><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;incrby&#x27;</span>,stockKey,<span class="number">-1</span>)</span><br><span class="line"><span class="comment">--3.4.ä¸‹å• sadd orderKey userId</span></span><br><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;sadd&#x27;</span>,orderKey,userId)</span><br><span class="line"><span class="comment">--3.5.å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ä¸­ XADD stream.orders * k1 v1 k2 v2</span></span><br><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;xadd&#x27;</span>,<span class="string">&#x27;stream.orders&#x27;</span>,<span class="string">&#x27;*&#x27;</span>,<span class="string">&#x27;userId&#x27;</span>,userId,<span class="string">&#x27;voucherId&#x27;</span>,voucherId,<span class="string">&#x27;orderId&#x27;</span>,orderId)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>xadd</code></strong> å‘½ä»¤å°† <code>userId</code>ã€<code>voucherId</code> å’Œ <code>orderId</code> å‘é€åˆ°åä¸º <code>stream.orders</code> çš„é˜Ÿåˆ—ä¸­ã€‚</li>
<li>æ¶ˆæ¯è¢«å‘é€åˆ°é˜Ÿåˆ—åï¼Œæ¶ˆè´¹è€…å¯ä»¥å¼‚æ­¥å¤„ç†è¿™ä¸ªæ¶ˆæ¯ã€‚</li>
</ul>
<p>åœ¨VoucherOrderServiceImplç±»ä¸­ä¿®æ”¹seckillVoucheræ–¹æ³•ï¼š</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function">Result <span class="title">seckillVoucher</span><span class="params">(Long voucherId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//è·å–è®¢å•id</span></span><br><span class="line">    <span class="keyword">long</span> orderId = redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    <span class="comment">//1.æ‰§è¡ŒLuaè„šæœ¬(åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰è´­ä¹°èµ„æ ¼ï¼Œæ¶ˆæ¯å‘å‡º)</span></span><br><span class="line">    Long result = stringRedisTemplate.execute(</span><br><span class="line">            SECKILL_SCRIPT,</span><br><span class="line">            Collections.emptyList(),</span><br><span class="line">            voucherId.toString(),</span><br><span class="line">            UserHolder.getUser().getId().toString(),</span><br><span class="line">            String.valueOf(orderId)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">int</span> r = result.intValue();</span><br><span class="line">    <span class="keyword">if</span>(r != <span class="number">0</span>)&#123; <span class="comment">//2.åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0,ä¸ä¸º0,ä»£è¡¨æ²¡æœ‰è´­ä¹°èµ„æ ¼</span></span><br><span class="line">        <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(r==<span class="number">1</span> ? <span class="string">&quot;åº“å­˜ä¸è¶³&quot;</span>:<span class="string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è·å–ä»£ç†å¯¹è±¡</span></span><br><span class="line">    proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">    <span class="comment">//3.è¿”å›è®¢å•id</span></span><br><span class="line">    <span class="function"><span class="keyword">return</span> Result.<span class="title">ok</span><span class="params">(orderId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡æ‰§è¡Œ Lua è„šæœ¬æ¥è¿›è¡Œç§’æ€èµ„æ ¼çš„åˆ¤æ–­ï¼Œå¹¶å°†è®¢å•ä¿¡æ¯å‘é€åˆ° <code>stream.orders</code> é˜Ÿåˆ—ã€‚</p>
<p>åœ¨VoucherOrderServiceImplä¸­ä¿®æ”¹VoucherOrderHandleræ–¹æ³•çš„ä»£ç ï¼š</p>
<p>ä»£ç æ€è·¯å¦‚ä¸‹ï¼š</p>
<p>1.ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å°è¯•è¯»æ¶ˆæ¯ã€‚</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">1</span>.<span class="number">1</span>.è·å–å¤±è´¥ï¼Œç»§ç»­å¾ªç¯ã€‚</span><br></pre></td></tr></table></figure>
<p>2.è·å–æˆåŠŸï¼Œè¿›è¡Œè§£æå’Œè½¬æ¢ã€‚</p>
<p>3.è°ƒç”¨createVoucherOrder(voucherOrder)æ–¹æ³•å®Œæˆä¸‹å•ã€‚</p>
<p>4.ACKç¡®è®¤</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">    <span class="number">4.1</span>.ç¡®è®¤å¤±è´¥ï¼Œè°ƒç”¨<span class="title function_">handlePendingList</span>()æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="title class_">ExecutorService</span> seckill_order_executor = <span class="title class_">Executors</span>.<span class="title function_">newSingleThreadExecutor</span>();</span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">void</span> <span class="title function_">init</span>(<span class="params"></span>)&#123;</span><br><span class="line">    seckill_order_executor.<span class="title function_">submit</span>(<span class="keyword">new</span> <span class="title class_">VoucherOrderHandler</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line">    <span class="title class_">String</span> queueName = <span class="string">&quot;stream.order&quot;</span>;</span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//1.è·å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS streams.order &gt;</span></span><br><span class="line">                <span class="title class_">List</span>&lt;<span class="title class_">MapRecord</span>&lt;<span class="title class_">String</span>, <span class="title class_">Object</span>, <span class="title class_">Object</span>&gt;&gt; list = stringRedisTemplate.<span class="title function_">opsForStream</span>().<span class="title function_">read</span>(</span><br><span class="line">                        <span class="title class_">Consumer</span>.<span class="title function_">from</span>(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">                        <span class="title class_">StreamReadOptions</span>.<span class="title function_">empty</span>().<span class="title function_">count</span>(<span class="number">1</span>).<span class="title function_">block</span>(<span class="title class_">Duration</span>.<span class="title function_">ofSeconds</span>(<span class="number">2</span>)),</span><br><span class="line">                        <span class="title class_">StreamOffset</span>.<span class="title function_">create</span>(queueName, <span class="title class_">ReadOffset</span>.<span class="title function_">lastConsumed</span>())</span><br><span class="line">                );</span><br><span class="line">                <span class="comment">//2.åˆ¤æ–­æ¶ˆæ¯è·å–æ˜¯å¦æˆåŠŸ</span></span><br><span class="line">                <span class="keyword">if</span>(list==<span class="literal">null</span> || list.<span class="title function_">isEmpty</span>())&#123;</span><br><span class="line">                    <span class="comment">//2.1.è·å–å¤±è´¥ï¼Œæ²¡æœ‰æ¶ˆæ¯ï¼Œç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//3.è§£ææ¶ˆæ¯ä¸­çš„è®¢å•ä¿¡æ¯</span></span><br><span class="line">                <span class="title class_">MapRecord</span>&lt;<span class="title class_">String</span>, <span class="title class_">Object</span>, <span class="title class_">Object</span>&gt; record = list.<span class="title function_">get</span>(<span class="number">0</span>);</span><br><span class="line">                <span class="comment">//4.è·å–æˆåŠŸï¼Œå¯ä»¥ä¸‹å•</span></span><br><span class="line">                <span class="title class_">Map</span>&lt;<span class="title class_">Object</span>, <span class="title class_">Object</span>&gt; values = record.<span class="title function_">getValue</span>();</span><br><span class="line">                <span class="comment">//3.åˆ›å»ºè®¢å•</span></span><br><span class="line">                <span class="title class_">VoucherOrder</span> voucherOrder = <span class="title class_">BeanUtil</span>.<span class="title function_">fillBeanWithMap</span>(values, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br><span class="line">                <span class="title function_">createVoucherOrder</span>(voucherOrder);</span><br><span class="line">                <span class="comment">//4.ACKç¡®è®¤</span></span><br><span class="line">                stringRedisTemplate.<span class="title function_">opsForStream</span>().<span class="title function_">acknowledge</span>(queueName,<span class="string">&quot;g1&quot;</span>,record.<span class="title function_">getId</span>());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) &#123;</span><br><span class="line">                log.<span class="title function_">debug</span>(<span class="string">&quot;å¤„ç†è®¢å•å¼‚å¸¸&quot;</span>,e);</span><br><span class="line">                <span class="title function_">handlePendingList</span>();</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>XREAD</code></strong> å‘½ä»¤ä» <code>stream.orders</code> é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯ã€‚</li>
<li>è¯»å–åˆ°æ¶ˆæ¯åï¼Œè°ƒç”¨ <code>createVoucherOrder()</code> æ–¹æ³•æ¥å¤„ç†è®¢å•ã€‚</li>
<li>ä½¿ç”¨ <strong>ACK ç¡®è®¤</strong> æ¥ç¡®ä¿æ¶ˆæ¯è¢«æ­£ç¡®æ¶ˆè´¹ã€‚</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">  </span><br></pre></td></tr></table></figure>
<p>åœ¨VoucherOrderServiceImplä¸­æ·»åŠ handlePendingList()æ–¹æ³•çš„ä»£ç ï¼š</p>
<p>ä¸‹é¢æœ‰å‡ ä¸ªä¿®æ”¹ç‚¹ï¼š1.XREADGROUPè¯­å¥æœ«å°¾æ”¹ä¸º0ï¼Œè¡¨ç¤ºè¯»Pending-listé˜Ÿåˆ—ã€‚2.Pending-listæ¶ˆæ¯è·å–å¤±è´¥ç»“æŸå¾ªç¯ã€‚3.å¦‚æœæŠ›å¼‚å¸¸åªæ˜¯æš‚åœä¸€ä¸‹ï¼Œç„¶åä¼šç»§ç»­å¾ªç¯è¯»ã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">void</span> <span class="title function_">handlePendingList</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1.è·å–Pending-Listä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS streams.order 0</span></span><br><span class="line">            <span class="title class_">List</span>&lt;<span class="title class_">MapRecord</span>&lt;<span class="title class_">String</span>, <span class="title class_">Object</span>, <span class="title class_">Object</span>&gt;&gt; list = stringRedisTemplate.<span class="title function_">opsForStream</span>().<span class="title function_">read</span>(</span><br><span class="line">                    <span class="title class_">Consumer</span>.<span class="title function_">from</span>(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">                    <span class="title class_">StreamReadOptions</span>.<span class="title function_">empty</span>().<span class="title function_">count</span>(<span class="number">1</span>),</span><br><span class="line">                    <span class="title class_">StreamOffset</span>.<span class="title function_">create</span>(queueName, <span class="title class_">ReadOffset</span>.<span class="title function_">from</span>(<span class="string">&quot;0&quot;</span>))</span><br><span class="line">            );</span><br><span class="line">            <span class="comment">//2.åˆ¤æ–­æ¶ˆæ¯è·å–æ˜¯å¦æˆåŠŸ</span></span><br><span class="line">            <span class="keyword">if</span>(list==<span class="literal">null</span> || list.<span class="title function_">isEmpty</span>())&#123;</span><br><span class="line">                <span class="comment">//2.1.è·å–å¤±è´¥ï¼Œè¯´æ˜Pending-listé‡Œæ²¡æœ‰å¼‚å¸¸æ¶ˆæ¯ï¼Œç»“æŸå¾ªç¯</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//3.è§£ææ¶ˆæ¯ä¸­çš„è®¢å•ä¿¡æ¯</span></span><br><span class="line">            <span class="title class_">MapRecord</span>&lt;<span class="title class_">String</span>, <span class="title class_">Object</span>, <span class="title class_">Object</span>&gt; record = list.<span class="title function_">get</span>(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">//4.è·å–æˆåŠŸï¼Œå¯ä»¥ä¸‹å•</span></span><br><span class="line">            <span class="title class_">Map</span>&lt;<span class="title class_">Object</span>, <span class="title class_">Object</span>&gt; values = record.<span class="title function_">getValue</span>();</span><br><span class="line">            <span class="comment">//3.åˆ›å»ºè®¢å•</span></span><br><span class="line">            <span class="title class_">VoucherOrder</span> voucherOrder = <span class="title class_">BeanUtil</span>.<span class="title function_">fillBeanWithMap</span>(values, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br><span class="line">            <span class="comment">//4.ACKç¡®è®¤</span></span><br><span class="line">            stringRedisTemplate.<span class="title function_">opsForStream</span>().<span class="title function_">acknowledge</span>(queueName,<span class="string">&quot;g1&quot;</span>,record.<span class="title function_">getId</span>());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) &#123;</span><br><span class="line">            log.<span class="title function_">debug</span>(<span class="string">&quot;å¤„ç†Pending-listå¼‚å¸¸&quot;</span>,e);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="title class_">Thread</span>.<span class="title function_">sleep</span>(<span class="number">20</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="title class_">InterruptedException</span> ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ€»ç»“ï¼š</p>
<ul>
<li><strong>å¼‚æ­¥ä¸‹å•</strong>ï¼šé€šè¿‡ Redis Stream å®ç°ç§’æ€ä¸‹å•çš„å¼‚æ­¥å¤„ç†ï¼Œé¿å…äº†å‰ç«¯ç”¨æˆ·çš„é˜»å¡ã€‚</li>
<li><strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼šä½¿ç”¨ Redis Stream å­˜å‚¨æ¶ˆæ¯ï¼Œç¡®ä¿æ¯ä¸ªç§’æ€è¯·æ±‚å¯ä»¥è¢«å¼‚æ­¥å¤„ç†ã€‚</li>
<li><strong>æ¶ˆæ¯ç¡®è®¤æœºåˆ¶</strong>ï¼šä½¿ç”¨ ACK ç¡®è®¤ç¡®ä¿æ¶ˆæ¯è¢«æˆåŠŸæ¶ˆè´¹ï¼Œå¹¶é€šè¿‡ Pending List å¤„ç†å¼‚å¸¸æ¶ˆæ¯ï¼Œé˜²æ­¢ä¸¢å¤±ã€‚</li>
</ul>
<p>æµ‹è¯•ï¼š</p>
<p>ç”¨Apifoxè¿›è¡Œæµ‹è¯•ï¼Œæµ‹è¯•æ¥å£è¯·æ±‚å‘é€æˆåŠŸï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-280-1024x590.png" alt="img"></p>
<p>æµ‹è¯•æˆåŠŸåå¯ä»¥çœ‹åˆ°ï¼štb_voucher_orderè¡¨å¤šäº†1æ¡è®°å½•ï¼Œtb_seckill_voucherè¡¨å¯¹åº”ä¼˜æƒ åˆ¸çš„åº“å­˜-1ï¼›åœ¨Redisä¸­seckill:orderä¸‹å‡ºç°è®¢å•è®°å½•ï¼Œåœ¨stockill:stockä¸‹çš„åº“å­˜-1ï¼Œåœ¨stream.ordersä¸‹å‡ºç°1æ¡æ–°çš„è®°å½•ã€‚</p>
<p>ç„¶åç”¨Jmeterè¿›è¡Œæµ‹è¯•ï¼šå¯ä»¥å‘ç°ç›¸è¾ƒäºæœªåšå¼‚æ­¥å¤„ç†çš„æƒ…å†µæ€§èƒ½ä»æœ‰è¾ƒå¤§æå‡ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-279-1024x264.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-281-1024x479.png" alt="img"></p>
<h2 id="8ã€è¾¾äººæ¢åº—">8ã€è¾¾äººæ¢åº—</h2>
<h3 id="8-1ã€è¾¾äººæ¢åº—-å‘å¸ƒæ¢åº—ç¬”è®°">8.1ã€è¾¾äººæ¢åº—-å‘å¸ƒæ¢åº—ç¬”è®°</h3>
<p>å‘å¸ƒæ¢åº—ç¬”è®°</p>
<p>æ¢åº—ç¬”è®°ç±»ä¼¼ç‚¹è¯„ç½‘ç«™çš„è¯„ä»·ï¼Œå¾€å¾€æ˜¯å›¾æ–‡ç»“åˆã€‚å¯¹åº”çš„è¡¨æœ‰ä¸¤ä¸ªï¼š<br>
tb_blogï¼šæ¢åº—ç¬”è®°è¡¨ï¼ŒåŒ…å«ç¬”è®°ä¸­çš„æ ‡é¢˜ã€æ–‡å­—ã€å›¾ç‰‡ç­‰<br>
tb_blog_commentsï¼šå…¶ä»–ç”¨æˆ·å¯¹æ¢åº—ç¬”è®°çš„è¯„ä»·</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-283.png" alt="img"></p>
<p><strong>å…·ä½“å‘å¸ƒæµç¨‹</strong></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-284.png" alt="img"></p>
<p>ä¸Šä¼ æ¥å£</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;upload&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">&quot;blog&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Result</span> <span class="title function_">uploadImage</span>(<span class="params"><span class="meta">@RequestParam</span>(<span class="string">&quot;file&quot;</span>) <span class="title class_">MultipartFile</span> image</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è·å–åŸå§‹æ–‡ä»¶åç§°</span></span><br><span class="line">            <span class="title class_">String</span> originalFilename = image.<span class="title function_">getOriginalFilename</span>();</span><br><span class="line">            <span class="comment">// ç”Ÿæˆæ–°æ–‡ä»¶å</span></span><br><span class="line">            <span class="title class_">String</span> fileName = <span class="title function_">createNewFileName</span>(originalFilename);</span><br><span class="line">            <span class="comment">// ä¿å­˜æ–‡ä»¶</span></span><br><span class="line">            image.<span class="title function_">transferTo</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="title class_">SystemConstants</span>.<span class="property">IMAGE_UPLOAD_DIR</span>, fileName));</span><br><span class="line">            <span class="comment">// è¿”å›ç»“æœ</span></span><br><span class="line">            log.<span class="title function_">debug</span>(<span class="string">&quot;æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œ&#123;&#125;&quot;</span>, fileName);</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">Result</span>.<span class="title function_">ok</span>(fileName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="title class_">IOException</span> e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;æ–‡ä»¶ä¸Šä¼ å¤±è´¥&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼šåŒå­¦ä»¬åœ¨æ“ä½œæ—¶ï¼Œéœ€è¦ä¿®æ”¹SystemConstants.IMAGE_UPLOAD_DIR è‡ªå·±å›¾ç‰‡æ‰€åœ¨çš„åœ°å€ï¼Œåœ¨å®é™…å¼€å‘ä¸­å›¾ç‰‡ä¸€èˆ¬ä¼šæ”¾åœ¨nginxä¸Šæˆ–è€…æ˜¯äº‘å­˜å‚¨ä¸Šã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-285-1024x179.png" alt="img"></p>
<p>BlogController</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(<span class="string">&quot;/blog&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IBlogService blogService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="keyword">public</span> Result saveBlog(<span class="meta">@RequestBody</span> Blog blog) &#123;</span><br><span class="line">        <span class="comment">//è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">        UserDTO user = UserHolder.getUser();</span><br><span class="line">        blog.setUpdateTime(user.getId());</span><br><span class="line">        <span class="comment">//ä¿å­˜æ¢åº—åšæ–‡</span></span><br><span class="line">        blogService.saveBlog(blog);</span><br><span class="line">        <span class="comment">//è¿”å›id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(blog.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="8-2-è¾¾äººæ¢åº—-æŸ¥çœ‹æ¢åº—ç¬”è®°">8.2 è¾¾äººæ¢åº—-æŸ¥çœ‹æ¢åº—ç¬”è®°</h3>
<p>æ¢åº—ç¬”è®°è¦åŒ…å«ç¬”è®°çš„å†…å®¹å’Œåšä¸»çš„ç›¸å…³ä¿¡æ¯ã€‚æ‰€ä»¥é€‰æ‹©åœ¨Blogè¡¨ä¸­æ·»åŠ å¦‚ä¸‹2ä¸ªå­—æ®µï¼Œè¿™ä¸¤ä¸ªå­—æ®µéœ€è¦åç»­æˆ‘ä»¬æ‰‹åŠ¨ç»´æŠ¤ï¼ˆèµ‹å€¼ï¼‰ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-286-1024x814.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-287.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-289.png" alt="img"></p>
<p>åœ¨BlogControllerç±»é‡Œæ·»åŠ ä¸€ä¸ªqueryBlogByIdæ–¹æ³•ï¼ˆè™½ç„¶Controlleré‡Œä¸åº”è¯¥å‡ºç°ä¸šåŠ¡ä»£ç ï¼Œä½†é‰´äºåªæ˜¯ç®€å•çš„æŸ¥è¯¢æ“ä½œï¼Œå°±ä¸å¿…åœ¨æ„ç»†èŠ‚äº†ï¼‰ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(<span class="string">&quot;/&#123;id&#125;&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> Result queryBlogById(<span class="meta">@PathVariable(<span class="string">&quot;id&quot;</span>)</span> <span class="built_in">Long</span> id)&#123;</span><br><span class="line">    Blog blog = blogService.getById(id);</span><br><span class="line">    <span class="keyword">if</span>(blog==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;ç¬”è®°ä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    User user = userService.getById(id);</span><br><span class="line">    blog.setIcon(user.getIcon());</span><br><span class="line">    blog.setName(user.getNickName());</span><br><span class="line">    <span class="keyword">return</span> Result.ok(blog);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="8-3-è¾¾äººæ¢åº—-ç‚¹èµåŠŸèƒ½">8.3 è¾¾äººæ¢åº—-ç‚¹èµåŠŸèƒ½</h3>
<p>ç°åœ¨çš„ç‚¹èµé€»è¾‘æ˜¯ï¼Œä¸€ä¸ªäººå¯ä»¥å¯¹åŒä¸€ç¯‡ç¬”è®°ç‚¹èµæ— æ•°æ¬¡ã€‚</p>
<p>éœ€æ±‚ï¼š</p>
<ul>
<li>1.åŒä¸€ä¸ªç”¨æˆ·åªèƒ½ç‚¹èµä¸€æ¬¡ï¼Œå¦‚æœå†æ¬¡ç‚¹å‡»åˆ™å–æ¶ˆç‚¹èµã€‚</li>
<li>2.å¦‚æœå½“å‰ç”¨æˆ·å·²ç»ç‚¹èµï¼Œåˆ™ç‚¹èµæŒ‰é’®é«˜äº®æ˜¾ç¤ºï¼ˆå‰ç«¯å·²å®ç°ï¼Œåˆ¤æ–­å­—æ®µBlogç±»çš„isLikeå±æ€§ï¼‰</li>
</ul>
<p>åˆ†æï¼š</p>
<ul>
<li>1.ç»™Blogç±»ä¸­æ·»åŠ ä¸€ä¸ªisLikeå­—æ®µï¼Œæ ‡ç¤ºæ˜¯å¦è¢«å½“å‰ç”¨æˆ·ç‚¹èµã€‚</li>
<li>2.ä¿®æ”¹ç‚¹èµåŠŸèƒ½ï¼Œåˆ©ç”¨Redisçš„Seté›†åˆåˆ¤æ–­æ˜¯å¦ç‚¹èµè¿‡ï¼Œæœªç‚¹èµåˆ™ç‚¹èµæ•°+1ï¼Œå·²ç‚¹èµåˆ™ç‚¹èµæ•°-1ã€‚</li>
<li>3.ä¿®æ”¹åˆ†é¡µæŸ¥è¯¢Blogä¸šåŠ¡å’Œæ ¹æ®idæŸ¥è¯¢Blogçš„ä¸šåŠ¡ï¼Œåˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦ç‚¹èµè¿‡ï¼Œèµ‹å€¼ç»™isLikeå­—æ®µã€‚</li>
<li>4.ä¿®æ”¹åˆ†é¡µæŸ¥è¯¢Blogä¸šåŠ¡ï¼Œåˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦ç‚¹èµè¿‡ï¼Œèµ‹å€¼ç»™isLikeå­—æ®µ</li>
</ul>
<p>ä¸ºä»€ä¹ˆé‡‡ç”¨seté›†åˆï¼š</p>
<p>Redis çš„ Set æ˜¯ä¸€ä¸ªä¸å…è®¸é‡å¤å…ƒç´ çš„é›†åˆï¼Œç‰¹åˆ«é€‚åˆç”¨äºå­˜å‚¨ç”¨æˆ·æ˜¯å¦ç‚¹èµçš„çŠ¶æ€ã€‚</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<p>åœ¨BlogControllerç±»ä¸­æ–°å¢likeBlogæ–¹æ³•ï¼š</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@PutMapping</span>(<span class="string">&quot;/like/&#123;id&#125;&quot;</span>)</span><br><span class="line">public Result <span class="built_in">likeBlog</span>(<span class="variable">@PathVariable</span>(<span class="string">&quot;id&quot;</span>) Long id) &#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">blogService</span><span class="selector-class">.likeBlog</span>(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ä½¿ç”¨ <code>@PutMapping</code> è¡¨ç¤ºç”¨æˆ·ç‚¹èµæˆ–å–æ¶ˆç‚¹èµã€‚</li>
<li>è°ƒç”¨ <code>likeBlog</code> æ–¹æ³•æ¥æ‰§è¡Œç‚¹èµé€»è¾‘ã€‚</li>
</ul>
<p>åœ¨IBlogServiceæ¥å£ä¸­æ·»åŠ æ–¹æ³•å£°æ˜ï¼š</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable"><span class="class">Result</span></span> <span class="function"><span class="title">likeBlog</span>(<span class="variable">Long</span> <span class="variable">id</span>);</span></span><br></pre></td></tr></table></figure>
<p>åœ¨BlogServiceImplç±»ä¸­æ·»åŠ ä¸‹é¢ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">BlogServiceImpl</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> user.getId();</span><br><span class="line">    <span class="comment">//2.åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµè¿‡</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;blog:liked:&quot;</span> +id;</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isMember</span> <span class="operator">=</span> stringRedisTemplate.opsForSet().isMember(key, userId.toString());</span><br><span class="line">    <span class="keyword">if</span>(BooleanUtil.isFalse(isMember))&#123;</span><br><span class="line">        <span class="comment">//3.æœªç‚¹èµï¼Œå¯ä»¥ç‚¹èµ</span></span><br><span class="line">        <span class="comment">//3.1.æ•°æ®åº“ç‚¹èµæ•°+1</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked=liked+1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="comment">//3.2.ä¿å­˜ç”¨æˆ·åˆ°Redis</span></span><br><span class="line">        <span class="keyword">if</span>(isSuccess)&#123;</span><br><span class="line">            stringRedisTemplate.opsForSet().add(key,userId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//4.å·²ç‚¹èµï¼Œå–æ¶ˆç‚¹èµ</span></span><br><span class="line">        <span class="comment">//4.1.æ•°æ®åº“ç‚¹èµæ•°-1</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked=liked-1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="comment">//4.2.æŠŠç”¨æˆ·ä»Redisçš„seté›†åˆç§»é™¤</span></span><br><span class="line">        stringRedisTemplate.opsForSet().remove(key,userId.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ç‚¹èµ</strong>ï¼šå¦‚æœ Redis Set ä¸­æ²¡æœ‰å½“å‰ç”¨æˆ·çš„ IDï¼Œè¯´æ˜ç”¨æˆ·è¿˜æœªç‚¹èµï¼Œæ‰§è¡Œæ•°æ®åº“æ›´æ–°ï¼ˆç‚¹èµæ•°+1ï¼‰ï¼Œå¹¶å°†ç”¨æˆ· ID å­˜å…¥ Redis Setã€‚</li>
<li><strong>å–æ¶ˆç‚¹èµ</strong>ï¼šå¦‚æœ Redis Set ä¸­æœ‰å½“å‰ç”¨æˆ·çš„ IDï¼Œè¯´æ˜ç”¨æˆ·å·²ç‚¹èµï¼Œæ‰§è¡Œæ•°æ®åº“æ›´æ–°ï¼ˆç‚¹èµæ•°-1ï¼‰ï¼Œå¹¶å°†ç”¨æˆ· ID ä» Redis Set ä¸­ç§»é™¤ã€‚</li>
</ul>
<p>å› ä¸ºæˆ‘çš„queryBlogByIdå’ŒqueryHotBlogçš„ä¸šåŠ¡ä»£ç éƒ½æ²¿ç”¨åŸæœ¬çš„ä»£ç å†™åœ¨BlogControllerä¸­ï¼Œå› æ­¤æˆ‘æ˜¯ç›´æ¥åœ¨BlogControllerä¸­å†™å…¥isBlogLikedä»£ç ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">Boolean</span> isBlogLiked(Blog blog) &#123;</span><br><span class="line"><span class="built_in">Long</span> userId = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">userId = UserHolder.getUser().getId();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">log.debug(<span class="string">&quot;ç”¨æˆ·æœªç™»å½•ï¼&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//2.åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµè¿‡</span></span><br><span class="line">String key = <span class="string">&quot;blog:liked:&quot;</span> +blog.getId();</span><br><span class="line"><span class="built_in">Boolean</span> isMember = stringRedisTemplate.opsForSet().isMember(key, userId.toString());</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">blog.setIsLike(BooleanUtil.isTrue(isMember));</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">log.debug(<span class="string">&quot;ç‚¹èµä¿¡æ¯ä¸ºç©ºï¼&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> isMember;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç‚¹èµ</strong>ï¼šé€šè¿‡ Redis åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å·²ç‚¹èµï¼Œå¦‚æœç‚¹èµï¼Œåˆ™å°† <code>isLike</code> å­—æ®µè®¾ç½®ä¸º <code>true</code>ï¼Œå‰ç«¯æ ¹æ®è¯¥å­—æ®µå€¼æ¥æ§åˆ¶ç‚¹èµæŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-291.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-290.png" alt="img"></p>
<p>æ€»ç»“ï¼š</p>
<ul>
<li><strong>ç‚¹èµæ“ä½œ</strong>ï¼šä½¿ç”¨ Redis Set æ¥å­˜å‚¨æ¯ä¸ªç”¨æˆ·å¯¹åšå®¢çš„ç‚¹èµè®°å½•ï¼Œç¡®ä¿æ¯ä¸ªç”¨æˆ·åªèƒ½å¯¹åŒä¸€ç¯‡æ–‡ç« ç‚¹èµä¸€æ¬¡ã€‚</li>
<li><strong>å¼‚æ­¥æ›´æ–°</strong>ï¼šé€šè¿‡ Redis å­˜å‚¨ç‚¹èµçŠ¶æ€ï¼Œå‡å°‘æ•°æ®åº“æ“ä½œé¢‘ç‡ï¼Œæé«˜æ€§èƒ½ã€‚</li>
<li><strong>å‰ç«¯äº¤äº’</strong>ï¼šæ ¹æ® <code>isLike</code> å­—æ®µï¼Œå‰ç«¯åŠ¨æ€æ›´æ–°ç‚¹èµæŒ‰é’®çš„çŠ¶æ€ï¼Œå®ç°é«˜äº®æ˜¾ç¤ºå’Œå–æ¶ˆé«˜äº®ã€‚</li>
<li><strong>ç¼“å­˜ä¼˜åŒ–</strong>ï¼šä½¿ç”¨ Redis å¿«é€Ÿæ£€æŸ¥ç”¨æˆ·çš„ç‚¹èµçŠ¶æ€ï¼Œé¿å…é¢‘ç¹è®¿é—®æ•°æ®åº“ï¼Œæé«˜ç³»ç»Ÿå“åº”é€Ÿåº¦ã€‚</li>
</ul>
<p>æµ‹è¯•æ•ˆæœï¼šç‚¹èµä¸€æ¬¡é«˜äº®ï¼Œç‚¹èµä¸¤æ¬¡å–æ¶ˆã€‚åœ¨ç¼“å­˜ä¸­æœ‰ç›¸åº”çš„è®°å½•</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-294.png" alt="img"></p>
<h3 id="8-4-è¾¾äººæ¢åº—-ç‚¹èµæ’è¡Œæ¦œ">8.4 è¾¾äººæ¢åº—-ç‚¹èµæ’è¡Œæ¦œ</h3>
<p>éœ€æ±‚ï¼šåœ¨æ¢åº—ç¬”è®°è¯¦æƒ…é¡µé¢ï¼ŒæŒ‰ç…§æ—¶é—´æ’åºï¼ŒæŠŠæœ€æ—©ç‚¹èµçš„TOP5åˆ—ä¸¾å‡ºæ¥ï¼Œå½¢æˆç‚¹èµæ’è¡Œæ¦œã€‚</p>
<p>ä¹‹å‰çš„ç‚¹èµæ˜¯æ”¾åˆ°seté›†åˆï¼Œä½†æ˜¯<strong>seté›†åˆæ˜¯ä¸èƒ½æ’åºçš„</strong>ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ï¼Œå’±ä»¬å¯ä»¥é‡‡ç”¨ä¸€ä¸ªå¯ä»¥æ’åºçš„seté›†åˆï¼Œå°±æ˜¯å’±ä»¬çš„sortedSet</p>
<p><strong>SortedSetï¼ˆæœ‰åºé›†åˆï¼‰</strong> æ˜¯ Redis ä¸­ä¸€ä¸ªé‡è¦çš„æ•°æ®ç»“æ„ï¼Œæ”¯æŒæŒ‰ <strong>score</strong> å€¼æ’åºï¼Œè¿™éå¸¸é€‚åˆç”¨äºæ’åç­‰åœºæ™¯ã€‚æˆ‘ä»¬éœ€è¦æ ¹æ® <strong>score</strong>ï¼ˆé€šå¸¸æ˜¯æ—¶é—´æˆ³æˆ–è€…ç”¨æˆ·çš„ç‚¹èµæ•°ç­‰ï¼‰æ¥æ’åºã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-295.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-292.png" alt="img"></p>
<p>å¯ä»¥ç”¨ZADDå‘½ä»¤æ·»åŠ å…ƒç´ ï¼ŒZSCOPEæ¥è·å¾—åˆ†æ•°å¯¹åº”çš„å…ƒç´ ï¼ŒZRANGEæ¥</p>
<p>Redis ä¸­é€šè¿‡ <strong>ZADD</strong> å‘½ä»¤æ¥å‘ <strong>SortedSet</strong> ä¸­æ·»åŠ å…ƒç´ ï¼Œå…ƒç´ ä¼šæ ¹æ® <strong>score</strong> å€¼æ’åºã€‚æ¯ä¸ªå…ƒç´ æœ‰ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li><strong>Member</strong>ï¼šè¡¨ç¤ºå…ƒç´ ã€‚</li>
<li><strong>Score</strong>ï¼šè¡¨ç¤ºæ’åºå€¼ï¼ŒRedis ä¼šæ ¹æ®è¿™ä¸ªå€¼å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-296.png" alt="img"></p>
<ul>
<li><code>ZADD</code> æ·»åŠ äº† 3 ä¸ªå…ƒç´ ï¼Œåˆ†åˆ«ä¸º m1ã€m2ã€m3ï¼Œä¸”åˆ†åˆ«èµ‹äºˆäº†ä¸åŒçš„ <strong>score</strong>ã€‚</li>
<li><code>ZRANGE</code> å‘½ä»¤æŒ‰ <strong>score</strong> å‡åºæ’åˆ—ï¼Œå¹¶è¿”å›æŒ‡å®šèŒƒå›´çš„å…ƒç´ ã€‚</li>
</ul>
<p>ä¿®æ”¹ä»¥ä¸‹å‡ ç‚¹</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-297-1024x584.png" alt="img"></p>
<ul>
<li><strong>ZADD</strong> ç”¨æ¥å°†ç”¨æˆ· ID å’Œå½“å‰æ—¶é—´æˆ³ï¼ˆä½œä¸º <code>score</code>ï¼‰åŠ å…¥åˆ° Redis çš„ SortedSet ä¸­ã€‚</li>
<li><strong>ZREM</strong> ç”¨æ¥ç§»é™¤å·²ç‚¹èµç”¨æˆ·çš„è®°å½•ï¼Œè¿›è¡Œå–æ¶ˆç‚¹èµæ“ä½œã€‚</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-298.png" alt="img"></p>
<p>åœ¨Redisç¼“å­˜ä¸­å¤šäº†ä¸€ä¸ªscoreï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-299.png" alt="img"></p>
<p>åœ¨BlogControllerç±»ä¸­æ·»åŠ å¦‚ä¸‹æ–¹æ³•ï¼š</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@GetMapping</span>(<span class="string">&quot;/likes/&#123;id&#125;&quot;</span>)</span><br><span class="line">public Result <span class="built_in">queryBlogLikes</span>(<span class="variable">@PathVariable</span>(<span class="string">&quot;id&quot;</span>) Long id) &#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">blogService</span><span class="selector-class">.queryBlogLikes</span>(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>BlogController</code> ç±»ä¸­æ–°å¢æŸ¥è¯¢æ¥å£æ–¹æ³• <code>queryBlogLikes</code>ï¼š</p>
<ul>
<li><strong>GET</strong> è¯·æ±‚ <code>/blog/likes/&#123;id&#125;</code> æŸ¥è¯¢æŸç¯‡åšå®¢çš„ <strong>TOP 5 ç‚¹èµç”¨æˆ·</strong>ã€‚</li>
<li>è¿”å›ç»“æœæ˜¯ä¸€ä¸ª <code>List&lt;UserDTO&gt;</code>ï¼ŒåŒ…å«äº†ç‚¹èµæœ€å¤šçš„ç”¨æˆ·ã€‚</li>
</ul>
<p>åœ¨IBlogServiceæ¥å£ä¸­æ·»åŠ å¦‚ä¸‹æ–¹æ³•ï¼š</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable"><span class="class">Result</span></span> <span class="function"><span class="title">queryBlogLikes</span>(<span class="variable">Long</span> <span class="variable">id</span>);</span></span><br></pre></td></tr></table></figure>
<p>åœ¨BlogServiceImplç±»ä¸­æ·»åŠ å¦‚ä¸‹æ–¹æ³•ï¼š</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="keyword">public</span> Result queryBlogLikes(<span class="keyword">Long</span> id) &#123;</span><br><span class="line">    String key = RedisConstants.BLOG_LIKED_KEY +id;</span><br><span class="line">    <span class="comment">//1.æŸ¥è¯¢top5çš„ç‚¹èµç”¨æˆ· zrange key 0 4</span></span><br><span class="line">    Set&lt;String&gt; top5 = stringRedisTemplate.opsForZSet().range(key, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span>(top5==<span class="keyword">null</span> || top5.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.è§£æå‡ºå…¶ä¸­çš„ç”¨æˆ·id</span></span><br><span class="line">    List&lt;<span class="keyword">Long</span>&gt; ids = top5.stream().map(<span class="keyword">Long</span>::valueOf).<span class="keyword">collect</span>(Collectors.<span class="keyword">toList</span>());</span><br><span class="line">    <span class="comment">//3.æ ¹æ®ç”¨æˆ·idæŸ¥è¯¢ç”¨æˆ·</span></span><br><span class="line">    List&lt;UserDTO&gt; userDTOS = userService.listByIds(ids)</span><br><span class="line">            .stream()</span><br><span class="line">            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.<span class="keyword">class</span>))</span><br><span class="line">            .<span class="keyword">collect</span>(Collectors.<span class="keyword">toList</span>());</span><br><span class="line">    <span class="comment">//4.è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(userDTOS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ä¼šå‡ºç°å·¦å›¾é—®é¢˜ï¼Œå…ˆç‚¹èµçš„åè€Œè¢«æ’åˆ°åé¢äº†ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-300.png" alt="img"></p>
<p>ä¸‹é¢æ˜¯ä¿®æ”¹åçš„queryBlogLikesï¼š</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="keyword">public</span> Result queryBlogLikes(<span class="keyword">Long</span> id) &#123;</span><br><span class="line">    String key = RedisConstants.BLOG_LIKED_KEY +id;</span><br><span class="line">    <span class="comment">//1.æŸ¥è¯¢top5çš„ç‚¹èµç”¨æˆ· zrange key 0 4</span></span><br><span class="line">    Set&lt;String&gt; top5 = stringRedisTemplate.opsForZSet().range(key, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span>(top5==<span class="keyword">null</span> || top5.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.è§£æå‡ºå…¶ä¸­çš„ç”¨æˆ·id</span></span><br><span class="line">    List&lt;<span class="keyword">Long</span>&gt; ids = top5.stream().map(<span class="keyword">Long</span>::valueOf).<span class="keyword">collect</span>(Collectors.<span class="keyword">toList</span>());</span><br><span class="line">    <span class="comment">//3.æ ¹æ®ç”¨æˆ·idæŸ¥è¯¢ç”¨æˆ·</span></span><br><span class="line">    String idStr = StrUtil.<span class="keyword">join</span>(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">    List&lt;UserDTO&gt; userDTOS = userService.query()</span><br><span class="line">            .in(<span class="string">&quot;id&quot;</span>,ids)</span><br><span class="line">            .last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span>+idStr+<span class="string">&quot;)&quot;</span>).list()</span><br><span class="line">            .stream()</span><br><span class="line">            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.<span class="keyword">class</span>))</span><br><span class="line">            .<span class="keyword">collect</span>(Collectors.<span class="keyword">toList</span>());</span><br><span class="line">    <span class="comment">//4.è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(userDTOS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>èƒ½å¤Ÿæ­£å¸¸å±•ç¤ºï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-301.png" alt="img"></p>
<h2 id="9ã€å¥½å‹å…³æ³¨">9ã€å¥½å‹å…³æ³¨</h2>
<h3 id="9-1-å¥½å‹å…³æ³¨-å…³æ³¨å’Œå–æ¶ˆå…³æ³¨">9.1 å¥½å‹å…³æ³¨-å…³æ³¨å’Œå–æ¶ˆå…³æ³¨</h3>
<p>é’ˆå¯¹ç”¨æˆ·çš„æ“ä½œï¼šå¯ä»¥å¯¹ç”¨æˆ·è¿›è¡Œå…³æ³¨å’Œå–æ¶ˆå…³æ³¨åŠŸèƒ½ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-302-1024x506.png" alt="img"></p>
<p>å®ç°æ€è·¯ï¼š</p>
<p>éœ€æ±‚ï¼šåŸºäºè¯¥è¡¨æ•°æ®ç»“æ„ï¼Œå®ç°ä¸¤ä¸ªæ¥å£ï¼š</p>
<ul>
<li>å…³æ³¨å’Œå–å…³æ¥å£</li>
<li>åˆ¤æ–­æ˜¯å¦å…³æ³¨çš„æ¥å£</li>
</ul>
<p>å…³æ³¨æ˜¯Userä¹‹é—´çš„å…³ç³»ï¼Œæ˜¯åšä¸»ä¸ç²‰ä¸çš„å…³ç³»ï¼Œæ•°æ®åº“ä¸­æœ‰ä¸€å¼ tb_followè¡¨æ¥æ ‡ç¤ºï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-303-1024x213.png" alt="img"></p>
<p>å…³æ³¨æ˜¯ç»™è¡¨æ–°å¢è®°å½•ï¼Œå–å…³æ˜¯åˆ é™¤è¡¨ä¸­è®°å½•ã€‚</p>
<p>åœ¨FollowControllerç±»ä¸­å†™å…¥å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å…³æ³¨</span></span><br><span class="line"><span class="variable">@PutMapping</span>(<span class="string">&quot;/&#123;id&#125;/&#123;isFollow&#125;&quot;</span>)</span><br><span class="line">public Result <span class="built_in">follow</span>(<span class="variable">@PathVariable</span>(<span class="string">&quot;id&quot;</span>) Long followUserId, <span class="variable">@PathVariable</span>(<span class="string">&quot;isFollow&quot;</span>) Boolean isFollow) &#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">followService</span><span class="selector-class">.follow</span>(followUserId, isFollow);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å–æ¶ˆå…³æ³¨</span></span><br><span class="line">@<span class="selector-tag">GetMapping</span>(<span class="string">&quot;/or/not/&#123;id&#125;&quot;</span>)</span><br><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">Result</span> <span class="selector-tag">isFollow</span>(<span class="variable">@PathVariable</span>(<span class="string">&quot;id&quot;</span>) Long followUserId) &#123;</span><br><span class="line">      <span class="selector-tag">return</span> <span class="selector-tag">followService</span><span class="selector-class">.isFollow</span>(followUserId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å…³æ³¨æ¥å£ï¼ˆPUT è¯·æ±‚ï¼‰</strong>ï¼š</p>
<ul>
<li>è·¯ç”±ï¼š<code>/follow/&#123;id&#125;/&#123;isFollow&#125;</code></li>
<li>åŠŸèƒ½ï¼šåˆ¤æ–­æ˜¯å…³æ³¨è¿˜æ˜¯å–æ¶ˆå…³æ³¨ï¼Œé€šè¿‡ <code>isFollow</code> å‚æ•°æ¥åŒºåˆ†ã€‚å¦‚æœ <code>isFollow</code> ä¸º <code>true</code>ï¼Œåˆ™è¡¨ç¤ºå…³æ³¨ï¼›å¦‚æœä¸º <code>false</code>ï¼Œåˆ™è¡¨ç¤ºå–æ¶ˆå…³æ³¨ã€‚</li>
</ul>
<p><strong>å–æ¶ˆå…³æ³¨æ¥å£ï¼ˆGET è¯·æ±‚ï¼‰</strong>ï¼š</p>
<ul>
<li>è·¯ç”±ï¼š<code>/or/not/&#123;id&#125;</code></li>
<li>åŠŸèƒ½ï¼šåˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦å·²å…³æ³¨ç›®æ ‡ç”¨æˆ·ã€‚</li>
</ul>
<p>åœ¨IFollowServiceä¸­å†™å…¥å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="symbol">IFollowService</span> <span class="symbol">extends</span> <span class="symbol">IService</span>&lt;<span class="symbol">Follow</span>&gt; &#123;</span><br><span class="line">    Result follow(Long followUserId, Boolean isFollow); <span class="comment">// å…³æ³¨æˆ–å–å…³</span></span><br><span class="line">    Result isFollow(Long followUserId); <span class="comment">// åˆ¤æ–­æ˜¯å¦å…³æ³¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨FollowServiceImplç±»ä¸­å†™å…¥å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Service</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">FollowServiceImpl</span> <span class="title">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">FollowMapper</span>, <span class="title">Follow</span>&gt; <span class="title">implements</span> <span class="title">IFollowService</span> </span>&#123;</span><br><span class="line">    // å…³æ³¨ä¸å–æ¶ˆå…³æ³¨æ“ä½œ</span><br><span class="line">    <span class="variable">@Override</span></span><br><span class="line">    public Result follow(Long followUserId, Boolean isFollow) &#123;</span><br><span class="line">        Long userId = UserHolder.getUser().getId();</span><br><span class="line">        <span class="regexp">//</span><span class="number">1</span>.åˆ¤æ–­æ˜¯å…³æ³¨è¿˜æ˜¯å–å…³</span><br><span class="line">        <span class="keyword">if</span>(isFollow)&#123;</span><br><span class="line">            <span class="regexp">//</span><span class="number">2</span>.å…³æ³¨ï¼Œæ–°å¢æ•°æ®</span><br><span class="line">            Follow follow = new Follow();</span><br><span class="line">            follow.setUserId(userId);</span><br><span class="line">            follow.setFollowUserId(followUserId);</span><br><span class="line">            save(follow);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="regexp">//</span><span class="number">3</span>.å–å…³ï¼Œåˆ é™¤è®°å½•</span><br><span class="line">            remove(new QueryWrapper&lt;Follow&gt;()</span><br><span class="line">                    .e<span class="string">q(&quot;user_id&quot;, userId)</span>.e<span class="string">q(&quot;follow_user_id&quot;, followUserId)</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦å·²å…³æ³¨ç›®æ ‡ç”¨æˆ·</span><br><span class="line">    <span class="variable">@Override</span></span><br><span class="line">    public Result isFollow(Long followUserId) &#123;</span><br><span class="line">        Long userId = UserHolder.getUser().getId();</span><br><span class="line">        <span class="regexp">//</span><span class="number">1</span>.æŸ¥è¯¢æ˜¯å¦å…³æ³¨</span><br><span class="line">        Integer count = query().e<span class="string">q(&quot;user_id&quot;, userId)</span>.e<span class="string">q(&quot;follow_user_id&quot;, followUserId)</span>.count();</span><br><span class="line">        <span class="regexp">//</span><span class="number">2</span>.åˆ¤æ–­æ˜¯å¦å…³æ³¨</span><br><span class="line">        <span class="keyword">return</span> Result.ok(count&gt;<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>å…³æ³¨æ“ä½œ</strong>ï¼šé¦–å…ˆè·å–å½“å‰ç™»å½•çš„ <code>userId</code>ï¼Œç„¶åæ ¹æ® <code>followUserId</code> åˆ›å»ºä¸€ä¸ª <code>Follow</code> å®ä½“å¯¹è±¡ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚</li>
<li><strong>å–æ¶ˆå…³æ³¨æ“ä½œ</strong>ï¼šæ ¹æ®å½“å‰ç”¨æˆ·çš„ <code>userId</code> å’Œç›®æ ‡ç”¨æˆ·çš„ <code>followUserId</code> åˆ é™¤ <code>tb_follow</code> è¡¨ä¸­çš„è®°å½•ï¼Œè¡¨ç¤ºå–æ¶ˆå…³æ³¨ã€‚</li>
<li><strong>åˆ¤æ–­æ˜¯å¦å·²å…³æ³¨</strong></li>
<li><strong>isFollow æ–¹æ³•</strong>ï¼šè¯¥æ–¹æ³•é€šè¿‡æŸ¥è¯¢ <code>tb_follow</code> è¡¨æ¥åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç»å…³æ³¨æŸä¸ªç›®æ ‡ç”¨æˆ·ã€‚å¦‚æœå­˜åœ¨å¯¹åº”è®°å½•ï¼Œåˆ™è¿”å› <code>true</code>ï¼Œå¦åˆ™è¿”å› <code>false</code>ã€‚</li>
</ul>
<p>æµ‹è¯•ï¼šç‚¹å‡»å…³æ³¨æ˜¾ç¤ºå…³æ³¨æˆåŠŸï¼Œæ•°æ®åº“é‡Œä¼šæœ‰è®°å½•ã€‚å–æ¶ˆå…³æ³¨ååˆ é™¤æ¶ˆæ¯ã€‚</p>
<h3 id="9-2-å¥½å‹å…³æ³¨-å…±åŒå…³æ³¨">9.2 å¥½å‹å…³æ³¨-å…±åŒå…³æ³¨</h3>
<p>æƒ³è¦å»çœ‹å…±åŒå…³æ³¨çš„å¥½å‹ï¼Œéœ€è¦é¦–å…ˆè¿›å…¥åˆ°è¿™ä¸ªé¡µé¢ï¼Œè¿™ä¸ªé¡µé¢ä¼šå‘èµ·ä¸¤ä¸ªè¯·æ±‚</p>
<p>1ã€å»æŸ¥è¯¢ç”¨æˆ·çš„è¯¦æƒ…</p>
<p>2ã€å»æŸ¥è¯¢ç”¨æˆ·çš„ç¬”è®°</p>
<p>ä»¥ä¸Šä¸¤ä¸ªåŠŸèƒ½å’Œå…±åŒå…³æ³¨æ²¡æœ‰ä»€ä¹ˆå…³ç³»ï¼Œå¤§å®¶å¯ä»¥è‡ªè¡Œå°†ç¬”è®°ä¸­çš„ä»£ç æ‹·è´åˆ°ideaä¸­å°±å¯ä»¥å®ç°è¿™ä¸¤ä¸ªåŠŸèƒ½äº†ï¼Œæˆ‘ä»¬çš„é‡ç‚¹åœ¨äºå…±åŒå…³æ³¨åŠŸèƒ½ã€‚</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserController æ ¹æ®idæŸ¥è¯¢ç”¨æˆ·</span></span><br><span class="line"><span class="meta">@GetMapping(<span class="string">&quot;/&#123;id&#125;&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> Result queryUserById(<span class="meta">@PathVariable(<span class="string">&quot;id&quot;</span>)</span> <span class="built_in">Long</span> userId)&#123;</span><br><span class="line">	<span class="comment">// æŸ¥è¯¢è¯¦æƒ…</span></span><br><span class="line">	User user = userService.getById(userId);</span><br><span class="line">	<span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> Result.ok();</span><br><span class="line">	&#125;</span><br><span class="line">	UserDTO userDTO = BeanUtil.copyProperties(user, UserDTO.<span class="keyword">class</span>);</span><br><span class="line">	<span class="comment">// è¿”å›</span></span><br><span class="line">	<span class="keyword">return</span> Result.ok(userDTO);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BlogController  æ ¹æ®idæŸ¥è¯¢åšä¸»çš„æ¢åº—ç¬”è®°</span></span><br><span class="line"><span class="meta">@GetMapping(<span class="string">&quot;/of/user&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> Result queryBlogByUserId(</span><br><span class="line">		<span class="meta">@RequestParam(value = <span class="string">&quot;current&quot;</span>, defaultValue = <span class="string">&quot;1&quot;</span>)</span> Integer current,</span><br><span class="line">		<span class="meta">@RequestParam(<span class="string">&quot;id&quot;</span>)</span> <span class="built_in">Long</span> id) &#123;</span><br><span class="line">	<span class="comment">// æ ¹æ®ç”¨æˆ·æŸ¥è¯¢</span></span><br><span class="line">	Page&lt;Blog&gt; page = blogService.query()</span><br><span class="line">			.eq(<span class="string">&quot;user_id&quot;</span>, id).page(new Page&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));</span><br><span class="line">	<span class="comment">// è·å–å½“å‰é¡µæ•°æ®</span></span><br><span class="line">	List&lt;Blog&gt; records = page.getRecords();</span><br><span class="line">	<span class="keyword">return</span> Result.ok(records);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-304-1024x403.png" alt="img"></p>
<p>åŠŸèƒ½å®ç°çš„æ€è·¯æ˜¯ï¼š</p>
<ul>
<li><strong>å…³æ³¨æ“ä½œ</strong>ï¼šå½“ç”¨æˆ·å…³æ³¨å¦ä¸€ä¸ªç”¨æˆ·æ—¶ï¼Œä¸ä»…è¦åœ¨æ•°æ®åº“è¡¨ä¸­æ’å…¥è®°å½•ï¼Œè¿˜éœ€è¦å°†å…³æ³¨çš„ç”¨æˆ·IDå­˜å‚¨åœ¨Redisçš„ <code>Set</code> é›†åˆä¸­ã€‚</li>
<li><strong>å–æ¶ˆå…³æ³¨æ“ä½œ</strong>ï¼šå½“ç”¨æˆ·å–æ¶ˆå¯¹å¦ä¸€ä¸ªç”¨æˆ·çš„å…³æ³¨æ—¶ï¼Œé™¤äº†åˆ é™¤æ•°æ®åº“ä¸­çš„è®°å½•ï¼Œè¿˜éœ€è¦ä»Redisä¸­ç§»é™¤å¯¹åº”çš„ç”¨æˆ·IDã€‚</li>
<li><strong>å…±åŒå…³æ³¨æ“ä½œ</strong>ï¼šé€šè¿‡Redisçš„ <code>SINTER</code> å‘½ä»¤ï¼Œè·å–å½“å‰ç”¨æˆ·ä¸ç›®æ ‡ç”¨æˆ·å…³æ³¨çš„äº¤é›†ï¼Œè¿›è€ŒæŸ¥è¯¢è¿™äº›å…±åŒå…³æ³¨çš„ç”¨æˆ·ä¿¡æ¯ã€‚</li>
</ul>
<p>é¦–å…ˆè¦æ›´æ”¹FollowServiceImplä»£ç ä¸­çš„followæ–¹æ³•ï¼Œä¸»è¦åœ¨å…³æ³¨æ—¶æŠŠè¢«å…³æ³¨ç”¨æˆ·çš„idæ”¾å…¥redisï¼Œå–å…³æ—¶ä»redisä¸­ç§»é™¤idï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> IUserService userService;</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">FollowServiceImpl</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(Long followUserId, Boolean isFollow)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + userId;</span><br><span class="line">    <span class="comment">//1.åˆ¤æ–­æ˜¯å…³æ³¨è¿˜æ˜¯å–å…³</span></span><br><span class="line">    <span class="keyword">if</span>(isFollow)&#123;</span><br><span class="line">        <span class="comment">//2.å…³æ³¨ï¼Œæ–°å¢æ•°æ®</span></span><br><span class="line">        <span class="type">Follow</span> <span class="variable">follow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Follow</span>();</span><br><span class="line">        follow.setUserId(userId);</span><br><span class="line">        follow.setFollowUserId(followUserId);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(follow);</span><br><span class="line">        <span class="keyword">if</span>(isSuccess)&#123;</span><br><span class="line">            <span class="comment">//æŠŠå…³æ³¨ç”¨æˆ·çš„idæ”¾å…¥redisçš„seté›†åˆ</span></span><br><span class="line">            stringRedisTemplate.opsForSet().add(key,followUserId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//3.å–å…³ï¼Œåˆ é™¤è®°å½•</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> remove(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;Follow&gt;()</span><br><span class="line">                .eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId));</span><br><span class="line">        <span class="keyword">if</span>(isSuccess)&#123;</span><br><span class="line">            <span class="comment">//æŠŠå…³æ³¨ç”¨æˆ·çš„idä»Redisç§»é™¤</span></span><br><span class="line">            stringRedisTemplate.opsForSet().remove(key,followUserId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>å…³æ³¨æ“ä½œ</strong>ï¼šå½“ç”¨æˆ·å…³æ³¨æŸäººæ—¶ï¼Œæˆ‘ä»¬åœ¨æ•°æ®åº“ä¸­æ’å…¥å…³æ³¨è®°å½•ï¼Œå¹¶å°†è¢«å…³æ³¨ç”¨æˆ·çš„ <code>userId</code> å­˜å…¥ Redis çš„ <code>Set</code> é›†åˆã€‚</li>
<li><strong>å–æ¶ˆå…³æ³¨æ“ä½œ</strong>ï¼šå½“ç”¨æˆ·å–æ¶ˆå…³æ³¨æ—¶ï¼Œæˆ‘ä»¬ä»æ•°æ®åº“åˆ é™¤å¯¹åº”çš„å…³æ³¨è®°å½•ï¼Œå¹¶å°†è¯¥ç”¨æˆ·çš„ <code>userId</code> ä» Redis ä¸­çš„ <code>Set</code> é›†åˆç§»é™¤ã€‚</li>
</ul>
<p>ä¸‹é¢è¿›è¡Œç®€å•æµ‹è¯•ï¼Œå…³æ³¨æ—¶æ•°æ®å­˜å…¥redisæ²¡é—®é¢˜ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-305.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-306.png" alt="img"></p>
<p>ç‚¹å‡»å…±åŒå…³æ³¨æŠ¥é”™ï¼Œä½†å‘å‡ºäº†è¯·æ±‚ï¼ŒåŸå› æ˜¯è¿˜æ²¡ç¼–å†™æ–¹æ³•ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-307-1024x272.png" alt="img"></p>
<p>å¯ä»¥é€šè¿‡SINTERå‘½ä»¤æ±‚å‡ºäº¤é›†ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-308.png" alt="img"></p>
<p>åœ¨ <code>FollowController</code> ä¸­æ·»åŠ è·¯ç”±,åœ¨FollowControllerä¸­å†™å…¥ä¸‹é¢ä»£ç ï¼š</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@GetMapping</span>(<span class="string">&quot;/common/&#123;id&#125;&quot;</span>)</span><br><span class="line">public Result <span class="built_in">followCommons</span>(<span class="variable">@PathVariable</span>(<span class="string">&quot;id&quot;</span>) Long id)&#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">followService</span><span class="selector-class">.followCommons</span>(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>IFollowService</code> æ¥å£ä¸­å£°æ˜,åœ¨IFollowServiceä¸­å†™å…¥ä¸‹é¢ä»£ç ï¼š</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable"><span class="class">Result</span></span> <span class="function"><span class="title">followCommons</span>(<span class="variable">Long</span> <span class="variable">id</span>);</span></span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>FollowServiceImpl</code> ç±»ä¸­å®ç°,åœ¨FollowServiceImplç±»ä¸­å†™å…¥ä¸‹é¢ä»£ç ï¼š</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="keyword">public</span> Result followCommons(<span class="keyword">Long</span> id) &#123;</span><br><span class="line">    <span class="comment">//æ±‚çš„æ˜¯ç›®æ ‡ç”¨æˆ·å’Œå½“å‰ç”¨æˆ·å…³æ³¨çš„äº¤é›†</span></span><br><span class="line">    <span class="comment">//1.è·å–key</span></span><br><span class="line">    <span class="keyword">Long</span> userId = UserHolder.getUser().getId();</span><br><span class="line">    String key1 = <span class="string">&quot;follows:&quot;</span>+userId; <span class="comment">// å½“å‰ç”¨æˆ·å…³æ³¨çš„é›†åˆ</span></span><br><span class="line">    String key2 = <span class="string">&quot;follows:&quot;</span>+id; <span class="comment">// ç›®æ ‡ç”¨æˆ·å…³æ³¨çš„é›†åˆ</span></span><br><span class="line">    <span class="comment">//2.ä½¿ç”¨Redisçš„SINTERå‘½ä»¤æ±‚äº¤é›†</span></span><br><span class="line">    Set&lt;String&gt; <span class="keyword">intersect</span> = stringRedisTemplate.opsForSet().<span class="keyword">intersect</span>(key1, key2);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">intersect</span>==<span class="keyword">null</span>||<span class="keyword">intersect</span>.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3.è§£æidé›†åˆ,å°†äº¤é›†ä¸­çš„ç”¨æˆ·IDè½¬æ¢æˆLongç±»å‹</span></span><br><span class="line">    List&lt;<span class="keyword">Long</span>&gt; ids = <span class="keyword">intersect</span>.stream().map(<span class="keyword">Long</span>::valueOf).<span class="keyword">collect</span>(Collectors.<span class="keyword">toList</span>());</span><br><span class="line">    <span class="comment">//4. æŸ¥è¯¢å…±åŒå…³æ³¨çš„ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">    List&lt;UserDTO&gt; users = userService.listByIds(ids)</span><br><span class="line">            .stream()</span><br><span class="line">            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.<span class="keyword">class</span>))</span><br><span class="line">            .<span class="keyword">collect</span>(Collectors.<span class="keyword">toList</span>());</span><br><span class="line">    <span class="keyword">return</span> Result.ok(users);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è·å–å…±åŒå…³æ³¨ç”¨æˆ·</strong>ï¼šé¦–å…ˆï¼Œæˆ‘ä»¬è·å–å½“å‰ç”¨æˆ·å’Œç›®æ ‡ç”¨æˆ·çš„å…³æ³¨åˆ—è¡¨ï¼ˆå­˜å‚¨åœ¨ Redis çš„ <code>Set</code> é›†åˆä¸­ï¼‰ï¼Œç„¶åä½¿ç”¨ <code>SINTER</code> å‘½ä»¤è·å–å®ƒä»¬çš„äº¤é›†ï¼ˆå³å…±åŒå…³æ³¨çš„ç”¨æˆ·ï¼‰ã€‚æ¥ç€ï¼Œæˆ‘ä»¬å°†è¿™äº›ç”¨æˆ·IDæŸ¥è¯¢å‡ºæ¥ï¼Œå¹¶è¿”å›ç”¨æˆ·ä¿¡æ¯ã€‚</p>
<p>åƒæˆ‘ç°åœ¨å…³æ³¨çš„æ˜¯å°é±¼åŒå­¦å’Œå¯å¯ä»Šå¤©ä¸åƒè‚‰ã€‚æ¥ä¸‹æ¥æ¢å·ï¼Œæ¢æˆå°é±¼åŒå­¦ï¼Œç”µè¯ï¼š13686869696ï¼Œè®©å°é±¼åŒå­¦å…³æ³¨æˆ‘å’Œå¯å¯ä»Šå¤©ä¸åƒè‚‰ã€‚ä»¥å°é±¼åŒå­¦çš„è§†è§’æ¥æŸ¥çœ‹æˆ‘ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬å…±åŒå…³æ³¨äº†å¯å¯ä»Šå¤©ä¸åƒè‚‰ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-309.png" alt="img"></p>
<h3 id="9-3-å¥½å‹å…³æ³¨-Feedæµå®ç°æ–¹æ¡ˆ">9.3 å¥½å‹å…³æ³¨-Feedæµå®ç°æ–¹æ¡ˆ</h3>
<p><strong>Feedæµ</strong>ï¼Œå³åŠ¨æ€æ¶ˆæ¯æµï¼Œæ˜¯ç¤¾äº¤å¹³å°ç”¨æ¥ä¸ºç”¨æˆ·æŒç»­æä¾›å†…å®¹çš„ä¸€ç§æ–¹å¼ã€‚é€šè¿‡Feedæµï¼Œç”¨æˆ·èƒ½å¤Ÿæ— éœ€ä¸»åŠ¨æŸ¥æ‰¾ï¼Œç³»ç»Ÿè‡ªåŠ¨æ¨é€ç¬¦åˆå…¶å…´è¶£çš„å†…å®¹ï¼Œæä¾›æ›´åŠ æ²‰æµ¸å¼çš„ä½“éªŒã€‚å¸¸è§çš„ä¾‹å­æœ‰ç¤¾äº¤ç½‘ç»œçš„åŠ¨æ€æ—¶é—´çº¿ï¼ˆTimelineï¼‰ï¼Œä¾‹å¦‚Facebookã€Instagramã€Twitterç­‰ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-310.png" alt="img"></p>
<h4 id="Feedæµçš„ä¸¤ç§æ¨¡å¼ï¼š"><strong>Feedæµçš„ä¸¤ç§æ¨¡å¼ï¼š</strong></h4>
<ol>
<li>
<p>Timelineæ¨¡å¼</p>
<p>ï¼š</p>
<ul>
<li><strong>å®šä¹‰</strong>ï¼šä¸å¯¹å†…å®¹è¿›è¡Œç­›é€‰ï¼ŒæŒ‰å†…å®¹çš„å‘å¸ƒæ—¶é—´æ’åºï¼Œé€šå¸¸ç”¨äºå¥½å‹æˆ–å…³æ³¨çš„äººå‘å¸ƒçš„å†…å®¹ï¼Œä¾‹å¦‚ç¤¾äº¤å¹³å°çš„åŠ¨æ€ã€‚</li>
<li><strong>ä¼˜ç‚¹</strong>ï¼šä¿¡æ¯å…¨é¢ï¼Œä¸ä¼šç¼ºå¤±ä»»ä½•å†…å®¹ï¼›å®ç°è¾ƒä¸ºç®€å•ã€‚</li>
<li><strong>ç¼ºç‚¹</strong>ï¼šå¯èƒ½å­˜åœ¨ä¿¡æ¯å™ªéŸ³ï¼Œç”¨æˆ·æœªå¿…æ„Ÿå…´è¶£ï¼Œå¯¼è‡´å†…å®¹è·å–æ•ˆç‡ä½ã€‚</li>
</ul>
</li>
<li>
<p>æ™ºèƒ½æ’åº</p>
<p>ï¼š</p>
<ul>
<li><strong>å®šä¹‰</strong>ï¼šé€šè¿‡æ™ºèƒ½ç®—æ³•ç­›é€‰å‡ºç”¨æˆ·æ„Ÿå…´è¶£çš„å†…å®¹ï¼ŒåŒæ—¶å±è”½æ‰è¿è§„æˆ–ä¸æ„Ÿå…´è¶£çš„å†…å®¹ã€‚è¿™æ ·ï¼Œç³»ç»Ÿæ¨é€çš„å†…å®¹æ›´ç¬¦åˆç”¨æˆ·çš„åå¥½ã€‚</li>
<li><strong>ä¼˜ç‚¹</strong>ï¼šç”¨æˆ·èƒ½å¤Ÿè·å¾—æ›´ç¬¦åˆå…¶å…´è¶£çš„å†…å®¹ï¼Œå¢åŠ ç”¨æˆ·ç²˜æ€§ï¼Œå¯èƒ½è®©ç”¨æˆ·æ›´æ²‰æµ¸åœ¨å¹³å°å†…ã€‚</li>
<li><strong>ç¼ºç‚¹</strong>ï¼šå¦‚æœæ¨èç®—æ³•ä¸å‡†ç¡®ï¼Œå¯èƒ½ä¼šè¯¯æ¨é€ä¸ç›¸å…³æˆ–è®©ç”¨æˆ·ä¸æ»¡æ„çš„å†…å®¹ã€‚</li>
</ul>
</li>
</ol>
<p>æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ <strong>Timelineæ¨¡å¼</strong>ï¼Œå³åŸºäºç”¨æˆ·å…³æ³¨çš„å¥½å‹ä¿¡æ¯ï¼ŒæŒ‰ç…§æ—¶é—´é¡ºåºå±•ç¤ºå†…å®¹ã€‚</p>
<p>å› æ­¤é‡‡ç”¨Timelineçš„æ¨¡å¼ã€‚è¯¥æ¨¡å¼çš„å®ç°æ–¹æ¡ˆæœ‰ä¸‰ç§ï¼š</p>
<ul>
<li>æ‹‰æ¨¡å¼</li>
<li>æ¨æ¨¡å¼</li>
<li>æ¨æ‹‰ç»“åˆ</li>
</ul>
<p><strong>æ‹‰æ¨¡å¼</strong>ï¼šä¹Ÿå«åšè¯»æ‰©æ•£</p>
<p>è¯¥æ¨¡å¼çš„æ ¸å¿ƒå«ä¹‰å°±æ˜¯ï¼šå½“ç”¨æˆ·æƒ³æŸ¥çœ‹å¥½å‹çš„åŠ¨æ€æ—¶ï¼Œç³»ç»Ÿä¼šä»ç”¨æˆ·å…³æ³¨çš„å¥½å‹ä¸­æ‹‰å–æœ€æ–°çš„å†…å®¹ã€‚ç³»ç»Ÿä¼šæ ¹æ®ç”¨æˆ·å…³æ³¨çš„äººç¾¤ï¼Œæ‹‰å–è¿™äº›äººå‘å¸ƒçš„ä¿¡æ¯ï¼Œå¹¶è¿›è¡Œæ’åºã€‚</p>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li><strong>èŠ‚çº¦ç©ºé—´</strong>ï¼šæ•°æ®ä»…åœ¨ç”¨æˆ·éœ€è¦æ—¶æ‰è¿›è¡Œè¯»å–ï¼Œå‡å°‘äº†é‡å¤å­˜å‚¨ã€‚</li>
<li>ç”¨æˆ·è¯»å–å®Œä¿¡æ¯åï¼Œå¯ä»¥æ¸…ç©ºæ”¶ä»¶ç®±ï¼Œé¿å…å­˜å‚¨å¤§é‡æœªè¯»æ•°æ®ã€‚</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li><strong>å»¶è¿Ÿæ€§</strong>ï¼šç”¨æˆ·åœ¨è¯»å–ä¿¡æ¯æ—¶æ‰ä¼šå»æ‹‰å–ï¼Œè‹¥ç”¨æˆ·å…³æ³¨äº†å¤§é‡çš„äººï¼Œç³»ç»Ÿå¯èƒ½éœ€è¦ä¸€æ¬¡æ€§æ‹‰å–å¤§é‡çš„å†…å®¹ï¼Œå¢åŠ æœåŠ¡å™¨è´Ÿæ‹…ã€‚</li>
<li>åœ¨æ•°æ®é‡å¤§æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´å»¶æ—¶è¾ƒé«˜ã€‚</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-311-1024x443.png" alt="img"></p>
<p><strong>æ¨æ¨¡å¼</strong>ï¼šä¹Ÿå«åšå†™æ‰©æ•£ã€‚</p>
<p>å½“ç”¨æˆ·ï¼ˆå¦‚åšä¸»ï¼‰å‘å¸ƒæ–°çš„å†…å®¹æ—¶ï¼Œç³»ç»Ÿä¼šä¸»åŠ¨å°†å†…å®¹æ¨é€åˆ°å…³æ³¨ä»–çš„ç²‰ä¸çš„æ”¶ä»¶ç®±ä¸­ã€‚è¿™é¿å…äº†ç”¨æˆ·æ¯æ¬¡éƒ½è¦å»æ‹‰å–æ•°æ®ã€‚</p>
<p>ä¼˜ç‚¹ï¼šæ—¶æ•ˆå¿«ï¼Œä¸ç”¨ä¸´æ—¶æ‹‰å–</p>
<p>ç¼ºç‚¹ï¼šå†…å­˜å‹åŠ›å¤§ï¼Œå‡è®¾ä¸€ä¸ªå¤§Vå†™ä¿¡æ¯ï¼Œå¾ˆå¤šäººå…³æ³¨ä»–ï¼Œ å°±ä¼šå†™å¾ˆå¤šåˆ†æ•°æ®åˆ°ç²‰ä¸é‚£è¾¹å»</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-312.png" alt="img"></p>
<p><strong>æ¨æ‹‰ç»“åˆæ¨¡å¼</strong>ï¼šä¹Ÿå«åšè¯»å†™æ··åˆï¼Œå…¼å…·æ¨å’Œæ‹‰ä¸¤ç§æ¨¡å¼çš„ä¼˜ç‚¹ã€‚</p>
<p>æ¨æ‹‰æ¨¡å¼æ˜¯ä¸€ä¸ªæŠ˜ä¸­çš„æ–¹æ¡ˆ</p>
<ul>
<li><strong>æ™®é€šç”¨æˆ·</strong>ï¼šæ™®é€šç”¨æˆ·å‘å¸ƒçš„å†…å®¹ä¼šç›´æ¥æ¨é€åˆ°å…¶ç²‰ä¸çš„æ”¶ä»¶ç®±ä¸­ã€‚</li>
<li><strong>å¤§Vç”¨æˆ·</strong>ï¼šå¯¹äºå¤§Vï¼Œç³»ç»Ÿä¼šå…ˆå°†å…¶å†…å®¹å†™å…¥åˆ°å‘ä»¶ç®±ï¼Œå†å°†å†…å®¹æ¨é€åˆ°æ´»è·ƒç²‰ä¸çš„æ”¶ä»¶ç®±ä¸­ï¼›å¯¹äºä¸æ´»è·ƒçš„ç²‰ä¸ï¼Œå†…å®¹ä¼šå­˜å…¥å‘ä»¶ç®±ï¼Œç­‰ä»–ä»¬ä¸Šçº¿æ—¶å†æ‹‰å–ã€‚</li>
</ul>
<p><strong>ä¼˜ç‚¹</strong>ï¼š</p>
<ul>
<li><strong>æŠ˜ä¸­æ–¹æ¡ˆ</strong>ï¼šæ—¢æœ‰æ¨é€çš„å®æ—¶æ€§ï¼Œåˆèƒ½é¿å…å¤§Vè´¦å·äº§ç”Ÿè¿‡å¤§å†…å­˜å‹åŠ›ã€‚</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-313-1024x454.png" alt="img"></p>
<h3 id="9-4-å¥½å‹å…³æ³¨-æ¨é€åˆ°ç²‰ä¸æ”¶ä»¶ç®±">9.4 å¥½å‹å…³æ³¨-æ¨é€åˆ°ç²‰ä¸æ”¶ä»¶ç®±</h3>
<p>éœ€æ±‚ï¼š</p>
<ul>
<li>ä¿®æ”¹æ–°å¢æ¢åº—ç¬”è®°çš„ä¸šåŠ¡ï¼Œåœ¨ä¿å­˜blogåˆ°æ•°æ®åº“çš„åŒæ—¶ï¼Œæ¨é€åˆ°ç²‰ä¸çš„æ”¶ä»¶ç®±</li>
<li>æ”¶ä»¶ç®±æ»¡è¶³å¯ä»¥æ ¹æ®æ—¶é—´æˆ³æ’åºï¼Œå¿…é¡»ç”¨Redisçš„æ•°æ®ç»“æ„å®ç°</li>
<li>æŸ¥è¯¢æ”¶ä»¶ç®±æ•°æ®æ—¶ï¼Œå¯ä»¥å®ç°åˆ†é¡µæŸ¥è¯¢</li>
</ul>
<p>Feedæµä¸­çš„æ•°æ®ä¼šä¸æ–­æ›´æ–°ï¼Œæ‰€ä»¥æ•°æ®çš„è§’æ ‡ä¹Ÿåœ¨å˜åŒ–ï¼Œå› æ­¤ä¸èƒ½é‡‡ç”¨ä¼ ç»Ÿçš„åˆ†é¡µæ¨¡å¼ã€‚</p>
<p>ä¼ ç»Ÿäº†åˆ†é¡µåœ¨feedæµæ˜¯ä¸é€‚ç”¨çš„ï¼Œå› ä¸ºæˆ‘ä»¬çš„æ•°æ®ä¼šéšæ—¶å‘ç”Ÿå˜åŒ–</p>
<p>æƒ…æ™¯è§£é‡Š</p>
<ul>
<li>å‡è®¾ä½ é¦–å…ˆè¯·æ±‚äº†åŠ¨æ€çš„ç¬¬ä¸€é¡µï¼ˆ<code>page=1</code>ï¼Œæ¯é¡µ5æ¡æ•°æ®ï¼‰ï¼Œç„¶åä½ ä¼šå¾—åˆ°ç±»ä¼¼10ã€11ã€12ã€13ã€14è¿™æ ·çš„æ•°æ®ã€‚</li>
<li>æ¥ç€ä½ è¯·æ±‚ç¬¬äºŒé¡µï¼ˆ<code>page=2</code>ï¼‰ï¼Œä½ ä¼šæœŸæœ›å¾—åˆ°æ¥ä¸‹æ¥çš„æ•°æ®ï¼ˆä¾‹å¦‚15ã€16ã€17ç­‰ï¼‰ã€‚</li>
<li>ç„¶è€Œï¼Œå¦‚æœåœ¨ä½ è¯·æ±‚æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼ŒåŠ¨æ€æµï¼ˆfeedï¼‰æœ‰æ–°å†…å®¹å‘å¸ƒï¼Œé‚£ä¹ˆä½ çš„è¯·æ±‚å°±å¯èƒ½ä¼šè·å–åˆ°ä¸ä¸€è‡´çš„æ•°æ®ã€‚</li>
</ul>
<p><strong>æ½œåœ¨é—®é¢˜</strong>ï¼š</p>
<ul>
<li>å¦‚æœç¬¬ä¸€é¡µçš„æ•°æ®æ˜¯åœ¨<code>t1</code>æ—¶åˆ»è¯·æ±‚çš„ï¼Œè€Œæ–°æ•°æ®ï¼ˆæ¯”å¦‚â€œFeed: 11â€ï¼‰æ˜¯åœ¨<code>t3</code>æ—¶åˆ»å‘å¸ƒçš„ï¼Œé‚£ä¹ˆç¬¬äºŒé¡µè·å–çš„æ•°æ®å¯èƒ½ä¼šå’Œç¬¬ä¸€é¡µé‡å ã€‚</li>
<li>è¿™ä¼šå¯¼è‡´åˆ†é¡µæ•°æ®çš„é‡å¤æˆ–è€…é”™ä¹±ï¼Œå› ä¸ºFeedåœ¨æ›´æ–°æ—¶ï¼Œæ•°æ®ä¼šå‘ç”Ÿå˜åŒ–ã€‚</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-314-1024x454.png" alt="img"></p>
<p>Feedæµçš„æ»šåŠ¨åˆ†é¡µ</p>
<ul>
<li>è¿™é‡Œæå‡ºçš„è§£å†³æ–¹æ³•æ˜¯è®°å½•æ¯æ¬¡è¯·æ±‚çš„æœ€åä¸€ä¸ªæ•°æ®IDï¼ˆ<code>lastId</code>ï¼‰ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿æ¯æ¬¡åˆ†é¡µè¯·æ±‚éƒ½çŸ¥é“ä»å“ªé‡Œå¼€å§‹è·å–æ•°æ®ã€‚</li>
<li>æ¯”å¦‚ï¼Œå¦‚æœä½ å·²ç»è·å–åˆ°çš„æœ€åä¸€ä¸ªIDæ˜¯<code>6</code>ï¼Œé‚£ä¹ˆç¬¬äºŒé¡µçš„æ•°æ®åº”è¯¥ä»IDä¸º<code>6</code>çš„ä¸‹ä¸€æ¡æ•°æ®å¼€å§‹ï¼Œè¿™æ ·å¯ä»¥é¿å…é‡å¤è·å–å·²è¯»è¿‡çš„æ•°æ®ã€‚</li>
</ul>
<p>ä¸¾ä¸ªä¾‹å­ï¼šæˆ‘æ¯æ¬¡è¯·æ±‚æ—¶ï¼Œä¿å­˜å½“å‰æœ€åè¯»å–çš„æ•°æ®IDã€‚</p>
<p>å½“è¯·æ±‚ä¸‹ä¸€é¡µæ—¶ï¼Œé€šè¿‡<code>lastId</code>æ¥ç¡®è®¤ä»å“ªé‡Œç»§ç»­è¯»å–æ•°æ®ï¼Œç¡®ä¿ä¸ä¼šé‡å¤æˆ–è€…é—æ¼ã€‚</p>
<p>è¿™ç§æ–¹å¼ç¡®ä¿äº†åˆ†é¡µçš„æ•°æ®ä¸ä¼šå—åŠ¨æ€æµä¸­é—´æ›´æ–°çš„å½±å“ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-315-1024x536.png" alt="img"></p>
<p>æ ¸å¿ƒçš„æ„æ€ï¼šå°±æ˜¯æˆ‘ä»¬åœ¨ä¿å­˜å®Œæ¢åº—ç¬”è®°åï¼Œè·å¾—åˆ°å½“å‰ç¬”è®°çš„ç²‰ä¸ï¼Œç„¶åæŠŠæ•°æ®æ¨é€åˆ°ç²‰ä¸çš„redisä¸­å»ã€‚</p>
<p>åœ¨BlogControlleré‡Œé¢å†™å…¥å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">saveBlog</span><span class="params">(<span class="meta">@RequestBody</span> Blog blog)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">    blog.setUserId(user.getId());</span><br><span class="line">    <span class="comment">// ä¿å­˜æ¢åº—åšæ–‡</span></span><br><span class="line">    blogService.saveBlog(blog);</span><br><span class="line">    <span class="comment">// è¿”å›id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(blog.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨IBlogServiceæ¥å£é‡Œé¢å†™å…¥å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable"><span class="class">Result</span></span> <span class="function"><span class="title">saveBlog</span>(<span class="variable">Blog</span> <span class="variable">blog</span>);</span></span><br></pre></td></tr></table></figure>
<p>åœ¨BlogServiceImplç±»ä¸­å†™å…¥å¦‚ä¸‹ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">saveBlog</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">    <span class="comment">//1.è·å–ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">    blog.setUserId(user.getId());</span><br><span class="line">    <span class="comment">//2.ä¿å­˜æ¢åº—ç¬”è®°</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(blog);</span><br><span class="line">    <span class="keyword">if</span>(!isSuccess)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;æ–°å¢ç¬”è®°å¤±è´¥ï¼&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3.æŸ¥è¯¢ç¬”è®°ä½œä¸šçš„æ‰€æœ‰ç²‰ä¸</span></span><br><span class="line">    <span class="comment">//select * from tb_follow where follow_user_id = ?</span></span><br><span class="line">    List&lt;Follow&gt; follows = followService.query().eq(<span class="string">&quot;follow_user_id&quot;</span>, user.getId()).list();</span><br><span class="line">    <span class="comment">//4.æ¨é€ç¬”è®°idç»™ç²‰ä¸</span></span><br><span class="line">    <span class="keyword">for</span>(Follow follow : follows)&#123;</span><br><span class="line">        <span class="comment">//4.1.è·å–ç²‰ä¸id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> follow.getUserId();</span><br><span class="line">        <span class="comment">//4.2.æ¨é€åˆ°ç²‰ä¸æ”¶ä»¶ç®±æ˜¯sortedSet</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;feed::&quot;</span>+userId;</span><br><span class="line">        stringRedisTemplate.opsForZSet().add(key,blog.getId().toString(),System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿”å›id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(blog.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="9-5å¥½å‹å…³æ³¨-å®ç°åˆ†é¡µæŸ¥è¯¢æ”¶é‚®ç®±çš„æ€è·¯">9.5å¥½å‹å…³æ³¨-å®ç°åˆ†é¡µæŸ¥è¯¢æ”¶é‚®ç®±çš„æ€è·¯</h3>
<p>ZRANGEæ˜¯æŒ‰ç…§è§’æ ‡ä»å°åˆ°å¤§æ’åºï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-316.png" alt="img"></p>
<p>è¿™ä¸ªå‘½ä»¤è¿”å›ä¸€ä¸ªæœ‰åºé›†åˆä¸­æˆå‘˜çš„èŒƒå›´ï¼Œå¯ä»¥æ ¹æ®ç»™å®šçš„æœ€å°å€¼å’Œæœ€å¤§å€¼æ¥é™åˆ¶è¿”å›çš„å…ƒç´ ã€‚</p>
<p>ZREVRANGEæ˜¯æŒ‰ç…§è§’æ ‡ä»å¤§åˆ°å°æ’åºï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-317.png" alt="img"></p>
<p>è¿™ä¸ªå‘½ä»¤ä¸ <code>ZRANGE</code> ç±»ä¼¼ï¼Œä¸è¿‡å®ƒæ˜¯å€’åºè¿”å›é›†åˆä¸­çš„å…ƒç´ ã€‚</p>
<p>ZREVRANGEBYSCOREæ˜¯æŒ‰ç…§åˆ†æ•°ä»å¤§åˆ°å°æ’åºï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-318.png" alt="img"></p>
<p>è¿™ä¸ªå‘½ä»¤æ ¹æ®åˆ†æ•°è¿›è¡Œè¿‡æ»¤ï¼Œè¿”å›åˆ†æ•°èŒƒå›´å†…çš„æˆå‘˜ï¼Œé€šå¸¸ç”¨æ¥å¤„ç†æ—¶é—´çº¿æˆ–è€…æ’åä¹‹ç±»çš„æ•°æ®ã€‚</p>
<p>æ»šåŠ¨æŸ¥è¯¢ï¼šæ¯æ¬¡åˆ†é¡µæŸ¥è¯¢éƒ½ä¼šè·å–ä¸Šä¸€æ¬¡æŸ¥è¯¢è¿”å›çš„æœ€å°å€¼ï¼Œå¹¶å°†å…¶ä½œä¸ºä¸‹ä¸€æ¬¡æŸ¥è¯¢çš„æœ€å¤§å€¼ã€‚è¿™æ ·ç¡®ä¿æ¯æ¬¡æŸ¥è¯¢è¿”å›çš„æ•°æ®æ˜¯è¿ç»­çš„ï¼Œä¸ä¼šé‡å¤æˆ–è€…é—æ¼ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-319.png" alt="img"></p>
<p>ä¾‹å¦‚ï¼Œå½“ä½ ä½¿ç”¨ <code>ZRANGE</code> æˆ– <code>ZREVRANGE</code> è¿›è¡Œåˆ†é¡µæŸ¥è¯¢æ—¶ï¼Œä½ å¯ä»¥è®¾ç½® <code>LIMIT</code> å‚æ•°æ¥é™åˆ¶è¿”å›çš„ç»“æœæ•°é‡ã€‚ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ—¶ï¼Œä½ ä¼šä»ç¬¬ä¸€ä¸ªæˆå‘˜å¼€å§‹ï¼Œåç»­æ¯æ¬¡æŸ¥è¯¢ä¼šæ ¹æ®ä¸Šä¸€æ¬¡æŸ¥è¯¢çš„ç»“æœæ¥è°ƒæ•´å¼€å§‹çš„åœ°æ–¹ã€‚</p>
<p>è§„å¾‹ï¼šåˆ†æ•°æœ€å°å€¼å’ŒæŸ¥çš„æ•°é‡å›ºå®šä¸å˜ã€‚æœ€å¤§å€¼ä¸ºä¸Šä¸€æ¬¡æŸ¥è¯¢çš„æœ€å°å€¼ã€åç§»é‡ç¬¬1æ¬¡ç»™0ï¼Œç¬¬1æ¬¡åç»™åœ¨ä¸Šä¸€æ¬¡çš„ç»“æœä¸­ï¼Œä¸æœ€å°å€¼ä¸€æ ·çš„å…ƒç´ çš„ä¸ªæ•°ã€‚</p>
<p>å½“åˆ†æ•°ä¸€è‡´å‡ºç°é—®é¢˜ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-320.png" alt="img"></p>
<ul>
<li>åˆ†æ•°ç›¸åŒçš„æˆå‘˜å°†è¢«è§†ä¸ºå…·æœ‰ç›¸åŒçš„é¡ºåºã€‚</li>
<li>å½“åˆ†æ•°ç›¸åŒçš„æˆå‘˜å‡ºç°åœ¨ä¸¤æ¬¡åˆ†é¡µæŸ¥è¯¢çš„ç»“æœä¸­æ—¶ï¼Œå®ƒä»¬ä¼šæŒ‰ç…§ç¬¬ä¸€æ¬¡æŸ¥è¯¢çš„ç»“æœé¡ºåºè¢«è¿”å›ã€‚</li>
<li>æ¯”å¦‚ï¼Œå½“ç¬¬ä¸€æ¬¡æŸ¥è¯¢è¿”å›åˆ†æ•°ä¸º 6 çš„æˆå‘˜æ—¶ï¼Œç¬¬äºŒæ¬¡æŸ¥è¯¢ä¼šç»§ç»­è¿”å›åˆ†æ•°ä¸º 6 çš„æˆå‘˜ï¼Œè¿™æ ·ä¿è¯äº†åˆ†é¡µçš„è¿ç»­æ€§ã€‚</li>
</ul>
<p>å¦‚æœ <code>z1</code> é›†åˆä¸­æœ‰å‡ ä¸ªåˆ†æ•°ä¸º <code>6</code> çš„å…ƒç´ ï¼Œç¬¬ä¸€æ¬¡æŸ¥è¯¢è¿”å›äº†è¿™äº›å…ƒç´ åï¼Œä¸‹ä¸€æ¬¡æŸ¥è¯¢ä¼šä»ä¸Šä¸€æ¬¡æŸ¥è¯¢çš„ç»“æœç»§ç»­è·å–æ•°æ®ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-321.png" alt="img"></p>
<h3 id="9-6å¥½å‹å…³æ³¨-å®ç°æ»šåŠ¨åˆ†é¡µæŸ¥è¯¢">9.6å¥½å‹å…³æ³¨-å®ç°æ»šåŠ¨åˆ†é¡µæŸ¥è¯¢</h3>
<p>éœ€æ±‚ï¼šåœ¨å®ç°<strong>æ»šåŠ¨åˆ†é¡µæŸ¥è¯¢</strong>æ—¶ï¼Œç›®çš„æ˜¯åœ¨ç”¨æˆ·çš„ä¸ªäººä¸»é¡µå±•ç¤ºä»–ä»¬å…³æ³¨çš„åšå®¢å†…å®¹ã€‚æ¯æ¬¡æŸ¥è¯¢è¿”å›ä¸€å®šæ•°é‡çš„æ•°æ®ï¼ŒåŒæ—¶å°†æœ€å°æ—¶é—´æˆ³å’Œåç§»é‡ä½œä¸ºæŸ¥è¯¢æ¡ä»¶ä¼ é€’ç»™ä¸‹ä¸€æ¬¡æŸ¥è¯¢ã€‚</p>
<p>å…·ä½“æ“ä½œå¦‚ä¸‹ï¼š</p>
<p>1.<strong>è·å–æœ€å°æ—¶é—´æˆ³</strong>ï¼šæ¯æ¬¡æŸ¥è¯¢ç»“æŸåï¼Œåˆ†æå‡ºè¿”å›æ•°æ®ä¸­çš„æœ€å°æ—¶é—´æˆ³ï¼Œè¿™ä¸ªæ—¶é—´æˆ³å°†ä½œä¸ºä¸‹ä¸€æ¬¡æŸ¥è¯¢çš„æ¡ä»¶ï¼Œç”¨äºè·å–æ¯”å½“å‰æŸ¥è¯¢æ—¶é—´æ›´æ–°çš„åšå®¢ã€‚</p>
<p>2.<strong>è®¡ç®—åç§»é‡</strong>ï¼šåç§»é‡æ˜¯ä¸Šæ¬¡æŸ¥è¯¢ä¸­è¿”å›çš„æ•°æ®æ¡ç›®æ•°ï¼Œç›®çš„æ˜¯è·³è¿‡å·²ç»æŸ¥è¯¢è¿‡çš„æ•°æ®ï¼Œä»è€Œç¡®ä¿æ¯æ¬¡æŸ¥è¯¢éƒ½èƒ½è·å–æ–°çš„æ•°æ®ã€‚</p>
<p>3.<strong>è¯·æ±‚å‚æ•°</strong>ï¼šæ¯æ¬¡è¯·æ±‚æ—¶éœ€è¦æºå¸¦ <code>lastId</code>ï¼ˆå³ä¸Šä¸€æ¬¡æŸ¥è¯¢çš„æœ€å°æ—¶é—´æˆ³ï¼‰å’Œ <code>offset</code>ï¼ˆå³åç§»é‡ï¼‰è¿™ä¸¤ä¸ªå‚æ•°ã€‚ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ—¶ï¼Œå‰ç«¯ä¼šæŒ‡å®šè¿™ä¸¤ä¸ªå‚æ•°ï¼Œä¹‹åçš„æŸ¥è¯¢ç”±åå°æ ¹æ®ä¸Šä¸€æ¬¡çš„æŸ¥è¯¢ç»“æœè¿›è¡Œä¼ é€’ã€‚</p>
<p>ç»¼ä¸Šï¼šæˆ‘ä»¬çš„è¯·æ±‚å‚æ•°ä¸­å°±éœ€è¦æºå¸¦ lastIdï¼šä¸Šä¸€æ¬¡æŸ¥è¯¢çš„æœ€å°æ—¶é—´æˆ³ å’Œåç§»é‡è¿™ä¸¤ä¸ªå‚æ•°ã€‚</p>
<p>è¿™ä¸¤ä¸ªå‚æ•°ç¬¬ä¸€æ¬¡ä¼šç”±å‰ç«¯æ¥æŒ‡å®šï¼Œä»¥åçš„æŸ¥è¯¢å°±æ ¹æ®åå°ç»“æœä½œä¸ºæ¡ä»¶ï¼Œå†æ¬¡ä¼ é€’åˆ°åå°ã€‚</p>
<p>é¦–å…ˆå®šä¹‰å‡ºæ¥å…·ä½“çš„è¿”å›å€¼å®ä½“ç±»</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScrollResult</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">List</span>&lt;<span class="string">?&gt;</span> list;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Long</span> minTime;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> offset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ScrollResult</code> ç±»ç”¨äºå°è£…æŸ¥è¯¢ç»“æœï¼ŒåŒ…å«ä¸‰ä¸ªå­—æ®µï¼š</p>
<ul>
<li><code>list</code>ï¼šå­˜å‚¨æŸ¥è¯¢åˆ°çš„åšå®¢åˆ—è¡¨ã€‚</li>
<li><code>minTime</code>ï¼šæœ¬æ¬¡æŸ¥è¯¢è¿”å›æ•°æ®ä¸­çš„æœ€å°æ—¶é—´æˆ³ï¼Œç”¨äºä¸‹ä¸€æ¬¡æŸ¥è¯¢çš„æ¡ä»¶ã€‚</li>
<li><code>offset</code>ï¼šåç§»é‡ï¼Œè¡¨ç¤ºè¿™æ¬¡æŸ¥è¯¢è¿”å›çš„æ•°æ®æ•°é‡ï¼Œä¸‹ä¸€æ¬¡æŸ¥è¯¢éœ€è¦è·³è¿‡è¿™äº›æ•°æ®ã€‚</li>
</ul>
<p>åœ¨BlogControllerä¸­å†™å…¥ä¸‹é¢ä»£ç ï¼š</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@GetMapping</span>(<span class="string">&quot;/of/follow&quot;</span>)</span><br><span class="line">public Result <span class="built_in">queryBlogOfFollow</span>(<span class="variable">@RequestParam</span>(<span class="string">&quot;lastId&quot;</span>) Long max,<span class="variable">@RequestParam</span>(value = <span class="string">&quot;offset&quot;</span>,defaultValue = <span class="string">&quot;0&quot;</span>) Integer offset) &#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">blogService</span><span class="selector-class">.queryBlogOfFollow</span>(max,offset);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥å£æ¥æ”¶ä¸¤ä¸ªè¯·æ±‚å‚æ•°ï¼š</p>
<ul>
<li><code>lastId</code>ï¼šä¸Šæ¬¡æŸ¥è¯¢çš„æœ€å°æ—¶é—´æˆ³ã€‚</li>
<li><code>offset</code>ï¼šæœ¬æ¬¡æŸ¥è¯¢çš„åç§»é‡ï¼Œé»˜è®¤å€¼ä¸º 0ã€‚</li>
</ul>
<p>åœ¨IBlogServiceå†™å…¥å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Result</span> queryBlogOfFollow(Long max, <span class="type">Integer</span> <span class="keyword">offset</span>);</span><br></pre></td></tr></table></figure>
<p>åœ¨BlogServiceImplä¸­å†™å…¥å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Result queryB<span class="keyword">log</span>OfFollow(Long <span class="keyword">max</span>, Integer offset) &#123;</span><br><span class="line">    //<span class="number">1</span>.è·å–å½“å‰ç”¨æˆ·</span><br><span class="line">    Long <span class="keyword">user</span>Id = UserHolder.getUser().getId();</span><br><span class="line">    //<span class="number">2</span>.æŸ¥è¯¢æ”¶ä»¶ç®± ZREVRANGEBYSCORE key Max M<span class="keyword">in</span> LIMIT offset count</span><br><span class="line">    String key = FEED_KEY+<span class="keyword">user</span>Id;</span><br><span class="line">    Set<span class="variable">&lt;ZSetOperations.TypedTuple&lt;String&gt;</span>&gt; typedTuples = stringRedisTemplate.opsForZSet()</span><br><span class="line">            .reverseRangeByScoreWithScores(key, <span class="number">0</span>, <span class="keyword">max</span>, offset, <span class="number">3</span>);</span><br><span class="line">    //<span class="number">2.1</span>.éç©ºåˆ¤æ–­</span><br><span class="line">    if(typedTuples==null || typedTuples.isEmpty())&#123;</span><br><span class="line">        return Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">    //<span class="number">3</span>.è§£ææ•°æ®ï¼šblogIdã€<span class="keyword">min</span>Time(æ—¶é—´æˆ³)ã€offset</span><br><span class="line">    List<span class="variable">&lt;Long&gt;</span> ids = new ArrayList<span class="variable">&lt;&gt;</span>(typedTuples.size());</span><br><span class="line">    long <span class="keyword">min</span>Time = <span class="number">0</span>;</span><br><span class="line">    int <span class="keyword">os</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(ZSetOperations.TypedTuple<span class="variable">&lt;String&gt;</span> tuple:typedTuples)&#123;</span><br><span class="line">        //<span class="number">4.1</span>.è·å–id</span><br><span class="line">        String idStr = tuple.getValue();</span><br><span class="line">        ids.add(Long.valueOf(idStr));</span><br><span class="line">        //<span class="number">4.2</span>.è·å–åˆ†æ•°</span><br><span class="line">        long time = tuple.getScore().longValue();</span><br><span class="line">        if(time == <span class="keyword">min</span>Time)&#123;</span><br><span class="line">            <span class="keyword">os</span>++;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            <span class="keyword">min</span>Time = time;</span><br><span class="line">            <span class="keyword">os</span>=<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //<span class="number">4</span>.æ ¹æ®idæŸ¥è¯¢blog</span><br><span class="line">    String idStr = StrUtil.join(<span class="string">&quot;,&quot;</span>,ids);</span><br><span class="line">    List<span class="variable">&lt;Blog&gt;</span> blogs = query().<span class="keyword">in</span>(<span class="string">&quot;id&quot;</span>,ids).last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span>+idStr+<span class="string">&quot;)&quot;</span>).list();</span><br><span class="line">    <span class="keyword">for</span> (B<span class="keyword">log</span> blog : blogs) &#123;</span><br><span class="line">        isB<span class="keyword">log</span>Liked(blog);</span><br><span class="line">        User <span class="keyword">user</span> = <span class="keyword">user</span>Service.getById(blog.getUserId());</span><br><span class="line">        blog.<span class="built_in">set</span>Name(<span class="keyword">user</span>.getNickName());</span><br><span class="line">        blog.<span class="built_in">set</span>Icon(<span class="keyword">user</span>.getIcon());</span><br><span class="line">    &#125;</span><br><span class="line">    //<span class="number">5</span>.å°è£…å¹¶è¿”å›</span><br><span class="line">    ScrollResult r = new ScrollResult();</span><br><span class="line">    r.<span class="built_in">set</span>List(blogs);</span><br><span class="line">    r.<span class="built_in">set</span>Offset(<span class="keyword">os</span>);</span><br><span class="line">    r.<span class="built_in">set</span>M<span class="keyword">in</span>Time(<span class="keyword">min</span>Time);</span><br><span class="line">    return Result.ok(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è·å–å½“å‰ç”¨æˆ·</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨ <code>UserHolder.getUser().getId()</code> è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„ IDã€‚</li>
</ul>
<p><strong>æŸ¥è¯¢åŠ¨æ€æµ</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨ Redis çš„ <code>reverseRangeByScoreWithScores</code> å‘½ä»¤æŒ‰æ—¶é—´æˆ³å€’åºè·å–åŠ¨æ€æµä¸­çš„åšå®¢ IDã€‚æŸ¥è¯¢èŒƒå›´æ˜¯ä»æ—¶é—´æˆ³ 0 åˆ° <code>max</code>ï¼ˆå³ä¸Šæ¬¡æŸ¥è¯¢çš„æœ€å°æ—¶é—´æˆ³ï¼‰ï¼Œåç§»é‡ä¸º <code>offset</code>ï¼Œæ¯æ¬¡æŸ¥è¯¢ 3 æ¡æ•°æ®ã€‚</li>
</ul>
<p><strong>å¤„ç†æŸ¥è¯¢ç»“æœ</strong>ï¼š</p>
<ul>
<li>éå†æŸ¥è¯¢ç»“æœï¼Œæå–å‡ºåšå®¢çš„ ID å’Œæ—¶é—´æˆ³ã€‚æ ¹æ®æ—¶é—´æˆ³åˆ¤æ–­æ˜¯å¦ä¸ä¸Šä¸€æ¬¡çš„æœ€å°æ—¶é—´æˆ³ç›¸åŒï¼Œè‹¥ç›¸åŒï¼Œåˆ™åç§»é‡åŠ  1ï¼Œè‹¥ä¸åŒï¼Œåˆ™æ›´æ–°æœ€å°æ—¶é—´æˆ³å¹¶é‡ç½®åç§»é‡ã€‚</li>
</ul>
<p><strong>æŸ¥è¯¢åšå®¢ä¿¡æ¯</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨ <code>query().in(&quot;id&quot;, ids)</code> æ ¹æ®æŸ¥è¯¢åˆ°çš„åšå®¢ ID æŸ¥è¯¢åšå®¢è¯¦ç»†ä¿¡æ¯ï¼Œä½¿ç”¨ <code>ORDER BY FIELD</code> ç¡®ä¿è¿”å›çš„åšå®¢é¡ºåºä¸ ID åˆ—è¡¨ä¸€è‡´ã€‚</li>
</ul>
<p><strong>è¿”å›ç»“æœ</strong>ï¼š</p>
<ul>
<li>å°†æŸ¥è¯¢åˆ°çš„åšå®¢ä¿¡æ¯ã€æœ€å°æ—¶é—´æˆ³å’Œåç§»é‡å°è£…åœ¨ <code>ScrollResult</code> å¯¹è±¡ä¸­ï¼Œå¹¶è¿”å›ç»™å‰ç«¯ã€‚</li>
</ul>
<p>æ•ˆæœå›¾å¦‚ä¸‹ï¼ˆæˆ‘å…³æ³¨äº†å°é±¼åŒå­¦ï¼Œäºæ˜¯æˆ‘å¯ä»¥çœ‹åˆ°å°é±¼åŒå­¦å‘å¸ƒçš„æ–‡ç« ï¼‰ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-322.png" alt="img"></p>
<h2 id="10ã€é™„è¿‘å•†æˆ·">10ã€é™„è¿‘å•†æˆ·</h2>
<h3 id="10-1ã€é™„è¿‘å•†æˆ·-GEOæ•°æ®ç»“æ„çš„åŸºæœ¬ç”¨æ³•">10.1ã€é™„è¿‘å•†æˆ·-GEOæ•°æ®ç»“æ„çš„åŸºæœ¬ç”¨æ³•</h3>
<p>GEOæ˜¯Geolocationçš„ç®€å†™å½¢å¼ï¼Œä»£è¡¨åœ°ç†åæ ‡ï¼Œåœ¨Redisçš„3.2ç‰ˆæœ¬ååŠ å…¥äº†GEOçš„æ”¯æŒï¼Œå…è®¸å­˜å‚¨åœ°ç†åæ ‡ä¿¡æ¯ï¼Œå¸®åŠ©æˆ‘ä»¬æ ¹æ®ç»çº¬åº¦æ¥æ£€ç´¢æ•°æ®ã€‚</p>
<p>å¸¸è§çš„å‘½ä»¤æœ‰ï¼š</p>
<ol>
<li>GEOADDï¼šæ·»åŠ ä¸€ä¸ªåœ°ç†ç©ºé—´ä¿¡æ¯ï¼ŒåŒ…å«ï¼šç»åº¦ï¼ˆlongitudeï¼‰ã€çº¬åº¦ï¼ˆlatitudeï¼‰ã€å€¼ï¼ˆmemberï¼‰</li>
<li>GEODISTï¼šè®¡ç®—æŒ‡å®šçš„ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»å¹¶è¿”å›</li>
<li>GEOHASHï¼šå°†æŒ‡å®šmemberçš„åæ ‡è½¬ä¸ºhashå­—ç¬¦ä¸²å½¢å¼å¹¶è¿”å›</li>
<li>GEOPOSï¼šè¿”å›æŒ‡å®šmemberçš„åæ ‡</li>
<li>GEORADIUSï¼šæŒ‡å®šåœ†å¿ƒã€åŠå¾„ï¼Œæ‰¾åˆ°è¯¥åœ†å†…åŒ…å«çš„æ‰€æœ‰memberï¼Œå¹¶æŒ‰ç…§ä¸åœ†å¿ƒä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ã€‚6.ä»¥åå·²åºŸå¼ƒ</li>
<li>GEOSEARCHï¼šåœ¨æŒ‡å®šèŒƒå›´å†…æœç´¢memberï¼Œå¹¶æŒ‰ç…§ä¸æŒ‡å®šç‚¹ä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ã€‚èŒƒå›´å¯ä»¥æ˜¯åœ†å½¢æˆ–çŸ©å½¢ã€‚6.2.æ–°åŠŸèƒ½</li>
<li>GEOSEARCHSTOREï¼šä¸GEOSEARCHåŠŸèƒ½ä¸€è‡´ï¼Œä¸è¿‡å¯ä»¥æŠŠç»“æœå­˜å‚¨åˆ°ä¸€ä¸ªæŒ‡å®šçš„keyã€‚ 6.2.æ–°åŠŸèƒ½</li>
</ol>
<h3 id="10-2ã€-é™„è¿‘å•†æˆ·-å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO">10.2ã€ é™„è¿‘å•†æˆ·-å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO</h3>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-323-1024x421.png" alt="img"></p>
<p><strong>ä¸ºä»€ä¹ˆä½¿ç”¨ Redis GEO</strong>ï¼š</p>
<p>Redis æä¾›çš„ GEO æ•°æ®ç»“æ„æ”¯æŒå­˜å‚¨åŸºäºåœ°ç†ä½ç½®çš„æˆå‘˜ï¼Œå¯ä»¥é€šè¿‡ç»çº¬åº¦æ¥å­˜å‚¨åœ°ç†åæ ‡ï¼Œå¹¶æ”¯æŒéå¸¸é«˜æ•ˆçš„åŸºäºè·ç¦»çš„æŸ¥è¯¢ã€‚è¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥éå¸¸æ–¹ä¾¿åœ°è¿›è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<ul>
<li><strong>æ’å…¥å•†æˆ·çš„åœ°ç†ä½ç½®ä¿¡æ¯</strong>ï¼šå°†å•†æˆ·çš„ç»çº¬åº¦å’Œå•†æˆ·IDå­˜å…¥ Redisã€‚</li>
<li><strong>æ ¹æ®è·ç¦»æŸ¥è¯¢å•†æˆ·</strong>ï¼šåŸºäºç”¨æˆ·çš„å½“å‰ä½ç½®ï¼ŒæŸ¥è¯¢æŒ‡å®šèŒƒå›´å†…çš„å•†æˆ·ã€‚</li>
</ul>
<p>å…·ä½“åœºæ™¯è¯´æ˜ï¼š</p>
<p>å½“ç”¨æˆ·ç‚¹å‡»â€œç¾é£Ÿâ€åï¼Œåå°ä¼šæ ¹æ®ç”¨æˆ·çš„åœ°ç†ä½ç½®æŸ¥è¯¢å‡ºå‘¨è¾¹çš„å•†æˆ·ã€‚æŸ¥è¯¢çš„æ–¹å¼æ˜¯ï¼šé€šè¿‡ç”¨æˆ·æä¾›çš„åœ°ç†åæ ‡ä½œä¸ºåœ†å¿ƒï¼Œåœ¨ Redis ä¸­æ ¹æ®ç»çº¬åº¦å­˜å‚¨å•†æˆ·ä¿¡æ¯ï¼ŒæŒ‰è·ç¦»æ¥æ’åºå•†æˆ·ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-324.png" alt="img"></p>
<p>æˆ‘ä»¬è¦åšçš„äº‹æƒ…æ˜¯ï¼šå°†æ•°æ®åº“è¡¨ä¸­çš„æ•°æ®å¯¼å…¥åˆ°redisä¸­å»ï¼Œredisä¸­çš„GEOï¼ŒGEOåœ¨redisä¸­å°±ä¸€ä¸ªmenberå’Œä¸€ä¸ªç»çº¬åº¦ï¼Œæˆ‘ä»¬æŠŠxå’Œyè½´ä¼ å…¥åˆ°redisåšçš„ç»çº¬åº¦ä½ç½®å»ï¼Œä½†æˆ‘ä»¬ä¸èƒ½æŠŠæ‰€æœ‰çš„æ•°æ®éƒ½æ”¾å…¥åˆ°menberä¸­å»ï¼Œæ¯•ç«Ÿä½œä¸ºredisæ˜¯ä¸€ä¸ªå†…å­˜çº§æ•°æ®åº“ï¼Œå¦‚æœå­˜æµ·é‡æ•°æ®ï¼Œredisè¿˜æ˜¯åŠ›ä¸ä»å¿ƒï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¿™ä¸ªåœ°æ–¹å­˜å‚¨ä»–çš„idå³å¯ã€‚</p>
<p>ä½†æ˜¯è¿™ä¸ªæ—¶å€™è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯åœ¨redisä¸­å¹¶æ²¡æœ‰å­˜å‚¨typeï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•æ ¹æ®typeæ¥å¯¹æ•°æ®è¿›è¡Œç­›é€‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŒ‰ç…§å•†æˆ·ç±»å‹åšåˆ†ç»„ï¼Œç±»å‹ç›¸åŒçš„å•†æˆ·ä½œä¸ºåŒä¸€ç»„ï¼Œä»¥typeIdä¸ºkeyå­˜å…¥åŒä¸€ä¸ªGEOé›†åˆä¸­å³å¯</p>
<p>åœ¨src/test/java/com/hmdpçš„HmDianPingApplicationTestsç±»ä¸­å†™å…¥å¦‚ä¸‹çš„æ–¹æ³•ï¼š</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="type">StringRedisTemplate</span> stringRedisTemplate;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line">void loadShopData()&#123;</span><br><span class="line">    <span class="comment">//1.æŸ¥è¯¢åº—é“ºä¿¡æ¯</span></span><br><span class="line">    <span class="type">List</span>&lt;<span class="type">Shop</span>&gt; list <span class="operator">=</span> shopService.list();</span><br><span class="line">    <span class="comment">//2.æŠŠåº—é“ºåˆ†ç»„ï¼ŒæŒ‰ç…§typeIdåˆ†ç»„ï¼ŒtypeIdä¸€è‡´çš„æ”¾åˆ°ä¸€ä¸ªé›†åˆ</span></span><br><span class="line">    <span class="type">Map</span>&lt;<span class="type">Long</span>,<span class="type">List</span>&lt;<span class="type">Shop</span>&gt;&gt; map <span class="operator">=</span> list.stream().collect(<span class="type">Collectors</span>.groupingBy(Shop::getTypeId));</span><br><span class="line">    <span class="comment">//3.åˆ†æ‰¹å®Œæˆå†™å…¥Redis</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">Map</span>.<span class="type">Entry</span>&lt;<span class="type">Long</span>, <span class="type">List</span>&lt;<span class="type">Shop</span>&gt;&gt; entry : map.entrySet()) &#123;</span><br><span class="line">        <span class="comment">//3.1.è·å–ç±»å‹id</span></span><br><span class="line">        <span class="type">Long</span> typeid <span class="operator">=</span> entry.getKey();</span><br><span class="line">        <span class="type">String</span> key <span class="operator">=</span> <span class="string">&quot;shop:geo:&quot;</span><span class="operator">+</span>typeid;</span><br><span class="line">        <span class="comment">//3.2.è·å–åŒç±»å‹çš„åº—é“ºçš„é›†åˆ</span></span><br><span class="line">        <span class="type">List</span>&lt;<span class="type">Shop</span>&gt; value <span class="operator">=</span> entry.getValue();</span><br><span class="line">        <span class="comment">//3.3.å†™å…¥redis GEOADD key ç»åº¦ çº¬åº¦ member</span></span><br><span class="line">        <span class="type">List</span>&lt;<span class="type">RedisGeoCommands</span>.<span class="type">GeoLocation</span>&lt;<span class="type">String</span>&gt;&gt; locations <span class="operator">=</span> new <span class="type">ArrayList</span>&lt;&gt;(value.size());</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">Shop</span> shop : value)&#123;</span><br><span class="line"><span class="comment">//                stringRedisTemplate.opsForGeo().add(key,new Point(shop.getX(),shop.getY()),shop.getId().toString());</span></span><br><span class="line">            locations.add(new <span class="type">RedisGeoCommands</span>.<span class="type">GeoLocation</span>&lt;&gt;(</span><br><span class="line">                    shop.getId().toString(),</span><br><span class="line">                    new <span class="type">Point</span>(shop.getX(),shop.getY())</span><br><span class="line">            ));</span><br><span class="line">        &#125;</span><br><span class="line">        stringRedisTemplate.opsForGeo().add(key,locations);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ­¥éª¤è¯¦è§£</strong>ï¼š</p>
<h4 id="1-æŸ¥è¯¢å•†æˆ·ä¿¡æ¯ï¼š">1. <strong>æŸ¥è¯¢å•†æˆ·ä¿¡æ¯</strong>ï¼š</h4>
<p>é¦–å…ˆï¼Œä»æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæ‰€æœ‰çš„å•†æˆ·æ•°æ®ã€‚</p>
<p><code>shopService.list()</code> è¿”å›çš„æ˜¯æ‰€æœ‰å•†æˆ·çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å•†æˆ·çš„ç»çº¬åº¦ï¼ˆ<code>x</code> å’Œ <code>y</code>ï¼‰ã€å•†æˆ·ç±»å‹ï¼ˆ<code>typeId</code>ï¼‰ç­‰ã€‚</p>
<ol start="2">
<li><strong>å°†å•†æˆ·æŒ‰ç±»å‹åˆ†ç»„</strong>ï¼š</li>
</ol>
<p>å•†æˆ·æ•°æ®æŒ‰ <code>typeId</code>ï¼ˆå•†æˆ·ç±»å‹ï¼‰è¿›è¡Œåˆ†ç»„ï¼Œç¡®ä¿åŒç±»å‹çš„å•†æˆ·ä¼šå­˜å‚¨åœ¨åŒä¸€ä¸ª GEO é›†åˆä¸­ã€‚</p>
<p>é€šè¿‡ Java 8 çš„ <code>Collectors.groupingBy()</code> æ–¹æ³•ï¼ŒæŒ‰ç…§ <code>typeId</code> å¯¹å•†æˆ·è¿›è¡Œåˆ†ç»„ï¼Œè¿”å›ä¸€ä¸ªä»¥ <code>typeId</code> ä¸ºé”®çš„ <code>Map</code>ï¼Œæ¯ä¸ªé”®å¯¹åº”ä¸€ä¸ªå•†æˆ·ç±»å‹çš„å•†æˆ·åˆ—è¡¨ã€‚</p>
<h4 id="3-å°†å•†æˆ·æ•°æ®åˆ†æ‰¹å†™å…¥-Redisï¼š">3. <strong>å°†å•†æˆ·æ•°æ®åˆ†æ‰¹å†™å…¥ Redis</strong>ï¼š</h4>
<p>å¯¹äºæ¯ä¸€ç»„å•†æˆ·ï¼Œä½¿ç”¨ Redis çš„ <code>GEOADD</code> å‘½ä»¤å°†å•†æˆ·çš„ç»çº¬åº¦æ•°æ®æ·»åŠ åˆ°å¯¹åº”çš„ GEO é›†åˆä¸­ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ Redis ä¸­ä¸ºæ¯ç§ç±»å‹çš„å•†æˆ·åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ GEO é›†åˆã€‚</p>
<ul>
<li><code>key</code>ï¼šä»¥å•†æˆ·ç±»å‹çš„ <code>typeId</code> ä¸ºé”®ï¼Œåˆ›å»ºä¸€ä¸ªå¯¹åº”çš„ Redis GEO é›†åˆï¼ˆå¦‚ <code>shop:geo:1</code> å¯¹åº”ç±»å‹ä¸º 1 çš„å•†æˆ·ï¼‰ã€‚</li>
<li><code>locations</code>ï¼šè¿™æ˜¯ä¸€ä¸ª <code>List</code>ï¼ŒåŒ…å«æ¯ä¸ªå•†æˆ·çš„ <code>GeoLocation</code>ï¼Œæ¯ä¸ªå•†æˆ·çš„ä½ç½®ä¿¡æ¯åŒ…æ‹¬å•†æˆ·çš„ <code>ID</code> å’Œ <code>Point</code>ï¼ˆç»çº¬åº¦ï¼‰ã€‚</li>
<li><code>stringRedisTemplate.opsForGeo().add(key, locations)</code>ï¼šé€šè¿‡ <code>stringRedisTemplate</code> çš„ <code>Geo</code> æ“ä½œå°†å•†æˆ·çš„ä½ç½®ä¿¡æ¯æ‰¹é‡å†™å…¥ Redis ä¸­ã€‚</li>
</ul>
<h4 id="å…³äº-Redis-GEO-çš„å­˜å‚¨å’ŒæŸ¥è¯¢ï¼š"><strong>å…³äº Redis GEO çš„å­˜å‚¨å’ŒæŸ¥è¯¢</strong>ï¼š</h4>
<ul>
<li><strong>å­˜å‚¨æ•°æ®</strong>ï¼šæ¯ä¸ªå•†æˆ·çš„ ID ä½œä¸º Redis GEO é›†åˆçš„ memberï¼Œå•†æˆ·çš„ç»çº¬åº¦ä½œä¸ºå¯¹åº”çš„ <code>Point</code> å­˜å‚¨åœ¨ Redis ä¸­ã€‚</li>
<li><strong>æŸ¥è¯¢æ•°æ®</strong>ï¼šå­˜å‚¨å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Redis æä¾›çš„ GEO å‘½ä»¤æ¥è¿›è¡ŒåŸºäºåœ°ç†ä½ç½®çš„æŸ¥è¯¢ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥æŸ¥è¯¢ç»™å®šåæ ‡èŒƒå›´å†…çš„å•†æˆ·ï¼Œæˆ–è€…æ ¹æ®ç”¨æˆ·çš„ä½ç½®ï¼ŒæŸ¥è¯¢é™„è¿‘çš„å•†æˆ·ã€‚</li>
</ul>
<p>æµ‹è¯•ï¼šç‚¹å‡»è¿è¡Œä¹‹åï¼Œåœ¨Redisä¸­èƒ½å¤Ÿçœ‹åˆ°å¯¼å…¥çš„æ•°æ®ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-325-1024x608.png" alt="img"></p>
<h3 id="10-3-é™„è¿‘å•†æˆ·-å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½">10.3 é™„è¿‘å•†æˆ·-å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½</h3>
<p>SpringDataRedisçš„2.3.9ç‰ˆæœ¬å¹¶ä¸æ”¯æŒRedis 6.2æä¾›çš„GEOSEARCHå‘½ä»¤ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æç¤ºå…¶ç‰ˆæœ¬ï¼Œä¿®æ”¹è‡ªå·±çš„POM</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>spring-data-redis</code></strong> å‡çº§è‡³ 2.6.2 ç‰ˆæœ¬ï¼Œä»¥æ”¯æŒ Redis 6.2 æ–°ç‰¹æ€§ã€‚</li>
<li><strong><code>lettuce-core</code></strong> å‡çº§è‡³ 6.1.6 ç‰ˆæœ¬ï¼Œç¡®ä¿æ”¯æŒ <code>GEOSEARCH</code> å‘½ä»¤ã€‚</li>
</ul>
<p>åœ¨ShopControllerä¸­ä¿®æ”¹queryShopByTypeæ–¹æ³•ï¼š</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@GetMapping</span>(<span class="string">&quot;/of/type&quot;</span>)</span><br><span class="line">public Result <span class="built_in">queryShopByType</span>(</span><br><span class="line">        <span class="variable">@RequestParam</span>(<span class="string">&quot;typeId&quot;</span>) Integer typeId,</span><br><span class="line">        <span class="variable">@RequestParam</span>(value = <span class="string">&quot;current&quot;</span>, defaultValue = <span class="string">&quot;1&quot;</span>) Integer current,</span><br><span class="line">        <span class="variable">@RequestParam</span>(value=<span class="string">&quot;x&quot;</span>,required=false) Double x,</span><br><span class="line">        <span class="variable">@RequestParam</span>(value=<span class="string">&quot;y&quot;</span>,required=false) Double y</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">shopService</span><span class="selector-class">.queryShopByType</span>(typeId,current,x,y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>typeId</code></strong>ï¼šå•†æˆ·ç±»å‹IDï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„å•†æˆ·ã€‚</li>
<li><strong><code>current</code></strong>ï¼šå½“å‰é¡µï¼Œé»˜è®¤ä¸º1ï¼Œç”¨äºåˆ†é¡µã€‚</li>
<li><strong><code>x</code> å’Œ <code>y</code></strong>ï¼šå¯é€‰çš„ç»çº¬åº¦ï¼Œç”¨äºæŸ¥è¯¢é™„è¿‘çš„å•†æˆ·ã€‚å¦‚æœä¸ºç©ºï¼Œåˆ™ä¸æŒ‰è·ç¦»æŸ¥è¯¢ã€‚</li>
</ul>
<p>åœ¨IShopServiceæ¥å£ä¸­å†™å…¥å¦‚ä¸‹æ–¹æ³•ï¼š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Result</span> queryShopByType(<span class="type">Integer</span> typeId, <span class="type">Integer</span> <span class="keyword">current</span>, <span class="keyword">Double</span> x, <span class="keyword">Double</span> y);</span><br></pre></td></tr></table></figure>
<p>åœ¨ShopServiceImplç±»ä¸­å†™å…¥å¦‚ä¸‹æ–¹æ³•ï¼š</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="keyword">public</span> Result queryShopByType(Integer typeId, Integer current, <span class="keyword">Double</span> x, <span class="keyword">Double</span> y) &#123;</span><br><span class="line">    <span class="comment">//1.åˆ¤æ–­æ˜¯å¦éœ€è¦æ ¹æ®åæ ‡æŸ¥è¯¢</span></span><br><span class="line">    <span class="keyword">if</span>(x==<span class="keyword">null</span> || y==<span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="comment">//ä¸éœ€è¦æŸ¥è¯¢åæ ‡ï¼ŒæŒ‰æ•°æ®åº“æŸ¥</span></span><br><span class="line">        Page&lt;Shop&gt; page = query()</span><br><span class="line">                .eq(<span class="string">&quot;type_id&quot;</span>,typeId)</span><br><span class="line">                .page(<span class="keyword">new</span> Page&lt;&gt;(current, SystemConstants.DEFAULT_PAGE_SIZE));</span><br><span class="line">        <span class="keyword">return</span> Result.ok(page.getRecords());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.è®¡ç®—åˆ†é¡µå‚æ•°</span></span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">from</span> = (current - <span class="number">1</span>)*SystemConstants.DEFAULT_PAGE_SIZE;</span><br><span class="line">    <span class="keyword">int</span> end = current*SystemConstants.DEFAULT_PAGE_SIZE;</span><br><span class="line">    <span class="comment">//3.æŸ¥è¯¢redisï¼ŒæŒ‰ç…§è·ç¦»æ’åºã€åˆ†é¡µã€‚ç»“æœï¼šshopId,distance</span></span><br><span class="line">    String key = SHOP_GEO_KEY+typeId;</span><br><span class="line">    GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = stringRedisTemplate.opsForGeo()</span><br><span class="line">            .search(</span><br><span class="line">                    key,</span><br><span class="line">                    GeoReference.fromCoordinate(x, y),</span><br><span class="line">                    <span class="keyword">new</span> Distance(<span class="number">5000</span>),</span><br><span class="line">                    RedisGeoCommands.GeoSearchCommandArgs.newGeoSearchArgs().includeDistance().limit(end)</span><br><span class="line">            );</span><br><span class="line">    <span class="comment">//4.è§£æå‡ºid</span></span><br><span class="line">    <span class="keyword">if</span>(results==<span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; list = results.getContent();</span><br><span class="line">    <span class="comment">//4.1.æˆªå–from-endçš„éƒ¨åˆ†</span></span><br><span class="line">    List&lt;<span class="keyword">Long</span>&gt; ids = <span class="keyword">new</span> ArrayList&lt;&gt;(list.<span class="keyword">size</span>());</span><br><span class="line">    Map&lt;String,Distance&gt; distanceMap = <span class="keyword">new</span> HashMap&lt;&gt;(list.<span class="keyword">size</span>());</span><br><span class="line">    <span class="keyword">if</span>(list.<span class="keyword">size</span>()&lt;=<span class="keyword">from</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    list.stream().skip(<span class="keyword">from</span>).forEach(result-&gt;&#123; <span class="comment">//è·³è¿‡å¯èƒ½æŠŠæ‰€æœ‰æ•°æ®è·³è¿‡äº†</span></span><br><span class="line">        <span class="comment">//4.2.è·å–åº—é“ºid</span></span><br><span class="line">        String shopIdStr = result.getContent().getName();</span><br><span class="line">        ids.add(<span class="keyword">Long</span>.valueOf(shopIdStr));</span><br><span class="line">        <span class="comment">//4.3.è·å–è·ç¦»</span></span><br><span class="line">        Distance distance = result.getDistance();</span><br><span class="line">        distanceMap.put(shopIdStr,distance);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//5.æ ¹æ®idæŸ¥è¯¢shop</span></span><br><span class="line">    String idStr = StrUtil.<span class="keyword">join</span>(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">    List&lt;Shop&gt; shops = query().in(<span class="string">&quot;id&quot;</span>, ids).last(<span class="string">&quot;ORDER BY FIELD ( id,&quot;</span> + idStr + <span class="string">&quot;)&quot;</span>).list();</span><br><span class="line">    <span class="keyword">for</span>(Shop shop : shops)&#123;</span><br><span class="line">        shop.setDistance(distanceMap.get(shop.getId().toString()).getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6ã€è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shops);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="æ­¥éª¤-1ï¼šåˆ¤æ–­æ˜¯å¦éœ€è¦æ ¹æ®åæ ‡æŸ¥è¯¢"><strong>æ­¥éª¤ 1ï¼šåˆ¤æ–­æ˜¯å¦éœ€è¦æ ¹æ®åæ ‡æŸ¥è¯¢</strong></h4>
<p>é¦–å…ˆæ£€æŸ¥ <code>x</code> å’Œ <code>y</code> æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™ä¸éœ€è¦æ ¹æ®åæ ‡æŸ¥è¯¢ï¼Œç›´æ¥ä»æ•°æ®åº“ä¸­æŸ¥è¯¢å•†æˆ·ä¿¡æ¯ã€‚å¦‚æœ <code>x</code> å’Œ <code>y</code> ä¸ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºéœ€è¦æ ¹æ®ç»çº¬åº¦æŸ¥è¯¢é™„è¿‘çš„å•†æˆ·ã€‚</p>
<h4 id="æ­¥éª¤-2ï¼šè®¡ç®—åˆ†é¡µå‚æ•°"><strong>æ­¥éª¤ 2ï¼šè®¡ç®—åˆ†é¡µå‚æ•°</strong></h4>
<p>æ ¹æ®å½“å‰é¡µæ•° <code>current</code>ï¼Œè®¡ç®—åˆ†é¡µçš„èµ·å§‹ä½ç½® <code>from</code> å’Œç»“æŸä½ç½® <code>end</code>ã€‚è¿™å°†ç”¨äºä»æŸ¥è¯¢ç»“æœä¸­æå–å¯¹åº”çš„æ•°æ®ã€‚</p>
<h4 id="æ­¥éª¤-3ï¼šæŸ¥è¯¢-Redis-ä¸­çš„å•†æˆ·æ•°æ®"><strong>æ­¥éª¤ 3ï¼šæŸ¥è¯¢ Redis ä¸­çš„å•†æˆ·æ•°æ®</strong></h4>
<p>ä½¿ç”¨ Redis çš„ <code>GEOSEARCH</code> å‘½ä»¤æŸ¥è¯¢å•†æˆ·ï¼Œæ ¹æ®ç”¨æˆ·æä¾›çš„ç»çº¬åº¦ï¼ˆ<code>x</code>, <code>y</code>ï¼‰è®¡ç®—è·ç¦»ï¼Œç­›é€‰å‡ºè·ç¦»ç”¨æˆ·ä½ç½®åœ¨ä¸€å®šèŒƒå›´å†…çš„å•†æˆ·ã€‚</p>
<ul>
<li><code>SHOP_GEO_KEY + typeId</code>ï¼šRedis ä¸­å­˜å‚¨å•†æˆ·ä½ç½®ä¿¡æ¯çš„é”®ï¼Œä»¥å•†æˆ·ç±»å‹ <code>typeId</code> ä¸ºåŒºåˆ†ã€‚</li>
<li><code>GeoReference.fromCoordinate(x, y)</code>ï¼šé€šè¿‡ç”¨æˆ·æä¾›çš„ç»çº¬åº¦åˆ›å»º <code>GeoReference</code>ã€‚</li>
<li><code>new Distance(5000)</code>ï¼šè®¾ç½®æŸ¥è¯¢çš„åŠå¾„ä¸º 5000 ç±³ï¼Œå³æŸ¥è¯¢ 5 å…¬é‡ŒèŒƒå›´å†…çš„å•†æˆ·ã€‚</li>
<li><code>limit(end)</code>ï¼šé™åˆ¶è¿”å›çš„å•†æˆ·æ•°é‡ã€‚</li>
</ul>
<h4 id="æ­¥éª¤-4ï¼šè§£ææŸ¥è¯¢ç»“æœ"><strong>æ­¥éª¤ 4ï¼šè§£ææŸ¥è¯¢ç»“æœ</strong></h4>
<p>ä» Redis è¿”å›çš„ç»“æœä¸­æå–å•†æˆ· ID å’Œè·ç¦»ä¿¡æ¯ï¼Œå¹¶æ ¹æ®åˆ†é¡µå‚æ•°æˆªå–éœ€è¦çš„æ•°æ®ã€‚</p>
<ul>
<li>ä½¿ç”¨ <code>skip(from)</code> è·³è¿‡ä¸éœ€è¦çš„å•†æˆ·æ•°æ®ï¼Œç¡®ä¿ä»æ­£ç¡®çš„èµ·å§‹ä½ç½®å¼€å§‹æå–å•†æˆ·ã€‚</li>
<li>æå–å•†æˆ·çš„ ID å’Œè·ç¦»ä¿¡æ¯ï¼Œå­˜å…¥ <code>ids</code> å’Œ <code>distanceMap</code>ã€‚</li>
</ul>
<h4 id="æ­¥éª¤-5ï¼šæ ¹æ®å•†æˆ·-ID-æŸ¥è¯¢å•†æˆ·è¯¦æƒ…"><strong>æ­¥éª¤ 5ï¼šæ ¹æ®å•†æˆ· ID æŸ¥è¯¢å•†æˆ·è¯¦æƒ…</strong></h4>
<p>æ ¹æ®æå–åˆ°çš„å•†æˆ· IDï¼Œä»æ•°æ®åº“ä¸­æŸ¥è¯¢å•†æˆ·çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¹¶å°†æŸ¥è¯¢åˆ°çš„è·ç¦»ä¿¡æ¯æ·»åŠ åˆ°å•†æˆ·æ•°æ®ä¸­ã€‚</p>
<h4 id="æ­¥éª¤-6ï¼šè¿”å›ç»“æœ"><strong>æ­¥éª¤ 6ï¼šè¿”å›ç»“æœ</strong></h4>
<p>æœ€ç»ˆè¿”å›å•†æˆ·çš„è¯¦ç»†ä¿¡æ¯ä»¥åŠè·ç¦»ã€‚</p>
<p>æ•ˆæœï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-326.png" alt="img"></p>
<h2 id="11ã€ç”¨æˆ·ç­¾åˆ°">11ã€ç”¨æˆ·ç­¾åˆ°</h2>
<h3 id="11-1ã€ç”¨æˆ·ç­¾åˆ°-BitMapåŠŸèƒ½æ¼”ç¤º">11.1ã€ç”¨æˆ·ç­¾åˆ°-BitMapåŠŸèƒ½æ¼”ç¤º</h3>
<p>æˆ‘ä»¬é’ˆå¯¹ç­¾åˆ°åŠŸèƒ½å®Œå…¨å¯ä»¥é€šè¿‡mysqlæ¥å®Œæˆï¼Œæ¯”å¦‚è¯´ä»¥ä¸‹è¿™å¼ è¡¨</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-327.png" alt="img"></p>
<p>ç”¨æˆ·ä¸€æ¬¡ç­¾åˆ°ï¼Œå°±æ˜¯ä¸€æ¡è®°å½•ï¼Œå‡å¦‚æœ‰1000ä¸‡ç”¨æˆ·ï¼Œå¹³å‡æ¯äººæ¯å¹´ç­¾åˆ°æ¬¡æ•°ä¸º10æ¬¡ï¼Œåˆ™è¿™å¼ è¡¨ä¸€å¹´çš„æ•°æ®é‡ä¸º 1äº¿æ¡</p>
<p>æ¯ç­¾åˆ°ä¸€æ¬¡éœ€è¦ä½¿ç”¨ï¼ˆ8 + 8 + 1 + 1 + 3 + 1ï¼‰å…±22 å­—èŠ‚çš„å†…å­˜ï¼Œä¸€ä¸ªæœˆåˆ™æœ€å¤šéœ€è¦600å¤šå­—èŠ‚</p>
<p>æˆ‘ä»¬å¦‚ä½•èƒ½å¤Ÿç®€åŒ–ä¸€ç‚¹å‘¢ï¼Ÿå…¶å®å¯ä»¥è€ƒè™‘å°æ—¶å€™ä¸€ä¸ªæŒºå¸¸è§çš„æ–¹æ¡ˆï¼Œå°±æ˜¯å°æ—¶å€™ï¼Œå’±ä»¬å‡†å¤‡ä¸€å¼ å°å°çš„å¡ç‰‡ï¼Œä½ åªè¦ç­¾åˆ°å°±æ‰“ä¸Šä¸€ä¸ªå‹¾ï¼Œæˆ‘æœ€ååˆ¤æ–­ä½ æ˜¯å¦ç­¾åˆ°ï¼Œå…¶å®åªéœ€è¦åˆ°å°å¡ç‰‡ä¸Šçœ‹ä¸€çœ‹å°±çŸ¥é“äº†</p>
<p>æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ç±»ä¼¼è¿™æ ·çš„æ–¹æ¡ˆæ¥å®ç°æˆ‘ä»¬çš„ç­¾åˆ°éœ€æ±‚ã€‚</p>
<p>åœ¨å®é™…åœºæ™¯ä¸­ï¼Œå¯èƒ½æœ‰å¾ˆå¤šç”¨æˆ·æ¯æœˆçš„ç­¾åˆ°è®°å½•ã€‚ä¾‹å¦‚ï¼Œå‡è®¾æ¯ä¸ªç”¨æˆ·æ¯æœˆæœ‰ 30 å¤©çš„ç­¾åˆ°è®°å½•ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ¯ä¸ªç”¨æˆ·ä½¿ç”¨ä¸€ä¸ª BitMap æ¥è®°å½•ä»–ä»¬çš„ç­¾åˆ°æƒ…å†µã€‚æ¯ä½ç”¨æˆ·çš„ç­¾åˆ°ä¿¡æ¯ä¼šå¯¹åº”ä¸€ä¸ª 1 æˆ– 0ï¼Œ1 è¡¨ç¤ºç­¾åˆ°ï¼Œ0 è¡¨ç¤ºæœªç­¾åˆ°ã€‚</p>
<p>æŠŠæ¯ä¸€ä¸ªbitä½å¯¹åº”å½“æœˆçš„æ¯ä¸€å¤©ï¼Œå½¢æˆäº†æ˜ å°„å…³ç³»ã€‚ç”¨0å’Œ1æ ‡ç¤ºä¸šåŠ¡çŠ¶æ€ï¼Œè¿™ç§æ€è·¯å°±ç§°ä¸ºä½å›¾ï¼ˆBitMapï¼‰ã€‚è¿™æ ·æˆ‘ä»¬å°±ç”¨æå°çš„ç©ºé—´ï¼Œæ¥å®ç°äº†å¤§é‡æ•°æ®çš„è¡¨ç¤º</p>
<p>Redisä¸­æ˜¯åˆ©ç”¨stringç±»å‹æ•°æ®ç»“æ„å®ç°BitMapï¼Œå› æ­¤æœ€å¤§ä¸Šé™æ˜¯512Mï¼Œè½¬æ¢ä¸ºbitåˆ™æ˜¯ 2^32ä¸ªbitä½ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-328-1024x225.png" alt="img"></p>
<p>æ¯å¤©çš„ç­¾åˆ°æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶ä½ï¼Œ1 è¡¨ç¤ºç­¾åˆ°ï¼Œ0 è¡¨ç¤ºæœªç­¾åˆ°ã€‚æ¯ä¸ªç”¨æˆ·æ¯æœˆçš„ç­¾åˆ°æ•°æ®å°±å¯¹åº”ä¸€ä¸ªé•¿åº¦ä¸º 30 æˆ– 31 çš„äºŒè¿›åˆ¶æ•°ã€‚</p>
<p>å‡è®¾ä¸€ä¸ªç”¨æˆ·çš„ç­¾åˆ°è®°å½•æ˜¯ï¼š<br>
<code>1110101001001010111011001...</code><br>
æ¯ä¸ªä½ç½®å¯¹åº”ä¸€ä¸ªæ—¥æœŸï¼Œ1 è¡¨ç¤ºè¯¥æ—¥æœŸç­¾åˆ°ï¼Œ0 è¡¨ç¤ºæœªç­¾åˆ°ã€‚</p>
<p>BitMapçš„æ“ä½œå‘½ä»¤æœ‰ï¼š</p>
<ul>
<li>SETBITï¼šå‘æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰å­˜å…¥ä¸€ä¸ª0æˆ–1</li>
<li>GETBIT ï¼šè·å–æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰çš„bitå€¼</li>
<li>BITCOUNT ï¼šç»Ÿè®¡BitMapä¸­å€¼ä¸º1çš„bitä½çš„æ•°é‡</li>
<li>BITFIELD ï¼šæ“ä½œï¼ˆæŸ¥è¯¢ã€ä¿®æ”¹ã€è‡ªå¢ï¼‰BitMapä¸­bitæ•°ç»„ä¸­çš„æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰çš„å€¼</li>
<li>BITFIELD_RO ï¼šè·å–BitMapä¸­bitæ•°ç»„ï¼Œå¹¶ä»¥åè¿›åˆ¶å½¢å¼è¿”å›</li>
<li>BITOP ï¼šå°†å¤šä¸ªBitMapçš„ç»“æœåšä½è¿ç®—ï¼ˆä¸ ã€æˆ–ã€å¼‚æˆ–ï¼‰</li>
<li>BITPOS ï¼šæŸ¥æ‰¾bitæ•°ç»„ä¸­æŒ‡å®šèŒƒå›´å†…ç¬¬ä¸€ä¸ª0æˆ–1å‡ºç°çš„ä½ç½®</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-329.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-330.png" alt="img"></p>
<p><strong>BITFIELD key GET</strong>(ä»£è¡¨æŸ¥è¯¢) <strong>u</strong>(uä»£è¡¨æ— ç¬¦å·ï¼Œiä»£è¡¨æœ‰ç¬¦å·)<strong>æˆªå–å‡ ä½ä½œä¸ºç»“æœ å¼€å§‹çš„ä½ç½®</strong></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-333.png" alt="img"></p>
<h3 id="11-2-ã€ç”¨æˆ·ç­¾åˆ°-å®ç°ç­¾åˆ°åŠŸèƒ½">11.2 ã€ç”¨æˆ·ç­¾åˆ°-å®ç°ç­¾åˆ°åŠŸèƒ½</h3>
<p>éœ€æ±‚ï¼šå®ç°ç­¾åˆ°æ¥å£ï¼Œå°†å½“å‰ç”¨æˆ·å½“å¤©ç­¾åˆ°ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­</p>
<p>æ€è·¯ï¼š</p>
<ul>
<li>å°†æ¯ä¸ªç”¨æˆ·çš„ç­¾åˆ°æ•°æ®ä»¥ <code>BitMap</code> çš„å½¢å¼å­˜å‚¨ã€‚<code>BitMap</code> é€šè¿‡ä½æ¥è¡¨ç¤ºæ•°æ®ï¼Œç­¾åˆ°çš„ä½ä¸º <code>1</code>ï¼Œæœªç­¾åˆ°çš„ä½ä¸º <code>0</code>ã€‚</li>
<li>æ¯æ¬¡ç­¾åˆ°æ—¶ï¼Œæ›´æ–°å¯¹åº”æ—¥æœŸçš„ä½ç½®ï¼ˆå³æ¯ä¸ªç”¨æˆ·çš„ç­¾åˆ°ä¿¡æ¯ï¼‰ã€‚</li>
</ul>
<p>æˆ‘ä»¬é€šè¿‡æ¥å£æ–‡æ¡£å‘ç°ï¼Œæ­¤æ¥å£å¹¶æ²¡æœ‰ä¼ é€’ä»»ä½•çš„å‚æ•°ï¼Œæ²¡æœ‰å‚æ•°æ€ä¹ˆç¡®å®æ˜¯å“ªä¸€å¤©ç­¾åˆ°å‘¢ï¼Ÿè¿™ä¸ªå¾ˆå®¹æ˜“ï¼Œå¯ä»¥é€šè¿‡åå°ä»£ç ç›´æ¥è·å–å³å¯ï¼Œç„¶ååˆ°å¯¹åº”çš„åœ°å€ä¸Šå»ä¿®æ”¹bitMapã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-334-1024x510.png" alt="img"></p>
<p><strong>ä»£ç </strong></p>
<p>UserController</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">&quot;/sign&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="function">Result <span class="title">sign</span><span class="params">()</span></span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">return</span> userService.<span class="title">sign</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UserServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sign</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.è·å–å½“å‰ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 2.è·å–æ—¥æœŸ</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="comment">// 3.æ‹¼æ¥key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">keySuffix</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;:yyyyMM&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_SIGN_KEY + userId + keySuffix;</span><br><span class="line">    <span class="comment">// 4.è·å–ä»Šå¤©æ˜¯æœ¬æœˆçš„ç¬¬å‡ å¤©</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">dayOfMonth</span> <span class="operator">=</span> now.getDayOfMonth();</span><br><span class="line">    <span class="comment">// 5.å†™å…¥Redis SETBIT key offset 1</span></span><br><span class="line">    stringRedisTemplate.opsForValue().setBit(key, dayOfMonth - <span class="number">1</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>UserServiceImpl</code> ä¸­ï¼Œå…·ä½“å®ç°ç­¾åˆ°çš„åŠŸèƒ½ã€‚ä»£ç æ‰§è¡Œçš„æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>è·å–å½“å‰ç”¨æˆ· ID</strong>ï¼šé€šè¿‡ <code>UserHolder.getUser().getId()</code> è·å–å½“å‰ç”¨æˆ·çš„ IDã€‚</li>
<li><strong>è·å–å½“å‰æ—¥æœŸ</strong>ï¼šä½¿ç”¨ <code>LocalDateTime.now()</code> è·å–å½“å‰æ—¥æœŸï¼Œç”¨äºè®¡ç®—å½“å¤©çš„æ—¥æœŸã€‚</li>
<li><strong>æ„å»º Redis <code>key</code></strong>ï¼šæ ¹æ®ç”¨æˆ· ID å’Œå½“å‰å¹´æœˆï¼ˆæ ¼å¼ï¼š<code>yyyyMM</code>ï¼‰æ„å»º Redis çš„ <code>key</code>ï¼Œå³ <code>USER_SIGN_KEY + userId + keySuffix</code>ï¼Œå…¶ä¸­ <code>keySuffix</code> ä¸ºå¹´æœˆã€‚</li>
<li><strong>è®¡ç®—ä»Šå¤©æ˜¯æœ¬æœˆçš„ç¬¬å‡ å¤©</strong>ï¼šé€šè¿‡ <code>now.getDayOfMonth()</code> è·å–ä»Šå¤©æ˜¯æœ¬æœˆçš„ç¬¬å‡ å¤©ï¼ˆä¾‹å¦‚ 1ã€2ã€3â€¦ï¼‰ã€‚</li>
<li><strong>æ›´æ–° Redis ä¸­çš„ BitMap</strong>ï¼šé€šè¿‡ <code>stringRedisTemplate.opsForValue().setBit(key, dayOfMonth - 1, true)</code> å°†å¯¹åº”æ—¥æœŸçš„ç­¾åˆ°çŠ¶æ€è®¾ç½®ä¸º <code>1</code>ï¼Œè¡¨ç¤ºè¯¥ç”¨æˆ·å·²ç­¾åˆ°ã€‚</li>
</ul>
<p><code>SETBIT key offset 1</code>ï¼šå°† <code>key</code> å¯¹åº”çš„ BitMap ä¸­çš„ <code>offset</code> ä½ç½®è®¾ç½®ä¸º <code>1</code>ï¼Œè¡¨ç¤ºç”¨æˆ·åœ¨è¯¥æ—¥æœŸå·²ç­¾åˆ°ã€‚</p>
<ul>
<li><code>key</code>ï¼šç”¨æˆ·æŸä¸ªæœˆçš„ç­¾åˆ°è®°å½•ã€‚</li>
<li><code>offset</code>ï¼šç­¾åˆ°çš„æ—¥æœŸï¼Œ<code>dayOfMonth - 1</code>ï¼ˆå¦‚ 1 å·ç­¾åˆ°å¯¹åº”çš„ <code>offset</code> ä¸º 0ï¼‰ã€‚</li>
<li><code>true</code>ï¼šè¡¨ç¤ºè¯¥æ—¥æœŸå·²ç­¾åˆ°ï¼ˆ1ï¼‰ï¼Œ<code>false</code> è¡¨ç¤ºæœªç­¾åˆ°ï¼ˆ0ï¼‰ã€‚</li>
</ul>
<p>ç”¨Apifoxè¿›è¡Œæµ‹è¯•ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-335-1024x453.png" alt="img"></p>
<h3 id="11-3-ç”¨æˆ·ç­¾åˆ°-ç­¾åˆ°ç»Ÿè®¡">11.3 ç”¨æˆ·ç­¾åˆ°-ç­¾åˆ°ç»Ÿè®¡</h3>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-337.png" alt="img"></p>
<p>åœ¨UserControllerç±»ä¸­å†™å…¥å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">&quot;/sign/count&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="function">Result <span class="title">signCount</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">return</span> userService.<span class="title">signCount</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨IUserServiceç±»ä¸­å†™å…¥å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Result <span class="title">signCount</span>()</span>;</span><br></pre></td></tr></table></figure>
<p>åœ¨UserServiceImplç±»ä¸­å†™å…¥å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">public Result signCount() &#123;</span><br><span class="line">    <span class="comment">//1.è·å–å½“å‰ç™»å½•ç”¨æˆ·</span></span><br><span class="line">    Long userId = UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">//2.è·å–æ—¥æœŸ</span></span><br><span class="line">    LocalDateTime now = LocalDateTime.now();</span><br><span class="line">    <span class="comment">//3.æ‹¼æ¥key</span></span><br><span class="line">    <span class="built_in">String</span> keySuffix = now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyyMM&quot;</span>));</span><br><span class="line">    <span class="built_in">String</span> key = USER_SIGN_KEY + userId + keySuffix;</span><br><span class="line">    <span class="comment">//4.è·å–ä»Šå¤©æ˜¯æœ¬æœˆç¬¬å‡ å¤©</span></span><br><span class="line">    <span class="built_in">int</span> dayOfMonth = now.getDayOfMonth();</span><br><span class="line">    <span class="comment">//5.è·å–æœ¬æœˆæˆªæ­¢ä»Šå¤©ä¸ºæ­¢çš„æ‰€æœ‰çš„ç­¾åˆ°è®°å½•ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªåè¿›åˆ¶çš„æ•°å­— BITFIELD sign:5:202203 GET u14 0</span></span><br><span class="line">    <span class="built_in">List</span>&lt;Long&gt; result = stringRedisTemplate.opsForValue().bitField(</span><br><span class="line">            key, BitFieldSubCommands.create()</span><br><span class="line">                    .<span class="keyword">get</span>(BitFieldSubCommands.BitFieldType.unsigned(dayOfMonth)).valueAt(<span class="number">0</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span>(result==<span class="keyword">null</span> || result.isEmpty())&#123;</span><br><span class="line">        <span class="comment">//æ²¡æœ‰ä»»ä½•ç­¾åˆ°ç»“æœ</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Long <span class="built_in">num</span> = result.<span class="keyword">get</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">num</span>==<span class="keyword">null</span> || <span class="built_in">num</span>==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6.å¾ªç¯éå†</span></span><br><span class="line">    <span class="built_in">int</span> count=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">        <span class="comment">//6.1.è®©è¿™ä¸ªæ•°å­—ä¸1åšä¸è¿ç®—ï¼Œå¾—åˆ°æ•°å­—çš„æœ€åä¸€ä¸ªbitä½</span></span><br><span class="line">        <span class="keyword">if</span>((<span class="built_in">num</span>&amp;<span class="number">1</span>)==<span class="number">0</span>)&#123;<span class="comment">//6.2.åˆ¤æ–­è¿™ä¸ªbitä½æ˜¯å¦ä¸º0</span></span><br><span class="line">            <span class="comment">//6.3.å¦‚æœä¸º0ï¼Œè¯´æ˜æœªç­¾åˆ°ç»“æŸ</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//6.4.å¦‚æœä¸ä¸º0ï¼Œè¯´æ˜å·²ç­¾åˆ°ï¼Œè®¡æ•°å™¨+1</span></span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//6.5.æŠŠæ•°å­—å³ç§»ä¸€ä½ï¼ŒæŠ›å¼ƒæœ€åä¸€ä¸ªbitä½,ç»§ç»­ä¸‹ä¸€ä¸ªbitä½</span></span><br><span class="line">        <span class="built_in">num</span> &gt;&gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> Result.ok(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>æ­¥éª¤ 1</strong>ï¼šè·å–å½“å‰ç™»å½•ç”¨æˆ·çš„ IDã€‚</li>
<li><strong>æ­¥éª¤ 2</strong>ï¼šè·å–å½“å‰æ—¥æœŸã€‚</li>
<li><strong>æ­¥éª¤ 3</strong>ï¼šæ‹¼æ¥ Redis <code>key</code>ï¼Œæ ¼å¼ä¸º <code>USER_SIGN_KEY + userId + &quot;yyyyMM&quot;</code>ï¼Œç”¨äºæ ‡è¯†æ¯ä¸ªæœˆçš„ç­¾åˆ°æ•°æ®ã€‚</li>
<li><strong>æ­¥éª¤ 4</strong>ï¼šè·å–ä»Šå¤©æ˜¯æœ¬æœˆçš„ç¬¬å‡ å¤©ï¼Œå³ <code>dayOfMonth</code>ã€‚</li>
<li><strong>æ­¥éª¤ 5</strong>ï¼šä½¿ç”¨ <code>BITFIELD</code> å‘½ä»¤è·å–å½“å‰æœˆæˆªè‡³ä»Šå¤©çš„ç­¾åˆ°æ•°æ®ã€‚é€šè¿‡ <code>BitFieldSubCommands</code> è®¾ç½®è·å–ç­¾åˆ°ä¿¡æ¯çš„ä½æ•°ã€‚</li>
<li><strong>æ­¥éª¤ 6</strong>ï¼šéå†ç­¾åˆ°æ•°æ®ï¼Œé€šè¿‡ä½æ“ä½œï¼ˆä¸è¿ç®—ï¼‰ç»Ÿè®¡è¿ç»­ç­¾åˆ°çš„å¤©æ•°ã€‚</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-338-1024x449.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-339.png" alt="img"></p>
<p>11.4 é¢å¤–è¡¥å……-å…³äºä½¿ç”¨bitmapæ¥è§£å†³ç¼“å­˜ç©¿é€çš„æ–¹æ¡ˆ</p>
<p>å›é¡¾<strong>ç¼“å­˜ç©¿é€</strong>ï¼š</p>
<p><strong>ç¼“å­˜ç©¿é€é—®é¢˜æ¦‚è¿°</strong>ï¼š</p>
<ul>
<li>å…¸å‹çš„è§£å†³åŠæ³•æ˜¯ <strong>ç¼“å­˜ç©ºå€¼</strong>ï¼Œå³å½“æ•°æ®åº“æŸ¥è¯¢è¿”å›ç©ºæ•°æ®æ—¶ï¼Œå°†è¿™ä¸ªç©ºæ•°æ®ä¹Ÿå­˜å…¥ç¼“å­˜ï¼Œä»¥é˜²æ­¢ç›¸åŒçš„æ— æ•ˆæŸ¥è¯¢é¢‘ç¹è®¿é—®æ•°æ®åº“ã€‚</li>
<li><strong>ç¼“å­˜ç©¿é€</strong>æŒ‡çš„æ˜¯ç”¨æˆ·è¯·æ±‚çš„æ•°æ®æ—¢ä¸åœ¨ç¼“å­˜ä¸­ï¼Œä¹Ÿä¸åœ¨æ•°æ®åº“ä¸­ã€‚æ¯æ¬¡ç”¨æˆ·è¯·æ±‚çš„éƒ½å¯èƒ½æ˜¯ä¸€ä¸ªä¸å­˜åœ¨çš„æ•°æ®ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸æ–­è¯·æ±‚ä¸å­˜åœ¨çš„æ•°æ®æ¥ç»•è¿‡ç¼“å­˜ï¼Œç›´æ¥è®¿é—®æ•°æ®åº“ï¼Œé€ æˆæ•°æ®åº“è´Ÿæ‹…è¿‡é‡ã€‚</li>
</ul>
<p><strong>ä¼ ç»Ÿè§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<p>åœ¨ä¼ ç»Ÿè§£å†³æ–¹æ¡ˆä¸­ï¼Œå¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰æ•°æ®ï¼Œç¼“å­˜ä¸­ä¹Ÿæ²¡æœ‰ï¼Œæˆ‘ä»¬å°±ä¼šæŠŠè¯¥æ•°æ®æ ‡è®°ä¸ºç©ºå¹¶å­˜å…¥ç¼“å­˜ï¼Œè¿™æ ·ä¸‹ä¸€æ¬¡è¯·æ±‚è¯¥æ•°æ®æ—¶ç›´æ¥ä»ç¼“å­˜ä¸­è·å–ã€‚ä½†è¿™ä¸ªæ–¹æ³•å­˜åœ¨çš„é—®é¢˜æ˜¯ï¼š</p>
<ul>
<li>å¦‚æœæŸ¥è¯¢çš„æ˜¯ä¸åŒçš„ ID æ•°æ®ï¼Œç¼“å­˜ä¼šé€æ¸å˜å¾—éå¸¸å¤§ï¼Œå ç”¨è¾ƒå¤šå†…å­˜ã€‚</li>
<li>å¦‚æœè¯·æ±‚çš„æ˜¯æŸä¸ªä¸å­˜åœ¨çš„æ•°æ®ï¼Œç¼“å­˜æ— æ³•ä»ä¸€å¼€å§‹è§£å†³ã€‚</li>
</ul>
<p>æ‰€ä»¥æˆ‘ä»¬å¦‚ä½•è§£å†³å‘¢ï¼Ÿ</p>
<p>ä¸ºäº†æ›´æœ‰æ•ˆåœ°è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜å¹¶ä¼˜åŒ–å­˜å‚¨ç©ºé—´ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <strong>BitMap</strong> ä»£æ›¿ <strong>List</strong> æ¥å­˜å‚¨ ID æ•°æ®ã€‚</p>
<h4 id="æ€è·¯ï¼š"><strong>æ€è·¯</strong>ï¼š</h4>
<ol>
<li><strong>æ•°æ®å­˜å‚¨æ–¹å¼</strong>ï¼šå°†æ‰€æœ‰åˆæ³•çš„ ID å­˜å‚¨åˆ°ä¸€ä¸ªéå¸¸å¤§çš„ <strong>BitMap</strong> ä¸­ã€‚æ¯ä¸ª ID çš„ä½ç½®ï¼ˆå³ç´¢å¼•ï¼‰å¯¹åº”äº BitMap çš„æŸä¸€ä½ã€‚å½“ç”¨æˆ·è®¿é—®æŸä¸ª ID æ—¶ï¼Œæˆ‘ä»¬é€šè¿‡å“ˆå¸Œç®—æ³•ï¼ˆå¦‚ <code>id % bitmap.size</code>ï¼‰è®¡ç®—å‡ºè¯¥ ID åº”è¯¥å­˜å‚¨åœ¨ BitMap çš„å“ªä¸ªä½ç½®ï¼Œå¹¶å°†è¯¥ä½ç½®çš„å€¼è®¾ç½®ä¸º 1ï¼Œè¡¨ç¤ºè¯¥æ•°æ®å·²ç»å­˜åœ¨ã€‚</li>
<li><strong>æŸ¥è¯¢è¿‡ç¨‹</strong>ï¼šå½“ç”¨æˆ·æŸ¥è¯¢æŸä¸ªæ•°æ®æ—¶ï¼Œæˆ‘ä»¬åŒæ ·é€šè¿‡å“ˆå¸Œç®—æ³•è®¡ç®—è¯¥ ID åº”è¯¥è½åœ¨ BitMap çš„å“ªä¸ªä½ç½®ã€‚å¦‚æœè¯¥ä½ç½®çš„å€¼ä¸º 1ï¼Œè¡¨ç¤ºè¯¥æ•°æ®å­˜åœ¨ï¼›å¦‚æœä¸º 0ï¼Œåˆ™è¡¨ç¤ºè¯¥æ•°æ®ä¸å­˜åœ¨ï¼Œå¯ä»¥ç›´æ¥è¿”å›ï¼Œä¸è®¿é—®æ•°æ®åº“ã€‚</li>
</ol>
<h4 id="æ­¥éª¤ï¼š"><strong>æ­¥éª¤</strong>ï¼š</h4>
<ol>
<li>
<p>å°† ID æ•°æ®å­˜å‚¨åˆ° BitMap</p>
<p>ï¼šä¾‹å¦‚ï¼Œä½¿ç”¨ Redis çš„</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">SETBIT</span></span><br></pre></td></tr></table></figure>
<p>å‘½ä»¤å°†æŸä¸ª ID å¯¹åº”çš„ä½è®¾ç½®ä¸º</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1</span><br></pre></td></tr></table></figure>
<p>ï¼Œè¡¨ç¤ºè¯¥ ID å¯¹åº”çš„æ•°æ®å­˜åœ¨ã€‚</p>
<ul>
<li><code>SETBIT key offset 1</code>ï¼šè®¾ç½® <code>key</code> å¯¹åº”çš„ä½ï¼ˆç”± ID è®¡ç®—å¾—å‡ºï¼‰ä¸º 1ï¼Œè¡¨ç¤ºæ•°æ®å­˜åœ¨ã€‚</li>
</ul>
</li>
<li>
<p><strong>æŸ¥è¯¢æ—¶é€šè¿‡å“ˆå¸Œè®¡ç®—ä½ç½®</strong>ï¼šå½“ç”¨æˆ·è¯·æ±‚æŸä¸ª ID æ—¶ï¼Œä½¿ç”¨å“ˆå¸Œç®—æ³•ï¼ˆ<code>id % bitmap.size</code>ï¼‰è®¡ç®—å‡ºè¯¥ ID åœ¨ BitMap ä¸­çš„åç§»ä½ç½®ã€‚å¦‚æœè¯¥ä½ç½®ä¸º 1ï¼Œåˆ™è¡¨ç¤ºè¯¥æ•°æ®å­˜åœ¨ï¼Œåä¹‹ä¸º 0ï¼Œåˆ™è¯´æ˜è¯¥æ•°æ®ä¸å­˜åœ¨ã€‚</p>
</li>
</ol>
<h4 id="ä¼˜ç‚¹ï¼š"><strong>ä¼˜ç‚¹</strong>ï¼š</h4>
<ul>
<li><strong>èŠ‚çœå†…å­˜</strong>ï¼šBitMap åªç”¨ä¸€ä¸ªæ¯”ç‰¹ä½æ¥è¡¨ç¤ºä¸€ä¸ªæ•°æ®çš„å­˜åœ¨ä¸å¦ï¼Œç›¸æ¯” List æˆ– HashMap ç­‰æ•°æ®ç»“æ„ï¼Œå®ƒèƒ½å¤Ÿæ˜¾è‘—å‡å°‘å†…å­˜å ç”¨ã€‚</li>
<li><strong>é«˜æ•ˆæŸ¥è¯¢</strong>ï¼šBitMap çš„æŸ¥è¯¢æ“ä½œéå¸¸å¿«é€Ÿï¼Œé€šè¿‡ç›´æ¥è®¿é—®å¯¹åº”çš„ä½æ¥åˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨ï¼ŒæŸ¥è¯¢å¤æ‚åº¦ä¸º O(1)ã€‚</li>
</ul>
<h4 id="è¯¯å·®ç‡ï¼š"><strong>è¯¯å·®ç‡</strong>ï¼š</h4>
<p>ç”±äºä½¿ç”¨å“ˆå¸Œç®—æ³•æ¥æ˜ å°„ ID åˆ° BitMap ä¸­çš„ä½ï¼Œå› æ­¤å¯èƒ½ä¼šå‘ç”Ÿ <strong>å“ˆå¸Œå†²çª</strong>ã€‚å¦‚æœå¤šä¸ª ID è¢«æ˜ å°„åˆ° BitMap çš„åŒä¸€ä½ä¸Šï¼Œå¯èƒ½ä¼šå‡ºç°è¯¯åˆ¤çš„æƒ…å†µï¼ˆå³è®¤ä¸ºæŸä¸ªæ•°æ®å­˜åœ¨ï¼Œä½†å®é™…å¹¶ä¸å­˜åœ¨ï¼‰ã€‚è¿™ç§æƒ…å†µç§°ä¸ºè¯¯å·®ç‡ã€‚</p>
<p>è¯¯å·®ç‡ä¼šéšç€å“ˆå¸Œå†²çªçš„å¢åŠ è€Œå¢å¤§ï¼Œé€šå¸¸æˆ‘ä»¬å¯ä»¥é€šè¿‡å¢åŠ  BitMap çš„å¤§å°æ¥é™ä½è¯¯å·®ç‡ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-340-1024x260.png" alt="img"></p>
<ul>
<li>ç”¨æˆ·å‘èµ·è¯·æ±‚ï¼ŒæŸ¥è¯¢æŸä¸ªæ•°æ®ï¼ˆå¦‚ ID ä¸º 1ã€2ã€3 çš„æ•°æ®ï¼‰ã€‚</li>
<li>æ•°æ®è¢«å­˜å‚¨åˆ° Redis ä¸­ï¼Œé€šè¿‡ <code>List</code> å­˜å‚¨ ID æ•°æ®ã€‚æŸ¥è¯¢æ—¶ï¼Œé€šè¿‡æ£€æŸ¥ <code>List</code> æ˜¯å¦åŒ…å«å¯¹åº”çš„ ID æ•°æ®æ¥åˆ¤æ–­ç¼“å­˜æ˜¯å¦å‘½ä¸­ã€‚</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-341-1024x432.png" alt="img"></p>
<ul>
<li>å°† <code>List</code> æ•°æ®ç»“æ„æ›¿æ¢æˆ <code>BitMap</code>ï¼Œå¹¶ä½¿ç”¨å“ˆå¸Œç®—æ³•å°†æ¯ä¸ª ID æ˜ å°„åˆ° BitMap çš„æŸä¸€ä½ã€‚</li>
<li>ä½¿ç”¨ Redis çš„ BitMapï¼ˆ<code>SETBIT</code> å’Œ <code>GETBIT</code>ï¼‰æ“ä½œï¼Œå‡å°‘äº† <code>List</code> å­˜å‚¨ç©ºé—´ï¼Œå¹¶ä¸”æé«˜äº†æŸ¥è¯¢æ•ˆç‡ã€‚</li>
</ul>
<h4 id="å…·ä½“æ“ä½œï¼š"><strong>å…·ä½“æ“ä½œ</strong>ï¼š</h4>
<ul>
<li><strong>SETBIT</strong>ï¼šè®¾ç½®æŸä¸ªä½ä¸º <code>1</code>ï¼Œè¡¨ç¤ºæ•°æ®å­˜åœ¨ã€‚</li>
<li><strong>GETBIT</strong>ï¼šè·å–æŸä¸ªä½çš„å€¼ï¼Œåˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨ã€‚</li>
</ul>
<h2 id="12ã€UVç»Ÿè®¡">12ã€UVç»Ÿè®¡</h2>
<h3 id="12-1-ã€UVç»Ÿè®¡-HyperLogLog">12.1 ã€UVç»Ÿè®¡-HyperLogLog</h3>
<p>é¦–å…ˆæˆ‘ä»¬ææ‡‚ä¸¤ä¸ªæ¦‚å¿µï¼š</p>
<ul>
<li>UVï¼šå…¨ç§°Unique Visitorï¼Œä¹Ÿå«ç‹¬ç«‹è®¿å®¢é‡ï¼Œæ˜¯æŒ‡é€šè¿‡äº’è”ç½‘è®¿é—®ã€æµè§ˆè¿™ä¸ªç½‘é¡µçš„è‡ªç„¶äººã€‚1å¤©å†…åŒä¸€ä¸ªç”¨æˆ·å¤šæ¬¡è®¿é—®è¯¥ç½‘ç«™ï¼Œåªè®°å½•1æ¬¡ã€‚</li>
<li>PVï¼šå…¨ç§°Page Viewï¼Œä¹Ÿå«é¡µé¢è®¿é—®é‡æˆ–ç‚¹å‡»é‡ï¼Œç”¨æˆ·æ¯è®¿é—®ç½‘ç«™çš„ä¸€ä¸ªé¡µé¢ï¼Œè®°å½•1æ¬¡PVï¼Œç”¨æˆ·å¤šæ¬¡æ‰“å¼€é¡µé¢ï¼Œåˆ™è®°å½•å¤šæ¬¡PVã€‚å¾€å¾€ç”¨æ¥è¡¡é‡ç½‘ç«™çš„æµé‡ã€‚</li>
</ul>
<p>é€šå¸¸æ¥è¯´UVä¼šæ¯”PVå¤§å¾ˆå¤šï¼Œæ‰€ä»¥è¡¡é‡åŒä¸€ä¸ªç½‘ç«™çš„è®¿é—®é‡ï¼Œæˆ‘ä»¬éœ€è¦ç»¼åˆè€ƒè™‘å¾ˆå¤šå› ç´ ï¼Œæ‰€ä»¥æˆ‘ä»¬åªæ˜¯å•çº¯çš„æŠŠè¿™ä¸¤ä¸ªå€¼ä½œä¸ºä¸€ä¸ªå‚è€ƒå€¼</p>
<p>UVç»Ÿè®¡åœ¨æœåŠ¡ç«¯åšä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œå› ä¸ºè¦åˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯å¦å·²ç»ç»Ÿè®¡è¿‡äº†ï¼Œéœ€è¦å°†ç»Ÿè®¡è¿‡çš„ç”¨æˆ·ä¿¡æ¯ä¿å­˜ã€‚ä½†æ˜¯å¦‚æœæ¯ä¸ªè®¿é—®çš„ç”¨æˆ·éƒ½ä¿å­˜åˆ°Redisä¸­ï¼Œæ•°æ®é‡ä¼šéå¸¸ææ€–ï¼Œé‚£æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</p>
<p>Hyperloglog(HLL)æ˜¯ä»Loglogç®—æ³•æ´¾ç”Ÿçš„æ¦‚ç‡ç®—æ³•ï¼Œç”¨äºç¡®å®šéå¸¸å¤§çš„é›†åˆçš„åŸºæ•°ï¼Œè€Œä¸éœ€è¦å­˜å‚¨å…¶æ‰€æœ‰å€¼ã€‚ç›¸å…³ç®—æ³•åŸç†å¤§å®¶å¯ä»¥å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903785744056333#heading-0">https://juejin.cn/post/6844903785744056333#heading-0</a> Redisä¸­çš„HLLæ˜¯åŸºäºstringç»“æ„å®ç°çš„ï¼Œå•ä¸ªHLLçš„å†…å­˜<strong>æ°¸è¿œå°äº16kb</strong>ï¼Œ<strong>å†…å­˜å ç”¨ä½</strong>çš„ä»¤äººå‘æŒ‡ï¼ä½œä¸ºä»£ä»·ï¼Œå…¶æµ‹é‡ç»“æœæ˜¯æ¦‚ç‡æ€§çš„ï¼Œ<strong>æœ‰å°äº0.81ï¼…çš„è¯¯å·®</strong>ã€‚ä¸è¿‡å¯¹äºUVç»Ÿè®¡æ¥è¯´ï¼Œè¿™å®Œå…¨å¯ä»¥å¿½ç•¥ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-342-1024x356.png" alt="img"></p>
<p>ä¸è®ºæ·»åŠ å‡ æ¬¡ï¼Œæ°¸è¿œåªè®°å½•ä¸€æ¬¡ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-344.png" alt="img"></p>
<h3 id="12-2-UVç»Ÿè®¡-æµ‹è¯•ç™¾ä¸‡æ•°æ®çš„ç»Ÿè®¡">12.2 UVç»Ÿè®¡-æµ‹è¯•ç™¾ä¸‡æ•°æ®çš„ç»Ÿè®¡</h3>
<p>æµ‹è¯•æ€è·¯ï¼šæˆ‘ä»¬ç›´æ¥åˆ©ç”¨å•å…ƒæµ‹è¯•ï¼Œå‘HyperLogLogä¸­æ·»åŠ 100ä¸‡æ¡æ•°æ®ï¼Œçœ‹çœ‹å†…å­˜å ç”¨å’Œç»Ÿè®¡æ•ˆæœå¦‚ä½•</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-343-1024x506.png" alt="img"></p>
<p>ç»è¿‡æµ‹è¯•ï¼šæˆ‘ä»¬ä¼šå‘ç”Ÿä»–çš„è¯¯å·®æ˜¯åœ¨å…è®¸èŒƒå›´å†…ï¼Œå¹¶ä¸”å†…å­˜å ç”¨æå°</p>
<p>100ä¸‡æ•°æ®æˆåŠŸå†™å…¥ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-345-1024x556.png" alt="img"></p>
<p>æµ‹è¯•å‰ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-346.png" alt="img"></p>
<p>æµ‹è¯•åï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-347.png" alt="img"></p>
<p>å¤§çº¦å ç”¨11kbï¼Œç¡®å®æ˜¯å°äº16kbã€‚</p>
<h1 id="Redis-å®æˆ˜ç¯‡-é»‘é©¬ç‚¹è¯„-å®Œç»“">Redis(å®æˆ˜ç¯‡-é»‘é©¬ç‚¹è¯„) å®Œç»“</h1>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>Rediså®æˆ˜ç¯‡</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://itgeqian.github.io/posts/6.html">https://itgeqian.github.io/posts/6.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>ä½œè€…</h><div class="post-copyright-cc-info"><h>geqian's BlogğŸ­</h></div></div><div class="post-copyright-c"><h>å‘å¸ƒäº</h><div class="post-copyright-cc-info"><h>2024-09-14</h></div></div><div class="post-copyright-u"><h>æ›´æ–°äº</h><div class="post-copyright-cc-info"><h>2024-09-17</h></div></div><div class="post-copyright-c"><h>è®¸å¯åè®®</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Redis/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>Redis</a></div></div><link rel="stylesheet" href="/css/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">æŠ•å–‚ä½œè€…</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://java-geqian.oss-cn-beijing.aliyuncs.com/%E5%BE%AE%E4%BF%A1PAY.jpg" target="_blank"><img class="post-qr-code-img" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/%E5%BE%AE%E4%BF%A1PAY.jpg" alt="å¾®ä¿¡"/></a><div class="post-qr-code-desc">å¾®ä¿¡</div></li><li class="reward-item"><a href="https://java-geqian.oss-cn-beijing.aliyuncs.com/%E6%94%AF%E4%BB%98%E5%AE%9DPAY.jpg" target="_blank"><img class="post-qr-code-img" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/%E6%94%AF%E4%BB%98%E5%AE%9DPAY.jpg" alt="æ”¯ä»˜å®"/></a><div class="post-qr-code-desc">æ”¯ä»˜å®</div></li></ul></div></button></div><audio id="coinAudio" src="https://npm.elemecdn.com/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/js/coin.js"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/40.html"><img class="prev-cover" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/geqian-Blos/%E7%99%BD%E4%B8%9D%E8%83%A1%E6%A1%83.jpg" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">10åˆ†é’Ÿå­¦ä¼šSessionã€JWTã€Token</div></div></a></div><div class="next-post pull-right"><a href="/posts/5.html"><img class="next-cover" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/geqian-Blos/65.jpg" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">RedisåŸºç¡€ç¯‡</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/posts/73.html" title="Redisç›¸å…³é¢è¯•é¢˜"><img class="cover" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/geqian-Blos/20.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2025-10-09</div><div class="title">Redisç›¸å…³é¢è¯•é¢˜</div></div></a></div><div><a href="/posts/5.html" title="RedisåŸºç¡€ç¯‡"><img class="cover" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/geqian-Blos/65.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2024-09-12</div><div class="title">RedisåŸºç¡€ç¯‡</div></div></a></div><div><a href="/posts/35.html" title="Redisé¢è¯•ç¯‡"><img class="cover" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/geqian-Blos/66.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2025-08-08</div><div class="title">Redisé¢è¯•ç¯‡</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><svg class="meta_icon" style="width:22px;height:22px;position:relative;top:5px"><use xlink:href="#icon-mulu1"></use></svg><span style="font-weight:bold">ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E7%9F%AD%E4%BF%A1%E7%99%BB%E5%BD%95"><span class="toc-text">1ã€çŸ­ä¿¡ç™»å½•</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E3%80%81%E5%AF%BC%E5%85%A5%E9%BB%91%E9%A9%AC%E7%82%B9%E8%AF%84%E9%A1%B9%E7%9B%AE"><span class="toc-text">1.1ã€å¯¼å…¥é»‘é©¬ç‚¹è¯„é¡¹ç›®</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-1-%E3%80%81%E5%AF%BC%E5%85%A5SQL%EF%BC%88Mysql%E7%89%88%E6%9C%AC%E5%A4%A7%E4%BA%8E5-7%EF%BC%89"><span class="toc-text">1.1.1 ã€å¯¼å…¥SQLï¼ˆMysqlç‰ˆæœ¬å¤§äº5.7ï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-2%E3%80%81%E6%9C%89%E5%85%B3%E5%BD%93%E5%89%8D%E6%A8%A1%E5%9E%8B"><span class="toc-text">1.1.2ã€æœ‰å…³å½“å‰æ¨¡å‹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E3%80%81%E5%9F%BA%E4%BA%8ESession%E5%AE%9E%E7%8E%B0%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B"><span class="toc-text">1.2 ã€åŸºäºSessionå®ç°ç™»å½•æµç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3%E5%AE%9E%E7%8E%B0%E5%8F%91%E9%80%81%E7%9F%AD%E4%BF%A1%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-text">1.3å®ç°å‘é€çŸ­ä¿¡éªŒè¯ç </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E6%98%BE%E7%A4%BA%E7%99%BB%E5%BD%95%E6%8B%A6%E6%88%AA"><span class="toc-text">1.4 æ˜¾ç¤ºç™»å½•æ‹¦æˆª</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5"><span class="toc-text">1. å»ºç«‹è¿æ¥</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%88%86%E5%8F%91%E8%AF%B7%E6%B1%82"><span class="toc-text">2. åˆ†å‘è¯·æ±‚</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82"><span class="toc-text">3. å¤„ç†è¯·æ±‚</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E8%BF%94%E5%9B%9E%E5%93%8D%E5%BA%94"><span class="toc-text">4. è¿”å›å“åº”</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5%E3%80%81%E9%9A%90%E8%97%8F%E7%94%A8%E6%88%B7%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF"><span class="toc-text">1.5ã€éšè—ç”¨æˆ·æ•æ„Ÿä¿¡æ¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6%E3%80%81session%E5%85%B1%E4%BA%AB%E9%97%AE%E9%A2%98"><span class="toc-text">1.6ã€sessionå…±äº«é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7-Redis%E4%BB%A3%E6%9B%BFsession%E7%9A%84%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B"><span class="toc-text">1.7 Redisä»£æ›¿sessionçš„ä¸šåŠ¡æµç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-7-1%E5%9C%A8%E8%AE%BE%E8%AE%A1%E8%BF%99%E4%B8%AAkey%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E9%9C%80%E8%A6%81%E6%BB%A1%E8%B6%B3%E4%B8%A4%E7%82%B9"><span class="toc-text">1.7.1åœ¨è®¾è®¡è¿™ä¸ªkeyçš„æ—¶å€™ï¼Œéœ€è¦æ»¡è¶³ä¸¤ç‚¹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-7-2-%E6%95%B4%E4%BD%93%E8%AE%BF%E9%97%AE%E6%B5%81%E7%A8%8B"><span class="toc-text">1.7.2 æ•´ä½“è®¿é—®æµç¨‹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-8-%E5%9F%BA%E4%BA%8ERedis%E5%AE%9E%E7%8E%B0%E7%9F%AD%E4%BF%A1%E7%99%BB%E5%BD%95"><span class="toc-text">1.8 åŸºäºRediså®ç°çŸ­ä¿¡ç™»å½•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-9-%E8%A7%A3%E5%86%B3%E7%8A%B6%E6%80%81%E7%99%BB%E5%BD%95%E5%88%B7%E6%96%B0%E9%97%AE%E9%A2%98"><span class="toc-text">1.9 è§£å†³çŠ¶æ€ç™»å½•åˆ·æ–°é—®é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-9-1-%E5%88%9D%E5%A7%8B%E6%96%B9%E6%A1%88%E6%80%9D%E8%B7%AF%E6%80%BB%E7%BB%93%EF%BC%9A"><span class="toc-text">1.9.1 åˆå§‹æ–¹æ¡ˆæ€è·¯æ€»ç»“ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-9-2-%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88"><span class="toc-text">1.9.2 ä¼˜åŒ–æ–¹æ¡ˆ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-9-3-%E4%BB%A3%E7%A0%81"><span class="toc-text">1.9.3 ä»£ç </span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%95%86%E6%88%B7%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98"><span class="toc-text">2ã€å•†æˆ·æŸ¥è¯¢ç¼“å­˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1%E4%BB%80%E4%B9%88%E6%98%AF%E7%BC%93%E5%AD%98"><span class="toc-text">2.1ä»€ä¹ˆæ˜¯ç¼“å­˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E6%B7%BB%E5%8A%A0%E5%95%86%E6%88%B7%E7%BC%93%E5%AD%98"><span class="toc-text">2.2 æ·»åŠ å•†æˆ·ç¼“å­˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5"><span class="toc-text">2.3 ç¼“å­˜æ›´æ–°ç­–ç•¥</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%93%E5%AD%98%E4%B8%8D%E4%B8%80%E8%87%B4%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%EF%BC%9A"><span class="toc-text">2.3.1 æ•°æ®åº“ç¼“å­˜ä¸ä¸€è‡´è§£å†³æ–¹æ¡ˆï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%BC%93%E5%AD%98%E4%B8%8D%E4%B8%80%E8%87%B4%E9%87%87%E7%94%A8%E4%BB%80%E4%B9%88%E6%96%B9%E6%A1%88"><span class="toc-text">2.3.2 æ•°æ®åº“å’Œç¼“å­˜ä¸ä¸€è‡´é‡‡ç”¨ä»€ä¹ˆæ–¹æ¡ˆ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E5%AE%9E%E7%8E%B0%E5%95%86%E9%93%BA%E5%92%8C%E7%BC%93%E5%AD%98%E4%B8%8E%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8F%8C%E5%86%99%E4%B8%80%E8%87%B4"><span class="toc-text">2.4 å®ç°å•†é“ºå’Œç¼“å­˜ä¸æ•°æ®åº“åŒå†™ä¸€è‡´</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF"><span class="toc-text">2.5 ç¼“å­˜ç©¿é€é—®é¢˜çš„è§£å†³æ€è·¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-%E7%BC%96%E7%A0%81%E8%A7%A3%E5%86%B3%E5%95%86%E5%93%81%E6%9F%A5%E8%AF%A2%E7%9A%84%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E9%97%AE%E9%A2%98%EF%BC%9A"><span class="toc-text">2.6 ç¼–ç è§£å†³å•†å“æŸ¥è¯¢çš„ç¼“å­˜ç©¿é€é—®é¢˜ï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF"><span class="toc-text">2.7 ç¼“å­˜é›ªå´©é—®é¢˜åŠè§£å†³æ€è·¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E9%97%AE%E9%A2%98%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF"><span class="toc-text">2.8 ç¼“å­˜å‡»ç©¿é—®é¢˜åŠè§£å†³æ€è·¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9-%E5%88%A9%E7%94%A8%E4%BA%92%E6%96%A5%E9%94%81%E8%A7%A3%E5%86%B3%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E9%97%AE%E9%A2%98"><span class="toc-text">2.9 åˆ©ç”¨äº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-10-%E5%88%A9%E7%94%A8%E9%80%BB%E8%BE%91%E8%BF%87%E6%9C%9F%E8%A7%A3%E5%86%B3%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E9%97%AE%E9%A2%98"><span class="toc-text">2.10  åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-11-%E5%B0%81%E8%A3%85Redis-%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-text">2.11 å°è£…Redis å·¥å…·ç±»</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E4%BC%98%E6%83%A0%E5%8D%B7%E7%A7%92%E6%9D%80"><span class="toc-text">3ã€ä¼˜æƒ å·ç§’æ€</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%85%A8%E5%B1%80%E5%94%AF%E4%B8%80ID"><span class="toc-text">3.1 -å…¨å±€å”¯ä¸€ID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Redis%E5%AE%9E%E7%8E%B0%E5%85%A8%E5%B1%80%E5%94%AF%E4%B8%80Id"><span class="toc-text">3.2 -Rediså®ç°å…¨å±€å”¯ä¸€Id</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%A7%A9-%E4%B8%8E%E5%85%B6%E4%BB%96-ID-%E7%94%9F%E6%88%90%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94"><span class="toc-text">ğŸ§© ä¸å…¶ä»– ID ç”Ÿæˆæ–¹æ¡ˆå¯¹æ¯”</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E6%B7%BB%E5%8A%A0%E4%BC%98%E6%83%A0%E5%8D%B7"><span class="toc-text">3.3 æ·»åŠ ä¼˜æƒ å·</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E5%AE%9E%E7%8E%B0%E7%A7%92%E6%9D%80%E4%B8%8B%E5%8D%95"><span class="toc-text">3.4 å®ç°ç§’æ€ä¸‹å•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E5%BA%93%E5%AD%98%E8%B6%85%E5%8D%96%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-text">3.5 åº“å­˜è¶…å–é—®é¢˜åˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-%E4%B9%90%E8%A7%82%E9%94%81%E8%A7%A3%E5%86%B3%E8%B6%85%E5%8D%96%E9%97%AE%E9%A2%98"><span class="toc-text">3.6 ä¹è§‚é”è§£å†³è¶…å–é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7%E4%BC%98%E6%83%A0%E5%88%B8%E7%A7%92%E6%9D%80-%E4%B8%80%E4%BA%BA%E4%B8%80%E5%8D%95"><span class="toc-text">3.7ä¼˜æƒ åˆ¸ç§’æ€-ä¸€äººä¸€å•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%81-%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-text">ğŸ” äº‹åŠ¡æ§åˆ¶æ³¨æ„äº‹é¡¹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#createVoucherOrder-%E6%96%B9%E6%B3%95%EF%BC%88%E7%9C%9F%E6%AD%A3%E5%88%9B%E5%BB%BA%E8%AE%A2%E5%8D%95%E7%9A%84%E9%80%BB%E8%BE%91%EF%BC%8C%E5%B8%A6%E4%BA%8B%E5%8A%A1%EF%BC%89"><span class="toc-text">createVoucherOrder() æ–¹æ³•ï¼ˆçœŸæ­£åˆ›å»ºè®¢å•çš„é€»è¾‘ï¼Œå¸¦äº‹åŠ¡ï¼‰</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8-%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98"><span class="toc-text">3.8 é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E6%9C%BA%E4%B8%8B%E7%9A%84%E9%94%81%E6%8E%A7%E5%88%B6%EF%BC%88%E7%AC%AC%E4%B8%80%E5%BC%A0%E5%9B%BE%EF%BC%89"><span class="toc-text">å•æœºä¸‹çš„é”æ§åˆ¶ï¼ˆç¬¬ä¸€å¼ å›¾ï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9C%85-%E5%85%B3%E9%94%AE%E6%B5%81%E7%A8%8B%EF%BC%9A"><span class="toc-text">âœ… å…³é”®æµç¨‹ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%9C%85-%E7%BB%93%E8%AE%BA%EF%BC%9A"><span class="toc-text">âœ… ç»“è®ºï¼š</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%9D%8C-%E9%9B%86%E7%BE%A4%E4%B8%8B%E7%9A%84%E9%94%81%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98%EF%BC%88%E7%AC%AC%E4%BA%8C%E5%BC%A0%E5%9B%BE%EF%BC%89"><span class="toc-text">âŒ é›†ç¾¤ä¸‹çš„é”å¤±æ•ˆé—®é¢˜ï¼ˆç¬¬äºŒå¼ å›¾ï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B7%A6%E4%BE%A7%EF%BC%9AJVM1%EF%BC%88Tomcat-A%EF%BC%89"><span class="toc-text">å·¦ä¾§ï¼šJVM1ï¼ˆTomcat Aï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%B3%E4%BE%A7%EF%BC%9AJVM2%EF%BC%88Tomcat-B%EF%BC%89"><span class="toc-text">å³ä¾§ï¼šJVM2ï¼ˆTomcat Bï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%A7%A8-%E9%97%AE%E9%A2%98%E4%BA%A7%E7%94%9F%EF%BC%9A"><span class="toc-text">ğŸ§¨ é—®é¢˜äº§ç”Ÿï¼š</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-text">4ã€åˆ†å¸ƒå¼é”</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E3%80%81%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86%E5%92%8C%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F%E5%AF%B9%E6%AF%94"><span class="toc-text">4.1 ã€åŸºæœ¬åŸç†å’Œå®ç°æ–¹å¼å¯¹æ¯”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E3%80%81Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%A0%B8%E5%BF%83%E6%80%9D%E8%B7%AF"><span class="toc-text">4.2 ã€Redisåˆ†å¸ƒå¼é”çš„å®ç°æ ¸å¿ƒæ€è·¯</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1%E5%AE%9E%E7%8E%B0-Redis-%E9%94%81%E6%9C%80%E6%A0%B8%E5%BF%83%E7%9A%84%E5%B0%B1%E4%B8%A4%E4%B8%AA%E6%8C%87%E4%BB%A4%EF%BC%9A"><span class="toc-text">4.2.1å®ç° Redis é”æœ€æ ¸å¿ƒçš„å°±ä¸¤ä¸ªæŒ‡ä»¤ï¼š</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-DEL%EF%BC%9A%E9%87%8A%E6%94%BE%E9%94%81"><span class="toc-text">2. DELï¼šé‡Šæ”¾é”</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2%E8%AE%BE%E7%BD%AE%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4%EF%BC%8C%E9%81%BF%E5%85%8D%E6%AD%BB%E9%94%81"><span class="toc-text">4.2.2è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé¿å…æ­»é”</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%8A%A0-EXPIRE%EF%BC%9F"><span class="toc-text">ä¸ºä»€ä¹ˆéœ€è¦åŠ  EXPIREï¼Ÿ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-3%E9%81%BF%E5%85%8D-SETNX-%E5%92%8C-EXPIRE-%E4%B9%8B%E9%97%B4%E7%9A%84%E9%97%B4%E9%9A%99"><span class="toc-text">4.2.3é¿å… SETNX å’Œ EXPIRE ä¹‹é—´çš„é—´éš™</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-4%E5%8A%A0%E9%94%81%E4%B8%8E%E9%87%8A%E6%94%BE%E7%9A%84%E6%AD%A3%E7%A1%AE%E6%B5%81%E7%A8%8B%E6%80%BB%E7%BB%93"><span class="toc-text">4.2.4åŠ é”ä¸é‡Šæ”¾çš„æ­£ç¡®æµç¨‹æ€»ç»“</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%89%88%E6%9C%AC%E4%B8%80"><span class="toc-text">4.3 å®ç°åˆ†å¸ƒå¼é”ç‰ˆæœ¬ä¸€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%86%E8%8A%82%E8%A7%A3%E9%87%8A%EF%BC%9A"><span class="toc-text">ç»†èŠ‚è§£é‡Šï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E8%AF%AF%E5%88%A0%E6%83%85%E5%86%B5%E8%AF%B4%E6%98%8E"><span class="toc-text">4.4Redisåˆ†å¸ƒå¼é”è¯¯åˆ æƒ…å†µè¯´æ˜</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%BE%E4%B8%AD%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3"><span class="toc-text">å›¾ä¸­æµç¨‹è¯¦è§£</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%96%B6-%E7%BA%BF%E7%A8%8B1%EF%BC%9A"><span class="toc-text">â–¶ çº¿ç¨‹1ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%96%B6-%E7%BA%BF%E7%A8%8B2%EF%BC%9A"><span class="toc-text">â–¶ çº¿ç¨‹2ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E2%96%B6-%E9%97%AE%E9%A2%98%E6%9D%A5%E4%BA%86%EF%BC%9A"><span class="toc-text">â–¶ é—®é¢˜æ¥äº†ï¼š</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E8%A7%A3%E5%86%B3Redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E8%AF%AF%E5%88%A0%E9%97%AE%E9%A2%98"><span class="toc-text">4.5 è§£å†³Redisåˆ†å¸ƒå¼é”è¯¯åˆ é—®é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%8E%9F%E5%AD%90%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-text">4.6 åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E9%97%AE%E9%A2%98%EF%BC%9A%E5%88%A4%E6%96%AD-%E5%88%A0%E9%99%A4%E4%B8%8D%E6%98%AF%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C"><span class="toc-text">å…³é”®é—®é¢˜ï¼šåˆ¤æ–­ + åˆ é™¤ä¸æ˜¯åŸå­æ“ä½œ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-7-Lua%E8%84%9A%E6%9C%AC%E8%A7%A3%E5%86%B3%E5%A4%9A%E6%9D%A1%E5%91%BD%E4%BB%A4%E5%8E%9F%E5%AD%90%E6%80%A7%E9%97%AE%E9%A2%98"><span class="toc-text">4.7 Luaè„šæœ¬è§£å†³å¤šæ¡å‘½ä»¤åŸå­æ€§é—®é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E7%94%A8-Lua%EF%BC%9F"><span class="toc-text">ä¸ºä»€ä¹ˆç”¨ Luaï¼Ÿ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-7-1Lua-%E8%84%9A%E6%9C%AC%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-text">4.7.1Lua è„šæœ¬åŸºæœ¬è¯­æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-7-2-%E4%BD%BF%E7%94%A8-EVAL-%E8%B0%83%E7%94%A8%E8%84%9A%E6%9C%AC"><span class="toc-text">4.7.2 ä½¿ç”¨ EVAL è°ƒç”¨è„šæœ¬</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-7-3-%E5%8F%82%E6%95%B0%E5%8A%A8%E6%80%81%E4%BC%A0%E5%85%A5%E6%96%B9%E5%BC%8F"><span class="toc-text">4.7.3. å‚æ•°åŠ¨æ€ä¼ å…¥æ–¹å¼</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E4%B8%80%E5%8F%A5%E8%AF%9D"><span class="toc-text">æ€»ç»“ä¸€å¥è¯</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-8-%E5%88%A9%E7%94%A8Java%E4%BB%A3%E7%A0%81%E8%B0%83%E7%94%A8Lua%E8%84%9A%E6%9C%AC%E6%94%B9%E9%80%A0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-text">4.8 åˆ©ç”¨Javaä»£ç è°ƒç”¨Luaè„šæœ¬æ”¹é€ åˆ†å¸ƒå¼é”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E%EF%BC%9A"><span class="toc-text">è¯´æ˜ï¼š</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-redission"><span class="toc-text">5ã€åˆ†å¸ƒå¼é”-redission</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-redission%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D"><span class="toc-text">5.1 åˆ†å¸ƒå¼é”-redissionåŠŸèƒ½ä»‹ç»</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93%E4%B8%80%E5%8F%A5%E8%AF%9D%EF%BC%9A"><span class="toc-text">æ€»ç»“ä¸€å¥è¯ï¼š</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-Redission%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-text">5.2 åˆ†å¸ƒå¼é”-Redissionå¿«é€Ÿå…¥é—¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E%EF%BC%9A-2"><span class="toc-text">è¯´æ˜ï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B4%E6%98%8E%EF%BC%9A-3"><span class="toc-text">è¯´æ˜ï¼š</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-redission%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81%E5%8E%9F%E7%90%86"><span class="toc-text">5.3 åˆ†å¸ƒå¼é”-redissionå¯é‡å…¥é”åŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-1%E9%87%8D%E5%85%A5%E9%94%81%E7%9A%84%E6%A6%82%E5%BF%B5%EF%BC%88%E6%9C%AC%E5%9C%B0%E9%94%81%E5%92%8C%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E9%80%9A%E7%94%A8%EF%BC%89"><span class="toc-text">5.3.1é‡å…¥é”çš„æ¦‚å¿µï¼ˆæœ¬åœ°é”å’Œåˆ†å¸ƒå¼é”é€šç”¨ï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-2%E6%9C%AC%E5%9C%B0%E9%94%81%EF%BC%88%E5%A6%82-Java-ReentrantLock%EF%BC%89%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6"><span class="toc-text">5.3.2æœ¬åœ°é”ï¼ˆå¦‚ Java ReentrantLockï¼‰çš„å®ç°æœºåˆ¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3-3Redisson-%E5%8F%AF%E9%87%8D%E5%85%A5%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">5.3.3Redisson å¯é‡å…¥åˆ†å¸ƒå¼é”å®ç°åŸç†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Redis-%E4%B8%AD%E5%A6%82%E4%BD%95%E5%AD%98%E5%82%A8%E9%94%81%EF%BC%9F"><span class="toc-text">1. Redis ä¸­å¦‚ä½•å­˜å‚¨é”ï¼Ÿ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-redission%E9%94%81%E9%87%8D%E8%AF%95%E5%92%8CWatchDog%E6%9C%BA%E5%88%B6"><span class="toc-text">5.4 åˆ†å¸ƒå¼é”-redissioné”é‡è¯•å’ŒWatchDogæœºåˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-1Redisson-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E4%B8%AD-tryLock-%E9%87%8D%E8%AF%95-WatchDog-%E8%87%AA%E5%8A%A8%E7%BB%AD%E6%9C%9F%E7%9A%84%E6%BA%90%E7%A0%81%E6%9C%BA%E5%88%B6%E3%80%82"><span class="toc-text">5.4.1Redisson åˆ†å¸ƒå¼é”ä¸­ tryLock é‡è¯• + WatchDog è‡ªåŠ¨ç»­æœŸçš„æºç æœºåˆ¶ã€‚</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E9%94%81%E9%80%BB%E8%BE%91%E6%80%BB%E7%BB%93%EF%BC%9A"><span class="toc-text">åŠ é”é€»è¾‘æ€»ç»“ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E9%94%81%E9%80%BB%E8%BE%91%EF%BC%9A"><span class="toc-text">è§£é”é€»è¾‘ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-2Redisson-%E7%9A%84%E4%B8%A4%E7%A7%8D%E5%8A%A0%E9%94%81%E6%96%B9%E5%BC%8F"><span class="toc-text">5.4.2Redisson çš„ä¸¤ç§åŠ é”æ–¹å¼</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-3lock-%E5%8A%A0%E9%94%81%E6%B5%81%E7%A8%8B%E5%9B%9E%E9%A1%BE"><span class="toc-text">5.4.3lock() åŠ é”æµç¨‹å›é¡¾</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-4%E4%B8%89%E7%A7%8D%E5%8A%A0%E9%94%81%E5%9C%BA%E6%99%AF%E9%80%BB%E8%BE%91%E5%88%A4%E6%96%AD%EF%BC%88tryAcquire-%E5%86%85%E9%83%A8%EF%BC%89"><span class="toc-text">5.4.4ä¸‰ç§åŠ é”åœºæ™¯é€»è¾‘åˆ¤æ–­ï¼ˆtryAcquire å†…éƒ¨ï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-5-%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6%EF%BC%88%E5%BE%AA%E7%8E%AF%E6%8A%A2%E9%94%81%EF%BC%89"><span class="toc-text">5.4.5 é‡è¯•æœºåˆ¶ï¼ˆå¾ªç¯æŠ¢é”ï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-6-%E7%9C%8B%E9%97%A8%E7%8B%97%E6%9C%BA%E5%88%B6%EF%BC%88WatchDog%EF%BC%89"><span class="toc-text">5.4.6 çœ‹é—¨ç‹—æœºåˆ¶ï¼ˆWatchDogï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%9A"><span class="toc-text">é€‚ç”¨åœºæ™¯ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-7-%E7%BB%AD%E7%BA%A6%E6%9C%BA%E5%88%B6%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%88renewExpiration%EF%BC%89"><span class="toc-text">5.4.7 ç»­çº¦æœºåˆ¶æºç åˆ†æï¼ˆrenewExpirationï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E8%BF%87%E7%A8%8B%EF%BC%9A"><span class="toc-text">æ•´ä½“è¿‡ç¨‹ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-8-%E6%80%BB%E7%BB%93%EF%BC%9ARedisson-%E9%94%81%E7%9A%84%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6"><span class="toc-text">5.4.8 æ€»ç»“ï¼šRedisson é”çš„æ ¸å¿ƒæœºåˆ¶</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-redission%E9%94%81%E7%9A%84MutiLock%E5%8E%9F%E7%90%86"><span class="toc-text">5.5 åˆ†å¸ƒå¼é”-redissioné”çš„MutiLockåŸç†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MultiLock-%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86%EF%BC%9A"><span class="toc-text">MultiLock æ ¸å¿ƒåŸç†ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E6%88%90%E5%8A%9F%E5%88%A4%E5%AE%9A%E6%9D%A1%E4%BB%B6%EF%BC%9A"><span class="toc-text">5. æˆåŠŸåˆ¤å®šæ¡ä»¶ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E5%A6%82%E6%9E%9C%E6%9C%89%E9%94%81%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%9B%9E%E6%BB%9A%E6%89%80%E6%9C%89%E5%B7%B2%E8%8E%B7%E5%8F%96%E7%9A%84%E9%94%81%EF%BC%9A"><span class="toc-text">6. å¦‚æœæœ‰é”å¤±è´¥ï¼Œå›æ»šæ‰€æœ‰å·²è·å–çš„é”ï¼š</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81%E7%A7%92%E6%9D%80%E4%BC%98%E5%8C%96"><span class="toc-text">6ã€ç§’æ€ä¼˜åŒ–</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E7%A7%92%E6%9D%80%E4%BC%98%E5%8C%96-%E5%BC%82%E6%AD%A5%E7%A7%92%E6%9D%80%E6%80%9D%E8%B7%AF"><span class="toc-text">6.1 ç§’æ€ä¼˜åŒ–-å¼‚æ­¥ç§’æ€æ€è·¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E7%A7%92%E6%9D%80%E4%BC%98%E5%8C%96-Redis%E5%AE%8C%E6%88%90%E7%A7%92%E6%9D%80%E8%B5%84%E6%A0%BC%E5%88%A4%E6%96%AD"><span class="toc-text">6.2 ç§’æ€ä¼˜åŒ–-Rediså®Œæˆç§’æ€èµ„æ ¼åˆ¤æ–­</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E4%B8%80%E4%B8%8B%E8%BF%99%E4%B8%AAlua%E8%84%9A%E6%AD%A5"><span class="toc-text">è§£æä¸€ä¸‹è¿™ä¸ªluaè„šæ­¥</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E7%A7%92%E6%9D%80%E4%BC%98%E5%8C%96-%E5%9F%BA%E4%BA%8E%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97%E5%AE%9E%E7%8E%B0%E7%A7%92%E6%9D%80%E4%BC%98%E5%8C%96"><span class="toc-text">6.3 ç§’æ€ä¼˜åŒ–-åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€ä¼˜åŒ–</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7%E3%80%81Redis%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">7ã€Redisæ¶ˆæ¯é˜Ÿåˆ—</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-Redis%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-%E8%AE%A4%E8%AF%86%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">7.1 Redisæ¶ˆæ¯é˜Ÿåˆ—-è®¤è¯†æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-Redis%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-%E5%9F%BA%E4%BA%8EList%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">7.2 Redisæ¶ˆæ¯é˜Ÿåˆ—-åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E7%82%B9%EF%BC%9A"><span class="toc-text">å…³é”®ç‚¹ï¼š</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-Redis%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-%E5%9F%BA%E4%BA%8EPubSub%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">7.3 Redisæ¶ˆæ¯é˜Ÿåˆ—-åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-4-Redis%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-%E5%9F%BA%E4%BA%8EStream%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97"><span class="toc-text">7.4 Redisæ¶ˆæ¯é˜Ÿåˆ—-åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-5-Redis%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-%E5%9F%BA%E4%BA%8EStream%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97-%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84"><span class="toc-text">7.5 Redisæ¶ˆæ¯é˜Ÿåˆ—-åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-6-%E5%9F%BA%E4%BA%8ERedis%E7%9A%84Stream%E7%BB%93%E6%9E%84%E4%BD%9C%E4%B8%BA%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%8C%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5%E7%A7%92%E6%9D%80%E4%B8%8B%E5%8D%95"><span class="toc-text">7.6 åŸºäºRedisçš„Streamç»“æ„ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ç°å¼‚æ­¥ç§’æ€ä¸‹å•</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8%E3%80%81%E8%BE%BE%E4%BA%BA%E6%8E%A2%E5%BA%97"><span class="toc-text">8ã€è¾¾äººæ¢åº—</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1%E3%80%81%E8%BE%BE%E4%BA%BA%E6%8E%A2%E5%BA%97-%E5%8F%91%E5%B8%83%E6%8E%A2%E5%BA%97%E7%AC%94%E8%AE%B0"><span class="toc-text">8.1ã€è¾¾äººæ¢åº—-å‘å¸ƒæ¢åº—ç¬”è®°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E8%BE%BE%E4%BA%BA%E6%8E%A2%E5%BA%97-%E6%9F%A5%E7%9C%8B%E6%8E%A2%E5%BA%97%E7%AC%94%E8%AE%B0"><span class="toc-text">8.2 è¾¾äººæ¢åº—-æŸ¥çœ‹æ¢åº—ç¬”è®°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-%E8%BE%BE%E4%BA%BA%E6%8E%A2%E5%BA%97-%E7%82%B9%E8%B5%9E%E5%8A%9F%E8%83%BD"><span class="toc-text">8.3 è¾¾äººæ¢åº—-ç‚¹èµåŠŸèƒ½</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-%E8%BE%BE%E4%BA%BA%E6%8E%A2%E5%BA%97-%E7%82%B9%E8%B5%9E%E6%8E%92%E8%A1%8C%E6%A6%9C"><span class="toc-text">8.4 è¾¾äººæ¢åº—-ç‚¹èµæ’è¡Œæ¦œ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9%E3%80%81%E5%A5%BD%E5%8F%8B%E5%85%B3%E6%B3%A8"><span class="toc-text">9ã€å¥½å‹å…³æ³¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-%E5%A5%BD%E5%8F%8B%E5%85%B3%E6%B3%A8-%E5%85%B3%E6%B3%A8%E5%92%8C%E5%8F%96%E6%B6%88%E5%85%B3%E6%B3%A8"><span class="toc-text">9.1 å¥½å‹å…³æ³¨-å…³æ³¨å’Œå–æ¶ˆå…³æ³¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-%E5%A5%BD%E5%8F%8B%E5%85%B3%E6%B3%A8-%E5%85%B1%E5%90%8C%E5%85%B3%E6%B3%A8"><span class="toc-text">9.2 å¥½å‹å…³æ³¨-å…±åŒå…³æ³¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-%E5%A5%BD%E5%8F%8B%E5%85%B3%E6%B3%A8-Feed%E6%B5%81%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88"><span class="toc-text">9.3 å¥½å‹å…³æ³¨-Feedæµå®ç°æ–¹æ¡ˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Feed%E6%B5%81%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%A8%A1%E5%BC%8F%EF%BC%9A"><span class="toc-text">Feedæµçš„ä¸¤ç§æ¨¡å¼ï¼š</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-4-%E5%A5%BD%E5%8F%8B%E5%85%B3%E6%B3%A8-%E6%8E%A8%E9%80%81%E5%88%B0%E7%B2%89%E4%B8%9D%E6%94%B6%E4%BB%B6%E7%AE%B1"><span class="toc-text">9.4 å¥½å‹å…³æ³¨-æ¨é€åˆ°ç²‰ä¸æ”¶ä»¶ç®±</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-5%E5%A5%BD%E5%8F%8B%E5%85%B3%E6%B3%A8-%E5%AE%9E%E7%8E%B0%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2%E6%94%B6%E9%82%AE%E7%AE%B1%E7%9A%84%E6%80%9D%E8%B7%AF"><span class="toc-text">9.5å¥½å‹å…³æ³¨-å®ç°åˆ†é¡µæŸ¥è¯¢æ”¶é‚®ç®±çš„æ€è·¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-6%E5%A5%BD%E5%8F%8B%E5%85%B3%E6%B3%A8-%E5%AE%9E%E7%8E%B0%E6%BB%9A%E5%8A%A8%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2"><span class="toc-text">9.6å¥½å‹å…³æ³¨-å®ç°æ»šåŠ¨åˆ†é¡µæŸ¥è¯¢</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10%E3%80%81%E9%99%84%E8%BF%91%E5%95%86%E6%88%B7"><span class="toc-text">10ã€é™„è¿‘å•†æˆ·</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1%E3%80%81%E9%99%84%E8%BF%91%E5%95%86%E6%88%B7-GEO%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="toc-text">10.1ã€é™„è¿‘å•†æˆ·-GEOæ•°æ®ç»“æ„çš„åŸºæœ¬ç”¨æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-2%E3%80%81-%E9%99%84%E8%BF%91%E5%95%86%E6%88%B7-%E5%AF%BC%E5%85%A5%E5%BA%97%E9%93%BA%E6%95%B0%E6%8D%AE%E5%88%B0GEO"><span class="toc-text">10.2ã€ é™„è¿‘å•†æˆ·-å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%9F%A5%E8%AF%A2%E5%95%86%E6%88%B7%E4%BF%A1%E6%81%AF%EF%BC%9A"><span class="toc-text">1. æŸ¥è¯¢å•†æˆ·ä¿¡æ¯ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%B0%86%E5%95%86%E6%88%B7%E6%95%B0%E6%8D%AE%E5%88%86%E6%89%B9%E5%86%99%E5%85%A5-Redis%EF%BC%9A"><span class="toc-text">3. å°†å•†æˆ·æ•°æ®åˆ†æ‰¹å†™å…¥ Redisï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E-Redis-GEO-%E7%9A%84%E5%AD%98%E5%82%A8%E5%92%8C%E6%9F%A5%E8%AF%A2%EF%BC%9A"><span class="toc-text">å…³äº Redis GEO çš„å­˜å‚¨å’ŒæŸ¥è¯¢ï¼š</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-%E9%99%84%E8%BF%91%E5%95%86%E6%88%B7-%E5%AE%9E%E7%8E%B0%E9%99%84%E8%BF%91%E5%95%86%E6%88%B7%E5%8A%9F%E8%83%BD"><span class="toc-text">10.3 é™„è¿‘å•†æˆ·-å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-1%EF%BC%9A%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E9%9C%80%E8%A6%81%E6%A0%B9%E6%8D%AE%E5%9D%90%E6%A0%87%E6%9F%A5%E8%AF%A2"><span class="toc-text">æ­¥éª¤ 1ï¼šåˆ¤æ–­æ˜¯å¦éœ€è¦æ ¹æ®åæ ‡æŸ¥è¯¢</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-2%EF%BC%9A%E8%AE%A1%E7%AE%97%E5%88%86%E9%A1%B5%E5%8F%82%E6%95%B0"><span class="toc-text">æ­¥éª¤ 2ï¼šè®¡ç®—åˆ†é¡µå‚æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-3%EF%BC%9A%E6%9F%A5%E8%AF%A2-Redis-%E4%B8%AD%E7%9A%84%E5%95%86%E6%88%B7%E6%95%B0%E6%8D%AE"><span class="toc-text">æ­¥éª¤ 3ï¼šæŸ¥è¯¢ Redis ä¸­çš„å•†æˆ·æ•°æ®</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-4%EF%BC%9A%E8%A7%A3%E6%9E%90%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C"><span class="toc-text">æ­¥éª¤ 4ï¼šè§£ææŸ¥è¯¢ç»“æœ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-5%EF%BC%9A%E6%A0%B9%E6%8D%AE%E5%95%86%E6%88%B7-ID-%E6%9F%A5%E8%AF%A2%E5%95%86%E6%88%B7%E8%AF%A6%E6%83%85"><span class="toc-text">æ­¥éª¤ 5ï¼šæ ¹æ®å•†æˆ· ID æŸ¥è¯¢å•†æˆ·è¯¦æƒ…</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4-6%EF%BC%9A%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C"><span class="toc-text">æ­¥éª¤ 6ï¼šè¿”å›ç»“æœ</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11%E3%80%81%E7%94%A8%E6%88%B7%E7%AD%BE%E5%88%B0"><span class="toc-text">11ã€ç”¨æˆ·ç­¾åˆ°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-1%E3%80%81%E7%94%A8%E6%88%B7%E7%AD%BE%E5%88%B0-BitMap%E5%8A%9F%E8%83%BD%E6%BC%94%E7%A4%BA"><span class="toc-text">11.1ã€ç”¨æˆ·ç­¾åˆ°-BitMapåŠŸèƒ½æ¼”ç¤º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-2-%E3%80%81%E7%94%A8%E6%88%B7%E7%AD%BE%E5%88%B0-%E5%AE%9E%E7%8E%B0%E7%AD%BE%E5%88%B0%E5%8A%9F%E8%83%BD"><span class="toc-text">11.2 ã€ç”¨æˆ·ç­¾åˆ°-å®ç°ç­¾åˆ°åŠŸèƒ½</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-3-%E7%94%A8%E6%88%B7%E7%AD%BE%E5%88%B0-%E7%AD%BE%E5%88%B0%E7%BB%9F%E8%AE%A1"><span class="toc-text">11.3 ç”¨æˆ·ç­¾åˆ°-ç­¾åˆ°ç»Ÿè®¡</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%EF%BC%9A"><span class="toc-text">æ€è·¯ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4%EF%BC%9A"><span class="toc-text">æ­¥éª¤ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E7%82%B9%EF%BC%9A"><span class="toc-text">ä¼˜ç‚¹ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%AF%E5%B7%AE%E7%8E%87%EF%BC%9A"><span class="toc-text">è¯¯å·®ç‡ï¼š</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E6%93%8D%E4%BD%9C%EF%BC%9A"><span class="toc-text">å…·ä½“æ“ä½œï¼š</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12%E3%80%81UV%E7%BB%9F%E8%AE%A1"><span class="toc-text">12ã€UVç»Ÿè®¡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#12-1-%E3%80%81UV%E7%BB%9F%E8%AE%A1-HyperLogLog"><span class="toc-text">12.1 ã€UVç»Ÿè®¡-HyperLogLog</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#12-2-UV%E7%BB%9F%E8%AE%A1-%E6%B5%8B%E8%AF%95%E7%99%BE%E4%B8%87%E6%95%B0%E6%8D%AE%E7%9A%84%E7%BB%9F%E8%AE%A1"><span class="toc-text">12.2 UVç»Ÿè®¡-æµ‹è¯•ç™¾ä¸‡æ•°æ®çš„ç»Ÿè®¡</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis-%E5%AE%9E%E6%88%98%E7%AF%87-%E9%BB%91%E9%A9%AC%E7%82%B9%E8%AF%84-%E5%AE%8C%E7%BB%93"><span class="toc-text">Redis(å®æˆ˜ç¯‡-é»‘é©¬ç‚¹è¯„) å®Œç»“</span></a></div></div></div></div></main><footer id="footer" style="background-color: transparent;"><div id="footer-wrap"><div id="ft"><div class="ft-item-1"><div class="t-top"><div class="t-t-l"><p class="ft-t t-l-t">æ ¼è¨€ğŸ§¬</p><div class="bg-ad"><div>å†çœ‹çœ‹é‚£ä¸ªå…‰ç‚¹ï¼Œå®ƒå°±åœ¨è¿™é‡Œï¼Œè¿™æ˜¯å®¶å›­ï¼Œè¿™æ˜¯æˆ‘ä»¬ â€”â€” ä½ æ‰€çˆ±çš„æ¯ä¸€ä¸ªäººï¼Œä½ è®¤è¯†çš„ä¸€ä¸ªäººï¼Œä½ å¬è¯´è¿‡çš„æ¯ä¸€ä¸ªäººï¼Œæ›¾ç»æœ‰è¿‡çš„æ¯ä¸€ä¸ªäººï¼Œéƒ½åœ¨å®ƒä¸Šé¢åº¦è¿‡ä»–ä»¬çš„ä¸€ç”Ÿâœ¨</div><div class="btn-xz-box"><a class="btn-xz" target="_blank" rel="noopener" href="https://stellarium.org/">ç‚¹å‡»å¼€å¯æ˜Ÿè¾°ä¹‹æ—…</a></div></div></div><div class="t-t-r"><p class="ft-t t-l-t">çŒœä½ æƒ³çœ‹ğŸ’¡</p><ul class="ft-links"><li><a href="/comments/">ç•™ç‚¹ä»€ä¹ˆ</a><a href="/archives/">æ–‡ç« å½’æ¡£</a></li><li><a href="/categories/">æ–‡ç« åˆ†ç±»</a><a href="/tags/">æ–‡ç« æ ‡ç­¾</a></li><li><a href="/box/Gallery/">æˆ‘çš„ç”»å»Š</a><a href="/personal/bb/">æˆ‘çš„å” å¨</a></li><li><a href="/site/time/">å»ºè®¾è¿›ç¨‹</a><a href="/site/census/">ç½‘ç«™ç»Ÿè®¡</a></li></ul></div></div></div><div class="ft-item-2"><p class="ft-t">æ¨èå‹é“¾âŒ›</p><div class="ft-img-group"><div class="img-group-item"></div></div></div></div><div class="copyright"><span><b>&copy;2022-2025</b></span><span><b>&nbsp;&nbsp;By geqian's BlogğŸ­</b></span></div><div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=20230913" style="margin-inline:5px" title="æœ¬ç«™å·²åŠ å…¥èŒICPè±ªåå¥—é¤ï¼ŒèŒICPå¤‡20230913å·"><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/20230913.svg" alt=""/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button><button class="share" type="button" title="å³é”®æ¨¡å¼" onclick="changeMouseMode()"><i class="fas fa-mouse"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog right_side"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button class="share" type="button" title="åˆ†äº«é“¾æ¥" onclick="share()"><i class="fas fa-share-nodes"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button><button id="go-down" type="button" title="ç›´è¾¾åº•éƒ¨" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>å¤åˆ¶</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>ç™¾åº¦æœç´¢</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>ç²˜è´´</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span>ç©ºé™è¯„è®º</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>å¤åˆ¶æœ¬æ–‡åœ°å€</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>ä¿å­˜å›¾ç‰‡</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>åœ¨æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶å›¾ç‰‡é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:randomPost()"><i class="fa fa-paper-plane"></i><span>éšä¾¿é€›é€›</span></a><a class="rightMenu-item" href="javascript:switchNightMode();"><i class="fa fa-moon"></i><span>æ˜¼å¤œåˆ‡æ¢</span></a><a class="rightMenu-item" href="/personal/about/"><i class="fa fa-info-circle"></i><span>å…³äºåšå®¢</span></a><a class="rightMenu-item" href="javascript:toggleWinbox();"><i class="fas fa-cog"></i><span>ç¾åŒ–è®¾ç½®</span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span>åˆ‡æ¢å…¨å±</span></a><a class="rightMenu-item" href="javascript:window.print();"><i class="fa-solid fa-print"></i><span>æ‰“å°é¡µé¢</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000);
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: '',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: '',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.staticfile.org/twikoo/1.6.8/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script async src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script defer type="text/javascript" src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer src="https://cdn1.tianli0.top/gh/nextapps-de/winbox/dist/winbox.bundle.min.js"></script><script async src="//at.alicdn.com/t/c/font_3586335_hsivh70x0fm.js"></script><script async src="//at.alicdn.com/t/c/font_3636804_gr02jmjr3y9.js"></script><script async src="//at.alicdn.com/t/c/font_3612150_kfv55xn3u2g.js"></script><script async src="https://cdn.wpon.cn/2022-sucai/Gold-ingot.js"></script><canvas id="universe"></canvas><canvas id="snow"></canvas><script defer src="/js/fomal.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn1.tianli0.top/npm/js-heo@1.0.12/metingjs/Meting.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#web_bg",".js-pjax","#bibi","body > title","#app","#tag-echarts","#posts-echart","#categories-echarts"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/å­¦ä¹ ç¬”è®°/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¡ geqianã®å­¦ä¹ ç¬”è®° (10)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/æ‚é¡¹/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¼ geqianã®æ‚é¡¹ (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/é¡¹ç›®/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ‰ geqianã®é¡¹ç›®ç¬”è®° (6)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/AI/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¨ geqianã®AIå¤§æ¨¡å‹ (6)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/ç®—æ³•/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸŸ geqianã®ç®—æ³•å­¦ä¹ ç¬”è®° (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/é¢è¯•/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¥ geqianã®é¢è¯• (20)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/JUC/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸŒ geqianã®JUC (4)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/JVM/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸœ geqianã®JVM (5)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/äº‘åŸç”Ÿ/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ” geqianã®äº‘åŸç”Ÿç›¸å…³ (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/MQ/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ“± geqianã®æ¶ˆæ¯é˜Ÿåˆ— (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/å‰ç«¯/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ›ï¸ geqianã®å‰ç«¯å·¥ç¨‹ (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/mybatis-mybatis-plus/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¨ geqianã®mybatisç³»åˆ— (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/å¾®æœåŠ¡/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ—ºï¸ geqianã®SpringCloudç³»åˆ— (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/SSM/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ“– geqianã®SSM+SpringBootç³»åˆ— (7)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/ruoyi/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ“ geqianã®è‹¥ä¾æ¡†æ¶ (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/mysql/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">â“ geqianã®mysql (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/Redis/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ’– geqianã®Redis (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item" style="visibility: hidden"></div><a class="magnet_link_more"  href="https://itgeqian.github.io/categories/" style="flex:1;text-align: center;margin-bottom: 10px;">æŸ¥çœ‹æ›´å¤š...</a></div></div>';
    console.log('å·²æŒ‚è½½magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(33.333333333333336% - 5px);background: #e9e9e9;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: var(--text-bg-hover)}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/71.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/geqian-Blos/21.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-10-07</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/71.html&quot;);" href="javascript:void(0);" alt="">JVMé¢è¯•é¢˜</a><div class="blog-slider__text">æˆ‘å¯¹JVMçš„ç›¸å…³ç†è§£</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/71.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/60.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/geqian-Blos/%E5%8F%A4%E9%A3%8E.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-09-30</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/60.html&quot;);" href="javascript:void(0);" alt="">é€Ÿé€šSpring AI Alibaba </a><div class="blog-slider__text">é€Ÿé€šSpring AI Alibaba å®Œç»“</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/60.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/37.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/geqian-Blos/27.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-04-02</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/37.html&quot;);" href="javascript:void(0);" alt="">GQ Videoå•æœåŠ¡ç‰ˆæœ¬è®°å½•</a><div class="blog-slider__text">GQ Videoå•æœåŠ¡ç‰ˆæœ¬è®°å½•ï¼ˆå®Œæ•´è®°å½•GQ Videoä»0åˆ°1çš„å…¨è®°å½•ï¼‰</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/37.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/74.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/geqian-Blos/35.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-09-06</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/74.html&quot;);" href="javascript:void(0);" alt="">Mysqlç›¸å…³é¢è¯•é¢˜</a><div class="blog-slider__text">æˆ‘å¯¹mysqlçš„ç›¸å…³ç†è§£</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/74.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/77.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/geqian-Blos/31.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-10-07</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/77.html&quot;);" href="javascript:void(0);" alt="">javase+é›†åˆç›¸å…³é¢è¯•é¢˜</a><div class="blog-slider__text">æˆ‘å¯¹javaåŸºç¡€å’Œé›†åˆç±»çš„ç›¸å…³ç†è§£</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/77.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/68.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/geqian-Blos/22.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-10-01</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/68.html&quot;);" href="javascript:void(0);" alt="">JUCé¢è¯•é¢˜</a><div class="blog-slider__text">æˆ‘å¯¹JUCçš„ç†è§£</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/68.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('å·²æŒ‚è½½butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper@1.0.12/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper@1.0.12/lib/swiper_init.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('gitZone');
      var item_html = '<div class="recent-post-item" id="gitcalendarBar" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 320px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('å·²æŒ‚è½½gitcalendar')
      }

    if( document.getElementById('gitZone') && (location.pathname ==='/site/census/'|| '/site/census/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("/api?null",['#d9e0df', '#c6e0dc', '#a8dcd4', '#9adcd2', '#89ded1', '#77e0d0', '#5fdecb', '#47dcc6', '#39dcc3', '#1fdabe', '#00dab9'],'null')
    }
  </script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>