<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><div id="myscoll"></div><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>GQ Videoå•æœåŠ¡ç‰ˆæœ¬è®°å½• | geqian's BlogğŸ­</title><meta name="keywords" content="é¡¹ç›®ç›¸å…³"><meta name="author" content="geqian's BlogğŸ­"><meta name="copyright" content="geqian's BlogğŸ­"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="GQ Videoå•æœåŠ¡ç‰ˆæœ¬è®°å½•ï¼ˆå®Œæ•´è®°å½•GQ Videoä»0åˆ°1çš„å…¨è®°å½•ï¼‰">
<meta property="og:type" content="article">
<meta property="og:title" content="GQ Videoå•æœåŠ¡ç‰ˆæœ¬è®°å½•">
<meta property="og:url" content="https://itgeqian.github.io/posts/37.html">
<meta property="og:site_name" content="geqian&#39;s BlogğŸ­">
<meta property="og:description" content="GQ Videoå•æœåŠ¡ç‰ˆæœ¬è®°å½•ï¼ˆå®Œæ•´è®°å½•GQ Videoä»0åˆ°1çš„å…¨è®°å½•ï¼‰">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp">
<meta property="article:published_time" content="2025-04-02T00:19:03.000Z">
<meta property="article:modified_time" content="2025-08-12T11:12:00.000Z">
<meta property="article:author" content="geqian&#39;s BlogğŸ­">
<meta property="article:tag" content="é¡¹ç›®ç›¸å…³">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp"><link rel="shortcut icon" href="/"><link rel="canonical" href="https://itgeqian.github.io/posts/37"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.js',
      css: 'https://cdnjs.cloudflare.com/ajax/libs/flickr-justified-gallery/2.1.2/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'GQ Videoå•æœåŠ¡ç‰ˆæœ¬è®°å½•',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-08-12 19:12:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const now = new Date()
          const hour = now.getHours()
          const isNight = hour <= 6 || hour >= 18
          if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
          else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn1.tianli0.top/npm/element-ui@2.15.6/packages/theme-chalk/lib/index.css"><style id="themeColor"></style><style id="rightSide"></style><style id="transPercent"></style><style id="blurNum"></style><style id="settingStyle"></style><span id="fps"></span><style id="defineBg"></style><style id="menu_shadow"></style><script src="https://cdn.jsdelivr.net/npm/echarts@6/dist/echarts.min.js"></script><svg aria-hidden="true" style="position:absolute; overflow:hidden; width:0; height:0"><symbol id="icon-sun" viewBox="0 0 1024 1024"><path d="M960 512l-128 128v192h-192l-128 128-128-128H192v-192l-128-128 128-128V192h192l128-128 128 128h192v192z" fill="#FFD878" p-id="8420"></path><path d="M736 512a224 224 0 1 0-448 0 224 224 0 1 0 448 0z" fill="#FFE4A9" p-id="8421"></path><path d="M512 109.248L626.752 224H800v173.248L914.752 512 800 626.752V800h-173.248L512 914.752 397.248 800H224v-173.248L109.248 512 224 397.248V224h173.248L512 109.248M512 64l-128 128H192v192l-128 128 128 128v192h192l128 128 128-128h192v-192l128-128-128-128V192h-192l-128-128z" fill="#4D5152" p-id="8422"></path><path d="M512 320c105.888 0 192 86.112 192 192s-86.112 192-192 192-192-86.112-192-192 86.112-192 192-192m0-32a224 224 0 1 0 0 448 224 224 0 0 0 0-448z" fill="#4D5152" p-id="8423"></path></symbol><symbol id="icon-moon" viewBox="0 0 1024 1024"><path d="M611.370667 167.082667a445.013333 445.013333 0 0 1-38.4 161.834666 477.824 477.824 0 0 1-244.736 244.394667 445.141333 445.141333 0 0 1-161.109334 38.058667 85.077333 85.077333 0 0 0-65.066666 135.722666A462.08 462.08 0 1 0 747.093333 102.058667a85.077333 85.077333 0 0 0-135.722666 65.024z" fill="#FFB531" p-id="11345"></path><path d="M329.728 274.133333l35.157333-35.157333a21.333333 21.333333 0 1 0-30.165333-30.165333l-35.157333 35.157333-35.114667-35.157333a21.333333 21.333333 0 0 0-30.165333 30.165333l35.114666 35.157333-35.114666 35.157334a21.333333 21.333333 0 1 0 30.165333 30.165333l35.114667-35.157333 35.157333 35.157333a21.333333 21.333333 0 1 0 30.165333-30.165333z" fill="#030835" p-id="11346"></path></symbol></svg><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper@1.0.12/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper@1.0.12/lib/swiperstyle.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/animate.min.css" media="print" onload="this.media='screen'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="geqian's BlogğŸ­" type="application/atom+xml">
</head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/assets/avatar.png" onerror="onerror=null;src='/assets/r1.jpg'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">81</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">51</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">18</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> ä¼‘é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> å…«éŸ³ç›’</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½±é™¢</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xiangzi"></use></svg><span class="menu_word" style="font-size:17px"> å…«å®ç®±</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-tubiaozhizuomoban">                   </use></svg><span class="menu_word" style="font-size:17px"> ç”»å»Š</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-nvwumao">                   </use></svg><span class="menu_word" style="font-size:17px"> åŠ¨ç”»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘å€å¯¼èˆª</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> æœ‹å‹åœˆ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> å‹äººå¸</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> æ—§æ—¶å…‰</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">geqian's BlogğŸ­</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-home"></use></svg><span class="menu_word" style="font-size:17px"> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--article"></use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« </span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-guidang1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-sekuaibiaoqian">                   </use></svg><span class="menu_word" style="font-size:17px"> æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-fenlei">                   </use></svg><span class="menu_word" style="font-size:17px"> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pinweishenghuo"></use></svg><span class="menu_word" style="font-size:17px"> ä¼‘é—²</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/life/music/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-yinle">                   </use></svg><span class="menu_word" style="font-size:17px"> å…«éŸ³ç›’</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/movies/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-dianying1">                   </use></svg><span class="menu_word" style="font-size:17px"> å½±é™¢</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/life/games/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-youxishoubing">                   </use></svg><span class="menu_word" style="font-size:17px"> æ¸¸æˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xiangzi"></use></svg><span class="menu_word" style="font-size:17px"> å…«å®ç®±</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/box/gallery/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-tubiaozhizuomoban">                   </use></svg><span class="menu_word" style="font-size:17px"> ç”»å»Š</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/animation/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-nvwumao">                   </use></svg><span class="menu_word" style="font-size:17px"> åŠ¨ç”»</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/nav/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-zhifengche">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘å€å¯¼èˆª</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shejiaoxinxi"></use></svg><span class="menu_word" style="font-size:17px"> ç¤¾äº¤</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/social/fcircle/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-pengyouquan">                   </use></svg><span class="menu_word" style="font-size:17px"> æœ‹å‹åœˆ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-liuyan">                   </use></svg><span class="menu_word" style="font-size:17px"> ç•™è¨€æ¿</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/social/link/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-lianjie">                   </use></svg><span class="menu_word" style="font-size:17px"> å‹äººå¸</span></a></li></ul></div><div class="menus_item"><a class="site-page group faa-parent animated-hover hide" href="javascript:void(0);"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-wangye"></use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/site/census/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon--tongjibiao">                   </use></svg><span class="menu_word" style="font-size:17px"> ç½‘ç«™ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/echarts/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-shujutongji1">                   </use></svg><span class="menu_word" style="font-size:17px"> æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/site/time/"><svg class="menu_icon faa-tada" aria-hidden="true" style="width:1.30em;height:1.30em;vertical-align:-0.15em;fill:currentColor;overflow:hidden;"><use xlink:href="#icon-xianxingshalou">                   </use></svg><span class="menu_word" style="font-size:17px"> æ—§æ—¶å…‰</span></a></li></ul></div></div><center id="name-container"><a id="page-name" href="javascript:scrollToTop()">PAGE_NAME</a></center><div id="nav-right"><div id="search-button"><a class="search faa-parent animated-hover" title="æ£€ç´¢ç«™å†…ä»»ä½•ä½ æƒ³è¦çš„ä¿¡æ¯"><svg class="faa-tada icon" style="height:24px;width:24px;fill:currentColor;position:relative;top:6px" aria-hidden="true"><use xlink:href="#icon-valentine_-search-love-find-heart"></use></svg><span> æœç´¢</span></a></div><a class="meihua faa-parent animated-hover" onclick="toggleWinbox()" title="ç¾åŒ–è®¾ç½®-è‡ªå®šä¹‰ä½ çš„é£æ ¼" id="meihua-button"><svg class="faa-tada icon" style="height:26px;width:26px;fill:currentColor;position:relative;top:8px" aria-hidden="true"><use xlink:href="#icon-tupian1"></use></svg></a><a class="sun_moon faa-parent animated-hover" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢" id="nightmode-button"><svg class="faa-tada" style="height:25px;width:25px;fill:currentColor;position:relative;top:7px" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon">       </use></svg></a><div id="toggle-menu"><a><i class="fas fa-bars fa-fw"></i></a></div></div></div></nav><div id="post-info"><h1 class="post-title">GQ Videoå•æœåŠ¡ç‰ˆæœ¬è®°å½•</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><svg class="meta_icon post-meta-icon" style="width:30px;height:30px;position:relative;top:10px"><use xlink:href="#icon-rili"></use></svg><span class="post-meta-label">å‘è¡¨äº </span><time class="post-meta-date-created" datetime="2025-04-02T00:19:03.000Z" title="å‘è¡¨äº 2025-04-02 08:19:03">2025-04-02</time><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-gengxin1"></use></svg><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2025-08-12T11:12:00.000Z" title="æ›´æ–°äº 2025-08-12 19:12:00">2025-08-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:18px;height:18px;position:relative;top:5px"><use xlink:href="#icon-biaoqian"></use></svg><a class="post-meta-categories" href="/categories/%E9%A1%B9%E7%9B%AE/">é¡¹ç›®</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:8px"><use xlink:href="#icon-charuword"></use></svg><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">6.6w</span><span class="post-meta-separator">|</span><svg class="meta_icon post-meta-icon" style="width:20px;height:20px;position:relative;top:5px"><use xlink:href="#icon-shizhong"></use></svg><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>307åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="GQ Videoå•æœåŠ¡ç‰ˆæœ¬è®°å½•"><svg class="meta_icon post-meta-icon" style="width:25px;height:25px;position:relative;top:5px"><use xlink:href="#icon-eye"></use></svg><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="1-ç¯å¢ƒå‡†å¤‡">1.ç¯å¢ƒå‡†å¤‡</h2>
<h3 id="1-1æŠ€æœ¯æ ˆ">1.1æŠ€æœ¯æ ˆ</h3>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-547.png" alt="img"></p>
<h3 id="1-2æ¥å£æ–‡æ¡£">1.2æ¥å£æ–‡æ¡£</h3>
<p>æ¥å£æ–‡æ¡£ï¼š<a target="_blank" rel="noopener" href="https://console-docs.apipost.cn/preview/c960fe9e750ce5c1/d148092bed3ffd1e">Apipost-åŸºäºåä½œ, ä¸æ­¢äºAPIæ–‡æ¡£ã€è°ƒè¯•ã€Mockã€è‡ªåŠ¨åŒ–æµ‹è¯•</a></p>
<h3 id="1-3é¡¹ç›®ç›®å½•ç»“æ„">1.3é¡¹ç›®ç›®å½•ç»“æ„</h3>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-548.png" alt="img"></p>
<h3 id="1-4pomé…ç½®æ–‡ä»¶">1.4pomé…ç½®æ–‡ä»¶</h3>
<h4 id="æ ¹pom-xml">æ ¹pom.xml</h4>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.18<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.easylive<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>easylive<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>easylive-common<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>easylive-admin<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>easylive-web<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">skipTests</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skipTests</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">springboot.version</span>&gt;</span>2.7.18<span class="tag">&lt;/<span class="name">springboot.version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">mybatis.version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">mybatis.version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">logback.version</span>&gt;</span>1.2.10<span class="tag">&lt;/<span class="name">logback.version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>8.0.23<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">aspectjweaver.version</span>&gt;</span>1.9.3<span class="tag">&lt;/<span class="name">aspectjweaver.version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">fastjson.version</span>&gt;</span>1.2.83<span class="tag">&lt;/<span class="name">fastjson.version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">commons.lang3.version</span>&gt;</span>3.4<span class="tag">&lt;/<span class="name">commons.lang3.version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">commons.csv.version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">commons.csv.version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">commons.codec.version</span>&gt;</span>1.9<span class="tag">&lt;/<span class="name">commons.codec.version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">commons.io.version</span>&gt;</span>2.5<span class="tag">&lt;/<span class="name">commons.io.version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">lombok.version</span>&gt;</span>1.18.22<span class="tag">&lt;/<span class="name">lombok.version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">captcha.verion</span>&gt;</span>1.6.2<span class="tag">&lt;/<span class="name">captcha.verion</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">es.version</span>&gt;</span>3.3.2<span class="tag">&lt;/<span class="name">es.version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;springboot.version&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;mybatis.version&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="comment">&lt;!-- æ•°æ®åº“--&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;mysql.version&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="comment">&lt;!-- æ—¥å¿—ç‰ˆæœ¬ --&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;logback.version&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;logback.version&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="comment">&lt;!--åˆ‡é¢--&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;aspectjweaver.version&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="comment">&lt;!--fastjson--&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;fastjson.version&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;commons.lang3.version&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-codec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-codec<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;commons.codec.version&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;commons.io.version&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="comment">&lt;!---es search--&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;es.version&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;lombok.version&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.whvcse<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>easy-captcha<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;captcha.verion&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-549-1024x521.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-550-1024x422.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-551-1024x454.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-552-1024x633.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-553-1024x835.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-554.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-555-1024x669.png" alt="img"></p>
<h4 id="commonæ¨¡å—pom-xml">commonæ¨¡å—pom.xml</h4>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.easylive<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>easylive<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.easylive<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>easylive-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">skipTests</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skipTests</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--mybatis--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- æ•°æ®åº“--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- æ—¥å¿—ç‰ˆæœ¬ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--åˆ‡é¢--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--fastjson--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--apache common--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-codec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-codec<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.whvcse<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>easy-captcha<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-556-1024x633.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-557-1024x560.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-558-1024x624.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-559-1024x791.png" alt="img"></p>
<h4 id="adminæ¨¡å—pom-xml">adminæ¨¡å—pom.xml</h4>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.easylive<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>easylive<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.easylive<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>easylive-admin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">skipTests</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skipTests</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.easylive<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>easylive-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.easylive.admin.EasyliveAdminRunApplication<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="webæ¨¡å—pom-xml">webæ¨¡å—pom.xml</h4>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.easylive<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>easylive<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.easylive<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>easylive-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">skipTests</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skipTests</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.easylive<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>easylive-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.easylive.web.EasyliveWebRunApplication<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="logbacké…ç½®æ–‡ä»¶">logbacké…ç½®æ–‡ä»¶</h4>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">scan</span>=<span class="string">&quot;true&quot;</span> <span class="attr">scanPeriod</span>=<span class="string">&quot;10 minutes&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;stdot&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">layout</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.PatternLayout&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d</span><span class="template-variable">&#123;yyyy-MM-dd HH:mm:ss,GMT+8&#125;</span><span class="language-xml"> [%p][%c][%M][%L]-&gt; %m%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">springProperty</span> <span class="attr">scope</span>=<span class="string">&quot;context&quot;</span> <span class="attr">name</span>=<span class="string">&quot;log.path&quot;</span> <span class="attr">source</span>=<span class="string">&quot;project.folder&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">springProperty</span> <span class="attr">scope</span>=<span class="string">&quot;context&quot;</span> <span class="attr">name</span>=<span class="string">&quot;log.root.level&quot;</span> <span class="attr">source</span>=<span class="string">&quot;log.root.level&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">springProperty</span> <span class="attr">scope</span>=<span class="string">&quot;context&quot;</span> <span class="attr">name</span>=<span class="string">&quot;appname&quot;</span> <span class="attr">source</span>=<span class="string">&quot;spring.application.name&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;LOG_FOLDER&quot;</span> <span class="attr">value</span>=<span class="string">&quot;logs&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>$</span><span class="template-variable">&#123;log.path&#125;</span><span class="language-xml">/$</span><span class="template-variable">&#123;LOG_FOLDER&#125;</span><span class="language-xml">/$</span><span class="template-variable">&#123;appname&#125;</span><span class="language-xml">.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">FileNamePattern</span>&gt;</span>$</span><span class="template-variable">&#123;log.path&#125;</span><span class="language-xml">/$</span><span class="template-variable">&#123;LOG_FOLDER&#125;</span><span class="language-xml">/$</span><span class="template-variable">&#123;appname&#125;</span><span class="language-xml">.%d</span><span class="template-variable">&#123;yyyyMMdd&#125;</span><span class="language-xml">.%i<span class="tag">&lt;/<span class="name">FileNamePattern</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">cleanHistoryOnStart</span>&gt;</span>true<span class="tag">&lt;/<span class="name">cleanHistoryOnStart</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">TimeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">MaxFileSize</span>&gt;</span>20MB<span class="tag">&lt;/<span class="name">MaxFileSize</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">TimeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>30<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>utf-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d</span><span class="template-variable">&#123;yyyy-MM-dd HH:mm:ss,GMT+8&#125;</span><span class="language-xml"> [%p][%c][%M][%L]-&gt; %m%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">append</span>&gt;</span>false<span class="tag">&lt;/<span class="name">append</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">prudent</span>&gt;</span>false<span class="tag">&lt;/<span class="name">prudent</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;org.springframework.boot.autoconfigure.logging.ConditionEvaluationReportLoggingListener&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">level</span>=<span class="string">&quot;error&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;org.redisson.connection.DNSMonitor&quot;</span> <span class="attr">level</span>=<span class="string">&quot;error&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;com.zaxxer.hikari&quot;</span> <span class="attr">level</span>=<span class="string">&quot;info&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;io.lettuce.core&quot;</span> <span class="attr">level</span>=<span class="string">&quot;info&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;org.springframework.data.redis&quot;</span> <span class="attr">level</span>=<span class="string">&quot;info&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;$</span></span></span><span class="template-variable">&#123;log.root.level&#125;</span><span class="language-xml"><span class="tag"><span class="string">&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;stdot&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;file&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-560.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-561.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-562.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-563.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-564.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-565.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-566.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-567.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-568.png" alt="img"></p>
<h4 id="application-ymlé…ç½®æ–‡ä»¶">application.ymlé…ç½®æ–‡ä»¶</h4>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">server:</span></span><br><span class="line">  <span class="params">port:</span> <span class="number">7070</span></span><br><span class="line">  <span class="params">servlet:</span></span><br><span class="line">    <span class="params">context-path:</span> <span class="symbol">/admin</span></span><br><span class="line"><span class="params">spring:</span></span><br><span class="line">  <span class="params">servlet:</span></span><br><span class="line">    <span class="params">multipart:</span></span><br><span class="line">      <span class="params">max-file-size:</span> <span class="number">10</span>MB</span><br><span class="line">      <span class="params">max-request-size:</span> <span class="number">15</span>MB</span><br><span class="line">  <span class="params">application:</span></span><br><span class="line">    <span class="params">name:</span> easylive-admin</span><br><span class="line">  <span class="params">datasource:</span></span><br><span class="line">    <span class="params">url:</span> jdbc:mysql:<span class="operator">//</span><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">3306</span><span class="operator">/</span>easylive<span class="operator">?</span>serverTimezone<span class="operator">=</span>GMT%<span class="number">2</span>B8&amp;useUnicode<span class="operator">=</span><span class="literal">true</span>&amp;characterEncoding<span class="operator">=</span>utf8&amp;autoReconnect<span class="operator">=</span><span class="literal">true</span>&amp;allowMultiQueries<span class="operator">=</span><span class="literal">true</span>&amp;useSSL<span class="operator">=</span><span class="literal">false</span></span><br><span class="line">    <span class="params">username:</span> root</span><br><span class="line">    <span class="params">password:</span> root</span><br><span class="line">    <span class="params">driver-class-name:</span> com.mysql.cj.jdbc.Driver</span><br><span class="line">    <span class="params">hikari:</span></span><br><span class="line">      <span class="params">pool-name:</span> HikariCPDatasource</span><br><span class="line">      <span class="params">minimum-idle:</span> <span class="number">5</span></span><br><span class="line">      <span class="params">idle-timeout:</span> <span class="number">180000</span></span><br><span class="line">      <span class="params">maximum-pool-size:</span> <span class="number">10</span></span><br><span class="line">      <span class="params">auto-commit:</span> <span class="literal">true</span></span><br><span class="line">      <span class="params">max-lifetime:</span> <span class="number">1800000</span></span><br><span class="line">      <span class="params">connection-timeout:</span> <span class="number">30000</span></span><br><span class="line">      <span class="params">connection-test-query:</span> SELECT <span class="number">1</span></span><br><span class="line">  <span class="params">redis:</span></span><br><span class="line">    <span class="params">database:</span> <span class="number">0</span></span><br><span class="line">    <span class="params">host:</span> <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line">    <span class="params">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="params">jedis:</span></span><br><span class="line">      <span class="params">pool:</span></span><br><span class="line">        <span class="params">max-active:</span> <span class="number">20</span></span><br><span class="line">        <span class="params">max-wait:</span> <span class="operator">-</span><span class="number">1</span></span><br><span class="line">        <span class="params">max-idle:</span> <span class="number">10</span></span><br><span class="line">        <span class="params">min-idle:</span> <span class="number">0</span></span><br><span class="line">    <span class="params">timeout:</span> <span class="number">2000</span></span><br><span class="line"><span class="comment">#mybatis å¤§å°å†™è½¬é©¼å³°</span></span><br><span class="line"><span class="params">mybatis:</span></span><br><span class="line">  <span class="params">configuration:</span></span><br><span class="line">    <span class="params">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="params">project:</span></span><br><span class="line">  <span class="params">folder:</span> c:<span class="operator">/</span>webser<span class="operator">/</span>easylive<span class="symbol">/</span></span><br><span class="line"><span class="params">log:</span></span><br><span class="line">  <span class="params">root:</span></span><br><span class="line">    <span class="params">level:</span> debug</span><br><span class="line"><span class="params">admin:</span></span><br><span class="line">  <span class="params">account:</span> admin</span><br><span class="line">  <span class="params">password:</span> admin123</span><br></pre></td></tr></table></figure>
<p>è¯¦è§£application.xml</p>
<p><strong>1. æœåŠ¡å™¨é…ç½®ï¼ˆ<code>server</code>ï¼‰</strong></p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">server:</span></span><br><span class="line">  <span class="params">port:</span> <span class="number">7070</span>                     <span class="comment"># æœåŠ¡å™¨ç«¯å£å·ï¼ˆé»˜è®¤8080ï¼Œè¿™é‡Œè®¾ä¸º7070ï¼‰</span></span><br><span class="line">  <span class="params">servlet:</span></span><br><span class="line">    <span class="params">context-path:</span> <span class="symbol">/admin</span>         <span class="comment"># åº”ç”¨ä¸Šä¸‹æ–‡è·¯å¾„ï¼ˆè®¿é—®è·¯å¾„éœ€åŠ  `/admin`ï¼Œå¦‚ `http://localhost:7070/admin`ï¼‰</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>port</code></strong>: æŒ‡å®šåº”ç”¨è¿è¡Œçš„ç«¯å£å·ï¼ˆé»˜è®¤ <code>8080</code>ï¼Œè¿™é‡Œæ”¹ä¸º <code>7070</code>ï¼‰ã€‚</li>
<li><strong><code>context-path</code></strong>: è®¾ç½®åº”ç”¨çš„æ ¹è·¯å¾„ï¼ˆå¦‚ <code>/admin</code>ï¼‰ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½éœ€è¦åŠ ä¸Šè¿™ä¸ªå‰ç¼€ã€‚</li>
</ul>
<p><strong>2. æ–‡ä»¶ä¸Šä¼ é…ç½®ï¼ˆ<code>spring.servlet.multipart</code>ï¼‰</strong></p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">spring:</span></span><br><span class="line">  <span class="params">servlet:</span></span><br><span class="line">    <span class="params">multipart:</span></span><br><span class="line">      <span class="params">max-file-size:</span> <span class="number">10</span>MB        <span class="comment"># å•ä¸ªæ–‡ä»¶æœ€å¤§å¤§å°ï¼ˆé»˜è®¤1MBï¼‰</span></span><br><span class="line">      <span class="params">max-request-size:</span> <span class="number">15</span>MB     <span class="comment"># æ•´ä¸ªè¯·æ±‚çš„æœ€å¤§å¤§å°ï¼ˆé»˜è®¤10MBï¼‰</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>max-file-size</code></strong>: é™åˆ¶å•ä¸ªä¸Šä¼ æ–‡ä»¶çš„å¤§å°ï¼ˆå¦‚ <code>10MB</code>ï¼‰ã€‚</li>
<li><strong><code>max-request-size</code></strong>: é™åˆ¶æ•´ä¸ª HTTP è¯·æ±‚ï¼ˆå¯èƒ½åŒ…å«å¤šä¸ªæ–‡ä»¶ï¼‰çš„æœ€å¤§å¤§å°ï¼ˆå¦‚ <code>15MB</code>ï¼‰ã€‚</li>
</ul>
<p><strong>3. åº”ç”¨åç§°ï¼ˆ<code>spring.application.name</code>ï¼‰</strong></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">spring:</span></span><br><span class="line"><span class="symbol">  application:</span></span><br><span class="line"><span class="symbol">    name:</span> easylive-admin         <span class="meta"># åº”ç”¨åç§°ï¼ˆç”¨äºæœåŠ¡å‘ç°ã€æ—¥å¿—æ ‡è®°ç­‰ï¼‰</span></span><br></pre></td></tr></table></figure>
<ul>
<li>ç”¨äºæ ‡è¯†å½“å‰åº”ç”¨ï¼ˆå¦‚å¾®æœåŠ¡æ¶æ„ä¸­çš„æœåŠ¡åï¼‰ã€‚</li>
</ul>
<p><strong>4. æ•°æ®åº“é…ç½®ï¼ˆ<code>spring.datasource</code>ï¼‰</strong></p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">spring:</span></span><br><span class="line">  <span class="params">datasource:</span></span><br><span class="line">    <span class="params">url:</span> jdbc:mysql:<span class="operator">//</span><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">3306</span><span class="operator">/</span>easylive<span class="operator">?</span>serverTimezone<span class="operator">=</span>GMT%<span class="number">2</span>B8&amp;useUnicode<span class="operator">=</span><span class="literal">true</span>&amp;characterEncoding<span class="operator">=</span>utf8&amp;autoReconnect<span class="operator">=</span><span class="literal">true</span>&amp;allowMultiQueries<span class="operator">=</span><span class="literal">true</span>&amp;useSSL<span class="operator">=</span><span class="literal">false</span></span><br><span class="line">    <span class="params">username:</span> root               <span class="comment"># æ•°æ®åº“ç”¨æˆ·å</span></span><br><span class="line">    <span class="params">password:</span> <span class="number">123456</span>               <span class="comment"># æ•°æ®åº“å¯†ç </span></span><br><span class="line">    <span class="params">driver-class-name:</span> com.mysql.cj.jdbc.Driver  <span class="comment"># MySQL JDBC é©±åŠ¨</span></span><br><span class="line">    <span class="params">hikari:</span>                      <span class="comment"># HikariCP è¿æ¥æ± é…ç½®</span></span><br><span class="line">      <span class="params">pool-name:</span> HikariCPDatasource</span><br><span class="line">      <span class="params">minimum-idle:</span> <span class="number">5</span>            <span class="comment"># æœ€å°ç©ºé—²è¿æ¥æ•°</span></span><br><span class="line">      <span class="params">maximum-pool-size:</span> <span class="number">10</span>      <span class="comment"># æœ€å¤§è¿æ¥æ•°</span></span><br><span class="line">      <span class="params">idle-timeout:</span> <span class="number">180000</span>       <span class="comment"># ç©ºé—²è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span></span><br><span class="line">      <span class="params">max-lifetime:</span> <span class="number">1800000</span>      <span class="comment"># è¿æ¥æœ€å¤§å­˜æ´»æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span></span><br><span class="line">      <span class="params">connection-timeout:</span> <span class="number">30000</span>  <span class="comment"># è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span></span><br><span class="line">      <span class="params">connection-test-query:</span> SELECT <span class="number">1</span>  <span class="comment"># è¿æ¥æµ‹è¯•SQL</span></span><br></pre></td></tr></table></figure>
<ul>
<li>url: MySQL æ•°æ®åº“è¿æ¥åœ°å€ï¼ŒåŒ…å«ï¼š</li>
<li>serverTimezone=GMT%2B8ï¼ˆè®¾ç½®æ—¶åŒºä¸ºä¸œå…«åŒºï¼‰</li>
<li>useUnicode=true&amp;characterEncoding=utf8ï¼ˆæ”¯æŒ UTF-8 ç¼–ç ï¼‰</li>
<li>autoReconnect=trueï¼ˆè‡ªåŠ¨é‡è¿ï¼‰</li>
<li>allowMultiQueries=trueï¼ˆå…è®¸æ‰§è¡Œå¤šæ¡ SQLï¼‰</li>
<li>useSSL=falseï¼ˆç¦ç”¨ SSLï¼‰</li>
<li>hikari: HikariCP æ˜¯ Spring Boot é»˜è®¤çš„é«˜æ€§èƒ½æ•°æ®åº“è¿æ¥æ± ï¼Œè¿™é‡Œé…ç½®äº†è¿æ¥æ± å‚æ•°ã€‚</li>
</ul>
<p><strong>5. Redis é…ç½®ï¼ˆ<code>spring.redis</code>ï¼‰</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span>                  <span class="comment"># Redis æ•°æ®åº“ç´¢å¼•ï¼ˆé»˜è®¤0ï¼‰</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>              <span class="comment"># Redis æœåŠ¡å™¨åœ°å€</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span>                   <span class="comment"># Redis ç«¯å£</span></span><br><span class="line">    <span class="attr">jedis:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">20</span>           <span class="comment"># æœ€å¤§æ´»è·ƒè¿æ¥æ•°</span></span><br><span class="line">        <span class="attr">max-wait:</span> <span class="number">-1</span>             <span class="comment"># æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆ-1è¡¨ç¤ºæ— é™ç­‰å¾…ï¼‰</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">10</span>             <span class="comment"># æœ€å¤§ç©ºé—²è¿æ¥æ•°</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">0</span>              <span class="comment"># æœ€å°ç©ºé—²è¿æ¥æ•°</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">2000</span>                <span class="comment"># è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰</span></span><br></pre></td></tr></table></figure>
<ul>
<li>é…ç½® Redis è¿æ¥ä¿¡æ¯ï¼Œä½¿ç”¨ Jedis ä½œä¸ºå®¢æˆ·ç«¯ã€‚</li>
</ul>
<p><strong>6. MyBatis é…ç½®ï¼ˆ<code>mybatis</code>ï¼‰</strong></p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">mybatis:</span></span><br><span class="line"><span class="title">  configuration:</span></span><br><span class="line"><span class="title">    map-underscore-to-camel-case:</span> <span class="literal">true</span>  # æ•°æ®åº“å­—æ®µä¸‹åˆ’çº¿è½¬é©¼å³°å‘½åï¼ˆå¦‚ `user_name` â†’ `userName`ï¼‰</span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>map-underscore-to-camel-case</code></strong>: è‡ªåŠ¨å°†æ•°æ®åº“çš„ <code>snake_case</code> å­—æ®µåæ˜ å°„ä¸º Java çš„ <code>camelCase</code> å±æ€§åã€‚</li>
</ul>
<p><strong>7. è‡ªå®šä¹‰é…ç½®ï¼ˆ<code>project</code>ã€<code>log</code>ã€<code>admin</code>ï¼‰</strong></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">project:</span></span><br><span class="line"><span class="symbol">  folder:</span> D:<span class="keyword">/work-webser/</span>myapps/easylive  <span class="meta"># è‡ªå®šä¹‰é¡¹ç›®æ–‡ä»¶å­˜å‚¨è·¯å¾„</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">log:</span></span><br><span class="line"><span class="symbol">  root:</span></span><br><span class="line"><span class="symbol">    level:</span> debug                  <span class="meta"># æ—¥å¿—çº§åˆ«ï¼ˆdebugã€infoã€warnã€errorï¼‰</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">admin:</span></span><br><span class="line"><span class="symbol">  account:</span> admin                  <span class="meta"># ç®¡ç†å‘˜è´¦å·</span></span><br><span class="line"><span class="symbol">  password:</span> admin123              <span class="meta"># ç®¡ç†å‘˜å¯†ç </span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>project.folder</code></strong>: è‡ªå®šä¹‰æ–‡ä»¶å­˜å‚¨è·¯å¾„ï¼ˆå¦‚ä¸Šä¼ çš„æ–‡ä»¶å­˜æ”¾ä½ç½®ï¼‰ã€‚</li>
<li><strong><code>log.root.level</code></strong>: è®¾ç½®æ—¥å¿—çº§åˆ«ï¼ˆ<code>debug</code> ä¼šæ‰“å°æ›´è¯¦ç»†çš„æ—¥å¿—ï¼‰ã€‚</li>
<li><strong><code>admin.account/password</code></strong>: å¯èƒ½æ˜¯ç”¨äºåå°ç®¡ç†çš„é»˜è®¤è´¦å·å¯†ç ã€‚</li>
</ul>
<h3 id="1-5æ•°æ®åº“">1.5æ•°æ®åº“</h3>
<p>å»ºè¡¨ï¼ˆuser_infoï¼‰è¯­å¥</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_info`(</span><br><span class="line">  `user_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ç”¨æˆ·id&#x27;</span>,</span><br><span class="line">  `nick_name` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æ˜µç§°&#x27;</span>,</span><br><span class="line">  `email` <span class="type">varchar</span>(<span class="number">150</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;é‚®ç®±&#x27;</span>,</span><br><span class="line">  `<span class="keyword">password</span>` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;å¯†ç &#x27;</span>,</span><br><span class="line">  `sex` tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;0:å¥³ 1:ç”· 2:æœªçŸ¥&#x27;</span>,</span><br><span class="line">  `birthday` <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;å‡ºç”Ÿæ—¥æœŸ&#x27;</span>,</span><br><span class="line">  `school` <span class="type">varchar</span>(<span class="number">150</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;å­¦æ ¡&#x27;</span>,</span><br><span class="line">  `person_introduction` <span class="type">varchar</span>(<span class="number">200</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ä¸ªäººç®€ä»‹&#x27;</span>,</span><br><span class="line">  `join_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;åŠ å…¥æ—¶é—´&#x27;</span>,</span><br><span class="line">  `last_login_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æœ€åç™»å½•æ—¶é—´&#x27;</span>,</span><br><span class="line">  `last_login_ip` <span class="type">varchar</span>(<span class="number">15</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æœ€åç™»å½•IP&#x27;</span>,</span><br><span class="line">  `status` tinyint(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;0:ç¦ç”¨ 1:æ­£å¸¸&#x27;</span>,</span><br><span class="line">  `notice_info` <span class="type">varchar</span>(<span class="number">300</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ç©ºé—´å…¬å‘Š&#x27;</span>,</span><br><span class="line">  `total_coin_count` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ç¡¬å¸æ€»æ•°é‡&#x27;</span>,</span><br><span class="line">  `current_coin_count` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;å½“å‰ç¡¬å¸æ•°&#x27;</span>,</span><br><span class="line">  `theme` tinyint(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;1&#x27;</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ä¸»é¢˜&#x27;</span>,</span><br><span class="line"> `avatar` <span class="type">varchar</span>(<span class="number">100</span>)  <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;å¤´åƒ&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (`user_id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `idx_key_email` (`email`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `idx_nick_name` (`nick_name`)</span><br><span class="line">) ENGINE = InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4 <span class="keyword">COLLATE</span> = utf8mb4_general_ci <span class="keyword">COMMENT</span> = <span class="string">&#x27;ç”¨æˆ·ä¿¡æ¯&#x27;</span> ROW_FORMAT = Dynamic;</span><br></pre></td></tr></table></figure>
<p>1.6åˆ©ç”¨EasyJavaä»£ç ç”Ÿæˆå™¨ç”Ÿæˆuser_infoè¡¨çš„Controllerã€VOã€POã€Queryã€Serviceã€Mapperxml</p>
<h2 id="2-ç™»å½•ä¸æ³¨å†Œ">2.ç™»å½•ä¸æ³¨å†Œ</h2>
<h3 id="1-éªŒè¯ç ">1.éªŒè¯ç </h3>
<h4 id="ç”¨session">ç”¨session</h4>
<p>éªŒè¯ç æ¥å£http://localhost:7071/account/checkCode</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/checkCode&quot;)</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> ResponseVO <span class="title function_">checkCode</span><span class="params">(HttpSession session)</span>&#123;</span><br><span class="line">       <span class="comment">// éªŒè¯ç </span></span><br><span class="line">       <span class="type">ArithmeticCaptcha</span> <span class="variable">captcha</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArithmeticCaptcha</span>(<span class="number">100</span>, <span class="number">42</span>);</span><br><span class="line">       <span class="comment">//æ‹¿åˆ°éªŒè¯ç æ–‡æœ¬å†…å®¹</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> captcha.text();</span><br><span class="line">       session.setAttribute(<span class="string">&quot;captcha&quot;</span>, code);</span><br><span class="line">       <span class="type">String</span> <span class="variable">checkCodeBase64</span> <span class="operator">=</span> captcha.toBase64();</span><br><span class="line">       <span class="keyword">return</span> getSucessResponseVo(checkCodeBase64);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-573-1024x256.png" alt="img"></p>
<p>å…ˆå†™ä¸€ä¸ªç®€æ˜“çš„registeræ–¹æ³•ï¼Œç”¨æ¥æµ‹è¯•æ˜¯å¦æ‹¿åˆ°éªŒè¯ç </p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/register&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">register</span>(<span class="params"><span class="title class_">HttpSession</span> session,<span class="title class_">String</span> checkCode</span>)&#123;</span><br><span class="line">        <span class="title class_">String</span> myCheckCode = (<span class="title class_">String</span>) session.<span class="title function_">getAttribute</span>(<span class="string">&quot;checkCode&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">getSucessResponseVo</span>(myCheckCode.<span class="title function_">equalsIgnoreCase</span>(checkCode));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ string myCheckCode = (string) session.getAttribute(â€œcheckCodeâ€);è¿™ä¸€è¡Œæ‰“ä¸Šæ–­ç‚¹</p>
<p>æµè§ˆå™¨è¾“å…¥ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-575.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-576-1024x438.png" alt="img"></p>
<p>å¯ä»¥çœ‹åˆ°éªŒè¯ç ä¸ä¸€è‡´</p>
<h4 id="æ”¹é€ ä»£ç ç”¨Redisæ¥æ”¶éªŒè¯ç ">æ”¹é€ ä»£ç ç”¨Redisæ¥æ”¶éªŒè¯ç </h4>
<p>åœ¨commonæ¨¡å—ä¸‹åˆ›å»ºredisåŒ…å’ŒRedisConfig</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-577.png" alt="img"></p>
<p>RedisConfigï¼šRedisçš„å¸¸è§é…ç½®</p>
<figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> RedisConfig&lt;V&gt; &#123;</span><br><span class="line">    <span class="keyword">@Bean</span>(<span class="string">&quot;redisTemplate&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, V&gt; redisTemplate(RedisConnectionFactory factory) &#123;</span><br><span class="line">        RedisTemplate&lt;String, V&gt; <span class="keyword">template</span> = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">        <span class="keyword">template</span>.setConnectionFactory(factory);</span><br><span class="line">        <span class="comment">// è®¾ç½®keyçš„åºåˆ—åŒ–æ–¹å¼</span></span><br><span class="line">        <span class="keyword">template</span>.setKeySerializer(RedisSerializer.<span class="built_in">string</span>());</span><br><span class="line">        <span class="comment">// è®¾ç½®valueçš„åºåˆ—åŒ–æ–¹å¼</span></span><br><span class="line">        <span class="keyword">template</span>.setValueSerializer(RedisSerializer.json());</span><br><span class="line">        <span class="comment">// è®¾ç½®hashçš„keyçš„åºåˆ—åŒ–æ–¹å¼</span></span><br><span class="line">        <span class="keyword">template</span>.setHashKeySerializer(RedisSerializer.<span class="built_in">string</span>());</span><br><span class="line">        <span class="comment">// è®¾ç½®hashçš„valueçš„åºåˆ—åŒ–æ–¹å¼</span></span><br><span class="line">        <span class="keyword">template</span>.setHashValueSerializer(RedisSerializer.json());</span><br><span class="line">        <span class="keyword">template</span>.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">template</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisMessageListenerContainer container(RedisConnectionFactory connectionFactory) &#123;</span><br><span class="line">        RedisMessageListenerContainer container = <span class="keyword">new</span> RedisMessageListenerContainer();</span><br><span class="line">        container.setConnectionFactory(connectionFactory);</span><br><span class="line">        <span class="keyword">return</span> container;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-578-1024x935.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-579.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-580.png" alt="img"></p>
<p>è¿™ä¸ª <code>RedisConfig</code> é…ç½®ç±»ä¸»è¦åšäº†ï¼š</p>
<ol>
<li>é…ç½®äº†ä¸€ä¸ªå¸¦æœ‰ <strong>JSON åºåˆ—åŒ–</strong>ï¼ˆvalue/hashValueï¼‰å’Œ <strong>å­—ç¬¦ä¸²åºåˆ—åŒ–</strong>ï¼ˆkey/hashKeyï¼‰çš„ <code>RedisTemplate</code>ï¼Œæ–¹ä¾¿å­˜å–å¯¹è±¡æ—¶é¿å…ä¹±ç å¹¶ä¿æŒå¯è¯»æ€§ã€‚</li>
<li>é…ç½®äº†ä¸€ä¸ª <strong>Redis æ¶ˆæ¯ç›‘å¬å®¹å™¨</strong>ï¼Œç”¨äºå¤„ç†å‘å¸ƒ/è®¢é˜…æ¶ˆæ¯æœºåˆ¶ã€‚</li>
</ol>
<p>RedisUtils</p>
<p>è¿™ä¸ª <code>RedisUtils</code> æ˜¯ä¸€ä¸ªåŸºäº <code>RedisTemplate</code> å°è£…çš„ <strong>Redis æ“ä½œå·¥å…·ç±»</strong>ï¼Œæ–¹ä¾¿åœ¨é¡¹ç›®ä¸­ç›´æ¥è°ƒç”¨ Redis çš„å¸¸ç”¨åŠŸèƒ½ï¼Œè€Œä¸ç”¨æ¯æ¬¡éƒ½å†™ <code>redisTemplate.opsForXXX()</code>ã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(<span class="string">&quot;redisUtils&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisUtils</span>&lt;V&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">RedisTemplate</span>&lt;<span class="title class_">String</span>, V&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> final <span class="title class_">Logger</span> logger = <span class="title class_">LoggerFactory</span>.<span class="title function_">getLogger</span>(<span class="title class_">RedisUtils</span>.<span class="property">class</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ é™¤ç¼“å­˜</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key å¯ä»¥ä¼ ä¸€ä¸ªå€¼ æˆ–å¤šä¸ª</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">delete</span>(<span class="params"><span class="title class_">String</span>... key</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key != <span class="literal">null</span> &amp;&amp; key.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (key.<span class="property">length</span> == <span class="number">1</span>) &#123;</span><br><span class="line">                redisTemplate.<span class="title function_">delete</span>(key[<span class="number">0</span>]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                redisTemplate.<span class="title function_">delete</span>((<span class="title class_">Collection</span>&lt;<span class="title class_">String</span>&gt;) <span class="title class_">CollectionUtils</span>.<span class="title function_">arrayToList</span>(key));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">get</span>(<span class="params"><span class="title class_">String</span> key</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> key == <span class="literal">null</span> ? <span class="literal">null</span> : redisTemplate.<span class="title function_">opsForValue</span>().<span class="title function_">get</span>(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ™®é€šç¼“å­˜æ”¾å…¥</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> trueæˆåŠŸ falseå¤±è´¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">boolean</span> <span class="title function_">set</span>(<span class="params"><span class="title class_">String</span> key, V value</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.<span class="title function_">opsForValue</span>().<span class="title function_">set</span>(key, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) &#123;</span><br><span class="line">            logger.<span class="title function_">error</span>(<span class="string">&quot;è®¾ç½®redisKey:&#123;&#125;,value:&#123;&#125;å¤±è´¥&quot;</span>, key, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">boolean</span> <span class="title function_">keyExists</span>(<span class="params"><span class="title class_">String</span> key</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.<span class="title function_">hasKey</span>(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ™®é€šç¼“å­˜æ”¾å…¥å¹¶è®¾ç½®æ—¶é—´</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   é”®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time  æ—¶é—´(ç§’) timeè¦å¤§äº0 å¦‚æœtimeå°äºç­‰äº0 å°†è®¾ç½®æ— é™æœŸ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> trueæˆåŠŸ false å¤±è´¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">boolean</span> <span class="title function_">setex</span>(<span class="params"><span class="title class_">String</span> key, V value, long time</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                redisTemplate.<span class="title function_">opsForValue</span>().<span class="title function_">set</span>(key, value, time, <span class="title class_">TimeUnit</span>.<span class="property">MILLISECONDS</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">set</span>(key, value);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) &#123;</span><br><span class="line">            logger.<span class="title function_">error</span>(<span class="string">&quot;è®¾ç½®redisKey:&#123;&#125;,value:&#123;&#125;å¤±è´¥&quot;</span>, key, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">boolean</span> <span class="title function_">expire</span>(<span class="params"><span class="title class_">String</span> key, long time</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                redisTemplate.<span class="title function_">expire</span>(key, time, <span class="title class_">TimeUnit</span>.<span class="property">MILLISECONDS</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) &#123;</span><br><span class="line">            e.<span class="title function_">printStackTrace</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">List</span>&lt;V&gt; <span class="title function_">getQueueList</span>(<span class="params"><span class="title class_">String</span> key</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.<span class="title function_">opsForList</span>().<span class="title function_">range</span>(key, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">boolean</span> <span class="title function_">lpush</span>(<span class="params"><span class="title class_">String</span> key, V value, <span class="title class_">Long</span> time</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.<span class="title function_">opsForList</span>().<span class="title function_">leftPush</span>(key, value);</span><br><span class="line">            <span class="keyword">if</span> (time != <span class="literal">null</span> &amp;&amp; time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="title function_">expire</span>(key, time);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) &#123;</span><br><span class="line">            e.<span class="title function_">printStackTrace</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> long <span class="title function_">remove</span>(<span class="params"><span class="title class_">String</span> key, <span class="title class_">Object</span> value</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="title class_">Long</span> remove = redisTemplate.<span class="title function_">opsForList</span>().<span class="title function_">remove</span>(key, <span class="number">1</span>, value);</span><br><span class="line">            <span class="keyword">return</span> remove;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) &#123;</span><br><span class="line">            e.<span class="title function_">printStackTrace</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">boolean</span> <span class="title function_">lpushAll</span>(<span class="params"><span class="title class_">String</span> key, <span class="title class_">List</span>&lt;V&gt; values, long time</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.<span class="title function_">opsForList</span>().<span class="title function_">leftPushAll</span>(key, values);</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="title function_">expire</span>(key, time);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) &#123;</span><br><span class="line">            e.<span class="title function_">printStackTrace</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> V <span class="title function_">rpop</span>(<span class="params"><span class="title class_">String</span> key</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.<span class="title function_">opsForList</span>().<span class="title function_">rightPop</span>(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) &#123;</span><br><span class="line">            e.<span class="title function_">printStackTrace</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Long</span> <span class="title function_">increment</span>(<span class="params"><span class="title class_">String</span> key</span>) &#123;</span><br><span class="line">        <span class="title class_">Long</span> count = redisTemplate.<span class="title function_">opsForValue</span>().<span class="title function_">increment</span>(key, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Long</span> <span class="title function_">incrementex</span>(<span class="params"><span class="title class_">String</span> key, long milliseconds</span>) &#123;</span><br><span class="line">        <span class="title class_">Long</span> count = redisTemplate.<span class="title function_">opsForValue</span>().<span class="title function_">increment</span>(key, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">//è®¾ç½®è¿‡æœŸæ—¶é—´1å¤©</span></span><br><span class="line">            <span class="title function_">expire</span>(key, milliseconds);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Long</span> <span class="title function_">decrement</span>(<span class="params"><span class="title class_">String</span> key</span>) &#123;</span><br><span class="line">        <span class="title class_">Long</span> count = redisTemplate.<span class="title function_">opsForValue</span>().<span class="title function_">increment</span>(key, -<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            redisTemplate.<span class="title function_">delete</span>(key);</span><br><span class="line">        &#125;</span><br><span class="line">        logger.<span class="title function_">info</span>(<span class="string">&quot;key:&#123;&#125;,å‡å°‘æ•°é‡&#123;&#125;&quot;</span>, key, count);</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Set</span>&lt;<span class="title class_">String</span>&gt; <span class="title function_">getByKeyPrefix</span>(<span class="params"><span class="title class_">String</span> keyPrifix</span>) &#123;</span><br><span class="line">        <span class="title class_">Set</span>&lt;<span class="title class_">String</span>&gt; keyList = redisTemplate.<span class="title function_">keys</span>(keyPrifix + <span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> keyList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Map</span>&lt;<span class="title class_">String</span>, V&gt; <span class="title function_">getBatch</span>(<span class="params"><span class="title class_">String</span> keyPrifix</span>) &#123;</span><br><span class="line">        <span class="title class_">Set</span>&lt;<span class="title class_">String</span>&gt; keySet = redisTemplate.<span class="title function_">keys</span>(keyPrifix + <span class="string">&quot;*&quot;</span>);</span><br><span class="line">        <span class="title class_">List</span>&lt;<span class="title class_">String</span>&gt; keyList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(keySet);</span><br><span class="line">        <span class="title class_">List</span>&lt;V&gt; keyValueList = redisTemplate.<span class="title function_">opsForValue</span>().<span class="title function_">multiGet</span>(keyList);</span><br><span class="line">        <span class="title class_">Map</span>&lt;<span class="title class_">String</span>, V&gt; resultMap = keyList.<span class="title function_">stream</span>().<span class="title function_">collect</span>(<span class="title class_">Collectors</span>.<span class="title function_">toMap</span>(key -&gt; key, value -&gt; keyValueList.<span class="title function_">get</span>(keyList.<span class="title function_">indexOf</span>(value))));</span><br><span class="line">        <span class="keyword">return</span> resultMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">zaddCount</span>(<span class="params"><span class="title class_">String</span> key, V v</span>) &#123;</span><br><span class="line">        redisTemplate.<span class="title function_">opsForZSet</span>().<span class="title function_">incrementScore</span>(key, v, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">List</span>&lt;V&gt; <span class="title function_">getZSetList</span>(<span class="params"><span class="title class_">String</span> key, <span class="title class_">Integer</span> count</span>) &#123;</span><br><span class="line">        <span class="title class_">Set</span>&lt;V&gt; topElements = redisTemplate.<span class="title function_">opsForZSet</span>().<span class="title function_">reverseRange</span>(key, <span class="number">0</span>, count);</span><br><span class="line">        <span class="title class_">List</span>&lt;V&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(topElements);</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-581.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-582-953x1024.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-583-1024x888.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-584.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-585.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-586.png" alt="img"></p>
<p>è¿™ä¸ª <code>RedisUtils</code> å·¥å…·ç±»ç›¸å½“äºç»™ Redis çš„å¸¸è§æ“ä½œåšäº†<strong>ä¸€å±‚å°è£…</strong>ï¼ŒåŒ…æ‹¬ï¼š</p>
<ol>
<li><strong>String</strong> ç±»å‹çš„å­˜å–ã€è¿‡æœŸæ§åˆ¶ã€è®¡æ•°å™¨åŠŸèƒ½ã€‚</li>
<li><strong>List</strong> ç±»å‹çš„é˜Ÿåˆ—/æ ˆæ“ä½œï¼ˆlpushã€rpopã€removeã€æ‰¹é‡ pushï¼‰ã€‚</li>
<li><strong>ZSet</strong> æ’è¡Œæ¦œ/è®¡æ•°åŠŸèƒ½ã€‚</li>
<li><strong>æ‰¹é‡ key æŸ¥è¯¢</strong>ï¼ˆæ”¯æŒå‰ç¼€åŒ¹é…ï¼‰ã€‚</li>
<li><strong>å¼‚å¸¸å¤„ç† &amp; æ—¥å¿—è®°å½•</strong>ï¼ˆä¿è¯å‡ºé”™ä¸ä¼šç›´æ¥æŠ›åˆ°ä¸šåŠ¡å±‚ï¼‰ã€‚</li>
</ol>
<p>è¿™æ ·ç”¨çš„æ—¶å€™ï¼Œå°±å¯ä»¥ç›´æ¥å†™ï¼š</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redisUtils.<span class="built_in">set</span>(<span class="string">&quot;user:1001&quot;</span>, <span class="keyword">user</span>Obj, <span class="number">60000</span>);</span><br><span class="line">List<span class="variable">&lt;String&gt;</span> messages = redisUtils.getQueueList(<span class="string">&quot;chat:room:1&quot;</span>);</span><br><span class="line">redisUtils.zaddCount(<span class="string">&quot;ranking&quot;</span>, <span class="string">&quot;playerA&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>è€Œä¸ç”¨è‡ªå·±åå¤å†™ <code>redisTemplate</code> çš„åº•å±‚ APIã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/Untitled-diagram-_-Mermaid-Chart-2025-08-08-065429-1024x56.png" alt="img"></p>
<p>ç”¨Redisæ”¹é€ checkCodeå’Œregisteræ–¹æ³•</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title class_">RedisUtils</span> redisUtils;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">checkCode</span>(<span class="params"><span class="title class_">HttpSession</span> session</span>)&#123;</span><br><span class="line">      <span class="comment">// éªŒè¯ç </span></span><br><span class="line">      <span class="title class_">ArithmeticCaptcha</span> captcha = <span class="keyword">new</span> <span class="title class_">ArithmeticCaptcha</span>(<span class="number">100</span>, <span class="number">42</span>);</span><br><span class="line">      <span class="comment">//æ‹¿åˆ°éªŒè¯ç æ–‡æœ¬å†…å®¹</span></span><br><span class="line">      <span class="title class_">String</span> code = captcha.<span class="title function_">text</span>();</span><br><span class="line">      <span class="comment">//å°†éªŒè¯ç å­˜å…¥redisï¼Œæœ‰æ•ˆæœŸ10åˆ†é’Ÿ</span></span><br><span class="line">      redisUtils.<span class="title function_">setex</span>(<span class="string">&quot;checkCode&quot;</span>,code,<span class="number">1000</span>*<span class="number">60</span>*<span class="number">10</span>);</span><br><span class="line">      <span class="comment">//å°†éªŒè¯ç å›¾ç‰‡è½¬æˆbase64ç¼–ç </span></span><br><span class="line">      <span class="title class_">String</span> checkCodeBase64 = captcha.<span class="title function_">toBase64</span>();</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">getSucessResponseVo</span>(checkCodeBase64);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@RequestMapping</span>(<span class="string">&quot;/register&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">register</span>(<span class="params"><span class="title class_">String</span> checkCode</span>)&#123;</span><br><span class="line">      <span class="comment">//æ ¡éªŒéªŒè¯ç </span></span><br><span class="line">      <span class="title class_">String</span> myCheckCode = (<span class="title class_">String</span>)redisUtils.<span class="title function_">get</span>(<span class="string">&quot;checkCode&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">getSucessResponseVo</span>(myCheckCode.<span class="title function_">equalsIgnoreCase</span>(checkCode));</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-588.png" alt="img"></p>
<p>è¾“å…¥0ä¸ºtrue</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-587.png" alt="img"></p>
<p>è¾“å…¥1ä¸ºfalse</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-589.png" alt="img"></p>
<p>é—®é¢˜ï¼š</p>
<p>æ²¡æœ‰æŒ‡å®šç”¨æˆ·idï¼Œå½“å…¶ä»–ç”¨æˆ·åŒæ—¶å‘èµ·è¯·æ±‚éªŒè¯ç æ—¶ï¼Œä¸Šä¸€ä¸ªç”¨æˆ·çš„éªŒè¯ç å°±ä¼šè¢«è¦†ç›–æ‰</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-590.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-591.png" alt="img"></p>
<p><strong>ä¸ºä»€ä¹ˆ Redis è¿™é‡Œä¼šå‡ºé—®é¢˜</strong></p>
<ul>
<li>Redis æ˜¯ä¸€ä¸ªå…¨å±€çš„ KV å­˜å‚¨ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰ç”¨æˆ·è®¿é—®çš„ key éƒ½æ˜¯åœ¨åŒä¸€ä¸ªå‘½åç©ºé—´é‡Œå…±äº«çš„ã€‚</li>
<li>å¦‚æœä½ ä¸ç”¨ç”¨æˆ·å”¯ä¸€æ ‡è¯†ï¼ˆä¾‹å¦‚ç”¨æˆ· IDã€æ‰‹æœºå·ã€sessionIdã€ä¸´æ—¶ tokenï¼‰åŒºåˆ† keyï¼Œé‚£åŒåçš„ key å°±ä¼šäº’ç›¸è¦†ç›–ã€‚</li>
<li>è¿™ä¸ªé—®é¢˜æœ¬è´¨ä¸Šæ˜¯ <strong>å¤šç”¨æˆ·å…±äº«äº†åŒä¸€ä¸ª key</strong>ã€‚</li>
</ul>
<p>è¿™å°±æ˜¯ <strong>Session å¤©ç„¶æ˜¯â€œç”¨æˆ·éš”ç¦»â€å­˜å‚¨</strong>ï¼Œè€Œ <strong>Redis æ˜¯å…¨å±€å…±äº«å­˜å‚¨ï¼Œéœ€è¦è‡ªå·±åŠ éš”ç¦»æ ‡è¯†</strong> çš„åŒºåˆ«ã€‚</p>
<h5 id="ä¿®æ”¹é—®é¢˜">ä¿®æ”¹é—®é¢˜</h5>
<p>åœ¨commonæ¨¡å—entityä¸­å»ºåŒ…constants</p>
<p>Constants</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title class_"><span class="keyword">class</span> <span class="title">Constants</span> </span>&#123;</span><br><span class="line">    <span class="comment">//rediså‰ç¼€,åŒºåˆ†ä¸åŒé¡¹ç›®</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> REDIS_KEY_PREFIX = <span class="string">&quot;easylive:&quot;</span>;</span><br><span class="line">    <span class="comment">//éªŒè¯ç å‰ç¼€</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> REDIS_KEY_CHECK_CODE = REDIS_KEY_PREFIX+<span class="string">&quot;checkCode:&quot;</span>;</span><br><span class="line">    <span class="comment">//è®¾ç½®è¿‡æœŸæ—¶é—´1åˆ†é’Ÿ(æ¯«ç§’)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Integer REDIS_KEY_EXPIRES_ONE_MIN = <span class="number">60000</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨commonæ¨¡å—å»ºåŒ…component</p>
<p>RedisCompoent</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisComponent</span> &#123;</span><br><span class="line">   <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">RedisUtils</span> redisUtils;</span><br><span class="line">   <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">saveCheckCode</span>(<span class="params"><span class="title class_">String</span> code</span>)&#123;</span><br><span class="line">       <span class="title class_">String</span> checkCodeKey = <span class="variable constant_">UUID</span>.<span class="title function_">randomUUID</span>().<span class="title function_">toString</span>();</span><br><span class="line">       <span class="comment">//è®¾ç½®è¿‡æœŸæ—¶é—´10åˆ†é’Ÿ(æ¯«ç§’)</span></span><br><span class="line">       redisUtils.<span class="title function_">setex</span>(<span class="title class_">Constants</span>.<span class="property">REDIS_KEY_CHECK_CODE</span>+checkCodeKey,code,<span class="title class_">Constants</span>.<span class="property">REDIS_KEY_EXPIRES_ONE_MIN</span>*<span class="number">10</span>);</span><br><span class="line">       <span class="keyword">return</span> checkCodeKey;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AccoutController</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/account&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">&quot;/checkCode&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">RedisComponent</span> redisComponent;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">checkCode</span>(<span class="params"><span class="title class_">HttpSession</span> session</span>)&#123;</span><br><span class="line">        <span class="comment">// éªŒè¯ç </span></span><br><span class="line">        <span class="title class_">ArithmeticCaptcha</span> captcha = <span class="keyword">new</span> <span class="title class_">ArithmeticCaptcha</span>(<span class="number">100</span>, <span class="number">42</span>);</span><br><span class="line">        <span class="comment">//æ‹¿åˆ°éªŒè¯ç æ–‡æœ¬å†…å®¹</span></span><br><span class="line">        <span class="title class_">String</span> code = captcha.<span class="title function_">text</span>();</span><br><span class="line">        <span class="comment">//ä¿å­˜éªŒè¯ç æ–‡æœ¬å†…å®¹åˆ°redis</span></span><br><span class="line">        <span class="title class_">String</span> checkCodeKey = redisComponent.<span class="title function_">saveCheckCode</span>(code);</span><br><span class="line">        <span class="comment">//å°†éªŒè¯ç å›¾ç‰‡è½¬ä¸ºbase64ç¼–ç </span></span><br><span class="line">        <span class="title class_">String</span> checkCodeBase64 = captcha.<span class="title function_">toBase64</span>();</span><br><span class="line">        <span class="comment">//å°è£…è¿”å›ç»“æœ</span></span><br><span class="line">        <span class="title class_">Map</span>&lt;<span class="title class_">String</span>,<span class="title class_">String</span>&gt;result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        result.<span class="title function_">put</span>(<span class="string">&quot;checkCode&quot;</span>,checkCodeBase64);</span><br><span class="line">        result.<span class="title function_">put</span>(<span class="string">&quot;checkCodeKey&quot;</span>,checkCodeKey);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">getSucessResponseVo</span>(checkCodeBase64);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ³¨é‡Šæ‰ä¸‹é¢çš„ä»£ç ï¼Œåé¢å†ä¿®æ”¹</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">&quot;/register&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">register</span>(<span class="params"><span class="title class_">String</span> checkCode</span>)&#123;</span><br><span class="line">        <span class="comment">//æ ¡éªŒéªŒè¯ç </span></span><br><span class="line">        <span class="comment">//String myCheckCode = (String)redisUtils.get(&quot;checkCode&quot;);</span></span><br><span class="line">        <span class="comment">//return getSucessResponseVo(myCheckCode.equalsIgnoreCase(checkCode));</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-592.png" alt="img"></p>
<p>æ­¤æ—¶è¿”å›çš„æ˜¯ä¸€ä¸ªå›¾ç‰‡å’Œä¸€ä¸ªuuid</p>
<p>æ”¹é€ register</p>
<p>åœ¨Constansä¸­åŠ å…¥å¯†ç éªŒè¯å¸¸é‡</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">å¯†ç æ ¡éªŒ</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> final <span class="title class_">String</span> <span class="variable constant_">REGEX_PASSWORD</span> = <span class="string">&quot;^(?=.*\\d)(?=.*[a-zA-Z])[\\da-zA-Z~!@#$%^&amp;*_]&#123;8,18&#125;$&quot;</span>;</span><br><span class="line"><span class="meta">@Validated</span><span class="comment">//æ ¡éªŒå‚æ•°</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/register&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">register</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="meta">@Email</span> <span class="meta">@Size</span>(max = <span class="number">150</span>) <span class="title class_">String</span> email,</span></span><br><span class="line"><span class="params">                               <span class="meta">@NotEmpty</span> <span class="meta">@Size</span>(max = <span class="number">20</span>) <span class="title class_">String</span> nickName,</span></span><br><span class="line"><span class="params">                               <span class="meta">@NotEmpty</span> <span class="meta">@Pattern</span>(regexp = Constants.REGEX_PASSWORD) <span class="title class_">String</span> registerPassword,</span></span><br><span class="line"><span class="params">                               <span class="meta">@NotEmpty</span> <span class="title class_">String</span> checkCodeKey,</span></span><br><span class="line"><span class="params">                               <span class="meta">@NotEmpty</span> <span class="title class_">String</span> checkCode</span>)&#123;</span><br><span class="line">        <span class="comment">//æ ¡éªŒéªŒè¯ç </span></span><br><span class="line">        <span class="comment">//String myCheckCode = (String)redisUtils.get(&quot;checkCode&quot;);</span></span><br><span class="line">        <span class="comment">//return getSucessResponseVo(myCheckCode.equalsIgnoreCase(checkCode));</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ä¸€ä¸‹è¿™ä¸ªæ¥å£</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-594-1024x822.png" alt="img"></p>
<p>è¿™æ˜¯å› ä¸ºå…¨å±€å¤„ç†ä¸­æ²¡æœ‰å¯¹è¿™ä¸ªå¼‚å¸¸è¿›è¡Œå¤„ç†</p>
<p>æ‰€ä»¥åœ¨å…¨å±€å¤„ç†ä¸­åŠ å…¥å¯¹æ²¡æœ‰é€šè¿‡å¯†ç æ ¡éªŒçš„å¼‚å¸¸å¤„ç†</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-593-1024x194.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-595.png" alt="img"></p>
<p>åœ¨RedisComponent æ·»åŠ è·å–éªŒè¯ç å’Œæ¸…é™¤éªŒè¯ç çš„åŠŸèƒ½</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getCheckCode</span>(<span class="params"><span class="title class_">String</span> checkCodeKey</span>)&#123;</span><br><span class="line">       <span class="comment">//è·å–éªŒè¯ç </span></span><br><span class="line">       <span class="keyword">return</span> (<span class="title class_">String</span>) redisUtils.<span class="title function_">get</span>(<span class="title class_">Constants</span>.<span class="property">REDIS_KEY_CHECK_CODE</span>+checkCodeKey);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">clearCheckCode</span>(<span class="params"><span class="title class_">String</span> checkCodeKey</span>)&#123;</span><br><span class="line">       <span class="comment">//æ¸…é™¤éªŒè¯ç </span></span><br><span class="line">       redisUtils.<span class="title function_">delete</span>(<span class="title class_">Constants</span>.<span class="property">REDIS_KEY_CHECK_CODE</span>+checkCodeKey);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨AccountControllerä¸­</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@RequestMapping</span>(<span class="string">&quot;/register&quot;</span>)</span><br><span class="line"></span><br><span class="line">    public ResponseVO <span class="built_in">register</span>(<span class="variable">@NotEmpty</span> <span class="variable">@Email</span> <span class="variable">@Size</span>(max = <span class="number">150</span>) String email,</span><br><span class="line">                               <span class="variable">@NotEmpty</span> <span class="variable">@Size</span>(max = <span class="number">20</span>) String nickName,</span><br><span class="line">                               <span class="variable">@NotEmpty</span> <span class="variable">@Pattern</span>(regexp = Constants.REGEX_PASSWORD) String registerPassword,</span><br><span class="line">                               <span class="variable">@NotEmpty</span> String checkCodeKey,</span><br><span class="line">                               <span class="variable">@NotEmpty</span> String checkCode)&#123;</span><br><span class="line">        <span class="selector-tag">try</span> &#123;</span><br><span class="line">            <span class="selector-tag">if</span>(!checkCode.<span class="built_in">equals</span>(redisComponent.<span class="built_in">getCheckCode</span>(checkCodeKey))) &#123;</span><br><span class="line">                <span class="selector-tag">throw</span> <span class="selector-tag">new</span> <span class="selector-tag">BusinessException</span>(Constants.MESSAGE_CHECKCODE_ERROR);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="selector-tag">userInfoService</span><span class="selector-class">.register</span>(email,nickName,registerPassword);</span><br><span class="line">            <span class="selector-tag">return</span> <span class="selector-tag">getSucessResponseVo</span>(null);</span><br><span class="line">        &#125;<span class="selector-tag">finally</span>&#123;</span><br><span class="line">                <span class="comment">//ä¸ç®¡éªŒè¯ç æ­£ç¡®è¿˜æ˜¯é”™è¯¯ç”¨å®Œå°±æ¸…é™¤éªŒè¯ç </span></span><br><span class="line">                <span class="selector-tag">redisComponent</span><span class="selector-class">.clearCheckCode</span>(checkCodeKey);</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Constants.MESSAGE_CHECKCODE_ERRORéœ€è¦åœ¨Constantsé‡ŒåŠ ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-596.png" alt="img"></p>
<h3 id="2-å®ç°æ³¨å†Œ">2.å®ç°æ³¨å†Œ</h3>
<p>åœ¨userInfoServiceé‡Œå®šä¹‰è¿™ä¸ªæ–¹æ³•</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-598.png" alt="img"></p>
<p>userInfoServiceImplæ¥ä¸‹æ¥å†™æ³¨å†Œæ–¹æ³•çš„å®ç°</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">  public void register<span class="params">(String email, String nickName, String registerPassword)</span> &#123;</span><br><span class="line"><span class="string">//</span>        <span class="string">//</span>æ ¹æ®é‚®ç®±æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</span><br><span class="line"><span class="string">//</span>        UserInfo userInfo = this.userInfoMapper.selectByEmail<span class="params">(email)</span>;</span><br><span class="line"><span class="string">//</span>        <span class="string">//</span>å½“ç”¨æˆ·ä¿¡æ¯ä¸ä¸ºç©ºæ—¶</span><br><span class="line"><span class="string">//</span>      <span class="keyword">if</span> <span class="params">(userInfo != null)</span> &#123;</span><br><span class="line"><span class="string">//</span>          <span class="string">//</span>æ ¹æ®æ˜µç§°æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</span><br><span class="line"><span class="string">//</span>          userInfo nickNameUser = this.userInfoMapper.selectByNickName<span class="params">(nickName)</span>;</span><br><span class="line"><span class="string">//</span>          <span class="string">//</span>å½“æ˜µç§°ç”¨æˆ·ä¿¡æ¯ä¸ä¸ºç©ºæ—¶</span><br><span class="line"><span class="string">//</span>          <span class="keyword">if</span> <span class="params">(nickNameUser != null)</span> &#123;</span><br><span class="line"><span class="string">//</span>              <span class="string">//</span>åˆ›å»ºç”¨æˆ·ä¿¡æ¯å¯¹è±¡</span><br><span class="line"><span class="string">//</span>              userInfo = new UserInfo<span class="params">()</span>;</span><br><span class="line"><span class="string">//</span>              <span class="string">//</span>ç”¨æˆ·IDè®¾ç½®ä¸º10ä½éšæœºæ•°</span><br><span class="line"><span class="string">//</span>              String userId = StringTools.getRandomNumber<span class="params">(Constants.LENGTH_10)</span>;</span><br><span class="line"><span class="string">//</span>              <span class="string">//</span>è®¾ç½®ç”¨æˆ·ID</span><br><span class="line"><span class="string">//</span>              userInfo.<span class="keyword">set</span>UserId<span class="params">(userId)</span>;</span><br><span class="line"><span class="string">//</span>              <span class="string">//</span>è®¾ç½®ç”¨æˆ·æ˜µç§°</span><br><span class="line"><span class="string">//</span>              userInfo.<span class="keyword">set</span>NickName<span class="params">(nickName)</span>;</span><br><span class="line"><span class="string">//</span>              <span class="string">//</span>è®¾ç½®ç”¨æˆ·å¯†ç ,å¯¹å¯†ç è¿›è¡ŒMD5åŠ å¯†å¤„ç†</span><br><span class="line"><span class="string">//</span>              userInfo.<span class="keyword">set</span>Password<span class="params">(StringTools.encodeByMd5(registerPassword)</span>);</span><br><span class="line"><span class="string">//</span>              <span class="string">//</span>è®¾ç½®ç”¨æˆ·åŠ å…¥æ—¶é—´</span><br><span class="line"><span class="string">//</span>              userInfo.<span class="keyword">set</span>JoinTime<span class="params">(new Date()</span>);</span><br><span class="line"><span class="string">//</span>              <span class="string">//</span>è®¾ç½®ç”¨æˆ·çŠ¶æ€ï¼Œé»˜è®¤å¯ç”¨</span><br><span class="line"><span class="string">//</span>              userInfo.<span class="keyword">set</span>Status<span class="params">(UserStatusEnum.ENABLE.getStatus()</span>);</span><br><span class="line"><span class="string">//</span>              <span class="string">//</span>è®¾ç½®ç”¨æˆ·æ€§åˆ«ï¼Œé»˜è®¤ä¿å¯†</span><br><span class="line"><span class="string">//</span>              userInfo.<span class="keyword">set</span>Sex<span class="params">(UserSexEnum.SECRECY.getType()</span>);</span><br><span class="line"><span class="string">//</span>              <span class="string">//</span>è®¾ç½®ä¸»é¢˜</span><br><span class="line"><span class="string">//</span>              userInfo.<span class="keyword">set</span>Theme<span class="params">(Constants.ONE)</span>;</span><br><span class="line"><span class="string">//</span></span><br><span class="line"><span class="string">//</span>              <span class="string">//TODO</span> åˆå§‹åŒ–ç”¨æˆ·çš„ç¡¬å¸</span><br><span class="line"><span class="string">//</span>              <span class="string">//</span>å°†ç”¨æˆ·ä¿¡æ¯æ’å…¥æ•°æ®åº“</span><br><span class="line"><span class="string">//</span>              this.userInfoMapper.insert<span class="params">(userInfo)</span>;</span><br><span class="line"><span class="string">//</span>              return <span class="literal">true</span>;</span><br><span class="line"><span class="string">//</span>          &#125;<span class="string">//</span> å½“æ˜µç§°ç”¨æˆ·ä¿¡æ¯ä¸ºç©ºæ—¶ï¼Œè¿”å›<span class="literal">false</span></span><br><span class="line"><span class="string">//</span>          else&#123;</span><br><span class="line"><span class="string">//</span>              return <span class="literal">false</span>;</span><br><span class="line"><span class="string">//</span>          &#125;</span><br><span class="line"><span class="string">//</span>      &#125;<span class="string">//</span>å½“ç”¨æˆ·ä¿¡æ¯ä¸ºç©ºæ—¶ï¼Œè¿”å›<span class="literal">false</span></span><br><span class="line"><span class="string">//</span>      else&#123;</span><br><span class="line"><span class="string">//</span>           return <span class="literal">false</span>;</span><br><span class="line"><span class="string">//</span>      &#125;</span><br><span class="line"><span class="string">//</span>    &#125;</span><br><span class="line">        UserInfo userInfo = this.userInfoMapper.selectByEmail<span class="params">(email)</span>;</span><br><span class="line">        <span class="keyword">if</span> <span class="params">(null != userInfo)</span> &#123;</span><br><span class="line">		throw new BusinessException<span class="params">(&quot;é‚®ç®±è´¦å·å·²ç»å­˜åœ¨&quot;)</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	UserInfo nickNameUser = this.userInfoMapper.selectByNickName<span class="params">(nickName)</span>;</span><br><span class="line">        <span class="keyword">if</span> <span class="params">(null != nickNameUser)</span> &#123;</span><br><span class="line">		throw new BusinessException<span class="params">(&quot;æ˜µç§°å·²ç»è¢«å ç”¨&quot;)</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	userInfo = new UserInfo<span class="params">()</span>;</span><br><span class="line">	<span class="string">//</span>ç”¨æˆ·IDè®¾ç½®ä¸º10ä½éšæœºæ•°</span><br><span class="line">	String userId = StringTools.getRandomNumber<span class="params">(Constants.LENGTH_10)</span>;</span><br><span class="line">	<span class="string">//</span>è®¾ç½®ç”¨æˆ·ID</span><br><span class="line">        userInfo.<span class="keyword">set</span>UserId<span class="params">(userId)</span>;</span><br><span class="line">	<span class="string">//</span>è®¾ç½®ç”¨æˆ·æ˜µç§°</span><br><span class="line">        userInfo.<span class="keyword">set</span>NickName<span class="params">(nickName)</span>;</span><br><span class="line">		<span class="string">//</span>è®¾ç½®ç”¨æˆ·é‚®ç®±</span><br><span class="line">		userInfo.<span class="keyword">set</span>Email<span class="params">(email)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="string">//</span>è®¾ç½®ç”¨æˆ·å¯†ç ,å¯¹å¯†ç è¿›è¡ŒMD5åŠ å¯†å¤„ç†</span><br><span class="line">        userInfo.<span class="keyword">set</span>Password<span class="params">(StringTools.encodeByMd5(registerPassword)</span>);</span><br><span class="line">	<span class="string">//</span>è®¾ç½®ç”¨æˆ·åŠ å…¥æ—¶é—´</span><br><span class="line">        userInfo.<span class="keyword">set</span>JoinTime<span class="params">(new Date()</span>);</span><br><span class="line">	<span class="string">//</span>è®¾ç½®ç”¨æˆ·çŠ¶æ€ï¼Œé»˜è®¤å¯ç”¨</span><br><span class="line">        userInfo.<span class="keyword">set</span>Status<span class="params">(UserStatusEnum.ENABLE.getStatus()</span>);</span><br><span class="line">	<span class="string">//</span>è®¾ç½®ç”¨æˆ·æ€§åˆ«ï¼Œé»˜è®¤ä¿å¯†</span><br><span class="line">        userInfo.<span class="keyword">set</span>Sex<span class="params">(UserSexEnum.SECRECY.getType()</span>);</span><br><span class="line">	<span class="string">//</span>è®¾ç½®ä¸»é¢˜</span><br><span class="line">        userInfo.<span class="keyword">set</span>Theme<span class="params">(Constants.ONE)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="string">//TODO</span> åˆå§‹åŒ–ç”¨æˆ·çš„ç¡¬å¸</span><br><span class="line">        userInfo.<span class="keyword">set</span>CurrentCoinCount<span class="params">(10)</span>;</span><br><span class="line">	userInfo.<span class="keyword">set</span>TotalCoinCount<span class="params">(10)</span>;</span><br><span class="line">	<span class="string">//</span>å°†ç”¨æˆ·ä¿¡æ¯æ’å…¥æ•°æ®åº“</span><br><span class="line">        this.userInfoMapper.insert<span class="params">(userInfo)</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>å¯¹æ¯”ç‚¹</th>
<th>æ³¨é‡Šæ‰çš„ä»£ç </th>
<th>æ²¡æ³¨é‡Šçš„ä»£ç </th>
</tr>
</thead>
<tbody>
<tr>
<td>é€»è¾‘ç»“æ„</td>
<td>åµŒå¥—å¤šå±‚ ifï¼Œé˜…è¯»æˆæœ¬é«˜</td>
<td>ç›´çº¿é€»è¾‘ï¼Œæ˜“è¯»</td>
</tr>
<tr>
<td>é”™è¯¯å¤„ç†</td>
<td>è¿”å›å¸ƒå°”å€¼ï¼ŒåŸå› ä¸æ˜ç¡®</td>
<td>æŠ›ä¸šåŠ¡å¼‚å¸¸ï¼Œå¸¦é”™è¯¯ä¿¡æ¯</td>
</tr>
<tr>
<td>ç»´æŠ¤æ€§</td>
<td>åˆ†æ”¯å¤šï¼Œé‡å¤ä»£ç å¯èƒ½å¤š</td>
<td>æ ¡éªŒä¸ä¸šåŠ¡åˆ†ç¦»ï¼Œæ‰©å±•æ€§å¥½</td>
</tr>
<tr>
<td>å¯æµ‹è¯•æ€§</td>
<td>éœ€é¢å¤–è§£æè¿”å›å€¼åˆ¤æ–­</td>
<td>å¼‚å¸¸æœºåˆ¶å¯ç›´æ¥æ•è·</td>
</tr>
</tbody>
</table>
<p>getRandomString()éœ€è¦åœ¨untilsåŒ…ä¸‹StringToolsä¸­å®šä¹‰</p>
<p>å®šä¹‰ä¸¤ç§æ–¹æ³•åç»­éƒ½ä¼šç”¨åˆ°</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-599-1024x184.png" alt="img"></p>
<p>åœ¨Constantsé‡ŒåŠ ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-600.png" alt="img"></p>
<p>åœ¨StringToolsä¸‹åŠ ä¸€ä¸ªencodeByMd5æ–¹æ³•ï¼Œå¯¹å¯†ç è¿›è¡Œmd5åŠ å¯†</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-601-1024x85.png" alt="img"></p>
<p>åˆ›å»ºç”¨æˆ·çŠ¶æ€æšä¸¾</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-838-1024x592.png" alt="img"></p>
<p>åˆ›å»ºç”¨æˆ·æ€§åˆ«æšä¸¾</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-839-1024x678.png" alt="img"></p>
<p>æµ‹è¯•ï¼š</p>
<p>å…ˆå‘éªŒè¯ç ä¸º10</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-605.png" alt="img"></p>
<p>æ³¨å†ŒæˆåŠŸ</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-604-1024x838.png" alt="img"></p>
<p>å†æ¬¡æ³¨å†Œï¼Œé‚®ç®±å·²å­˜åœ¨</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-606-1024x743.png" alt="img"></p>
<h3 id="3-ç”¨æˆ·ç«¯-ç™»å½•ï¼ˆé‡‡ç”¨tokenï¼‰">3.ç”¨æˆ·ç«¯ ç™»å½•ï¼ˆé‡‡ç”¨tokenï¼‰</h3>
<h4 id="æ™®é€šç™»å½•">æ™®é€šç™»å½•</h4>
<p>åœ¨ABaseControlleré‡Œæ·»åŠ è·å–ipçš„æ–¹æ³•</p>
<p>è¿™ä¸ª <code>getIpAddr()</code> æ–¹æ³•æ˜¯ç”¨æ¥<strong>è·å–å®¢æˆ·ç«¯çœŸå® IP åœ°å€</strong>çš„ï¼Œä¸»è¦æ˜¯ä¸ºäº†åº”å¯¹å„ç§ç½‘ç»œè½¬å‘ã€åå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡ç­‰åœºæ™¯ã€‚</p>
<figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">protected String getIp<span class="meta">Addr</span>() &#123;</span><br><span class="line">    HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();</span><br><span class="line">    String ip = request.getHeader(<span class="string">&quot;x-forwarded-for&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ip != <span class="keyword">null</span> <span class="variable">&amp;&amp;</span> ip.<span class="meta">length</span>() != 0 <span class="variable">&amp;&amp;</span> !<span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">        // å¤šæ¬¡åå‘ä»£ç†åä¼šæœ‰å¤šä¸ªipå€¼ï¼Œç¬¬ä¸€ä¸ªipæ‰æ˜¯çœŸå®ip</span><br><span class="line">        <span class="keyword">if</span> (ip.indexOf(<span class="string">&quot;,&quot;</span>) != -1) &#123;</span><br><span class="line">            ip = ip.split(<span class="string">&quot;,&quot;</span>)[0];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ip == <span class="keyword">null</span> || ip.<span class="meta">length</span>() == 0 || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">        ip = request.getHeader(<span class="string">&quot;Proxy-Client-IP&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ip == <span class="keyword">null</span> || ip.<span class="meta">length</span>() == 0 || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">        ip = request.getHeader(<span class="string">&quot;WL-Proxy-Client-IP&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ip == <span class="keyword">null</span> || ip.<span class="meta">length</span>() == 0 || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">        ip = request.getHeader(<span class="string">&quot;HTTP_CLIENT_IP&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ip == <span class="keyword">null</span> || ip.<span class="meta">length</span>() == 0 || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">        ip = request.getHeader(<span class="string">&quot;HTTP_X_FORWARDED_FOR&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ip == <span class="keyword">null</span> || ip.<span class="meta">length</span>() == 0 || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">        ip = request.getHeader(<span class="string">&quot;X-Real-IP&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ip == <span class="keyword">null</span> || ip.<span class="meta">length</span>() == 0 || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">        ip = request.getRemote<span class="meta">Addr</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ip;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-845.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-846.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-847.png" alt="img"></p>
<p>åœ¨utilsåŒ…ä¸‹å»ºCopyToolså¯¹è±¡å±æ€§å¤åˆ¶å·¥å…·ç±»</p>
<p>ä¸»è¦ç”¨æ¥æŠŠä¸€ä¸ªå¯¹è±¡ï¼ˆæˆ–å¯¹è±¡åˆ—è¡¨ï¼‰çš„å­—æ®µå€¼å¤åˆ¶åˆ°å¦ä¸€ä¸ªå¯¹è±¡é‡Œï¼Œé¿å…ä½ æ‰‹åŠ¨ä¸€è¡Œè¡Œå»èµ‹å€¼ã€‚å®ƒåŸºäº Spring æ¡†æ¶æä¾›çš„ <code>BeanUtils.copyProperties()</code> æ–¹æ³•å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CopyTools</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T, S&gt; List&lt;T&gt; <span class="title function_">copyList</span><span class="params">(List&lt;S&gt; sList, Class&lt;T&gt; classz)</span> &#123;</span><br><span class="line">        List&lt;T&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;T&gt;();</span><br><span class="line">        <span class="keyword">for</span> (S s : sList) &#123;</span><br><span class="line">            <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                t = classz.newInstance();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            BeanUtils.copyProperties(s, t);</span><br><span class="line">            list.add(t);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T, S&gt; T <span class="title function_">copy</span><span class="params">(S s, Class&lt;T&gt; classz)</span> &#123;</span><br><span class="line">        <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            t = classz.newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        BeanUtils.copyProperties(s, t);</span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T, S&gt; <span class="keyword">void</span> <span class="title function_">copyProperties</span><span class="params">(S s, T t)</span> &#123;</span><br><span class="line">        BeanUtils.copyProperties(s, t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-840.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-841.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-842.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-843.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-844.png" alt="img"></p>
<p>å°†tokenä¿å­˜åˆ°cookieï¼Œåœ¨ABaseControllerä¸­æ·»åŠ saveTokenToCookieæ–¹æ³•</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°†tokenä¿å­˜åˆ°cookieä¸­</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">void</span> <span class="title function_">saveTokenToCookie</span>(<span class="params"><span class="title class_">HttpServletResponse</span> response, <span class="title class_">String</span> token</span>) &#123;</span><br><span class="line">        <span class="title class_">Cookie</span> cookie = <span class="keyword">new</span> <span class="title class_">Cookie</span>(<span class="title class_">Constants</span>.<span class="property">TOKEN_WEB</span>, token);</span><br><span class="line">        <span class="comment">// è®¾ç½®cookieæœ‰æ•ˆæœŸä¸º7å¤©</span></span><br><span class="line">        cookie.<span class="title function_">setMaxAge</span>(<span class="title class_">Constants</span>.<span class="property">TIME_SECONDS_DAY</span> *<span class="number">7</span>);</span><br><span class="line">        cookie.<span class="title function_">setPath</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        response.<span class="title function_">addCookie</span>(cookie);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ”¾åˆ°Cookieä¸­çš„tokenå‰ç¼€</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TOKEN_WEB</span> <span class="operator">=</span> <span class="string">&quot;token&quot;</span>;</span><br><span class="line"><span class="comment">//è®¾ç½®è¿‡æœŸæ—¶é—´1å¤©</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">REDIS_KEY_EXPIRES_ONE_DAY</span> <span class="operator">=</span> <span class="number">86400000</span>;</span><br><span class="line">  <span class="comment">//è®¾ç½®è¿‡æœŸæ—¶é—´1å¤©ï¼ˆå•ä½ç§’ï¼‰</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">TIME_SECONDS_DAY</span> <span class="operator">=</span> REDIS_KEY_EXPIRES_ONE_DAY/<span class="number">1000</span>;</span><br></pre></td></tr></table></figure>
<p>ç™»å½•æ–¹æ³•ï¼š</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">login</span>(<span class="params"><span class="title class_">HttpServletResponse</span> response,</span></span><br><span class="line"><span class="params">                            <span class="meta">@NotEmpty</span> <span class="meta">@Email</span> <span class="title class_">String</span> email,</span></span><br><span class="line"><span class="params">                            <span class="meta">@NotEmpty</span> <span class="title class_">String</span> password,</span></span><br><span class="line"><span class="params">                            <span class="meta">@NotEmpty</span> <span class="title class_">String</span> checkCodeKey,</span></span><br><span class="line"><span class="params">                            <span class="meta">@NotEmpty</span> <span class="title class_">String</span> checkCode</span>)&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(!checkCode.<span class="title function_">equalsIgnoreCase</span>(redisComponent.<span class="title function_">getCheckCode</span>(checkCodeKey))) &#123;</span><br><span class="line">                <span class="comment">//éªŒè¯ç é”™è¯¯ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="title class_">String</span>.<span class="title function_">valueOf</span>(<span class="title class_">Constants</span>.<span class="property">MESSAGE_CHECKCODE_ERROR</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title class_">String</span> ip = <span class="title function_">getIpAddr</span>();</span><br><span class="line">            <span class="title class_">TokenUserInfoDto</span> tokenUserInfoDto= userInfoService.<span class="title function_">login</span>(email,password,ip);</span><br><span class="line">            <span class="comment">//å°†tokenå†™å…¥åˆ°cookieä¸­</span></span><br><span class="line">            <span class="title function_">saveTokenToCookie</span>(response,tokenUserInfoDto.<span class="title function_">getToken</span>());</span><br><span class="line">            <span class="comment">//TODO è®¾ç½®ç²‰ä¸æ•°ã€å…³æ³¨æ•°ã€ç¡¬å¸æ•°ç­‰ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(tokenUserInfoDto);</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//ä¸ç®¡éªŒè¯ç æ­£ç¡®è¿˜æ˜¯é”™è¯¯ç”¨å®Œå°±æ¸…é™¤éªŒè¯ç </span></span><br><span class="line">            redisComponent.<span class="title function_">cleanCheckCode</span>(checkCodeKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>å®ç°ç±»æ¥å£UserInfoService</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç™»å½•ç”¨æˆ·</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function">TokenUserInfoDto <span class="title">login</span><span class="params">(<span class="type">String</span> email, <span class="type">String</span> password, <span class="type">String</span> ip)</span></span>;</span><br></pre></td></tr></table></figure>
<p>å®ç°ç±»UserInfoServiceImpl</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">TokenUserInfoDto</span> <span class="title function_">login</span>(<span class="params"><span class="title class_">String</span> email, <span class="title class_">String</span> password, <span class="title class_">String</span> ip</span>) &#123;</span><br><span class="line">		<span class="title class_">UserInfo</span> userInfo = <span class="variable language_">this</span>.<span class="property">userInfoMapper</span>.<span class="title function_">selectByEmail</span>(email);</span><br><span class="line">		<span class="comment">//åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œå¹¶ä¸”å¯†ç æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">		<span class="keyword">if</span>(<span class="literal">null</span> == userInfo ||!userInfo.<span class="title function_">getPassword</span>().<span class="title function_">equals</span>(password)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;è´¦å·æˆ–å¯†ç é”™è¯¯&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//åˆ¤æ–­ç”¨æˆ·æ˜¯å¦è¢«ç¦ç”¨</span></span><br><span class="line">		<span class="keyword">if</span>(<span class="title class_">UserStatusEnum</span>.<span class="property">DISABLE</span>.<span class="title function_">getStatus</span>().<span class="title function_">equals</span>(userInfo.<span class="title function_">getStatus</span>() )) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;è´¦å·å·²ç¦ç”¨&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//åˆ›å»ºä¸€ä¸ªæ–°çš„ updateInfo å¯¹è±¡ï¼Œå‡†å¤‡ç”¨æ¥æ›´æ–°æ•°æ®åº“ã€‚</span></span><br><span class="line">		<span class="title class_">UserInfo</span> updateInfo = <span class="keyword">new</span> <span class="title class_">UserInfo</span>();</span><br><span class="line">		<span class="comment">//æ›´æ–°ç”¨æˆ·æœ€åç™»å½•æ—¶é—´</span></span><br><span class="line">		updateInfo.<span class="title function_">setLastLoginTime</span>(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">		<span class="comment">//æ›´æ–°ç”¨æˆ·æœ€åç™»å½•IP</span></span><br><span class="line">		updateInfo.<span class="title function_">setLastLoginIp</span>(ip);</span><br><span class="line">		<span class="comment">//æ›´æ–°ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">		<span class="variable language_">this</span>.<span class="property">userInfoMapper</span>.<span class="title function_">updateByUserId</span>(updateInfo, userInfo.<span class="title function_">getUserId</span>());</span><br><span class="line">        <span class="comment">//å°è£…ç”¨æˆ·ä¿¡æ¯ï¼Œå‡†å¤‡è¿”å›ç»™å‰ç«¯</span></span><br><span class="line">		<span class="title class_">TokenUserInfoDto</span> tokenUserInfoDto = <span class="title class_">CopyTools</span>.<span class="title function_">copy</span>(userInfo, <span class="title class_">TokenUserInfoDto</span>.<span class="property">class</span>);</span><br><span class="line">	    <span class="comment">//å°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­ï¼Œå¹¶è¿”å›token</span></span><br><span class="line">		redisComponent.<span class="title function_">saveTokenInfo</span>(tokenUserInfoDto);</span><br><span class="line">		<span class="keyword">return</span> tokenUserInfoDto;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-848-1024x920.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-849-1024x737.png" alt="img"></p>
<p>æ›´æ–°Controllerå±‚çš„å®ç°ï¼Œæ·»åŠ åŠŸèƒ½ï¼šæ¯ä¸€æ¬¡è·å–æ–°tokenæ—¶ï¼Œåœ¨redisä¸­æ¸…é™¤æ—§çš„token</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">login</span>(<span class="params"><span class="title class_">HttpServletRequest</span> request,</span></span><br><span class="line"><span class="params">                            <span class="title class_">HttpServletResponse</span> response,</span></span><br><span class="line"><span class="params">                            <span class="meta">@NotEmpty</span> <span class="meta">@Email</span> <span class="title class_">String</span> email,</span></span><br><span class="line"><span class="params">                            <span class="meta">@NotEmpty</span> <span class="title class_">String</span> password,</span></span><br><span class="line"><span class="params">                            <span class="meta">@NotEmpty</span> <span class="title class_">String</span> checkCodeKey,</span></span><br><span class="line"><span class="params">                            <span class="meta">@NotEmpty</span> <span class="title class_">String</span> checkCode</span>)&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(!checkCode.<span class="title function_">equalsIgnoreCase</span>(redisComponent.<span class="title function_">getCheckCode</span>(checkCodeKey))) &#123;</span><br><span class="line">                <span class="comment">//éªŒè¯ç é”™è¯¯ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="title class_">String</span>.<span class="title function_">valueOf</span>(<span class="title class_">Constants</span>.<span class="property">MESSAGE_CHECKCODE_ERROR</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title class_">String</span> ip = <span class="title function_">getIpAddr</span>();</span><br><span class="line">            <span class="title class_">TokenUserInfoDto</span> tokenUserInfoDto= userInfoService.<span class="title function_">login</span>(email,password,ip);</span><br><span class="line">            <span class="comment">//å°†tokenå†™å…¥åˆ°cookieä¸­</span></span><br><span class="line">            <span class="title function_">saveTokenToCookie</span>(response,tokenUserInfoDto.<span class="title function_">getToken</span>());</span><br><span class="line">            <span class="comment">//TODO è®¾ç½®ç²‰ä¸æ•°ã€å…³æ³¨æ•°ã€ç¡¬å¸æ•°ç­‰ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(tokenUserInfoDto);</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//ä¸ç®¡éªŒè¯ç æ­£ç¡®è¿˜æ˜¯é”™è¯¯ç”¨å®Œå°±æ¸…é™¤éªŒè¯ç </span></span><br><span class="line">            redisComponent.<span class="title function_">cleanCheckCode</span>(checkCodeKey);</span><br><span class="line">             <span class="comment">//å½“æœ‰cookieæ—¶æ¯ä¸€æ¬¡è·å–æ–°tokenæ—¶ï¼Œåœ¨redisä¸­æ¸…é™¤æ—§çš„token</span></span><br><span class="line">            <span class="keyword">if</span>(request.<span class="title function_">getCookies</span>() != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">//è·å–cookieæ•°ç»„</span></span><br><span class="line">                <span class="title class_">Cookie</span>[] cookies = request.<span class="title function_">getCookies</span>();</span><br><span class="line">                <span class="title class_">String</span> token = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="title class_">Cookie</span> cookie : cookies) &#123;</span><br><span class="line">                    <span class="comment">//å¦‚æœcookieçš„åå­—æ˜¯tokenï¼Œåˆ™è·å–å®ƒçš„å€¼</span></span><br><span class="line">                    <span class="keyword">if</span> (cookie.<span class="title function_">getName</span>().<span class="title function_">equals</span>(<span class="title class_">Constants</span>.<span class="property">TOKEN_WEB</span>)) &#123;</span><br><span class="line">                        token = cookie.<span class="title function_">getValue</span>();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//å¦‚æœcookieä¸­æœ‰tokenï¼Œåˆ™æ¸…é™¤redisä¸­çš„æ—§token</span></span><br><span class="line">                <span class="keyword">if</span> (!<span class="title class_">StringTools</span>.<span class="title function_">isEmpty</span>(token)) &#123;</span><br><span class="line">                    <span class="comment">//æ¸…é™¤æ—§çš„token</span></span><br><span class="line">                    redisComponent.<span class="title function_">cleanToken</span>(token);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ redisComponentä¸­æ·»åŠ cleanTokenæ–¹æ³•</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">     * æ¸…é™¤<span class="type">token</span>ä¿¡æ¯</span><br><span class="line">     * <span class="title">@param</span> <span class="type">token</span></span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">    public <span class="type">void</span> cleanToken(String <span class="type">token</span>) &#123;</span><br><span class="line">        redisUtils.delete(Constants.REDIS_KEY_TOKEN_WEB + <span class="type">token</span>)<span class="comment">;</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="è‡ªåŠ¨ç™»å½•">è‡ªåŠ¨ç™»å½•</h4>
<p>Controllerä¸­</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * è‡ªåŠ¨ç™»å½•</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">   <span class="meta">@RequestMapping</span>(<span class="string">&quot;/autoLogin&quot;</span>)</span><br><span class="line">   <span class="keyword">public</span> <span class="function">ResponseVO <span class="title">autoLogin</span><span class="params">(HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//ä»redisä¸­æ‹¿åˆ°token</span></span><br><span class="line">       TokenUserInfoDto tokenUserInfoDto = getTokenUserInfoDto();</span><br><span class="line">       <span class="comment">//å¦‚æœtokenä¸ºç©ºï¼Œè¯´æ˜ä½ é•¿æ—¶é—´æ²¡æœ‰ç™»å½•ï¼Œæˆ–è€…ä½ ä¹‹å‰æ²¡æœ‰ç™»å½•è¿‡</span></span><br><span class="line">       <span class="keyword">if</span> (tokenUserInfoDto == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="function"><span class="keyword">return</span> <span class="title">getSuccessResponseVO</span><span class="params">(<span class="keyword">null</span>)</span></span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//å¦‚æœtokençš„è¿‡æœŸæ—¶é—´å°äºä¸€å¤©ï¼Œåˆ™é‡æ–°ä¿å­˜åˆ°redisä¸­ï¼ˆä¸ºå®ƒç»­æœŸï¼‰</span></span><br><span class="line">       <span class="keyword">if</span> (tokenUserInfoDto.getExpireAt() - System.currentTimeMillis() &lt; Constants.REDIS_KEY_EXPIRES_ONE_DAY) &#123;</span><br><span class="line">           redisComponent.saveTokenInfo(tokenUserInfoDto);</span><br><span class="line">           <span class="comment">//å°†ç»­æœŸçš„æ–°tokenå†™å…¥åˆ°cookieä¸­</span></span><br><span class="line">           saveTokenToCookie(response, tokenUserInfoDto.getToken());</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//ifå¤–çš„saveToken2Cookieä¸å¤šä½™ï¼Œç”¨æˆ·ç™»å½•ä¸€æ¬¡å°±é‡ç½®cookieæœ‰æ•ˆæœŸ</span></span><br><span class="line">       saveTokenToCookie(response, tokenUserInfoDto.getToken());</span><br><span class="line">       <span class="comment">//TODO è®¾ç½®ç²‰ä¸æ•°ã€å…³æ³¨æ•°ã€ç¡¬å¸æ•°ç­‰ä¿¡æ¯</span></span><br><span class="line">       <span class="function"><span class="keyword">return</span> <span class="title">getSuccessResponseVO</span><span class="params">(tokenUserInfoDto)</span></span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>æœ‰å…³tokençš„æ–¹æ³•å®šä¹‰åœ¨RedisComponentä¸­</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¿å­˜tokenä¿¡æ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> <span class="variable">tokenUserInfoDto</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">saveTokenInfo</span>(<span class="params"><span class="title class_">TokenUserInfoDto</span> tokenUserInfoDto</span>)&#123;</span><br><span class="line">        <span class="title class_">String</span> token = <span class="variable constant_">UUID</span>.<span class="title function_">randomUUID</span>().<span class="title function_">toString</span>();</span><br><span class="line">        <span class="comment">//è®¾ç½®tokençš„å¤±æ•ˆæ—¶é—´ä¸º7å¤©</span></span><br><span class="line">        tokenUserInfoDto.<span class="title function_">setExpireAt</span>(<span class="title class_">System</span>.<span class="title function_">currentTimeMillis</span>() + <span class="title class_">Constants</span>.<span class="property">REDIS_KEY_EXPIRES_ONE_DAY</span> * <span class="number">7</span>);</span><br><span class="line">        <span class="comment">//è®¾ç½®tokençš„å€¼</span></span><br><span class="line">        tokenUserInfoDto.<span class="title function_">setToken</span>(token);</span><br><span class="line">        <span class="comment">//å°†tokenä¿¡æ¯å­˜å…¥redisä¸­</span></span><br><span class="line">        redisUtils.<span class="title function_">setex</span>(<span class="title class_">Constants</span>.<span class="property">REDIS_KEY_TOKEN_WEB</span> + token,tokenUserInfoDto, <span class="title class_">Constants</span>.<span class="property">REDIS_KEY_EXPIRES_ONE_DAY</span> * <span class="number">7</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¸…é™¤tokenä¿¡æ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> <span class="variable">token</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">cleanToken</span>(<span class="params"><span class="title class_">String</span> token</span>) &#123;</span><br><span class="line">        redisUtils.<span class="title function_">delete</span>(<span class="title class_">Constants</span>.<span class="property">REDIS_KEY_TOKEN_WEB</span> + token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–tokenä¿¡æ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> <span class="variable">token</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">TokenUserInfoDto</span> <span class="title function_">getTokenInfo</span>(<span class="params"><span class="title class_">String</span> token</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="title class_">TokenUserInfoDto</span>) redisUtils.<span class="title function_">get</span>(<span class="title class_">Constants</span>.<span class="property">REDIS_KEY_TOKEN_WEB</span> + token);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ABaseControllerä¸­</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°†tokenä¿å­˜åˆ°cookieä¸­</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">void</span> <span class="title function_">saveTokenToCookie</span>(<span class="params"><span class="title class_">HttpServletResponse</span> response, <span class="title class_">String</span> token</span>) &#123;</span><br><span class="line">        <span class="title class_">Cookie</span> cookie = <span class="keyword">new</span> <span class="title class_">Cookie</span>(<span class="title class_">Constants</span>.<span class="property">TOKEN_WEB</span>, token);</span><br><span class="line">        <span class="comment">// è®¾ç½®cookieæœ‰æ•ˆæœŸä¸º7å¤©</span></span><br><span class="line">        cookie.<span class="title function_">setMaxAge</span>(<span class="title class_">Constants</span>.<span class="property">TIME_SECONDS_DAY</span> *<span class="number">7</span>);</span><br><span class="line">        cookie.<span class="title function_">setPath</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        response.<span class="title function_">addCookie</span>(cookie);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ä»redisä¸­è·å–tokenä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="title class_">TokenUserInfoDto</span> <span class="title function_">getTokenUserInfoDto</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰è¯·æ±‚</span></span><br><span class="line">        <span class="title class_">HttpServletRequest</span> request = ((<span class="title class_">ServletRequestAttributes</span>) <span class="title class_">RequestContextHolder</span>.<span class="title function_">getRequestAttributes</span>()).<span class="title function_">getRequest</span>();</span><br><span class="line">        <span class="comment">// ä»è¯·æ±‚ä¸­è·å–token</span></span><br><span class="line">        <span class="title class_">String</span> token = request.<span class="title function_">getHeader</span>(<span class="title class_">Constants</span>.<span class="property">TOKEN_WEB</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">StringTools</span>.<span class="title function_">isEmpty</span>(token)) &#123;</span><br><span class="line">            <span class="comment">// æ²¡æœ‰tokenï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="title class_">ResponseCodeEnum</span>.<span class="property">CODE_601</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä»redisä¸­è·å–tokenä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> redisComponent.<span class="title function_">getTokenInfo</span>(token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…é™¤cookie</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="built_in">void</span> <span class="title function_">cleanCookie</span>(<span class="params"><span class="title class_">HttpServletResponse</span> response</span>)&#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰è¯·æ±‚</span></span><br><span class="line">        <span class="title class_">HttpServletRequest</span> request = ((<span class="title class_">ServletRequestAttributes</span>) <span class="title class_">RequestContextHolder</span>.<span class="title function_">getRequestAttributes</span>()).<span class="title function_">getRequest</span>();</span><br><span class="line">        <span class="comment">//è·å–cookieæ•°ç»„</span></span><br><span class="line">        <span class="title class_">Cookie</span>[]cookies = request.<span class="title function_">getCookies</span>();</span><br><span class="line">        <span class="comment">//å¦‚æœæ²¡æœ‰cookieï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span>(cookies == <span class="literal">null</span>)&#123;<span class="keyword">return</span>;&#125;</span><br><span class="line">        <span class="comment">//éå†cookieæ•°ç»„ï¼Œæ‰¾åˆ°tokençš„cookieå¹¶æ¸…é™¤</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="title class_">Cookie</span> cookie : cookies) &#123;</span><br><span class="line">            <span class="keyword">if</span>(cookie.<span class="title function_">getName</span>().<span class="title function_">equals</span>(<span class="title class_">Constants</span>.<span class="property">TOKEN_WEB</span>))&#123;</span><br><span class="line">                redisComponent.<span class="title function_">cleanToken</span>(cookie.<span class="title function_">getValue</span>());</span><br><span class="line">                cookie.<span class="title function_">setMaxAge</span>(<span class="number">0</span>);</span><br><span class="line">                cookie.<span class="title function_">setPath</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">                response.<span class="title function_">addCookie</span>(cookie);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-é€€å‡º">4.é€€å‡º</h3>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/logout&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="function">ResponseVO <span class="title">logout</span><span class="params">(HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">    cleanCookie(response);</span><br><span class="line">    <span class="function"><span class="keyword">return</span> <span class="title">getSuccessResponseVO</span><span class="params">(<span class="keyword">null</span>)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-850-801x1024.png" alt="img"></p>
<h2 id="3-éƒ¨ç½²å‰ç«¯ï¼ˆå®Œæˆç®¡ç†ç«¯ç™»å½•é€€å‡ºï¼‰">3.éƒ¨ç½²å‰ç«¯ï¼ˆå®Œæˆç®¡ç†ç«¯ç™»å½•é€€å‡ºï¼‰</h2>
<p>npm install</p>
<p>npm run dev</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-851.png" alt="img"></p>
<p>å…ˆè·‘æœåŠ¡ç«¯æµ‹è¯•ä¸‹ç™»å½•é€€å‡ºæ³¨å†Œçš„åŠŸèƒ½</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-852-1024x496.png" alt="img"></p>
<p>æ¥ä¸‹æ¥å°±æ˜¯ä¸ºç®¡ç†ç«¯ç¼–å†™ç™»å½•ã€é€€å‡ºçš„é€»è¾‘ï¼Œç®¡ç†ç«¯ä¸ç”¨æ³¨å†Œ</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-853.png" alt="img"></p>
<p>è¿™é‡ŒæŠŠæœåŠ¡ç«¯çš„é€»è¾‘å¤åˆ¶è¿‡æ¥ç›´æ¥æ”¹å°±è¡Œäº†</p>
<p>å®šä¹‰AppConfigæ–‡ä»¶ï¼Œæ–¹ä¾¿è¯»å–adminç«¯application.ymlé‡Œçš„è´¦å·å¯†ç ï¼Œè·¯å¾„ç­‰ä¿¡æ¯</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Value(<span class="string">&quot;<span class="subst">$&#123;project.folder:&#125;</span>&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> String projectFolder;</span><br><span class="line">    <span class="meta">@Value(<span class="string">&quot;<span class="subst">$&#123;admin account:&#125;</span>&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> String adminAccount;</span><br><span class="line">    <span class="meta">@Value(<span class="string">&quot;<span class="subst">$&#123;admin password:&#125;</span>&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> String adminPassword;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String getProjectFolder() &#123;</span><br><span class="line">        <span class="keyword">return</span> projectFolder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String getAdminAccount() &#123;</span><br><span class="line">        <span class="keyword">return</span> adminAccount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String getAdminPassword() &#123;</span><br><span class="line">        <span class="keyword">return</span> adminPassword;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RedisCompoent</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¿å­˜ç®¡ç†å‘˜tokenä¿¡æ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> <span class="variable">account</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">saveTokenInfo4Admin</span>(<span class="params"><span class="title class_">String</span> account</span>) &#123;</span><br><span class="line">        <span class="title class_">String</span> token = <span class="variable constant_">UUID</span>.<span class="title function_">randomUUID</span>().<span class="title function_">toString</span>();</span><br><span class="line">        redisUtils.<span class="title function_">setex</span>(<span class="title class_">Constants</span>.<span class="property">REDIS_KEY_TOKEN_ADMIN</span> + token,account ,<span class="title class_">Constants</span>.<span class="property">REDIS_KEY_EXPIRES_ONE_DAY</span> );</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¸…é™¤ç®¡ç†å‘˜tokenä¿¡æ¯</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> <span class="variable">token</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">cleanToken4Admin</span>(<span class="params"><span class="title class_">String</span> token</span>) &#123;</span><br><span class="line">        redisUtils.<span class="title function_">delete</span>(<span class="title class_">Constants</span>.<span class="property">REDIS_KEY_TOKEN_ADMIN</span> + token);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­åˆ›å»ºç®¡ç†å‘˜tokenå’Œç”¨æˆ·tokenåˆ†å¼€ï¼š</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">String</span> TOKEN_ADMIN = <span class="string">&quot;adminToken&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>å®Œæ•´çš„ABaseController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.admin.controller;</span><br><span class="line"><span class="keyword">import</span> com.easylive.component.RedisComponent;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.constants.Constants;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.enums.ResponseCodeEnum;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.vo.ResponseVO;</span><br><span class="line"><span class="keyword">import</span> com.easylive.exception.BusinessException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.Cookie;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ABaseController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">STATUC_SUCCESS</span> <span class="operator">=</span> <span class="string">&quot;success&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">STATUC_ERROR</span> <span class="operator">=</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisComponent redisComponent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æˆåŠŸå“åº”VO</span></span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; ResponseVO <span class="title function_">getSuccessResponseVO</span><span class="params">(T t)</span> &#123;</span><br><span class="line">        ResponseVO&lt;T&gt; responseVO = <span class="keyword">new</span> <span class="title class_">ResponseVO</span>&lt;&gt;();</span><br><span class="line">        responseVO.setStatus(STATUC_SUCCESS);</span><br><span class="line">        responseVO.setCode(ResponseCodeEnum.CODE_200.getCode());</span><br><span class="line">        responseVO.setInfo(ResponseCodeEnum.CODE_200.getMsg());</span><br><span class="line">        responseVO.setData(t);</span><br><span class="line">        <span class="keyword">return</span> responseVO;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸šåŠ¡å¼‚å¸¸å“åº”VO</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; ResponseVO <span class="title function_">getBusinessErrorResponseVO</span><span class="params">(BusinessException e, T t)</span> &#123;</span><br><span class="line">        <span class="type">ResponseVO</span> <span class="variable">vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseVO</span>();</span><br><span class="line">        vo.setStatus(STATUC_ERROR);</span><br><span class="line">        <span class="keyword">if</span> (e.getCode() == <span class="literal">null</span>) &#123;</span><br><span class="line">            vo.setCode(ResponseCodeEnum.CODE_600.getCode());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            vo.setCode(e.getCode());</span><br><span class="line">        &#125;</span><br><span class="line">        vo.setInfo(e.getMessage());</span><br><span class="line">        vo.setData(t);</span><br><span class="line">        <span class="keyword">return</span> vo;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æœåŠ¡å™¨å†…éƒ¨é”™è¯¯å“åº”VO</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; ResponseVO <span class="title function_">getServerErrorResponseVO</span><span class="params">(T t)</span> &#123;</span><br><span class="line">        <span class="type">ResponseVO</span> <span class="variable">vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResponseVO</span>();</span><br><span class="line">        vo.setStatus(STATUC_ERROR);</span><br><span class="line">        vo.setCode(ResponseCodeEnum.CODE_500.getCode());</span><br><span class="line">        vo.setInfo(ResponseCodeEnum.CODE_500.getMsg());</span><br><span class="line">        vo.setData(t);</span><br><span class="line">        <span class="keyword">return</span> vo;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–å®¢æˆ·ç«¯IPåœ°å€</span></span><br><span class="line">    <span class="keyword">protected</span> String <span class="title function_">getIpAddr</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();</span><br><span class="line">        <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;x-forwarded-for&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (ip != <span class="literal">null</span> &amp;&amp; ip.length() != <span class="number">0</span> &amp;&amp; !<span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">            <span class="comment">// å¤šæ¬¡åå‘ä»£ç†åä¼šæœ‰å¤šä¸ªipå€¼ï¼Œç¬¬ä¸€ä¸ªipæ‰æ˜¯çœŸå®ip</span></span><br><span class="line">            <span class="keyword">if</span> (ip.indexOf(<span class="string">&quot;,&quot;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">                ip = ip.split(<span class="string">&quot;,&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ip == <span class="literal">null</span> || ip.length() == <span class="number">0</span> || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">            ip = request.getHeader(<span class="string">&quot;Proxy-Client-IP&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ip == <span class="literal">null</span> || ip.length() == <span class="number">0</span> || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">            ip = request.getHeader(<span class="string">&quot;WL-Proxy-Client-IP&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ip == <span class="literal">null</span> || ip.length() == <span class="number">0</span> || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">            ip = request.getHeader(<span class="string">&quot;HTTP_CLIENT_IP&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ip == <span class="literal">null</span> || ip.length() == <span class="number">0</span> || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">            ip = request.getHeader(<span class="string">&quot;HTTP_X_FORWARDED_FOR&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ip == <span class="literal">null</span> || ip.length() == <span class="number">0</span> || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">            ip = request.getHeader(<span class="string">&quot;X-Real-IP&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ip == <span class="literal">null</span> || ip.length() == <span class="number">0</span> || <span class="string">&quot;unknown&quot;</span>.equalsIgnoreCase(ip)) &#123;</span><br><span class="line">            ip = request.getRemoteAddr();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ip;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†tokenä¿å­˜åˆ°cookieä¸­</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">saveTokenToCookie</span><span class="params">(HttpServletResponse response, String token)</span> &#123;</span><br><span class="line">        <span class="type">Cookie</span> <span class="variable">cookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cookie</span>(Constants.TOKEN_ADMIN, token);</span><br><span class="line">       <span class="comment">// // è®¾ç½®cookieæœ‰æ•ˆæœŸä¸º1å¤©</span></span><br><span class="line">        <span class="comment">//cookie.setMaxAge(Constants.TIME_SECONDS_DAY );</span></span><br><span class="line">        <span class="comment">//è®¾ç½®cookieä¸ºä¼šè¯çº§åˆ«</span></span><br><span class="line">        cookie.setMaxAge(-<span class="number">1</span>);</span><br><span class="line">        cookie.setPath(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        response.addCookie(cookie);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¸…é™¤ç®¡ç†å‘˜cookie</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">cleanCookie</span><span class="params">(HttpServletResponse response)</span>&#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰è¯·æ±‚</span></span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();</span><br><span class="line">        <span class="comment">//è·å–cookieæ•°ç»„</span></span><br><span class="line">        Cookie[]cookies = request.getCookies();</span><br><span class="line">        <span class="comment">//å¦‚æœæ²¡æœ‰cookieï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span>(cookies == <span class="literal">null</span>)&#123;<span class="keyword">return</span>;&#125;</span><br><span class="line">        <span class="comment">//éå†cookieæ•°ç»„ï¼Œæ‰¾åˆ°tokençš„cookieå¹¶æ¸…é™¤</span></span><br><span class="line">        <span class="keyword">for</span> (Cookie cookie : cookies) &#123;</span><br><span class="line">            <span class="keyword">if</span>(cookie.getName().equals(Constants.TOKEN_ADMIN))&#123;</span><br><span class="line">                redisComponent.cleanToken(cookie.getValue());</span><br><span class="line">                cookie.setMaxAge(<span class="number">0</span>);</span><br><span class="line">                cookie.setPath(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">                response.addCookie(cookie);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®Œæ•´çš„AccountController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.admin.controller;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.easylive.component.RedisComponent;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.config.AppConfig;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.constants.Constants;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.vo.ResponseVO;</span><br><span class="line"><span class="keyword">import</span> com.easylive.exception.BusinessException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.easylive.utils.StringTools;</span><br><span class="line"><span class="keyword">import</span> com.wf.captcha.ArithmeticCaptcha;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.annotation.Validated;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.Cookie;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.NotEmpty;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç®¡ç†å‘˜ä¿¡æ¯ Controller</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Validated</span><span class="comment">//æ ¡éªŒå‚æ•°</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/account&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountController</span> <span class="keyword">extends</span> <span class="title class_">ABaseController</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisComponent redisComponent;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AppConfig appConfig;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å‘é€éªŒè¯ç </span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/checkCode&quot;)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ResponseVO <span class="title function_">checkCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// éªŒè¯ç </span></span><br><span class="line">        <span class="type">ArithmeticCaptcha</span> <span class="variable">captcha</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArithmeticCaptcha</span>(<span class="number">100</span>, <span class="number">42</span>);</span><br><span class="line">        <span class="comment">//æ‹¿åˆ°éªŒè¯ç æ–‡æœ¬å†…å®¹</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> captcha.text();</span><br><span class="line">        <span class="comment">//ä¿å­˜éªŒè¯ç æ–‡æœ¬å†…å®¹åˆ°redis</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">checkCodeKey</span> <span class="operator">=</span> redisComponent.saveCheckCode(code);</span><br><span class="line">        <span class="comment">//å°†éªŒè¯ç å›¾ç‰‡è½¬ä¸ºbase64ç¼–ç </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">checkCodeBase64</span> <span class="operator">=</span> captcha.toBase64();</span><br><span class="line">        <span class="comment">//å°è£…è¿”å›ç»“æœ</span></span><br><span class="line">        Map&lt;String, String&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        result.put(<span class="string">&quot;checkCode&quot;</span>, checkCodeBase64);</span><br><span class="line">        result.put(<span class="string">&quot;checkCodeKey&quot;</span>, checkCodeKey);</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç®¡ç†å‘˜ç™»å½•</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> account</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> password</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> checkCodeKey</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> checkCode</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/login&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseVO <span class="title function_">login</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">                            HttpServletResponse response,</span></span><br><span class="line"><span class="params">                            <span class="meta">@NotEmpty</span> String account,</span></span><br><span class="line"><span class="params">                            <span class="meta">@NotEmpty</span> String password,</span></span><br><span class="line"><span class="params">                            <span class="meta">@NotEmpty</span> String checkCodeKey,</span></span><br><span class="line"><span class="params">                            <span class="meta">@NotEmpty</span> String checkCode)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!checkCode.equalsIgnoreCase(redisComponent.getCheckCode(checkCodeKey))) &#123;</span><br><span class="line">                <span class="comment">//éªŒè¯ç é”™è¯¯ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(String.valueOf(Constants.MESSAGE_CHECKCODE_ERROR));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//æ ¡éªŒè´¦å·å¯†ç ,ç›´æ¥å¯¹æ¯”æˆ‘ä»¬è¾“å…¥çš„è·Ÿé…ç½®æ–‡ä»¶é‡Œçš„æ˜¯å¦ä¸€è‡´</span></span><br><span class="line">            <span class="keyword">if</span> (!account.equals(appConfig.getAdminAccount()) || !password.equals(StringTools.encodeByMd5(appConfig.getAdminPassword()))) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;è´¦å·æˆ–å¯†ç é”™è¯¯&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> redisComponent.saveTokenInfo4Admin(account);</span><br><span class="line">            saveTokenToCookie(response, token);</span><br><span class="line">            <span class="keyword">return</span> getSuccessResponseVO(account);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//ä¸ç®¡éªŒè¯ç æ­£ç¡®è¿˜æ˜¯é”™è¯¯ç”¨å®Œå°±æ¸…é™¤éªŒè¯ç </span></span><br><span class="line">            redisComponent.cleanCheckCode(checkCodeKey);</span><br><span class="line">            <span class="comment">//å½“æœ‰cookieæ—¶æ¯ä¸€æ¬¡è·å–æ–°tokenæ—¶ï¼Œåœ¨redisä¸­æ¸…é™¤æ—§çš„token</span></span><br><span class="line">            <span class="keyword">if</span> (request.getCookies() != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//è·å–cookieæ•°ç»„</span></span><br><span class="line">                Cookie[] cookies = request.getCookies();</span><br><span class="line">                <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (Cookie cookie : cookies) &#123;</span><br><span class="line">                    <span class="comment">//å¦‚æœcookieçš„åå­—æ˜¯tokenï¼Œåˆ™è·å–å®ƒçš„å€¼</span></span><br><span class="line">                    <span class="keyword">if</span> (cookie.getName().equals(Constants.TOKEN_ADMIN)) &#123;</span><br><span class="line">                        token = cookie.getValue();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//å¦‚æœcookieä¸­æœ‰tokenï¼Œåˆ™æ¸…é™¤redisä¸­çš„æ—§token</span></span><br><span class="line">                <span class="keyword">if</span> (!StringTools.isEmpty(token)) &#123;</span><br><span class="line">                    <span class="comment">//æ¸…é™¤æ—§çš„token</span></span><br><span class="line">                    redisComponent.cleanToken4Admin(token);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/logout&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseVO <span class="title function_">logout</span><span class="params">(HttpServletResponse response)</span> &#123;</span><br><span class="line">        cleanCookie(response);</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-854-1024x511.png" alt="img"></p>
<h2 id="4-ç®¡ç†ç«¯-åˆ†ç±»ç®¡ç†">4.ç®¡ç†ç«¯ åˆ†ç±»ç®¡ç†</h2>
<h3 id="1-å‰ç½®å‡†å¤‡-æ‹¦æˆªå™¨">1.å‰ç½®å‡†å¤‡ -æ‹¦æˆªå™¨</h3>
<p>å®šä¹‰æ‹¦æˆªå™¨</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-855.png" alt="img"></p>
<p>webAppConfigurer</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.admin.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.<span class="keyword">annotation</span>.InterceptorRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.<span class="keyword">annotation</span>.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebAppConfigurer</span> <span class="title">implements</span> <span class="title">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AppInterceptor appInterceptor;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> void addInterceptors(InterceptorRegistry registry) &#123;</span><br><span class="line">        registry.addInterceptor(appInterceptor).addPathPatterns(<span class="string">&quot;/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>åšäº†ä»€ä¹ˆ</strong></p>
<ul>
<li>æŠŠ <code>AppInterceptor</code> æ³¨å†Œè¿› Spring MVC çš„æ‹¦æˆªå™¨é“¾ï¼Œå¯¹ <strong>æ‰€æœ‰è¯·æ±‚è·¯å¾„</strong> (<code>/**</code>) ç”Ÿæ•ˆã€‚</li>
</ul>
<p><strong>ä¸ºä»€ä¹ˆ</strong></p>
<ul>
<li>ç»Ÿä¸€å…¥å£ï¼šä»»ä½•è¯·æ±‚åˆ°è¾¾ Controller å‰ï¼Œå…ˆèµ°ä½ çš„è‡ªå®šä¹‰é€»è¾‘ï¼ˆé‰´æƒã€é™æµã€å®¡è®¡ç­‰ï¼‰ã€‚</li>
</ul>
<p><strong>è¦ç‚¹</strong></p>
<ul>
<li>æ‹¦æˆªé¡ºåºç”±æ³¨å†Œé¡ºåºå†³å®šï¼ˆå¤šä¸ªæ‹¦æˆªå™¨æ—¶å¾ˆé‡è¦ï¼‰ã€‚</li>
<li>è¿™é‡Œæ²¡è®¾ç½® <code>excludePathPatterns</code>ï¼Œç­‰äºäº¤ç»™æ‹¦æˆªå™¨å†…éƒ¨è‡ªå·±æ”¾è¡Œ <code>/account</code> ç­‰è·¯å¾„ã€‚</li>
</ul>
<p>AppInterceptor</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.admin.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.easylive.component.RedisComponent;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.constants.Constants;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.enums.ResponseCodeEnum;</span><br><span class="line"><span class="keyword">import</span> com.easylive.exception.BusinessException;</span><br><span class="line"><span class="keyword">import</span> com.easylive.utils.StringTools;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.method.HandlerMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.Cookie;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String URL_ACCOUNT = <span class="string">&quot;/account&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String URL_FILE = <span class="string">&quot;/file&quot;</span>;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisComponent redisComponent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å‰ç½®æ‹¦æˆªå™¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object <span class="keyword">handler</span>)</span>  </span>&#123;</span><br><span class="line">            <span class="comment">// 1) åŸºæœ¬è¿‡æ»¤ï¼šæ²¡æœ‰å¤„ç†å™¨å°±æ‹¦æˆªï¼Œé™æ€èµ„æºç›´æ¥æ”¾è¡Œ</span></span><br><span class="line">            <span class="comment">//å¦‚æœ handler æ˜¯ nullï¼ˆæ²¡æœ‰æ‰¾åˆ°å¤„ç†è¿™ä¸ªè¯·æ±‚çš„æ–¹æ³•ï¼‰ï¼Œç›´æ¥è¿”å› falseï¼Œé˜»æ­¢ç»§ç»­æ‰§è¡Œã€‚</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">null</span> == <span class="keyword">handler</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//åˆ¤æ–­ handler æ˜¯å¦æ˜¯ HandlerMethod ç±»å‹ã€‚</span></span><br><span class="line">            <span class="comment">//å¦‚æœä¸æ˜¯ï¼ˆå¯èƒ½æ˜¯è®¿é—®é™æ€èµ„æºï¼Œæ¯”å¦‚å›¾ç‰‡ã€CSSã€JSï¼‰ï¼Œç›´æ¥æ”¾è¡Œã€‚</span></span><br><span class="line">            <span class="keyword">if</span>(!(<span class="keyword">handler</span> <span class="keyword">instanceof</span> HandlerMethod))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 2) ç™»å½•ä¸æ³¨å†Œç­‰â€œè´¦æˆ·æ¥å£â€ç›´æ¥æ”¾è¡Œ</span></span><br><span class="line">            <span class="comment">//å¦‚æœè¯·æ±‚è·¯å¾„åŒ…å« /accountï¼ˆä¾‹å¦‚ /account/loginã€/account/registerï¼‰ï¼Œç›´æ¥æ”¾è¡Œã€‚</span></span><br><span class="line">            <span class="keyword">if</span>(request.getRequestURI().contains(URL_ACCOUNT))&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//é™¤äº†accountä¸æ‹¦æˆªå…¶ä»–çš„éƒ½è¦åšåˆ¤æ–­</span></span><br><span class="line">            <span class="comment">// 3) å– tokenï¼šä¼˜å…ˆè¯·æ±‚å¤´ï¼Œå…¶æ¬¡ï¼ˆè®¿é—®æ–‡ä»¶èµ„æºæ—¶ï¼‰ä» cookie é‡Œå–</span></span><br><span class="line">            <span class="comment">//3.1è·å–è¯·æ±‚å¤´ä¸­çš„ token</span></span><br><span class="line">            String token = request.getHeader(Constants.TOKEN_ADMIN);</span><br><span class="line">            <span class="comment">//3.2å¦‚æœè·å–å›¾ç‰‡èµ„æºï¼Œæ¯”å¦‚ /file/xxx.jpgï¼Œåˆ™éœ€è¦ä» cookie ä¸­è·å– tokenã€‚</span></span><br><span class="line">            <span class="comment">//è¿™ç§æƒ…å†µåªèƒ½ä»cookieä¸­è·å–ï¼Œheaderæ‹¿ä¸åˆ°</span></span><br><span class="line">            <span class="keyword">if</span>(request.getRequestURI().contains(URL_FILE))&#123;</span><br><span class="line">                token = getTokenFromCookie(request);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 4) ç¼º token æˆ– Redis æŸ¥ä¸åˆ°ä¼šè¯ â†’ æŠ›ä¸šåŠ¡å¼‚å¸¸ï¼ˆäº¤ç»™å…¨å±€å¼‚å¸¸å¤„ç†è¿”å› 401/è‡ªå®šä¹‰ç 901ï¼‰</span></span><br><span class="line">            <span class="comment">//å¦‚æœ token ä¸ºç©ºï¼ŒæŠ›å¼‚å¸¸</span></span><br><span class="line">            <span class="keyword">if</span>(StringTools.isEmpty(token))&#123;</span><br><span class="line">                <span class="comment">//æŠ›å¼‚å¸¸ï¼šæœªç™»å½•æˆ–ç™»å½•è¶…æ—¶</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(ResponseCodeEnum.CODE_901);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//ä» redis ä¸­è·å– token å¯¹åº”çš„ session ä¿¡æ¯</span></span><br><span class="line">            Object sessionObj = redisComponent.getTokenInfo4Admin(token);</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">null</span> ==sessionObj)&#123;</span><br><span class="line">                <span class="comment">//æŠ›å¼‚å¸¸ï¼šæœªç™»å½•æˆ–ç™»å½•è¶…æ—¶</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(ResponseCodeEnum.CODE_901);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 5) æ ¡éªŒé€šè¿‡ï¼Œæ”¾è¡Œ</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">     <span class="keyword">private</span> <span class="function">String <span class="title">getTokenFromCookie</span><span class="params">(HttpServletRequest request)</span></span>&#123;</span><br><span class="line">            <span class="comment">//éå†cookieæ•°ç»„</span></span><br><span class="line">         Cookie[] cookies = request.getCookies();</span><br><span class="line">         <span class="keyword">if</span>(cookies==<span class="keyword">null</span>)&#123;</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         String token = <span class="keyword">null</span>;</span><br><span class="line">         <span class="keyword">for</span> (Cookie cookie : cookies) &#123;</span><br><span class="line">             <span class="comment">//å¦‚æœcookieçš„åå­—æ˜¯tokenï¼Œåˆ™è·å–å®ƒçš„å€¼</span></span><br><span class="line">             <span class="keyword">if</span> (cookie.getName().equals(Constants.TOKEN_ADMIN)) &#123;</span><br><span class="line">                <span class="function"><span class="keyword">return</span> cookie.<span class="title">getValue</span><span class="params">()</span></span>;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åç½®æ‹¦æˆªå™¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ex</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object <span class="keyword">handler</span>, Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            HandlerInterceptor.<span class="keyword">super</span>.afterCompletion(request, response, <span class="keyword">handler</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åç½®æ¸²æŸ“è§†å›¾æ‹¦æˆªå™¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> modelAndView</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object <span class="keyword">handler</span>, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            HandlerInterceptor.<span class="keyword">super</span>.postHandle(request, response, <span class="keyword">handler</span>, modelAndView);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>åšäº†ä»€ä¹ˆ</strong></p>
<ul>
<li>
<p>ç»Ÿä¸€åš</p>
<p>ç™»å½•æ€æ ¡éªŒ</p>
<p>ï¼š</p>
<ol>
<li>é Controllerï¼ˆé™æ€èµ„æºç­‰ï¼‰ç›´æ¥æ”¾è¡Œã€‚</li>
<li><code>/account</code> ä¸‹çš„ç™»å½•/æ³¨å†Œç­‰å…¬å…±æ¥å£æ”¾è¡Œã€‚</li>
<li>å…¶ä»–è¯·æ±‚å¿…é¡»æºå¸¦ <strong>ç®¡ç†å‘˜ token</strong>ã€‚</li>
<li>token åœ¨ Redis ä¸­èƒ½æŸ¥åˆ°ä¼šè¯ä¿¡æ¯æ‰æ”¾è¡Œã€‚</li>
</ol>
</li>
</ul>
<p><strong>ä¸ºä»€ä¹ˆæ–‡ä»¶è¦ä» Cookie å– tokenï¼Ÿ</strong></p>
<ul>
<li>æµè§ˆå™¨åœ¨å‘èµ· <code>&lt;img src=&quot;/file/xx&quot;&gt;</code>ã€<code>&lt;link&gt;</code>ã€<code>&lt;video&gt;</code> ç­‰é™æ€èµ„æºè¯·æ±‚æ—¶ï¼Œ<strong>é€šå¸¸ä¸ä¼š</strong>è‡ªåŠ¨å¸¦è‡ªå®šä¹‰çš„è¯·æ±‚å¤´ï¼ˆæ¯”å¦‚ <code>Authorization</code> æˆ–è‡ªå®šä¹‰ <code>TOKEN_ADMIN</code>ï¼‰ï¼Œä½†ä¼šæºå¸¦ä¸åŸŸåŒ¹é…çš„ <strong>Cookie</strong>ã€‚</li>
<li>æ‰€ä»¥è®¿é—® <code>/file/**</code> è¿™ç±»èµ„æºæ—¶ï¼Œæ”¹ä¸ºä» Cookie æ‹¿ token æ‰èƒ½é‰´æƒã€‚</li>
</ul>
<p><strong>å¼‚å¸¸å¤„ç†æœºåˆ¶</strong></p>
<ul>
<li>ç›´æ¥åœ¨æ‹¦æˆªå™¨é‡Œ <code>throw new BusinessException()</code>ï¼Œè®©å…¨å±€å¼‚å¸¸å¤„ç†å™¨ï¼ˆæ¯”å¦‚ <code>@ControllerAdvice</code>ï¼‰ç»Ÿä¸€è¿”å›æœªç™»å½•/è¿‡æœŸçš„å“åº”ç ä¸æç¤ºã€‚</li>
</ul>
<p>ç›®å‰æœ‰ä¸ªé—®é¢˜ï¼Œå½“æˆ‘å…³æ‰æµè§ˆå™¨ï¼Œé‡æ–°è¿›å…¥<a target="_blank" rel="noopener" href="http://localhost:7070/admin/category">http://localhost:3031/content/category</a>å‘ç°ç›´æ¥å°±è¿›å»äº†ï¼Œä¸åº”è¯¥è¿™æ ·ï¼Œåœ¨å®¢æˆ·ç«¯åº”è¯¥è¿™æ ·ï¼Œå½“å®¢æˆ·ç”µè„‘å…³äº†ï¼Œå› ä¸ºcookieä¿ç•™7å¤©ï¼Œå®ƒåå°ä¸€ç›´éƒ½åœ¨ï¼Œç®¡ç†ç«¯ä¸åº”è¯¥è¿™æ ·</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-856-1024x553.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-857-1024x173.png" alt="img"></p>
<p>é—®é¢˜åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬çš„cookieè®¾ç½®ä¸ºäº†1å¤©ï¼Œæ­¤æ—¶åœ¨ä¸€å¤©å†…æ— è®ºå…³ä¸å…³æ‰æµè§ˆå™¨å®ƒä¸€ç›´éƒ½åœ¨ï¼Œéœ€è¦æŠŠcookieè®¾ç½®ä¸ºä¼šè¯çº§åˆ«</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-858-1024x278.png" alt="img"></p>
<h3 id="2-åˆ†ç±»">2.åˆ†ç±»</h3>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-859.png" alt="img"></p>
<h4 id="å»ºæ•°æ®åº“">å»ºæ•°æ®åº“</h4>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> `category_info`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `category_info`  (</span><br><span class="line">  `category_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">&#x27;è‡ªå¢åˆ†ç±»ID&#x27;</span>,</span><br><span class="line">  `category_code` <span class="type">varchar</span>(<span class="number">30</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;åˆ†ç±»ç¼–ç &#x27;</span>,</span><br><span class="line">  `category_name` <span class="type">varchar</span>(<span class="number">30</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;åˆ†ç±»åç§°&#x27;</span>,</span><br><span class="line">  `p_category_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;çˆ¶çº§åˆ†ç±»ID&#x27;</span>,</span><br><span class="line">  `icon` <span class="type">varchar</span>(<span class="number">50</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;å›¾æ ‡&#x27;</span>,</span><br><span class="line">  `background` <span class="type">varchar</span>(<span class="number">50</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;èƒŒæ™¯å›¾&#x27;</span>,</span><br><span class="line">  `sort` tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æ’åºå·&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (`category_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> `idx_key_category_code`(`category_code`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE = InnoDB AUTO_INCREMENT = <span class="number">40</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4 <span class="keyword">COLLATE</span> = utf8mb4_general_ci <span class="keyword">COMMENT</span> = <span class="string">&#x27;åˆ†ç±»ä¿¡æ¯&#x27;</span> ROW_FORMAT = DYNAMIC;</span><br></pre></td></tr></table></figure>
<h4 id="1-è·å–åˆ†ç±»">1.è·å–åˆ†ç±»</h4>
<p>CategoryController</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.admin.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.po.<span class="type">CategoryInfo</span>;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.query.<span class="type">CategoryInfoQuery</span>;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.vo.<span class="type">ResponseVO</span>;</span><br><span class="line"><span class="keyword">import</span> com.easylive.service.<span class="type">CategoryInfoService</span>;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.<span class="type">RequestMapping</span>;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.<span class="type">RestController</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.<span class="type">Resource</span>;</span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">List</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/category&quot;</span>)</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">CategoryController</span> <span class="keyword">extends</span> <span class="title">ABaseController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">CategoryInfoService</span> categoryInfoService;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">&quot;loadCategory&quot;</span>)</span><br><span class="line">    public <span class="type">ResponseVO</span> loadCategory(<span class="type">CategoryInfoQuery</span> query) &#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®æ’åºæ¡ä»¶ï¼ŒæŒ‰ç…§sortå­—æ®µå‡åºæ’åˆ—</span></span><br><span class="line">        query.setOrderBy(<span class="string">&quot;sort asc&quot;</span>);</span><br><span class="line">        <span class="comment">// æŸ¥è¯¢åˆ†ç±»ä¿¡æ¯åˆ—è¡¨</span></span><br><span class="line">        <span class="type">List</span>&lt;<span class="type">CategoryInfo</span>&gt;categoryInfoList = categoryInfoService.findListByParam(query);</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(categoryInfoList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-860-1024x478.png" alt="img"></p>
<p>å¯ä»¥çœ‹åˆ°å·²ç»æ‹¿åˆ°äº†<em>ä¿¡æ¯åˆ—è¡¨</em></p>
<h4 id="2-æ–°å¢åˆ†ç±»-ä¿®æ”¹åˆ†ç±»">2.æ–°å¢åˆ†ç±»/ä¿®æ”¹åˆ†ç±»</h4>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-861.png" alt="img"></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@RequestMapping</span>(<span class="string">&quot;saveCategory&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">saveCategory</span>(<span class="params"><span class="meta">@NotNull</span> <span class="title class_">Integer</span> pCategoryId,</span></span><br><span class="line"><span class="params">                                   <span class="title class_">Integer</span> categoryId,</span></span><br><span class="line"><span class="params">                                   <span class="meta">@NotEmpty</span> <span class="title class_">String</span> categoryCode,</span></span><br><span class="line"><span class="params">                                   <span class="meta">@NotEmpty</span> <span class="title class_">String</span> categoryName,</span></span><br><span class="line"><span class="params">                                   <span class="title class_">String</span> icon,</span></span><br><span class="line"><span class="params">                                   <span class="title class_">String</span> background</span>) &#123;</span><br><span class="line">        <span class="title class_">CategoryInfo</span> categoryInfo = <span class="keyword">new</span> <span class="title class_">CategoryInfo</span>();</span><br><span class="line">        categoryInfo.<span class="title function_">setpCategoryId</span>(pCategoryId);</span><br><span class="line">        categoryInfo.<span class="title function_">setCategoryId</span>(categoryId);</span><br><span class="line">        categoryInfo.<span class="title function_">setCategoryCode</span>(categoryCode);</span><br><span class="line">        categoryInfo.<span class="title function_">setCategoryName</span>(categoryName);</span><br><span class="line">        categoryInfo.<span class="title function_">setIcon</span>(icon);</span><br><span class="line">        categoryInfo.<span class="title function_">setBackground</span>(background);</span><br><span class="line"></span><br><span class="line">        categoryInfoService.<span class="title function_">saveCategory</span>(categoryInfo);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * ä¿å­˜åˆ†ç±»ä¿¡æ¯</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> <span class="variable">categoryInfo</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="built_in">void</span> <span class="title function_">saveCategory</span>(<span class="title class_">CategoryInfo</span> categoryInfo);</span><br><span class="line"><span class="title function_">saveCategory</span>(<span class="title class_">CategoryInfo</span> bean)</span><br></pre></td></tr></table></figure>
<ul>
<li>ä¿å­˜ä¸€ä¸ªåˆ†ç±»ï¼ˆå¯èƒ½æ˜¯æ–°å¢ï¼Œä¹Ÿå¯èƒ½æ˜¯æ›´æ–°ï¼‰ã€‚</li>
<li>åœ¨ä¿å­˜ä¹‹å‰ï¼Œè¦ç¡®ä¿ <strong>åˆ†ç±»ç¼–å·ï¼ˆcategoryCodeï¼‰</strong> åœ¨æ•°æ®åº“ä¸­æ˜¯å”¯ä¸€çš„ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveCategory</span><span class="params">(CategoryInfo bean)</span> &#123;</span><br><span class="line"><span class="comment">//æ ¹æ®ä¼ å…¥å¯¹è±¡ bean çš„ categoryCode å»æ•°æ®åº“æŸ¥ï¼Œçœ‹æ˜¯å¦å·²ç»æœ‰ç›¸åŒç¼–å·çš„åˆ†ç±»å­˜åœ¨ã€‚</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">//å¦‚æœæŸ¥åˆ°äº†ï¼Œå°±æŠŠç»“æœæ”¾åˆ° dbBeanã€‚</span></span><br><span class="line">	<span class="type">CategoryInfo</span> <span class="variable">dbBean</span> <span class="operator">=</span> <span class="built_in">this</span>.categoryInfoMapper.selectByCategoryCode(bean.getCategoryCode());</span><br><span class="line">    <span class="comment">// åˆ¤æ–­åˆ†ç±»ç¼–å·æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">	<span class="keyword">if</span>(bean.getCategoryId() ==<span class="literal">null</span> &amp;&amp;dbBean != <span class="literal">null</span> ||</span><br><span class="line">			bean.getCategoryId() !=<span class="literal">null</span> &amp;&amp; dbBean!=<span class="literal">null</span>&amp;&amp;!bean.getCategoryId().equals(dbBean.getCategoryId()))&#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;åˆ†ç±»ç¼–å·å·²å­˜åœ¨&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-862.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-863.png" alt="img"></p>
<table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>æ¡ä»¶</th>
<th>ç»“æœ</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ–°å¢ä¸”ç¼–å·å·²å­˜åœ¨</td>
<td><code>categoryId == null &amp;&amp; dbBean != null</code></td>
<td>æŠ›å¼‚å¸¸</td>
</tr>
<tr>
<td>ä¿®æ”¹ä¸”ç¼–å·å†²çª</td>
<td><code>categoryId != null &amp;&amp; dbBean != null &amp;&amp; categoryId != dbBean.getCategoryId()</code></td>
<td>æŠ›å¼‚å¸¸</td>
</tr>
<tr>
<td>å…¶ä»–æƒ…å†µ</td>
<td>ä¸æ»¡è¶³ä¸Šé¢æ¡ä»¶</td>
<td>å…è®¸ä¿å­˜</td>
</tr>
</tbody>
</table>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-864-1024x182.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-865-1024x73.png" alt="img"></p>
<p>è¿™é‡Œè¦ä¼ å…¥çš„æ˜¯çˆ¶åˆ†ç±»id</p>
<p>å®Œå–„å®ç°ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveCategory</span><span class="params">(CategoryInfo bean)</span> &#123;</span><br><span class="line">		<span class="comment">//æ ¹æ®ä¼ å…¥å¯¹è±¡ bean çš„ categoryCode å»æ•°æ®åº“æŸ¥ï¼Œçœ‹æ˜¯å¦å·²ç»æœ‰ç›¸åŒç¼–å·çš„åˆ†ç±»å­˜åœ¨ã€‚</span></span><br><span class="line">		<span class="comment">// //å¦‚æœæŸ¥åˆ°äº†ï¼Œå°±æŠŠç»“æœæ”¾åˆ° dbBeanã€‚</span></span><br><span class="line">		<span class="type">CategoryInfo</span> <span class="variable">dbBean</span> <span class="operator">=</span> <span class="built_in">this</span>.categoryInfoMapper.selectByCategoryCode(bean.getCategoryCode());</span><br><span class="line">	    <span class="comment">// åˆ¤æ–­åˆ†ç±»ç¼–å·æ˜¯å¦å­˜åœ¨-&gt;å…ˆåˆ¤æ–­éæ³•é€»è¾‘ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚</span></span><br><span class="line">		<span class="comment">//1.æ–°å¢ä¸”ç¼–å·å·²å­˜åœ¨ || 2.ä¿®æ”¹ä¸”ç¼–å·å·²å­˜åœ¨ ä¸”ä¸æ˜¯åŒä¸€ä¸ªåˆ†ç±»</span></span><br><span class="line">		<span class="keyword">if</span>(bean.getCategoryId() ==<span class="literal">null</span> &amp;&amp;dbBean != <span class="literal">null</span> ||</span><br><span class="line">				bean.getCategoryId() !=<span class="literal">null</span> &amp;&amp; dbBean!=<span class="literal">null</span>&amp;&amp;!bean.getCategoryId().equals(dbBean.getCategoryId()))&#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;åˆ†ç±»ç¼–å·å·²å­˜åœ¨&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//ä¸‹é¢å°±æ˜¯æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘äº†ã€‚</span></span><br><span class="line">		<span class="comment">//è¯´æ˜æ˜¯æ–°å¢ï¼ˆæ•°æ®åº“è¿˜æ²¡æœ‰è¿™ä¸ªåˆ†ç±»çš„ IDï¼‰</span></span><br><span class="line">		<span class="keyword">if</span>(bean.getCategoryId() == <span class="literal">null</span>)&#123;</span><br><span class="line">			<span class="comment">//æ–°å¢åˆ†ç±»ï¼Œå…ˆæŸ¥è¯¢æœ€å¤§æ’åºå·ï¼Œç„¶åè®¾ç½®å½“å‰åˆ†ç±»çš„æ’åºå·ä¸º maxSort+1</span></span><br><span class="line">			<span class="type">Integer</span> <span class="variable">maxSort</span> <span class="operator">=</span> <span class="built_in">this</span>.categoryInfoMapper.selectMaxSort(bean.getpCategoryId());</span><br><span class="line">			bean.setSort(maxSort+<span class="number">1</span>);</span><br><span class="line">			<span class="built_in">this</span>.categoryInfoMapper.insert(bean);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="comment">//è¯´æ˜æ˜¯ä¿®æ”¹</span></span><br><span class="line">			<span class="built_in">this</span>.categoryInfoMapper.updateByCategoryId(bean, bean.getCategoryId());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>mapper</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»æ•°æ®åº“é‡Œè·å–æœ€å¤§æ’åºå€¼</span></span><br><span class="line"><span class="comment"> * @return</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="selector-tag">Integer</span> <span class="selector-tag">selectMaxSort</span>(<span class="variable">@Param</span>(<span class="string">&quot;pCategoryId&quot;</span>) Integer pCategoryId);</span><br></pre></td></tr></table></figure>
<p>mapper.xml</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!--ä»æ•°æ®åº“ä¸­è·å–æœ€å¤§çš„æ’åºåºå·  --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectMaxSort&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;java.lang.Integer&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">      select ifnull(max(sort),0)from category_info  where p_category_id = #</span><span class="template-variable">&#123;pCategoryId&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-866-1024x423.png" alt="img"></p>
<h4 id="3-åˆ é™¤åˆ†ç±»">3.åˆ é™¤åˆ†ç±»</h4>
<p>controllerä¸­delCategory</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@RequestMapping</span>(<span class="string">&quot;delCategory&quot;</span>)</span><br><span class="line">  public ResponseVO <span class="built_in">delCategory</span>(<span class="variable">@NotNull</span> Integer categoryId) &#123;</span><br><span class="line">      <span class="selector-tag">categoryInfoService</span><span class="selector-class">.delCategory</span>(categoryId);</span><br><span class="line">      <span class="selector-tag">return</span> <span class="selector-tag">getSuccessResponseVO</span>(null);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>service</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ é™¤åˆ†ç±»ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> * @param categoryId</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">delCategory</span><span class="params">(Integer categoryId)</span></span>;</span><br></pre></td></tr></table></figure>
<p>å®ç°ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delCategory</span><span class="params">(Integer categoryId)</span> &#123;</span><br><span class="line">      <span class="comment">//TODO æŸ¥è¯¢åˆ†ç±»ä¸‹æ˜¯å¦æœ‰è§†é¢‘</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//åˆ é™¤åˆ†ç±»ä¿¡æ¯</span></span><br><span class="line">	<span class="type">CategoryInfoQuery</span> <span class="variable">categoryInfoQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CategoryInfoQuery</span>();</span><br><span class="line">	<span class="comment">//æ ¹æ®åˆ†ç±»IDåˆ é™¤åˆ†ç±»ä¿¡æ¯,é€šè¿‡categoryIdè¿™ä¸ªå±æ€§å¯ä»¥çŸ¥é“è¯¥å±æ€§çš„çˆ¶ç±»å’Œå­ç±»å…³ç³»</span></span><br><span class="line">	categoryInfoQuery.setCategoryIdOrPCategoryId(categoryId);</span><br><span class="line">	categoryInfoMapper.deleteByParam(categoryInfoQuery);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//TODO åˆ·æ–°ç¼“å­˜</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨CategoryInfoQueryé‡ŒåŠ å…¥è¿™ä¸ªå±æ€§ï¼ˆgetterå’Œsetteræ–¹æ³•ï¼Œåç»­ä¸å†æé†’ï¼‰</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ†ç±»IDæˆ–çˆ¶çº§åˆ†ç±»IDï¼ˆç”¨äºæŸ¥è¯¢å­ç±»ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">	<span class="keyword">private</span>  <span class="built_in">Integer</span> categoryIdOrPCategoryId;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-867-1024x378.png" alt="img"></p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.categoryIdOrPCategoryId!=null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"> and (c.category_id = #</span><span class="template-variable">&#123;query.categoryIdOrPCategoryId&#125;</span><span class="language-xml"> or c.p_category_id = #</span><span class="template-variable">&#123;query.categoryIdOrPCategoryId&#125;</span><span class="language-xml">)</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>æ¯”å¦‚è¯´åˆ ç¬¬ä¸€ä¸ª34è¿™ä¸ªï¼Œcategory_id=34æˆ–è€…p_category_id=34éƒ½å¯ä»¥æŠŠè¿™ä¸‰ä¸ªéƒ½åˆ äº†</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-868.png" alt="img"></p>
<p>è¿™æ®µé€»è¾‘é‡ŒåŠ  <code>categoryIdOrPCategoryId</code> å…¶å®æ˜¯ä¸ºäº†<strong>ä¸€æ¬¡æ€§åˆ é™¤ç›®æ ‡åˆ†ç±»å’Œå®ƒçš„ç›´æ¥å­åˆ†ç±»</strong>ï¼Œé¿å…åªåˆ è‡ªå·±è€Œç•™ä¸‹â€œå­¤å„¿åˆ†ç±»â€ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-869.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-870.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-871.png" alt="img"></p>
<p>å®Œæˆäº†çˆ¶å­åŒæ­¥åˆ é™¤åï¼Œè§£å†³çˆ¶å­æ ‘çŠ¶ç»“æ„ã€‚è¿™æ ·å°±é¿å…çˆ¶å­å…¨åœ¨ä¸€çº§åˆ†ç±»</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-872-1024x415.png" alt="img"></p>
<p>å¯ä»¥çœ‹åˆ°æ˜¯çº¿æ€§çš„</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-873-1024x509.png" alt="img"></p>
<p>åŠ è½½åˆ†ç±»ä¿¡æ¯æ—¶query.setConvert2Tree(true);å¼€å¯æ ‘å½¢</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * åŠ è½½åˆ†ç±»ä¿¡æ¯</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> query</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@RequestMapping</span>(<span class="string">&quot;loadCategory&quot;</span>)</span><br><span class="line">   <span class="keyword">public</span> <span class="function">ResponseVO <span class="title">loadCategory</span><span class="params">(CategoryInfoQuery query)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// è®¾ç½®æ’åºæ¡ä»¶ï¼ŒæŒ‰ç…§sortå­—æ®µå‡åºæ’åˆ—</span></span><br><span class="line">       query.setOrderBy(<span class="string">&quot;sort asc&quot;</span>);</span><br><span class="line">       query.setConvert2Tree(<span class="keyword">true</span>);</span><br><span class="line">       <span class="comment">// æŸ¥è¯¢åˆ†ç±»ä¿¡æ¯åˆ—è¡¨</span></span><br><span class="line">       List&lt;CategoryInfo&gt;categoryInfoList = categoryInfoService.findListByParam(query);</span><br><span class="line">       <span class="function"><span class="keyword">return</span> <span class="title">getSuccessResponseVO</span><span class="params">(categoryInfoList)</span></span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨CategoryInfoQueryé‡ŒåŠ å…¥è¿™ä¸ªå±æ€§</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦è½¬æ¢æˆæ ‘ç»“æ„ï¼Œé»˜è®¤ä¸è½¬æ¢ï¼ˆfalseï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">Boolean</span> convert2Tree;</span><br></pre></td></tr></table></figure>
<p>æ”¹é€ è¿™ä¸ªæ–¹æ³•å¦‚ä¸‹</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®æ¡ä»¶æŸ¥è¯¢åˆ—è¡¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;CategoryInfo&gt; findListByParam(CategoryInfoQuery param) &#123;</span><br><span class="line">	List&lt;CategoryInfo&gt;categoryInfoList = <span class="keyword">this</span>.categoryInfoMapper.selectList(param);</span><br><span class="line">	<span class="keyword">return</span> categoryInfoList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨POåŒ…ä¸‹CategoryInfoä¸­</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ ‘å½¢ç»“æ„éœ€è¦çš„å­—æ®µ</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">List</span>&lt;<span class="type">CategoryInfo</span>&gt; children;</span><br></pre></td></tr></table></figure>
<p>CategoryInfoServiceImplä¸­</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®æ¡ä»¶æŸ¥è¯¢åˆ—è¡¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">List</span>&lt;<span class="title class_">CategoryInfo</span>&gt; <span class="title function_">findListByParam</span>(<span class="params"><span class="title class_">CategoryInfoQuery</span> param</span>) &#123;</span><br><span class="line">	<span class="title class_">List</span>&lt;<span class="title class_">CategoryInfo</span>&gt; categoryInfoList= <span class="variable language_">this</span>.<span class="property">categoryInfoMapper</span>.<span class="title function_">selectList</span>(param);</span><br><span class="line">	<span class="keyword">if</span>(param.<span class="title function_">getConvert2Tree</span>() != <span class="literal">null</span> &amp;&amp; param.<span class="title function_">getConvert2Tree</span>())&#123;</span><br><span class="line">		categoryInfoList = <span class="title function_">convertLine2Tree</span>(categoryInfoList, <span class="title class_">Constants</span>.<span class="property">ZERO</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> categoryInfoList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æŠŠçº¿æ€§è½¬ä¸ºæ ‘å½¢</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">dataList</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">pid</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="title class_">List</span>&lt;<span class="title class_">CategoryInfo</span>&gt;<span class="title function_">convertLine2Tree</span>(<span class="params"><span class="title class_">List</span>&lt;<span class="title class_">CategoryInfo</span>&gt;dataList,<span class="title class_">Integer</span> pid</span>)&#123;</span><br><span class="line">	<span class="title class_">List</span>&lt;<span class="title class_">CategoryInfo</span>&gt; children = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">	<span class="keyword">for</span>(<span class="title class_">CategoryInfo</span> <span class="attr">m</span>:dataList)&#123;</span><br><span class="line">		<span class="keyword">if</span>(m.<span class="title function_">getCategoryId</span>()!=<span class="literal">null</span>&amp;&amp;m.<span class="title function_">getpCategoryId</span>()!=<span class="literal">null</span>&amp;&amp;m.<span class="title function_">getpCategoryId</span>().<span class="title function_">equals</span>(pid))&#123;</span><br><span class="line">			m.<span class="title function_">setChildren</span>(<span class="title function_">convertLine2Tree</span>(dataList, m.<span class="title function_">getCategoryId</span>()));</span><br><span class="line">			children.<span class="title function_">add</span>(m);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> children;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚å›¾å·²æˆåŠŸè½¬ä¸ºæ ‘å½¢ç»“æ„</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-874-1024x404.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-875.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-876.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-877.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-878.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-881.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-882.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-883-1024x695.png" alt="img"></p>
<p>é—®é¢˜2ï¼šç°åœ¨æˆ‘å‘ç°äº†ä¸ªé—®é¢˜ï¼Œæˆ‘åˆ›å»ºå¥½ä¸€çº§åˆ†ç±»åå†åŠ å…¥äºŒçº§åˆ†ç±»ï¼Œåˆ é™¤äºŒçº§åˆ†ç±»æ—¶ç›´æ¥å°±åˆ æ‰äº†ã€‚å¦‚æœæœ‰äºŒçº§åˆ†ç±»çš„å‰æä¸‹åˆ ä¸€çº§åˆ†ç±»ï¼Œä¸€çº§åˆ†ç±»ç›´æ¥åˆ æ‰ä½†äºŒçº§åˆ†ç±»è¿˜åœ¨é‚£é‡Œï¼Œä½†æ˜¯æˆ‘é¡µé¢ä¹Ÿåˆ·æ–°ï¼ŒäºŒçº§åˆ†ç±»ä¹Ÿæ²¡äº†ï¼Œä¹Ÿå°±æ˜¯è¯´å•ç‹¬åˆ äºŒçº§åˆ†ç±»å®ƒç«‹å³å›æ˜¾ï¼Œåˆ ä¸€çº§åˆ†ç±»æ—¶è¿å¸¦ç€åˆ äºŒçº§åˆ†ç±»æ—¶ï¼ŒäºŒçº§åˆ†ç±»å´ä¸å›æ˜¾ï¼Œéœ€è¦åˆ·æ–°æ‰ä¼šä¸è§ï¼Œä½ å¸®æˆ‘åˆ†æä¸€ä¸‹è¿™æ˜¯å‰ç«¯å‡ºé—®é¢˜äº†è¿˜æ˜¯åç«¯å‡ºé—®é¢˜äº†</p>
<p>æ ¹æ®ChatGPT5æˆåŠŸè§£å†³</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-884.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-885.png" alt="img"></p>
<p>æ›¿æ¢CategoryListè¿™ä¸€å—çš„é€»è¾‘é—®é¢˜æˆåŠŸè§£å†³ï¼</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-886-744x1024.png" alt="img"></p>
<h4 id="4-å˜æ¢åˆ†ç±»ä½ç½®ï¼ˆä¸Šç§»-ä¸‹ç§»ï¼‰">4.å˜æ¢åˆ†ç±»ä½ç½®ï¼ˆä¸Šç§»/ä¸‹ç§»ï¼‰</h4>
<p>CategoryController</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¿®æ”¹åˆ†ç±»æ’åºï¼ˆä¸Šç§»/ä¸‹ç§»ï¼‰</span></span><br><span class="line"><span class="comment"> * @param pCategoryId çˆ¶åˆ†ç±»IDï¼ˆ0 è¡¨ç¤ºä¸€çº§åˆ†ç±»ï¼Œå¦åˆ™è¡¨ç¤ºæŸä¸ªä¸€çº§åˆ†ç±»ä¸‹çš„äºŒçº§åˆ†ç±»ï¼‰</span></span><br><span class="line"><span class="comment"> * @param categoryIds æ’åºåçš„åˆ†ç±»IDå­—ç¬¦ä¸²ï¼ˆç”¨é€—å·åˆ†éš”ï¼Œæ¯”å¦‚ &quot;3,5,4&quot;ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@RequestMapping</span>(<span class="string">&quot;/changeSort&quot;</span>)</span><br><span class="line">public ResponseVO <span class="built_in">changeSort</span>(<span class="variable">@NotNull</span> Integer pCategoryId,</span><br><span class="line">                             <span class="variable">@NotEmpty</span> String categoryIds) &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨ Service è¿›è¡Œæ’åºå¤„ç†</span></span><br><span class="line">    <span class="selector-tag">categoryInfoService</span><span class="selector-class">.changeSort</span>(pCategoryId, categoryIds);</span><br><span class="line">    <span class="comment">// è¿”å›ä¸€ä¸ªæˆåŠŸå“åº”</span></span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">getSuccessResponseVO</span>(null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>æ¥æ”¶å‰ç«¯ä¼ æ¥çš„ <code>pCategoryId</code> å’Œ <code>categoryIds</code>ã€‚</li>
<li><code>categoryIds</code> é‡Œçš„é¡ºåºï¼Œå°±æ˜¯ç”¨æˆ·åœ¨å‰ç«¯æ‹–åŠ¨/ä¸Šç§»ä¸‹ç§»åçš„æ–°é¡ºåºã€‚</li>
<li>æŠŠè¯·æ±‚è½¬äº¤ç»™ Service å¤„ç†ã€‚</li>
</ul>
<p>Service æ¥å£</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¿®æ”¹åˆ†ç±»æ’åº</span></span><br><span class="line"><span class="comment"> * @param pCategoryId çˆ¶åˆ†ç±»ID</span></span><br><span class="line"><span class="comment"> * @param categoryIds æ’åºåçš„åˆ†ç±»IDå­—ç¬¦ä¸²</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">changeSort</span><span class="params">(Integer pCategoryId, <span class="type">String</span> categoryIds)</span></span>;</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼š</p>
<ul>
<li>å®šä¹‰äº†ä¸€ä¸ªæ’åºæ›´æ–°æ–¹æ³•ï¼Œè®© Controller å’Œ ServiceImpl å¯¹æ¥ã€‚</li>
</ul>
<p>ServiceImpl å®ç°</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">changeSort</span>(<span class="params"><span class="title class_">Integer</span> pCategoryId, <span class="title class_">String</span> categoryIds</span>) &#123;</span><br><span class="line">    <span class="comment">// 1. æŠŠé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²æ‹†æˆæ•°ç»„</span></span><br><span class="line">    <span class="title class_">String</span>[] categoryIdArray = categoryIds.<span class="title function_">split</span>(<span class="string">&quot;,&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. ç”¨æ¥å­˜æ”¾è¦æ›´æ–°çš„åˆ†ç±»å¯¹è±¡</span></span><br><span class="line">    <span class="title class_">List</span>&lt;<span class="title class_">CategoryInfo</span>&gt; categoryInfoList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. æ’åºå·ä» 1 å¼€å§‹</span></span><br><span class="line">    <span class="title class_">Integer</span> sort = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. éå†æ•°ç»„ï¼Œä¾æ¬¡æ„é€  CategoryInfo å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="title class_">String</span> categoryId : categoryIdArray) &#123;</span><br><span class="line">        <span class="title class_">CategoryInfo</span> categoryInfo = <span class="keyword">new</span> <span class="title class_">CategoryInfo</span>();</span><br><span class="line">        categoryInfo.<span class="title function_">setCategoryId</span>(<span class="title class_">Integer</span>.<span class="built_in">parseInt</span>(categoryId)); <span class="comment">// åˆ†ç±»ID</span></span><br><span class="line">        categoryInfo.<span class="title function_">setpCategoryId</span>(pCategoryId);                 <span class="comment">// çˆ¶åˆ†ç±»ID</span></span><br><span class="line">        categoryInfo.<span class="title function_">setSort</span>(sort++);                             <span class="comment">// æ’åºå·ï¼ˆè‡ªå¢ï¼‰</span></span><br><span class="line">        categoryInfoList.<span class="title function_">add</span>(categoryInfo);                       <span class="comment">// æ”¾å…¥é›†åˆ</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. å¦‚æœé›†åˆéç©ºï¼Œå°±æ‰¹é‡æ›´æ–°åˆ°æ•°æ®åº“</span></span><br><span class="line">    <span class="keyword">if</span> (!categoryInfoList.<span class="title function_">isEmpty</span>()) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">categoryInfoMapper</span>.<span class="title function_">updateSortBatch</span>(categoryInfoList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼š</p>
<ul>
<li>
<p>æŠŠæ–°çš„æ’åºé¡ºåºè½¬æ¢æˆä¸€ç»„</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">CategoryInfo</span></span><br></pre></td></tr></table></figure>
<p>å¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡è®°å½•ï¼š</p>
<ul>
<li>åˆ†ç±»ID</li>
<li>çˆ¶åˆ†ç±»ID</li>
<li>æ–°çš„æ’åºå·</li>
</ul>
</li>
<li>
<p>æœ€åä¸€æ¬¡æ€§æ‰¹é‡æ›´æ–°æ•°æ®åº“ï¼Œé¿å…ä¸€æ¡æ¡æ›´æ–°æ•ˆç‡ä½ã€‚</p>
</li>
</ul>
<p>Mapper æ¥å£</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰¹é‡æ›´æ–°æ’åº</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="selector-tag">void</span> <span class="selector-tag">updateSortBatch</span>(<span class="variable">@Param</span>(<span class="string">&quot;categoryList&quot;</span>) List&lt;CategoryInfo&gt; categoryList);</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼š</p>
<ul>
<li>å®šä¹‰æ‰¹é‡æ›´æ–°çš„æ–¹æ³•ï¼Œæ¥æ”¶ä¸€ä¸ªåˆ†ç±»å¯¹è±¡åˆ—è¡¨ã€‚</li>
</ul>
<p>Mapper XML</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!-- æ‰¹é‡æ›´æ–°æ’åº --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateSortBatch&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;categoryList&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;;&quot;</span> <span class="attr">item</span>=<span class="string">&quot;item&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        update category_info </span></span><br><span class="line"><span class="language-xml">        set sort = #</span><span class="template-variable">&#123;item.sort&#125;</span><span class="language-xml"> </span></span><br><span class="line"><span class="language-xml">        where category_id = #</span><span class="template-variable">&#123;item.categoryId&#125;</span><span class="language-xml"> </span></span><br><span class="line"><span class="language-xml">          and p_category_id = #</span><span class="template-variable">&#123;item.pCategoryId&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼š</p>
<ul>
<li>MyBatis <code>&lt;foreach&gt;</code> å¾ªç¯æ‹¼æ¥å¤šæ¡ <code>UPDATE</code> SQLã€‚</li>
<li>æ¯æ¡ SQL æ›´æ–°ä¸€ä¸ªåˆ†ç±»çš„æ’åºå·ã€‚</li>
<li><code>separator=&quot;;&quot;</code> è¡¨ç¤ºå¤šæ¡ SQL ä¹‹é—´ç”¨åˆ†å·éš”å¼€ã€‚</li>
<li>æ›´æ–°æ¡ä»¶å¿…é¡»åŒ¹é… <code>category_id</code> å’Œ <code>p_category_id</code>ï¼Œä¿è¯ä¸ä¼šè¯¯æ›´æ–°åˆ°å…¶ä»–çˆ¶åˆ†ç±»ä¸‹çš„åŒå IDã€‚</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-887-1024x924.png" alt="img"></p>
<p><strong>è§£é‡Š</strong></p>
<ul>
<li><code>&lt;foreach&gt;</code> ä¼šéå† <code>categoryList</code> ä¸­çš„æ¯ä¸ª <code>item</code></li>
<li><code>#&#123;item.sort&#125;</code>ã€<code>#&#123;item.categoryId&#125;</code>ã€<code>#&#123;item.pCategoryId&#125;</code> ä¼šè¢«æ›¿æ¢æˆå¯¹åº”çš„å€¼ï¼ˆå¹¶å®‰å…¨ç»‘å®šä¸º SQL å‚æ•°ï¼‰</li>
<li><code>separator=&quot;;&quot;</code> ä¼šè®©å¤šæ¡è¯­å¥ä¹‹é—´ç”¨åˆ†å·éš”å¼€</li>
</ul>
<p>å¦‚æœæ‰¹é‡æ›´æ–°çš„æ•°æ®æ¯”è¾ƒå¤šï¼Œè¿™ç§æ–¹å¼ä¼šç›´æ¥æ‰§è¡Œå¤šæ¡ <code>UPDATE</code>ï¼Œè€Œä¸æ˜¯ä¸€æ¡ SQL å®Œæˆæ‰¹é‡æ›´æ–°ï¼Œè¿™æ ·ç®€å•ç›´è§‚ï¼Œä½†åœ¨æ•°æ®é‡å¾ˆå¤§æ—¶æ€§èƒ½ä¼šå·®ä¸€äº›ã€‚</p>
<h4 id="5-åˆ·æ–°ç¼“å­˜">5.åˆ·æ–°ç¼“å­˜</h4>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-889.png" alt="img"></p>
<p>CategoryInfoServiceImplä¸­å®šä¹‰save2Redisè¿™ä¸ªæ–¹æ³•</p>
<p>é¦–å…ˆç°åœ¨RedisComponentä¸­åŠ å…¥saveCategoryListè¿™ä¸ªæ–¹æ³•</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveCategoryList</span>(<span class="params">List&lt;CategoryInfo&gt;categoryInfoList</span>)</span>&#123;</span><br><span class="line">        redisUtils.<span class="keyword">set</span>(Constants.REDIS_KEY_CATEGORY_LIST,categoryInfoList);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ä½œç”¨</strong></li>
<li>æ¥æ”¶æœ€ç»ˆçš„åˆ†ç±»æ•°æ® <code>categoryInfoList</code></li>
<li>æŠŠå®ƒå†™å…¥ Redis
<ul>
<li>keyï¼š<code>category:list:</code>ï¼ˆå¸¸é‡ï¼‰</li>
<li>valueï¼šåˆ†ç±»æ•°æ®ï¼ˆä¼šè¢« JSON åºåˆ—åŒ–æˆå­—ç¬¦ä¸²ï¼‰</li>
</ul>
</li>
<li><strong>å…³é”®ç‚¹</strong></li>
<li><code>redisUtils.set()</code> å·²ç»åœ¨ RedisConfig é‡Œé…ç½®äº† JSON åºåˆ—åŒ–ï¼Œæ‰€ä»¥ <code>List&lt;CategoryInfo&gt;</code> ä¼šç›´æ¥å˜æˆ JSON å­˜å‚¨</li>
<li>key ç”¨å¸¸é‡æ˜¯ä¸ºäº†<strong>ç»Ÿä¸€ç®¡ç†</strong>ï¼Œé¿å…å†™é”™å’Œä¾¿äºä¿®æ”¹</li>
</ul>
<p>å…¶ä¸­<em>REDIS_KEY_CATEGORY_LIST</em>åœ¨Constantsä¸­å®šä¹‰ä¸º</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">String</span> REDIS_KEY_CATEGORY_LIST = <span class="string">&quot;category:list:&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>è¿™æ˜¯ç¼“å­˜åˆ†ç±»æ•°æ®çš„ key å‰ç¼€</li>
<li>å¦‚æœæœªæ¥è¦æ”¯æŒå¤šç«¯/å¤šç”¨æˆ·ï¼Œå¯ä»¥æ”¹æˆ <code>category:list:&lt;token&gt;</code> æˆ– <code>category:list:&lt;tenantId&gt;</code></li>
</ul>
<p>save2Rediså¦‚ä¸‹ï¼Œåªè¦åˆ†ç±»å‘ç”Ÿæ”¹å˜äº†å°±è¦åˆ·æ–°ç¼“å­˜</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private void save2Redis()&#123;</span><br><span class="line">		CategoryInfoQuery query <span class="operator">=</span> new CategoryInfoQuery()<span class="comment">;</span></span><br><span class="line">		query.setOrderBy(<span class="string">&quot;sort asc&quot;</span>)<span class="comment">;</span></span><br><span class="line">		query.setConvert2Tree(true)<span class="comment">;</span></span><br><span class="line">		List&lt;CategoryInfo&gt;categoryInfoList <span class="operator">=</span> findListByParam(query)<span class="comment">;</span></span><br><span class="line">		redisComponent.saveCategoryList(categoryInfoList)<span class="comment">;</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p><strong>åˆ›å»ºæŸ¥è¯¢æ¡ä»¶</strong><br>
<code>CategoryInfoQuery query = new CategoryInfoQuery();</code><br>
ç”¨äºå°è£…éœ€è¦æŸ¥è¯¢çš„æ¡ä»¶</p>
<p><strong>è®¾ç½®æ’åºè§„åˆ™</strong><br>
<code>query.setOrderBy(&quot;sort asc&quot;);</code><br>
ç¡®ä¿åˆ†ç±»åˆ—è¡¨æŒ‰ç…§ sort å€¼ä»å°åˆ°å¤§æ’åˆ—</p>
<p><strong>è¦æ±‚è½¬æˆæ ‘å½¢ç»“æ„</strong><br>
<code>query.setConvert2Tree(true);</code><br>
è®© <code>findListByParam()</code> é‡Œè‡ªåŠ¨è°ƒç”¨ <code>convertLine2Tree()</code></p>
<ul>
<li>æ•°æ®ä»æ•°æ®åº“å‡ºæ¥æ˜¯â€œçº¿æ€§â€çš„ï¼ˆæ¯æ¡è®°å½•æœ‰ <code>pCategoryId</code> æŒ‡å‘çˆ¶ç±»ï¼‰</li>
<li>è½¬æ ‘å½¢åï¼Œä¸€çº§åˆ†ç±»é‡Œä¼šåŒ…å«å®ƒçš„ childrenï¼ˆäºŒçº§åˆ†ç±»ï¼‰</li>
</ul>
<p><strong>æ‰§è¡ŒæŸ¥è¯¢</strong><br>
<code>findListByParam(query)</code> è¿”å›çš„æ˜¯<strong>æ’å¥½åºçš„æ ‘å½¢åˆ†ç±»åˆ—è¡¨</strong></p>
<p><strong>ä¿å­˜åˆ° Redis</strong><br>
<code>redisComponent.saveCategoryList(categoryInfoList);</code><br>
æŠŠæœ€ç»ˆçš„æ ‘å½¢ç»“æ„å­˜å…¥ç¼“å­˜ï¼Œä¾›å‰ç«¯ç›´æ¥è¯»å–</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-888-1024x741.png" alt="img"></p>
<p>å½“æ›´æ”¹æ’åºæ—¶å¯ä»¥çœ‹åˆ°ç¼“å­˜æˆåŠŸåˆ·æ–°</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-890.png" alt="img"></p>
<h4 id="6-ä¸Šä¼ å›¾ç‰‡">6.ä¸Šä¼ å›¾ç‰‡</h4>
<p>æ•´ä½“æµç¨‹</p>
<p>å‰ç«¯ä¸Šä¼ å›¾ç‰‡ â†’ æ¥å£æ¥æ”¶å¹¶è½ç›˜ï¼ˆæŒ‰æœˆä»½åˆ†ç›®å½•+éšæœºæ–‡ä»¶åï¼‰â†’ å¦‚éœ€ç¼©ç•¥å›¾åˆ™è°ƒç”¨ <code>ffmpeg</code> ç”Ÿæˆä¸€å¼  200px å®½çš„ç¼©ç•¥å›¾ â†’ è¿”å›ç›¸å¯¹è·¯å¾„ï¼ˆç»™å‰ç«¯å›æ˜¾/è®¿é—®ï¼‰ã€‚</p>
<p>åˆ›å»º FileController</p>
<p>å‰æå‡†å¤‡</p>
<p>DateTimePatternEnumä¸­å®šä¹‰<em>YYYYMM</em></p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">YYYY_MM_DD_HH_MM_SS</span>(&quot;yyyy-MM-dd HH:mm:ss&quot;), <span class="built_in">YYYY_MM_DD</span>(&quot;yyyy-MM-dd&quot;),<span class="built_in">YYYYMM</span>(&quot;yyyyMM&quot;);</span><br></pre></td></tr></table></figure>
<p>Constantsä¸­å®šä¹‰FILE_FOLDERå’ŒFILE_COVER</p>
<p>ä¸Šä¼ å›¾ç‰‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ–‡ä»¶ä¸Šä¼ è·¯å¾„</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILE_FOLDER</span> <span class="operator">=</span> <span class="string">&quot;file/&quot;</span>;</span><br><span class="line"><span class="comment">//å°é¢å›¾ç‰‡è·¯å¾„å‰ç¼€</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILE_COVER</span> <span class="operator">=</span> <span class="string">&quot;cover/&quot;</span>;</span><br><span class="line"><span class="comment">//è§†é¢‘æ–‡ä»¶è·¯å¾„å‰ç¼€</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILE_VIDEO</span> <span class="operator">=</span> <span class="string">&quot;video/&quot;</span>;</span><br><span class="line"><span class="comment">//ä¸´æ—¶æ–‡ä»¶è·¯å¾„å‰ç¼€</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILE_FOLDER_TEMP</span> <span class="operator">=</span> <span class="string">&quot;temp/&quot;</span>;</span><br><span class="line"><span class="comment">//ç¼©ç•¥å›¾åç¼€</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">IMAGE_THUMBNAIL_SUFFIX</span> <span class="operator">=</span> <span class="string">&quot;_thumbnail.jpg&quot;</span>;</span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/file&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileController</span> <span class="keyword">extends</span> <span class="title class_">ABaseController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AppConfig appConfig;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/uploadImage&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseVO <span class="title function_">uploadCover</span><span class="params">(<span class="meta">@NotNull</span> MultipartFile file, <span class="meta">@NotNull</span> Boolean createThumbnail)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">month</span> <span class="operator">=</span> DateUtil.format(<span class="keyword">new</span> <span class="title class_">Date</span>(), DateTimePatternEnum.YYYYMM.getPattern());</span><br><span class="line">        <span class="type">String</span> <span class="variable">folder</span> <span class="operator">=</span> appConfig.getProjectFolder() + Constants.FILE_FOLDER + Constants.FILE_COVER + month;</span><br><span class="line">        <span class="type">File</span> <span class="variable">folderFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(folder);</span><br><span class="line">        <span class="keyword">if</span> (!folderFile.exists()) &#123;</span><br><span class="line">            folderFile.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> file.getOriginalFilename();</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileSuffix</span> <span class="operator">=</span> fileName.substring(fileName.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">realFileName</span> <span class="operator">=</span> StringTools.getRandomString(Constants.LENGTH_30) + fileSuffix;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> folder + <span class="string">&quot;/&quot;</span> + realFileName;</span><br><span class="line">        file.transferTo(<span class="keyword">new</span> <span class="title class_">File</span>(filePath));</span><br><span class="line">        <span class="keyword">if</span> (createThumbnail) &#123;</span><br><span class="line">            <span class="comment">//ç”Ÿæˆç¼©ç•¥å›¾</span></span><br><span class="line">            fFmpegUtils.createImageThumbnail(filePath);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(Constants.FILE_COVER + month + <span class="string">&quot;/&quot;</span> + realFileName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œéœ€è¦ä¸€ä¸ªfFmpegUtilsç±»ä¸­çš„createImageThumbnailæ–¹æ³•</p>
<p>åœ¨æ­¤ä¹‹å‰å…ˆå®šä¹‰ä¸€ä¸ªProcessUtilsï¼Œè¯¥ç±»ä¸»è¦ç”¨äºæ‰§è¡Œå‘½ä»¤å¹¶å¤„ç†ç›¸å…³çš„è¿›ç¨‹æ“ä½œï¼Œç‰¹åˆ«æ˜¯é’ˆå¯¹ä¸åŒæ“ä½œç³»ç»Ÿæ‰§è¡ŒffmpegæŒ‡ä»¤ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.easylive.exception.BusinessException;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProcessUtils</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(ProcessUtils.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">osName</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">executeCommand</span><span class="params">(String cmd, Boolean showLog)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (StringTools.isEmpty(cmd)) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Windows ç›´æ¥æ‰§è¡Œï¼›Linux èµ° /bin/sh -c</span></span><br><span class="line">        process = osName.contains(<span class="string">&quot;win&quot;</span>)</span><br><span class="line">                  ? Runtime.getRuntime().exec(cmd)</span><br><span class="line">                  : Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// âš  è¿™é‡Œç›´æ¥ waitForï¼Œç„¶åå†é€è¡Œè¯» stdout/stderr</span></span><br><span class="line">        <span class="comment">// è‹¥ ffmpeg è¾“å‡ºå¾ˆå¤§ï¼Œæœ‰â€œç¼“å†²åŒºé˜»å¡â€é£é™©ï¼ˆè§ä¸‹â€œæ”¹è¿›å»ºè®®â€ï¼‰</span></span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getErrorStream()));</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line"></span><br><span class="line">        process.waitFor();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ±‡æ€»è¾“å‡º</span></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        String line;</span><br><span class="line">        <span class="keyword">while</span> ((line = err.readLine()) != <span class="literal">null</span>) result.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span> ((line = out.readLine()) != <span class="literal">null</span>) result.append(line).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (showLog) logger.info(<span class="string">&quot;æ‰§è¡Œå‘½ä»¤: &#123;&#125; ç»“æœ: &#123;&#125;&quot;</span>, cmd, result.toString());</span><br><span class="line">        <span class="keyword">return</span> result.toString();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;æ‰§è¡Œå‘½ä»¤å¤±è´¥ cmd: &#123;&#125; å¤±è´¥: &#123;&#125;&quot;</span>, cmd, e.getMessage(), e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;è§†é¢‘è½¬æ¢å¤±è´¥: &quot;</span> + e.getMessage(), e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (process != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// è¿›ç¨‹æ¸…ç†ï¼šJVM å…³é—­æ—¶é”€æ¯å¤–éƒ¨è¿›ç¨‹</span></span><br><span class="line">            <span class="type">ProcessKiller</span> <span class="variable">ffmpegKiller</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessKiller</span>(process);</span><br><span class="line">            runtime.addShutdownHook(ffmpegKiller);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åœ¨ç¨‹åºé€€å‡ºå‰ç»“æŸå·²æœ‰çš„FFmpegè¿›ç¨‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ProcessKiller</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> Process process;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ProcessKiller</span><span class="params">(Process process)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.process = process;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.process.destroy();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨äºå–å‡ºffmpegçº¿ç¨‹æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„å„ç§è¾“å‡ºå’Œé”™è¯¯æµçš„ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">PrintStream</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">bufferedReader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">stringBuffer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">PrintStream</span><span class="params">(InputStream inputStream)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.inputStream = inputStream;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == inputStream) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                bufferedReader = <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(inputStream));</span><br><span class="line">                <span class="type">String</span> <span class="variable">line</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">while</span> ((line = bufferedReader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                    stringBuffer.append(line);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;è¯»å–è¾“å…¥æµå‡ºé”™äº†ï¼é”™è¯¯ä¿¡æ¯ï¼š&quot;</span> + e.getMessage());</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="literal">null</span> != bufferedReader) &#123;</span><br><span class="line">                        bufferedReader.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="literal">null</span> != inputStream) &#123;</span><br><span class="line">                        inputStream.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    logger.error(<span class="string">&quot;è°ƒç”¨PrintStreamè¯»å–è¾“å‡ºæµåï¼Œå…³é—­æµæ—¶å‡ºé”™ï¼&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-893.png" alt="img"></p>
<p>FFmpegUtils</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">easylive</span>.<span class="property">utils</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">config</span>.<span class="property">AppConfig</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">constants</span>.<span class="property">Constants</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.<span class="property">annotation</span>.<span class="property">Resource</span>;</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FFmpegUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">AppConfig</span> appConfig;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”Ÿæˆå›¾ç‰‡ç¼©ç•¥å›¾</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> <span class="variable">filePath</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">createImageThumbnail</span>(<span class="params"><span class="title class_">String</span> filePath</span>) &#123;</span><br><span class="line">        final <span class="title class_">String</span> <span class="variable constant_">CMD_CREATE_IMAGE_THUMBNAIL</span> = <span class="string">&quot;ffmpeg -i \&quot;%s\&quot; -vf scale=200:-1 \&quot;%s\&quot;&quot;</span>;</span><br><span class="line">         <span class="title class_">String</span> out = filePath + <span class="title class_">Constants</span>.<span class="property">IMAGE_THUMBNAIL_SUFFIX</span>; <span class="comment">// &quot;_thumbnail.jpg&quot;</span></span><br><span class="line">        <span class="title class_">String</span> cmd = <span class="title class_">String</span>.<span class="title function_">format</span>(<span class="variable constant_">CMD</span>, filePath, out);</span><br><span class="line">        <span class="title class_">ProcessUtils</span>.<span class="title function_">executeCommand</span>(cmd, appConfig.<span class="title function_">getShowFFmpegLog</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è¦ç‚¹&amp;å»ºè®®</strong></p>
<ul>
<li><code>-vf scale=200:-1</code>ï¼šå®½åº¦å®šä¸º 200ï¼Œä¿æŒå®½é«˜æ¯”è‡ªåŠ¨è®¡ç®—é«˜åº¦ã€‚</li>
<li>Windows è·¯å¾„/ç©ºæ ¼é—®é¢˜é€šè¿‡ç»™è·¯å¾„åŠ å¼•å·è§£å†³ï¼ˆå·²å¤„ç†ï¼‰ã€‚</li>
<li>è‹¥ç¼©ç•¥å›¾ä¸åŸå›¾åˆ†ç›®å½•ç®¡ç†ï¼ˆå¦‚ <code>thumb/</code>ï¼‰ï¼Œæ›´åˆ©äºå‰ç«¯åŒºåˆ†ä¸ CDN ç¼“å­˜ã€‚</li>
</ul>
<p>appconfigä¸­æ–°å¢</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ˜¯å¦æ˜¾ç¤ºffmpegæ—¥å¿—ï¼Œé»˜è®¤å±•ç¤º</span></span><br><span class="line">   <span class="meta">@Value</span>(<span class="string">&quot;$&#123;showFFmegLog:true&quot;</span>)</span><br><span class="line">   <span class="keyword">private</span> <span class="title class_">Boolean</span> showFFmpegLog;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">Boolean</span> <span class="title function_">getShowFFmpegLog</span>(<span class="params"></span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> showFFmpegLog;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•æ—¶å‘ç°é—®é¢˜ï¼šæ‰¾ä¸åˆ°æ–‡ä»¶è·¯å¾„</p>
<p>æ”¹è¿›uploadCover</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/uploadImage&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">uploadCover</span>(<span class="params"></span></span><br><span class="line"><span class="params">        <span class="meta">@NotNull</span> <span class="title class_">MultipartFile</span> file,              <span class="comment">// å‰ç«¯ä¸Šä¼ çš„æ–‡ä»¶å¯¹è±¡</span></span></span><br><span class="line"><span class="params">        <span class="meta">@NotNull</span> <span class="title class_">Boolean</span> createThumbnail          <span class="comment">// æ˜¯å¦ç”Ÿæˆç¼©ç•¥å›¾</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 1) ä»¥ yyyyMM æ ¼å¼ç”Ÿæˆå½“å‰å¹´æœˆå­—ç¬¦ä¸²ï¼Œç”¨äºæŒ‰æœˆåˆ†æ–‡ä»¶å¤¹å­˜å‚¨ï¼Œä¾‹å¦‚ï¼š202508</span></span><br><span class="line">    <span class="title class_">String</span> month = <span class="title class_">DateUtil</span>.<span class="title function_">format</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(), <span class="title class_">DateTimePatternEnum</span>.<span class="property">YYYYMM</span>.<span class="title function_">getPattern</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) æ‹¼æ¥æ–‡ä»¶ä¿å­˜ç›®å½•ï¼š</span></span><br><span class="line">    <span class="comment">// &#123;projectFolder&#125;/file/cover/&#123;month&#125;</span></span><br><span class="line">    <span class="comment">// appConfig.getProjectFolder()ï¼šé¡¹ç›®æ–‡ä»¶æ ¹ç›®å½•ï¼ˆé€šå¸¸é…ç½®åœ¨ application.ymlï¼‰</span></span><br><span class="line">    <span class="title class_">String</span> folder = appConfig.<span class="title function_">getProjectFolder</span>()</span><br><span class="line">            + <span class="title class_">Constants</span>.<span class="property">FILE_FOLDER</span>       <span class="comment">// &quot;file/&quot;</span></span><br><span class="line">            + <span class="title class_">Constants</span>.<span class="property">FILE_COVER</span>        <span class="comment">// &quot;cover/&quot;</span></span><br><span class="line">            + month;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) ç¡®ä¿ç›®å½•å­˜åœ¨ &amp; æ£€æŸ¥æƒé™</span></span><br><span class="line">    <span class="title class_">File</span> folderFile = <span class="keyword">new</span> <span class="title class_">File</span>(folder);</span><br><span class="line">    <span class="keyword">if</span> (!folderFile.<span class="title function_">exists</span>()) &#123;</span><br><span class="line">        <span class="built_in">boolean</span> mkdirResult = folderFile.<span class="title function_">mkdirs</span>(); <span class="comment">// é€’å½’åˆ›å»ºç›®å½•</span></span><br><span class="line">        <span class="keyword">if</span> (!mkdirResult) &#123;</span><br><span class="line">            <span class="comment">// åˆ›å»ºå¤±è´¥ï¼ˆå¯èƒ½æ˜¯æƒé™ä¸è¶³æˆ–è·¯å¾„æ— æ•ˆï¼‰</span></span><br><span class="line">            log.<span class="title function_">error</span>(<span class="string">&quot;æ–‡ä»¶å¤¹åˆ›å»ºå¤±è´¥: &#123;&#125;, è¯·æ£€æŸ¥ç›®å½•æƒé™&quot;</span>, folder);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(</span><br><span class="line">                    <span class="title class_">ResponseCodeEnum</span>.<span class="property">CODE_600</span>.<span class="title function_">getCode</span>(),</span><br><span class="line">                    <span class="string">&quot;æ–‡ä»¶ä¸Šä¼ å¤±è´¥: æ–‡ä»¶å¤¹åˆ›å»ºå¤±è´¥, è¯·æ£€æŸ¥ç›®å½•æƒé™&quot;</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!folderFile.<span class="title function_">canWrite</span>()) &#123;</span><br><span class="line">        <span class="comment">// ç›®å½•å­˜åœ¨ä½†æ— å†™æƒé™</span></span><br><span class="line">        log.<span class="title function_">error</span>(<span class="string">&quot;æ–‡ä»¶å¤¹æ²¡æœ‰å†™å…¥æƒé™: &#123;&#125;&quot;</span>, folder);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(</span><br><span class="line">                <span class="title class_">ResponseCodeEnum</span>.<span class="property">CODE_600</span>.<span class="title function_">getCode</span>(),</span><br><span class="line">                <span class="string">&quot;æ–‡ä»¶ä¸Šä¼ å¤±è´¥: æ–‡ä»¶å¤¹æ²¡æœ‰å†™å…¥æƒé™&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) ç”Ÿæˆéšæœºæ–‡ä»¶åï¼ˆä¿ç•™åŸåç¼€ï¼‰</span></span><br><span class="line">    <span class="title class_">String</span> fileName = file.<span class="title function_">getOriginalFilename</span>();  <span class="comment">// åŸå§‹æ–‡ä»¶åï¼Œä¾‹å¦‚ &quot;abc.jpg&quot;</span></span><br><span class="line">    <span class="title class_">String</span> fileSuffix = fileName.<span class="title function_">substring</span>(fileName.<span class="title function_">lastIndexOf</span>(<span class="string">&quot;.&quot;</span>)); <span class="comment">// å–æ–‡ä»¶åç¼€ï¼Œä¾‹å¦‚ &quot;.jpg&quot;</span></span><br><span class="line">    <span class="title class_">String</span> realFileName = <span class="title class_">StringTools</span>.<span class="title function_">getRandomString</span>(<span class="title class_">Constants</span>.<span class="property">LENGTH_30</span>) + fileSuffix; <span class="comment">// ç”Ÿæˆéšæœºä¸² + åç¼€</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5) ç»„åˆå®Œæ•´æ–‡ä»¶è·¯å¾„ï¼Œä¾‹å¦‚ï¼š</span></span><br><span class="line">    <span class="comment">// /var/project/file/cover/202508/éšæœºä¸².jpg</span></span><br><span class="line">    <span class="title class_">String</span> filePath = folder + <span class="title class_">File</span>.<span class="property">separator</span> + realFileName;</span><br><span class="line">    <span class="title class_">File</span> destFile = <span class="keyword">new</span> <span class="title class_">File</span>(filePath);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6) å°†ä¸Šä¼ æ–‡ä»¶ä¿å­˜åˆ°ç£ç›˜</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        file.<span class="title function_">transferTo</span>(destFile); <span class="comment">// Spring æä¾›çš„ç›´æ¥ä¿å­˜æ–¹æ³•</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="title class_">IOException</span> e) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœ transferTo å¤±è´¥ï¼Œåˆ™æ‰‹åŠ¨å†™å…¥å­—èŠ‚æµï¼ˆå…œåº•æ–¹æ¡ˆï¼‰</span></span><br><span class="line">        <span class="title function_">try</span> (<span class="title class_">OutputStream</span> os = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(destFile)) &#123;</span><br><span class="line">            os.<span class="title function_">write</span>(file.<span class="title function_">getBytes</span>());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="title class_">IOException</span> ex) &#123;</span><br><span class="line">            log.<span class="title function_">error</span>(<span class="string">&quot;æ–‡ä»¶ä¸Šä¼ å¤±è´¥&quot;</span>, ex);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="title class_">ResponseCodeEnum</span>.<span class="property">CODE_600</span>.<span class="title function_">getCode</span>(), <span class="string">&quot;æ–‡ä»¶ä¸Šä¼ å¤±è´¥&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 7) å¦‚æœéœ€è¦ï¼Œç”Ÿæˆç¼©ç•¥å›¾ï¼ˆé€šå¸¸ç”¨äºå°é¢å›¾ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (createThumbnail) &#123;</span><br><span class="line">        fFmpegUtils.<span class="title function_">createImageThumbnail</span>(filePath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 8) è¿”å›æ–‡ä»¶ç›¸å¯¹è·¯å¾„ï¼ˆä¾›å‰ç«¯æ‹¼æ¥è®¿é—® URLï¼‰</span></span><br><span class="line">    <span class="comment">// ä¾‹å¦‚ï¼š&quot;cover/202508/éšæœºä¸².jpg&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(<span class="title class_">Constants</span>.<span class="property">FILE_COVER</span> + month + <span class="string">&quot;/&quot;</span> + realFileName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å’Œæ—§ç‰ˆç›¸æ¯”çš„æ”¹è¿›ç‚¹ï¼ˆæ€»ç»“ï¼‰</p>
<ol>
<li><strong>ç›®å½•åˆ›å»ºå¤±è´¥ç«‹å³æŠ›é”™</strong> â†’ é¿å…åç»­å†™æ–‡ä»¶æ—¶æŠ¥æ‰¾ä¸åˆ°è·¯å¾„ã€‚</li>
<li><strong>æå‰æ£€æµ‹ç›®å½•å†™æƒé™</strong> â†’ æå‰æš´éœ²è¿ç»´é—®é¢˜ã€‚</li>
<li><strong>æ–‡ä»¶ä¿å­˜æœ‰å…œåº•æµå¼å†™æ³•</strong> â†’ æå‡å®¹é”™æ€§å’Œå…¼å®¹æ€§ã€‚</li>
<li><strong>è·¨å¹³å°è·¯å¾„æ‹¼æ¥</strong> â†’ <code>File.separator</code> é€‚é… Windows / Linuxã€‚</li>
<li><strong>è¯¦ç»†æ—¥å¿—è®°å½•</strong> â†’ å‡ºé”™åæ›´å®¹æ˜“æ’æŸ¥åŸå› ã€‚</li>
</ol>
<p>ä¸Šä¼ æµ‹è¯•</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-892-1024x430.png" alt="img"></p>
<h4 id="7-è·å–æ–‡ä»¶">7.è·å–æ–‡ä»¶</h4>
<p>è¿™é‡Œè¿™å—â€œè·å–æ–‡ä»¶â€çš„é€»è¾‘ï¼Œæ˜¯ç»™å‰ç«¯ä¸€ä¸ª<strong>æŒ‰ç›¸å¯¹è·¯å¾„è¯»å–å¹¶å›ä¼ é™æ€æ–‡ä»¶</strong>çš„æ¥å£ã€‚å®ƒè‡ªå·±åšäº†å®‰å…¨æ ¡éªŒã€é˜²è·¯å¾„ç©¿è¶Šã€è®¾ç½®å“åº”å¤´ï¼Œç„¶åæŠŠç£ç›˜ä¸Šçš„æ–‡ä»¶ä»¥<strong>å­—èŠ‚æµ</strong>å†™å›æµè§ˆå™¨ã€‚</p>
<p>åœ¨FlieControllerä¸­</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(<span class="string">&quot;/getResource&quot;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getResource</span>(<span class="params">HttpServletResponse response, @NotEmpty String sourceName</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!StringTools.pathIsOk(sourceName)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(ResponseCodeEnum.CODE_600);</span><br><span class="line">        &#125;</span><br><span class="line">        String suffix = StringTools.getFileSuffix(sourceName);</span><br><span class="line">        response.setContentType(<span class="string">&quot;image/&quot;</span> + suffix.replace(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;&quot;</span>));</span><br><span class="line">        response.setHeader(<span class="string">&quot;Cache-Control&quot;</span>, <span class="string">&quot;max-age=2592000&quot;</span>);</span><br><span class="line">        readFile(response, sourceName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">readFile</span>(<span class="params">HttpServletResponse response, String filePath</span>)</span> &#123;</span><br><span class="line">        File <span class="keyword">file</span> = <span class="keyword">new</span> File(appConfig.getProjectFolder() + Constants.FILE_FOLDER + filePath);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">file</span>.exists()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> (OutputStream <span class="keyword">out</span> = response.getOutputStream(); FileInputStream <span class="keyword">in</span> = <span class="keyword">new</span> FileInputStream(<span class="keyword">file</span>)) &#123;</span><br><span class="line">            <span class="built_in">byte</span>[] byteData = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="built_in">int</span> len = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> ((len = <span class="keyword">in</span>.read(byteData)) != <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="keyword">out</span>.write(byteData, <span class="number">0</span>, len);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">out</span>.flush();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;è¯»å–æ–‡ä»¶å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>sourceName</code></strong>ï¼šå‰ç«¯ä¼ æ¥çš„<strong>ç›¸å¯¹è·¯å¾„</strong>ï¼ˆä¾‹å¦‚ <code>cover/202508/xxx.jpg</code>ï¼‰ï¼Œæ§åˆ¶å™¨ä¸ä¼šè®©ä½ è·¨å‡ºé¡¹ç›®çš„æ–‡ä»¶æ ¹ç›®å½•ã€‚</li>
<li><strong><code>pathIsOk</code></strong>ï¼šé˜»æ­¢ <code>../</code> æˆ– <code>..\\</code> è¿™ç±»ç›®å½•ä¸Šè·³ï¼ˆè·¯å¾„ç©¿è¶Šæ”»å‡»å¸¸ç”¨æ‰‹æ®µï¼‰ã€‚</li>
<li><strong><code>Content-Type</code></strong>ï¼šç”¨åç¼€ç®€å•æ¨æ–­æˆ <code>image/*</code>ï¼Œæµè§ˆå™¨å°±èƒ½ç›´æ¥æ˜¾ç¤ºå›¾ç‰‡äº†ã€‚</li>
<li><strong><code>Cache-Control</code></strong>ï¼šç»™é™æ€èµ„æºåŠ å¼ºç¼“å­˜ï¼Œå‡å°‘å¸¦å®½ä¸è¯·æ±‚æ•°ã€‚</li>
</ul>
<p>readFileä¸­</p>
<ul>
<li>çœŸå®è¯»å–ä½ç½®å›ºå®šåœ¨ <code>projectFolder/file/</code> ä¹‹ä¸‹ï¼Œ<code>sourceName</code> åªèƒ½åœ¨è¿™ä¸‹é¢æ´»åŠ¨ï¼Œç»“åˆå‰é¢çš„<strong>è·¯å¾„ç©¿è¶Šæ‹¦æˆª</strong>ï¼Œèƒ½æœ‰æ•ˆé™åˆ¶è®¿é—®èŒƒå›´ã€‚</li>
<li>é‡‡ç”¨ <strong>try-with-resources</strong> è‡ªåŠ¨å…³é—­è¾“å…¥/è¾“å‡ºæµï¼Œé¿å…èµ„æºæ³„æ¼ã€‚</li>
</ul>
<p>åœ¨StringToolsä¸­å®šä¹‰pathIsOkã€getFileSuffixæ–¹æ³•</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title class_">String</span> <span class="title function_">getFileSuffix</span>(<span class="params"><span class="title class_">String</span> fileName</span>) &#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="title class_">StringTools</span>.<span class="title function_">isEmpty</span>(fileName) || !fileName.<span class="title function_">contains</span>(<span class="string">&quot;.&quot;</span>)) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="title class_">String</span> suffix = fileName.<span class="title function_">substring</span>(fileName.<span class="title function_">lastIndexOf</span>(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">       <span class="keyword">return</span> suffix;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">boolean</span> <span class="title function_">pathIsOk</span>(<span class="params"><span class="title class_">String</span> path</span>) &#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="title class_">StringTools</span>.<span class="title function_">isEmpty</span>(path)) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (path.<span class="title function_">contains</span>(<span class="string">&quot;../&quot;</span>) || path.<span class="title function_">contains</span>(<span class="string">&quot;..\\&quot;</span>)) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong><code>getFileSuffix</code></strong> ç”¨äºè®¾ç½® <code>Content-Type</code>ã€‚</li>
<li><strong><code>pathIsOk</code></strong> æ˜¯æœ€å…³é”®çš„<strong>å®‰å…¨é—¸é—¨</strong>ï¼Œé¿å…è¯·æ±‚ä»»æ„ç³»ç»Ÿæ–‡ä»¶ï¼ˆä¾‹å¦‚ <code>/etc/passwd</code>ï¼‰ã€‚</li>
</ul>
<p>è·å–æµ‹è¯•</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-891-1024x504.png" alt="img"></p>
<h4 id="8-å®¢æˆ·ç«¯è·å–å…¨éƒ¨åˆ†ç±»">8.å®¢æˆ·ç«¯è·å–å…¨éƒ¨åˆ†ç±»</h4>
<p>CategoryController</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.web.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.po.<span class="type">CategoryInfo</span>;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.vo.<span class="type">ResponseVO</span>;</span><br><span class="line"><span class="keyword">import</span> com.easylive.service.<span class="type">CategoryInfoService</span>;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.annotation.<span class="type">Validated</span>;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.<span class="type">RequestMapping</span>;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.<span class="type">RestController</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.<span class="type">Resource</span>;</span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">List</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/category&quot;</span>)</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">CategoryController</span> <span class="keyword">extends</span> <span class="title">ABaseController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">CategoryInfoService</span> categoryInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">&quot;/loadAllCategory&quot;</span>)</span><br><span class="line">    public <span class="type">ResponseVO</span> loadAllCategory() &#123;</span><br><span class="line">        <span class="type">List</span>&lt;<span class="type">CategoryInfo</span>&gt; categoryInfoList = categoryInfoService.getAllCategoryList();</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(categoryInfoList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½œç”¨ï¼šç»™å®¢æˆ·ç«¯ä¸€ä¸ªâ€œæ‹¿å…¨é‡åˆ†ç±»â€çš„ç»Ÿä¸€å…¥å£ã€‚</p>
<p>Service</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * è·å–æ‰€æœ‰åˆ†ç±»ä¿¡æ¯</span></span><br><span class="line"><span class="comment">	 * @return</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function">List&lt;CategoryInfo&gt; <span class="title">getAllCategoryList</span>()</span>;</span><br></pre></td></tr></table></figure>
<p>ServiceImpl</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="type">List</span>&lt;<span class="type">CategoryInfo</span>&gt; getAllCategoryList() &#123;</span><br><span class="line">		<span class="type">List</span>&lt;<span class="type">CategoryInfo</span>&gt; categoryInfoList <span class="operator">=</span> redisComponent.getCategoryList();</span><br><span class="line">		<span class="keyword">if</span> (categoryInfoList.isEmpty()) &#123;</span><br><span class="line">			save2Redis();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> redisComponent.getCategoryList();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-895.png" alt="img"></p>
<p>RedisComponent</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * è·å–åˆ†ç±»ä¿¡æ¯</span></span><br><span class="line"><span class="comment">    * @return</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> List&lt;CategoryInfo&gt; <span class="title">getCategoryList</span>()</span> &#123;</span><br><span class="line">       List&lt;CategoryInfo&gt; categoryInfoList = (List&lt;CategoryInfo&gt;) redisUtils.<span class="keyword">get</span>(Constants.REDIS_KEY_CATEGORY_LIST);</span><br><span class="line">       <span class="keyword">return</span> categoryInfoList == <span class="literal">null</span> ? <span class="keyword">new</span> ArrayList&lt;&gt;() : categoryInfoList;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-896.png" alt="img"></p>
<p>æŠŠfileControllerçš„å†…å®¹å¤åˆ¶åˆ°webç«¯å»æ‰é‡Œé¢çš„ä¸Šä¼ å›¾ç‰‡æ¥å£ï¼ˆè¿™ä¸ªå®¢æˆ·ç«¯çš„FileControlleåæœŸå†å®ç°ï¼‰</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-897.png" alt="img"></p>
<p>æµ‹è¯•å¦‚å›¾</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-894-1024x293.png" alt="img"></p>
<h2 id="5-è§†é¢‘ç®¡ç†">5.è§†é¢‘ç®¡ç†</h2>
<h3 id="1-æ„å»ºè§†é¢‘è¡¨">1.æ„å»ºè§†é¢‘è¡¨</h3>
<p>è®¾è®¡ä¸¤å¥—è¡¨å…±å››å¼ è¡¨</p>
<p>ä¸»è¡¨ä¸å­è¡¨</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for video_info</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> `video_info`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `video_info`  (</span><br><span class="line">  `video_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;è§†é¢‘ID&#x27;</span>,</span><br><span class="line">  `video_cover` <span class="type">varchar</span>(<span class="number">50</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;è§†é¢‘å°é¢&#x27;</span>,</span><br><span class="line">  `video_name` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;è§†é¢‘åç§°&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ç”¨æˆ·ID&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;åˆ›å»ºæ—¶é—´&#x27;</span>,</span><br><span class="line">  `last_update_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æœ€åæ›´æ–°æ—¶é—´&#x27;</span>,</span><br><span class="line">  `p_category_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;çˆ¶çº§åˆ†ç±»ID&#x27;</span>,</span><br><span class="line">  `category_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;åˆ†ç±»ID&#x27;</span>,</span><br><span class="line">  `post_type` tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;0:è‡ªåˆ¶ä½œ  1:è½¬è½½&#x27;</span>,</span><br><span class="line">  `origin_info` <span class="type">varchar</span>(<span class="number">200</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;åŸèµ„æºè¯´æ˜&#x27;</span>,</span><br><span class="line">  `tags` <span class="type">varchar</span>(<span class="number">300</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æ ‡ç­¾&#x27;</span>,</span><br><span class="line">  `introduction` <span class="type">varchar</span>(<span class="number">2000</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ç®€ä»‹&#x27;</span>,</span><br><span class="line">  `interaction` <span class="type">varchar</span>(<span class="number">5</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;äº’åŠ¨è®¾ç½®&#x27;</span>,</span><br><span class="line">  `duration` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰&#x27;</span>,</span><br><span class="line">  `play_count` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æ’­æ”¾æ•°é‡&#x27;</span>,</span><br><span class="line">  `like_count` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ç‚¹èµæ•°é‡&#x27;</span>,</span><br><span class="line">  `danmu_count` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;å¼¹å¹•æ•°é‡&#x27;</span>,</span><br><span class="line">  `comment_count` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;è¯„è®ºæ•°é‡&#x27;</span>,</span><br><span class="line">  `coin_count` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æŠ•å¸æ•°é‡&#x27;</span>,</span><br><span class="line">  `collect_count` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æ”¶è—æ•°é‡&#x27;</span>,</span><br><span class="line">  `recommend_type` tinyint(<span class="number">1</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æ˜¯å¦æ¨è0:æœªæ¨è  1:å·²æ¨è&#x27;</span>,</span><br><span class="line">  `last_play_time` datetime <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æœ€åæ’­æ”¾æ—¶é—´&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (`video_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_create_time`(`create_time`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_user_id`(`user_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_category_id`(`category_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_pcategory_id`(`p_category_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_recommend_type`(`recommend_type`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_last_update_time`(`last_play_time`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE = InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4 <span class="keyword">COLLATE</span> = utf8mb4_general_ci <span class="keyword">COMMENT</span> = <span class="string">&#x27;è§†é¢‘ä¿¡æ¯&#x27;</span> ROW_FORMAT = DYNAMIC;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for video_info_file</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> `video_info_file`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `video_info_file`  (</span><br><span class="line">  `file_id` <span class="type">varchar</span>(<span class="number">20</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;å”¯ä¸€ID&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ç”¨æˆ·ID&#x27;</span>,</span><br><span class="line">  `video_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;è§†é¢‘ID&#x27;</span>,</span><br><span class="line">  `file_name` <span class="type">varchar</span>(<span class="number">200</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æ–‡ä»¶å&#x27;</span>,</span><br><span class="line">  `file_index` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æ–‡ä»¶ç´¢å¼•&#x27;</span>,</span><br><span class="line">  `file_size` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æ–‡ä»¶å¤§å°&#x27;</span>,</span><br><span class="line">  `file_path` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æ–‡ä»¶è·¯å¾„&#x27;</span>,</span><br><span class="line">  `duration` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (`file_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_video_id`(`video_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE = InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4 <span class="keyword">COLLATE</span> = utf8mb4_general_ci <span class="keyword">COMMENT</span> = <span class="string">&#x27;è§†é¢‘æ–‡ä»¶ä¿¡æ¯&#x27;</span> ROW_FORMAT = DYNAMIC;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for video_info_file_post</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> `video_info_file_post`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `video_info_file_post`  (</span><br><span class="line">  `file_id` <span class="type">varchar</span>(<span class="number">20</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;å”¯ä¸€ID&#x27;</span>,</span><br><span class="line">  `upload_id` <span class="type">varchar</span>(<span class="number">15</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ä¸Šä¼ ID&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ç”¨æˆ·ID&#x27;</span>,</span><br><span class="line">  `video_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;è§†é¢‘ID&#x27;</span>,</span><br><span class="line">  `file_index` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æ–‡ä»¶ç´¢å¼•&#x27;</span>,</span><br><span class="line">  `file_name` <span class="type">varchar</span>(<span class="number">200</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æ–‡ä»¶å&#x27;</span>,</span><br><span class="line">  `file_size` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æ–‡ä»¶å¤§å°&#x27;</span>,</span><br><span class="line">  `file_path` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æ–‡ä»¶è·¯å¾„&#x27;</span>,</span><br><span class="line">  `update_type` tinyint(<span class="number">4</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;0:æ— æ›´æ–° 1:æœ‰æ›´æ–°&#x27;</span>,</span><br><span class="line">  `transfer_result` tinyint(<span class="number">4</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;0:è½¬ç ä¸­ 1:è½¬ç æˆåŠŸ 2:è½¬ç å¤±è´¥&#x27;</span>,</span><br><span class="line">  `duration` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (`file_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> `idx_key_upload_id`(`upload_id`, `user_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_video_id`(`video_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE = InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4 <span class="keyword">COLLATE</span> = utf8mb4_general_ci <span class="keyword">COMMENT</span> = <span class="string">&#x27;è§†é¢‘æ–‡ä»¶ä¿¡æ¯&#x27;</span> ROW_FORMAT = DYNAMIC;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for video_info_post</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> `video_info_post`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `video_info_post`  (</span><br><span class="line">  `video_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;è§†é¢‘ID&#x27;</span>,</span><br><span class="line">  `video_cover` <span class="type">varchar</span>(<span class="number">50</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;è§†é¢‘å°é¢&#x27;</span>,</span><br><span class="line">  `video_name` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;è§†é¢‘åç§°&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ç”¨æˆ·ID&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;åˆ›å»ºæ—¶é—´&#x27;</span>,</span><br><span class="line">  `last_update_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æœ€åæ›´æ–°æ—¶é—´&#x27;</span>,</span><br><span class="line">  `p_category_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;çˆ¶çº§åˆ†ç±»ID&#x27;</span>,</span><br><span class="line">  `category_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;åˆ†ç±»ID&#x27;</span>,</span><br><span class="line">  `status` tinyint(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;0:è½¬ç ä¸­ 1è½¬ç å¤±è´¥ 2:å¾…å®¡æ ¸ 3:å®¡æ ¸æˆåŠŸ 4:å®¡æ ¸å¤±è´¥&#x27;</span>,</span><br><span class="line">  `post_type` tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;0:è‡ªåˆ¶ä½œ  1:è½¬è½½&#x27;</span>,</span><br><span class="line">  `origin_info` <span class="type">varchar</span>(<span class="number">200</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;åŸèµ„æºè¯´æ˜&#x27;</span>,</span><br><span class="line">  `tags` <span class="type">varchar</span>(<span class="number">300</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æ ‡ç­¾&#x27;</span>,</span><br><span class="line">  `introduction` <span class="type">varchar</span>(<span class="number">2000</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ç®€ä»‹&#x27;</span>,</span><br><span class="line">  `interaction` <span class="type">varchar</span>(<span class="number">5</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;äº’åŠ¨è®¾ç½®&#x27;</span>,</span><br><span class="line">  `duration` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (`video_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_create_time`(`create_time`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_user_id`(`user_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_category_id`(`category_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_pcategory_id`(`p_category_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE = InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4 <span class="keyword">COLLATE</span> = utf8mb4_general_ci <span class="keyword">COMMENT</span> = <span class="string">&#x27;è§†é¢‘ä¿¡æ¯&#x27;</span> ROW_FORMAT = DYNAMIC;</span><br></pre></td></tr></table></figure>
<p>è¿™å››å¼ è¡¨åˆ†æˆäº† <strong>ä¸¤å¥—ï¼ˆä¸»è¡¨ + å­è¡¨ï¼‰ç»“æ„</strong>ï¼Œåˆ†åˆ«ç”¨äºè§†é¢‘çš„æ­£å¼æ•°æ®å’Œè§†é¢‘çš„æŠ•ç¨¿è¿‡ç¨‹æ•°æ®ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-898.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-899.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-900.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-901.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-902.png" alt="img"></p>
<h3 id="2-æ–‡ä»¶é¢„ä¸Šä¼ ">2.æ–‡ä»¶é¢„ä¸Šä¼ </h3>
<p><strong>é¢„ä¸Šä¼ </strong>ï¼ˆå¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ çš„å»ºæ¡£æ­¥éª¤ï¼‰</p>
<p><strong>é¢„ä¸Šä¼ </strong>æ˜¯åˆ†ç‰‡ä¸Šä¼ çš„ç¬¬ 0 æ­¥ï¼š<br>
åœ¨çœŸæ­£ä¼ ç¬¬ 1 ç‰‡æ•°æ®ä¹‹å‰ï¼Œ<strong>å…ˆåœ¨æœåŠ¡ç«¯ç™»è®°æœ¬æ¬¡ä¸Šä¼ çš„ä¿¡æ¯</strong>ï¼ˆæ–‡ä»¶åã€æ€»åˆ†ç‰‡æ•°ã€ä¸´æ—¶å­˜å‚¨è·¯å¾„ç­‰ï¼‰ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ª <strong><code>uploadId</code></strong> ä½œä¸ºè¿™æ¬¡ä¸Šä¼ ä¼šè¯çš„å”¯ä¸€æ ‡è¯†ã€‚åç»­æ¯ä¸ªåˆ†ç‰‡éƒ½ä¼šå¸¦ç€ <code>uploadId</code> æ¥å¯¹é½è¿›åº¦ã€‚</p>
<p>åœ¨webç«¯çš„FileControllerä¸­,åŠ ä¸Šé¢„ä¸Šä¼ æ¥å£</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ä¸Šä¼ è§†é¢‘æ–‡ä»¶å‰ï¼Œå…ˆä¿å­˜æ–‡ä»¶åå’Œåˆ†ç‰‡æ•°é‡</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> <span class="variable">fileName</span></span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> <span class="variable">chunks</span></span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@RequestMapping</span>(<span class="string">&quot;/preUploadVideo&quot;</span>)</span><br><span class="line">   <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">preUploadVideo</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="title class_">String</span> fileName, <span class="meta">@NotNull</span> <span class="title class_">Integer</span> chunks</span>) &#123;</span><br><span class="line">       <span class="title class_">TokenUserInfoDto</span> tokenUserInfoDto = <span class="title function_">getTokenUserInfoDto</span>();</span><br><span class="line">       <span class="title class_">String</span> uploadId = redisComponent.<span class="title function_">savePreVideoFileInfo</span>(tokenUserInfoDto.<span class="title function_">getUserId</span>(), fileName, chunks);</span><br><span class="line">       <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(uploadId);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-903-1024x859.png" alt="img"></p>
<p>RedisComponentå®šä¹‰savePreVideoFileInfo</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¿å­˜ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> <span class="variable">fileName</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> <span class="variable">chunks</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">savePreVideoFileInfo</span>(<span class="params"><span class="title class_">String</span> userId, <span class="title class_">String</span> fileName, <span class="title class_">Integer</span> chunks</span>) &#123;</span><br><span class="line">        <span class="title class_">String</span> uploadId = <span class="title class_">StringTools</span>.<span class="title function_">getRandomString</span>(<span class="title class_">Constants</span>.<span class="property">LENGTH_15</span>);</span><br><span class="line">        <span class="title class_">UploadingFileDto</span> fileDto = <span class="keyword">new</span> <span class="title class_">UploadingFileDto</span>();</span><br><span class="line">        fileDto.<span class="title function_">setChunks</span>(chunks);</span><br><span class="line">        fileDto.<span class="title function_">setFileName</span>(fileName);</span><br><span class="line">        fileDto.<span class="title function_">setUploadId</span>(uploadId);</span><br><span class="line">        fileDto.<span class="title function_">setChunkIndex</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">String</span> day = <span class="title class_">DateUtil</span>.<span class="title function_">format</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(), <span class="title class_">DateTimePatternEnum</span>.<span class="property">YYYYMMDD</span>.<span class="title function_">getPattern</span>());</span><br><span class="line">        <span class="title class_">String</span> filePath = day + <span class="string">&quot;/&quot;</span> + userId + uploadId;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">String</span> folder = appConfig.<span class="title function_">getProjectFolder</span>() + <span class="title class_">Constants</span>.<span class="property">FILE_FOLDER</span> + <span class="title class_">Constants</span>.<span class="property">FILE_FOLDER_TEMP</span> + filePath;</span><br><span class="line">        <span class="title class_">File</span> folderFile = <span class="keyword">new</span> <span class="title class_">File</span>(folder);</span><br><span class="line">        <span class="keyword">if</span> (!folderFile.<span class="title function_">exists</span>()) &#123;</span><br><span class="line">            folderFile.<span class="title function_">mkdirs</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        fileDto.<span class="title function_">setFilePath</span>(filePath);</span><br><span class="line">        redisUtils.<span class="title function_">setex</span>(<span class="title class_">Constants</span>.<span class="property">REDIS_KEY_UPLOADING_FILE</span> + userId + uploadId, fileDto, <span class="title class_">Constants</span>.<span class="property">REDIS_KEY_EXPIRES_DAY</span>);</span><br><span class="line">        <span class="keyword">return</span> uploadId;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>RedisComponentï¼šç”Ÿæˆä¼šè¯ &amp; å»ºç«‹ä¸´æ—¶ç›®å½• &amp; å†™å…¥ Redisï¼ˆå¸¦ TTLï¼‰</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-904-811x1024.png" alt="img"></p>
<p><strong>è¦ç‚¹è§£é‡Š</strong></p>
<ul>
<li><strong><code>uploadId</code></strong>ï¼šæœ¬æ¬¡åˆ†ç‰‡ä¸Šä¼ çš„ä¼šè¯æ ‡è¯†ï¼Œä¿è¯å¹¶å‘/å¤šæ–‡ä»¶äº’ä¸å¹²æ‰°ã€‚</li>
<li><strong><code>filePath</code></strong>ï¼šä¸ºæœ¬æ¬¡ä¼šè¯åˆ›å»ºçš„<strong>ä¸´æ—¶ç›®å½•</strong>ï¼ˆåˆ†ç‰‡ä¼šè½åœ¨è¿™é‡Œï¼Œæœ€ååˆå¹¶ï¼‰ã€‚</li>
<li><strong>Redis TTL</strong>ï¼š<code>setex(..., 1å¤©)</code> é˜²æ­¢é•¿æ—¶é—´æœªå®Œæˆçš„ä¼šè¯é•¿æœŸå ç”¨å†…å­˜/ç£ç›˜ã€‚</li>
</ul>
<p>éœ€è¦UploadingFileDtoï¼Œå’ŒConstantsé‡Œçš„ä¸¤ä¸ªå˜é‡</p>
<p><strong>DTOï¼š*<em>UploadingFileDto*</em>ï¼ˆä¼šè¯çŠ¶æ€ï¼‰</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">dto</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.<span class="property">fasterxml</span>.<span class="property">jackson</span>.<span class="property">annotation</span>.<span class="property">JsonIgnoreProperties</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">Serializable</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@JsonIgnoreProperties</span>(ignoreUnknown = <span class="literal">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadingFileDto</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> uploadId;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> fileName;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> chunkIndex;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> chunks;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Long</span> fileSize = 0L;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> filePath;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Long</span> <span class="title function_">getFileSize</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> fileSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setFileSize</span>(<span class="params"><span class="title class_">Long</span> fileSize</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">fileSize</span> = fileSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getUploadId</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> uploadId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setUploadId</span>(<span class="params"><span class="title class_">String</span> uploadId</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">uploadId</span> = uploadId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getFileName</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> fileName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setFileName</span>(<span class="params"><span class="title class_">String</span> fileName</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">fileName</span> = fileName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getChunkIndex</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> chunkIndex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setChunkIndex</span>(<span class="params"><span class="title class_">Integer</span> chunkIndex</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">chunkIndex</span> = chunkIndex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getChunks</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> chunks;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setChunks</span>(<span class="params"><span class="title class_">Integer</span> chunks</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">chunks</span> = chunks;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getFilePath</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> filePath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setFilePath</span>(<span class="params"><span class="title class_">String</span> filePath</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">filePath</span> = filePath;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-905.png" alt="img"></p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿‡æœŸæ—¶é—´ 1å¤©</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> Integer REDIS_KEY_EXPIRES_DAY = REDIS_KEY_EXPIRES_ONE_MIN * <span class="number">60</span> * <span class="number">24</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//ä¸Šä¼ ä¸­çš„æ–‡ä»¶å‰ç¼€</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">String</span> REDIS_KEY_UPLOADING_FILE = REDIS_KEY_PREFIX+<span class="string">&quot;uploading :&quot;</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-906.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-907.png" alt="img"></p>
<p><strong>ä¸€å¥è¯æ€»ç»“</strong>ï¼š<br>
è¿™å¥—â€œé¢„ä¸Šä¼ â€æ˜¯åœ¨çœŸæ­£å†™åˆ†ç‰‡ä¹‹å‰ï¼ŒæŠŠ<strong>ä¼šè¯ã€ä¸´æ—¶è·¯å¾„ã€åˆ†ç‰‡æ€»æ•°</strong>æ³¨å†Œåˆ° Redisï¼Œå¹¶è¿”å› <code>uploadId</code> ä½œä¸ºåç»­æ‰€æœ‰åˆ†ç‰‡çš„â€œèº«ä»½è¯â€ã€‚å®ƒæ—¢èƒ½åš<strong>æ–­ç‚¹ç»­ä¼ </strong>ã€<strong>é¡ºåºæ§åˆ¶</strong>ï¼Œè¿˜èƒ½æ”¯æ’‘<strong>å¤§æ–‡ä»¶</strong>ä¸<strong>å¹¶å‘</strong>ä¸Šä¼ çš„å¯è§‚æµ‹æ€§å’Œå®¹é”™æ€§ã€‚</p>
<h3 id="3-è§†é¢‘ä¸Šä¼ ">3.è§†é¢‘ä¸Šä¼ </h3>
<p>å‰ç«¯å¸¦ç€ <code>uploadId + chunkIndex + chunkFile</code> è°ƒ <code>/file/uploadVideo</code> â†’ æœåŠ¡ç«¯æ ¡éªŒ<strong>ä¼šè¯</strong>ä¸<strong>åˆ†ç‰‡åº</strong>ã€<strong>å¤§å°é™åˆ¶</strong> â†’ æŠŠè¯¥åˆ†ç‰‡è½åˆ°<strong>ä¸´æ—¶ç›®å½•</strong>ä¸­ä»¥ <code>chunkIndex</code> å‘½åçš„æ–‡ä»¶é‡Œ â†’ åœ¨ Redis é‡Œæ›´æ–°æœ¬æ¬¡ä¼šè¯çš„<strong>å·²ä¸Šä¼ åˆ†ç‰‡å·</strong>ä¸<strong>ç´¯è®¡å­—èŠ‚æ•°</strong>ï¼ˆå¹¶åˆ·æ–° TTLï¼‰ã€‚</p>
<p>FileController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@RequestMapping(&quot;/uploadVideo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseVO <span class="title function_">uploadVideo</span><span class="params">(<span class="meta">@NotNull</span> MultipartFile chunkFile,</span></span><br><span class="line"><span class="params">                              <span class="meta">@NotNull</span> Integer chunkIndex,</span></span><br><span class="line"><span class="params">                              <span class="meta">@NotEmpty</span> String uploadId)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 1) ä»ç™»å½•æ€æ‹¿ userIdï¼ˆé˜²æ­¢å‰ç«¯ä¼ªé€ ï¼‰</span></span><br><span class="line">    <span class="type">TokenUserInfoDto</span> <span class="variable">tokenUserInfoDto</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) è¯»æœ¬æ¬¡ä¸Šä¼ ä¼šè¯ï¼ˆé¢„ä¸Šä¼ æ—¶æ”¾è¿›äº† Redisï¼‰</span></span><br><span class="line">    <span class="type">UploadingFileDto</span> <span class="variable">fileDto</span> <span class="operator">=</span> redisComponent.getUploadingVideoFile(</span><br><span class="line">            tokenUserInfoDto.getUserId(), uploadId);</span><br><span class="line">    <span class="keyword">if</span> (fileDto == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ä¼šè¯ä¸å­˜åœ¨æˆ–è¿‡æœŸ</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;æ–‡ä»¶ä¸å­˜åœ¨è¯·é‡æ–°ä¸Šä¼ &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) è¯»ç³»ç»Ÿè®¾ç½®ï¼ˆè§†é¢‘å¤§å°é™åˆ¶ç­‰ï¼‰</span></span><br><span class="line">    <span class="type">SysSettingDto</span> <span class="variable">sysSettingDto</span> <span class="operator">=</span> redisComponent.getSysSettingDto();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) å¤§å°æ ¡éªŒï¼ˆå½“å‰å®ç°ï¼šåªæ‹¿â€œå·²ä¸Šä¼ å­—èŠ‚æ•°â€å¯¹æ¯”ä¸Šé™ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (fileDto.getFileSize() &gt; sysSettingDto.getVideoSize() * Constants.MB_SIZE) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;æ–‡ä»¶è¶…è¿‡æœ€å¤§æ–‡ä»¶é™åˆ¶&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5) åˆ†ç‰‡åºæ ¡éªŒï¼š</span></span><br><span class="line">    <span class="comment">//    a. (chunkIndex - 1) &gt; å½“å‰å·²ç¡®è®¤çš„åˆ†ç‰‡å·  -&gt; ç¦æ­¢â€œè·³ç€ä¼ â€ï¼ˆå¼ºåˆ¶é¡ºåºä¸Šä¼ ï¼Œä»…å…è®¸é‡ä¼ å½“å‰æˆ–ä¸Šä¼ ä¸‹ä¸€ç‰‡ï¼‰</span></span><br><span class="line">    <span class="comment">//    b. chunkIndex &gt; æ€»åˆ†ç‰‡æ•° - 1            -&gt; è¶Šç•Œ</span></span><br><span class="line">    <span class="keyword">if</span> ((chunkIndex - <span class="number">1</span>) &gt; fileDto.getChunkIndex()</span><br><span class="line">            || chunkIndex &gt; fileDto.getChunks() - <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6) è®¡ç®—ä¸´æ—¶ç›®å½•ï¼ˆé¢„ä¸Šä¼ æ—¶å·²ç»ç”Ÿæˆ fileDto.filePathï¼‰</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">folder</span> <span class="operator">=</span> appConfig.getProjectFolder()</span><br><span class="line">            + Constants.FILE_FOLDER</span><br><span class="line">            + Constants.FILE_FOLDER_TEMP</span><br><span class="line">            + fileDto.getFilePath();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 7) ä»¥ â€œ&#123;chunkIndex&#125;â€ å‘½åè¯¥åˆ†ç‰‡çš„è½ç›˜æ–‡ä»¶</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">targetFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(folder + <span class="string">&quot;/&quot;</span> + chunkIndex);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 8) ç¡®ä¿ç›®å½•å­˜åœ¨</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">parentFile</span> <span class="operator">=</span> targetFile.getParentFile();</span><br><span class="line">    <span class="keyword">if</span> (!parentFile.exists()) &#123;</span><br><span class="line">        parentFile.mkdirs();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 9) æŠŠåˆ†ç‰‡å†™å…¥ç£ç›˜ï¼ˆæ”¯æŒé‡ä¼ ï¼šåŒåæ–‡ä»¶ä¼šè¦†ç›–ï¼‰</span></span><br><span class="line">    chunkFile.transferTo(targetFile);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 10) è®°å½•å·²ä¸Šä¼ åˆ°çš„åˆ†ç‰‡åºå·ï¼ˆå½“å‰ç­–ç•¥ï¼šæŠŠä¼šè¯è¿›åº¦ç›´æ¥è®¾ä¸ºè¿™æ¬¡çš„ chunkIndexï¼‰</span></span><br><span class="line">    fileDto.setChunkIndex(chunkIndex);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 11) ç´¯åŠ å·²ä¸Šä¼ å­—èŠ‚æ•°ï¼ˆç”¨äºå…¨å±€å¤§å°é™åˆ¶ä¸è¿›åº¦ç»Ÿè®¡ï¼‰</span></span><br><span class="line">    fileDto.setFileSize(fileDto.getFileSize() + chunkFile.getSize());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 12) åˆ·æ–° Redis ä¼šè¯ï¼ˆå¸¦ TTLï¼Œé»˜è®¤ 1 å¤©ï¼‰</span></span><br><span class="line">    redisComponent.updateVideoFileInfo(tokenUserInfoDto.getUserId(), fileDto);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> getSuccessResponseVO(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è¦ç‚¹å›é¡¾</strong></p>
<ul>
<li><strong>é¡ºåºæ§åˆ¶</strong>ï¼šä¸å…è®¸â€œè·³ç‰‡â€ä¸Šä¼ ï¼Œåªèƒ½é‡ä¼ å½“å‰æˆ–ä¼ ä¸‹ä¸€ç‰‡ã€‚</li>
<li><strong>ä¼šè¯è¿›åº¦</strong>ï¼š<code>chunkIndex</code> å­˜åœ¨ <code>fileDto</code> é‡Œï¼Œç”¨äºä¸‹ä¸€æ¬¡æ ¡éªŒâ€œæ˜¯å¦è·³ç‰‡â€ã€‚</li>
<li><strong>ä¸´æ—¶ç›®å½•</strong>ï¼šç”±â€œé¢„ä¸Šä¼ â€é˜¶æ®µç”Ÿæˆçš„ <code>filePath</code> å†³å®šï¼ˆå½¢å¦‚ <code>yyyyMMdd/&#123;userId&#125;/&#123;uploadId&#125;</code>ï¼‰ã€‚</li>
<li><strong>å¹‚ç­‰æ€§</strong>ï¼šå…è®¸â€œåŒä¸€åˆ†ç‰‡é‡ä¼ â€ï¼Œè¦†ç›–å†™å…¥å³å¯ã€‚</li>
</ul>
<p>RedisCompoent</p>
<p>Redis ç»„ä»¶ï¼šè¯»/å†™ä¼šè¯ &amp; è¯»ç³»ç»Ÿè®¾ç½®</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 1) è¯»ä¼šè¯ï¼šæŒ‰ &quot;uploading&quot; å‰ç¼€ + userId + uploadId æ‹¿åˆ° UploadingFileDto</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">UploadingFileDto</span> <span class="title function_">getUploadingVideoFile</span>(<span class="params"><span class="title class_">String</span> userId, <span class="title class_">String</span> uploadId</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="title class_">UploadingFileDto</span>) redisUtils.<span class="title function_">get</span>(</span><br><span class="line">            <span class="title class_">Constants</span>.<span class="property">REDIS_KEY_UPLOADING_FILE</span> + userId + uploadId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2) è¯»ç³»ç»Ÿè®¾ç½®ï¼šæœªé…ç½®åˆ™ç»™é»˜è®¤å¯¹è±¡ï¼ˆå«è§†é¢‘å¤§å°ä¸Šé™ç­‰ï¼‰</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">SysSettingDto</span> <span class="title function_">getSysSettingDto</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">SysSettingDto</span> sysSettingDto = (<span class="title class_">SysSettingDto</span>) redisUtils.<span class="title function_">get</span>(<span class="title class_">Constants</span>.<span class="property">REDIS_KEY_SYS_SETTING</span>);</span><br><span class="line">    <span class="keyword">if</span> (sysSettingDto == <span class="literal">null</span>) &#123;</span><br><span class="line">        sysSettingDto = <span class="keyword">new</span> <span class="title class_">SysSettingDto</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sysSettingDto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3) æ›´æ–°ä¼šè¯å¹¶æ»‘åŠ¨è¿‡æœŸï¼ˆç»­æœŸ 1 å¤©ï¼‰</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">updateVideoFileInfo</span>(<span class="params"><span class="title class_">String</span> userId, <span class="title class_">UploadingFileDto</span> fileDto</span>) &#123;</span><br><span class="line">    redisUtils.<span class="title function_">setex</span>(<span class="title class_">Constants</span>.<span class="property">REDIS_KEY_UPLOADING_FILE</span> + userId + fileDto.<span class="title function_">getUploadId</span>(),</span><br><span class="line">                     fileDto,</span><br><span class="line">                     <span class="title class_">Constants</span>.<span class="property">REDIS_KEY_EXPIRES_DAY</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ä¼šè¯é”®</strong>ï¼š<code>uploading:&lt;userId&gt;&lt;uploadId&gt;</code>ï¼ˆä½ ä»£ç é‡Œæ˜¯ç›´æ¥æ‹¼æ¥ï¼Œå»ºè®®ä¸­é—´åŠ å†’å·æ›´æ¸…æ™°ï¼‰ã€‚</p>
<p><strong>æ»‘åŠ¨è¿‡æœŸ</strong>ï¼šæ¯ä¸Šä¼ ä¸€ç‰‡éƒ½ä¼š <code>setex</code> ä¸€æ¬¡ï¼ŒTTL ç»­æœŸï¼Œé¿å…é•¿è§†é¢‘ä¸­é€”è¿‡æœŸã€‚</p>
<p>SysSetSysSettingDtoï¼šåå°å¯æ§é˜ˆå€¼</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">dto</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.<span class="property">fasterxml</span>.<span class="property">jackson</span>.<span class="property">annotation</span>.<span class="property">JsonIgnoreProperties</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">Serializable</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@JsonIgnoreProperties</span>(ignoreUnknown = <span class="literal">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SysSettingDto</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> registerCoinCount = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> postVideoCoinCount = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> videoSize = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> videoPCount = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> videoCount = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> commentCount = <span class="number">20</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> danmuCount = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getVideoSize</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> videoSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setVideoSize</span>(<span class="params"><span class="title class_">Integer</span> videoSize</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">videoSize</span> = videoSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getVideoPCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> videoPCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setVideoPCount</span>(<span class="params"><span class="title class_">Integer</span> videoPCount</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">videoPCount</span> = videoPCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getVideoCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> videoCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setVideoCount</span>(<span class="params"><span class="title class_">Integer</span> videoCount</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">videoCount</span> = videoCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getCommentCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> commentCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setCommentCount</span>(<span class="params"><span class="title class_">Integer</span> commentCount</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">commentCount</span> = commentCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getDanmuCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> danmuCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setDanmuCount</span>(<span class="params"><span class="title class_">Integer</span> danmuCount</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">danmuCount</span> = danmuCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getRegisterCoinCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> registerCoinCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setRegisterCoinCount</span>(<span class="params"><span class="title class_">Integer</span> registerCoinCount</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">registerCoinCount</span> = registerCoinCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getPostVideoCoinCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> postVideoCoinCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setPostVideoCoinCount</span>(<span class="params"><span class="title class_">Integer</span> postVideoCoinCount</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">postVideoCoinCount</span> = postVideoCoinCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-910.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-908-1024x404.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-911.png" alt="img"></p>
<p>æ”¹è¿›ç‰ˆ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/uploadVideo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseVO <span class="title function_">uploadVideo</span><span class="params">(<span class="meta">@NotNull</span> MultipartFile chunkFile,</span></span><br><span class="line"><span class="params">                              <span class="meta">@NotNull</span> Integer chunkIndex,</span></span><br><span class="line"><span class="params">                              <span class="meta">@NotEmpty</span> String uploadId)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">TokenUserInfoDto</span> <span class="variable">user</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line">    <span class="type">UploadingFileDto</span> <span class="variable">dto</span> <span class="operator">=</span> redisComponent.getUploadingVideoFile(user.getUserId(), uploadId);</span><br><span class="line">    <span class="keyword">if</span> (dto == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;æ–‡ä»¶ä¸å­˜åœ¨è¯·é‡æ–°ä¸Šä¼ &quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">SysSettingDto</span> <span class="variable">st</span> <span class="operator">=</span> redisComponent.getSysSettingDto();</span><br><span class="line">    <span class="type">long</span> <span class="variable">limit</span> <span class="operator">=</span> (<span class="type">long</span>) st.getVideoSize() * Constants.MB_SIZE;</span><br><span class="line">    <span class="comment">// å¤§å°æ ¡éªŒï¼šåŒ…å«æœ¬æ¬¡åˆ†ç‰‡</span></span><br><span class="line">    <span class="keyword">if</span> (dto.getFileSize() + chunkFile.getSize() &gt; limit) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;æ–‡ä»¶è¶…è¿‡æœ€å¤§æ–‡ä»¶é™åˆ¶&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç´¢å¼•æ ¡éªŒï¼š0 &lt;= idx &lt; chunksï¼Œä¸”ä¸èƒ½â€œè·³ç‰‡â€</span></span><br><span class="line">    <span class="keyword">if</span> (chunkIndex &lt; <span class="number">0</span> || chunkIndex &gt;= dto.getChunks()</span><br><span class="line">            || (chunkIndex - <span class="number">1</span>) &gt; dto.getChunkIndex()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">folder</span> <span class="operator">=</span> appConfig.getProjectFolder()</span><br><span class="line">            + Constants.FILE_FOLDER + Constants.FILE_FOLDER_TEMP + dto.getFilePath();</span><br><span class="line">    <span class="type">File</span> <span class="variable">target</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(folder, String.valueOf(chunkIndex));</span><br><span class="line">    target.getParentFile().mkdirs();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¦†ç›–å†™å…¥ï¼Œæ”¯æŒé‡ä¼ è¯¥åˆ†ç‰‡</span></span><br><span class="line">    chunkFile.transferTo(target);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿›åº¦ä¸å­—èŠ‚æ•°ï¼ˆå¹¶å‘åœºæ™¯å– maxï¼Œé¿å…å›é€€ï¼‰</span></span><br><span class="line">    dto.setChunkIndex(Math.max(dto.getChunkIndex(), chunkIndex));</span><br><span class="line">    dto.setFileSize(dto.getFileSize() + chunkFile.getSize());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ»‘åŠ¨è¿‡æœŸ</span></span><br><span class="line">    redisComponent.updateVideoFileInfo(user.getUserId(), dto);</span><br><span class="line">    <span class="keyword">return</span> getSuccessResponseVO(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-åˆ é™¤ä¸Šä¼ çš„è§†é¢‘">4.åˆ é™¤ä¸Šä¼ çš„è§†é¢‘</h3>
<p>Controller å±‚é€»è¾‘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/delUploadVideo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseVO <span class="title function_">delUploadVideo</span><span class="params">(<span class="meta">@NotEmpty</span> String uploadId)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 1. è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼ˆä» Token ä¸­è§£æï¼‰</span></span><br><span class="line">    <span class="type">TokenUserInfoDto</span> <span class="variable">tokenUserInfoDto</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. ä» Redis ä¸­è·å–è¯¥ç”¨æˆ·å¯¹åº” uploadId çš„ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯</span></span><br><span class="line">    <span class="type">UploadingFileDto</span> <span class="variable">fileDto</span> <span class="operator">=</span> redisComponent.getUploadingVideoFile(tokenUserInfoDto.getUserId(), uploadId);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. å¦‚æœ Redis ä¸­æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶ä¿¡æ¯ï¼Œè¯´æ˜æ–‡ä»¶ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤</span></span><br><span class="line">    <span class="keyword">if</span> (fileDto == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;æ–‡ä»¶ä¸å­˜åœ¨è¯·é‡æ–°ä¸Šä¼ &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. ä» Redis åˆ é™¤è¯¥ä¸Šä¼ æ–‡ä»¶çš„è®°å½•</span></span><br><span class="line">    redisComponent.delVideoFileInfo(tokenUserInfoDto.getUserId(), uploadId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. åˆ é™¤æœ¬åœ°ä¸´æ—¶æ–‡ä»¶å¤¹ï¼ˆè§†é¢‘æ–‡ä»¶ç‰‡æ®µç­‰ï¼‰</span></span><br><span class="line">    FileUtils.deleteDirectory(<span class="keyword">new</span> <span class="title class_">File</span>(</span><br><span class="line">        appConfig.getProjectFolder() + Constants.FILE_FOLDER + Constants.FILE_FOLDER_TEMP + fileDto.getFilePath()</span><br><span class="line">    ));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6. è¿”å›åˆ é™¤æˆåŠŸçš„å“åº”</span></span><br><span class="line">    <span class="keyword">return</span> getSuccessResponseVO(uploadId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RedisComponent é€»è¾‘</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">delVideoFileInfo</span>(<span class="params"><span class="title class_">String</span> userId, <span class="title class_">String</span> uploadId</span>) &#123;</span><br><span class="line">    <span class="comment">// åˆ é™¤ Redis ä¸­å­˜å‚¨çš„è¯¥æ–‡ä»¶çš„ä¸Šä¼ è¿›åº¦/ä¿¡æ¯</span></span><br><span class="line">    redisUtils.<span class="title function_">delete</span>(<span class="title class_">Constants</span>.<span class="property">REDIS_KEY_UPLOADING_FILE</span> + userId + uploadId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-912.png" alt="img"></p>
<h3 id="5-è·å–ç³»ç»Ÿè®¾ç½®">5.è·å–ç³»ç»Ÿè®¾ç½®</h3>
<p>åŠ SysSettingController</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.web.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.easylive.component.RedisComponent;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.vo.ResponseVO;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.<span class="keyword">annotation</span>.Validated;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController(<span class="string">&quot;sysSettingController&quot;</span>)</span></span><br><span class="line"><span class="meta">@RequestMapping(<span class="string">&quot;/sysSetting&quot;</span>)</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SysSettingController</span> <span class="title">extends</span> <span class="title">ABaseController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisComponent redisComponent;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = <span class="string">&quot;/getSetting&quot;</span>)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ResponseVO getSetting() &#123;</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(redisComponent.getSysSettingDto());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-914.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-913-1024x542.png" alt="img"></p>
<h3 id="6-æŠ•ç¨¿ä¸­çš„uploadImage">6.æŠ•ç¨¿ä¸­çš„uploadImage</h3>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-915-1024x600.png" alt="img"></p>
<p>è¿™ä¸ªæ¥å£åœ¨adminç«¯ä¸­å†™è¿‡ç›´æ¥æ‹·è´è¿‡æ¥å³å¯</p>
<p>å¦‚å›¾è¿™ä¸ªæ¥å£æˆåŠŸäº†</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-916-1024x421.png" alt="img"></p>
<h3 id="7-å‘å¸ƒè§†é¢‘">7.å‘å¸ƒè§†é¢‘</h3>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-917-1024x454.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-920.png" alt="img"></p>
<p>åˆ›å»ºJsonUtils</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">easylive</span>.<span class="property">utils</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.<span class="property">alibaba</span>.<span class="property">fastjson</span>.<span class="property">JSON</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">alibaba</span>.<span class="property">fastjson</span>.<span class="property">JSONArray</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">alibaba</span>.<span class="property">fastjson</span>.<span class="property">JSONObject</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">slf4j</span>.<span class="property">Logger</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">slf4j</span>.<span class="property">LoggerFactory</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">List</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JsonUtils</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> final <span class="title class_">Logger</span> logger = <span class="title class_">LoggerFactory</span>.<span class="title function_">getLogger</span>(<span class="title class_">JsonUtils</span>.<span class="property">class</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="title class_">String</span> <span class="title function_">convertObj2Json</span>(<span class="params"><span class="title class_">Object</span> obj</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">JSON</span>.<span class="title function_">toJSONString</span>(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">convertJson2Obj</span>(<span class="params"><span class="title class_">String</span> json, <span class="title class_">Class</span>&lt;T&gt; classz</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">JSON</span><span class="built_in">Object</span>.<span class="title function_">parseObject</span>(json, classz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="title class_">List</span>&lt;T&gt; <span class="title function_">convertJsonArray2List</span>(<span class="params"><span class="title class_">String</span> json, <span class="title class_">Class</span>&lt;T&gt; classz</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">JSON</span><span class="built_in">Array</span>.<span class="title function_">parseArray</span>(json, classz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="title function_">main</span>(<span class="params"><span class="title class_">String</span>[] args</span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºUCenterVideoPostController  ç”¨æˆ·ä¸­å¿ƒå‘å¸ƒè§†é¢‘Controllerã€‚</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.web.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.dto.TokenUserInfoDto;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.po.VideoInfoFilePost;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.po.VideoInfoPost;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.vo.ResponseVO;</span><br><span class="line"><span class="keyword">import</span> com.easylive.service.VideoInfoFilePostService;</span><br><span class="line"><span class="keyword">import</span> com.easylive.service.VideoInfoPostService;</span><br><span class="line"><span class="keyword">import</span> com.easylive.service.VideoInfoService;</span><br><span class="line"><span class="keyword">import</span> com.easylive.utils.JsonUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.<span class="keyword">annotation</span>.Validated;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.NotEmpty;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.NotNull;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.Size;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="meta">@RequestMapping(<span class="string">&quot;/ucenter&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UCenterVideoPostController</span> <span class="title">extends</span> <span class="title">ABaseController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> VideoInfoPostService videoInfoPostService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> VideoInfoFilePostService videoInfoFilePostService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> VideoInfoService videoInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(<span class="string">&quot;/postVideo&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseVO postVideo(String videoId, <span class="meta">@NotEmpty</span> String videoCover, <span class="meta">@NotEmpty</span> <span class="meta">@Size(max = 100)</span> String videoName, <span class="meta">@NotNull</span> Integer pCategoryId,</span><br><span class="line">                                Integer categoryId, <span class="meta">@NotNull</span> Integer postType, <span class="meta">@NotEmpty</span> <span class="meta">@Size(max = 300)</span> String tags, <span class="meta">@Size(max = 2000)</span> String introduction,</span><br><span class="line">                                <span class="meta">@Size(max = 3)</span> String interaction, <span class="meta">@NotEmpty</span> String uploadFileList) &#123;</span><br><span class="line"></span><br><span class="line">        TokenUserInfoDto tokenUserInfoDto = getTokenUserInfoDto();</span><br><span class="line">        List&lt;VideoInfoFilePost&gt; fileInfoList = JsonUtils.convertJsonArray2List(uploadFileList, VideoInfoFilePost.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">        VideoInfoPost videoInfo = new VideoInfoPost();</span><br><span class="line">        videoInfo.setVideoId(videoId);</span><br><span class="line">        videoInfo.setVideoName(videoName);</span><br><span class="line">        videoInfo.setVideoCover(videoCover);</span><br><span class="line">        videoInfo.setpCategoryId(pCategoryId);</span><br><span class="line">        videoInfo.setCategoryId(categoryId);</span><br><span class="line">        videoInfo.setPostType(postType);</span><br><span class="line">        videoInfo.setTags(tags);</span><br><span class="line">        videoInfo.setIntroduction(introduction);</span><br><span class="line">        videoInfo.setInteraction(interaction);</span><br><span class="line"></span><br><span class="line">        videoInfo.setUserId(tokenUserInfoDto.getUserId());</span><br><span class="line"></span><br><span class="line">        videoInfoPostService.saveVideoInfo(videoInfo, fileInfoList);</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Service</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * ä¿å­˜è§†é¢‘ä¿¡æ¯</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> videoInfo</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> fileInfoList</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">saveVideoInfo</span><span class="params">(VideoInfoPost videoInfo, List&lt;VideoInfoFilePost&gt; fileInfoList)</span></span>;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºVideoStatusEnumï¼Œ VideoFileUpdateTypeEnumï¼ŒVideoFileTransferResultEnum</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">enums</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">VideoStatusEnum</span> &#123;</span><br><span class="line">    <span class="title class_">STATUS0</span>(<span class="number">0</span>, <span class="string">&quot;è½¬ç ä¸­&quot;</span>),</span><br><span class="line">    <span class="title class_">STATUS1</span>(<span class="number">1</span>, <span class="string">&quot;è½¬ç å¤±è´¥&quot;</span>),</span><br><span class="line">    <span class="title class_">STATUS2</span>(<span class="number">2</span>, <span class="string">&quot;å¾…å®¡æ ¸&quot;</span>),</span><br><span class="line">    <span class="title class_">STATUS3</span>(<span class="number">3</span>, <span class="string">&quot;å®¡æ ¸æˆåŠŸ&quot;</span>),</span><br><span class="line">    <span class="title class_">STATUS4</span>(<span class="number">4</span>, <span class="string">&quot;å®¡æ ¸ä¸é€šè¿‡&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> status;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> desc;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">VideoStatusEnum</span>(<span class="title class_">Integer</span> status, <span class="title class_">String</span> desc) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">status</span> = status;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">desc</span> = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getStatus</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getDesc</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="title class_">VideoStatusEnum</span> <span class="title function_">getByStatus</span>(<span class="params"><span class="title class_">Integer</span> status</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="title class_">VideoStatusEnum</span> statusEnum : <span class="title class_">VideoStatusEnum</span>.<span class="title function_">values</span>()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (statusEnum.<span class="title function_">getStatus</span>().<span class="title function_">equals</span>(status)) &#123;</span><br><span class="line">                <span class="keyword">return</span> statusEnum;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">package com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">enums</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">VideoFileUpdateTypeEnum</span> &#123;</span><br><span class="line">    <span class="title function_">NO_UPDATE</span>(<span class="number">0</span>, <span class="string">&quot;æ— æ›´æ–°&quot;</span>),</span><br><span class="line">    <span class="title function_">UPDATE</span>(<span class="number">1</span>, <span class="string">&quot;æœ‰æ›´æ–°&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> status;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> desc;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">VideoFileUpdateTypeEnum</span>(<span class="title class_">Integer</span> status, <span class="title class_">String</span> desc) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">status</span> = status;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">desc</span> = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getStatus</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getDesc</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">package com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">enums</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">VideoFileTransferResultEnum</span> &#123;</span><br><span class="line">    <span class="title function_">TRANSFER</span>(<span class="number">0</span>, <span class="string">&quot;è½¬ç ä¸­&quot;</span>),</span><br><span class="line">    <span class="title function_">SUCCESS</span>(<span class="number">1</span>, <span class="string">&quot;è½¬ç æˆåŠŸ&quot;</span>),</span><br><span class="line">    <span class="title function_">FAIL</span>(<span class="number">2</span>, <span class="string">&quot;è½¬ç å¤±è´¥&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> status;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> desc;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">VideoFileTransferResultEnum</span>(<span class="title class_">Integer</span> status, <span class="title class_">String</span> desc) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">status</span> = status;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">desc</span> = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getStatus</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getDesc</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ConstantsåŠ å…¥ä¸¤ä¸ªå˜é‡</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ–‡ä»¶åˆ é™¤é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">String</span> REDIS_KEY_FILE_DEL = REDIS_KEY_PREFIX + <span class="string">&quot;file:list:del:&quot;</span>;</span><br><span class="line">    <span class="comment">//æ–‡ä»¶è½¬ç é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">String</span> REDIS_KEY_QUEUE_TRANSFER = REDIS_KEY_PREFIX + <span class="string">&quot;queue:transfer:&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>RedisCompoent</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°†éœ€è¦åˆ é™¤çš„æ–‡ä»¶åŠ å…¥é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> <span class="variable">videoId</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> <span class="variable">fileIdList</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">addFile2DelQueue</span>(<span class="params"><span class="title class_">String</span> videoId, <span class="title class_">List</span>&lt;<span class="title class_">String</span>&gt; fileIdList</span>) &#123;</span><br><span class="line">        redisUtils.<span class="title function_">lpushAll</span>(<span class="title class_">Constants</span>.<span class="property">REDIS_KEY_FILE_DEL</span> + videoId, fileIdList, <span class="title class_">Constants</span>.<span class="property">REDIS_KEY_EXPIRES_DAY</span> * <span class="number">7</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å°†éœ€è¦è½¬ç çš„æ–‡ä»¶åŠ å…¥é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> <span class="variable">fileList</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">addFile2TransferQueue</span>(<span class="params"><span class="title class_">List</span>&lt;<span class="title class_">VideoInfoFilePost</span>&gt; fileList</span>) &#123;</span><br><span class="line">        redisUtils.<span class="title function_">lpushAll</span>(<span class="title class_">Constants</span>.<span class="property">REDIS_KEY_QUEUE_TRANSFER</span>, fileList, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>videoInfoFilePostMapperä¸­deleteBatchByFileIdæ–¹æ³•</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * æ‰¹é‡åˆ é™¤æ–‡ä»¶ä¿¡æ¯</span></span><br><span class="line"><span class="comment">	 * @param delFileIdList</span></span><br><span class="line"><span class="comment">	 * @param userId</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="selector-tag">void</span> <span class="selector-tag">deleteBatchByFileId</span>(<span class="variable">@Param</span>(<span class="string">&quot;fileIdList&quot;</span>) List&lt;String&gt; delFileIdList,<span class="variable">@Param</span>(<span class="string">&quot;userId&quot;</span>) String userId);</span><br></pre></td></tr></table></figure>
<p>xmlæ–‡ä»¶</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!--	æ ¹æ®FileIdæ‰¹é‡åˆ é™¤--&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteBatchByFileId&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">		delete from video_info_file_post where file_id in(<span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;fileIdList&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span> <span class="attr">item</span>=<span class="string">&quot;item&quot;</span>&gt;</span>#</span><span class="template-variable">&#123;item&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">foreach</span>&gt;</span>)</span></span><br><span class="line"><span class="language-xml">		and user_id=#</span><span class="template-variable">&#123;userId&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>VideoInfoPostServiceImplä¸­</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-921-1024x962.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-922.png" alt="img"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.easylive.component.RedisComponent;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.constants.Constants;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.enums.VideoFileTransferResultEnum;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.enums.VideoFileUpdateTypeEnum;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.enums.VideoStatusEnum;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.po.VideoInfoFilePost;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.po.VideoInfoPost;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.query.VideoInfoFilePostQuery;</span><br><span class="line"><span class="keyword">import</span> com.easylive.exception.BusinessException;</span><br><span class="line"><span class="keyword">import</span> com.easylive.mappers.VideoInfoFilePostMapper;</span><br><span class="line"><span class="keyword">import</span> com.easylive.mappers.VideoInfoPostMapper;</span><br><span class="line"><span class="keyword">import</span> com.easylive.service.VideoInfoPostService;</span><br><span class="line"><span class="keyword">import</span> com.easylive.utils.StringTools;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.enums.ResponseCodeEnum;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.ArrayUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æŠ•ç¨¿è§†é¢‘ä¿å­˜ &amp; æ›´æ–°å®ç°</span></span><br><span class="line"><span class="comment"> * è´Ÿè´£ï¼šå‚æ•°æ ¡éªŒã€çŠ¶æ€æœºæ§åˆ¶ã€æ–‡ä»¶æ¸…å•å¯¹æ¯”ã€é˜Ÿåˆ—æŠ•é€’ï¼ˆè½¬ç /åˆ é™¤ï¼‰ä¸è½åº“</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VideoInfoPostServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">VideoInfoPostService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> VideoInfoPostMapper videoInfoPostMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> VideoInfoFilePostMapper videoInfoFilePostMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisComponent redisComponent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¿å­˜/æ›´æ–°æŠ•ç¨¿è§†é¢‘ï¼ˆå«æ–‡ä»¶æ¸…å•ï¼‰</span></span><br><span class="line"><span class="comment">     * - æ–°å¢ï¼šåˆ›å»º videoIdï¼ŒçŠ¶æ€=è½¬ç ä¸­(0)</span></span><br><span class="line"><span class="comment">     * - ç¼–è¾‘ï¼šå¯¹æ¯”æ–‡ä»¶æ¸…å•ï¼ˆæ–°å¢/åˆ é™¤/æ”¹åï¼‰ï¼Œå¿…è¦æ—¶ç½®ä¸º å¾…å®¡æ ¸/è½¬ç ä¸­</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveVideoInfo</span><span class="params">(VideoInfoPost videoInfoPost, List&lt;VideoInfoFilePost&gt; uploadFileList)</span> &#123;</span><br><span class="line">        <span class="comment">// ---------- 0. åŸºç¡€é˜²å¾¡ ----------</span></span><br><span class="line">        <span class="keyword">if</span> (uploadFileList == <span class="literal">null</span>) &#123;</span><br><span class="line">            uploadFileList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ---------- 1. åˆ†Pä¸ªæ•°æ ¡éªŒ ----------</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">maxPCount</span> <span class="operator">=</span> redisComponent.getSysSettingDto().getVideoPCount();</span><br><span class="line">        <span class="keyword">if</span> (uploadFileList.size() &gt; maxPCount) &#123;</span><br><span class="line">            <span class="comment">// è¶…è¿‡ç³»ç»Ÿè®¾ç½®çš„å•è§†é¢‘åˆ†Pä¸Šé™</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ---------- 2. ç¼–è¾‘åœºæ™¯çš„çŠ¶æ€çº¦æŸ ----------</span></span><br><span class="line">        <span class="keyword">if</span> (!StringTools.isEmpty(videoInfoPost.getVideoId())) &#123;</span><br><span class="line">            <span class="type">VideoInfoPost</span> <span class="variable">db</span> <span class="operator">=</span> videoInfoPostMapper.selectByVideoId(videoInfoPost.getVideoId());</span><br><span class="line">            <span class="keyword">if</span> (db == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// ä¼ æ¥çš„ videoId ä¸å­˜åœ¨</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ä¸å…è®¸åœ¨ã€Œè½¬ç ä¸­/å¾…å®¡æ ¸ã€æ—¶å†æ¬¡ä¿®æ”¹ï¼Œé¿å…çŠ¶æ€æœºæ··ä¹±</span></span><br><span class="line">            <span class="keyword">if</span> (ArrayUtils.contains(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Integer</span>[]&#123;VideoStatusEnum.STATUS0.getStatus(), VideoStatusEnum.STATUS2.getStatus()&#125;,</span><br><span class="line">                    db.getStatus())) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">videoId</span> <span class="operator">=</span> videoInfoPost.getVideoId();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// éœ€è¦åˆ é™¤çš„æ—§æ–‡ä»¶ï¼ˆä»…ç¼–è¾‘æ—¶å¯èƒ½äº§ç”Ÿï¼‰</span></span><br><span class="line">        List&lt;VideoInfoFilePost&gt; deleteFileList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// éœ€è¦è½¬ç çš„æ–°å¢æ–‡ä»¶ï¼ˆfileId==null è§†ä¸ºæ–°å¢ï¼‰</span></span><br><span class="line">        List&lt;VideoInfoFilePost&gt; addFileList = uploadFileList;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ---------- 3. æ–°å¢ or ç¼–è¾‘ ----------</span></span><br><span class="line">        <span class="keyword">if</span> (StringTools.isEmpty(videoId)) &#123;</span><br><span class="line">            <span class="comment">// &gt;&gt;&gt; æ–°å¢ &lt;&lt;&lt;</span></span><br><span class="line">            videoId = StringTools.getRandomString(Constants.LENGTH_10);</span><br><span class="line">            videoInfoPost.setVideoId(videoId);</span><br><span class="line">            videoInfoPost.setCreateTime(now);</span><br><span class="line">            videoInfoPost.setLastUpdateTime(now);</span><br><span class="line">            <span class="comment">// æ–°å¢ä¸€å®šè¦è½¬ç </span></span><br><span class="line">            videoInfoPost.setStatus(VideoStatusEnum.STATUS0.getStatus());</span><br><span class="line">            videoInfoPostMapper.insert(videoInfoPost);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// &gt;&gt;&gt; ç¼–è¾‘ &lt;&lt;&lt;</span></span><br><span class="line">            <span class="comment">// 3.1 æŸ¥è¯¢ DB å·²å­˜åœ¨çš„æ–‡ä»¶æ¸…å•</span></span><br><span class="line">            <span class="type">VideoInfoFilePostQuery</span> <span class="variable">fileQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoFilePostQuery</span>();</span><br><span class="line">            fileQuery.setVideoId(videoId);</span><br><span class="line">            fileQuery.setUserId(videoInfoPost.getUserId());</span><br><span class="line">            List&lt;VideoInfoFilePost&gt; dbFileList = videoInfoFilePostMapper.selectList(fileQuery);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.2 ä»¥ uploadId ä¸ºé”®ï¼Œæ„é€ â€œå‰ç«¯æœ¬æ¬¡æäº¤çš„æ–‡ä»¶Mapâ€</span></span><br><span class="line">            Map&lt;String, VideoInfoFilePost&gt; uploadFileMap = uploadFileList.stream()</span><br><span class="line">                    .filter(x -&gt; x.getUploadId() != <span class="literal">null</span>)</span><br><span class="line">                    .collect(Collectors.toMap(</span><br><span class="line">                            VideoInfoFilePost::getUploadId,</span><br><span class="line">                            Function.identity(),</span><br><span class="line">                            (a, b) -&gt; b)); <span class="comment">// åŒé”®å–åè€…ï¼Œé¿å…é‡å¤é”®å¼‚å¸¸</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.3 è®¡ç®— â€œåˆ é™¤åˆ—è¡¨â€ &amp; â€œæ˜¯å¦æ”¹åâ€</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">updateFileName</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (VideoInfoFilePost dbFile : dbFileList) &#123;</span><br><span class="line">                <span class="type">VideoInfoFilePost</span> <span class="variable">newOne</span> <span class="operator">=</span> uploadFileMap.get(dbFile.getUploadId());</span><br><span class="line">                <span class="keyword">if</span> (newOne == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// DBæœ‰ï¼Œä½†è¿™æ¬¡æ²¡æäº¤ =&gt; éœ€è¦åˆ é™¤</span></span><br><span class="line">                    deleteFileList.add(dbFile);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!Objects.equals(newOne.getFileName(), dbFile.getFileName())) &#123;</span><br><span class="line">                    <span class="comment">// æ–‡ä»¶åå‘ç”Ÿå˜åŒ–ï¼ˆè§†ä½œâ€œæœ‰å˜æ›´â€ï¼Œå¯èƒ½éœ€è¦å¤å®¡ï¼‰</span></span><br><span class="line">                    updateFileName = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.4 è®¡ç®— â€œæ–°å¢åˆ—è¡¨â€ï¼šæœ¬æ¬¡æäº¤é‡Œ fileId ä¸ºç©ºçš„ï¼Œè§†ä¸ºæ–°æ–‡ä»¶</span></span><br><span class="line">            addFileList = uploadFileList.stream()</span><br><span class="line">                    .filter(item -&gt; item.getFileId() == <span class="literal">null</span>)</span><br><span class="line">                    .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.5 æ›´æ–°è§†é¢‘åŸºæœ¬ä¿¡æ¯çš„æœ€åæ›´æ–°æ—¶é—´</span></span><br><span class="line">            videoInfoPost.setLastUpdateTime(now);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.6 æ˜¯å¦ä»…æ”¹äº†æ–‡æ¡ˆ/æ–‡ä»¶åï¼ˆè€Œæ²¡æœ‰æ–°å¢æ–‡ä»¶ï¼‰</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">changeVideoInfo</span> <span class="operator">=</span> <span class="built_in">this</span>.changeVideoInfo(videoInfoPost); <span class="comment">// å¯¹æ¯” æ ‡é¢˜/å°é¢/æ ‡ç­¾/ç®€ä»‹</span></span><br><span class="line">            <span class="keyword">if</span> (!addFileList.isEmpty()) &#123;</span><br><span class="line">                <span class="comment">// æœ‰æ–°å¢æ–‡ä»¶ =&gt; å¿…é¡»è½¬ç </span></span><br><span class="line">                videoInfoPost.setStatus(VideoStatusEnum.STATUS0.getStatus());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (changeVideoInfo || updateFileName) &#123;</span><br><span class="line">                <span class="comment">// æ— æ–°å¢æ–‡ä»¶ï¼Œä½†è§†é¢‘ä¿¡æ¯/æ–‡ä»¶åæœ‰å˜åŒ– =&gt; è¿›å…¥å¾…å®¡æ ¸</span></span><br><span class="line">                videoInfoPost.setStatus(VideoStatusEnum.STATUS2.getStatus());</span><br><span class="line">            &#125;</span><br><span class="line">            videoInfoPostMapper.updateByVideoId(videoInfoPost, videoInfoPost.getVideoId());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ---------- 4. æ¸…ç†â€œè¢«åˆ é™¤â€çš„æ–‡ä»¶ ----------</span></span><br><span class="line">        <span class="keyword">if</span> (!deleteFileList.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// 4.1 åˆ  DB è®°å½•</span></span><br><span class="line">            List&lt;String&gt; delFileIdList = deleteFileList.stream()</span><br><span class="line">                    .map(VideoInfoFilePost::getFileId)</span><br><span class="line">                    .collect(Collectors.toList());</span><br><span class="line">            videoInfoFilePostMapper.deleteBatchByFileId(delFileIdList, videoInfoPost.getUserId());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4.2 æ¨å…¥â€œæ–‡ä»¶åˆ é™¤é˜Ÿåˆ—â€ï¼Œç”±å¼‚æ­¥ä»»åŠ¡åˆ é™¤ç‰©ç†æ–‡ä»¶</span></span><br><span class="line">            List&lt;String&gt; delFilePathList = deleteFileList.stream()</span><br><span class="line">                    .map(VideoInfoFilePost::getFilePath)</span><br><span class="line">                    .collect(Collectors.toList());</span><br><span class="line">            redisComponent.addFile2DelQueue(videoId, delFilePathList);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ---------- 5. ç»Ÿä¸€è¡¥å…¨ &amp; æ‰¹é‡è½åº“ï¼ˆinsertOrUpdateï¼‰ ----------</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (VideoInfoFilePost f : uploadFileList) &#123;</span><br><span class="line">            f.setFileIndex(index++);           <span class="comment">// åˆ†Pé¡ºåºï¼ˆ1..Nï¼‰</span></span><br><span class="line">            f.setVideoId(videoId);             <span class="comment">// ç»‘å®š videoId</span></span><br><span class="line">            f.setUserId(videoInfoPost.getUserId());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (f.getFileId() == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// æ–°å¢æ–‡ä»¶ï¼šç”Ÿæˆ fileIdï¼Œæ ‡è®°â€œæœ‰æ›´æ–°&amp;å¾…è½¬ç â€</span></span><br><span class="line">                f.setFileId(StringTools.getRandomString(Constants.LENGTH_20));</span><br><span class="line">                f.setUpdateType(VideoFileUpdateTypeEnum.UPDATE.getStatus());</span><br><span class="line">                f.setTransferResult(VideoFileTransferResultEnum.TRANSFER.getStatus());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ‰¹é‡æ–°å¢æˆ–æ›´æ–°ï¼ˆè¦æ±‚ Mapper/SQL æ”¯æŒ upsertï¼‰</span></span><br><span class="line">        videoInfoFilePostMapper.insertOrUpdateBatch(uploadFileList);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ---------- 6. å°†â€œæ–°å¢æ–‡ä»¶â€æ¨å…¥è½¬ç é˜Ÿåˆ— ----------</span></span><br><span class="line">        <span class="keyword">if</span> (!addFileList.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (VideoInfoFilePost f : addFileList) &#123;</span><br><span class="line">                f.setUserId(videoInfoPost.getUserId());</span><br><span class="line">                f.setVideoId(videoId);</span><br><span class="line">            &#125;</span><br><span class="line">            redisComponent.addFile2TransferQueue(addFileList);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ˜¯å¦â€œè§†é¢‘åŸºæœ¬ä¿¡æ¯â€å‘ç”Ÿå˜åŒ–ï¼ˆæ ‡é¢˜/å°é¢/æ ‡ç­¾/ç®€ä»‹ï¼‰</span></span><br><span class="line"><span class="comment">     * ä»…ç¼–è¾‘åœºæ™¯ä½¿ç”¨ï¼šæ ¹æ® videoId å–DBæ•°æ®åšå¯¹æ¯”</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">changeVideoInfo</span><span class="params">(VideoInfoPost incoming)</span> &#123;</span><br><span class="line">        <span class="type">VideoInfoPost</span> <span class="variable">db</span> <span class="operator">=</span> videoInfoPostMapper.selectByVideoId(incoming.getVideoId());</span><br><span class="line">        <span class="keyword">if</span> (db == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">return</span> !Objects.equals(incoming.getVideoCover(), db.getVideoCover())</span><br><span class="line">                || !Objects.equals(incoming.getVideoName(), db.getVideoName())</span><br><span class="line">                || !Objects.equals(incoming.getTags(), db.getTags())</span><br><span class="line">                || !Objects.equals(incoming.getIntroduction(), db.getIntroduction());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯´æ˜</p>
<ul>
<li><code>insertOrUpdateBatch(uploadFileList)</code>ï¼šè¦æ±‚ä½ çš„ <code>video_info_file_post</code> çš„ Mapper XML å·²å®ç°æ‰¹é‡ upsertï¼ˆä½ æ–‡æ¡£é‡Œå·²æœ‰å£°æ˜ï¼‰ã€‚</li>
<li>åˆ é™¤ä¸è½¬ç é˜Ÿåˆ—çš„æŠ•é€’ï¼Œä½¿ç”¨çš„å°±æ˜¯ä½ ç»™å‡ºçš„ <code>RedisComponent.addFile2DelQueue / addFile2TransferQueue</code>ã€‚</li>
</ul>
<p>æµ‹è¯•</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-919-1024x185.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-918-1024x401.png" alt="img"></p>
<h3 id="8-å°†ä¿å­˜åœ¨tempé‡Œçš„åˆ†ç‰‡ç§»åˆ°videoç›®å½•å¹¶åˆå¹¶ä¸ºè§†é¢‘">8.å°†ä¿å­˜åœ¨tempé‡Œçš„åˆ†ç‰‡ç§»åˆ°videoç›®å½•å¹¶åˆå¹¶ä¸ºè§†é¢‘</h3>
<p>æŠŠ temp é‡Œçš„åˆ†ç‰‡ç§»åŠ¨åˆ° video ç›®å½•å¹¶åˆå¹¶ä¸ºå®Œæ•´è§†é¢‘ã€å†åˆ‡æˆ HLSï¼ˆ.m3u8 + .tsï¼‰â€<strong>çš„æ•´æ¡æµæ°´çº¿</strong></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-924.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-925.png" alt="img"></p>
<p>åœ¨taskåŒ…ä¸‹å®šä¹‰ä¸€ä¸ªExecuteQueueTask</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è½¬ç è§†é¢‘æ–‡ä»¶</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">consumeTransferFileQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    executorService.execute(() -&gt; &#123;</span><br><span class="line">        <span class="comment">// å¾ªç¯å¤„ç†è½¬ç ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// ä»Redisé˜Ÿåˆ—ä¸­è·å–å¾…è½¬ç çš„è§†é¢‘æ–‡ä»¶ä¿¡æ¯</span></span><br><span class="line">                VideoInfoFilePost videoInfoFile = (VideoInfoFilePost) redisUtils.rpop(Constants.REDIS_KEY_QUEUE_TRANSFER);</span><br><span class="line">                <span class="comment">// å¦‚æœæ²¡æœ‰è·å–åˆ°å¾…è½¬ç çš„è§†é¢‘æ–‡ä»¶ä¿¡æ¯ï¼Œåˆ™ä¼‘çœ ä¸€æ®µæ—¶é—´åå†ç»§ç»­</span></span><br><span class="line">                <span class="keyword">if</span> (videoInfoFile == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1500</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// è°ƒç”¨æœåŠ¡è¿›è¡Œè§†é¢‘æ–‡ä»¶è½¬ç </span></span><br><span class="line">                videoInfoPostService.transferVideoFile(videoInfoFile);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// è®°å½•é”™è¯¯æ—¥å¿—</span></span><br><span class="line">                log.<span class="keyword">error</span>(<span class="string">&quot;è·å–è½¬ç æ–‡ä»¶é˜Ÿåˆ—ä¿¡æ¯å¤±è´¥&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>FFmpegUtilsæ–¹æ³•ä¸­</p>
<figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è·å–è§†é¢‘æ—¶é•¿ï¼ˆç§’ï¼‰</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> completeVideo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="variable">public</span> <span class="title class_">Integer</span> <span class="title function_">getVideoInfoDuration</span>(<span class="params">String</span> <span class="params">completeVideo</span>) &#123;</span><br><span class="line">    <span class="comment">// æ„é€ è·å–è§†é¢‘æ—¶é•¿çš„å‘½ä»¤</span></span><br><span class="line">    <span class="variable">final</span> <span class="title class_">String</span> <span class="variable">CMD_GET_CODE</span> <span class="operator">=</span> <span class="string">&quot;ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 <span class="char escape_">\&quot;</span>%s<span class="char escape_">\&quot;</span>&quot;</span>;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ä¼ å…¥çš„è§†é¢‘æ–‡ä»¶è·¯å¾„å¡«å……å‘½ä»¤æ¨¡æ¿</span></span><br><span class="line">    <span class="title class_">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="title class_">String</span>.<span class="property">format</span>(<span class="variable">CMD_GET_CODE</span>, <span class="variable">completeVideo</span>);</span><br><span class="line">    <span class="comment">// æ‰§è¡Œå‘½ä»¤å¹¶è·å–ç»“æœ</span></span><br><span class="line">    <span class="title class_">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="title class_">ProcessUtils</span>.<span class="property">executeCommand</span>(<span class="variable">cmd</span>, <span class="variable">appConfig</span>.<span class="property">getShowFFmpegLog</span>());</span><br><span class="line">    <span class="comment">// å¦‚æœç»“æœä¸ºç©ºï¼Œåˆ™è¿”å›0</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">StringTools</span>.<span class="property">isEmpty</span>(<span class="variable">result</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å»é™¤ç»“æœä¸­çš„æ¢è¡Œç¬¦</span></span><br><span class="line">    <span class="variable">result</span> <span class="operator">=</span> <span class="variable">result</span>.<span class="property">replace</span>(<span class="string">&quot;<span class="char escape_">\n</span>&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="comment">// å°†ç»“æœè½¬æ¢ä¸ºæ•´æ•°å¹¶è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">new</span> <span class="title class_">BigDecimal</span>(<span class="variable">result</span>).<span class="property">intValue</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è·å–è§†é¢‘ç¼–ç </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> videoFilePath</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">public</span> <span class="title class_">String</span> <span class="title function_">getVideoCodec</span>(<span class="params">String</span> <span class="params">videoFilePath</span>) &#123;</span><br><span class="line">    <span class="comment">// å®šä¹‰è·å–è§†é¢‘ç¼–ç çš„å‘½ä»¤æ¨¡æ¿</span></span><br><span class="line">    <span class="variable">final</span> <span class="title class_">String</span> <span class="variable">CMD_GET_CODE</span> <span class="operator">=</span> <span class="string">&quot;ffprobe -v error -select_streams v:0 -show_entries stream=codec_name <span class="char escape_">\&quot;</span>%s<span class="char escape_">\&quot;</span>&quot;</span>;</span><br><span class="line">    <span class="comment">// å°†è§†é¢‘æ–‡ä»¶è·¯å¾„æ’å…¥åˆ°å‘½ä»¤æ¨¡æ¿ä¸­ï¼Œç”Ÿæˆå®Œæ•´çš„å‘½ä»¤</span></span><br><span class="line">    <span class="title class_">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="title class_">String</span>.<span class="property">format</span>(<span class="variable">CMD_GET_CODE</span>, <span class="variable">videoFilePath</span>);</span><br><span class="line">    <span class="comment">// æ‰§è¡Œå‘½ä»¤å¹¶è·å–ç»“æœ</span></span><br><span class="line">    <span class="title class_">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="title class_">ProcessUtils</span>.<span class="property">executeCommand</span>(<span class="variable">cmd</span>, <span class="variable">appConfig</span>.<span class="property">getShowFFmpegLog</span>());</span><br><span class="line">    <span class="comment">// å»é™¤ç»“æœä¸­çš„æ¢è¡Œç¬¦</span></span><br><span class="line">    <span class="variable">result</span> <span class="operator">=</span> <span class="variable">result</span>.<span class="property">replace</span>(<span class="string">&quot;<span class="char escape_">\n</span>&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="comment">// ä»ç»“æœä¸­æˆªå–ç­‰å·åçš„éƒ¨åˆ†</span></span><br><span class="line">    <span class="variable">result</span> <span class="operator">=</span> <span class="variable">result</span>.<span class="property">substring</span>(<span class="variable">result</span>.<span class="property">indexOf</span>(<span class="string">&quot;=&quot;</span>) <span class="operator">+</span> <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// ä»ç»“æœä¸­æˆªå–åˆ°å·¦æ–¹æ‹¬å·ä¹‹å‰çš„éƒ¨åˆ†ï¼Œå³ä¸ºè§†é¢‘ç¼–ç </span></span><br><span class="line">    <span class="title class_">String</span> <span class="variable">codec</span> <span class="operator">=</span> <span class="variable">result</span>.<span class="property">substring</span>(<span class="number">0</span>, <span class="variable">result</span>.<span class="property">indexOf</span>(<span class="string">&quot;[&quot;</span>));</span><br><span class="line">    <span class="comment">// è¿”å›è§†é¢‘ç¼–ç </span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">codec</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°†HEVCæ ¼å¼çš„è§†é¢‘æ–‡ä»¶è½¬æ¢ä¸ºMP4æ ¼å¼ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> newFileName è½¬æ¢åæ–‡ä»¶çš„æ–°åç§°</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> videoFilePath å¾…è½¬æ¢çš„HEVCè§†é¢‘æ–‡ä»¶çš„è·¯å¾„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">public</span> <span class="variable">void</span> <span class="title function_">convertHevc2Mp4</span>(<span class="params">String</span> <span class="params">newFileName</span>, <span class="params">String</span> <span class="params">videoFilePath</span>) &#123;</span><br><span class="line">    <span class="comment">// å®šä¹‰HEVCè½¬H.264çš„å‘½ä»¤æ¨¡æ¿</span></span><br><span class="line">    <span class="title class_">String</span> <span class="variable">CMD_HEVC_264</span> <span class="operator">=</span> <span class="string">&quot;ffmpeg -i %s -c:v libx264 -crf 20 %s&quot;</span>;</span><br><span class="line">    <span class="comment">// æ ¼å¼åŒ–å‘½ä»¤æ¨¡æ¿ï¼Œç”Ÿæˆå…·ä½“çš„å‘½ä»¤è¡Œå­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="title class_">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="title class_">String</span>.<span class="property">format</span>(<span class="variable">CMD_HEVC_264</span>, <span class="variable">newFileName</span>, <span class="variable">videoFilePath</span>);</span><br><span class="line">    <span class="comment">// appConfig.getShowFFmpegLog() è¡¨ç¤ºæ˜¯å¦æ˜¾ç¤ºFFmpegæ—¥å¿—</span></span><br><span class="line">    <span class="title class_">ProcessUtils</span>.<span class="property">executeCommand</span>(<span class="variable">cmd</span>, <span class="variable">appConfig</span>.<span class="property">getShowFFmpegLog</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°†è§†é¢‘æ–‡ä»¶è½¬æ¢ä¸ºTSæ ¼å¼å¹¶ç”Ÿæˆç´¢å¼•æ–‡ä»¶.m3u8å’Œåˆ‡ç‰‡.ts</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> tsFolder å­˜å‚¨TSæ–‡ä»¶å’Œç´¢å¼•æ–‡ä»¶çš„æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> videoFilePath è§†é¢‘æ–‡ä»¶çš„è·¯å¾„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">public</span> <span class="variable">void</span> <span class="title function_">convertVideo2Ts</span>(<span class="params">File</span> <span class="params">tsFolder</span>, <span class="params">String</span> <span class="params">videoFilePath</span>) &#123;</span><br><span class="line">    <span class="variable">final</span> <span class="title class_">String</span> <span class="variable">CMD_TRANSFER_2TS</span> <span class="operator">=</span> <span class="string">&quot;ffmpeg -y -i <span class="char escape_">\&quot;</span>%s<span class="char escape_">\&quot;</span>  -vcodec copy -acodec copy -bsf:v h264_mp4toannexb <span class="char escape_">\&quot;</span>%s<span class="char escape_">\&quot;</span>&quot;</span>;</span><br><span class="line">    <span class="variable">final</span> <span class="title class_">String</span> <span class="variable">CMD_CUT_TS</span> <span class="operator">=</span> <span class="string">&quot;ffmpeg -i <span class="char escape_">\&quot;</span>%s<span class="char escape_">\&quot;</span> -c copy -map 0 -f segment -segment_list <span class="char escape_">\&quot;</span>%s<span class="char escape_">\&quot;</span> -segment_time 10 %s/%%4d.ts&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”ŸæˆTSæ–‡ä»¶è·¯å¾„</span></span><br><span class="line">    <span class="title class_">String</span> <span class="variable">tsPath</span> <span class="operator">=</span> <span class="variable">tsFolder</span> <span class="operator">+</span> <span class="string">&quot;/&quot;</span> <span class="operator">+</span> <span class="title class_">Constants</span>.<span class="property">TS_NAME</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”Ÿæˆ.tsæ–‡ä»¶</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ffmpegå‘½ä»¤å°†è§†é¢‘æ–‡ä»¶è½¬æ¢ä¸ºTSæ ¼å¼</span></span><br><span class="line">    <span class="title class_">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="title class_">String</span>.<span class="property">format</span>(<span class="variable">CMD_TRANSFER_2TS</span>, <span class="variable">videoFilePath</span>, <span class="variable">tsPath</span>);</span><br><span class="line">    <span class="title class_">ProcessUtils</span>.<span class="property">executeCommand</span>(<span class="variable">cmd</span>, <span class="variable">appConfig</span>.<span class="property">getShowFFmpegLog</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”Ÿæˆç´¢å¼•æ–‡ä»¶.m3u8 å’Œåˆ‡ç‰‡.ts</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ffmpegå‘½ä»¤ç”Ÿæˆç´¢å¼•æ–‡ä»¶.m3u8 å’Œåˆ‡ç‰‡.ts</span></span><br><span class="line">    <span class="variable">cmd</span> <span class="operator">=</span> <span class="title class_">String</span>.<span class="property">format</span>(<span class="variable">CMD_CUT_TS</span>, <span class="variable">tsPath</span>, <span class="variable">tsFolder</span>.<span class="property">getPath</span>() <span class="operator">+</span> <span class="string">&quot;/&quot;</span> <span class="operator">+</span> <span class="title class_">Constants</span>.<span class="property">M3U8_NAME</span>, <span class="variable">tsFolder</span>.<span class="property">getPath</span>());</span><br><span class="line">    <span class="title class_">ProcessUtils</span>.<span class="property">executeCommand</span>(<span class="variable">cmd</span>, <span class="variable">appConfig</span>.<span class="property">getShowFFmpegLog</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ é™¤index.tsæ–‡ä»¶</span></span><br><span class="line">    <span class="comment">// åˆ é™¤ç”Ÿæˆçš„ä¸´æ—¶TSæ–‡ä»¶</span></span><br><span class="line">    <span class="variable">new</span> <span class="title class_">File</span>(<span class="variable">tsPath</span>).<span class="property">delete</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Constants</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸´æ—¶è§†é¢‘æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"> <span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">String</span> TEMP_VIDEO_NAME = <span class="string">&quot;/temp.mp4&quot;</span>;</span><br><span class="line"> <span class="comment">//hevcç¼–ç </span></span><br><span class="line"> <span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">String</span> VIDEO_CODE_HEVC = <span class="string">&quot;hevc&quot;</span>;</span><br><span class="line"> <span class="comment">//ä¸´æ—¶æ–‡ä»¶åç¼€</span></span><br><span class="line"> <span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">String</span>  VIDEO_CODE_TEMP_FILE_SUFFIX= <span class="string">&quot;_temp&quot;</span>;</span><br><span class="line"> <span class="comment">//tsæ–‡ä»¶åç§°</span></span><br><span class="line"> <span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">String</span> TS_NAME = <span class="string">&quot;index.ts&quot;</span>;</span><br><span class="line"> <span class="comment">//m3u8æ–‡ä»¶åç§°</span></span><br><span class="line"> <span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">String</span> M3U8_NAME = <span class="string">&quot;index.m3u8&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>VideoInfoPostServiceImpl ä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°† temp ä¸‹åˆ†ç‰‡æ‹·è´åˆ° video ç›®å½•ï¼Œåˆå¹¶ã€åˆ‡ç‰‡å¹¶æ›´æ–°çŠ¶æ€</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transferVideoFile</span><span class="params">(VideoInfoFilePost videoInfoFile)</span> &#123;</span><br><span class="line">    <span class="comment">// ç”¨äºæœ€ç»ˆè½åº“æ›´æ–°çš„å­—æ®µï¼ˆæŒ‰ uploadId + userId å®šä½æ›´æ–°ï¼‰</span></span><br><span class="line">    <span class="type">VideoInfoFilePost</span> <span class="variable">updateFilePost</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoFilePost</span>();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1) ä» Redis å–ä¼šè¯ä¿¡æ¯ï¼ˆé¢„ä¸Šä¼ é˜¶æ®µå†™å…¥ï¼Œé‡Œå¤´æœ‰ filePathï¼‰</span></span><br><span class="line">        <span class="type">UploadingFileDto</span> <span class="variable">fileDto</span> <span class="operator">=</span> redisComponent.getUploadingVideoFile(</span><br><span class="line">                videoInfoFile.getUserId(), videoInfoFile.getUploadId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2) è®¡ç®—ä¸´æ—¶/æ­£å¼ç›®å½•çš„ç»å¯¹è·¯å¾„</span></span><br><span class="line">        <span class="comment">// temp ç›®å½•ï¼š.../file/temp/&#123;yyyyMMdd&#125;/&#123;userId&#125;/&#123;uploadId&#125;</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tempFilePath</span> <span class="operator">=</span> appConfig.getProjectFolder()</span><br><span class="line">                + Constants.FILE_FOLDER + Constants.FILE_FOLDER_TEMP</span><br><span class="line">                + fileDto.getFilePath();</span><br><span class="line">        <span class="type">File</span> <span class="variable">tempDir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(tempFilePath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// video ç›®å½•ï¼š.../file/video/&#123;yyyyMMdd&#125;/&#123;userId&#125;/&#123;uploadId&#125;</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">targetFilePath</span> <span class="operator">=</span> appConfig.getProjectFolder()</span><br><span class="line">                + Constants.FILE_FOLDER + Constants.FILE_VIDEO</span><br><span class="line">                + fileDto.getFilePath();</span><br><span class="line">        <span class="type">File</span> <span class="variable">videoDir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(targetFilePath);</span><br><span class="line">        <span class="keyword">if</span> (!videoDir.exists()) &#123;</span><br><span class="line">            videoDir.mkdirs(); <span class="comment">// ç¡®ä¿æ­£å¼ç›®å½•å­˜åœ¨</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3) å°† temp ç›®å½•å®Œæ•´æ‹·è´åˆ° video ç›®å½•ï¼ˆåŒ…å«æ‰€æœ‰åˆ†ç‰‡ 0,1,2...ï¼‰</span></span><br><span class="line">        FileUtils.copyDirectory(tempDir, videoDir);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4) æ¸…ç†ä¸´æ—¶ç›®å½•ä¸ Redis ä¼šè¯é”®</span></span><br><span class="line">        FileUtils.forceDelete(tempDir);</span><br><span class="line">        redisComponent.delVideoFileInfo(videoInfoFile.getUserId(), videoInfoFile.getUploadId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5) åˆå¹¶åŒç›®å½•ä¸‹çš„åˆ†ç‰‡ä¸ºä¸€ä¸ªä¸´æ—¶ MP4 æ–‡ä»¶ï¼ˆtemp.mp4ï¼‰</span></span><br><span class="line">        <span class="comment">//    è§„åˆ™ï¼šæŒ‰æ–‡ä»¶å 0..N é¡ºåºè¿½åŠ å†™å…¥</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">completeVideo</span> <span class="operator">=</span> targetFilePath + Constants.TEMP_VIDEO_NAME; <span class="comment">// /temp.mp4</span></span><br><span class="line">        <span class="built_in">this</span>.union(targetFilePath, completeVideo, <span class="literal">true</span>); <span class="comment">// delSource=true è¡¨ç¤ºåˆå¹¶ååˆ é™¤åˆ†ç‰‡æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6) è¯»å–æ’­æ”¾æ—¶é•¿ä¸æ–‡ä»¶å¤§å°ï¼Œå‡†å¤‡æ›´æ–° file_post è®°å½•</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">duration</span> <span class="operator">=</span> fFmpegUtils.getVideoInfoDuration(completeVideo);</span><br><span class="line">        updateFilePost.setDuration(duration);</span><br><span class="line">        updateFilePost.setFileSize(<span class="keyword">new</span> <span class="title class_">File</span>(completeVideo).length());</span><br><span class="line">        <span class="comment">// æ³¨æ„ï¼šè¿™é‡Œå­˜ç›¸å¯¹è·¯å¾„ï¼Œå½¢å¦‚ &quot;video/&#123;yyyyMMdd&#125;/&#123;userId&#125;/&#123;uploadId&#125;&quot;</span></span><br><span class="line">        updateFilePost.setFilePath(Constants.FILE_VIDEO + fileDto.getFilePath());</span><br><span class="line">        updateFilePost.setTransferResult(VideoFileTransferResultEnum.SUCCESS.getStatus());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7) ç”Ÿæˆ HLSï¼šè‹¥ä¸º HEVC å…ˆè½¬ H.264ï¼Œå†åˆ‡ç‰‡ç”Ÿæˆ m3u8 + ts</span></span><br><span class="line">        <span class="built_in">this</span>.convertVideo2Ts(completeVideo);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// ä»»æ„å¼‚å¸¸éƒ½è§†ä¸ºè¯¥æ–‡ä»¶è½¬ç å¤±è´¥</span></span><br><span class="line">        log.error(<span class="string">&quot;æ–‡ä»¶è½¬ç å¤±è´¥&quot;</span>, e);</span><br><span class="line">        updateFilePost.setTransferResult(VideoFileTransferResultEnum.FAIL.getStatus());</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 8) æ›´æ–°è¿™æ¡ file_post çš„è½¬ç ç»“æœ/æ—¶é•¿/å¤§å°/è·¯å¾„ï¼ˆæŒ‰ uploadId + userIdï¼‰</span></span><br><span class="line">        videoInfoFilePostMapper.updateByUploadIdAndUserId(</span><br><span class="line">                updateFilePost, videoInfoFile.getUploadId(), videoInfoFile.getUserId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 9) æ¨è¿›è§†é¢‘æ•´ä½“çŠ¶æ€ï¼š</span></span><br><span class="line">        <span class="comment">//    a) è‹¥è¯¥è§†é¢‘ä¸‹å­˜åœ¨ä»»æ„ FAIL æ–‡ä»¶ =&gt; è§†é¢‘çŠ¶æ€=è½¬ç å¤±è´¥(1)ï¼Œç»“æŸ</span></span><br><span class="line">        <span class="type">VideoInfoFilePostQuery</span> <span class="variable">fileQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoFilePostQuery</span>();</span><br><span class="line">        fileQuery.setVideoId(videoInfoFile.getVideoId());</span><br><span class="line">        fileQuery.setTransferResult(VideoFileTransferResultEnum.FAIL.getStatus());</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">failCount</span> <span class="operator">=</span> videoInfoFilePostMapper.selectCount(fileQuery);</span><br><span class="line">        <span class="keyword">if</span> (failCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">VideoInfoPost</span> <span class="variable">videoUpdate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoPost</span>();</span><br><span class="line">            videoUpdate.setStatus(VideoStatusEnum.STATUS1.getStatus()); <span class="comment">// 1=è½¬ç å¤±è´¥</span></span><br><span class="line">            videoInfoPostMapper.updateByVideoId(videoUpdate, videoInfoFile.getVideoId());</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//    b) è‹¥ä»æœ‰ TRANSFER(è½¬ç ä¸­) æ–‡ä»¶ =&gt; å…ˆä¸åŠ¨è§†é¢‘çŠ¶æ€</span></span><br><span class="line">        fileQuery.setTransferResult(VideoFileTransferResultEnum.TRANSFER.getStatus());</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">transferCount</span> <span class="operator">=</span> videoInfoFilePostMapper.selectCount(fileQuery);</span><br><span class="line">        <span class="keyword">if</span> (transferCount == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//    c) æ‰€æœ‰æ–‡ä»¶éƒ½è½¬ç å®Œ =&gt; æ±‡æ€»æ—¶é•¿ï¼Œè§†é¢‘çŠ¶æ€=å¾…å®¡æ ¸(2)</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">duration</span> <span class="operator">=</span> videoInfoFilePostMapper.sumDuration(videoInfoFile.getVideoId());</span><br><span class="line">            <span class="type">VideoInfoPost</span> <span class="variable">videoUpdate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoPost</span>();</span><br><span class="line">            videoUpdate.setStatus(VideoStatusEnum.STATUS2.getStatus()); <span class="comment">// 2=å¾…å®¡æ ¸</span></span><br><span class="line">            videoUpdate.setDuration(duration);</span><br><span class="line">            videoInfoPostMapper.updateByVideoId(videoUpdate, videoInfoFile.getVideoId());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°†åˆå¹¶åçš„ MP4 è½¬æˆ HLSï¼ˆå¿…è¦æ—¶å…ˆåš HEVC -&gt; H.264 è½¬ç ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">convertVideo2Ts</span><span class="params">(String videoFilePath)</span> &#123;</span><br><span class="line">    <span class="type">File</span> <span class="variable">videoFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(videoFilePath);</span><br><span class="line">    <span class="comment">// åˆ‡ç‰‡è¾“å‡ºç›®å½•ï¼šä½¿ç”¨è§†é¢‘åŒç›®å½•</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">tsFolder</span> <span class="operator">=</span> videoFile.getParentFile();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1) æ£€æµ‹ç¼–ç ï¼Œè‹¥æ˜¯ HEVC(H.265) åˆ™å…ˆè½¬ H.264ï¼ˆå…¼å®¹å¹¿æ³›è®¾å¤‡/æµè§ˆå™¨ï¼‰</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">codec</span> <span class="operator">=</span> fFmpegUtils.getVideoCodec(videoFilePath);</span><br><span class="line">    <span class="keyword">if</span> (Constants.VIDEO_CODE_HEVC.equals(codec)) &#123;</span><br><span class="line">        <span class="comment">// å°†åŸæ–‡ä»¶å…ˆæ”¹åä¸ºä¸´æ—¶åï¼Œå†ä»¥åŸåä½œä¸ºè½¬ç è¾“å‡ºï¼Œæœ€ååˆ ä¸´æ—¶</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tempFileName</span> <span class="operator">=</span> videoFilePath + Constants.VIDEO_CODE_TEMP_FILE_SUFFIX; <span class="comment">// _temp</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">File</span>(videoFilePath).renameTo(<span class="keyword">new</span> <span class="title class_">File</span>(tempFileName));</span><br><span class="line">        fFmpegUtils.convertHevc2Mp4(tempFileName, videoFilePath);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">File</span>(tempFileName).delete();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) ç”Ÿæˆ HLSï¼šindex.m3u8 + N ä¸ª 0000.ts åˆ‡ç‰‡ï¼›å¹¶åˆ é™¤ä¸­é—´ index.ts</span></span><br><span class="line">    fFmpegUtils.convertVideo2Ts(tsFolder, videoFilePath);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) HLS å°±ç»ªï¼Œåˆ é™¤åˆå¹¶å‡ºçš„ä¸´æ—¶ mp4</span></span><br><span class="line">    videoFile.delete();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆå¹¶åˆ†ç‰‡æ–‡ä»¶ï¼š</span></span><br><span class="line"><span class="comment"> * dirPath ä¸‹æŒ‰ 0..N çš„æ–‡ä»¶é¡ºåºè¯»å–ï¼Œå†™åˆ° toFilePathï¼›å¯é€‰æ‹©åˆ é™¤æºåˆ†ç‰‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">union</span><span class="params">(String dirPath, String toFilePath, <span class="type">boolean</span> delSource)</span> <span class="keyword">throws</span> BusinessException &#123;</span><br><span class="line">    <span class="type">File</span> <span class="variable">dir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(dirPath);</span><br><span class="line">    <span class="keyword">if</span> (!dir.exists()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;ç›®å½•ä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¯»å–ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼ˆæ³¨æ„ï¼šéå†è¾“å‡ºå¯èƒ½ä¸æŒ‰æ•°å­—é¡ºåºï¼‰</span></span><br><span class="line">    File[] fileList = dir.listFiles();</span><br><span class="line">    <span class="type">File</span> <span class="variable">targetFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(toFilePath);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> (<span class="type">RandomAccessFile</span> <span class="variable">writeFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(targetFile, <span class="string">&quot;rw&quot;</span>)) &#123;</span><br><span class="line">        <span class="type">byte</span>[] buf = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span> * <span class="number">10</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å…³é”®ï¼šæ ¹æ®åˆ†ç‰‡æ–‡ä»¶å 0..N çš„æ•°å­—é¡ºåºè¿›è¡Œåˆå¹¶</span></span><br><span class="line">        <span class="comment">// è¿™ä¸€æ­¥ä¸ä½ åŸå®ç°ä¿æŒä¸€è‡´ï¼šæŒ‰ i=0..len-1 æ„é€  File(dir/i) è¯»å–</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; fileList.length; i++) &#123;</span><br><span class="line">            <span class="type">File</span> <span class="variable">chunkFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(dirPath + File.separator + i);</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">RandomAccessFile</span> <span class="variable">readFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(chunkFile, <span class="string">&quot;r&quot;</span>)) &#123;</span><br><span class="line">                <span class="type">int</span> len;</span><br><span class="line">                <span class="keyword">while</span> ((len = readFile.read(buf)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    writeFile.write(buf, <span class="number">0</span>, len);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// ä»»æ„åˆ†ç‰‡è¯»å–å¤±è´¥ï¼Œè®¤ä¸ºåˆå¹¶å¤±è´¥</span></span><br><span class="line">                log.error(<span class="string">&quot;åˆå¹¶åˆ†ç‰‡å¤±è´¥&quot;</span>, e);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;åˆå¹¶æ–‡ä»¶å¤±è´¥&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;åˆå¹¶æ–‡ä»¶&quot;</span> + dirPath + <span class="string">&quot;å‡ºé”™äº†&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (delSource &amp;&amp; fileList != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// åˆå¹¶å®ŒæˆåæŒ‰éœ€åˆ é™¤æºåˆ†ç‰‡</span></span><br><span class="line">            <span class="keyword">for</span> (File f : fileList) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123; f.delete(); &#125; <span class="keyword">catch</span> (Exception ignore) &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•æ²¡é—®é¢˜</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-926-1024x279.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-927-1024x183.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-928-1024x319.png" alt="img"></p>
<h3 id="9-å†™loadVideoPostæ¥å£ï¼Œè®©ç”¨æˆ·è‡ªå·±èƒ½çœ‹åˆ°è‡ªå·±å‘å¸ƒè¿‡çš„è§†é¢‘">9.å†™loadVideoPostæ¥å£ï¼Œè®©ç”¨æˆ·è‡ªå·±èƒ½çœ‹åˆ°è‡ªå·±å‘å¸ƒè¿‡çš„è§†é¢‘</h3>
<p><strong>ç”¨æˆ·åœ¨ä¸ªäººä¸­å¿ƒæŸ¥çœ‹è‡ªå·±æŠ•ç¨¿çš„è§†é¢‘</strong></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-932.png" alt="img"></p>
<p>åœ¨UcenterVideoPostController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * åŠ è½½è§†é¢‘åˆ—è¡¨</span></span><br><span class="line"><span class="comment">    * æ ¹æ®ç”¨æˆ·IDå’ŒæŸ¥è¯¢æ¡ä»¶åŠ è½½è§†é¢‘åˆ—è¡¨ï¼Œæ”¯æŒæŒ‰çŠ¶æ€ã€é¡µç å’Œè§†é¢‘åç§°æ¨¡ç³ŠæŸ¥è¯¢ã€‚</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> status è§†é¢‘çŠ¶æ€ï¼Œä¸º-1æ—¶æ’é™¤ç‰¹å®šçŠ¶æ€çš„è§†é¢‘ï¼Œä¸ºå…¶ä»–å€¼æ—¶æŒ‰æŒ‡å®šçŠ¶æ€æŸ¥è¯¢</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> pageNo åˆ†é¡µé¡µç ï¼Œç”¨äºæŒ‡å®šæŸ¥è¯¢çš„é¡µç </span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> videoNameFuzzy è§†é¢‘åç§°æ¨¡ç³ŠæŸ¥è¯¢æ¡ä»¶</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> è¿”å›æŸ¥è¯¢ç»“æœçš„å“åº”å¯¹è±¡</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@RequestMapping(&quot;/loadVideoList&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> ResponseVO <span class="title function_">loadVideoList</span><span class="params">(Integer status, Integer pageNo, String videoNameFuzzy)</span> &#123;</span><br><span class="line">        <span class="comment">// 1) è·å–ç™»å½•ç”¨æˆ·ï¼ˆä» Token ä¸­è§£æï¼Œé˜²æ­¢è¶Šæƒï¼‰</span></span><br><span class="line">       <span class="type">TokenUserInfoDto</span> <span class="variable">tokenUserInfoDto</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line"></span><br><span class="line">      </span><br><span class="line">       <span class="type">VideoInfoPostQuery</span> <span class="variable">videoInfoQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoPostQuery</span>();</span><br><span class="line">       <span class="comment">// è®¾ç½®ç”¨æˆ·ID</span></span><br><span class="line">       videoInfoQuery.setUserId(tokenUserInfoDto.getUserId());</span><br><span class="line">       <span class="comment">// è®¾ç½®æ’åºè§„åˆ™</span></span><br><span class="line">       videoInfoQuery.setOrderBy(<span class="string">&quot;v.create_time desc&quot;</span>);</span><br><span class="line">       <span class="comment">// è®¾ç½®åˆ†é¡µé¡µç </span></span><br><span class="line">       videoInfoQuery.setPageNo(pageNo);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// æ ¹æ®statusçš„å€¼è®¾ç½®æŸ¥è¯¢æ¡ä»¶</span></span><br><span class="line">       <span class="keyword">if</span> (status != <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (status == -<span class="number">1</span>) &#123;</span><br><span class="line">               <span class="comment">// æ’é™¤ç‰¹å®šçŠ¶æ€çš„è§†é¢‘</span></span><br><span class="line">               videoInfoQuery.setExcludeStatusArray(<span class="keyword">new</span> <span class="title class_">Integer</span>[]&#123;VideoStatusEnum.STATUS3.getStatus(), VideoStatusEnum.STATUS4.getStatus()&#125;);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// è®¾ç½®æŸ¥è¯¢çŠ¶æ€</span></span><br><span class="line">               videoInfoQuery.setStatus(status);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// è®¾ç½®è§†é¢‘åç§°æ¨¡ç³ŠæŸ¥è¯¢æ¡ä»¶</span></span><br><span class="line">       videoInfoQuery.setVideoNameFuzzy(videoNameFuzzy);</span><br><span class="line">       <span class="comment">// è®¾ç½®æŸ¥è¯¢æ•°é‡ä¿¡æ¯</span></span><br><span class="line">       videoInfoQuery.setQueryCountInfo(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// æ‰§è¡ŒæŸ¥è¯¢æ“ä½œå¹¶è·å–ç»“æœ</span></span><br><span class="line">       <span class="type">PaginationResultVO</span> <span class="variable">resultVO</span> <span class="operator">=</span> videoInfoPostService.findListByPage(videoInfoQuery);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// è¿”å›æŸ¥è¯¢ç»“æœ</span></span><br><span class="line">       <span class="keyword">return</span> getSuccessResponseVO(resultVO);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>å…³é”®ç‚¹</p>
<ul>
<li>
<p><strong>è¶Šæƒé˜²æŠ¤</strong>ï¼š<code>userId</code> ä¸€å®šæ¥è‡ª <code>getTokenUserInfoDto()</code>ï¼Œä¸æ˜¯å‰ç«¯å¯æ§å‚æ•°ã€‚</p>
</li>
<li>
<p>çŠ¶æ€è¯­ä¹‰</p>
<p>ï¼š</p>
<ul>
<li><code>STATUS3=å®¡æ ¸é€šè¿‡</code>ï¼Œ<code>STATUS4=å®¡æ ¸å¤±è´¥</code>ï¼›</li>
<li><code>status=-1</code> ä»£è¡¨â€œæ’é™¤ 3/4â€ï¼Œå³<strong>åœ¨å®¡/è½¬ç ä¸­/è½¬ç å¤±è´¥</strong>ç­‰â€œè¿›è¡Œä¸­â€é›†åˆã€‚</li>
</ul>
</li>
<li>
<p><strong>åˆ†é¡µ</strong>ï¼š<code>setQueryCountInfo(true)</code> è®© Mapper åŒæ—¶ç»Ÿè®¡æ€»æ•°ï¼Œè¿”å› <code>PaginationResultVO</code>ï¼ˆåˆ—è¡¨+æ€»æ•°ï¼‰ã€‚</p>
</li>
<li>
<p><strong>æ’åº</strong>ï¼šæŒ‰åˆ›å»ºæ—¶é—´å€’åºï¼ŒæŠ•ç¨¿æœ€æ–°çš„åœ¨å‰ã€‚<br>
ä»¥ä¸Šé€»è¾‘ä¸æ³¨é‡Šè§ä½ æ–‡æ¡£ä»£ç ã€‚</p>
</li>
<li>
<p>çŠ¶æ€ç»Ÿè®¡ï¼š<code>/getVideoCountInfo</code></p>
</li>
</ul>
<p>æ ¸å¿ƒèŒè´£ï¼šè¿”å›â€œæˆ‘å‘å¸ƒè¿‡çš„â€ä¸‰ç±»æ•°é‡ï¼š<strong>å®¡æ ¸é€šè¿‡ã€å®¡æ ¸å¤±è´¥ã€è¿›è¡Œä¸­</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–è§†é¢‘å®¡æ ¸çŠ¶æ€ç»Ÿè®¡ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     * è¯¥æ¥å£ç”¨äºè·å–å½“å‰ç”¨æˆ·çš„è§†é¢‘å®¡æ ¸é€šè¿‡æ•°é‡ã€å®¡æ ¸å¤±è´¥æ•°é‡ä»¥åŠå®¡æ ¸ä¸­æ•°é‡ã€‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è¿”å›åŒ…å«å®¡æ ¸é€šè¿‡æ•°é‡ã€å®¡æ ¸å¤±è´¥æ•°é‡ä»¥åŠå®¡æ ¸ä¸­æ•°é‡çš„ResponseVOå¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/getVideoCountInfo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseVO <span class="title function_">getVideoCountInfo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">TokenUserInfoDto</span> <span class="variable">tokenUserInfoDto</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line">    <span class="type">VideoInfoPostQuery</span> <span class="variable">videoInfoQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoPostQuery</span>();</span><br><span class="line">    videoInfoQuery.setUserId(tokenUserInfoDto.getUserId());<span class="comment">//åªæŸ¥è‡ªå·±çš„</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// â‘  å®¡æ ¸é€šè¿‡æ•°é‡</span></span><br><span class="line">    videoInfoQuery.setStatus(VideoStatusEnum.STATUS3.getStatus());</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">auditPassCount</span> <span class="operator">=</span> videoInfoPostService.findCountByParam(videoInfoQuery);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// â‘¡ å®¡æ ¸å¤±è´¥æ•°é‡</span></span><br><span class="line">    videoInfoQuery.setStatus(VideoStatusEnum.STATUS4.getStatus());</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">auditFailCount</span> <span class="operator">=</span> videoInfoPostService.findCountByParam(videoInfoQuery);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// â‘¢ è¿›è¡Œä¸­æ•°é‡ï¼šæ’é™¤â€œé€šè¿‡/å¤±è´¥â€</span></span><br><span class="line">    videoInfoQuery.setStatus(<span class="literal">null</span>);</span><br><span class="line">    videoInfoQuery.setExcludeStatusArray(</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Integer</span>[]&#123;VideoStatusEnum.STATUS3.getStatus(), VideoStatusEnum.STATUS4.getStatus()&#125;</span><br><span class="line">    );</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">inProgress</span> <span class="operator">=</span> videoInfoPostService.findCountByParam(videoInfoQuery);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// â‘£ å°è£…è¿”å›</span></span><br><span class="line">    <span class="type">VideoStatusCountInfoVO</span> <span class="variable">countInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoStatusCountInfoVO</span>();</span><br><span class="line">    countInfo.setAuditPassCount(auditPassCount);</span><br><span class="line">    countInfo.setAuditFailCount(auditFailCount);</span><br><span class="line">    countInfo.setInProgress(inProgress);</span><br><span class="line">    <span class="keyword">return</span> getSuccessResponseVO(countInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…³é”®ç‚¹</p>
<ul>
<li><strong>ä¸‰æ¬¡è®¡æ•°</strong>ï¼šåˆ†åˆ«ç”¨â€œç­‰äºæŸçŠ¶æ€â€æˆ–â€œæ’é™¤æŸäº›çŠ¶æ€â€çš„æ–¹å¼ç»Ÿè®¡ã€‚</li>
<li><strong>VO ç»“æ„</strong>ï¼š<code>VideoStatusCountInfoVO</code> åªæœ‰ä¸‰ä¸ªæ•´æ•°å­—æ®µï¼ˆpass/fail/inProgressï¼‰ã€‚</li>
</ul>
<p>VideoStatusCountInfoVO</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">vo</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VideoStatusCountInfoVO</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> auditPassCount;<span class="comment">//å®¡æ ¸é€šè¿‡æ•°é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> auditFailCount;<span class="comment">//å®¡æ ¸å¤±è´¥æ•°é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> inProgress;<span class="comment">//å®¡æ ¸ä¸­æ•°é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getAuditPassCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> auditPassCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setAuditPassCount</span>(<span class="params"><span class="title class_">Integer</span> auditPassCount</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">auditPassCount</span> = auditPassCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getAuditFailCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> auditFailCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setAuditFailCount</span>(<span class="params"><span class="title class_">Integer</span> auditFailCount</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">auditFailCount</span> = auditFailCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getInProgress</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> inProgress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setInProgress</span>(<span class="params"><span class="title class_">Integer</span> inProgress</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">inProgress</span> = inProgress;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-933.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-929-1024x410.png" alt="img"></p>
<h3 id="10-ç®¡ç†ç«¯èƒ½çœ‹åˆ°ç”¨æˆ·ç«¯å¾…å®¡æ ¸çš„è§†é¢‘">10.ç®¡ç†ç«¯èƒ½çœ‹åˆ°ç”¨æˆ·ç«¯å¾…å®¡æ ¸çš„è§†é¢‘</h3>
<p>å…ˆå†™ç¨¿ä»¶ç®¡ç†ï¼Œå…ˆåœ¨è¿™é‡Œèƒ½çœ‹åˆ°ä¹‹å‰ç”¨æˆ·å‘å¸ƒçš„è§†é¢‘ï¼Œè¿™æ ·æ‰èƒ½çœ‹åˆ°æ‰€æœ‰çš„è§†é¢‘éƒ½æ˜¯å¾…å®¡æ ¸çŠ¶æ€</p>
<p>é¦–å…ˆæ˜¯loadVideoListï¼Œå½“ç‚¹å‡»æŸ¥è¯¢æ—¶ä¼šè°ƒç”¨è¿™ä¸ªæ¥å£</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-930-1024x353.png" alt="img"></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/videoInfo&quot;</span>)</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">VideoInfoController</span> <span class="keyword">extends</span> <span class="title">ABaseController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">VideoInfoPostService</span> videoInfoPostService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">VideoInfoFilePostService</span> videoInfoFilePostService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">VideoInfoService</span> videoInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">&quot;/loadVideoList&quot;</span>)</span><br><span class="line">    public <span class="type">ResponseVO</span> loadVideoList(<span class="type">VideoInfoPostQuery</span> videoInfoPostQuery) &#123;</span><br><span class="line">        videoInfoPostQuery.setOrderBy(<span class="string">&quot;last_update_time desc&quot;</span>);</span><br><span class="line">        videoInfoPostQuery.setQueryCountInfo(<span class="literal">true</span>);</span><br><span class="line">        videoInfoPostQuery.setQueryUserInfo(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">PaginationResultVO</span> resultVO = videoInfoPostService.findListByPage(videoInfoPostQuery);</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(resultVO);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-939-1024x721.png" alt="img"></p>
<p>VideoInfoä¸­è¡¥ä¸Šè¿™ä¸¤ä¸ªä¿¡æ¯å’Œgetterå’Œsetteræ–¹æ³•</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">String</span> nickName;</span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> avatar;</span><br></pre></td></tr></table></figure>
<p>VideoInfoPostMapper.xmlä¸­</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!-- æŸ¥è¯¢é›†åˆ--&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectList&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;base_result_map&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    SELECT</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;base_column_list&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.queryCountInfo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        ,c.play_count,c.like_count,c.danmu_count,c.comment_count,c.coin_count,c.collect_count,c.recommend_type</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.queryUserInfo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        ,u.nick_name,u.avatar</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    FROM video_info_post v</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.queryCountInfo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        left join video_info c on c.video_id = v.video_id</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.queryUserInfo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        left join user_info u on u.user_id = v.user_id</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;query_condition&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.orderBy!=null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        order by $</span><span class="template-variable">&#123;query.orderBy&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.simplePage!=null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        limit #</span><span class="template-variable">&#123;query.simplePage.start&#125;</span><span class="language-xml">,#</span><span class="template-variable">&#123;query.simplePage.end&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>Mapper XML åŠ¨æ€ SQL é€è¡Œæ‹†è§£</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-940.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-941.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-942.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-943.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-931-1024x370.png" alt="img"></p>
<h2 id="6-ç®¡ç†å‘˜å®¡æ ¸è§†é¢‘">6.ç®¡ç†å‘˜å®¡æ ¸è§†é¢‘</h2>
<p>åœ¨VideoInfoControllerä¸­</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å®¡æ ¸è§†é¢‘æ¥å£</span></span><br><span class="line"><span class="comment">    * è¯¥æ¥å£ç”¨äºå®¡æ ¸è§†é¢‘ï¼Œé€šè¿‡ä¼ å…¥è§†é¢‘IDã€å®¡æ ¸çŠ¶æ€å’Œå®¡æ ¸ç†ç”±æ¥æ‰§è¡Œå®¡æ ¸æ“ä½œï¼Œå¹¶è¿”å›æ“ä½œç»“æœã€‚</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * @param videoId  è§†é¢‘IDï¼Œä¸èƒ½ä¸ºç©º</span></span><br><span class="line"><span class="comment">    * @param status   å®¡æ ¸çŠ¶æ€ï¼Œä¸èƒ½ä¸ºç©ºï¼Œé€šå¸¸ä½¿ç”¨é¢„å®šä¹‰çš„æ•´æ•°å€¼è¡¨ç¤ºä¸åŒçš„å®¡æ ¸çŠ¶æ€</span></span><br><span class="line"><span class="comment">    * @param reason   å®¡æ ¸ç†ç”±ï¼Œå¯ä»¥ä¸ºç©º</span></span><br><span class="line"><span class="comment">    * @return è¿”å›æ“ä½œç»“æœçš„ResponseVOå¯¹è±¡</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="variable">@RequestMapping</span>(<span class="string">&quot;/auditVideo&quot;</span>)</span><br><span class="line">   public ResponseVO <span class="built_in">auditVideo</span>(<span class="variable">@NotEmpty</span> String videoId, <span class="variable">@NotNull</span> Integer status, String reason) &#123;</span><br><span class="line">       <span class="selector-tag">videoInfoPostService</span><span class="selector-class">.auditVideo</span>(videoId, status, reason);</span><br><span class="line">       <span class="selector-tag">return</span> <span class="selector-tag">getSuccessResponseVO</span>(null);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>Service</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å®¡æ ¸è§†é¢‘</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> videoId  è§†é¢‘IDï¼Œä¸èƒ½ä¸ºç©º</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> status   å®¡æ ¸çŠ¶æ€ï¼Œä¸èƒ½ä¸ºç©ºï¼Œé€šå¸¸ä½¿ç”¨é¢„å®šä¹‰çš„æ•´æ•°å€¼è¡¨ç¤ºä¸åŒçš„å®¡æ ¸çŠ¶æ€</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> reason   å®¡æ ¸ç†ç”±ï¼Œå¯ä»¥ä¸ºç©º</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">auditVideo</span>(<span class="title class_">String</span> videoId, <span class="title class_">Integer</span> status, <span class="title class_">String</span> reason);</span><br></pre></td></tr></table></figure>
<p>ServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * ç®¡ç†å‘˜å®¡æ ¸è§†é¢‘ï¼ˆé€šè¿‡/é©³å›ï¼‰</span></span><br><span class="line"><span class="comment">	 * å…³é”®ç‚¹ï¼š</span></span><br><span class="line"><span class="comment">	 * 1) çŠ¶æ€æ ¡éªŒï¼šstatus å¿…é¡»æ˜¯ VideoStatusEnum é‡Œåˆæ³•å€¼</span></span><br><span class="line"><span class="comment">	 * 2) ä¹è§‚é”ï¼šåªå…è®¸ä»â€œå¾…å®¡æ ¸(2)â€æ›´æ–°ä¸ºç›®æ ‡çŠ¶æ€ï¼ˆwhere status=2ï¼‰</span></span><br><span class="line"><span class="comment">	 * 3) é€šè¿‡åˆ™æŠŠæŠ•ç¨¿æ•°æ®å¤åˆ¶åˆ°æ­£å¼è¡¨ï¼›é©³å›åˆ™åªæ›´æ–°çŠ¶æ€ä¸ç†ç”±</span></span><br><span class="line"><span class="comment">	 * 4) æ¸…ç†â€œæ–‡ä»¶æ›´æ–°æ ‡å¿—â€ï¼Œæ¸…ç†å¾…åˆ é™¤æ–‡ä»¶é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">auditVideo</span><span class="params">(String videoId, Integer status, String reason)</span> &#123;</span><br><span class="line">		<span class="comment">// --- 0) åŸºç¡€æ ¡éªŒ ---</span></span><br><span class="line">		<span class="type">VideoStatusEnum</span> <span class="variable">targetEnum</span> <span class="operator">=</span> VideoStatusEnum.getByStatus(status);</span><br><span class="line">		<span class="keyword">if</span> (targetEnum == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600); <span class="comment">// éæ³•çŠ¶æ€</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// ä»…å…è®¸æŠŠâ€œå¾…å®¡æ ¸(2)â€ -&gt; â€œé€šè¿‡(3)â€æˆ–â€œå¤±è´¥(4)â€ï¼Œå…¶ä½™å˜è¿ä¸æ”¯æŒ</span></span><br><span class="line">		<span class="keyword">if</span> (!(VideoStatusEnum.STATUS3 == targetEnum || VideoStatusEnum.STATUS4 == targetEnum)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// --- 1) ä¹è§‚é”åœ°æ›´æ–° video_info_post ä¸»è¡¨ ---</span></span><br><span class="line">		<span class="type">VideoInfoPost</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoPost</span>();</span><br><span class="line">		update.setStatus(status);                          <span class="comment">// æ–°çŠ¶æ€</span></span><br><span class="line">		update.setLastUpdateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());              <span class="comment">// æœ€åæ›´æ–°æ—¶é—´</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// where æ¡ä»¶ï¼švideo_id=...? AND status=å¾…å®¡æ ¸(2)</span></span><br><span class="line">		<span class="type">VideoInfoPostQuery</span> <span class="variable">where</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoPostQuery</span>();</span><br><span class="line">		where.setVideoId(videoId);</span><br><span class="line">		where.setStatus(VideoStatusEnum.STATUS2.getStatus()); <span class="comment">// åªåœ¨â€œå¾…å®¡æ ¸â€æ‰èƒ½è¢«å®¡æ ¸</span></span><br><span class="line"></span><br><span class="line">		<span class="type">Integer</span> <span class="variable">affected</span> <span class="operator">=</span> videoInfoPostMapper.updateByParam(update, where);</span><br><span class="line">		<span class="keyword">if</span> (affected == <span class="literal">null</span> || affected == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">// è¯´æ˜ä¸æ˜¯å¾…å®¡æ ¸çŠ¶æ€ï¼ˆå¯èƒ½å·²è¢«åˆ«äººå®¡æ ¸è¿‡ï¼‰ï¼Œæˆ– videoId éæ³•</span></span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;å®¡æ ¸å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// --- 2) å½’é›¶æœ¬è½®â€œæ–‡ä»¶æ›´æ–°â€æ ‡å¿—ï¼ˆpost æ–‡ä»¶è¡¨ï¼‰---</span></span><br><span class="line">		<span class="type">VideoInfoFilePost</span> <span class="variable">fileFlagUpdate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoFilePost</span>();</span><br><span class="line">		fileFlagUpdate.setUpdateType(VideoFileUpdateTypeEnum.NO_UPDATE.getStatus());</span><br><span class="line">		<span class="type">VideoInfoFilePostQuery</span> <span class="variable">filePostWhere</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoFilePostQuery</span>();</span><br><span class="line">		filePostWhere.setVideoId(videoId);</span><br><span class="line">		videoInfoFilePostMapper.updateByParam(fileFlagUpdate, filePostWhere);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// --- 3) è‹¥å®¡æ ¸å¤±è´¥ï¼Œç›´æ¥ç»“æŸï¼ˆä¸è¿›å…¥çº¿ä¸Šè¡¨ï¼‰---</span></span><br><span class="line">		<span class="keyword">if</span> (VideoStatusEnum.STATUS4 == targetEnum) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// --- 4) å®¡æ ¸é€šè¿‡ï¼šæŠŠæŠ•ç¨¿æ•°æ®å¤åˆ¶åˆ°æ­£å¼è¡¨ ---</span></span><br><span class="line">		<span class="comment">// 4.1 è¯»å–æœ€æ–°çš„æŠ•ç¨¿ä¸»è¡¨æ•°æ®</span></span><br><span class="line">		<span class="type">VideoInfoPost</span> <span class="variable">infoPost</span> <span class="operator">=</span> videoInfoPostMapper.selectByVideoId(videoId);</span><br><span class="line">		<span class="keyword">if</span> (infoPost == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="comment">// ç†è®ºä¸Šä¸è¯¥å‡ºç°ï¼›åŠ é˜²å¾¡</span></span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;å®¡æ ¸å¤±è´¥ï¼Œæ•°æ®ä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 4.2 é¦–æ¬¡å‘å¸ƒå¥–åŠ±ï¼ˆå¯é€‰é¡¹ï¼‰ï¼šè‹¥æ­£å¼è¡¨ä¸å­˜åœ¨è¯¥ videoIdï¼Œè®¤ä¸ºæ˜¯é¦–å‘ï¼Œå¯åŠ ç¡¬å¸</span></span><br><span class="line">		<span class="type">VideoInfo</span> <span class="variable">existOnline</span> <span class="operator">=</span> (VideoInfo) videoInfoMapper.selectByVideoId(videoId);<span class="comment">// æŸ¥æ­£å¼è¡¨</span></span><br><span class="line">		<span class="keyword">if</span> (existOnline == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="type">SysSettingDto</span> <span class="variable">sysSettingDto</span> <span class="operator">=</span> redisComponent.getSysSettingDto();</span><br><span class="line">			<span class="comment">// TODOï¼šç»™ infoPost.getUserId() åŠ ç¡¬å¸ï¼Œé¢åº¦æ¥è‡ª sysSettingDto</span></span><br><span class="line">			<span class="comment">// userCoinService.addCoins(infoPost.getUserId(), sysSettingDto.getPostRewardCoins());</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 4.3 å¤åˆ¶â€œä¸»è¡¨â€åˆ°æ­£å¼è¡¨ï¼ˆinsertOrUpdateï¼‰</span></span><br><span class="line">		<span class="type">VideoInfo</span> <span class="variable">online</span> <span class="operator">=</span> CopyTools.copy(infoPost, VideoInfo.class);</span><br><span class="line">		videoInfoMapper.insertOrUpdate(online);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 4.4 æ›¿æ¢â€œæ–‡ä»¶æ¸…å•â€ï¼šå…ˆåˆ æ­£å¼è¡¨æ—§æ¸…å•ï¼Œå†æ‹·è´æŠ•ç¨¿æ–‡ä»¶æ¸…å•</span></span><br><span class="line">		<span class="type">VideoInfoFileQuery</span> <span class="variable">delWhere</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoFileQuery</span>();</span><br><span class="line">		delWhere.setVideoId(videoId);</span><br><span class="line">		videoInfoFileMapper.deleteByParam(delWhere);</span><br><span class="line"></span><br><span class="line">		<span class="type">VideoInfoFilePostQuery</span> <span class="variable">postFilesQ</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoFilePostQuery</span>();</span><br><span class="line">		postFilesQ.setVideoId(videoId);</span><br><span class="line">		List&lt;VideoInfoFilePost&gt; postFiles = videoInfoFilePostMapper.selectList(postFilesQ);</span><br><span class="line"></span><br><span class="line">		List&lt;VideoInfoFile&gt; onlineFiles = CopyTools.copyList(postFiles, VideoInfoFile.class);</span><br><span class="line">		<span class="keyword">if</span> (!onlineFiles.isEmpty()) &#123;</span><br><span class="line">			videoInfoFileMapper.insertBatch(onlineFiles);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// --- 5) æ¸…ç†â€œå¾…åˆ é™¤æ–‡ä»¶é˜Ÿåˆ—â€é‡Œçš„ç‰©ç†æ–‡ä»¶ ---</span></span><br><span class="line">		List&lt;String&gt; filePathList = redisComponent.getDelFileList(videoId); <span class="comment">// æ¯ä¸ª path æ˜¯ç›¸å¯¹è·¯å¾„ï¼šå¦‚ &quot;video/20250812/xxx&quot;</span></span><br><span class="line">		<span class="keyword">if</span> (filePathList != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span> (String relative : filePathList) &#123;</span><br><span class="line">				<span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(appConfig.getProjectFolder() + Constants.FILE_FOLDER + relative);</span><br><span class="line">				<span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						<span class="comment">// æœ‰çš„ path æŒ‡å‘çš„æ˜¯ç›®å½•ï¼ˆå¦‚ uploadId ç›®å½•ï¼‰ï¼Œç”¨é€’å½’åˆ æ›´ç¨³</span></span><br><span class="line">						FileUtils.deleteDirectory(file);</span><br><span class="line">					&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">						log.error(<span class="string">&quot;åˆ é™¤æ–‡ä»¶å¤±è´¥ path=&#123;&#125;&quot;</span>, relative, e);</span><br><span class="line">						<span class="comment">// ä¸æŠ›å‡ºï¼Œè®©äº‹åŠ¡å¯ç»§ç»­ï¼Œé¿å…çº¿ä¸Šæ•°æ®å·²æ›´æ–°å´å› æ¸…ç†å¤±è´¥æ•´ä½“å›æ»š</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		redisComponent.cleanDelFileList(videoId);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// --- 6) TODOï¼šæŠŠè§†é¢‘ä¿¡æ¯ç´¢å¼•åˆ° ES / åˆ·æ–°ç¼“å­˜ç­‰ ---</span></span><br><span class="line">		<span class="comment">// esIndexer.indexVideo(online);</span></span><br><span class="line">		<span class="comment">// categoryCache.save2Redis() ...</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-934.png" alt="img"></p>
<p>è¿™é‡Œè®¾è®¡åˆ°äº†ä¹è§‚é”çš„æ€æƒ³ï¼Œå½“æ²¡æœ‰åé¢çš„status=2æ—¶ï¼Œå½“ç®¡ç†ç«¯å¼€ä¸¤ä¸ªæµè§ˆå™¨ï¼Œä¸€ä¸ªå·²ç»æŠŠå¾…å®¡æ ¸æ”¹ä¸ºäº†å®¡æ ¸ï¼Œå¦ä¸€ä¸ªæµè§ˆå™¨å´ä¾ç„¶å¯ä»¥è¿›è¡Œå®¡æ ¸ï¼Œå½“æŠŠåé¢çš„status=2åŠ ä¸Šæˆ‘ä»¬å°±çŸ¥é“äº†å½“å‰çš„çŠ¶æ€æ˜¯å¾…å®¡æ ¸ï¼Œä¸æ˜¯2çš„è¯å°±è¯´æ˜å·²ç»å®¡æ ¸è¿‡äº†ï¼Œè¿™æ ·å°±é˜²æ­¢äº†ä¸ä¸€è‡´çš„ä¿®æ”¹</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-945-1024x780.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-946-1024x580.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-947-1024x452.png" alt="img"></p>
<p>RedisCompoent</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * è·å–å¾…åˆ é™¤æ–‡ä»¶çš„åˆ—è¡¨</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> videoId è§†é¢‘çš„å”¯ä¸€æ ‡è¯†ç¬¦</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> å¾…åˆ é™¤æ–‡ä»¶çš„åˆ—è¡¨</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="title class_">List</span>&lt;<span class="title class_">String</span>&gt; <span class="title function_">getDelFileList</span>(<span class="params"><span class="title class_">String</span> videoId</span>) &#123;</span><br><span class="line">       <span class="title class_">List</span>&lt;<span class="title class_">String</span>&gt; filePathList = redisUtils.<span class="title function_">getQueueList</span>(<span class="title class_">Constants</span>.<span class="property">REDIS_KEY_FILE_DEL</span> + videoId);</span><br><span class="line">       <span class="keyword">return</span> filePathList;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * åˆ é™¤æŒ‡å®šè§†é¢‘IDçš„åˆ é™¤æ–‡ä»¶åˆ—è¡¨</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> videoId è§†é¢‘ID</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">cleanDelFileList</span>(<span class="params"><span class="title class_">String</span> videoId</span>) &#123;</span><br><span class="line">       redisUtils.<span class="title function_">delete</span>(<span class="title class_">Constants</span>.<span class="property">REDIS_KEY_FILE_DEL</span> + videoId);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-935-1024x471.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-936-1024x341.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-937-1024x136.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-938-1024x180.png" alt="img"></p>
<h2 id="7-ç”¨æˆ·ç«¯è·å–è§†é¢‘åˆ—è¡¨">7.ç”¨æˆ·ç«¯è·å–è§†é¢‘åˆ—è¡¨</h2>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-949.png" alt="img"></p>
<p>VideoInfoQueryä¸­æ·»åŠ å­—æ®µï¼Œå¹¶ç”Ÿæˆget/setteræ–¹æ³•</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">Boolean</span> queryUserInfo;</span><br></pre></td></tr></table></figure>
<ul>
<li>ç”¨æ¥æ ‡è®°æ˜¯å¦è¦åŒæ—¶æŸ¥è§†é¢‘å…³è”çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆæ˜µç§°ã€å¤´åƒç­‰ï¼‰</li>
<li>å¦‚æœä¸º <code>true</code>ï¼Œåœ¨ SQL é‡Œä¼šåŠ ä¸Š <code>LEFT JOIN user_info u ON u.user_id = v.user_id</code> å¹¶å¤šæŸ¥ <code>nick_name</code>ã€<code>avatar</code> å­—æ®µ</li>
</ul>
<p>VideoInfoMapper.xmlä¸­</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!-- æŸ¥è¯¢é›†åˆ--&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectList&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;base_result_map&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    SELECT</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;base_column_list&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.queryUserInfo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        ,u.nick_name,u.avatar</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    FROM video_info v</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.queryUserInfo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        left join user_info u on u.user_id = v.user_id</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;query_condition&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.orderBy!=null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        order by $</span><span class="template-variable">&#123;query.orderBy&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.simplePage!=null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        limit #</span><span class="template-variable">&#123;query.simplePage.start&#125;</span><span class="language-xml">,#</span><span class="template-variable">&#123;query.simplePage.end&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-950-1024x643.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-944-1024x479.png" alt="img"></p>
<p>å¦‚å›¾éœ€è¦å…³è”è¡¨ä¿¡æ¯è¿™æ ·å‰ç«¯æ‰èƒ½æ˜¾ç¤ºç”¨æˆ·çš„ä¸ªäººä¿¡æ¯</p>
<p>VideoControllerä¸­</p>
<p>è¿™é‡Œéœ€è¦ä¸¤ä¸ªæ¥å£</p>
<p>loadRecommendVideoæ˜¯å› ä¸ºåœ¨é¦–é¡µæœ‰æ¨èçš„è§†é¢‘</p>
<p>loadVideoåœ¨å…¶ä»–é¡µé¢æ²¡æœ‰æ¨èçš„è§†é¢‘å°±ä¼šè°ƒç”¨è¿™ä¸ªæ¥å£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/loadRecommendVideo&quot;)</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> ResponseVO <span class="title function_">loadRecommendVideo</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="type">VideoInfoQuery</span> <span class="variable">videoInfoQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoQuery</span>();</span><br><span class="line">      videoInfoQuery.setQueryUserInfo(<span class="literal">true</span>);<span class="comment">// æŸ¥ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">      videoInfoQuery.setOrderBy(<span class="string">&quot;create_time desc&quot;</span>);</span><br><span class="line">      videoInfoQuery.setRecommendType(VideoRecommendTypeEnum.RECOMMEND.getType());<span class="comment">// å·²æ¨è</span></span><br><span class="line">      List&lt;VideoInfo&gt; recommendVideoList = videoInfoService.findListByParam(videoInfoQuery);</span><br><span class="line">      <span class="keyword">return</span> getSuccessResponseVO(recommendVideoList);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@RequestMapping(&quot;/loadVideo&quot;)</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> ResponseVO <span class="title function_">postVideo</span><span class="params">(Integer pCategoryId, Integer categoryId, Integer pageNo)</span> &#123;</span><br><span class="line">      <span class="type">VideoInfoQuery</span> <span class="variable">videoInfoQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoQuery</span>();</span><br><span class="line">      videoInfoQuery.setCategoryId(categoryId);</span><br><span class="line">      videoInfoQuery.setpCategoryId(pCategoryId);</span><br><span class="line">      videoInfoQuery.setPageNo(pageNo);</span><br><span class="line">      videoInfoQuery.setQueryUserInfo(<span class="literal">true</span>);</span><br><span class="line">      videoInfoQuery.setOrderBy(<span class="string">&quot;create_time desc&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (categoryId == <span class="literal">null</span> &amp;&amp; pCategoryId == <span class="literal">null</span>) &#123;</span><br><span class="line">          videoInfoQuery.setRecommendType(VideoRecommendTypeEnum.NO_RECOMMEND.getType());<span class="comment">// æœªæ¨è</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="type">PaginationResultVO</span> <span class="variable">resultVO</span> <span class="operator">=</span> videoInfoService.findListByPage(videoInfoQuery);</span><br><span class="line">      <span class="keyword">return</span> getSuccessResponseVO(resultVO);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>VideoRecommendTypeEnum</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">enums</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">VideoRecommendTypeEnum</span> &#123;</span><br><span class="line">    <span class="title function_">NO_RECOMMEND</span>(<span class="number">0</span>, <span class="string">&quot;æœªæ¨è&quot;</span>),</span><br><span class="line">    <span class="title function_">RECOMMEND</span>(<span class="number">1</span>, <span class="string">&quot;å·²æ¨è&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> <span class="keyword">type</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> desc;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">VideoRecommendTypeEnum</span>(<span class="title class_">Integer</span> <span class="keyword">type</span>, <span class="title class_">String</span> desc) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">type</span> = <span class="keyword">type</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">desc</span> = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getType</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">type</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getDesc</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="title class_">VideoRecommendTypeEnum</span> <span class="title function_">getByType</span>(<span class="params"><span class="title class_">Integer</span> <span class="keyword">type</span></span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="title class_">VideoRecommendTypeEnum</span> typeEnum : <span class="title class_">VideoRecommendTypeEnum</span>.<span class="title function_">values</span>()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (typeEnum.<span class="title function_">getType</span>().<span class="title function_">equals</span>(<span class="keyword">type</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> typeEnum;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-951.png" alt="img"></p>
<p>æµ‹è¯•</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-948-1024x395.png" alt="img"></p>
<h2 id="8ç”¨æˆ·ç«¯è·å–è§†é¢‘è¯¦æƒ…å¹¶æ’­æ”¾">8ç”¨æˆ·ç«¯è·å–è§†é¢‘è¯¦æƒ…å¹¶æ’­æ”¾</h2>
<h3 id="ç¬¬ä¸€éƒ¨åˆ†ï¼šå…ˆå®Œæˆåˆ†æ‰¹åˆ—è¡¨çš„å±•ç¤ºå’Œæ ‡é¢˜ç®€ä»‹ç­‰çš„å±•ç¤º">ç¬¬ä¸€éƒ¨åˆ†ï¼šå…ˆå®Œæˆåˆ†æ‰¹åˆ—è¡¨çš„å±•ç¤ºå’Œæ ‡é¢˜ç®€ä»‹ç­‰çš„å±•ç¤º</h3>
<p>å…ˆå®šä¹‰VideoInfoResultVo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.entity.vo;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.po.VideoInfo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VideoInfoResultVo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> VideoInfo videoInfo;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">VideoInfoResultVo</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">VideoInfoResultVo</span><span class="params">(VideoInfo videoInfo)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.videoInfo= videoInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> VideoInfo <span class="title function_">getVideoInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> videoInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setVideoInfo</span><span class="params">(VideoInfo videoInfo)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.videoInfo = videoInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>VideoInfoVO</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">vo</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.<span class="property">fasterxml</span>.<span class="property">jackson</span>.<span class="property">annotation</span>.<span class="property">JsonFormat</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">format</span>.<span class="property">annotation</span>.<span class="property">DateTimeFormat</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">Date</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VideoInfoVo</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è§†é¢‘ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> videoId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è§†é¢‘å°é¢</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> videoCover;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è§†é¢‘åç§°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> videoName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨æˆ·ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> userId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonFormat</span>(pattern = <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>, timezone = <span class="string">&quot;GMT+8&quot;</span>)</span><br><span class="line">    <span class="meta">@DateTimeFormat</span>(pattern = <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Date</span> createTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 0:è‡ªåˆ¶ä½œ  1:è½¬è½½</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> postType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŸèµ„æºè¯´æ˜</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> originInfo;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ ‡ç­¾</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> tags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç®€ä»‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> introduction;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * äº’åŠ¨è®¾ç½®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> interaction;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> duration;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ’­æ”¾æ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> playCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç‚¹èµæ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> likeCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¼¹å¹•æ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> danmuCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯„è®ºæ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> commentCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŠ•å¸æ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> coinCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ”¶è—æ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> collectCount;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getVideoId</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> videoId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setVideoId</span>(<span class="params"><span class="title class_">String</span> videoId</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">videoId</span> = videoId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getVideoCover</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> videoCover;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setVideoCover</span>(<span class="params"><span class="title class_">String</span> videoCover</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">videoCover</span> = videoCover;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getVideoName</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> videoName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setVideoName</span>(<span class="params"><span class="title class_">String</span> videoName</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">videoName</span> = videoName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getUserId</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setUserId</span>(<span class="params"><span class="title class_">String</span> userId</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userId</span> = userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Date</span> <span class="title function_">getCreateTime</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setCreateTime</span>(<span class="params"><span class="title class_">Date</span> createTime</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">createTime</span> = createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getPostType</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> postType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setPostType</span>(<span class="params"><span class="title class_">Integer</span> postType</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">postType</span> = postType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getOriginInfo</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> originInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setOriginInfo</span>(<span class="params"><span class="title class_">String</span> originInfo</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">originInfo</span> = originInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getTags</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> tags;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setTags</span>(<span class="params"><span class="title class_">String</span> tags</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">tags</span> = tags;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getIntroduction</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> introduction;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setIntroduction</span>(<span class="params"><span class="title class_">String</span> introduction</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">introduction</span> = introduction;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getInteraction</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> interaction;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setInteraction</span>(<span class="params"><span class="title class_">String</span> interaction</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">interaction</span> = interaction;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getDuration</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> duration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setDuration</span>(<span class="params"><span class="title class_">Integer</span> duration</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">duration</span> = duration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getPlayCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> playCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setPlayCount</span>(<span class="params"><span class="title class_">Integer</span> playCount</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">playCount</span> = playCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getLikeCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> likeCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setLikeCount</span>(<span class="params"><span class="title class_">Integer</span> likeCount</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">likeCount</span> = likeCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getDanmuCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> danmuCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setDanmuCount</span>(<span class="params"><span class="title class_">Integer</span> danmuCount</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">danmuCount</span> = danmuCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getCommentCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> commentCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setCommentCount</span>(<span class="params"><span class="title class_">Integer</span> commentCount</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">commentCount</span> = commentCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getCoinCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> coinCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setCoinCount</span>(<span class="params"><span class="title class_">Integer</span> coinCount</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">coinCount</span> = coinCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getCollectCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> collectCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setCollectCount</span>(<span class="params"><span class="title class_">Integer</span> collectCount</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">collectCount</span> = collectCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-961-890x1024.png" alt="img"></p>
<p>VideoControllerä¸­</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŠ è½½è§†é¢‘ç‰‡æ®µåˆ—è¡¨</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">videoId</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/loadVideoPList&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">loadVideoPList</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="title class_">String</span> videoId</span>) &#123;</span><br><span class="line">    <span class="title class_">VideoInfoFileQuery</span> videoInfoQuery = <span class="keyword">new</span> <span class="title class_">VideoInfoFileQuery</span>();</span><br><span class="line">    videoInfoQuery.<span class="title function_">setVideoId</span>(videoId);</span><br><span class="line">    videoInfoQuery.<span class="title function_">setOrderBy</span>(<span class="string">&quot;file_index asc&quot;</span>);</span><br><span class="line">    <span class="title class_">List</span>&lt;<span class="title class_">VideoInfoFile</span>&gt; fileList = videoInfoFileService.<span class="title function_">findListByParam</span>(videoInfoQuery);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(fileList);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/getVideoInfo&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">getVideoInfo</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="title class_">String</span> videoId</span>) &#123;</span><br><span class="line">    <span class="title class_">VideoInfo</span> videoInfo = videoInfoService.<span class="title function_">getVideoInfoByVideoId</span>(videoId);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">null</span> == videoInfo) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="title class_">ResponseCodeEnum</span>.<span class="property">CODE_404</span>);</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment">//TODO è·å–ç”¨æˆ·è¡Œä¸º ç‚¹èµï¼ŒæŠ•å¸ï¼Œæ”¶è—</span></span><br><span class="line">    <span class="title class_">VideoInfoResultVo</span> resultVo = <span class="keyword">new</span> <span class="title class_">VideoInfoResultVo</span>(videoInfo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(resultVo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-962-1024x965.png" alt="img"></p>
<p>æµ‹è¯•å¦‚å›¾</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-952-1024x521.png" alt="img"></p>
<h3 id="ç¬¬äºŒéƒ¨åˆ†ï¼šè®©è§†é¢‘èƒ½å¤Ÿæ’­æ”¾">ç¬¬äºŒéƒ¨åˆ†ï¼šè®©è§†é¢‘èƒ½å¤Ÿæ’­æ”¾</h3>
<p>åœ¨webç«¯çš„FileControllerä¸­åŠ 2ä¸ªæ–¹æ³•</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * è·å–è§†é¢‘èµ„æºæ–‡ä»¶</span></span><br><span class="line"><span class="comment">    * æ ¹æ®æ–‡ä»¶IDè·å–å¯¹åº”çš„è§†é¢‘èµ„æºæ–‡ä»¶ï¼Œå¹¶å°†æ–‡ä»¶å†…å®¹é€šè¿‡HTTPå“åº”è¿”å›ç»™å®¢æˆ·ç«¯</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> response HTTPå“åº”å¯¹è±¡ï¼Œç”¨äºå°†è§†é¢‘æ–‡ä»¶å†…å®¹è¿”å›ç»™å®¢æˆ·ç«¯</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> fileId   æ–‡ä»¶IDï¼Œç”¨äºå”¯ä¸€æ ‡è¯†è¦è·å–çš„è§†é¢‘èµ„æºæ–‡ä»¶</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@RequestMapping</span>(<span class="string">&quot;/videoResource/&#123;fileId&#125;&quot;</span>)</span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">getVideoResource</span>(<span class="params"><span class="title class_">HttpServletResponse</span> response, <span class="meta">@PathVariable</span> <span class="meta">@NotEmpty</span> <span class="title class_">String</span> fileId</span>) &#123;</span><br><span class="line">       <span class="comment">// è·å–è§†é¢‘èµ„æºä¿¡æ¯</span></span><br><span class="line">       <span class="title class_">VideoInfoFilePost</span> videoInfoFilePost = videoInfoFilePostService.<span class="title function_">getVideoInfoFilePostByFileId</span>(fileId);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// è·å–è§†é¢‘æ–‡ä»¶çš„è·¯å¾„</span></span><br><span class="line">       <span class="title class_">String</span> filePath = videoInfoFilePost.<span class="title function_">getFilePath</span>();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// è¯»å–è§†é¢‘æ–‡ä»¶å†…å®¹å¹¶è¿”å›ç»™å®¢æˆ·ç«¯</span></span><br><span class="line">       <span class="comment">// m3u8æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">       <span class="title function_">readFile</span>(response, filePath + <span class="string">&quot;/&quot;</span> + <span class="title class_">Constants</span>.<span class="property">M3U8_NAME</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * è·å–è§†é¢‘èµ„æºæ–‡ä»¶ç‰‡æ®µ</span></span><br><span class="line"><span class="comment">    * æ ¹æ®æ–‡ä»¶IDå’Œæ—¶é—´æˆ³è·å–å¯¹åº”çš„è§†é¢‘èµ„æºæ–‡ä»¶ç‰‡æ®µï¼Œå¹¶å°†æ–‡ä»¶å†…å®¹å†™å…¥å“åº”ä¸­</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> response HttpServletResponseå¯¹è±¡ï¼Œç”¨äºå°†æ–‡ä»¶å†…å®¹å†™å…¥å“åº”</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> fileId æ–‡ä»¶IDï¼Œç”¨äºå”¯ä¸€æ ‡è¯†ä¸€ä¸ªè§†é¢‘æ–‡ä»¶</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> ts æ—¶é—´æˆ³ï¼Œç”¨äºå®šä½è§†é¢‘æ–‡ä»¶ä¸­çš„å…·ä½“ç‰‡æ®µ</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@RequestMapping</span>(<span class="string">&quot;/videoResource/&#123;fileId&#125;/&#123;ts&#125;&quot;</span>)</span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">getVideoResourceTs</span>(<span class="params"><span class="title class_">HttpServletResponse</span> response, <span class="meta">@PathVariable</span> <span class="meta">@NotEmpty</span> <span class="title class_">String</span> fileId, <span class="meta">@PathVariable</span> <span class="meta">@NotNull</span> <span class="title class_">String</span> ts</span>) &#123;</span><br><span class="line">       <span class="comment">// é€šè¿‡æ–‡ä»¶IDè·å–è§†é¢‘ä¿¡æ¯æ–‡ä»¶å‘å¸ƒè®°å½•</span></span><br><span class="line">       <span class="title class_">VideoInfoFilePost</span> videoInfoFilePost = videoInfoFilePostService.<span class="title function_">getVideoInfoFilePostByFileId</span>(fileId);</span><br><span class="line">       <span class="comment">// è·å–è§†é¢‘æ–‡ä»¶çš„è·¯å¾„</span></span><br><span class="line">       <span class="title class_">String</span> filePath = videoInfoFilePost.<span class="title function_">getFilePath</span>() + <span class="string">&quot;&quot;</span>;</span><br><span class="line">       <span class="comment">// è¯»å–æ–‡ä»¶å¹¶å°†æ–‡ä»¶å†…å®¹å†™å…¥å“åº”</span></span><br><span class="line">       <span class="comment">// filePath + &quot;/&quot; + ts æ˜¯æ–‡ä»¶çš„å®Œæ•´è·¯å¾„ï¼Œå…¶ä¸­ filePath æ˜¯è§†é¢‘æ–‡ä»¶çš„ç›®å½•ï¼Œts æ˜¯è§†é¢‘ç‰‡æ®µçš„æ—¶é—´æˆ³</span></span><br><span class="line">       <span class="title function_">readFile</span>(response, filePath + <span class="string">&quot;/&quot;</span> + ts);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-963-1024x899.png" alt="img"></p>
<p>VideoInfoResultVo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.entity.vo;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.po.VideoInfo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VideoInfoResultVo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> VideoInfo videoInfo;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List userActionList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="title function_">VideoInfoResultVo</span><span class="params">(VideoInfo videoInfo, List userActionList)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.videoInfo = videoInfo;</span><br><span class="line">        <span class="built_in">this</span>.userActionList = userActionList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List <span class="title function_">getUserActionList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userActionList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserActionList</span><span class="params">(List userActionList)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userActionList = userActionList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> VideoInfo <span class="title function_">getVideoInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> videoInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setVideoInfo</span><span class="params">(VideoInfo videoInfo)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.videoInfo = videoInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>VideoController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * è·å–è§†é¢‘ä¿¡æ¯æ¥å£</span></span><br><span class="line"><span class="comment">  * æ ¹æ®è§†é¢‘IDè·å–è§†é¢‘çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç”¨æˆ·è¡Œä¸ºï¼ˆç‚¹èµï¼ŒæŠ•å¸ï¼Œæ”¶è—ï¼‰ç­‰ã€‚</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> videoId è§†é¢‘çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œä¸èƒ½ä¸ºç©º</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> è¿”å›åŒ…å«è§†é¢‘è¯¦ç»†ä¿¡æ¯çš„ResponseVOå¯¹è±¡</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@throws</span> BusinessException å¦‚æœè§†é¢‘IDå¯¹åº”çš„è§†é¢‘ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºä¸šåŠ¡å¼‚å¸¸</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="meta">@RequestMapping(&quot;/getVideoInfo&quot;)</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> ResponseVO <span class="title function_">getVideoInfo</span><span class="params">(<span class="meta">@NotEmpty</span> String videoId)</span> &#123;</span><br><span class="line">     <span class="type">VideoInfo</span> <span class="variable">videoInfo</span> <span class="operator">=</span> videoInfoService.getVideoInfoByVideoId(videoId);</span><br><span class="line">     <span class="keyword">if</span> (<span class="literal">null</span> == videoInfo) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_404);</span><br><span class="line">     &#125;</span><br><span class="line">    <span class="comment">//TODO è·å–ç”¨æˆ·è¡Œä¸º ç‚¹èµï¼ŒæŠ•å¸ï¼Œæ”¶è—</span></span><br><span class="line">     <span class="type">VideoInfoResultVo</span> <span class="variable">resultVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoResultVo</span>(videoInfo, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> getSuccessResponseVO(resultVo);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ï¼šè§†é¢‘èƒ½æˆåŠŸæ’­æ”¾</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-953-1024x515.png" alt="img"></p>
<h2 id="9-è§†é¢‘å¼¹å¹•">9.è§†é¢‘å¼¹å¹•</h2>
<h3 id="1-æ„å»ºè§†é¢‘å¼¹å¹•è¡¨ã€è§†é¢‘è¯„è®ºè¡¨ã€ç”¨æˆ·è¡Œä¸ºè¡¨">1.æ„å»ºè§†é¢‘å¼¹å¹•è¡¨ã€è§†é¢‘è¯„è®ºè¡¨ã€ç”¨æˆ·è¡Œä¸ºè¡¨</h3>
<p>å»ºä¸‰å¼ è¡¨</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for user_action</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> `user_action`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_action`  (</span><br><span class="line">  `action_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">&#x27;è‡ªå¢ID&#x27;</span>,</span><br><span class="line">  `video_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;è§†é¢‘ID&#x27;</span>,</span><br><span class="line">  `video_user_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;è§†é¢‘ç”¨æˆ·ID&#x27;</span>,</span><br><span class="line">  `comment_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;è¯„è®ºID&#x27;</span>,</span><br><span class="line">  `action_type` tinyint(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;0:è¯„è®ºå–œæ¬¢ç‚¹èµ 1:è®¨åŒè¯„è®º 2:è§†é¢‘ç‚¹èµ 3:è§†é¢‘æ”¶è— 4:è§†é¢‘æŠ•å¸ &#x27;</span>,</span><br><span class="line">  `action_count` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æ•°é‡&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ç”¨æˆ·ID&#x27;</span>,</span><br><span class="line">  `action_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æ“ä½œæ—¶é—´&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (`action_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> `idx_key_video_comment_type_user`(`video_id`, `comment_id`, `action_type`, `user_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_video_id`(`video_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_user_id`(`user_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_type`(`action_type`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_action_time`(`action_time`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE = InnoDB AUTO_INCREMENT = <span class="number">23</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4 <span class="keyword">COLLATE</span> = utf8mb4_general_ci <span class="keyword">COMMENT</span> = <span class="string">&#x27;ç”¨æˆ·è¡Œä¸º ç‚¹èµã€è¯„è®º&#x27;</span> ROW_FORMAT = DYNAMIC;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for video_danmu</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> `video_danmu`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `video_danmu`  (</span><br><span class="line">  `danmu_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">&#x27;è‡ªå¢ID&#x27;</span>,</span><br><span class="line">  `video_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;è§†é¢‘ID&#x27;</span>,</span><br><span class="line">  `file_id` <span class="type">varchar</span>(<span class="number">20</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;å”¯ä¸€ID&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">varchar</span>(<span class="number">15</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ç”¨æˆ·ID&#x27;</span>,</span><br><span class="line">  `post_time` datetime <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;å‘å¸ƒæ—¶é—´&#x27;</span>,</span><br><span class="line">  `<span class="type">text</span>` <span class="type">varchar</span>(<span class="number">300</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;å†…å®¹&#x27;</span>,</span><br><span class="line">  `mode` tinyint(<span class="number">1</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;å±•ç¤ºä½ç½®&#x27;</span>,</span><br><span class="line">  `color` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;é¢œè‰²&#x27;</span>,</span><br><span class="line">  `<span class="type">time</span>` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;å±•ç¤ºæ—¶é—´&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (`danmu_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_file_id`(`file_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE = InnoDB AUTO_INCREMENT = <span class="number">23</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4 <span class="keyword">COLLATE</span> = utf8mb4_general_ci <span class="keyword">COMMENT</span> = <span class="string">&#x27;è§†é¢‘å¼¹å¹•&#x27;</span> ROW_FORMAT = DYNAMIC;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for video_comment</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> `video_comment`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `video_comment`  (</span><br><span class="line">  `comment_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">&#x27;è¯„è®ºID&#x27;</span>,</span><br><span class="line">  `p_comment_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;çˆ¶çº§è¯„è®ºID&#x27;</span>,</span><br><span class="line">  `video_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;è§†é¢‘ID&#x27;</span>,</span><br><span class="line">  `video_user_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;è§†é¢‘ç”¨æˆ·ID&#x27;</span>,</span><br><span class="line">  `content` <span class="type">varchar</span>(<span class="number">500</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;å›å¤å†…å®¹&#x27;</span>,</span><br><span class="line">  `img_path` <span class="type">varchar</span>(<span class="number">150</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;å›¾ç‰‡&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">varchar</span>(<span class="number">15</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ç”¨æˆ·ID&#x27;</span>,</span><br><span class="line">  `reply_user_id` <span class="type">varchar</span>(<span class="number">15</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;å›å¤äººID&#x27;</span>,</span><br><span class="line">  `top_type` tinyint(<span class="number">4</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;0:æœªç½®é¡¶  1:ç½®é¡¶&#x27;</span>,</span><br><span class="line">  `post_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;å‘å¸ƒæ—¶é—´&#x27;</span>,</span><br><span class="line">  `like_count` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;å–œæ¬¢æ•°é‡&#x27;</span>,</span><br><span class="line">  `hate_count` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;è®¨åŒæ•°é‡&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (`comment_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_post_time`(`post_time`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_top`(`top_type`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_p_id`(`p_comment_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_user_id`(`user_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_video_id`(`video_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE = InnoDB AUTO_INCREMENT = <span class="number">8</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4 <span class="keyword">COLLATE</span> = utf8mb4_general_ci <span class="keyword">COMMENT</span> = <span class="string">&#x27;è¯„è®º&#x27;</span> ROW_FORMAT = DYNAMIC;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-954.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-955.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-956.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-957-1024x429.png" alt="img"></p>
<h3 id="2-å‘å¸ƒå¼¹å¹•å’Œå±•ç¤ºå¼¹å¹•">2.å‘å¸ƒå¼¹å¹•å’Œå±•ç¤ºå¼¹å¹•</h3>
<p>VideoDanmuController</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * åŠ è½½è§†é¢‘å¼¹å¹•</span></span><br><span class="line"><span class="comment">    * æ ¹æ®æ–‡ä»¶IDå’Œè§†é¢‘IDåŠ è½½å¯¹åº”è§†é¢‘çš„å¼¹å¹•åˆ—è¡¨</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> fileId æ–‡ä»¶IDï¼Œç”¨äºæ ‡è¯†ç‰¹å®šçš„è§†é¢‘æ–‡ä»¶</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> videoId è§†é¢‘IDï¼Œç”¨äºæ ‡è¯†ç‰¹å®šçš„è§†é¢‘</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> è¿”å›åŒ…å«å¼¹å¹•åˆ—è¡¨çš„ResponseVOå¯¹è±¡</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@RequestMapping</span>(<span class="string">&quot;/loadDanmu&quot;</span>)</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">loadDanmu</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="title class_">String</span> fileId, <span class="meta">@NotEmpty</span> <span class="title class_">String</span> videoId</span>) &#123;</span><br><span class="line">   </span><br><span class="line">       <span class="comment">// è·å–è§†é¢‘ä¿¡æ¯</span></span><br><span class="line">       <span class="title class_">VideoInfo</span> videoInfo = videoInfoService.<span class="title function_">getVideoInfoByVideoId</span>(videoId);</span><br><span class="line">   </span><br><span class="line">       <span class="comment">// å¦‚æœè§†é¢‘ä¿¡æ¯ä¸­åŒ…å«çš„äº’åŠ¨æ ‡è¯†ä¸º0ï¼Œåˆ™è¿”å›ç©ºçš„å¼¹å¹•åˆ—è¡¨</span></span><br><span class="line">       <span class="keyword">if</span> (videoInfo.<span class="title function_">getInteraction</span>() != <span class="literal">null</span> &amp;&amp; videoInfo.<span class="title function_">getInteraction</span>().<span class="title function_">contains</span>(<span class="title class_">Constants</span>.<span class="property">ZERO</span>.<span class="title function_">toString</span>())) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">       &#125;</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">       <span class="comment">// åˆ›å»ºå¼¹å¹•æŸ¥è¯¢å¯¹è±¡</span></span><br><span class="line">       <span class="title class_">VideoDanmuQuery</span> videoDanmuQuery = <span class="keyword">new</span> <span class="title class_">VideoDanmuQuery</span>();</span><br><span class="line">       <span class="comment">// è®¾ç½®æ–‡ä»¶ID</span></span><br><span class="line">       videoDanmuQuery.<span class="title function_">setFileId</span>(fileId);</span><br><span class="line">       <span class="comment">// è®¾ç½®æ’åºæ–¹å¼ä¸ºå¼¹å¹•IDå‡åº</span></span><br><span class="line">       videoDanmuQuery.<span class="title function_">setOrderBy</span>(<span class="string">&quot;danmu_id asc&quot;</span>);</span><br><span class="line">       <span class="comment">// è¿”å›åŒ…å«å¼¹å¹•åˆ—è¡¨çš„ResponseVOå¯¹è±¡</span></span><br><span class="line">       <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(videoDanmuService.<span class="title function_">findListByParam</span>(videoDanmuQuery));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å‘å¸ƒè§†é¢‘å¼¹å¹•</span></span><br><span class="line"><span class="comment">    * è¯¥æ¥å£ç”¨äºç”¨æˆ·å‘å¸ƒè§†é¢‘å¼¹å¹•ï¼Œå°†å¼¹å¹•ä¿¡æ¯ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> videoId è§†é¢‘IDï¼Œä¸èƒ½ä¸ºç©º</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> fileId  æ–‡ä»¶IDï¼Œä¸èƒ½ä¸ºç©º</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> text    å¼¹å¹•æ–‡æœ¬å†…å®¹ï¼Œä¸èƒ½ä¸ºç©ºï¼Œæœ€å¤§é•¿åº¦ä¸º200</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> mode    å¼¹å¹•æ¨¡å¼ï¼Œä¸èƒ½ä¸ºç©º</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> color   å¼¹å¹•é¢œè‰²ï¼Œä¸èƒ½ä¸ºç©º</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> time    å¼¹å¹•å‡ºç°çš„æ—¶é—´ï¼Œä¸èƒ½ä¸ºç©º</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> è¿”å›æ“ä½œç»“æœçš„ResponseVOå¯¹è±¡</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@RequestMapping</span>(<span class="string">&quot;/postDanmu&quot;</span>)</span><br><span class="line">   <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">postDanmu</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="title class_">String</span> videoId,</span></span><br><span class="line"><span class="params">                               <span class="meta">@NotEmpty</span> <span class="title class_">String</span> fileId,</span></span><br><span class="line"><span class="params">                               <span class="meta">@NotEmpty</span> <span class="meta">@Size</span>(max = <span class="number">200</span>) <span class="title class_">String</span> text,</span></span><br><span class="line"><span class="params">                               <span class="meta">@NotNull</span> <span class="title class_">Integer</span> mode,</span></span><br><span class="line"><span class="params">                               <span class="meta">@NotEmpty</span> <span class="title class_">String</span> color,</span></span><br><span class="line"><span class="params">                               <span class="meta">@NotNull</span> <span class="title class_">Integer</span> time</span>) &#123;</span><br><span class="line">       <span class="title class_">VideoDanmu</span> videoDanmu = <span class="keyword">new</span> <span class="title class_">VideoDanmu</span>();</span><br><span class="line">       videoDanmu.<span class="title function_">setVideoId</span>(videoId);</span><br><span class="line">       videoDanmu.<span class="title function_">setFileId</span>(fileId);</span><br><span class="line">       videoDanmu.<span class="title function_">setText</span>(text);</span><br><span class="line">       videoDanmu.<span class="title function_">setMode</span>(mode);</span><br><span class="line">       videoDanmu.<span class="title function_">setColor</span>(color);</span><br><span class="line">       videoDanmu.<span class="title function_">setTime</span>(time);</span><br><span class="line">       videoDanmu.<span class="title function_">setUserId</span>(<span class="title function_">getTokenUserInfoDto</span>().<span class="title function_">getUserId</span>());</span><br><span class="line">       videoDanmu.<span class="title function_">setPostTime</span>(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">       videoDanmuService.<span class="title function_">saveVideoDanmu</span>(videoDanmu);</span><br><span class="line">       <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(<span class="literal">null</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br></pre></td></tr></table></figure>
<p>Service</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * ä¿å­˜è§†é¢‘å¼¹å¹•</span></span><br><span class="line"><span class="comment">	 * @param videoDanmu</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">saveVideoDanmu</span><span class="params">(VideoDanmu videoDanmu)</span></span>;</span><br></pre></td></tr></table></figure>
<p>ServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¿å­˜è§†é¢‘å¼¹å¹•</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bean è§†é¢‘å¼¹å¹•å¯¹è±¡</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> BusinessException ä¸šåŠ¡å¼‚å¸¸</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveVideoDanmu</span><span class="params">(VideoDanmu bean)</span> &#123;</span><br><span class="line">	<span class="type">VideoInfo</span> <span class="variable">videoInfo</span> <span class="operator">=</span> videoInfoMapper.selectByVideoId(bean.getVideoId());</span><br><span class="line">	<span class="keyword">if</span> (videoInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//æ˜¯å¦å…³é—­å¼¹å¹•</span></span><br><span class="line">	<span class="keyword">if</span> (videoInfo.getInteraction() != <span class="literal">null</span> &amp;&amp; videoInfo.getInteraction().contains(Constants.ONE.toString())) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;UPä¸»å·²å…³é—­å¼¹å¹•&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">this</span>.videoDanmuMapper.insert(bean);</span><br><span class="line">	<span class="built_in">this</span>.videoInfoMapper.updateCountInfo(bean.getVideoId(), UserActionTypeEnum.VIDEO_DANMU.getField(), <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// TODO æ›´æ–°eså¼¹å¹•æ•°é‡</span></span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>videoInfoMapperä¸­æ›´æ–°è§†é¢‘å¼¹å¹•æ•°ã€æ’­æ”¾é‡ç­‰ä¿¡æ¯</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * æ›´æ–°è§†é¢‘ä¿¡æ¯ç»Ÿè®¡å­—æ®µ</span></span><br><span class="line"><span class="comment">	 * @param videoId</span></span><br><span class="line"><span class="comment">	 * @param field</span></span><br><span class="line"><span class="comment">	 * @param i</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">updateCountInfo</span><span class="params">(<span class="type">String</span> videoId, <span class="type">String</span> field, <span class="type">int</span> i)</span></span>;</span><br></pre></td></tr></table></figure>
<p>Mapperxml</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!-- æ›´æ–°è§†é¢‘æ’­æ”¾æ¬¡æ•°ã€ç‚¹èµæ•°ã€å¼¹å¹•æ•°ç­‰--&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateCountInfo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	update video_info set $</span><span class="template-variable">&#123;field&#125;</span><span class="language-xml"> = $</span><span class="template-variable">&#123;field&#125;</span><span class="language-xml">+#</span><span class="template-variable">&#123;changeCount&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;field==&#x27;play_count&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">		,last_play_time = now()</span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	where video_id = #</span><span class="template-variable">&#123;videoId&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-964.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-965-1024x868.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-966.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-967-927x1024.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-968.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-969.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-970.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-958-1024x521.png" alt="img"></p>
<h2 id="10-ç‚¹èµæ”¶è—">10.ç‚¹èµæ”¶è—</h2>
<p>é¦–å…ˆéœ€è¦MessageTypeEnum</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">enums</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">MessageTypeEnum</span> &#123;</span><br><span class="line">    <span class="title function_">SYS</span>(<span class="number">1</span>, <span class="string">&quot;ç³»ç»Ÿæ¶ˆæ¯&quot;</span>),</span><br><span class="line">    <span class="title function_">LIKE</span>(<span class="number">2</span>, <span class="string">&quot;ç‚¹èµ&quot;</span>),</span><br><span class="line">    <span class="title function_">COLLECTION</span>(<span class="number">3</span>, <span class="string">&quot;æ”¶è—&quot;</span>),</span><br><span class="line">    <span class="title function_">COMMENT</span>(<span class="number">4</span>, <span class="string">&quot;è¯„è®º&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> <span class="keyword">type</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> desc;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">MessageTypeEnum</span>(<span class="title class_">Integer</span> <span class="keyword">type</span>, <span class="title class_">String</span> desc) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">type</span> = <span class="keyword">type</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">desc</span> = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getType</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">type</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getDesc</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="title class_">MessageTypeEnum</span> <span class="title function_">getByType</span>(<span class="params"><span class="title class_">Integer</span> <span class="keyword">type</span></span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="title class_">MessageTypeEnum</span> statusEnum : <span class="title class_">MessageTypeEnum</span>.<span class="title function_">values</span>()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (statusEnum.<span class="title function_">getType</span>().<span class="title function_">equals</span>(<span class="keyword">type</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> statusEnum;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-971.png" alt="img"></p>
<p>åˆ›å»º<em>ç”¨æˆ·è¡Œä¸º ç‚¹èµã€è¯„è®º</em> UserActionController</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç”¨æˆ·è¡Œä¸º ç‚¹èµã€è¯„è®º Controller</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span>(<span class="string">&quot;userActionController&quot;</span>)</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/userAction&quot;</span>)</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">UserActionController</span> <span class="keyword">extends</span> <span class="title">ABaseController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserActionService</span> userActionService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">&quot;doAction&quot;</span>)</span><br><span class="line">    <span class="meta">@RecordUserMessage</span>(messageType = <span class="type">MessageTypeEnum</span>.<span class="type">LIKE</span>)</span><br><span class="line">    public <span class="type">ResponseVO</span> doAction(<span class="meta">@NotEmpty</span> <span class="type">String</span> videoId,</span><br><span class="line">                               <span class="meta">@NotEmpty</span> <span class="type">Integer</span> actionType,</span><br><span class="line">                               <span class="meta">@Max</span>(<span class="number">2</span>) <span class="meta">@Min</span>(<span class="number">1</span>) <span class="type">Integer</span> actionCount,</span><br><span class="line">                               <span class="type">Integer</span> commentId) &#123;</span><br><span class="line">        <span class="type">UserAction</span> userAction = <span class="keyword">new</span> <span class="type">UserAction</span>();</span><br><span class="line">        userAction.setUserId(getTokenUserInfoDto().getUserId());</span><br><span class="line">        userAction.setVideoId(videoId);</span><br><span class="line">        userAction.setActionType(actionType);</span><br><span class="line">        actionCount = actionCount == <span class="literal">null</span> ? <span class="type">Constants</span>.<span class="type">ONE</span> : actionCount;</span><br><span class="line">        userAction.setActionCount(actionCount);</span><br><span class="line">        commentId = commentId == <span class="literal">null</span> ? <span class="number">0</span> : commentId;</span><br><span class="line">        userAction.setCommentId(commentId);</span><br><span class="line">        userActionService.saveAction(userAction);</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-972-981x1024.png" alt="img"></p>
<p>userActionService</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * ä¿å­˜ç”¨æˆ·è¡Œä¸º</span></span><br><span class="line"><span class="comment">	 * @param userAction</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">saveAction</span><span class="params">(UserAction userAction)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å°æŠ€å·§ï¼šè¿™é‡Œè¡¥å……ideaçš„å¼ºå¤§åŠŸèƒ½ï¼Œé‡æ„é‡Œçš„æ”¹ä¸€ä¸ªå˜é‡ï¼Œå¼•ç”¨è¿™ä¸ªå˜é‡æ–¹æ³•é‡Œçš„æ–¹æ³•ä¸­å˜é‡ä¼šä¸€èµ·æ”¹ï¼Œé¿å…æˆ‘ä»¬ä¸€ä¸ªä¸ªæ‰¾å†ä¸€ä¸ªä¸ªæ”¹</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-959-916x1024.png" alt="img"></p>
<p>æ¥ä¸‹æ¥éœ€è¦æ”¹é€ VideoControllerï¼Œè¿™æ ·ç‚¹å¼€è§†é¢‘è¯¦æƒ…é¡µå¯ä»¥çœ‹åˆ°ä¹‹å‰ç‚¹è¿‡çš„èµå˜æˆè“è‰²äº†ï¼ˆä»£è¡¨ä¹‹å‰ç‚¹èµè¿‡äº†ï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–è§†é¢‘ä¿¡æ¯æ¥å£</span></span><br><span class="line"><span class="comment">     * æ ¹æ®è§†é¢‘IDè·å–è§†é¢‘çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç”¨æˆ·è¡Œä¸ºï¼ˆç‚¹èµï¼ŒæŠ•å¸ï¼Œæ”¶è—ï¼‰ç­‰ã€‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> videoId è§†é¢‘çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œä¸èƒ½ä¸ºç©º</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è¿”å›åŒ…å«è§†é¢‘è¯¦ç»†ä¿¡æ¯çš„ResponseVOå¯¹è±¡</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> BusinessException å¦‚æœè§†é¢‘IDå¯¹åº”çš„è§†é¢‘ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºä¸šåŠ¡å¼‚å¸¸</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/getVideoInfo&quot;)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ResponseVO <span class="title function_">getVideoInfo</span><span class="params">(<span class="meta">@NotEmpty</span> String videoId)</span> &#123;</span><br><span class="line">        <span class="type">VideoInfo</span> <span class="variable">videoInfo</span> <span class="operator">=</span> videoInfoService.getVideoInfoByVideoId(videoId);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == videoInfo) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_404);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">TokenUserInfoDto</span> <span class="variable">userInfoDto</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line">        List&lt;UserAction&gt; userActionList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (userInfoDto != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">UserActionQuery</span> <span class="variable">actionQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserActionQuery</span>();</span><br><span class="line">            actionQuery.setVideoId(videoId);</span><br><span class="line">            actionQuery.setUserId(userInfoDto.getUserId());</span><br><span class="line">            actionQuery.setActionTypeArray(<span class="keyword">new</span> <span class="title class_">Integer</span>[]&#123;UserActionTypeEnum.VIDEO_LIKE.getType(), UserActionTypeEnum.VIDEO_COLLECT.getType(),</span><br><span class="line">                    UserActionTypeEnum.VIDEO_COIN.getType(),&#125;);</span><br><span class="line">            userActionList = userActionService.findListByParam(actionQuery);</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">        <span class="type">VideoInfoResultVo</span> <span class="variable">resultVo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoResultVo</span>(videoInfo,userActionList);</span><br><span class="line">       </span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(resultVo);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-974-930x1024.png" alt="img"></p>
<p><strong>æ ¸å¿ƒé€»è¾‘</strong>ï¼š</p>
<ul>
<li>æ ¹æ® <code>videoId</code> è·å–è§†é¢‘çš„è¯¦ç»†ä¿¡æ¯ã€‚</li>
<li>å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼ŒæŸ¥è¯¢è¯¥ç”¨æˆ·å¯¹è¯¥è§†é¢‘çš„è¡Œä¸ºï¼ˆç‚¹èµã€æ”¶è—ã€æŠ•å¸ç­‰ï¼‰ã€‚</li>
<li>å°†è§†é¢‘ä¿¡æ¯ä¸ç”¨æˆ·è¡Œä¸ºä¿¡æ¯ä¸€èµ·è¿”å›ç»™å‰ç«¯ï¼Œå‰ç«¯ä¼šæ ¹æ®è¿™äº›ä¿¡æ¯æ¥å±•ç¤ºè§†é¢‘çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œç‚¹èµæŒ‰é’®å˜è“è¡¨ç¤ºç”¨æˆ·å·²ç‚¹èµï¼‰ã€‚</li>
</ul>
<p>UserActionQueryä¸­åŠ å…¥è¿™ä¸ªå˜é‡åŠå…¶get/setteræ–¹æ³•</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// è§†é¢‘ç‚¹èµã€è¯„è®ºç‚¹èµã€æ”¶è—ã€æŠ•å¸ç­‰è¡Œä¸ºç±»å‹æ•°ç»„</span></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">Integer</span><span class="meta">[</span><span class="meta">]</span> actionTypeArray;</span><br></pre></td></tr></table></figure>
<p>åœ¨UserActionMapperXmlä¸­æ·»åŠ æ‰©å±•çš„è¿‡æ»¤æ¡ä»¶</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!-- é€šç”¨æŸ¥è¯¢æ¡ä»¶åˆ—--&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;query_condition&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	 <span class="tag">&lt;<span class="name">where</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;base_condition_filed&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.videoIdFuzzy!= null  and query.videoIdFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 and  u.video_id like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.videoIdFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.videoUserIdFuzzy!= null  and query.videoUserIdFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 and  u.video_user_id like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.videoUserIdFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.userIdFuzzy!= null  and query.userIdFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 and  u.user_id like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.userIdFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.actionTimeStart!= null and query.actionTimeStart!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 &lt;![CDATA[ and  u.action_time&gt;=str_to_date(#</span><span class="template-variable">&#123;query.actionTimeStart&#125;</span><span class="language-xml">, &#x27;%Y-%m-%d&#x27;) ]]&gt;</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.actionTimeEnd!= null and query.actionTimeEnd!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 &lt;![CDATA[ and  u.action_time&lt; date_sub(str_to_date(#</span><span class="template-variable">&#123;query.actionTimeEnd&#125;</span><span class="language-xml">,&#x27;%Y-%m-%d&#x27;),interval -1 day) ]]&gt;</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="comment">&lt;!--æ‰©å±•çš„è¿‡æ»¤æ¡ä»¶--&gt;</span></span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.actionTypeArray!=null and query.actionTypeArray.length&gt;0&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">             and action_type in(<span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;query.actionTypeArray&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span> <span class="attr">item</span>=<span class="string">&quot;item&quot;</span>&gt;</span>#</span><span class="template-variable">&#123;item&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">foreach</span>&gt;</span> )</span></span><br><span class="line"><span class="language-xml">             <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	 <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-973-1024x519.png" alt="img"></p>
<p>userActionServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¿å­˜ç”¨æˆ·æ“ä½œã€‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bean ç”¨æˆ·æ“ä½œå®ä½“</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> BusinessException ä¸šåŠ¡å¼‚å¸¸</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveAction</span><span class="params">(UserAction bean)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–è§†é¢‘ä¿¡æ¯ï¼ŒéªŒè¯è§†é¢‘æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="type">VideoInfo</span> <span class="variable">videoInfo</span> <span class="operator">=</span> videoInfoMapper.selectByVideoId(bean.getVideoId());</span><br><span class="line">    <span class="keyword">if</span> (videoInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600);  <span class="comment">// å¦‚æœè§†é¢‘ä¸å­˜åœ¨ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    &#125;</span><br><span class="line">    bean.setVideoUserId(videoInfo.getUserId());  <span class="comment">// è®¾ç½®è§†é¢‘ç”¨æˆ·ID</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è·å–æ“ä½œç±»å‹æšä¸¾</span></span><br><span class="line">    <span class="type">UserActionTypeEnum</span> <span class="variable">actionTypeEnum</span> <span class="operator">=</span> UserActionTypeEnum.getByType(bean.getActionType());</span><br><span class="line">    <span class="keyword">if</span> (actionTypeEnum == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600);  <span class="comment">// å¦‚æœæ“ä½œç±»å‹æ— æ•ˆï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æŸ¥è¯¢æ˜¯å¦å·²æœ‰ç›¸åŒçš„ç”¨æˆ·è¡Œä¸ºè®°å½•</span></span><br><span class="line">    <span class="type">UserAction</span> <span class="variable">dbAction</span> <span class="operator">=</span> userActionMapper.selectByVideoIdAndCommentIdAndActionTypeAndUserId(</span><br><span class="line">        bean.getVideoId(), bean.getCommentId(), bean.getActionType(), bean.getUserId());</span><br><span class="line"></span><br><span class="line">    bean.setActionTime(<span class="keyword">new</span> <span class="title class_">Date</span>());  <span class="comment">// è®¾ç½®æ“ä½œæ—¶é—´</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®è¡Œä¸ºç±»å‹è¿›è¡Œæ“ä½œï¼ˆç‚¹èµã€æ”¶è—ï¼‰</span></span><br><span class="line">    <span class="keyword">switch</span> (actionTypeEnum) &#123;</span><br><span class="line">        <span class="keyword">case</span> VIDEO_LIKE:</span><br><span class="line">        <span class="keyword">case</span> VIDEO_COLLECT:</span><br><span class="line">            <span class="comment">// ç‚¹èµæˆ–æ”¶è—ï¼šå¦‚æœå·²ç»æœ‰è¡Œä¸ºè®°å½•ï¼Œåˆ é™¤è®°å½•ï¼›å¦‚æœæ²¡æœ‰ï¼Œæ’å…¥æ–°è®°å½•</span></span><br><span class="line">            <span class="keyword">if</span> (dbAction != <span class="literal">null</span>) &#123;</span><br><span class="line">                userActionMapper.deleteByActionId(dbAction.getActionId());  <span class="comment">// åˆ é™¤æ—§è®°å½•</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                userActionMapper.insert(bean);  <span class="comment">// æ’å…¥æ–°è®°å½•</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">changeCount</span> <span class="operator">=</span> dbAction == <span class="literal">null</span> ? <span class="number">1</span> : -<span class="number">1</span>;  <span class="comment">// å¢åŠ æˆ–å‡å°‘è®¡æ•°</span></span><br><span class="line">            videoInfoMapper.updateCountInfo(bean.getVideoId(), actionTypeEnum.getField(), changeCount);  <span class="comment">// æ›´æ–°è§†é¢‘ç»Ÿè®¡ä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ ¸å¿ƒé€»è¾‘</strong>ï¼š</p>
<ul>
<li><code>videoInfoMapper.selectByVideoId</code>ï¼šæ ¹æ®è§†é¢‘ ID è·å–è§†é¢‘ä¿¡æ¯ã€‚</li>
<li><code>userActionMapper.selectByVideoIdAndCommentIdAndActionTypeAndUserId</code>ï¼šæŸ¥è¯¢æ˜¯å¦å·²å­˜åœ¨è¯¥ç”¨æˆ·çš„ç‚¹èµæˆ–æ”¶è—è®°å½•ã€‚</li>
<li>å¦‚æœå­˜åœ¨è®°å½•ï¼Œåˆ™åˆ é™¤æ—§çš„è®°å½•ï¼ˆè¡¨ç¤ºç”¨æˆ·å–æ¶ˆæ“ä½œï¼‰ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ’å…¥æ–°çš„è®°å½•ã€‚</li>
<li>æ›´æ–°è§†é¢‘çš„ç‚¹èµã€æ”¶è—ç­‰ç»Ÿè®¡ä¿¡æ¯ã€‚</li>
</ul>
<p>æµ‹è¯•ä¸€ä¸‹æ²¡é—®é¢˜</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-975.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-960-1024x475.png" alt="img"></p>
<h2 id="11-æŠ•å¸">11.æŠ•å¸</h2>
<p><strong>èƒŒæ™¯</strong></p>
<p>æŠ•å¸åŠŸèƒ½é€šå¸¸ç”¨äºå¹³å°çš„å¥–åŠ±æœºåˆ¶ï¼Œç”¨æˆ·é€šè¿‡ç»™è§†é¢‘æŠ•å¸æ”¯æŒåˆ›ä½œè€…ã€‚é€šå¸¸ï¼ŒæŠ•å¸æ˜¯æœ‰é™åˆ¶çš„ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>ç”¨æˆ·ä¸èƒ½ç»™è‡ªå·±å‘å¸ƒçš„è§†é¢‘æŠ•å¸ã€‚</li>
<li>æŠ•å¸æ•°é™åˆ¶ï¼Œæ¯ä¸ªè§†é¢‘çš„æŠ•å¸æ¬¡æ•°å¯èƒ½ä¼šæœ‰é™åˆ¶ã€‚</li>
</ul>
<p>åœ¨UserActionServiceImplä¸­è¡¥ä¸Šç¡¬å¸çš„ç›¸å…³æ“ä½œ</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> VIDEO_COIN:</span><br><span class="line">                <span class="comment">// 1. æ£€æŸ¥UPä¸»æ˜¯å¦ç»™è‡ªå·±æŠ•å¸</span></span><br><span class="line">                <span class="keyword">if</span> (videoInfo.getUserId().<span class="keyword">equals</span>(bean.getUserId())) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(<span class="string">&quot;UPä¸»ä¸èƒ½ç»™è‡ªå·±æŠ•å¸&quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">                <span class="comment">// 2. æ£€æŸ¥è¯¥è§†é¢‘æ˜¯å¦å·²æŠ•å¸</span></span><br><span class="line">				<span class="keyword">if</span> (dbAction != <span class="literal">null</span>) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(<span class="string">&quot;å¯¹æœ¬ç¨¿ä»¶çš„æŠ•å¸æšæ•°å·²ç”¨å®Œ&quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">                <span class="comment">// 3. å‡å°‘ç”¨æˆ·çš„ç¡¬å¸æ•°é‡</span></span><br><span class="line">				Integer updateCount = userInfoMapper.updateCoinCountInfo(bean.getUserId(), -bean.getActionCount());</span><br><span class="line">				<span class="keyword">if</span> (updateCount == <span class="number">0</span>) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(<span class="string">&quot;å¸ä¸å¤Ÿ&quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">                <span class="comment">// 4. ç»™è§†é¢‘ä½œè€…å¢åŠ ç¡¬å¸</span></span><br><span class="line">				updateCount = userInfoMapper.updateCoinCountInfo(videoInfo.getUserId(), bean.getActionCount());</span><br><span class="line">				<span class="keyword">if</span> (updateCount == <span class="number">0</span>) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(<span class="string">&quot;æŠ•å¸å¤±è´¥&quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">                <span class="comment">// 5. ä¿å­˜ç”¨æˆ·çš„æŠ•å¸è¡Œä¸ºè®°å½•</span></span><br><span class="line">				userActionMapper.insert(bean);</span><br><span class="line">                <span class="comment">// 6. æ›´æ–°è§†é¢‘çš„æŠ•å¸ç»Ÿè®¡</span></span><br><span class="line">				videoInfoMapper.updateCountInfo(bean.getVideoId(), actionTypeEnum.getField(), bean.getActionCount());</span><br><span class="line">				<span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-978.png" alt="img"></p>
<p>userInfoMapperä¸­å®šä¹‰è¿™ä¸ªæ–¹æ³•updateCoinCountInfo</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ›´æ–°ç¡¬å¸æ•°é‡</span></span><br><span class="line"><span class="comment"> * @param userId</span></span><br><span class="line"><span class="comment"> * @param changeCount</span></span><br><span class="line"><span class="comment"> * @return</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="selector-tag">Integer</span> <span class="selector-tag">updateCoinCountInfo</span>(<span class="variable">@Param</span>(<span class="string">&quot;userId&quot;</span>) String userId,<span class="variable">@Param</span>(<span class="string">&quot;changeCount&quot;</span>) Integer changeCount);</span><br></pre></td></tr></table></figure>
<p>userInfoMapperXmlä¸­</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateCoinCountInfo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       update user_info</span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">set</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           current_coin_count = current_coin_count+ #</span><span class="template-variable">&#123;changeCount&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">           <span class="comment">&lt;!--æ€»ç¡¬å¸æ•°åªå¢ä¸å‡--&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;changeCount&gt;0&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               ,total_coin_count = total_coin_count+ #</span><span class="template-variable">&#123;changeCount&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       where user_id = #</span><span class="template-variable">&#123;userId&#125;</span><span class="language-xml"> and current_coin_count+#</span><span class="template-variable">&#123;changeCount&#125;</span><span class="language-xml">&gt;=0</span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-979-979x1024.png" alt="img"></p>
<p>æµ‹è¯•</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-976-1024x464.png" alt="img"></p>
<p>ç”¨è´¦å·2æ¥æŠ•å¸æµ‹è¯•</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-977-1024x483.png" alt="img"></p>
<h2 id="12-è¯„è®ºæ¨¡å—">12.è¯„è®ºæ¨¡å—</h2>
<h3 id="1-å‘å¸ƒè¯„è®º">1.å‘å¸ƒè¯„è®º</h3>
<p>è¿™ä¸ªæµç¨‹æ¶‰åŠ <strong>è¯„è®ºæ¨¡å—</strong> çš„è®¾è®¡å’Œå®ç°ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li><strong>å‘å¸ƒè¯„è®ºæ¥å£</strong></li>
<li><strong>è¯„è®ºæ•°æ®å¤„ç†ä¸å­˜å‚¨</strong></li>
<li><strong>çˆ¶è¯„è®ºå’Œå›å¤è¯„è®ºçš„é€»è¾‘</strong></li>
</ul>
<p>åˆ›å»ºVideoCommentController</p>
<p><strong>å‘å¸ƒè¯„è®ºæ¥å£ï¼š<code>postComment</code></strong></p>
<p><strong>åŠŸèƒ½</strong>ï¼š</p>
<p>è¯¥æ¥å£å¤„ç†ç”¨æˆ·å‘å¸ƒè¯„è®ºçš„æ“ä½œï¼Œè¯„è®ºå¯ä»¥æ˜¯å¯¹è§†é¢‘çš„ä¸»è¯„è®ºæˆ–å›å¤å…¶ä»–è¯„è®ºã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">&quot;/postComment&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">postComment</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="title class_">String</span> videoId,</span></span><br><span class="line"><span class="params">                              <span class="title class_">Integer</span> replyCommentId,  <span class="comment">// å›å¤çš„è¯„è®ºIDï¼Œè‹¥ä¸ºç©ºåˆ™è¡¨ç¤ºéå›å¤è¯„è®º</span></span></span><br><span class="line"><span class="params">                              <span class="meta">@NotEmpty</span> <span class="meta">@Size</span>(max = <span class="number">500</span>) <span class="title class_">String</span> content,  <span class="comment">// è¯„è®ºå†…å®¹</span></span></span><br><span class="line"><span class="params">                              <span class="meta">@Size</span>(max = <span class="number">50</span>) <span class="title class_">String</span> imgPath</span>) &#123;  <span class="comment">// è¯„è®ºé™„å¸¦çš„å›¾ç‰‡è·¯å¾„</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–å½“å‰ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">    <span class="title class_">TokenUserInfoDto</span> tokenUserInfoDto = <span class="title function_">getTokenUserInfoDto</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ›å»ºè¯„è®ºå¯¹è±¡</span></span><br><span class="line">    <span class="title class_">VideoComment</span> comment = <span class="keyword">new</span> <span class="title class_">VideoComment</span>();</span><br><span class="line">    comment.<span class="title function_">setUserId</span>(tokenUserInfoDto.<span class="title function_">getUserId</span>());  <span class="comment">// è®¾ç½®ç”¨æˆ·ID</span></span><br><span class="line">    comment.<span class="title function_">setAvatar</span>(tokenUserInfoDto.<span class="title function_">getAvatar</span>());  <span class="comment">// è®¾ç½®ç”¨æˆ·å¤´åƒ</span></span><br><span class="line">    comment.<span class="title function_">setNickName</span>(tokenUserInfoDto.<span class="title function_">getNickName</span>());  <span class="comment">// è®¾ç½®ç”¨æˆ·æ˜µç§°</span></span><br><span class="line">    comment.<span class="title function_">setVideoId</span>(videoId);  <span class="comment">// è®¾ç½®è§†é¢‘ID</span></span><br><span class="line">    comment.<span class="title function_">setContent</span>(content);  <span class="comment">// è®¾ç½®è¯„è®ºå†…å®¹</span></span><br><span class="line">    comment.<span class="title function_">setImgPath</span>(imgPath);  <span class="comment">// è®¾ç½®è¯„è®ºå›¾ç‰‡è·¯å¾„ï¼ˆå¯é€‰ï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨æœåŠ¡å±‚æ–¹æ³•å‘å¸ƒè¯„è®º</span></span><br><span class="line">    videoCommentService.<span class="title function_">postComment</span>(comment, replyCommentId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®å›å¤è¯„è®ºçš„ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚æœæ˜¯å›å¤è¯„è®ºï¼‰</span></span><br><span class="line">    comment.<span class="title function_">setReplyAvatar</span>(tokenUserInfoDto.<span class="title function_">getAvatar</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(comment);  <span class="comment">// è¿”å›æˆåŠŸå“åº”ï¼ŒåŒ…å«è¯„è®ºå¯¹è±¡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è¾“å…¥å‚æ•°</strong>ï¼š</p>
<ul>
<li><code>videoId</code>ï¼šè§†é¢‘IDï¼Œæ ‡è¯†è¯„è®ºæ‰€å±çš„è§†é¢‘ã€‚</li>
<li><code>replyCommentId</code>ï¼šå›å¤çš„è¯„è®ºIDï¼Œè‹¥ä¸ºç©ºåˆ™è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªä¸»è¯„è®ºï¼›è‹¥æœ‰å€¼ï¼Œè¡¨ç¤ºè¿™æ˜¯å¯¹æŸæ¡è¯„è®ºçš„å›å¤ã€‚</li>
<li><code>content</code>ï¼šè¯„è®ºå†…å®¹ï¼Œæœ€å¤š500ä¸ªå­—ç¬¦ã€‚</li>
<li><code>imgPath</code>ï¼šè¯„è®ºé™„å¸¦çš„å›¾ç‰‡è·¯å¾„ï¼ˆå¯é€‰ï¼‰ï¼Œæœ€å¤§50ä¸ªå­—ç¬¦ã€‚</li>
</ul>
<p><strong>å¤„ç†æµç¨‹</strong>ï¼š</p>
<ol>
<li>ä» <code>TokenUserInfoDto</code> ä¸­è·å–å½“å‰ç”¨æˆ·çš„ä¿¡æ¯ï¼ˆç”¨æˆ·IDã€å¤´åƒã€æ˜µç§°ï¼‰ã€‚</li>
<li>åˆ›å»º <code>VideoComment</code> å¯¹è±¡å¹¶å¡«å……ç›¸å…³ä¿¡æ¯ã€‚</li>
<li>è°ƒç”¨ <code>videoCommentService.postComment</code> æ–¹æ³•æ¥å¤„ç†å…·ä½“çš„è¯„è®ºå‘å¸ƒé€»è¾‘ï¼ˆåŒ…æ‹¬æ˜¯å¦æ˜¯å›å¤è¯„è®ºçš„é€»è¾‘ï¼‰ã€‚</li>
<li>å°†å›å¤ç”¨æˆ·çš„å¤´åƒå’Œæ˜µç§°è®¾ç½®ç»™è¯„è®ºå¯¹è±¡ï¼ˆå¦‚æœæ˜¯å›å¤å…¶ä»–è¯„è®ºï¼‰ã€‚</li>
<li>è¿”å›æˆåŠŸå“åº”ï¼ŒåŒ…å«è¯„è®ºå¯¹è±¡ã€‚</li>
</ol>
<p>VideoCommentåŠ å…¥è¿™4ä¸ªå±æ€§ï¼Œå¹¶ç”Ÿæˆgetterå’Œsetteræ–¹æ³•</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * ç”¨æˆ·æ˜µç§°å’Œå¤´åƒï¼Œç”¨äºå‰ç«¯å±•ç¤ºç”¨ï¼Œä¸å­˜æ•°æ®åº“</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">String</span> avatar;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * ç”¨æˆ·æ˜µç§°ï¼Œç”¨äºå‰ç«¯å±•ç¤ºç”¨ï¼Œä¸å­˜æ•°æ®åº“</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">String</span> nickName;</span><br><span class="line">         	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * å›å¤ç”¨æˆ·æ˜µç§°å’Œå¤´åƒï¼Œç”¨äºå‰ç«¯å±•ç¤ºç”¨ï¼Œä¸å­˜æ•°æ®åº“</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">String</span> replyAvatar;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * å›å¤ç”¨æˆ·æ˜µç§°ï¼Œç”¨äºå‰ç«¯å±•ç¤ºç”¨ï¼Œä¸å­˜æ•°æ®åº“</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">String</span> replyNickName;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-984-1024x787.png" alt="img"></p>
<p>VideoCommentServiceä¸­å®šä¹‰postCommentæ–¹æ³•</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * å‘å¸ƒè¯„è®º</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> comment</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> replyCommentId</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">postComment</span><span class="params">(VideoComment comment, Integer replyCommentId)</span></span>;</span><br></pre></td></tr></table></figure>
<p>Implå®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * å‘å¸ƒè¯„è®º</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> comment è¯„è®ºå¯¹è±¡</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> replyCommentId å›å¤çš„è¯„è®ºIDï¼Œè‹¥ä¸ºç©ºåˆ™è¡¨ç¤ºéå›å¤è¯„è®º</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> BusinessException ä¸šåŠ¡å¼‚å¸¸</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postComment</span><span class="params">(VideoComment comment, Integer replyCommentId)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å–è§†é¢‘ä¿¡æ¯</span></span><br><span class="line">    <span class="type">VideoInfo</span> <span class="variable">videoInfo</span> <span class="operator">=</span> videoInfoMapper.selectByVideoId(comment.getVideoId());</span><br><span class="line">    <span class="keyword">if</span> (videoInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600);  <span class="comment">// å¦‚æœè§†é¢‘ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­è§†é¢‘æ˜¯å¦å…³é—­äº†è¯„è®ºåŠŸèƒ½</span></span><br><span class="line">    <span class="keyword">if</span> (videoInfo.getInteraction() != <span class="literal">null</span> &amp;&amp; videoInfo.getInteraction().contains(Constants.ZERO.toString())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;UPä¸»å·²å…³é—­è¯„è®ºåŒº&quot;</span>);  <span class="comment">// å¦‚æœè§†é¢‘å…³é—­è¯„è®ºï¼Œåˆ™ä¸èƒ½å‘è¡¨è¯„è®º</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç†å›å¤è¯„è®ºçš„é€»è¾‘</span></span><br><span class="line">    <span class="keyword">if</span> (replyCommentId != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯å›å¤è¯„è®ºï¼Œè·å–å›å¤çš„è¯„è®ºä¿¡æ¯</span></span><br><span class="line">        <span class="type">VideoComment</span> <span class="variable">replyComment</span> <span class="operator">=</span> getVideoCommentByCommentId(replyCommentId);</span><br><span class="line">        <span class="keyword">if</span> (replyComment == <span class="literal">null</span> || !replyComment.getVideoId().equals(comment.getVideoId())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600);  <span class="comment">// å›å¤çš„è¯„è®ºä¸å­˜åœ¨æˆ–ä¸å½“å‰è§†é¢‘ä¸ç¬¦</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// è®¾ç½®çˆ¶è¯„è®ºID</span></span><br><span class="line">        <span class="keyword">if</span> (replyComment.getpCommentId() == <span class="number">0</span>) &#123;</span><br><span class="line">            comment.setpCommentId(replyComment.getCommentId());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            comment.setpCommentId(replyComment.getpCommentId());</span><br><span class="line">            comment.setReplyUserId(replyComment.getUserId());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®å›å¤ç”¨æˆ·çš„æ˜µç§°å’Œå¤´åƒ</span></span><br><span class="line">        <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> userInfoMapper.selectByUserId(replyComment.getUserId());</span><br><span class="line">        comment.setReplyNickName(userInfo.getNickName());</span><br><span class="line">        comment.setReplyAvatar(userInfo.getAvatar());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        comment.setpCommentId(<span class="number">0</span>);  <span class="comment">// å¦‚æœä¸æ˜¯å›å¤è¯„è®ºï¼Œè®¾ç½®ä¸º0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®è¯„è®ºçš„å‘å¸ƒæ—¶é—´å’Œè§†é¢‘ä½œè€…ID</span></span><br><span class="line">    comment.setPostTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    comment.setVideoUserId(videoInfo.getUserId());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¿å­˜è¯„è®ºåˆ°æ•°æ®åº“</span></span><br><span class="line">    videoCommentMapper.insert(comment);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ä¸»è¯„è®ºï¼Œå¢åŠ è§†é¢‘çš„è¯„è®ºæ•°</span></span><br><span class="line">    <span class="keyword">if</span> (comment.getpCommentId() == <span class="number">0</span>) &#123;</span><br><span class="line">        videoInfoMapper.updateCountInfo(comment.getVideoId(), UserActionTypeEnum.VIDEO_COMMENT.getField(), <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ­¥éª¤è§£æ</strong>ï¼š</p>
<ol>
<li>
<p><strong>è·å–è§†é¢‘ä¿¡æ¯</strong>ï¼š<br>
é€šè¿‡è§†é¢‘IDè·å–è§†é¢‘ä¿¡æ¯ï¼Œåˆ¤æ–­è§†é¢‘æ˜¯å¦å­˜åœ¨ã€‚å¦‚æœè§†é¢‘ä¸å­˜åœ¨ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚</p>
</li>
<li>
<p><strong>åˆ¤æ–­æ˜¯å¦å…³é—­è¯„è®ºåŠŸèƒ½</strong>ï¼š<br>
å¦‚æœè§†é¢‘çš„ <code>interaction</code> å­—æ®µåŒ…å« â€œ0â€ï¼ˆè¡¨ç¤ºè§†é¢‘å…³é—­äº†è¯„è®ºåŠŸèƒ½ï¼‰ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œé˜»æ­¢ç”¨æˆ·å‘è¡¨è¯„è®ºã€‚</p>
</li>
<li>
<p>å¤„ç†å›å¤è¯„è®ºçš„é€»è¾‘</p>
<p>ï¼š</p>
<p>å¦‚æœè¯„è®ºæ˜¯å›å¤å…¶ä»–è¯„è®ºçš„ï¼ˆ</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">replyCommentId</span> <span class="type">!=</span> <span class="literal">null</span></span><br></pre></td></tr></table></figure>
<p>ï¼‰ï¼Œåˆ™ï¼š</p>
<ul>
<li>è·å–å›å¤çš„è¯„è®ºï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æ•ˆã€‚</li>
<li>è®¾ç½®çˆ¶è¯„è®ºIDã€å›å¤ç”¨æˆ·IDã€å›å¤ç”¨æˆ·æ˜µç§°å’Œå¤´åƒã€‚</li>
</ul>
</li>
<li>
<p><strong>ä¿å­˜è¯„è®º</strong>ï¼š<br>
å°†è¯„è®ºä¿¡æ¯æ’å…¥åˆ° <code>video_comment</code> è¡¨ä¸­ã€‚</p>
</li>
<li>
<p><strong>å¢åŠ è§†é¢‘è¯„è®ºæ•°</strong>ï¼š<br>
å¦‚æœæ˜¯ä¸»è¯„è®ºï¼ˆ<code>pCommentId == 0</code>ï¼‰ï¼Œåˆ™å¢åŠ è§†é¢‘çš„è¯„è®ºæ•°ã€‚</p>
</li>
</ol>
<p>æµ‹è¯•å‘å¸ƒæˆåŠŸï¼Œç”±äºæˆ‘ä»¬è¿˜æ²¡åšæŸ¥è¯„è®ºçš„æ¥å£ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»æ•°æ®åº“é‡ŒéªŒè¯</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-980-1024x531.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-981-1024x139.png" alt="img"></p>
<h3 id="2-æŸ¥è¯¢è¯„è®ºå¹¶èƒ½å¤Ÿå­å›å¤å’Œç½®é¡¶è¯„è®º">2.æŸ¥è¯¢è¯„è®ºå¹¶èƒ½å¤Ÿå­å›å¤å’Œç½®é¡¶è¯„è®º</h3>
<p>è¿™ä¸ªæµç¨‹æ¶‰åŠçš„æ˜¯<strong>è§†é¢‘è¯„è®ºæ¨¡å—</strong>ï¼Œå…¶ä¸­åŒ…æ‹¬äº†è¯„è®ºçš„æŸ¥è¯¢ã€æ”¯æŒå­è¯„è®ºçš„åŠ è½½ã€ä»¥åŠè¯„è®ºçš„ç½®é¡¶åŠŸèƒ½ã€‚æˆ‘ä»¬ä¸€èµ·æ¥è¯¦ç»†è§£æä¸€ä¸‹è¿™ä¸ªæµç¨‹åŠå…¶ä»£ç å®ç°ã€‚</p>
<p><strong>æµç¨‹æ¦‚è¿°</strong></p>
<ol>
<li>æŸ¥è¯¢è§†é¢‘è¯„è®ºï¼š
<ul>
<li>æŸ¥è¯¢è§†é¢‘çš„ä¸»è¯„è®ºï¼Œå¹¶ä¸”æ ¹æ®å‚æ•°å†³å®šæ˜¯å¦åŠ è½½å­è¯„è®ºï¼ˆå›å¤ï¼‰ã€‚</li>
</ul>
</li>
<li>å­è¯„è®ºæŸ¥è¯¢ï¼š
<ul>
<li>å¦‚æœè®¾ç½®äº† <code>loadChildren</code> ä¸º <code>true</code>ï¼Œåˆ™æŸ¥è¯¢å¹¶åŠ è½½è¯¥è¯„è®ºçš„æ‰€æœ‰å­è¯„è®ºï¼ˆå›å¤ï¼‰ã€‚</li>
</ul>
</li>
<li>è§†é¢‘è¯„è®ºç½®é¡¶ï¼š
<ul>
<li>é€šè¿‡è®¾ç½® <code>top_type</code> æ¥åˆ¤æ–­å“ªäº›è¯„è®ºéœ€è¦ç½®é¡¶ã€‚</li>
</ul>
</li>
<li>è¿”å›è¯„è®ºæ•°æ®ï¼š
<ul>
<li>ç”Ÿæˆä¸€ä¸ª <code>VideoCommentResultVO</code> å¯¹è±¡ï¼ŒåŒ…å«è¯„è®ºæ•°æ®å’Œç”¨æˆ·çš„è¡Œä¸ºæ•°æ®ï¼ˆå¦‚ç‚¹èµæˆ–è®¨åŒè¯„è®ºï¼‰ã€‚</li>
</ul>
</li>
</ol>
<p>åˆ›å»ºVideoCommentResultVO</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">vo</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">po</span>.<span class="property">UserAction</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">po</span>.<span class="property">VideoComment</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">List</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VideoCommentResultVO</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">PaginationResultVO</span>&lt;<span class="title class_">VideoComment</span>&gt; commentData;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">List</span>&lt;<span class="title class_">UserAction</span>&gt; userActionList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">PaginationResultVO</span>&lt;<span class="title class_">VideoComment</span>&gt; <span class="title function_">getCommentData</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> commentData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setCommentData</span>(<span class="params"><span class="title class_">PaginationResultVO</span>&lt;<span class="title class_">VideoComment</span>&gt; commentData</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">commentData</span> = commentData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">List</span>&lt;<span class="title class_">UserAction</span>&gt; <span class="title function_">getUserActionList</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> userActionList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setUserActionList</span>(<span class="params"><span class="title class_">List</span>&lt;<span class="title class_">UserAction</span>&gt; userActionList</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userActionList</span> = userActionList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-985.png" alt="img"></p>
<p>VideoCommentQueryä¸­åŠ å…¥è¿™ä¸ªå­—æ®µå¹¶ç”Ÿæˆå¯¹åº”çš„getterå’Œsetteræ–¹æ³•</p>
<figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * æ˜¯å¦åŠ è½½å­è¯„è®º <span class="literal">true</span>:æ˜¯  <span class="literal">false</span>:å¦</span><br><span class="line"> */</span><br><span class="line"><span class="keyword">private</span> <span class="type">Boolean</span> loadChildren;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-986.png" alt="img"></p>
<p>VideoCommentServiceImplä¸­æ”¹é€ findListByParamæ–¹æ³•</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * æ ¹æ®æ¡ä»¶æŸ¥è¯¢åˆ—è¡¨</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> List&lt;VideoComment&gt; findListByParam(VideoCommentQuery param) &#123;</span><br><span class="line">		<span class="keyword">if</span> (param.getLoadChildren() != <span class="literal">null</span> &amp;&amp; param.getLoadChildren()) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.videoCommentMapper.selectListWithChildren(param);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.videoCommentMapper.selectList(param);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-987-1024x520.png" alt="img"></p>
<p>é¦–å…ˆåœ¨VideoCommentä¸­åŠ å…¥è¿™ä¸ªå±æ€§å¹¶ç”Ÿæˆå¯¹åº”çš„getterå’Œsetteræ–¹æ³•</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">List</span>&lt;<span class="type">VideoComment</span>&gt; children;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºVideoCommentMapperä¸­çš„selectListWithChildrenæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å­æŸ¥è¯¢</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> p</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">List&lt;T&gt; <span class="title function_">selectListWithChildren</span><span class="params">(<span class="meta">@Param(&quot;query&quot;)</span> P p)</span>;</span><br></pre></td></tr></table></figure>
<p>xmlä¸­</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;!<span class="comment">--è¿™é‡Œå•ç‹¬å®šä¹‰ä¸€ä¸ªresultMap å¦‚æœæ”¾åˆ° restMapä¸­å°±ä¼šé€’å½’è°ƒç”¨ --&gt;</span></span><br><span class="line">	&lt;resultMap id=&quot;base_result_map_children&quot; <span class="keyword">type</span>=&quot;com.easylive.entity.po.VideoComment&quot; extends=&quot;base_result_map&quot;&gt;</span><br><span class="line">		&lt;collection property=&quot;children&quot; column=&quot;comment_id&quot; <span class="keyword">select</span>=&quot;com.easylive.mappers.VideoCommentMapper.selectChildComment&quot;&gt;</span><br><span class="line">		&lt;/collection&gt;</span><br><span class="line">	&lt;/resultMap&gt;</span><br><span class="line"></span><br><span class="line">	&lt;<span class="keyword">select</span> id=&quot;selectChildComment&quot; resultMap=&quot;base_result_map&quot;&gt;</span><br><span class="line">		<span class="keyword">select</span> v.*,u.nick_name nickName,u.avatar avatar,u2.nick_name replyNickName,u2.avatar replyAvatar</span><br><span class="line">		<span class="keyword">from</span> video_comment v</span><br><span class="line">				 <span class="keyword">inner</span> <span class="keyword">join</span> user_info u <span class="keyword">on</span> v.user_id = u.user_id</span><br><span class="line">				 <span class="keyword">left join</span> user_info u2 <span class="keyword">on</span> u2.user_id = v.reply_user_id</span><br><span class="line">		<span class="keyword">where</span> p_comment_id = #&#123;commentId&#125; <span class="keyword">order</span> <span class="keyword">by</span> v.comment_id <span class="keyword">asc</span></span><br><span class="line">	&lt;/<span class="keyword">select</span>&gt;</span><br><span class="line"></span><br><span class="line">	&lt;<span class="keyword">select</span> id=&quot;selectListWithChildren&quot; resultMap=&quot;base_result_map_children&quot;&gt;</span><br><span class="line">		<span class="keyword">SELECT</span></span><br><span class="line">		&lt;<span class="keyword">include</span> refid=&quot;base_column_list&quot;/&gt;,u.nick_name nickName,u.avatar avatar</span><br><span class="line">		<span class="keyword">FROM</span> video_comment v <span class="keyword">left join</span> user_info u <span class="keyword">on</span> v.user_id = u.user_id</span><br><span class="line">		&lt;<span class="keyword">include</span> refid=&quot;query_condition&quot;/&gt;</span><br><span class="line">		&lt;<span class="keyword">if</span> test=&quot;query.orderBy!=null&quot;&gt;</span><br><span class="line">			<span class="keyword">order</span> <span class="keyword">by</span> $&#123;query.orderBy&#125;</span><br><span class="line">		&lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">		&lt;<span class="keyword">if</span> test=&quot;query.simplePage!=null&quot;&gt;</span><br><span class="line">			<span class="keyword">limit</span> #&#123;query.simplePage.<span class="keyword">start</span>&#125;,#&#123;query.simplePage.<span class="keyword">end</span>&#125;</span><br><span class="line">		&lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">	&lt;/<span class="keyword">select</span>&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-988.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-989.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-990-1024x440.png" alt="img"></p>
<p>VideoCommentController</p>
<p><code>loadComment</code> æ–¹æ³•å¤„ç†è¯„è®ºçš„æŸ¥è¯¢ï¼Œå¹¶å°†æ•°æ®è¿”å›ç»™å‰ç«¯ã€‚</p>
<p><strong>æ•´ä½“æµç¨‹ï¼š</strong></p>
<ol>
<li>æŸ¥è¯¢è§†é¢‘çš„è¯„è®ºåˆ—è¡¨ã€‚</li>
<li>æ ¹æ® <code>pageNo</code>ï¼ˆå½“å‰é¡µç ï¼‰å’Œ <code>orderType</code>ï¼ˆæ’åºæ–¹å¼ï¼‰è®¾ç½®æŸ¥è¯¢æ¡ä»¶ï¼Œå†³å®šå¦‚ä½•å±•ç¤ºè¯„è®ºï¼ˆåŒ…æ‹¬æ˜¯å¦åŠ è½½å­è¯„è®ºã€æ˜¯å¦å±•ç¤ºç½®é¡¶è¯„è®ºï¼‰ã€‚</li>
<li>å¦‚æœæ˜¯ç¬¬ä¸€é¡µï¼ŒæŸ¥è¯¢å¹¶å±•ç¤ºç½®é¡¶è¯„è®ºï¼Œå°†å®ƒä»¬æ”¾åœ¨è¯„è®ºåˆ—è¡¨çš„æœ€å‰é¢ã€‚</li>
<li>è¿”å›åŒ…å«è¯„è®ºæ•°æ®åŠç”¨æˆ·è¡Œä¸ºæ•°æ®ï¼ˆå¦‚ç‚¹èµã€è®¨åŒï¼‰ç»™å‰ç«¯ã€‚</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŠ è½½è§†é¢‘è¯„è®º</span></span><br><span class="line"><span class="comment">     * æ ¹æ®è§†é¢‘IDåŠ è½½å¯¹åº”è§†é¢‘çš„è¯„è®ºæ•°æ®ï¼ŒåŒ…æ‹¬è¯„è®ºåˆ—è¡¨å’Œç”¨æˆ·è¡Œä¸ºæ•°æ®ï¼ˆç‚¹èµ/è®¨åŒï¼‰</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> videoId è§†é¢‘IDï¼Œç”¨äºè·å–è§†é¢‘ä¿¡æ¯å’Œå¯¹åº”çš„è¯„è®º</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pageNo é¡µç ï¼Œç”¨äºåˆ†é¡µæŸ¥è¯¢è¯„è®ºæ•°æ®</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> orderType æ’åºç±»å‹ï¼Œ0æˆ–nullè¡¨ç¤ºæŒ‰ç‚¹èµæ•°é™åºæ’åºï¼Œå…¶ä»–å€¼è¡¨ç¤ºæŒ‰è¯„è®ºIDé™åºæ’åº</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è¿”å›åŒ…å«è¯„è®ºæ•°æ®å’Œç”¨æˆ·è¡Œä¸ºæ•°æ®çš„å“åº”å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/loadComment&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseVO <span class="title function_">loadComment</span><span class="params">(<span class="meta">@NotEmpty</span> String videoId, Integer pageNo, Integer orderType)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. è·å–è§†é¢‘ä¿¡æ¯</span></span><br><span class="line">        <span class="type">VideoInfo</span> <span class="variable">videoInfo</span> <span class="operator">=</span> videoInfoService.getVideoInfoByVideoId(videoId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. å¦‚æœè§†é¢‘å…³é—­äº†è¯„è®ºåŠŸèƒ½ï¼Œç›´æ¥è¿”å›ç©ºè¯„è®ºåˆ—è¡¨</span></span><br><span class="line">        <span class="keyword">if</span> (videoInfo.getInteraction() != <span class="literal">null</span> &amp;&amp; videoInfo.getInteraction().contains(Constants.ONE.toString())) &#123;</span><br><span class="line">            <span class="keyword">return</span> getSuccessResponseVO(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. åˆ›å»ºè¯„è®ºæŸ¥è¯¢å¯¹è±¡</span></span><br><span class="line">        <span class="type">VideoCommentQuery</span> <span class="variable">commentQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoCommentQuery</span>();</span><br><span class="line">        commentQuery.setVideoId(videoId);</span><br><span class="line">        commentQuery.setLoadChildren(<span class="literal">true</span>);  <span class="comment">// è®¾ç½®åŠ è½½å­è¯„è®º</span></span><br><span class="line">        commentQuery.setPageNo(pageNo);  <span class="comment">// è®¾ç½®å½“å‰é¡µ</span></span><br><span class="line">        commentQuery.setPageSize(PageSize.SIZE15.getSize());  <span class="comment">// è®¾ç½®æ¯é¡µå±•ç¤ºçš„è¯„è®ºæ•°</span></span><br><span class="line">        commentQuery.setpCommentId(<span class="number">0</span>);  <span class="comment">// åªæŸ¥è¯¢ä¸»è¯„è®º</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. è®¾ç½®æ’åºæ–¹å¼ï¼šæ ¹æ®ç‚¹èµæ•°é™åºæ’åºï¼Œè‹¥æ²¡æœ‰æ’åºæ¡ä»¶åˆ™æŒ‰è¯„è®ºIDé™åº</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">orderBy</span> <span class="operator">=</span> orderType == <span class="literal">null</span> || orderType == <span class="number">0</span> ? <span class="string">&quot;like_count desc,comment_id desc&quot;</span> : <span class="string">&quot;comment_id desc&quot;</span>;</span><br><span class="line">        commentQuery.setOrderBy(orderBy);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. æŸ¥è¯¢è¯„è®ºæ•°æ®</span></span><br><span class="line">        PaginationResultVO&lt;VideoComment&gt; commentData = videoCommentService.findListByPage(commentQuery);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. ç½®é¡¶è¯„è®ºï¼šå¦‚æœæ˜¯ç¬¬ä¸€é¡µï¼ŒæŸ¥è¯¢å¹¶å°†ç½®é¡¶è¯„è®ºæ”¾åˆ°è¯„è®ºåˆ—è¡¨æœ€å‰é¢</span></span><br><span class="line">        <span class="keyword">if</span> (pageNo == <span class="literal">null</span> || pageNo == <span class="number">1</span>) &#123;</span><br><span class="line">            List&lt;VideoComment&gt; topCommentList = topComment(videoId);</span><br><span class="line">            <span class="keyword">if</span> (!topCommentList.isEmpty()) &#123;</span><br><span class="line">                <span class="comment">// æ’é™¤å·²ç»åŒ…å«çš„ç½®é¡¶è¯„è®ºï¼Œå†å°†ç½®é¡¶è¯„è®ºåŠ åˆ°è¯„è®ºåˆ—è¡¨å‰é¢</span></span><br><span class="line">                List&lt;VideoComment&gt; commentList =</span><br><span class="line">                        commentData.getList().stream()</span><br><span class="line">                                .filter(item -&gt; !item.getCommentId().equals(topCommentList.get(<span class="number">0</span>).getCommentId()))</span><br><span class="line">                                .collect(Collectors.toList());</span><br><span class="line">                commentList.addAll(<span class="number">0</span>, topCommentList);  <span class="comment">// å°†ç½®é¡¶è¯„è®ºæ”¾åˆ°æœ€å‰é¢</span></span><br><span class="line">                commentData.setList(commentList);  <span class="comment">// æ›´æ–°è¯„è®ºåˆ—è¡¨</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7. è¿”å›è¯„è®ºæ•°æ®å’Œç”¨æˆ·è¡Œä¸ºæ•°æ®</span></span><br><span class="line">        <span class="type">VideoCommentResultVO</span> <span class="variable">resultVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoCommentResultVO</span>();</span><br><span class="line">        resultVO.setCommentData(commentData);  <span class="comment">// è®¾ç½®è¯„è®ºæ•°æ®</span></span><br><span class="line"></span><br><span class="line">        List&lt;UserAction&gt; userActionList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">TokenUserInfoDto</span> <span class="variable">tokenUserInfoDto</span> <span class="operator">=</span> getTokenUserInfoDto();  <span class="comment">// è·å–å½“å‰ç”¨æˆ·çš„ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">if</span> (tokenUserInfoDto != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">UserActionQuery</span> <span class="variable">userActionQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserActionQuery</span>();</span><br><span class="line">            userActionQuery.setUserId(tokenUserInfoDto.getUserId());</span><br><span class="line">            userActionQuery.setVideoId(videoId);</span><br><span class="line">            userActionQuery.setActionTypeArray(<span class="keyword">new</span> <span class="title class_">Integer</span>[]&#123;</span><br><span class="line">                    UserActionTypeEnum.COMMENT_LIKE.getType(),</span><br><span class="line">                    UserActionTypeEnum.COMMENT_HATE.getType()</span><br><span class="line">            &#125;);</span><br><span class="line">            userActionList = userActionService.findListByParam(userActionQuery);  <span class="comment">// æŸ¥è¯¢ç”¨æˆ·çš„è¡Œä¸ºæ•°æ®ï¼ˆç‚¹èµ/è®¨åŒï¼‰</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        resultVO.setUserActionList(userActionList);  <span class="comment">// è®¾ç½®ç”¨æˆ·è¡Œä¸ºæ•°æ®</span></span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(resultVO);  <span class="comment">// è¿”å›æˆåŠŸå“åº”ï¼ŒåŒ…å«è¯„è®ºå’Œç”¨æˆ·è¡Œä¸ºæ•°æ®</span></span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–æŒ‡å®šè§†é¢‘çš„ç½®é¡¶è¯„è®ºåˆ—è¡¨</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> videoId è§†é¢‘ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æŒ‡å®šè§†é¢‘çš„ç½®é¡¶è¯„è®ºåˆ—è¡¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;VideoComment&gt; <span class="title function_">topComment</span><span class="params">(String videoId)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºè¯„è®ºæŸ¥è¯¢å¯¹è±¡ï¼ŒæŸ¥è¯¢ç½®é¡¶çš„è¯„è®º</span></span><br><span class="line">        <span class="type">VideoCommentQuery</span> <span class="variable">commentQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoCommentQuery</span>();</span><br><span class="line">        commentQuery.setVideoId(videoId);</span><br><span class="line">        commentQuery.setTopType(CommentTopTypeEnum.TOP.getType());  <span class="comment">// è®¾ç½®æŸ¥è¯¢æ¡ä»¶ï¼šç½®é¡¶è¯„è®º</span></span><br><span class="line">        commentQuery.setLoadChildren(<span class="literal">true</span>);  <span class="comment">// åŠ è½½å­è¯„è®º</span></span><br><span class="line">        <span class="comment">// æŸ¥è¯¢å¹¶è¿”å›ç½®é¡¶è¯„è®ºåˆ—è¡¨</span></span><br><span class="line">        List&lt;VideoComment&gt; videoCommentList = videoCommentService.findListByParam(commentQuery);</span><br><span class="line">        <span class="keyword">return</span> videoCommentList;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><code>loadComment</code>æ¥å£æ­¥éª¤</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-991.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-992.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-993.png" alt="img"></p>
<p>æµ‹è¯•</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-983-1024x303.png" alt="img"></p>
<h3 id="3-è¯„è®ºè¡Œä¸ºçš„å®ç°">3.è¯„è®ºè¡Œä¸ºçš„å®ç°</h3>
<p>å¯¹åŒä¸€æ¡è¯„è®ºï¼Œ<strong>åŒä¸€ç”¨æˆ·</strong>åªèƒ½å¤„äºä¸‰ç§çŠ¶æ€ä¹‹ä¸€ï¼š</p>
<ul>
<li>æœªæ“ä½œï¼›</li>
<li>ç‚¹èµï¼›</li>
<li>ä¸å–œæ¬¢ï¼ˆè¸©ï¼‰ã€‚</li>
</ul>
<p>å¹¶ä¸”ï¼š</p>
<ul>
<li>å†æ¬¡ç‚¹å‡»<strong>åŒä¸€æŒ‰é’®</strong> â†’ å–æ¶ˆè¯¥åŠ¨ä½œï¼ˆè®¡æ•°å›æ»šï¼‰ã€‚</li>
<li>ä»â€œç‚¹èµâ€åˆ‡æ¢åˆ°â€œè¸©â€ï¼ˆæˆ–åä¹‹ï¼‰ â†’ <strong>ä¸¤è¾¹äº’æ–¥</strong>ï¼šæ–°å¢ä¸€è¾¹ã€åˆ é™¤å¦ä¸€è¾¹ã€ä¸¤è¾¹è®¡æ•°åŒæ—¶è°ƒæ•´ã€‚</li>
</ul>
<p>åœ¨UserActionServicceImplä¸­åŠ ä¸Šè¯„è®ºçš„è¡Œä¸ºå®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯„è®ºç±»è¡Œä¸ºï¼šç‚¹èµ / è®¨åŒ</span></span><br><span class="line">           <span class="keyword">case</span> COMMENT_LIKE:</span><br><span class="line">           <span class="keyword">case</span> COMMENT_HATE:</span><br><span class="line">               <span class="comment">// 1) è®¡ç®—â€œå¯¹ç«‹è¡Œä¸ºç±»å‹â€ï¼ˆç‚¹èµ çš„å¯¹ç«‹æ˜¯ è®¨åŒï¼›è®¨åŒ çš„å¯¹ç«‹æ˜¯ ç‚¹èµï¼‰</span></span><br><span class="line">               <span class="type">UserActionTypeEnum</span> <span class="variable">opposeTypeEnum</span> <span class="operator">=</span></span><br><span class="line">                       (actionTypeEnum == UserActionTypeEnum.COMMENT_LIKE)</span><br><span class="line">                               ? UserActionTypeEnum.COMMENT_HATE</span><br><span class="line">                               : UserActionTypeEnum.COMMENT_LIKE;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// 2) æŸ¥å‡ºâ€œå¯¹ç«‹è¡Œä¸ºâ€æ˜¯å¦å­˜åœ¨ï¼ˆåŒä¸€ç”¨æˆ·ã€åŒä¸€è§†é¢‘ã€åŒä¸€è¯„è®ºï¼‰</span></span><br><span class="line">               <span class="type">UserAction</span> <span class="variable">opposeAction</span> <span class="operator">=</span> userActionMapper</span><br><span class="line">                       .selectByVideoIdAndCommentIdAndActionTypeAndUserId(</span><br><span class="line">                               bean.getVideoId(),            <span class="comment">// è§†é¢‘</span></span><br><span class="line">                               bean.getCommentId(),          <span class="comment">// è¯„è®º</span></span><br><span class="line">                               opposeTypeEnum.getType(),     <span class="comment">// å¯¹ç«‹åŠ¨ä½œç±»å‹</span></span><br><span class="line">                               bean.getUserId());            <span class="comment">// å½“å‰ç”¨æˆ·</span></span><br><span class="line"></span><br><span class="line">               <span class="comment">// å¦‚æœâ€œå¯¹ç«‹è¡Œä¸ºâ€å­˜åœ¨ï¼Œå…ˆåˆ æ‰å®ƒï¼ˆä¿æŒäº’æ–¥ï¼‰</span></span><br><span class="line">               <span class="keyword">if</span> (opposeAction != <span class="literal">null</span>) &#123;</span><br><span class="line">                   userActionMapper.deleteByActionId(opposeAction.getActionId());</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// 3) æŸ¥è¯¢â€œæœ¬æ¬¡åŠ¨ä½œâ€æ˜¯å¦å·²å­˜åœ¨ï¼ˆç”¨äºâ€œäºŒæ¬¡ç‚¹å‡»å–æ¶ˆâ€ï¼‰</span></span><br><span class="line">                dbAction = userActionMapper</span><br><span class="line">                       .selectByVideoIdAndCommentIdAndActionTypeAndUserId(</span><br><span class="line">                               bean.getVideoId(),</span><br><span class="line">                               bean.getCommentId(),</span><br><span class="line">                               actionTypeEnum.getType(),     <span class="comment">// æœ¬æ¬¡åŠ¨ä½œç±»å‹</span></span><br><span class="line">                               bean.getUserId());</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (dbAction != <span class="literal">null</span>) &#123;</span><br><span class="line">                   <span class="comment">// å·²ç‚¹è¿‡åŒä¸€åŠ¨ä½œ -&gt; æœ¬æ¬¡æ“ä½œç­‰äºâ€œå–æ¶ˆâ€è¯¥åŠ¨ä½œ</span></span><br><span class="line">                   userActionMapper.deleteByActionId(dbAction.getActionId());</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="comment">// é¦–æ¬¡ç‚¹å‡»è¯¥åŠ¨ä½œ -&gt; æ’å…¥è¡Œä¸ºè®°å½•</span></span><br><span class="line">                   userActionMapper.insert(bean);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// 4) è®¡ç®—è®¡æ•°å˜åŒ–é‡ï¼š</span></span><br><span class="line">               <span class="comment">//    - å¦‚æœæ˜¯â€œé¦–æ¬¡ç‚¹å‡»â€ï¼šæœ¬åŠ¨ä½œ +1ï¼›</span></span><br><span class="line">               <span class="comment">//    - å¦‚æœæ˜¯â€œå–æ¶ˆç‚¹å‡»â€ï¼šæœ¬åŠ¨ä½œ -1ï¼›</span></span><br><span class="line">                changeCount = (dbAction == <span class="literal">null</span>) ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">               <span class="comment">//    - è‹¥å­˜åœ¨â€œå¯¹ç«‹è¡Œä¸ºâ€ï¼Œæ„å‘³ç€è¿™æ¬¡ä»å¯¹ç«‹åŠ¨ä½œåˆ‡æ¢è¿‡æ¥ï¼Œ</span></span><br><span class="line">               <span class="comment">//      éœ€è¦æŠŠâ€œå¯¹ç«‹åŠ¨ä½œè®¡æ•°â€åšä¸€ä¸ªç›¸åçš„å˜æ›´ï¼ˆ+1 çš„åå‘æ˜¯ -1ï¼‰</span></span><br><span class="line">               <span class="type">Integer</span> <span class="variable">opposeChangeCount</span> <span class="operator">=</span> changeCount * -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// 5) ä¸€æ¬¡ SQL åŒæ­¥æ›´æ–°è¯„è®ºä¸Šçš„ä¸¤ä¸ªè®¡æ•°å­—æ®µï¼ˆæœ¬åŠ¨ä½œå­—æ®µ + å¯¹ç«‹å­—æ®µï¼‰</span></span><br><span class="line">               videoCommentMapper.updateCountInfo(</span><br><span class="line">                       bean.getCommentId(),             <span class="comment">// å“ªæ¡è¯„è®º</span></span><br><span class="line">                       actionTypeEnum.getField(),       <span class="comment">// æœ¬åŠ¨ä½œå¯¹åº”çš„è®¡æ•°å­—æ®µåï¼ˆlike_count / hate_countï¼‰</span></span><br><span class="line">                       changeCount,                     <span class="comment">// æœ¬åŠ¨ä½œå˜æ›´é‡</span></span><br><span class="line">                       (opposeAction == <span class="literal">null</span>) ? <span class="literal">null</span> :  <span class="comment">// å¯¹ç«‹å­—æ®µï¼šåªæœ‰å½“â€œå¯¹ç«‹è¡Œä¸ºå­˜åœ¨â€æ—¶æ‰éœ€è¦å›æ»š</span></span><br><span class="line">                               opposeTypeEnum.getField(),</span><br><span class="line">                       opposeChangeCount);              <span class="comment">// å¯¹ç«‹å­—æ®µçš„åå‘å˜æ›´é‡</span></span><br><span class="line">               <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-995.png" alt="img"></p>
<p>å…¶ä¸­åœ¨VideoCommentMapperä¸­åŠ å…¥updateCountInfoæ–¹æ³•</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * æ›´æ–°ç‚¹èµæ•°å’Œè¸©æ•°</span></span><br><span class="line"><span class="comment">	 * @param commentId</span></span><br><span class="line"><span class="comment">	 * @param field</span></span><br><span class="line"><span class="comment">	 * @param changeCount</span></span><br><span class="line"><span class="comment">	 * @param opposeField</span></span><br><span class="line"><span class="comment">	 * @param opposeChangeCount</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="selector-tag">void</span> <span class="selector-tag">updateCountInfo</span>(<span class="variable">@Param</span>(<span class="string">&quot;commentId&quot;</span>) Integer commentId,</span><br><span class="line">						 <span class="variable">@Param</span>(<span class="string">&quot;field&quot;</span>) String field, <span class="variable">@Param</span>(<span class="string">&quot;changeCount&quot;</span>) Integer changeCount,</span><br><span class="line">						 <span class="variable">@Param</span>(<span class="string">&quot;opposeField&quot;</span>) String opposeField, <span class="variable">@Param</span>(<span class="string">&quot;opposeChangeCount&quot;</span>) Integer opposeChangeCount);</span><br></pre></td></tr></table></figure>
<p>xmlä¸­</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!-- æ›´æ–°ç‚¹èµæ•°å’Œè¸©æ•°--&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateCountInfo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	update video_comment set $</span><span class="template-variable">&#123;field&#125;</span><span class="language-xml"> = $</span><span class="template-variable">&#123;field&#125;</span><span class="language-xml">+#</span><span class="template-variable">&#123;changeCount&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;opposeField!=null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">		,$</span><span class="template-variable">&#123;opposeField&#125;</span><span class="language-xml"> = $</span><span class="template-variable">&#123;opposeField&#125;</span><span class="language-xml">+#</span><span class="template-variable">&#123;opposeChangeCount&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	where comment_id = #</span><span class="template-variable">&#123;commentId&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-996-795x1024.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-997.png" alt="img"></p>
<p>æµ‹è¯•ï¼šå¦‚å›¾ç‚¹èµæˆ–ä¸å–œæ¬¢é€»è¾‘å®ç°</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-994-1024x447.png" alt="img"></p>
<h3 id="4-ç”¨æˆ·å¯ä»¥åˆ é™¤è‡ªå·±å‘çš„è¯„è®ºï¼Œupä¸»å¯ä»¥å¯¹è¯„è®ºè¿›è¡Œåˆ é™¤å’Œç½®é¡¶">4.ç”¨æˆ·å¯ä»¥åˆ é™¤è‡ªå·±å‘çš„è¯„è®ºï¼Œupä¸»å¯ä»¥å¯¹è¯„è®ºè¿›è¡Œåˆ é™¤å’Œç½®é¡¶</h3>
<p>VideoCommentControlleræ·»åŠ è¿™3ä¸ªæ¥å£ï¼šåˆ é™¤è¯„è®ºæ¥å£ï¼Œupä¸»ç½®é¡¶è¯„è®ºæ¥å£ï¼Œupå–æ¶ˆç½®é¡¶è¯„è®ºæ¥å£</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-998-1024x430.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-999.png" alt="img"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ é™¤è¯„è®ºæ¥å£</span></span><br><span class="line"><span class="comment">     * è¯¥æ¥å£ç”¨äºç”¨æˆ·åˆ é™¤æŒ‡å®šçš„è¯„è®ºï¼Œé€šè¿‡è¯„è®ºIDè¿›è¡Œåˆ é™¤æ“ä½œï¼Œå¹¶è¿”å›æ“ä½œç»“æœã€‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> commentId è¦åˆ é™¤çš„è¯„è®ºIDï¼Œä¸èƒ½ä¸ºç©º</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è¿”å›æ“ä½œç»“æœçš„ResponseVOå¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">        <span class="meta">@RequestMapping(&quot;/userDelComment&quot;)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ResponseVO <span class="title function_">userDelComment</span><span class="params">(<span class="meta">@NotNull</span> Integer commentId)</span> &#123;</span><br><span class="line">        <span class="type">TokenUserInfoDto</span> <span class="variable">tokenUserInfoDto</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line">        <span class="type">VideoComment</span> <span class="variable">comment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoComment</span>();</span><br><span class="line">        videoCommentService.deleteComment(commentId, tokenUserInfoDto.getUserId());</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(comment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * upä¸»ç½®é ‚è¯„è®º</span></span><br><span class="line"><span class="comment">     * é€šè¿‡è¯„è®ºIDè·å–å¯¹åº”çš„é¡¶çº§è¯„è®ºä¿¡æ¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> commentId è¯„è®ºIDï¼Œç”¨äºæŒ‡å®šè·å–å“ªä¸ªè¯„è®ºçš„é¡¶çº§è¯„è®º</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> æˆåŠŸçš„å“åº”å¯¹è±¡ï¼ŒåŒ…å«é¡¶çº§è¯„è®ºä¿¡æ¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/topComment&quot;)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ResponseVO <span class="title function_">topComment</span><span class="params">(<span class="meta">@NotNull</span> Integer commentId)</span> &#123;</span><br><span class="line">        <span class="type">TokenUserInfoDto</span> <span class="variable">tokenUserInfoDto</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line">        videoCommentService.topComment(commentId, tokenUserInfoDto.getUserId());</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å–æ¶ˆç½®é¡¶è¯„è®º</span></span><br><span class="line"><span class="comment">     * è¯¥æ¥å£ç”¨äºå–æ¶ˆæŸä¸ªè¯„è®ºçš„ç½®é¡¶çŠ¶æ€ï¼Œéœ€è¦ä¼ å…¥è¯„è®ºIDä»¥åŠç”¨æˆ·ä¿¡æ¯ã€‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> commentId è¦å–æ¶ˆç½®é¡¶çš„è¯„è®ºID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è¿”å›æ“ä½œç»“æœçš„ResponseVOå¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/cancelTopComment&quot;)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ResponseVO <span class="title function_">cancelTopComment</span><span class="params">(<span class="meta">@NotNull</span> Integer commentId)</span> &#123;</span><br><span class="line">        <span class="type">TokenUserInfoDto</span> <span class="variable">tokenUserInfoDto</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line">        videoCommentService.cancelTopComment(commentId, tokenUserInfoDto.getUserId());</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨Serviceå®šä¹‰è¿™ä¸‰ä¸ªæ–¹æ³•</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ é™¤è¯„è®º</span></span><br><span class="line"><span class="comment"> * @param commentId</span></span><br><span class="line"><span class="comment"> * @param userId</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">deleteComment</span><span class="params">(Integer commentId, <span class="type">String</span> userId)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç½®é¡¶è¯„è®º</span></span><br><span class="line"><span class="comment"> * @param commentId</span></span><br><span class="line"><span class="comment"> * @param userId</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">topComment</span><span class="params">(Integer commentId, <span class="type">String</span> userId)</span></span>;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å–æ¶ˆç½®é¡¶è¯„è®º</span></span><br><span class="line"><span class="comment">    * @param commentId</span></span><br><span class="line"><span class="comment">    * @param userId</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cancelTopComment</span><span class="params">(Integer commentId, <span class="type">String</span> userId)</span></span>;</span><br></pre></td></tr></table></figure>
<p>åœ¨Implä¸­å…·ä½“å®ç°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VideoCommentServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">VideoCommentService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> VideoCommentMapper videoCommentMapper;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> VideoInfoMapper videoInfoMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ é™¤è¯„è®ºï¼š</span></span><br><span class="line"><span class="comment">     * 1) æ‰¾è¯„è®º &amp; æ‰€å±è§†é¢‘</span></span><br><span class="line"><span class="comment">     * 2) æƒé™ï¼šUP ä¸»æˆ–è¯„è®ºä½œè€…</span></span><br><span class="line"><span class="comment">     * 3) åˆ é™¤è¯„è®ºï¼›è‹¥ä¸ºé¡¶çº§è¯„ï¼Œå†åˆ å­è¯„å¹¶æŠŠè§†é¢‘ comment_count - 1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteComment</span><span class="params">(Integer commentId, String userId)</span> &#123;</span><br><span class="line">        <span class="comment">// 1) æŸ¥è¯„è®º</span></span><br><span class="line">        <span class="type">VideoComment</span> <span class="variable">comment</span> <span class="operator">=</span> videoCommentMapper.selectByCommentId(commentId);</span><br><span class="line">        <span class="keyword">if</span> (comment == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600); <span class="comment">// éæ³• commentId</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2) æŸ¥è§†é¢‘</span></span><br><span class="line">        <span class="type">VideoInfo</span> <span class="variable">videoInfo</span> <span class="operator">=</span> videoInfoMapper.selectByVideoId(comment.getVideoId());</span><br><span class="line">        <span class="keyword">if</span> (videoInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600); <span class="comment">// è„æ•°æ®ä¿æŠ¤</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3) æƒé™åˆ¤æ–­ï¼šæ“ä½œè€…å¿…é¡»æ˜¯ UP ä¸» æˆ– è¯„è®ºä½œè€…æœ¬äºº</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isVideoOwner</span> <span class="operator">=</span> videoInfo.getUserId().equals(userId);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isCommentOwner</span> <span class="operator">=</span> comment.getUserId().equals(userId);</span><br><span class="line">        <span class="keyword">if</span> (!isVideoOwner &amp;&amp; !isCommentOwner) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600); <span class="comment">// æ— æƒåˆ é™¤</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4) ç‰©ç†åˆ é™¤è¯„è®º</span></span><br><span class="line">        videoCommentMapper.deleteByCommentId(commentId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5) è‹¥æ˜¯â€œé¡¶çº§è¯„è®ºâ€ï¼Œé¢å¤–å¤„ç†ï¼šcomment_count - 1 &amp; åˆ é™¤æ‰€æœ‰å­è¯„</span></span><br><span class="line">        <span class="keyword">if</span> (comment.getpCommentId() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// é¡¹ç›®å£å¾„ï¼šåªç»Ÿè®¡é¡¶çº§è¯„è®º â†’ -1</span></span><br><span class="line">            videoInfoMapper.updateCountInfo(</span><br><span class="line">                videoInfo.getVideoId(),</span><br><span class="line">                UserActionTypeEnum.VIDEO_COMMENT.getField(), <span class="comment">// comment_count</span></span><br><span class="line">                -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åˆ é™¤å…¶æ‰€æœ‰å­è¯„ï¼ˆp_comment_id = commentIdï¼‰</span></span><br><span class="line">            <span class="type">VideoCommentQuery</span> <span class="variable">q</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoCommentQuery</span>();</span><br><span class="line">            q.setpCommentId(commentId);</span><br><span class="line">            videoCommentMapper.deleteByParam(q);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç½®é¡¶è¯„è®ºï¼š</span></span><br><span class="line"><span class="comment">     * - ä»… UP ä¸»å…è®¸</span></span><br><span class="line"><span class="comment">     * - å…ˆå–æ¶ˆæœ¬è§†é¢‘ä¸‹å·²æœ‰ç½®é¡¶ï¼ˆé˜²å¤šæ¡ç½®é¡¶ï¼‰</span></span><br><span class="line"><span class="comment">     * - å†å°†ç›®æ ‡è¯„è®ºè®¾ä¸ºç½®é¡¶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">topComment</span><span class="params">(Integer commentId, String userId)</span> &#123;</span><br><span class="line">        <span class="comment">// ç½®é¡¶ä¹‹å‰ï¼šä¼šå…ˆè°ƒç”¨å–æ¶ˆç½®é¡¶ï¼Œå†…éƒ¨ä¼šåš UP ä¸»æ ¡éªŒ</span></span><br><span class="line">        <span class="built_in">this</span>.cancelTopComment(commentId, userId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†ç›®æ ‡è¯„è®ºè®¾ä¸ºç½®é¡¶</span></span><br><span class="line">        <span class="type">VideoComment</span> <span class="variable">videoComment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoComment</span>();</span><br><span class="line">        videoComment.setTopType(CommentTopTypeEnum.TOP.getType()); <span class="comment">// 1</span></span><br><span class="line">        videoCommentMapper.updateByCommentId(videoComment, commentId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å–æ¶ˆç½®é¡¶ï¼š</span></span><br><span class="line"><span class="comment">     * - ä»… UP ä¸»å…è®¸</span></span><br><span class="line"><span class="comment">     * - æ ¹æ® commentId æ‰¾åˆ°æ‰€å±è§†é¢‘</span></span><br><span class="line"><span class="comment">     * - å°†è¯¥è§†é¢‘ä¸‹æ‰€æœ‰ top_type=1 çš„è¯„è®ºæ‰¹é‡æ”¹ä¸º 0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cancelTopComment</span><span class="params">(Integer commentId, String userId)</span> &#123;</span><br><span class="line">        <span class="comment">// 1) å–ç›®æ ‡è¯„è®º â†’ æ‹¿åˆ° videoId</span></span><br><span class="line">        <span class="type">VideoComment</span> <span class="variable">db</span> <span class="operator">=</span> videoCommentMapper.selectByCommentId(commentId);</span><br><span class="line">        <span class="keyword">if</span> (db == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2) æ ¡éªŒ UP ä¸»æƒé™</span></span><br><span class="line">        <span class="type">VideoInfo</span> <span class="variable">videoInfo</span> <span class="operator">=</span> videoInfoMapper.selectByVideoId(db.getVideoId());</span><br><span class="line">        <span class="keyword">if</span> (videoInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!videoInfo.getUserId().equals(userId)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600); <span class="comment">// ä»…è§†é¢‘ä½œè€…å¯æ“ä½œ</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3) æ‰¹é‡æŠŠæœ¬è§†é¢‘ä¸‹æ‰€æœ‰ç½®é¡¶æ ‡è®°æ¸…ç©º</span></span><br><span class="line">        <span class="type">VideoComment</span> <span class="variable">toUpdate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoComment</span>();</span><br><span class="line">        toUpdate.setTopType(CommentTopTypeEnum.NO_TOP.getType()); <span class="comment">// 0</span></span><br><span class="line"></span><br><span class="line">        <span class="type">VideoCommentQuery</span> <span class="variable">where</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoCommentQuery</span>();</span><br><span class="line">        where.setVideoId(db.getVideoId());</span><br><span class="line">        where.setTopType(CommentTopTypeEnum.TOP.getType()); <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç­‰ä»· SQL: update video_comment set top_type=0 where video_id=? and top_type=1</span></span><br><span class="line">        videoCommentMapper.updateByParam(toUpdate, where);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>XML ç»†èŠ‚</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!-- åˆ é™¤å•æ¡è¯„è®º --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteByCommentId&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  DELETE FROM video_comment WHERE comment_id = #</span><span class="template-variable">&#123;commentId&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="comment">&lt;!-- æ‰¹é‡åˆ é™¤å­è¯„ --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteByParam&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  DELETE FROM video_comment</span></span><br><span class="line"><span class="language-xml">  WHERE 1=1</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.pCommentId != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      AND p_comment_id = #</span><span class="template-variable">&#123;query.pCommentId&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="comment">&lt;!-- æ ¹æ® commentId æ›´æ–°ï¼ˆç½®é¡¶/å–æ¶ˆç½®é¡¶ï¼‰ --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateByCommentId&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  UPDATE video_comment</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">set</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;record.topType != null&quot;</span>&gt;</span> top_type = #</span><span class="template-variable">&#123;record.topType&#125;</span><span class="language-xml">, <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!-- å…¶ä»–å¯æ›´æ–°å­—æ®µ... --&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  WHERE comment_id = #</span><span class="template-variable">&#123;commentId&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="comment">&lt;!-- æ‰¹é‡æ¸…ç©ºæœ¬è§†é¢‘ç½®é¡¶ --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateByParam&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  UPDATE video_comment</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">set</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;record.topType != null&quot;</span>&gt;</span> top_type = #</span><span class="template-variable">&#123;record.topType&#125;</span><span class="language-xml"> <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  WHERE 1=1</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.videoId != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      AND video_id = #</span><span class="template-variable">&#123;query.videoId&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.topType != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      AND top_type = #</span><span class="template-variable">&#123;query.topType&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="comment">&lt;!-- è§†é¢‘è¯„è®ºç»Ÿè®¡å˜æ›´ï¼ˆè¯¦è§ä½ é¡¹ç›®é‡Œçš„ video_info.updateCountInfoï¼‰ --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateCountInfo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  UPDATE video_info</span></span><br><span class="line"><span class="language-xml">  SET $</span><span class="template-variable">&#123;field&#125;</span><span class="language-xml"> = $</span><span class="template-variable">&#123;field&#125;</span><span class="language-xml"> + #</span><span class="template-variable">&#123;changeCount&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  WHERE video_id = #</span><span class="template-variable">&#123;videoId&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>å…³é”®ç‚¹ï¼š</p>
<ul>
<li><strong>åˆ é™¤é¡¶çº§è¯„è®º</strong>æ—¶è®°å¾—<strong>é¡ºå¸¦åˆ é™¤å­è¯„</strong>ï¼Œå¹¶æŠŠ <code>comment_count - 1</code>ã€‚</li>
<li><strong>ç½®é¡¶</strong>ç”¨äº‹åŠ¡åŒ…è£¹ï¼šâ€œå–æ¶ˆæ—§ç½®é¡¶ â†’ è®¾ç½®æ–°ç½®é¡¶â€ä¸€å¹¶æäº¤ï¼Œé¿å…å¹¶å‘ä¸‹å‡ºç°ä¸¤æ¡ç½®é¡¶ã€‚</li>
<li><strong>æƒé™</strong>å®Œå…¨åœ¨ Service æ ¡éªŒï¼ŒController ä¸åšè¶Šæƒåˆ¤æ–­ã€‚</li>
<li>å¯é€‰åŠ å¼ºï¼šåªå…è®¸å¯¹<strong>é¡¶çº§è¯„è®º</strong>ç½®é¡¶ï¼ˆ<code>p_comment_id==0</code>ï¼‰ï¼Œé¿å…æŠŠå­è¯„ç½®é¡¶åˆ°åˆ—è¡¨é¡¶éƒ¨ã€‚</li>
</ul>
<p>æµ‹è¯•ï¼šå–æ¶ˆç½®é¡¶å’Œç½®é¡¶ï¼Œåˆ é™¤æ¶ˆæ¯éƒ½æ²¡æœ‰é—®é¢˜</p>
<h2 id="13-è§†é¢‘åœ¨çº¿äººæ•°">13.è§†é¢‘åœ¨çº¿äººæ•°</h2>
<p>è§†é¢‘åœ¨çº¿äººæ•°ç»Ÿè®¡ï¼ˆå¿ƒè·³ + è¿‡æœŸç›‘å¬ï¼‰</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1001-1024x446.png" alt="img"></p>
<p>åœ¨Constantså®šä¹‰è¿™å‡ ä¸ªå¸¸é‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç”¨æˆ·æ’­æ”¾æ¬¡æ•°å‰ç¼€</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REDIS_KEY_VIDEO_PLAY_COUNT_USER_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;user:&quot;</span>;</span><br><span class="line">    <span class="comment">//è§†é¢‘åœ¨çº¿</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REDIS_KEY_VIDEO_PLAY_COUNT_ONLINE_PREIFX</span> <span class="operator">=</span> REDIS_KEY_PREFIX + <span class="string">&quot;video:play:online:&quot;</span>;</span><br><span class="line">    <span class="comment">//ç”¨æˆ·æ’­æ”¾æ¬¡æ•°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REDIS_KEY_VIDEO_PLAY_COUNT_USER</span> <span class="operator">=</span> REDIS_KEY_VIDEO_PLAY_COUNT_ONLINE_PREIFX + REDIS_KEY_VIDEO_PLAY_COUNT_USER_PREFIX + <span class="string">&quot;%s:%s&quot;</span>;</span><br><span class="line">    <span class="comment">//è§†é¢‘åœ¨çº¿æ’­æ”¾æ¬¡æ•°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REDIS_KEY_VIDEO_PLAY_COUNT_ONLINE</span> <span class="operator">=</span> REDIS_KEY_VIDEO_PLAY_COUNT_ONLINE_PREIFX + <span class="string">&quot;count:%s&quot;</span>;</span><br><span class="line">    <span class="comment">//è¿‡æœŸæ—¶é—´1ç§’</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">REDIS_KEY_EXPIRES_ONE_SECONDS</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1004-1024x707.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1002-1024x447.png" alt="img"></p>
<p>åœ¨RedisCompoentä¸­å®šä¹‰è¿™ä¸ªæ–¹æ³•reportVideoPlayOnline</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * è®°å½•åœ¨çº¿äººæ•°</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> <span class="variable">fileId</span></span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> <span class="variable">deviceId</span></span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * å¿ƒè·³ä¸ŠæŠ¥ï¼šé¦–æ¬¡ä¸Šçº¿ +1ï¼Œå·²åœ¨çº¿åªç»­æœŸï¼›è¿”å›å½“å‰åœ¨çº¿æ€»æ•°</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">reportVideoPlayOnline</span>(<span class="params"><span class="title class_">String</span> fileId, <span class="title class_">String</span> deviceId</span>) &#123;</span><br><span class="line">     <span class="comment">// å•ç”¨æˆ·åœ¨çº¿æ ‡è®° keyï¼švideo:play:online:user:&#123;fileId&#125;:&#123;deviceId&#125;</span></span><br><span class="line">     <span class="title class_">String</span> userPlayOnlineKey = <span class="title class_">String</span>.<span class="title function_">format</span>(<span class="title class_">Constants</span>.<span class="property">REDIS_KEY_VIDEO_PLAY_COUNT_USER</span>, fileId, deviceId);</span><br><span class="line">     <span class="comment">// è§†é¢‘åœ¨çº¿æ€»æ•° keyï¼švideo:play:online:count:&#123;fileId&#125;</span></span><br><span class="line">     <span class="title class_">String</span> playOnlineCountKey = <span class="title class_">String</span>.<span class="title function_">format</span>(<span class="title class_">Constants</span>.<span class="property">REDIS_KEY_VIDEO_PLAY_COUNT_ONLINE</span>, fileId);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 1) é¦–æ¬¡å¿ƒè·³ï¼šè¿˜æ²¡æœ‰å•ç”¨æˆ·æ ‡è®° â†’ å†™æ ‡è®° &amp; åœ¨çº¿æ•° +1ï¼ˆå¹¶ç»™è®¡æ•°é”®è®¾ç½® TTLï¼‰</span></span><br><span class="line">     <span class="keyword">if</span> (!redisUtils.<span class="title function_">keyExists</span>(userPlayOnlineKey)) &#123;</span><br><span class="line">         <span class="comment">// å†™å…¥â€œç”¨æˆ·åœ¨çº¿æ ‡è®°â€ï¼Œæœ‰æ•ˆæœŸ ~8 ç§’ï¼ˆæ¯«ç§’å•ä½ï¼‰</span></span><br><span class="line">         redisUtils.<span class="title function_">setex</span>(userPlayOnlineKey, fileId, <span class="title class_">Constants</span>.<span class="property">REDIS_KEY_EXPIRES_ONE_SECONDS</span> * <span class="number">8</span>);</span><br><span class="line">         <span class="comment">// åœ¨çº¿äººæ•° +1ï¼›å¹¶ç»™åœ¨çº¿äººæ•°é”®ä¸€ä¸ª ~10 ç§’çš„è¿‡æœŸæ—¶é—´ï¼ˆé¦–æ¬¡å‡ºç°æ—¶è®¾ç½®ï¼‰</span></span><br><span class="line">         <span class="keyword">return</span> redisUtils.<span class="title function_">incrementex</span>(playOnlineCountKey, <span class="title class_">Constants</span>.<span class="property">REDIS_KEY_EXPIRES_ONE_SECONDS</span> * <span class="number">10</span>).<span class="title function_">intValue</span>();</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 2) éé¦–æ¬¡å¿ƒè·³ï¼šåªç»­æœŸï¼ˆå»¶é•¿æœ‰æ•ˆæœŸï¼‰ï¼Œä¸å† +1</span></span><br><span class="line">     <span class="comment">// ç»™åœ¨çº¿äººæ•°é”®ç»­æœŸï¼Œé¿å…åœ¨æ‰€æœ‰äººéƒ½è¿˜æ´»è·ƒæ—¶è®¡æ•°é”®å…ˆè¿‡æœŸ</span></span><br><span class="line">     redisUtils.<span class="title function_">expire</span>(playOnlineCountKey, <span class="title class_">Constants</span>.<span class="property">REDIS_KEY_EXPIRES_ONE_SECONDS</span> * <span class="number">10</span>);</span><br><span class="line">     <span class="comment">// ç»™å½“å‰ç”¨æˆ·åœ¨çº¿æ ‡è®°ç»­æœŸ</span></span><br><span class="line">     redisUtils.<span class="title function_">expire</span>(userPlayOnlineKey, <span class="title class_">Constants</span>.<span class="property">REDIS_KEY_EXPIRES_ONE_SECONDS</span> * <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 3) è¿”å›å½“å‰åœ¨çº¿æ€»æ•°ï¼ˆè‹¥è®¡æ•°é”®åˆšå¥½ä¸å­˜åœ¨ï¼Œåˆ™è§†ä¸º 1ï¼‰</span></span><br><span class="line">     <span class="title class_">Integer</span> count = (<span class="title class_">Integer</span>) redisUtils.<span class="title function_">get</span>(playOnlineCountKey);</span><br><span class="line">     <span class="keyword">return</span> count == <span class="literal">null</span> ? <span class="number">1</span> : count;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/** ç›‘å¬è¿‡æœŸæ—¶ç”¨äº -1 çš„è¾…åŠ©æ–¹æ³• */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">decrementPlayOnlineCount</span>(<span class="params"><span class="title class_">String</span> key</span>) &#123;</span><br><span class="line">     <span class="comment">// ä½¿ç”¨å°è£…çš„ decrementï¼šå†…éƒ¨åš -1ï¼›è‹¥å°äºç­‰äº 0ï¼Œä¼šæ¸…ç†è¯¥ key</span></span><br><span class="line">     redisUtils.<span class="title function_">decrement</span>(key);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p><strong>è¦ç‚¹</strong>ï¼š</p>
<ul>
<li>é¦–æ¬¡è¡Œä¸ºç”¨ <code>keyExists â†’ setex â†’ incrementex</code> å®ç°â€œåªåŠ ä¸€æ¬¡â€ï¼›ç»­æœŸåª <code>expire</code>ã€‚</li>
<li>è¯»æ•°æ—¶è‹¥è®¡æ•°é”®ä¸å­˜åœ¨è¿”å› <code>1</code> çš„é€»è¾‘ï¼Œæ˜¯â€œåˆšåˆ›å»ºæ—¶å°šæœªè¯»åˆ°â€çš„å…œåº•ï¼›ä½ ä¹Ÿå¯ä»¥æ”¹æˆ <code>0</code>ï¼Œçœ‹å‰ç«¯å±•ç¤ºè¯‰æ±‚ã€‚</li>
</ul>
<p>åœ¨VideoControllerå®šä¹‰reportVideoPlayOnlineæ¥å£</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/reportVideoPlayOnline&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">reportVideoPlayOnline</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="title class_">String</span> fileId, <span class="title class_">String</span> deviceId</span>) &#123;</span><br><span class="line">    <span class="title class_">Integer</span> count = redisComponent.<span class="title function_">reportVideoPlayOnline</span>(fileId, deviceId);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1003-1024x714.png" alt="img"></p>
<p>åœ¨componentä¸­åˆ›å»ºRedisKeyExpirationListener</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisKeyExpirationListener</span> <span class="keyword">extends</span> <span class="title class_">KeyExpirationEventMessageListener</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisComponent redisComponent;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedisKeyExpirationListener</span><span class="params">(RedisMessageListenerContainer listenerContainer)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(listenerContainer); <span class="comment">// ä½¿ç”¨ä½ åœ¨ RedisConfig é‡Œæ³¨å†Œçš„å®¹å™¨</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Message message, <span class="type">byte</span>[] pattern)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> message.toString();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åªå¤„ç† ç”¨æˆ·åœ¨çº¿æ ‡è®° çš„è¿‡æœŸäº‹ä»¶ï¼Œä¸å¤„ç†å…¶ä»– key</span></span><br><span class="line">        <span class="keyword">if</span> (!key.startsWith(Constants.REDIS_KEY_VIDEO_PLAY_COUNT_ONLINE_PREIFX</span><br><span class="line">                + Constants.REDIS_KEY_VIDEO_PLAY_COUNT_USER_PREFIX)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è§£æè¿‡æœŸ key ä¸­çš„ fileIdï¼ˆæ ¼å¼ï¼š...user:&#123;fileId&#125;:&#123;deviceId&#125;ï¼‰</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">userKeyIndex</span> <span class="operator">=</span> key.indexOf(Constants.REDIS_KEY_VIDEO_PLAY_COUNT_USER_PREFIX)</span><br><span class="line">                + Constants.REDIS_KEY_VIDEO_PLAY_COUNT_USER_PREFIX.length();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿™é‡ŒæŒ‰å›ºå®šé•¿åº¦æˆªå– fileIdï¼ˆä½ å¸¸é‡é‡Œæ˜¯ 20 ä½ï¼‰</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileId</span> <span class="operator">=</span> key.substring(userKeyIndex, userKeyIndex + Constants.LENGTH_20);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¡ç®—åœ¨çº¿è®¡æ•° keyï¼Œå¹¶æ‰§è¡Œ -1</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">counterKey</span> <span class="operator">=</span> String.format(Constants.REDIS_KEY_VIDEO_PLAY_COUNT_ONLINE, fileId);</span><br><span class="line">        redisComponent.decrementPlayOnlineCount(counterKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å‰æ</strong>ï¼šRedis å¿…é¡»å¼€å¯<strong>é”®è¿‡æœŸäº‹ä»¶é€šçŸ¥</strong>ï¼ˆ<code>notify-keyspace-events</code> è‡³å°‘åŒ…å« <code>Ex</code>ï¼‰ï¼ŒSpring çš„ <code>RedisMessageListenerContainer</code> æ‰èƒ½æ”¶åˆ°è¿‡æœŸå›è°ƒã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1005.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1006-1024x923.png" alt="img"></p>
<p>æµ‹è¯•å¦‚å›¾ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1000-1024x544.png" alt="img"></p>
<h2 id="14-ä¸ªäººä¸­å¿ƒ">14.ä¸ªäººä¸­å¿ƒ</h2>
<h3 id="1-å»ºè¡¨">1.å»ºè¡¨</h3>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for user_video_series</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> `user_video_series`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_video_series`  (</span><br><span class="line">  `series_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">&#x27;åˆ—è¡¨ID&#x27;</span>,</span><br><span class="line">  `series_name` <span class="type">varchar</span>(<span class="number">100</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;åˆ—è¡¨åç§°&#x27;</span>,</span><br><span class="line">  `series_description` <span class="type">varchar</span>(<span class="number">200</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æè¿°&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ç”¨æˆ·ID&#x27;</span>,</span><br><span class="line">  `sort` tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æ’åº&#x27;</span>,</span><br><span class="line">  `update_time` <span class="type">timestamp</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æ›´æ–°æ—¶é—´&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (`series_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_user_id`(`user_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE = InnoDB AUTO_INCREMENT = <span class="number">7</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4 <span class="keyword">COLLATE</span> = utf8mb4_general_ci <span class="keyword">COMMENT</span> = <span class="string">&#x27;ç”¨æˆ·è§†é¢‘åºåˆ—å½’æ¡£&#x27;</span> ROW_FORMAT = DYNAMIC;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for user_video_series_video</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> `user_video_series_video`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_video_series_video`  (</span><br><span class="line">  `series_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;åˆ—è¡¨ID&#x27;</span>,</span><br><span class="line">  `video_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;è§†é¢‘ID&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ç”¨æˆ·ID&#x27;</span>,</span><br><span class="line">  `sort` tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æ’åº&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (`series_id`, `video_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE = InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4 <span class="keyword">COLLATE</span> = utf8mb4_general_ci ROW_FORMAT = DYNAMIC;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for user_focus</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> `user_focus`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_focus`  (</span><br><span class="line">  `user_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ç”¨æˆ·ID&#x27;</span>,</span><br><span class="line">  `focus_user_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ç”¨æˆ·ID&#x27;</span>,</span><br><span class="line">  `focus_time` datetime <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (`user_id`, `focus_user_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE = InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4 <span class="keyword">COLLATE</span> = utf8mb4_general_ci ROW_FORMAT = DYNAMIC;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1007-1024x859.png" alt="img"></p>
<p><strong>è¡¨ä¹‹é—´çš„å…³ç³»ï¼š</strong></p>
<ul>
<li>è¿™å¼ è¡¨ä¸»è¦è®°å½•ç”¨æˆ·åˆ›å»ºçš„è§†é¢‘ç³»åˆ—ä¿¡æ¯ï¼Œé€šå¸¸å’Œ**<code>user_video_series_video</code>**è¡¨é€šè¿‡ <code>series_id</code> å»ºç«‹è”ç³»ã€‚</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1008.png" alt="img"></p>
<p>æ€»ç»“</p>
<ol>
<li><strong><code>user_video_series</code></strong> è¡¨ç”¨äºå­˜å‚¨è§†é¢‘ç³»åˆ—çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ç³»åˆ—çš„åç§°ã€æè¿°ã€æ’åºç­‰ã€‚</li>
<li><strong><code>user_video_series_video</code></strong> è¡¨ç”¨äºå…³è”å…·ä½“çš„è§†é¢‘ä¸ç”¨æˆ·è§†é¢‘ç³»åˆ—ï¼Œè¡¨ç¤ºä¸€ä¸ªè§†é¢‘ç³»åˆ—åŒ…å«äº†å“ªäº›è§†é¢‘ä»¥åŠè§†é¢‘åœ¨ç³»åˆ—ä¸­çš„æ’åºã€‚</li>
</ol>
<p><strong>å®é™…åº”ç”¨</strong>ï¼š</p>
<ul>
<li>ç”¨æˆ·å¯ä»¥åˆ›å»ºå¤šä¸ªè§†é¢‘ç³»åˆ—ï¼Œå¹¶å°†å¤šä¸ªè§†é¢‘æ·»åŠ åˆ°è¿™äº›ç³»åˆ—ä¸­ã€‚</li>
<li>é€šè¿‡ <strong><code>user_video_series</code></strong> è¡¨ï¼Œç³»ç»Ÿå¯ä»¥è·å¾—æ¯ä¸ªè§†é¢‘ç³»åˆ—çš„è¯¦ç»†ä¿¡æ¯ã€‚</li>
<li>é€šè¿‡ <strong><code>user_video_series_video</code></strong> è¡¨ï¼Œç³»ç»Ÿå¯ä»¥çŸ¥é“æ¯ä¸ªè§†é¢‘ç³»åˆ—ä¸­å…·ä½“åŒ…å«å“ªäº›è§†é¢‘ï¼Œä»¥åŠè§†é¢‘åœ¨ç³»åˆ—ä¸­çš„æ’åºï¼Œä»è€ŒæŒ‰é¡ºåºå±•ç¤ºè§†é¢‘å†…å®¹ã€‚</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1009-1024x815.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1010.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1011.png" alt="img"></p>
<h3 id="2-ä¸ªäººä¸­å¿ƒå±•ç¤ºç”¨æˆ·ä¿¡æ¯åŠæ›´æ”¹èƒŒæ™¯ä¸»é¢˜">2.ä¸ªäººä¸­å¿ƒå±•ç¤ºç”¨æˆ·ä¿¡æ¯åŠæ›´æ”¹èƒŒæ™¯ä¸»é¢˜</h3>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1013.png" alt="img"></p>
<p>webåŒ…ä¸­åˆ›å»ºUHomeController</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * è·å–ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"><span class="comment">  * - æ”¯æŒå½“å‰æœªç™»å½•ç”¨æˆ·è®¿é—®ï¼ˆcurrentUserId å¯èƒ½ä¸º nullï¼‰</span></span><br><span class="line"><span class="comment">  * - è¿”å›çš„æ˜¯è„±æ•/å±•ç¤ºå±‚ VO</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="meta">@RequestMapping</span>(<span class="string">&quot;/getUserInfo&quot;</span>)</span><br><span class="line"> <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">getUserInfo</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="title class_">String</span> userId</span>) &#123;</span><br><span class="line">     <span class="comment">// å½“å‰ç™»å½•ç”¨æˆ·ï¼ˆå¯èƒ½ä¸º nullï¼Œæ¸¸å®¢æŸ¥çœ‹ä»–äººä¸»é¡µï¼‰</span></span><br><span class="line">     <span class="title class_">TokenUserInfoDto</span> token = <span class="title function_">getTokenUserInfoDto</span>();</span><br><span class="line"></span><br><span class="line">     <span class="comment">// è¯»å–ç”¨æˆ·è¯¦æƒ…ï¼ˆå¯åœ¨ Service å†…è¿½åŠ ç²‰ä¸/å…³æ³¨/æ˜¯å¦äº’å…³ç­‰æ‰©å±•ï¼‰</span></span><br><span class="line">     <span class="title class_">UserInfo</span> userInfo = userInfoService.<span class="title function_">getUserDetailInfo</span>(</span><br><span class="line">             token == <span class="literal">null</span> ? <span class="literal">null</span> : token.<span class="title function_">getUserId</span>(), userId);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// DO -&gt; VOï¼ˆä»…æ‹·è´å±•ç¤ºéœ€è¦çš„å­—æ®µï¼‰</span></span><br><span class="line">     <span class="title class_">UserInfoVO</span> userInfoVO = <span class="title class_">CopyTools</span>.<span class="title function_">copy</span>(userInfo, <span class="title class_">UserInfoVO</span>.<span class="property">class</span>);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(userInfoVO);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * æ›´æ–°ä¸ªäººèµ„æ–™</span></span><br><span class="line"><span class="comment">  * - ä»…å…è®¸ç™»å½•ç”¨æˆ·ä¿®æ”¹è‡ªå·±çš„èµ„æ–™ï¼ˆuserId æ¥è‡ª tokenï¼‰</span></span><br><span class="line"><span class="comment">  * - è‹¥æ˜µç§°æœ‰å˜æ›´ï¼šéœ€è¦æ‰£ç¡¬å¸ï¼ˆåœ¨ Service å†…åšä¸šåŠ¡æ ¡éªŒä¸æ‰£å‡ï¼‰</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="meta">@RequestMapping</span>(<span class="string">&quot;/updateUserInfo&quot;</span>)</span><br><span class="line"> <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">updateUserInfo</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="meta">@Size</span>(max = <span class="number">20</span>) <span class="title class_">String</span> nickName,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@NotEmpty</span> <span class="meta">@Size</span>(max = <span class="number">100</span>) <span class="title class_">String</span> avatar,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@NotNull</span> <span class="title class_">Integer</span> sex,</span></span><br><span class="line"><span class="params">                                  <span class="title class_">String</span> birthday,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@Size</span>(max = <span class="number">150</span>) <span class="title class_">String</span> school,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@Size</span>(max = <span class="number">80</span>) <span class="title class_">String</span> personIntroduction,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@Size</span>(max = <span class="number">300</span>) <span class="title class_">String</span> noticeInfo</span>) &#123;</span><br><span class="line">     <span class="title class_">TokenUserInfoDto</span> token = <span class="title function_">getTokenUserInfoDto</span>();</span><br><span class="line"></span><br><span class="line">     <span class="comment">// åªè®¾ç½®æœ¬æ¬¡å…è®¸ä¿®æ”¹çš„å­—æ®µï¼›userId ä» token è·å–ï¼Œç¡®ä¿åªèƒ½æ”¹è‡ªå·±çš„æ•°æ®</span></span><br><span class="line">     <span class="title class_">UserInfo</span> userInfo = <span class="keyword">new</span> <span class="title class_">UserInfo</span>();</span><br><span class="line">     userInfo.<span class="title function_">setUserId</span>(token.<span class="title function_">getUserId</span>());</span><br><span class="line">     userInfo.<span class="title function_">setNickName</span>(nickName);</span><br><span class="line">     userInfo.<span class="title function_">setAvatar</span>(avatar);</span><br><span class="line">     userInfo.<span class="title function_">setSex</span>(sex);</span><br><span class="line">     userInfo.<span class="title function_">setBirthday</span>(birthday);</span><br><span class="line">     userInfo.<span class="title function_">setSchool</span>(school);</span><br><span class="line">     userInfo.<span class="title function_">setPersonIntroduction</span>(personIntroduction);</span><br><span class="line">     userInfo.<span class="title function_">setNoticeInfo</span>(noticeInfo);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// å…·ä½“ä¸šåŠ¡é€»è¾‘ï¼ˆæ˜µç§°å˜æ›´æ‰£å¸/åˆ·æ–° token ç¼“å­˜ï¼‰åœ¨ Service ä¸­å¤„ç†</span></span><br><span class="line">     userInfoService.<span class="title function_">updateUserInfo</span>(userInfo, token);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(<span class="literal">null</span>);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * ä¿å­˜ä¸»é¢˜ï¼ˆåˆ‡æ¢èƒŒæ™¯/é…è‰²ï¼‰</span></span><br><span class="line"><span class="comment">  * - è½»é‡æ›´æ–°ï¼Œåªå†™ theme å­—æ®µ</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="meta">@RequestMapping</span>(<span class="string">&quot;/saveTheme&quot;</span>)</span><br><span class="line"> <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">saveTheme</span>(<span class="params"><span class="title class_">Integer</span> theme</span>) &#123;</span><br><span class="line">     <span class="title class_">TokenUserInfoDto</span> token = <span class="title function_">getTokenUserInfoDto</span>();</span><br><span class="line">     <span class="title class_">UserInfo</span> userInfo = <span class="keyword">new</span> <span class="title class_">UserInfo</span>();</span><br><span class="line">     userInfo.<span class="title function_">setTheme</span>(theme);</span><br><span class="line"></span><br><span class="line">     <span class="comment">// åªæ ¹æ® userId è¿›è¡Œå­—æ®µæ›´æ–°</span></span><br><span class="line">     userInfoService.<span class="title function_">updateUserInfoByUserId</span>(userInfo, token.<span class="title function_">getUserId</span>());</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(<span class="literal">null</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>userInfoServiceä¸­</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  /** è·å–ç”¨æˆ·è¯¦æƒ…ï¼ˆå¯æºå¸¦å½“å‰ç™»å½•ç”¨æˆ· id ä»¥è®¡ç®—å…³ç³»/å±è”½ï¼‰ */</span></span><br><span class="line">    <span class="function">UserInfo <span class="title">getUserDetailInfo</span><span class="params">(<span class="type">String</span> currentUserId, <span class="type">String</span> userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** æ›´æ–°ä¸ªäººèµ„æ–™ï¼ˆæ˜µç§°å˜æ›´ä¼šæ‰£å¸ &amp; åˆ·æ–° token ç¼“å­˜ï¼‰ */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">updateUserInfo</span><span class="params">(UserInfo userInfo, TokenUserInfoDto tokenUserInfoDto)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** ä»…æŒ‰ userId å±€éƒ¨æ›´æ–°ï¼ˆä¾‹å¦‚ä¸»é¢˜ï¼‰ */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">updateUserInfoByUserId</span><span class="params">(UserInfo patch, <span class="type">String</span> userId)</span></span>;</span><br></pre></td></tr></table></figure>
<p>userInfoServiceImplä¸­</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * æ ¹æ®ç”¨æˆ·IDè·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> currentUserId å½“å‰ç”¨æˆ·ID</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> userId          ç”¨æˆ·ID</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> UserInfo ç”¨æˆ·è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> BusinessException ä¸šåŠ¡å¼‚å¸¸</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">UserInfo</span> <span class="title function_">getUserDetailInfo</span>(<span class="params"><span class="title class_">String</span> currentUserId, <span class="title class_">String</span> userId</span>) &#123;</span><br><span class="line">		<span class="comment">// 1) è¯» DB</span></span><br><span class="line">		<span class="title class_">UserInfo</span> userInfo = <span class="title function_">getUserInfoByUserId</span>(userId);</span><br><span class="line">		<span class="keyword">if</span> (<span class="literal">null</span> == userInfo) &#123;</span><br><span class="line">			<span class="comment">// ç”¨æˆ·ä¸å­˜åœ¨ â†’ 404</span></span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="title class_">ResponseCodeEnum</span>.<span class="property">CODE_404</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//TODO å…³æ³¨æ•°ç²‰ä¸æ•°</span></span><br><span class="line"></span><br><span class="line">   	<span class="keyword">return</span> userInfo;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * æ›´æ–°ä¸ªäººèµ„æ–™ï¼š</span></span><br><span class="line"><span class="comment">	 * - å…è®¸ä¿®æ”¹ï¼šæ˜µç§°/å¤´åƒ/æ€§åˆ«/ç”Ÿæ—¥/å­¦æ ¡/ç®€ä»‹/å…¬å‘Š...</span></span><br><span class="line"><span class="comment">	 * - è‹¥æ˜µç§°æœ‰å˜åŒ–ï¼šéœ€è¦æ‰£ç¡¬å¸ï¼ˆUPDATE_NICK_NAME_COINï¼‰</span></span><br><span class="line"><span class="comment">	 * - è‹¥å¤´åƒ/æ˜µç§°æ”¹äº†ï¼šåŒæ­¥æ›´æ–° Redis ä¸­çš„ token å±•ç¤ºä¿¡æ¯</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@Transactional</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">updateUserInfo</span>(<span class="params"><span class="title class_">UserInfo</span> userInfo, <span class="title class_">TokenUserInfoDto</span> token</span>) &#123;</span><br><span class="line">		<span class="comment">// 1) æŸ¥æ—§èµ„æ–™</span></span><br><span class="line">		<span class="title class_">UserInfo</span> dbInfo = userInfoMapper.<span class="title function_">selectByUserId</span>(userInfo.<span class="title function_">getUserId</span>());</span><br><span class="line">		<span class="keyword">if</span> (dbInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="title class_">ResponseCodeEnum</span>.<span class="property">CODE_404</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 2) è‹¥æ˜µç§°å˜æ›´ï¼Œåˆ™éœ€æ ¡éªŒä½™é¢å¹¶æ‰£å¸</span></span><br><span class="line">		<span class="built_in">boolean</span> nickChanged = !dbInfo.<span class="title function_">getNickName</span>().<span class="title function_">equals</span>(userInfo.<span class="title function_">getNickName</span>());</span><br><span class="line">		<span class="keyword">if</span> (nickChanged) &#123;</span><br><span class="line">			<span class="comment">// ä½™é¢æ˜¯å¦è¶³å¤Ÿ</span></span><br><span class="line">			<span class="keyword">if</span> (dbInfo.<span class="title function_">getCurrentCoinCount</span>() &lt; <span class="title class_">Constants</span>.<span class="property">UPDATE_NICK_NAME_COIN</span>) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;ç¡¬å¸ä¸è¶³ï¼Œæ— æ³•ä¿®æ”¹æ˜µç§°&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// å°è¯•æ‰£å¸ï¼ˆä½¿ç”¨ SQL: current_coin_count + changeCount &gt;= 0 æ§åˆ¶ä¸ä¸ºè´Ÿï¼‰</span></span><br><span class="line">			int affected = userInfoMapper.<span class="title function_">updateCoinCountInfo</span>(</span><br><span class="line">					userInfo.<span class="title function_">getUserId</span>(), -<span class="title class_">Constants</span>.<span class="property">UPDATE_NICK_NAME_COIN</span>);</span><br><span class="line">			<span class="keyword">if</span> (affected == <span class="number">0</span>) &#123;</span><br><span class="line">				<span class="comment">// å¹¶å‘ä¸‹å¯èƒ½å‡ºç°ä½™é¢å·²ä¸è¶³</span></span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;ç¡¬å¸ä¸è¶³ï¼Œæ— æ³•ä¿®æ”¹æ˜µç§°&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 3) å†™å…¥æ–°èµ„æ–™ï¼ˆæŒ‰ userId å±€éƒ¨æ›´æ–°ï¼‰</span></span><br><span class="line">		userInfoMapper.<span class="title function_">updateByUserId</span>(userInfo, userInfo.<span class="title function_">getUserId</span>());</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 4) è‹¥å¤´åƒ/æ˜µç§°å˜åŒ– â†’ åˆ·æ–° token ç¼“å­˜ï¼Œä¿è¯å‰ç«¯å¤´éƒ¨/è¯„è®ºåŒºå±•ç¤ºå³æ—¶ç”Ÿæ•ˆ</span></span><br><span class="line">		<span class="built_in">boolean</span> needRefreshToken = <span class="literal">false</span>;</span><br><span class="line">		<span class="keyword">if</span> (userInfo.<span class="title function_">getAvatar</span>() != <span class="literal">null</span> &amp;&amp; !userInfo.<span class="title function_">getAvatar</span>().<span class="title function_">equals</span>(token.<span class="title function_">getAvatar</span>())) &#123;</span><br><span class="line">			token.<span class="title function_">setAvatar</span>(userInfo.<span class="title function_">getAvatar</span>());</span><br><span class="line">			needRefreshToken = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (userInfo.<span class="title function_">getNickName</span>() != <span class="literal">null</span> &amp;&amp; !userInfo.<span class="title function_">getNickName</span>().<span class="title function_">equals</span>(token.<span class="title function_">getNickName</span>())) &#123;</span><br><span class="line">			token.<span class="title function_">setNickName</span>(userInfo.<span class="title function_">getNickName</span>());</span><br><span class="line">			needRefreshToken = <span class="literal">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (needRefreshToken) &#123;</span><br><span class="line">			redisComponent.<span class="title function_">updateTokenInfo</span>(token);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1012-1024x460.png" alt="img"></p>
<h3 id="3-ä¸ªäººä¸­å¿ƒå…³æ³¨-å–æ¶ˆå…³æ³¨">3.ä¸ªäººä¸­å¿ƒå…³æ³¨/å–æ¶ˆå…³æ³¨</h3>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1014.png" alt="img"></p>
<p>UHomeController</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸ªäººä¸­å¿ƒç›¸å…³æ§åˆ¶å™¨ï¼šå…³æ³¨ / å–å…³</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/uHome&quot;</span>)</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">UHomeController</span> <span class="keyword">extends</span> <span class="title">ABaseController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserFocusService</span> userFocusService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å…³æ³¨æŸä¸ªç”¨æˆ·</span></span><br><span class="line"><span class="comment">     * @param focusUserId è¢«å…³æ³¨è€…çš„ç”¨æˆ·ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">&quot;/focus&quot;</span>)</span><br><span class="line">    public <span class="type">ResponseVO</span> focus(<span class="meta">@NotEmpty</span> <span class="type">String</span> focusUserId) &#123;</span><br><span class="line">        <span class="comment">// ä»ç™»å½•æ€ä¸­è·å–å½“å‰æ“ä½œäººï¼ˆå…³æ³¨è€…ï¼‰</span></span><br><span class="line">        <span class="type">String</span> userId = getTokenUserInfoDto().getUserId();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// äº¤ç»™æœåŠ¡å±‚å¤„ç†ï¼ˆå«å¹‚ç­‰ã€è‡ªå…³æ³¨æ‹¦æˆªã€ç›®æ ‡ç”¨æˆ·å­˜åœ¨æ€§æ ¡éªŒï¼‰</span></span><br><span class="line">        userFocusService.focusUser(userId, focusUserId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‰ç«¯æ— éœ€é¢å¤–æ•°æ®ï¼Œè¿™é‡Œè¿”å›æˆåŠŸå³å¯</span></span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å–æ¶ˆå…³æ³¨</span></span><br><span class="line"><span class="comment">     * @param focusUserId è¢«å–å…³è€…çš„ç”¨æˆ·ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">&quot;/cancelFocus&quot;</span>)</span><br><span class="line">    public <span class="type">ResponseVO</span> cancelFocus(<span class="meta">@NotEmpty</span> <span class="type">String</span> focusUserId) &#123;</span><br><span class="line">        <span class="type">String</span> userId = getTokenUserInfoDto().getUserId();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç›´æ¥åˆ é™¤å…³æ³¨å…³ç³»ï¼ˆè‹¥ä¸å­˜åœ¨åˆ™ç›¸å½“äºå¹‚ç­‰æˆåŠŸï¼‰</span></span><br><span class="line">        userFocusService.cancelFocus(userId, focusUserId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UserFocusService</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å…³æ³¨ç”¨æˆ·</span></span><br><span class="line"><span class="comment"> * @param userId</span></span><br><span class="line"><span class="comment"> * @param focusUserId</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">   <span class="function"><span class="type">void</span> <span class="title">focusUser</span><span class="params">(<span class="type">String</span> userId, <span class="type">String</span> focusUserId)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å–æ¶ˆå…³æ³¨ç”¨æˆ·</span></span><br><span class="line"><span class="comment"> * @param userId</span></span><br><span class="line"><span class="comment"> * @param focusUserId</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">cancelFocus</span><span class="params">(<span class="type">String</span> userId, <span class="type">String</span> focusUserId)</span></span>;</span><br></pre></td></tr></table></figure>
<p>UserFocusServiceImpl</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">	<span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserFocusServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserFocusService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">UserFocusMapper</span> userFocusMapper;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">UserInfoMapper</span> userInfoMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å…³æ³¨ç”¨æˆ·</span></span><br><span class="line"><span class="comment">     * - ä¸å…è®¸å…³æ³¨è‡ªå·±</span></span><br><span class="line"><span class="comment">     * - å¹‚ç­‰ï¼šè‹¥å·²å…³æ³¨åˆ™ç›´æ¥è¿”å›</span></span><br><span class="line"><span class="comment">     * - æ ¡éªŒè¢«å…³æ³¨ç”¨æˆ·å­˜åœ¨</span></span><br><span class="line"><span class="comment">     * - æ’å…¥å…³æ³¨å…³ç³»</span></span><br><span class="line"><span class="comment">     * - ï¼ˆå¯é€‰ï¼‰æ›´æ–°åŒæ–¹è®¡æ•° &amp; å‘é€é€šçŸ¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(rollbackFor = <span class="title class_">Exception</span>.<span class="property">class</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">focusUser</span>(<span class="params"><span class="title class_">String</span> userId, <span class="title class_">String</span> focusUserId</span>) &#123;</span><br><span class="line">        <span class="comment">// 1) æ‹¦æˆªè‡ªæˆ‘å…³æ³¨</span></span><br><span class="line">        <span class="keyword">if</span> (userId.<span class="title function_">equals</span>(focusUserId)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;ä¸èƒ½å¯¹è‡ªå·±è¿›è¡Œæ­¤æ“ä½œ&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2) å¹‚ç­‰æ ¡éªŒï¼šå·²å­˜åœ¨å³è¿”å›ï¼ˆé¿å…é‡å¤æ’å…¥/é‡å¤æ‰£å¢ï¼‰</span></span><br><span class="line">        <span class="title class_">UserFocus</span> existed = userFocusMapper.<span class="title function_">selectByUserIdAndFocusUserId</span>(userId, focusUserId);</span><br><span class="line">        <span class="keyword">if</span> (existed != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>; <span class="comment">// å·²å…³æ³¨ï¼Œå¹‚ç­‰æˆåŠŸ</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3) æ ¡éªŒè¢«å…³æ³¨è€…å­˜åœ¨æ€§ï¼ˆé¿å…è„æ•°æ®ï¼‰</span></span><br><span class="line">        <span class="title class_">UserInfo</span> focusUser = userInfoMapper.<span class="title function_">selectByUserId</span>(focusUserId);</span><br><span class="line">        <span class="keyword">if</span> (focusUser == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="title class_">ResponseCodeEnum</span>.<span class="property">CODE_600</span>); <span class="comment">// æ— æ•ˆç”¨æˆ·</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4) æ’å…¥å…³æ³¨å…³ç³»</span></span><br><span class="line">        <span class="title class_">UserFocus</span> record = <span class="keyword">new</span> <span class="title class_">UserFocus</span>();</span><br><span class="line">        record.<span class="title function_">setUserId</span>(userId);</span><br><span class="line">        record.<span class="title function_">setFocusUserId</span>(focusUserId);</span><br><span class="line">        record.<span class="title function_">setFocusTime</span>(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        userFocusMapper.<span class="title function_">insert</span>(record);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5) ï¼ˆå¯é€‰ï¼‰è®¡æ•° &amp; é€šçŸ¥</span></span><br><span class="line">        <span class="comment">// userInfoMapper.updateFollowCount(userId, +1);</span></span><br><span class="line">        <span class="comment">// userInfoMapper.updateFansCount(focusUserId, +1);</span></span><br><span class="line">        <span class="comment">// messageService.sendFocusMessage(userId, focusUserId);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å–æ¶ˆå…³æ³¨</span></span><br><span class="line"><span class="comment">     * - ç›´æ¥åˆ é™¤å…³ç³»ï¼ˆä¸å­˜åœ¨ä¹Ÿä¸æŠ¥é”™ï¼Œä¿æŒå¹‚ç­‰ï¼‰</span></span><br><span class="line"><span class="comment">     * - ï¼ˆå¯é€‰ï¼‰å›æ»šåŒæ–¹è®¡æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span>(rollbackFor = <span class="title class_">Exception</span>.<span class="property">class</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">cancelFocus</span>(<span class="params"><span class="title class_">String</span> userId, <span class="title class_">String</span> focusUserId</span>) &#123;</span><br><span class="line">        <span class="comment">// ç›´æ¥åˆ é™¤ã€‚è‹¥æ²¡æœ‰è®°å½•ï¼Œå—å½±å“è¡Œæ•°ä¸º 0ï¼Œç›¸å½“äºå¹‚ç­‰æˆåŠŸ</span></span><br><span class="line">        userFocusMapper.<span class="title function_">deleteByUserIdAndFocusUserId</span>(userId, focusUserId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ï¼ˆå¯é€‰ï¼‰è®¡æ•°å›æ»š</span></span><br><span class="line">        <span class="comment">// userInfoMapper.updateFollowCount(userId, -1);</span></span><br><span class="line">        <span class="comment">// userInfoMapper.updateFansCount(focusUserId, -1);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-ä¸ªäººä¸­å¿ƒæ˜¾ç¤ºå…³æ³¨æ•°å’Œç²‰ä¸æ•°ç­‰ä¿¡æ¯ï¼ˆä½ å…³æ³¨äº†è°-ä½ çš„ç²‰ä¸æ˜¯è°-è°è·Ÿä½ äº’ç²‰äº†ï¼‰">4.ä¸ªäººä¸­å¿ƒæ˜¾ç¤ºå…³æ³¨æ•°å’Œç²‰ä¸æ•°ç­‰ä¿¡æ¯ï¼ˆä½ å…³æ³¨äº†è°/ä½ çš„ç²‰ä¸æ˜¯è°/è°è·Ÿä½ äº’ç²‰äº†ï¼‰</h3>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1020.png" alt="img"></p>
<p>åœ¨userInfoServiceImplä¸­è¡¥å…¨ä¹‹å‰çš„TODO å…³æ³¨æ•°å’Œç²‰ä¸é‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®ç”¨æˆ·IDè·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> * - é™„å¸¦å…³æ³¨æ•°ã€ç²‰ä¸æ•°</span></span><br><span class="line"><span class="comment"> * - è‹¥ä¼ å…¥å½“å‰ç™»å½•ç”¨æˆ·IDï¼Œå¯è®¡ç®—â€œå½“å‰ç”¨æˆ·æ˜¯å¦å·²å…³æ³¨è¯¥ä¸»é¡µç”¨æˆ·â€</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> UserInfo <span class="title function_">getUserDetailInfo</span><span class="params">(String currentUserId, String userId)</span> &#123;</span><br><span class="line">    <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> getUserInfoByUserId(userId);</span><br><span class="line">    <span class="keyword">if</span> (userInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_404);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…³æ³¨æ•°ï¼šä»¥â€œæˆ‘ä½œä¸º user_idâ€ç»Ÿè®¡</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">focusCount</span> <span class="operator">=</span> userFocusMapper.selectFocusCount(userId);</span><br><span class="line">    <span class="comment">// ç²‰ä¸æ•°ï¼šä»¥â€œæˆ‘ä½œä¸º focus_user_idâ€ç»Ÿè®¡</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">fansCount</span>  <span class="operator">=</span> userFocusMapper.selectFansCount(userId);</span><br><span class="line">    userInfo.setFocusCount(focusCount);</span><br><span class="line">    userInfo.setFansCount(fansCount);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ˜¯å¦å·²å…³æ³¨ï¼ˆä»…å½“æœ‰ç™»å½•æ€æ‰è®¡ç®—ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (currentUserId == <span class="literal">null</span>) &#123;</span><br><span class="line">        userInfo.setHaveFocus(<span class="literal">false</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æŸ¥è¯¢ï¼šå½“å‰ç”¨æˆ· -&gt; æ˜¯å¦å…³æ³¨äº†è¢«æŸ¥çœ‹ç”¨æˆ·</span></span><br><span class="line">        <span class="type">UserFocus</span> <span class="variable">uf</span> <span class="operator">=</span> userFocusMapper</span><br><span class="line">            .selectByUserIdAndFocusUserId(currentUserId, userId);</span><br><span class="line">        userInfo.setHaveFocus(uf != <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODOï¼šæ’­æ”¾é‡ã€è·èµã€è¢«æ”¶è—ç­‰ç»Ÿè®¡å¯åœ¨æ­¤ä¸€å¹¶è¡¥é½</span></span><br><span class="line">    <span class="keyword">return</span> userInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å¯¹åº”çš„ Mapper SQLï¼ˆè®¡æ•°èšåˆï¼‰ï¼š</strong></p>
<ul>
<li><strong>å…³æ³¨æ•°</strong>ï¼š<code>SELECT COUNT(1) FROM user_focus WHERE user_id = #&#123;userId&#125;</code></li>
<li><strong>ç²‰ä¸æ•°</strong>ï¼š<code>SELECT COUNT(1) FROM user_focus WHERE focus_user_id = #&#123;userId&#125;</code></li>
</ul>
<p>UserFocusMapper</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®UserIdè·å–ç²‰ä¸æ•°</span></span><br><span class="line"><span class="comment"> * @param userId</span></span><br><span class="line"><span class="comment"> * @return</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="selector-tag">Integer</span> <span class="selector-tag">selectFansCount</span>(<span class="variable">@Param</span>(<span class="string">&quot;userId&quot;</span>) String userId);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®UserIdè·å–å…³æ³¨æ•°</span></span><br><span class="line"><span class="comment"> * @param userId</span></span><br><span class="line"><span class="comment"> * @return</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">Integer</span> <span class="selector-tag">selectFocusCount</span>(<span class="variable">@Param</span>(<span class="string">&quot;userId&quot;</span>) String userId);</span><br></pre></td></tr></table></figure>
<p>UserFocusMapperXml</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!--	è·å–ç”¨æˆ·å…³æ³¨æ•°--&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectFocusCount&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;java.lang.Integer&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">		select count(1) from user_focus where user_id = #</span><span class="template-variable">&#123;userId&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="comment">&lt;!-- è·å–ç”¨æˆ·ç²‰ä¸æ•°--&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectFansCount&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;java.lang.Integer&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">		select count(1) from user_focus where focus_user_id = #</span><span class="template-variable">&#123;userId&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>åœ¨UHomeControllerä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æˆ‘å…³æ³¨çš„äººï¼ˆâ€œå…³æ³¨åˆ—è¡¨â€ï¼‰</span></span><br><span class="line"><span class="comment"> * - queryType = 0ï¼šä¸»è¡¨ user_focus çš„ user_id = æˆ‘</span></span><br><span class="line"><span class="comment"> * - å…³è” user_info å–â€œå¯¹æ–¹â€çš„å±•ç¤ºèµ„æ–™ï¼ˆæ˜µç§°/å¤´åƒ/ç®€ä»‹ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/loadFocusList&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseVO <span class="title function_">loadFocusList</span><span class="params">(Integer pageNo)</span> &#123;</span><br><span class="line">    <span class="type">TokenUserInfoDto</span> <span class="variable">token</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line">    <span class="type">UserFocusQuery</span> <span class="variable">q</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserFocusQuery</span>();</span><br><span class="line">    q.setUserId(token.getUserId());     <span class="comment">// æˆ‘æ˜¯è°</span></span><br><span class="line">    q.setQueryType(Constants.ZERO);     <span class="comment">// 0=æŸ¥â€œæˆ‘å…³æ³¨çš„äººâ€</span></span><br><span class="line">    q.setPageNo(pageNo);</span><br><span class="line">    q.setOrderBy(<span class="string">&quot;focus_time desc&quot;</span>);</span><br><span class="line">    <span class="type">PaginationResultVO</span> <span class="variable">vo</span> <span class="operator">=</span> userFocusService.findListByPage(q);</span><br><span class="line">    <span class="keyword">return</span> getSuccessResponseVO(vo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æˆ‘çš„ç²‰ä¸ï¼ˆâ€œç²‰ä¸åˆ—è¡¨â€ï¼‰</span></span><br><span class="line"><span class="comment"> * - queryType = 1ï¼šä¸»è¡¨ user_focus çš„ focus_user_id = æˆ‘</span></span><br><span class="line"><span class="comment"> * - å…³è” user_info å–â€œç²‰ä¸â€çš„å±•ç¤ºèµ„æ–™</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/loadFansList&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseVO <span class="title function_">loadFansList</span><span class="params">(Integer pageNo)</span> &#123;</span><br><span class="line">    <span class="type">TokenUserInfoDto</span> <span class="variable">token</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line">    <span class="type">UserFocusQuery</span> <span class="variable">q</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserFocusQuery</span>();</span><br><span class="line">    q.setFocusUserId(token.getUserId()); <span class="comment">// æˆ‘æ˜¯è°ï¼ˆè¢«å…³æ³¨è€…ï¼‰</span></span><br><span class="line">    q.setQueryType(Constants.ONE);       <span class="comment">// 1=æŸ¥â€œç²‰ä¸â€</span></span><br><span class="line">    q.setPageNo(pageNo);</span><br><span class="line">    q.setOrderBy(<span class="string">&quot;focus_time desc&quot;</span>);</span><br><span class="line">    <span class="type">PaginationResultVO</span> <span class="variable">vo</span> <span class="operator">=</span> userFocusService.findListByPage(q);</span><br><span class="line">    <span class="keyword">return</span> getSuccessResponseVO(vo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨UserFocusä¸­åŠ å…¥è¿™å‡ ä¸ªå±æ€§ä»¥åŠgetterå’Œsetteræ–¹æ³•</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">String</span> otherNickName;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">String</span> otherUserId;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">String</span> otherPersonIntroduction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">String</span> otherAvatar;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">Integer</span> focusType;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1021.png" alt="img"></p>
<p>UserFocusMapperXml</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">	<span class="comment">&lt;!-- æŸ¥è¯¢å…³æ³¨/ç²‰ä¸é›†åˆï¼ˆåˆ†é¡µ + å¯¹æ–¹èµ„æ–™ + æ˜¯å¦äº’ç²‰ï¼‰ --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectList&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;base_result_map&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  SELECT</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;base_column_list&quot;</span>/&gt;</span>  <span class="comment">&lt;!-- user_focus ä¸»è¡¨çš„åŸºç¡€åˆ—ï¼šuser_id, focus_user_id, focus_time ... --&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.queryType != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      , i.nick_name            AS otherNickName      <span class="comment">&lt;!-- å¯¹æ–¹æ˜µç§° --&gt;</span></span></span><br><span class="line"><span class="language-xml">      , i.user_id              AS otherUserId        <span class="comment">&lt;!-- å¯¹æ–¹ID --&gt;</span></span></span><br><span class="line"><span class="language-xml">      , i.person_introduction  AS otherPersonIntroduction</span></span><br><span class="line"><span class="language-xml">      , i.avatar               AS otherAvatar        <span class="comment">&lt;!-- å¯¹æ–¹å¤´åƒ --&gt;</span></span></span><br><span class="line"><span class="language-xml">      , (</span></span><br><span class="line"><span class="language-xml">          /* äº’ç²‰åˆ¤æ–­ï¼šå­˜åœ¨ä¸€æ¡â€œå¯¹å‘å…³ç³»â€åˆ™ä¸º1ï¼Œå¦åˆ™ä¸º0 */</span></span><br><span class="line"><span class="language-xml">          SELECT COUNT(1)</span></span><br><span class="line"><span class="language-xml">          FROM user_focus f</span></span><br><span class="line"><span class="language-xml">          WHERE u.user_id = f.focus_user_id   /* æˆ‘ è¢« å¯¹æ–¹å…³æ³¨ */</span></span><br><span class="line"><span class="language-xml">            AND u.focus_user_id = f.user_id   /* å¯¹æ–¹ å…³æ³¨ æˆ‘ */</span></span><br><span class="line"><span class="language-xml">        ) AS focusType</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  FROM user_focus u</span></span><br><span class="line"><span class="language-xml">  <span class="comment">&lt;!-- queryType=0ï¼šæŸ¥æˆ‘å…³æ³¨çš„äºº â†’ å³è¡¨æ˜¯å¯¹æ–¹ï¼ˆfocus_user_idï¼‰ --&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.queryType == 0&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    INNER JOIN user_info i ON i.user_id = u.focus_user_id</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="comment">&lt;!-- queryType=1ï¼šæŸ¥æˆ‘çš„ç²‰ä¸ â†’ å³è¡¨æ˜¯ç²‰ä¸ï¼ˆuser_idï¼‰ --&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.queryType == 1&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    INNER JOIN user_info i ON i.user_id = u.user_id</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;query_condition&quot;</span>/&gt;</span>     <span class="comment">&lt;!-- åŠ¨æ€ whereï¼šuser_id / focus_user_id / å…¶ä»–è¿‡æ»¤ --&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.orderBy != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    ORDER BY $</span><span class="template-variable">&#123;query.orderBy&#125;</span><span class="language-xml">             <span class="comment">&lt;!-- ä¾‹ï¼šfocus_time descï¼ˆç™½åå•åˆ—åï¼‰ --&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.simplePage != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    LIMIT #</span><span class="template-variable">&#123;query.simplePage.start&#125;</span><span class="language-xml">, #</span><span class="template-variable">&#123;query.simplePage.end&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1023.png" alt="img"></p>
<p>æµ‹è¯•ä¸¤è¾¹èƒ½æˆåŠŸäº’ç²‰</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1015-1024x538.png" alt="img"></p>
<h3 id="5-ä¸ªäººä¸­å¿ƒè§†é¢‘åˆ—è¡¨ã€æ”¶è—çš„å±•ç¤º">5.ä¸ªäººä¸­å¿ƒè§†é¢‘åˆ—è¡¨ã€æ”¶è—çš„å±•ç¤º</h3>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1027.png" alt="img"></p>
<p>åˆ›å»ºVideoOrderTypeEnumæšä¸¾ç±»</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">enums</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">VideoOrderTypeEnum</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">CREATE_TIME</span>(<span class="number">0</span>, <span class="string">&quot;create_time&quot;</span>, <span class="string">&quot;æœ€æ–°å‘å¸ƒ&quot;</span>),</span><br><span class="line">    <span class="title function_">PLAY_COUNT</span>(<span class="number">1</span>, <span class="string">&quot;play_count&quot;</span>, <span class="string">&quot;æœ€å¤šæ’­æ”¾&quot;</span>),</span><br><span class="line">    <span class="title function_">COLLECT_COUNT</span>(<span class="number">2</span>, <span class="string">&quot;collect_count&quot;</span>, <span class="string">&quot;æœ€å¤šæ”¶è—&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> <span class="keyword">type</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> field;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> desc;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">VideoOrderTypeEnum</span>(<span class="title class_">Integer</span> <span class="keyword">type</span>, <span class="title class_">String</span> field, <span class="title class_">String</span> desc) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">type</span> = <span class="keyword">type</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">field</span> = field;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">desc</span> = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="title class_">VideoOrderTypeEnum</span> <span class="title function_">getByType</span>(<span class="params"><span class="title class_">Integer</span> <span class="keyword">type</span></span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="title class_">VideoOrderTypeEnum</span> item : <span class="title class_">VideoOrderTypeEnum</span>.<span class="title function_">values</span>()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (item.<span class="title function_">getType</span>().<span class="title function_">equals</span>(<span class="keyword">type</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> item;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getType</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">type</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getDesc</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getField</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1028.png" alt="img"></p>
<p>åœ¨UserActionQueryä¸­åŠ å…¥è¿™ä¸ªå­—æ®µå¹¶ç”Ÿæˆgetterå’Œsetteræ–¹æ³•</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ˜¯å¦æŸ¥çœ‹è§†é¢‘ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">Boolean</span> queryVideoInfo;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1029.png" alt="img"></p>
<p>åŠ å…¥UserActionMapperXmlä¸­ä¸ºè¿™ä¸ªå­—æ®µæ·»åŠ æ¡ä»¶</p>
<p><strong>ç›®æ ‡</strong>ï¼šä» <code>user_action</code> é‡ŒæŸ¥â€œæ”¶è—â€è¡Œä¸ºï¼Œå¹¶<strong>å¯é€‰</strong>è”è¡¨ <code>video_info</code> ä»¥æ‹¿åˆ°å°é¢ä¸æ ‡é¢˜ï¼›æ”¯æŒåˆ†é¡µä¸æ’åºã€‚</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">	<span class="comment">&lt;!-- UserActionMapper.xml --&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="comment">&lt;!-- æŸ¥è¯¢é›†åˆï¼šå¯é€‰è”è¡¨è§†é¢‘ä¿¡æ¯ï¼ˆç”¨äºæ”¶è—åˆ—è¡¨ï¼‰ --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectList&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;base_result_map&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  SELECT</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;base_column_list&quot;</span>/&gt;</span>              <span class="comment">&lt;!-- user_action åŸºç¡€åˆ— --&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.queryVideoInfo&quot;</span>&gt;</span>                 <span class="comment">&lt;!-- å½“éœ€è¦è§†é¢‘ä¿¡æ¯æ—¶ --&gt;</span></span></span><br><span class="line"><span class="language-xml">      , v.video_cover AS videoCover</span></span><br><span class="line"><span class="language-xml">      , v.video_name  AS videoName</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  FROM user_action u</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.queryVideoInfo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    LEFT JOIN video_info v ON v.video_id = u.video_id</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;query_condition&quot;</span>/&gt;</span>                 <span class="comment">&lt;!-- åŠ¨æ€ whereï¼ˆå¦‚ user_idã€action_typeã€video_id...ï¼‰ --&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.orderBy != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    ORDER BY $</span><span class="template-variable">&#123;query.orderBy&#125;</span><span class="language-xml">                         <span class="comment">&lt;!-- ä¾‹ï¼šaction_time descï¼ˆæ§åˆ¶æˆç™½åå•ï¼‰ --&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.simplePage != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    LIMIT #</span><span class="template-variable">&#123;query.simplePage.start&#125;</span><span class="language-xml">, #</span><span class="template-variable">&#123;query.simplePage.end&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><strong>å‡ ç‚¹è¯´æ˜</strong></p>
<ul>
<li><code>queryVideoInfo=true</code> æ—¶æ‰ <code>LEFT JOIN video_info</code>ï¼Œé¿å…ä¸å¿…è¦çš„è”è¡¨æ‹–æ…¢æŸ¥è¯¢ã€‚</li>
<li><code>$&#123;query.orderBy&#125;</code> ä»…å…è®¸æ‹¼æ¥<strong>ç™½åå•å­—æ®µ</strong>ï¼ˆè¿™é‡Œä½ åœ¨ Controller å›ºå®šä¸º <code>action_time desc</code>ï¼‰ï¼Œå¦åˆ™è¦åšæšä¸¾/ç™½åå•æ ¡éªŒã€‚</li>
<li><code>resultMap</code> é‡Œéœ€è¦æœ‰ <code>videoCover</code>ã€<code>videoName</code> çš„æ˜ å°„åˆ° <code>UserAction</code> çš„æ‰©å±•å­—æ®µã€‚</li>
</ul>
<p>åœ¨UHomeControllerä¸­</p>
<p>1.è§†é¢‘åˆ—è¡¨ <code>loadVideoList</code></p>
<blockquote>
<p>åœºæ™¯ï¼šè®¿é—®æŸç”¨æˆ·ä¸»é¡µï¼Œåˆ†é¡µæŸ¥çœ‹ä»–å‘å¸ƒçš„è§†é¢‘ï¼Œæ”¯æŒåç§°æ¨¡ç³Šä¸å¤šç»´æ’åºã€‚</p>
<p><strong>è¦ç‚¹</strong></p>
<ul>
<li>æ’åºå­—æ®µæ¥è‡ªæšä¸¾ï¼Œ<code>desc</code> æ–¹å‘å›ºå®šï¼Œé˜²æ­¢ä¼ å…¥ä»»æ„åˆ—åã€‚</li>
<li><code>videoName</code> æ¨¡ç³ŠåŒ¹é…åº”åœ¨ XML é‡Œå†™æˆ <code>AND video_name LIKE CONCAT('%', #&#123;videoNameFuzzy&#125;, '%')</code>ã€‚</li>
<li>è‹¥åç»­è¦â€œä»…æ˜¾ç¤ºå®¡æ ¸é€šè¿‡/å·²å‘å¸ƒâ€çš„è§†é¢‘ï¼Œå¯åœ¨ <code>VideoInfoQuery</code> å¢åŠ çŠ¶æ€å­—æ®µå¹¶åœ¨ <code>query_condition</code> ä¸­è¿‡æ»¤ã€‚</li>
</ul>
<p>2.æ”¶è—åˆ—è¡¨ <code>loadUserCollection</code></p>
<p>åœºæ™¯ï¼šåœ¨æŸç”¨æˆ·ä¸»é¡µæŸ¥çœ‹â€œä»–æ”¶è—è¿‡çš„æ‰€æœ‰è§†é¢‘â€ï¼Œå¹¶å±•ç¤ºå°é¢ &amp; æ ‡é¢˜ã€‚</p>
<p><strong>è¦ç‚¹</strong></p>
<ul>
<li><code>actionType</code> å›ºå®šä¸ºâ€œæ”¶è—â€ï¼Œç¡®ä¿åªæŸ¥æ”¶è—è¡Œä¸ºï¼ˆè€Œéç‚¹èµ/æŠ•å¸ç­‰ï¼‰ã€‚</li>
<li><code>queryVideoInfo=true</code> è§¦å‘è”è¡¨ï¼Œåˆ—è¡¨é¡¹é‡Œæ‰ä¼šæœ‰ <code>videoCover</code>/<code>videoName</code>ã€‚</li>
<li>è®¢å•å­—æ®µå›ºå®šä¸º <code>action_time desc</code>ï¼Œé¿å…å‰ç«¯éšæ„ä¼ å€¼ã€‚</li>
</ul>
</blockquote>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@RequestMapping</span>(<span class="string">&quot;/loadVideoList&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">loadVideoList</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="title class_">String</span> userId,</span></span><br><span class="line"><span class="params">                                <span class="title class_">Integer</span> <span class="keyword">type</span>,          <span class="comment">// æ˜¯å¦åˆ†é¡µçš„ä¸€ä¸ªæ—§æ ‡è¯†ï¼šå­˜åœ¨åˆ™ç»™ pageSize=10</span></span></span><br><span class="line"><span class="params">                                <span class="title class_">Integer</span> pageNo,</span></span><br><span class="line"><span class="params">                                <span class="title class_">String</span>  videoName,     <span class="comment">// æ¨¡ç³Šæœç´¢</span></span></span><br><span class="line"><span class="params">                                <span class="title class_">Integer</span> orderType</span>) &#123;   <span class="comment">// 0=æœ€æ–°ï¼Œ1=æœ€å¤šæ’­ï¼Œ2=æœ€å¤šè—</span></span><br><span class="line">    <span class="title class_">VideoInfoQuery</span> infoQuery = <span class="keyword">new</span> <span class="title class_">VideoInfoQuery</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¼å®¹ï¼šå¦‚æœ type != nullï¼Œå°±æŠŠåˆ†é¡µå¤§å°å›ºå®šä¸º 10</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">type</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">        infoQuery.<span class="title function_">setPageSize</span>(<span class="title class_">PageSize</span>.<span class="property">SIZE10</span>.<span class="title function_">getSize</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°† orderType å®‰å…¨æ˜ å°„ä¸ºåˆ—åï¼ˆç™½åå•ï¼‰</span></span><br><span class="line">    <span class="title class_">VideoOrderTypeEnum</span> ot = <span class="title class_">VideoOrderTypeEnum</span>.<span class="title function_">getByType</span>(orderType);</span><br><span class="line">    <span class="keyword">if</span> (ot == <span class="literal">null</span>) ot = <span class="title class_">VideoOrderTypeEnum</span>.<span class="property">CREATE_TIME</span>;  <span class="comment">// å…œåº•ï¼šæŒ‰æœ€æ–°</span></span><br><span class="line">    infoQuery.<span class="title function_">setOrderBy</span>(ot.<span class="title function_">getField</span>() + <span class="string">&quot; desc&quot;</span>);        <span class="comment">// ä¾‹ï¼šplay_count desc</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¨¡ç³Šæœç´¢å­—æ®µï¼ˆç”± XML å†™æˆ like æ¡ä»¶ï¼‰</span></span><br><span class="line">    infoQuery.<span class="title function_">setVideoNameFuzzy</span>(videoName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†é¡µä¸å½’å±ç”¨æˆ·</span></span><br><span class="line">    infoQuery.<span class="title function_">setPageNo</span>(pageNo);</span><br><span class="line">    infoQuery.<span class="title function_">setUserId</span>(userId);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">PaginationResultVO</span> result = videoInfoService.<span class="title function_">findListByPage</span>(infoQuery);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/loadUserCollection&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">loadUserCollection</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="title class_">String</span> userId, <span class="title class_">Integer</span> pageNo</span>) &#123;</span><br><span class="line">    <span class="title class_">UserActionQuery</span> actionQuery = <span class="keyword">new</span> <span class="title class_">UserActionQuery</span>();</span><br><span class="line">    actionQuery.<span class="title function_">setActionType</span>(<span class="title class_">UserActionTypeEnum</span>.<span class="property">VIDEO_COLLECT</span>.<span class="title function_">getType</span>()); <span class="comment">// åªçœ‹â€œæ”¶è—â€è¡Œä¸º</span></span><br><span class="line">    actionQuery.<span class="title function_">setUserId</span>(userId);                                         <span class="comment">// è°çš„æ”¶è—</span></span><br><span class="line">    actionQuery.<span class="title function_">setPageNo</span>(pageNo);                                         <span class="comment">// åˆ†é¡µ</span></span><br><span class="line">    actionQuery.<span class="title function_">setQueryVideoInfo</span>(<span class="literal">true</span>);                                   <span class="comment">// éœ€è¦è”è¡¨è§†é¢‘ä¿¡æ¯</span></span><br><span class="line">    actionQuery.<span class="title function_">setOrderBy</span>(<span class="string">&quot;action_time desc&quot;</span>);                            <span class="comment">// æœ€æ–°æ”¶è—åœ¨å‰ï¼ˆç™½åå•ï¼‰</span></span><br><span class="line">    <span class="title class_">PaginationResultVO</span> result = userActionService.<span class="title function_">findListByPage</span>(actionQuery);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„åœ¨UserActionä¸­åŠ å…¥è¿™ä¸¤ä¸ªå­—æ®µçš„ä¿¡æ¯å’Œsetterã€getteræ–¹æ³•ï¼Œä¸ç„¶åç§°å’Œå›¾ç‰‡ä¼šæ˜¾ç¤ºå·²å¤±æ•ˆ</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * è§†é¢‘åç§°</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">String</span> videoName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * è§†é¢‘å°é¢</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">String</span> videoCover;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1030.png" alt="img"></p>
<p>æµ‹è¯•ï¼š</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1016-1024x462.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1017-1024x462.png" alt="img"></p>
<h3 id="6-ä¸ªäººä¸­å¿ƒä¸­è§†é¢‘åˆé›†">6.ä¸ªäººä¸­å¿ƒä¸­è§†é¢‘åˆé›†</h3>
<h4 id="1-å±•ç¤ºè§†é¢‘åˆé›†">1.å±•ç¤ºè§†é¢‘åˆé›†</h4>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1032.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1033.png" alt="img"></p>
<p>åˆ›å»ºUHomeVideoSeriesController</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * åŠ è½½ç”¨æˆ·è§†é¢‘ç³»åˆ—æ¥å£</span></span><br><span class="line"><span class="comment">  * æ ¹æ®ç”¨æˆ·IDåŠ è½½è¯¥ç”¨æˆ·çš„æ‰€æœ‰è§†é¢‘ç³»åˆ—ä¿¡æ¯</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> userId ç”¨æˆ·IDï¼Œä¸èƒ½ä¸ºç©º</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> è¿”å›åŒ…å«ç”¨æˆ·æ‰€æœ‰è§†é¢‘ç³»åˆ—ä¿¡æ¯çš„ResponseVOå¯¹è±¡</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="meta">@RequestMapping</span>(<span class="string">&quot;/loadVideoSeries&quot;</span>)</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">loadVideoSeries</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="title class_">String</span> userId</span>) &#123;</span><br><span class="line">     <span class="title class_">List</span>&lt;<span class="title class_">UserVideoSeries</span>&gt; videoSeries = userVideoSeriesService.<span class="title function_">getUserAllSeries</span>(userId);</span><br><span class="line">     <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(videoSeries);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>UserVideoSeriesService</p>
<figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è·å–ç”¨æˆ·æ‰€æœ‰åˆé›†</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">List</span><span class="operator">&lt;</span><span class="title class_">UserVideoSeries</span><span class="operator">&gt;</span> <span class="title function_">getUserAllSeries</span>(<span class="title class_">String</span> <span class="variable">userId</span>);</span><br></pre></td></tr></table></figure>
<p>UserVideoSeriesServiceImpl</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">List</span>&lt;<span class="title class_">UserVideoSeries</span>&gt; <span class="title function_">getUserAllSeries</span>(<span class="params"><span class="title class_">String</span> userId</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> userVideoSeriesMapper.<span class="title function_">selectUserAllSeries</span>(userId);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>UserVideoSeriesMapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * è·å–ç”¨æˆ·æ‰€æœ‰è§†é¢‘ç³»åˆ—</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	List&lt;T&gt; <span class="title function_">selectUserAllSeries</span><span class="params">(<span class="meta">@Param(&quot;userId&quot;)</span> String userId)</span>;</span><br></pre></td></tr></table></figure>
<p>UserVideoSeriesMapperXML</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--	è·å–ç”¨æˆ·çš„è§†é¢‘åˆé›†--&gt;</span><br><span class="line">	&lt;<span class="keyword">select</span> id=<span class="string">&quot;selectUserAllSeries&quot;</span> resultMap=<span class="string">&quot;base_result_map&quot;</span>&gt;</span><br><span class="line">		<span class="keyword">SELECT</span></span><br><span class="line">			t.*,</span><br><span class="line">			v.video_cover <span class="keyword">cover</span></span><br><span class="line">		<span class="keyword">FROM</span></span><br><span class="line">			(</span><br><span class="line">				<span class="keyword">SELECT</span></span><br><span class="line">					*,(</span><br><span class="line">					<span class="keyword">SELECT</span></span><br><span class="line">						video_id</span><br><span class="line">					<span class="keyword">FROM</span></span><br><span class="line">						user_video_series_video v</span><br><span class="line">					<span class="keyword">WHERE</span></span><br><span class="line">						v.series_id = s.series_id</span><br><span class="line">					<span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">						sort <span class="keyword">ASC</span></span><br><span class="line">					<span class="keyword">LIMIT</span> <span class="number">1</span></span><br><span class="line">				) video_id</span><br><span class="line">				<span class="keyword">FROM</span></span><br><span class="line">					user_video_series s</span><br><span class="line">				<span class="keyword">WHERE</span></span><br><span class="line">					s.user_id = #&#123;userId&#125;</span><br><span class="line">			) t</span><br><span class="line">				<span class="keyword">LEFT</span> <span class="keyword">JOIN</span> video_info v <span class="keyword">ON</span> v.video_id = t.video_id <span class="keyword">order</span> <span class="keyword">by</span> t.sort <span class="keyword">asc</span></span><br><span class="line">	&lt;/<span class="keyword">select</span>&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1034.png" alt="img"></p>
<p>è¿™æ­¥è¿‡ååœ¨UserVideoSeriesä¸­åŠ å…¥å°é¢å›¾è¿™ä¸ªå­—æ®µåŠå…¶getter/setteræ–¹æ³•</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * å°é¢å›¾</span></span><br><span class="line"><span class="comment">	 * @param seriesId</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">String</span> cover;</span><br></pre></td></tr></table></figure>
<h4 id="2-ä¿å­˜è§†é¢‘åˆé›†">2.ä¿å­˜è§†é¢‘åˆé›†</h4>
<p>UHomeVideoSeriesControllerï¼Œè¿™é‡Œè¿˜éœ€è¦loadAllVideoæ¥å£å› ä¸ºæ·»åŠ çš„å‰ææ˜¯è¦å…ˆè·å–æ‰€æœ‰è§†é¢‘</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ–°å¢/ç¼–è¾‘åˆé›† + é€‰è§†é¢‘å…¥åˆé›†</span></span><br><span class="line"><span class="comment"> * - seriesId ä¸ºç©ºï¼šæ–°å¢åˆé›†å¹¶ä¸€æ¬¡æ€§æ’å…¥è§†é¢‘</span></span><br><span class="line"><span class="comment"> * - seriesId ä¸ä¸ºç©ºï¼šä»…ç¼–è¾‘åˆé›†ä¿¡æ¯ï¼ˆåç§°/æè¿°ï¼‰</span></span><br><span class="line"><span class="comment"> * - videoIdsï¼šæ–°å¢æ—¶å¿…å¡«ï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/saveVideoSeries&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">saveVideoSeries</span>(<span class="params"><span class="title class_">Integer</span> seriesId,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@NotEmpty</span> <span class="meta">@Size</span>(max = <span class="number">100</span>) <span class="title class_">String</span> seriesName,</span></span><br><span class="line"><span class="params">                                  <span class="meta">@Size</span>(max = <span class="number">200</span>) <span class="title class_">String</span> seriesDescription,</span></span><br><span class="line"><span class="params">                                  <span class="title class_">String</span> videoIds</span>) &#123;</span><br><span class="line">    <span class="title class_">TokenUserInfoDto</span> token = <span class="title function_">getTokenUserInfoDto</span>();</span><br><span class="line"></span><br><span class="line">    <span class="title class_">UserVideoSeries</span> bean = <span class="keyword">new</span> <span class="title class_">UserVideoSeries</span>();</span><br><span class="line">    bean.<span class="title function_">setUserId</span>(token.<span class="title function_">getUserId</span>());</span><br><span class="line">    bean.<span class="title function_">setSeriesId</span>(seriesId);</span><br><span class="line">    bean.<span class="title function_">setSeriesName</span>(seriesName);</span><br><span class="line">    bean.<span class="title function_">setSeriesDescription</span>(seriesDescription);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// äº¤ç”± Serviceï¼šæ ¡éªŒ + äº‹åŠ¡ä¿å­˜</span></span><br><span class="line">    userVideoSeriesService.<span class="title function_">saveUserVideoSeries</span>(bean, videoIds);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŠ è½½â€œå¯åŠ å…¥è¯¥åˆé›†â€çš„å…¨éƒ¨è§†é¢‘</span></span><br><span class="line"><span class="comment"> * - è‹¥ä¼ äº† seriesIdï¼šæ’é™¤å·²åœ¨æ­¤åˆé›†å†…çš„è§†é¢‘</span></span><br><span class="line"><span class="comment"> * - ä»…è¿”å›â€œå½“å‰ç™»å½•ç”¨æˆ·â€çš„è§†é¢‘</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/loadAllVideo&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">loadAllVideo</span>(<span class="params"><span class="title class_">Integer</span> seriesId</span>) &#123;</span><br><span class="line">    <span class="title class_">TokenUserInfoDto</span> token = <span class="title function_">getTokenUserInfoDto</span>();</span><br><span class="line"></span><br><span class="line">    <span class="title class_">VideoInfoQuery</span> infoQuery = <span class="keyword">new</span> <span class="title class_">VideoInfoQuery</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ç¼–è¾‘å·²æœ‰åˆé›†ï¼šæŠŠå·²åœ¨åˆé›†é‡Œçš„è§†é¢‘æ’é™¤æ‰ï¼Œé¿å…å‰ç«¯é‡å¤æ·»åŠ </span></span><br><span class="line">    <span class="keyword">if</span> (seriesId != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title class_">UserVideoSeriesVideoQuery</span> q = <span class="keyword">new</span> <span class="title class_">UserVideoSeriesVideoQuery</span>();</span><br><span class="line">        q.<span class="title function_">setSeriesId</span>(seriesId);</span><br><span class="line">        q.<span class="title function_">setUserId</span>(token.<span class="title function_">getUserId</span>());</span><br><span class="line">        <span class="title class_">List</span>&lt;<span class="title class_">UserVideoSeriesVideo</span>&gt; seriesVideoList =</span><br><span class="line">            userVideoSeriesVideoService.<span class="title function_">findListByParam</span>(q);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">List</span>&lt;<span class="title class_">String</span>&gt; already = seriesVideoList.<span class="title function_">stream</span>()</span><br><span class="line">                              .<span class="title function_">map</span>(<span class="title class_">UserVideoSeriesVideo</span>::getVideoId)</span><br><span class="line">                              .<span class="title function_">collect</span>(<span class="title class_">Collectors</span>.<span class="title function_">toList</span>());</span><br><span class="line">        infoQuery.<span class="title function_">setExcludeVideoIdArray</span>(already.<span class="title function_">toArray</span>(<span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    infoQuery.<span class="title function_">setUserId</span>(token.<span class="title function_">getUserId</span>()); <span class="comment">// åªçœ‹æˆ‘è‡ªå·±çš„è§†é¢‘</span></span><br><span class="line">    <span class="title class_">List</span>&lt;<span class="title class_">VideoInfo</span>&gt; videoInfoList = videoInfoService.<span class="title function_">findListByParam</span>(infoQuery);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(videoInfoList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>VideoInfoQuery</code> é‡Œæ–°å¢ä¸¤ä¸ªæ•°ç»„å­—æ®µï¼š<code>videoIdArray</code> &amp; <code>excludeVideoIdArray</code>ï¼Œå¹¶åœ¨å…¶ XML <code>query_condition</code> ä¸­åˆ†åˆ«å†™ <code>IN</code> å’Œ <code>NOT IN</code> æ¡ä»¶ï¼ˆè§ä¸‹æ–¹ï¼‰ã€‚</p>
<p>UserVideoSeriesService</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** è·å–ç”¨æˆ·æ‰€æœ‰åˆé›†ï¼ˆå«å°é¢ï¼‰ */</span></span><br><span class="line">    <span class="function">List&lt;UserVideoSeries&gt; <span class="title">getUserAllSeries</span><span class="params">(<span class="type">String</span> userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** æ–°å¢/ç¼–è¾‘åˆé›†ï¼›æ–°å¢åœºæ™¯ä¼šé¡ºä¾¿æ’å…¥è§†é¢‘ */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">saveUserVideoSeries</span><span class="params">(UserVideoSeries videoSeries, <span class="type">String</span> videoIds)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** å‘å·²æœ‰åˆé›†é‡Œè¿½åŠ è§†é¢‘ï¼ˆå¯å¤šé€‰ï¼‰ */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">saveSeriesVideo</span><span class="params">(<span class="type">String</span> userId, Integer seriesId, <span class="type">String</span> videoIds)</span></span>;</span><br></pre></td></tr></table></figure>
<p>UserVideoSeriesServiceImplï¼Œè¿™é‡Œè¿˜è¦åŠ ä¸Šä¸€ä¸ªæ•ˆéªŒidçš„æ–¹æ³•å’Œä¿å­˜è§†é¢‘åˆ°åˆé›†ä¸­çš„æ–¹æ³•</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@Transactional</span>(rollbackFor = <span class="title class_">Exception</span>.<span class="property">class</span>)</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">saveUserVideoSeries</span>(<span class="params"><span class="title class_">UserVideoSeries</span> bean, <span class="title class_">String</span> videoIds</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (bean.<span class="title function_">getSeriesId</span>() == <span class="literal">null</span> &amp;&amp; <span class="title class_">StringTools</span>.<span class="title function_">isEmpty</span>(videoIds)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="title class_">ResponseCodeEnum</span>.<span class="property">CODE_600</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (bean.<span class="title function_">getSeriesId</span>() == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="title function_">checkVideoIds</span>(bean.<span class="title function_">getUserId</span>(), videoIds);</span><br><span class="line">			bean.<span class="title function_">setUpdateTime</span>(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">			bean.<span class="title function_">setSort</span>(<span class="variable language_">this</span>.<span class="property">userVideoSeriesMapper</span>.<span class="title function_">selectMaxSort</span>(bean.<span class="title function_">getUserId</span>()) + <span class="number">1</span>);</span><br><span class="line">			<span class="variable language_">this</span>.<span class="property">userVideoSeriesMapper</span>.<span class="title function_">insert</span>(bean);</span><br><span class="line">			<span class="variable language_">this</span>.<span class="title function_">saveSeriesVideo</span>(bean.<span class="title function_">getUserId</span>(), bean.<span class="title function_">getSeriesId</span>(), videoIds);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="title class_">UserVideoSeriesQuery</span> seriesQuery = <span class="keyword">new</span> <span class="title class_">UserVideoSeriesQuery</span>();</span><br><span class="line">			seriesQuery.<span class="title function_">setUserId</span>(bean.<span class="title function_">getUserId</span>());</span><br><span class="line">			seriesQuery.<span class="title function_">setSeriesId</span>(bean.<span class="title function_">getSeriesId</span>());</span><br><span class="line">			<span class="variable language_">this</span>.<span class="property">userVideoSeriesMapper</span>.<span class="title function_">updateByParam</span>(bean, seriesQuery);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//æ ¡éªŒè§†é¢‘idï¼Œé˜²æ­¢æŠŠåˆ«äººçš„è§†é¢‘åŠ åˆ°è‡ªå·±çš„è§†é¢‘åˆé›†é‡Œ</span></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">void</span> <span class="title function_">checkVideoIds</span>(<span class="params"><span class="title class_">String</span> userId, <span class="title class_">String</span> videoIds</span>) &#123;</span><br><span class="line">		<span class="title class_">String</span>[] videoIdArray = videoIds.<span class="title function_">split</span>(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">		<span class="title class_">VideoInfoQuery</span> videoInfoQuery = <span class="keyword">new</span> <span class="title class_">VideoInfoQuery</span>();</span><br><span class="line">		videoInfoQuery.<span class="title function_">setVideoIdArray</span>(videoIdArray);</span><br><span class="line">		videoInfoQuery.<span class="title function_">setUserId</span>(userId);</span><br><span class="line">		<span class="title class_">Integer</span> count = videoInfoMapper.<span class="title function_">selectCount</span>(videoInfoQuery);</span><br><span class="line">		<span class="keyword">if</span> (videoIdArray.<span class="property">length</span> != count) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="title class_">ResponseCodeEnum</span>.<span class="property">CODE_600</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">saveSeriesVideo</span>(<span class="params"><span class="title class_">String</span> userId, <span class="title class_">Integer</span> seriesId, <span class="title class_">String</span> videoIds</span>) &#123;</span><br><span class="line">		<span class="title class_">UserVideoSeries</span> userVideoSeries = <span class="title function_">getUserVideoSeriesBySeriesId</span>(seriesId);</span><br><span class="line">		<span class="keyword">if</span> (!userVideoSeries.<span class="title function_">getUserId</span>().<span class="title function_">equals</span>(userId)) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="title class_">ResponseCodeEnum</span>.<span class="property">CODE_600</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="title function_">checkVideoIds</span>(userId, videoIds);</span><br><span class="line">		<span class="title class_">String</span>[] videoIdArray = videoIds.<span class="title function_">split</span>(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">		<span class="title class_">Integer</span> sort = <span class="variable language_">this</span>.<span class="property">userVideoSeriesVideoMapper</span>.<span class="title function_">selectMaxSort</span>(seriesId);</span><br><span class="line">		<span class="title class_">List</span>&lt;<span class="title class_">UserVideoSeriesVideo</span>&gt; seriesVideoList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">		<span class="keyword">for</span> (<span class="title class_">String</span> videoId : videoIdArray) &#123;</span><br><span class="line">			<span class="title class_">UserVideoSeriesVideo</span> videoSeriesVideo = <span class="keyword">new</span> <span class="title class_">UserVideoSeriesVideo</span>();</span><br><span class="line">			videoSeriesVideo.<span class="title function_">setVideoId</span>(videoId);</span><br><span class="line">			videoSeriesVideo.<span class="title function_">setSort</span>(++sort);</span><br><span class="line">			videoSeriesVideo.<span class="title function_">setSeriesId</span>(seriesId);</span><br><span class="line">			videoSeriesVideo.<span class="title function_">setUserId</span>(userId);</span><br><span class="line">			seriesVideoList.<span class="title function_">add</span>(videoSeriesVideo);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable language_">this</span>.<span class="property">userVideoSeriesVideoMapper</span>.<span class="title function_">insertOrUpdateBatch</span>(seriesVideoList);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨VideoInfoMapperXMLä¸­åŠ å…¥è¡¥å……çš„æ¡ä»¶</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1035-978x1024.png" alt="img"></p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;query_condition&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">where</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;base_condition_filed&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.videoIdFuzzy!= null  and query.videoIdFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            and v.video_id like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.videoIdFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.videoCoverFuzzy!= null  and query.videoCoverFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            and v.video_cover like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.videoCoverFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.videoNameFuzzy!= null  and query.videoNameFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            and v.video_name like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.videoNameFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.userIdFuzzy!= null  and query.userIdFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            and v.user_id like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.userIdFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.createTimeStart!= null and query.createTimeStart!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            &lt;![CDATA[ and  v.create_time&gt;=str_to_date(#</span><span class="template-variable">&#123;query.createTimeStart&#125;</span><span class="language-xml">, &#x27;%Y-%m-%d&#x27;) ]]&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.createTimeEnd!= null and query.createTimeEnd!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            &lt;![CDATA[ and  v.create_time&lt; date_sub(str_to_date(#</span><span class="template-variable">&#123;query.createTimeEnd&#125;</span><span class="language-xml">,&#x27;%Y-%m-%d&#x27;),interval -1 day) ]]&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.lastUpdateTimeStart!= null and query.lastUpdateTimeStart!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            &lt;![CDATA[ and  v.last_update_time&gt;=str_to_date(#</span><span class="template-variable">&#123;query.lastUpdateTimeStart&#125;</span><span class="language-xml">, &#x27;%Y-%m-%d&#x27;) ]]&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.lastUpdateTimeEnd!= null and query.lastUpdateTimeEnd!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            &lt;![CDATA[ and  v.last_update_time&lt; date_sub(str_to_date(#</span><span class="template-variable">&#123;query.lastUpdateTimeEnd&#125;</span><span class="language-xml">,&#x27;%Y-%m-%d&#x27;),interval -1 day) ]]&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.originInfoFuzzy!= null  and query.originInfoFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            and v.origin_info like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.originInfoFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.tagsFuzzy!= null  and query.tagsFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            and v.tags like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.tagsFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.introductionFuzzy!= null  and query.introductionFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            and v.introduction like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.introductionFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.interactionFuzzy!= null  and query.interactionFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            and v.interaction like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.interactionFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.lastPlayTimeStart!= null and query.lastPlayTimeStart!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            &lt;![CDATA[ and  v.last_play_time&gt;=str_to_date(#</span><span class="template-variable">&#123;query.lastPlayTimeStart&#125;</span><span class="language-xml">, &#x27;%Y-%m-%d&#x27;) ]]&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.lastPlayTimeEnd!= null and query.lastPlayTimeEnd!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            &lt;![CDATA[ and  v.last_play_time&lt; date_sub(str_to_date(#</span><span class="template-variable">&#123;query.lastPlayTimeEnd&#125;</span><span class="language-xml">,&#x27;%Y-%m-%d&#x27;),interval -1 day) ]]&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="comment">&lt;!--è¡¥å……çš„æ¡ä»¶--&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.videoIdArray!=null and query.videoIdArray.length&gt;0&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            and video_id in(<span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;query.videoIdArray&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span> <span class="attr">item</span>=<span class="string">&quot;item&quot;</span>&gt;</span>#</span><span class="template-variable">&#123;item&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">foreach</span>&gt;</span>)</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.excludeVideoIdArray!=null and query.excludeVideoIdArray.length&gt;0&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			 and video_id not in(<span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;query.excludeVideoIdArray&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span> <span class="attr">item</span>=<span class="string">&quot;item&quot;</span>&gt;</span>#</span><span class="template-variable">&#123;item&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">foreach</span>&gt;</span>)</span></span><br><span class="line"><span class="language-xml">		 <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>UserVideoSeriesMapperä¸­</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * è·å–ç”¨æˆ·åˆé›†æœ€å¤§æ’åºå€¼</span></span><br><span class="line"><span class="comment">	 * @param userId</span></span><br><span class="line"><span class="comment">	 * @return</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="selector-tag">Integer</span> <span class="selector-tag">selectMaxSort</span>(<span class="variable">@Param</span>(<span class="string">&quot;userId&quot;</span>) String userId);</span><br></pre></td></tr></table></figure>
<p>UserVideoSeriesMapperXMLä¸­</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"> <span class="comment">&lt;!-- è·å–ç”¨æˆ·è§†é¢‘åˆé›†æœ€å¤§æ’åºå€¼--&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectMaxSort&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;java.lang.Integer&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	select ifnull(max(sort),0) from user_video_series u where user_id=#</span><span class="template-variable">&#123;userId&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>UserVideoSeriesVideoMapperä¸­</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®SeriesIdè·å–æœ€å¤§æ’åºå€¼</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="selector-tag">Integer</span> <span class="selector-tag">selectMaxSort</span>(<span class="variable">@Param</span>(<span class="string">&quot;seriesId&quot;</span>) Integer seriesId);</span><br></pre></td></tr></table></figure>
<p>UserVideoSeriesVideoMapperXMLä¸­</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!-- è·å–åˆé›†ä¸­è§†é¢‘çš„æœ€å¤§æ’åºå€¼--&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectMaxSort&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;java.lang.Integer&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">		select ifnull(max(sort),0) from user_video_series_video u where series_id=#</span><span class="template-variable">&#123;seriesId&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>æ³¨æ„åœ¨VideoInfoQueryä¸­åŠ å…¥è¿™2ä¸ªå­—æ®µåŠå…¶å¯¹åº”æ–¹æ³•</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * è§†é¢‘IDæ•°ç»„ï¼Œç”¨äºæ‰¹é‡æŸ¥è¯¢</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">String</span>[] videoIdArray;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * æ’é™¤è§†é¢‘IDæ•°ç»„ï¼Œç”¨äºæ‰¹é‡æŸ¥è¯¢æ—¶æ’é™¤æŸäº›è§†é¢‘</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">String</span>[] excludeVideoIdArray;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1036.png" alt="img"></p>
<p>æµ‹è¯•</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1018-1024x469.png" alt="img"></p>
<p>ç‚¹å‡»ä¸‹ä¸€æ­¥</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1019-1024x411.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1022-1024x521.png" alt="img"></p>
<h4 id="3-æ·»åŠ getVideoSeriesDetailæ¥å£ï¼Œå½“åœ¨åˆé›†é¡µé¢ç‚¹å‡»åˆé›†é‡Œçš„ä»»æ„è§†é¢‘å°±å¯ä»¥è¿›å…¥è§†é¢‘è¯¦æƒ…é¡µ">3.æ·»åŠ getVideoSeriesDetailæ¥å£ï¼Œå½“åœ¨åˆé›†é¡µé¢ç‚¹å‡»åˆé›†é‡Œçš„ä»»æ„è§†é¢‘å°±å¯ä»¥è¿›å…¥è§†é¢‘è¯¦æƒ…é¡µ</h4>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1037.png" alt="img"></p>
<p>UHomeVideoSeriesControlleræ·»åŠ getVideoSeriesDetailæ¥å£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@RequestMapping(&quot;/getVideoSeriesDetail&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseVO <span class="title function_">getVideoSeriesDetail</span><span class="params">(<span class="meta">@NotNull</span> Integer seriesId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1) æŸ¥è¯¢åˆé›†åŸºæœ¬ä¿¡æ¯ï¼ˆåŒ…æ‹¬åç§°ã€æè¿°ã€æ’åºã€å½’å±ç”¨æˆ·ç­‰ï¼‰</span></span><br><span class="line">    <span class="type">UserVideoSeries</span> <span class="variable">videoSeries</span> <span class="operator">=</span> userVideoSeriesService.getUserVideoSeriesBySeriesId(seriesId);</span><br><span class="line">    <span class="keyword">if</span> (videoSeries == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// åˆé›†ä¸å­˜åœ¨ â†’ è¿”å› 404</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_404);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) ç»„è£…æŸ¥è¯¢æ¡ä»¶ï¼šå–åˆé›†å†…è§†é¢‘ï¼›éœ€è¦è”è¡¨è§†é¢‘ä¿¡æ¯ï¼›æŒ‰åˆé›†å†…æ’åºå‡åº</span></span><br><span class="line">    <span class="type">UserVideoSeriesVideoQuery</span> <span class="variable">videoSeriesVideoQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserVideoSeriesVideoQuery</span>();</span><br><span class="line">    videoSeriesVideoQuery.setOrderBy(<span class="string">&quot;sort asc&quot;</span>);     <span class="comment">// æŒ‰åˆé›†å†…è‡ªå®šä¹‰é¡ºåºå±•ç¤º</span></span><br><span class="line">    videoSeriesVideoQuery.setQueryVideoInfo(<span class="literal">true</span>);    <span class="comment">// éœ€è¦è¿ video_info å–å±•ç¤ºå­—æ®µ</span></span><br><span class="line">    videoSeriesVideoQuery.setSeriesId(seriesId);      <span class="comment">// ç›®æ ‡åˆé›†ID</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) æŸ¥è¯¢åˆé›†å†…çš„è§†é¢‘åˆ—è¡¨ï¼ˆæ¯æ¡å¸¦ä¸Šè§†é¢‘çš„å°é¢ã€æ ‡é¢˜ã€æ’­æ”¾é‡ä¸åˆ›å»ºæ—¶é—´ï¼‰</span></span><br><span class="line">    List&lt;UserVideoSeriesVideo&gt; seriesVideoList =</span><br><span class="line">        userVideoSeriesVideoService.findListByParam(videoSeriesVideoQuery);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) ç»„åˆä¸ºä¸€ä¸ª VOï¼Œä¸€æ¬¡æ€§è¿”å›ç»™å‰ç«¯</span></span><br><span class="line">    <span class="keyword">return</span> getSuccessResponseVO(<span class="keyword">new</span> <span class="title class_">UserVideoSeriesDetailVO</span>(videoSeries, seriesVideoList));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥æ¥å£å¹¶æœªæ ¡éªŒâ€œæ˜¯å¦ä¸ºæœ¬äººåˆé›†â€ï¼Œè¯´æ˜åˆé›†è¯¦æƒ…<strong>å±äºå…¬å¼€å¯æµè§ˆ</strong>çš„åœºæ™¯ï¼›å¦‚æœæœ‰â€œç§å¯†åˆé›†â€éœ€æ±‚ï¼Œéœ€è¦åœ¨ Service é‡Œè¡¥å……â€œæƒé™/å¯è§æ€§â€æ‹¦æˆª</p>
<p>åˆ›å»º UserVideoSeriesDetailVO</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.entity.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.po.UserVideoSeries;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.po.UserVideoSeriesVideo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserVideoSeriesDetailVO</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> UserVideoSeries videoSeries;</span><br><span class="line">    <span class="keyword">private</span> List&lt;UserVideoSeriesVideo&gt; seriesVideoList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserVideoSeriesDetailVO</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserVideoSeriesDetailVO</span><span class="params">(UserVideoSeries videoSeries, List&lt;UserVideoSeriesVideo&gt; seriesVideoList)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.videoSeries = videoSeries;</span><br><span class="line">        <span class="built_in">this</span>.seriesVideoList = seriesVideoList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> UserVideoSeries <span class="title function_">getVideoSeries</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> videoSeries;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setVideoSeries</span><span class="params">(UserVideoSeries videoSeries)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.videoSeries = videoSeries;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;UserVideoSeriesVideo&gt; <span class="title function_">getSeriesVideoList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> seriesVideoList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSeriesVideoList</span><span class="params">(List&lt;UserVideoSeriesVideo&gt; seriesVideoList)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.seriesVideoList = seriesVideoList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1039-1024x784.png" alt="img"></p>
<p>åœ¨ UserVideoSeriesVideoQueryåˆ›å»ºä¸€ä¸ªå­—æ®µåŠå…¶å¯¹åº”æ–¹æ³•</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * æ˜¯å¦æŸ¥è¯¢è§†é¢‘ä¿¡æ¯</span></span><br><span class="line"><span class="comment">	 * @param seriesId</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">Boolean</span> queryVideoInfo;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1040.png" alt="img"></p>
<p>åœ¨UserVideoSeriesVideoMapperXmlä¸­ï¼Œæ·»åŠ VideoInfoçš„å­—æ®µ</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!-- UserVideoSeriesVideoMapper.xml --&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="comment">&lt;!-- åˆé›†-è§†é¢‘ å…³ç³»è¡¨çš„é€šç”¨æŸ¥è¯¢ï¼šå¯é€‰è”è¡¨ video_info å¸¦å‡ºå±•ç¤ºå­—æ®µ --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectList&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;base_result_map&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  SELECT</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;base_column_list&quot;</span>/&gt;</span>   <span class="comment">&lt;!-- å…³ç³»è¡¨åŸºç¡€åˆ—ï¼šidã€series_idã€video_idã€sortã€user_id ç­‰ --&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!-- éœ€è¦å±•ç¤ºè§†é¢‘ä¿¡æ¯æ—¶ï¼Œé¢å¤–é€‰æ‹©è§†é¢‘çš„å±•ç¤ºå­—æ®µ --&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.queryVideoInfo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      , v.video_cover</span></span><br><span class="line"><span class="language-xml">      , v.video_name</span></span><br><span class="line"><span class="language-xml">      , v.play_count</span></span><br><span class="line"><span class="language-xml">      , v.create_time</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  FROM user_video_series_video u</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="comment">&lt;!-- æŒ‰éœ€è”è¡¨ï¼šåªæœ‰ queryVideoInfo=true æ‰ INNER JOIN video_info --&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.queryVideoInfo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    INNER JOIN video_info v ON v.video_id = u.video_id</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="comment">&lt;!-- é€šç”¨ where æ¡ä»¶ï¼ˆseriesId / userId / å…¶å®ƒç­›é€‰ï¼‰ --&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;query_condition&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="comment">&lt;!-- æ’åºï¼šä½¿ç”¨åç«¯ç™½åå•åˆ—åï¼›æ­¤å¤„ä¼ å…¥çš„æ˜¯ &#x27;sort asc&#x27; --&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.orderBy != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    ORDER BY $</span><span class="template-variable">&#123;query.orderBy&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="comment">&lt;!-- åˆ†é¡µ --&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.simplePage != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    LIMIT #</span><span class="template-variable">&#123;query.simplePage.start&#125;</span><span class="language-xml">, #</span><span class="template-variable">&#123;query.simplePage.end&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><strong>å®‰å…¨è¦ç‚¹</strong></p>
<ul>
<li><code>$&#123;query.orderBy&#125;</code> å¿…é¡»ä¸¥æ ¼<strong>ç™½åå•</strong>ï¼ˆåªå…è®¸ <code>sort asc/desc</code> æˆ–å›ºå®šæ‹¼æ¥ï¼‰ï¼Œä¸è¦ç›´æ¥é€ä¼ å‰ç«¯å­—æ®µï¼Œé˜²æ³¨å…¥ã€‚</li>
<li><code>INNER JOIN</code> åœ¨ä½ ç»™çš„åœºæ™¯é‡Œæ˜¯åˆç†çš„ï¼šåˆé›†å†…è§†é¢‘åº”å½“å­˜åœ¨äº <code>video_info</code>ï¼Œè‹¥è¦å…¼å®¹â€œè½¯åˆ è§†é¢‘â€å¯ä»¥æ”¹ä¸º <code>LEFT JOIN</code> å¹¶åœ¨ where é‡Œè¿‡æ»¤çŠ¶æ€ã€‚</li>
</ul>
<p>åœ¨UserVideoSeriesVideoä¸­åŠ å…¥è¿™4ä¸ªå­—æ®µå’Œç›¸åº”æ–¹æ³•</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è§†é¢‘å°é¢å›¾</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">String</span> videoCover;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è§†é¢‘åç§°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">String</span> videoName;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç‚¹å‡»é‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Integer playCount;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ›å»ºæ—¶é—´</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">       </span><br><span class="line">       <span class="meta">@JsonFormat</span>(pattern = <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>, timezone = <span class="string">&quot;GMT+8&quot;</span>)</span><br><span class="line"><span class="meta">@DateTimeFormat</span>(pattern = <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)</span><br><span class="line"><span class="keyword">private</span> Date createTime;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1041.png" alt="img"></p>
<p>æµ‹è¯•</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1024-1024x497.png" alt="img"></p>
<h4 id="4-åœ¨å·²æœ‰çš„åˆé›†é‡Œæ·»åŠ è§†é¢‘ï¼Œåˆ é™¤å·²æœ‰åˆé›†ä¸­çš„è§†é¢‘ï¼Œåˆ é™¤æ•´ä¸ªåˆé›†">4.åœ¨å·²æœ‰çš„åˆé›†é‡Œæ·»åŠ è§†é¢‘ï¼Œåˆ é™¤å·²æœ‰åˆé›†ä¸­çš„è§†é¢‘ï¼Œåˆ é™¤æ•´ä¸ªåˆé›†</h4>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1026-1024x278.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1043.png" alt="img"></p>
<p>UHomeVideoSeriesController ä¸­æ·»åŠ è¿™3ä¸ªæ¥å£</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ä¿å­˜ç³»åˆ—è§†é¢‘</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> <span class="variable">seriesId</span></span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> <span class="variable">videoIds</span></span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@RequestMapping</span>(<span class="string">&quot;/saveSeriesVideo&quot;</span>)</span><br><span class="line">   <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">saveSeriesVideo</span>(<span class="params"><span class="meta">@NotNull</span> <span class="title class_">Integer</span> seriesId, <span class="meta">@NotEmpty</span> <span class="title class_">String</span> videoIds</span>) &#123;</span><br><span class="line">       <span class="title class_">TokenUserInfoDto</span> tokenUserInfoDto = <span class="title function_">getTokenUserInfoDto</span>();</span><br><span class="line">       userVideoSeriesService.<span class="title function_">saveSeriesVideo</span>(tokenUserInfoDto.<span class="title function_">getUserId</span>(), seriesId, videoIds);</span><br><span class="line">       <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(<span class="literal">null</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * åˆ é™¤è§†é¢‘</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> <span class="variable">seriesId</span></span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> <span class="variable">videoId</span></span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@RequestMapping</span>(<span class="string">&quot;/delSeriesVideo&quot;</span>)</span><br><span class="line">   <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">delSeriesVideo</span>(<span class="params"><span class="meta">@NotNull</span> <span class="title class_">Integer</span> seriesId, <span class="meta">@NotEmpty</span> <span class="title class_">String</span> videoId</span>) &#123;</span><br><span class="line">       <span class="title class_">TokenUserInfoDto</span> tokenUserInfoDto = <span class="title function_">getTokenUserInfoDto</span>();</span><br><span class="line">       userVideoSeriesService.<span class="title function_">delSeriesVideo</span>(tokenUserInfoDto.<span class="title function_">getUserId</span>(), seriesId, videoId);</span><br><span class="line">       <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(<span class="literal">null</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * åˆ é™¤ç³»åˆ—</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> <span class="variable">seriesId</span></span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@RequestMapping</span>(<span class="string">&quot;/delVideoSeries&quot;</span>)</span><br><span class="line">   <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">delVideoSeries</span>(<span class="params"><span class="meta">@NotNull</span> <span class="title class_">Integer</span> seriesId</span>) &#123;</span><br><span class="line">       <span class="title class_">TokenUserInfoDto</span> tokenUserInfoDto = <span class="title function_">getTokenUserInfoDto</span>();</span><br><span class="line">       userVideoSeriesService.<span class="title function_">delVideoSeries</span>(tokenUserInfoDto.<span class="title function_">getUserId</span>(), seriesId);</span><br><span class="line">       <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(<span class="literal">null</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>Serviceä¸­</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/** å‘å·²æœ‰åˆé›†é‡Œè¿½åŠ è§†é¢‘ï¼ˆæ‰¹é‡ï¼‰ */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">saveSeriesVideo</span><span class="params">(<span class="type">String</span> userId, Integer seriesId, <span class="type">String</span> videoIds)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** åˆ é™¤åˆé›†ä¸­çš„ä¸€ä¸ªè§†é¢‘ */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">delSeriesVideo</span><span class="params">(<span class="type">String</span> userId, Integer seriesId, <span class="type">String</span> videoId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** åˆ é™¤æ•´ä¸ªåˆé›†ï¼ˆå«æ¸…ç©ºè¯¥åˆé›†ä¸‹çš„æ‰€æœ‰è§†é¢‘å…³ç³»ï¼‰ */</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">delVideoSeries</span><span class="params">(<span class="type">String</span> userId, Integer seriesId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * åˆ é™¤åˆé›†é‡Œçš„æŸä¸€ä¸ªè§†é¢‘ï¼ˆä»…åˆ é™¤å…³ç³»ï¼Œä¸åŠ¨è§†é¢‘æœ¬èº«ï¼‰</span></span><br><span class="line"><span class="comment">    * - WHERE user_id = ? AND series_id = ? AND video_id = ?</span></span><br><span class="line"><span class="comment">    * - ä¿è¯åªèƒ½åˆ è‡ªå·±çš„åˆé›†å†…å®¹</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delSeriesVideo</span><span class="params">(String userId, Integer seriesId, String videoId)</span> &#123;</span><br><span class="line">       <span class="type">UserVideoSeriesVideoQuery</span> <span class="variable">q</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserVideoSeriesVideoQuery</span>();</span><br><span class="line">       q.setUserId(userId);</span><br><span class="line">       q.setSeriesId(seriesId);</span><br><span class="line">       q.setVideoId(videoId);</span><br><span class="line">       userVideoSeriesVideoMapper.deleteByParam(q);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * åˆ é™¤æ•´ä¸ªåˆé›†ï¼ˆäº‹åŠ¡ï¼‰</span></span><br><span class="line"><span class="comment">    * 1) å…ˆåˆ ä¸»è¡¨ï¼ˆæŒ‰ user_id + series_idï¼‰ï¼›å—å½±å“è¡Œæ•°ä¸º 0 -&gt; éæ³•æˆ–éæœ¬äººï¼ŒæŠ›å¼‚å¸¸</span></span><br><span class="line"><span class="comment">    * 2) å†åˆ å…³ç³»è¡¨ä¸­è¯¥ series_id çš„æ‰€æœ‰è®°å½•ï¼ˆåªåˆ å½“å‰ç”¨æˆ·åä¸‹ï¼ŒåŒä¿é™©ï¼‰</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delVideoSeries</span><span class="params">(String userId, Integer seriesId)</span> &#123;</span><br><span class="line">       <span class="comment">// åˆ é™¤ä¸»è¡¨ï¼ˆåªä¼šåˆ é™¤å½“å‰ç”¨æˆ·çš„åŒååˆé›†ï¼‰</span></span><br><span class="line">       <span class="type">UserVideoSeriesQuery</span> <span class="variable">seriesQ</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserVideoSeriesQuery</span>();</span><br><span class="line">       seriesQ.setUserId(userId);</span><br><span class="line">       seriesQ.setSeriesId(seriesId);</span><br><span class="line">       <span class="type">Integer</span> <span class="variable">affected</span> <span class="operator">=</span> userVideoSeriesMapper.deleteByParam(seriesQ);</span><br><span class="line">       <span class="keyword">if</span> (affected == <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="comment">// ä¸æ˜¯ä½ çš„åˆé›†æˆ–è¯¥åˆé›†ä¸å­˜åœ¨</span></span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// æ¸…ç©ºè¯¥åˆé›†çš„å…¨éƒ¨è§†é¢‘å…³ç³»</span></span><br><span class="line">       <span class="type">UserVideoSeriesVideoQuery</span> <span class="variable">relQ</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserVideoSeriesVideoQuery</span>();</span><br><span class="line">       relQ.setSeriesId(seriesId);</span><br><span class="line">       relQ.setUserId(userId);</span><br><span class="line">       userVideoSeriesVideoMapper.deleteByParam(relQ);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨ï¼šsaveSeriesVideoæˆ‘ä»¬åœ¨å‰é¢å·²ç»å®ç°è¿‡äº†</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1044.png" alt="img"></p>
<p>æµ‹è¯•ä¹‹åæ²¡é—®é¢˜</p>
<h4 id="5-å¯¹åˆé›†è¿›è¡Œæ’åº">5.å¯¹åˆé›†è¿›è¡Œæ’åº</h4>
<p>å¯¹åˆé›†é‡Œçš„è§†é¢‘è¿›è¡Œæ’åºè°ƒç”¨çš„æ˜¯saveSeriesVideoè¿™ä¸ªæ¥å£æˆ‘ä»¬å·²ç»å®ç°è¿‡äº†</p>
<p>æ¥ä¸‹æ¥éœ€è¦å®ç°å¯¹åˆé›†è¿›è¡Œæ’åº</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1048.png" alt="img"></p>
<p>UHomeVideoSeriesControllerä¸­</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç”¨æˆ·ä¸­å¿ƒï¼šå¯¹â€œè§†é¢‘åˆé›†â€è¿›è¡Œæ’åº</span></span><br><span class="line"><span class="comment"> * æ¥å£çº¦å®šï¼šseriesIds ä¸ºâ€œæ–°é¡ºåºâ€è‡ªå·¦è‡³å³çš„ seriesId åˆ—è¡¨ï¼Œé€—å·åˆ†éš”</span></span><br><span class="line"><span class="comment"> * ä¾‹å¦‚ï¼š12,5,9,3  â†’  sort: 12â†’1, 5â†’2, 9â†’3, 3â†’4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/changeVideoSeriesSort&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">changeVideoSeriesSort</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="title class_">String</span> seriesIds</span>) &#123;</span><br><span class="line">    <span class="comment">// å–å½“å‰ç™»å½•ç”¨æˆ·ï¼ˆè°åœ¨æ“ä½œè‡ªå·±çš„åˆé›†ï¼‰</span></span><br><span class="line">    <span class="title class_">TokenUserInfoDto</span> tokenUserInfoDto = <span class="title function_">getTokenUserInfoDto</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å§”æ‰˜ä¸šåŠ¡å±‚åšï¼šå…¥å‚è§£æã€å½’å±æ ¡éªŒï¼ˆå¯é€‰å¢å¼ºï¼‰ã€æ‰¹é‡æ›´æ–°</span></span><br><span class="line">    userVideoSeriesService.<span class="title function_">changeVideoSeriesSort</span>(tokenUserInfoDto.<span class="title function_">getUserId</span>(), seriesIds);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›ç®€å•æˆåŠŸå³å¯ï¼Œå‰ç«¯å¯è‡ªè¡Œåˆ·æ–°åˆ—è¡¨</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UHomeVideoSeriesServiceimpl</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">changeVideoSeriesSort</span>(<span class="params"><span class="title class_">String</span> userId, <span class="title class_">String</span> seriesIds</span>) &#123;</span><br><span class="line">    <span class="comment">// 1) æ‹†åˆ†ä¸º seriesId æ•°ç»„</span></span><br><span class="line">    <span class="title class_">String</span>[] seriesIdArray = seriesIds.<span class="title function_">split</span>(<span class="string">&quot;,&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯é€‰å¢å¼ºï¼šæ ¡éªŒè¿™äº› seriesId å…¨éƒ½å±äº userIdï¼Œé˜²æ­¢è·¨ç”¨æˆ·æ›´æ–°</span></span><br><span class="line">    <span class="comment">// int cnt = userVideoSeriesMapper.countByUserAndSeriesIds(userId, seriesIdArray);</span></span><br><span class="line">    <span class="comment">// if (cnt != seriesIdArray.length) throw new BusinessException(&quot;å‚æ•°å¼‚å¸¸ï¼šåŒ…å«éæœ¬äººåˆé›†&quot;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) ç»„è£…æ‰¹é‡æ›´æ–°å¯¹è±¡ï¼šæŒ‰ç…§ä¼ å…¥é¡ºåºä» 1 å¼€å§‹é‡å†™ sort</span></span><br><span class="line">    <span class="title class_">List</span>&lt;<span class="title class_">UserVideoSeries</span>&gt; videoSeriesList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="title class_">Integer</span> sort = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="title class_">String</span> seriesId : seriesIdArray) &#123;</span><br><span class="line">        <span class="title class_">UserVideoSeries</span> videoSeries = <span class="keyword">new</span> <span class="title class_">UserVideoSeries</span>();</span><br><span class="line">        videoSeries.<span class="title function_">setUserId</span>(userId);                     <span class="comment">// åªæ›´æ–°â€œæˆ‘çš„â€åˆé›†</span></span><br><span class="line">        videoSeries.<span class="title function_">setSeriesId</span>(<span class="title class_">Integer</span>.<span class="built_in">parseInt</span>(seriesId));</span><br><span class="line">        videoSeries.<span class="title function_">setSort</span>(++sort);                       <span class="comment">// æ–°é¡ºåºï¼š1ã€2ã€3â€¦â€¦</span></span><br><span class="line">        videoSeriesList.<span class="title function_">add</span>(videoSeries);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) æ‰¹é‡æ›´æ–°ï¼ˆåº•å±‚ç”¨ foreach ç”Ÿæˆå¤šæ¡ updateï¼‰</span></span><br><span class="line">    userVideoSeriesMapper.<span class="title function_">changeSort</span>(videoSeriesList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è¯´æ˜ä¸å»ºè®®</strong></p>
<ul>
<li><strong>é¡ºåºæ¥æº</strong>ï¼šä¸¥æ ¼ä»¥å‰ç«¯ <code>seriesIds</code> çš„é¡ºåºä¸ºå‡†ï¼›æ— éœ€ä¼ â€œæ–¹å‘â€ä¸â€œç´¢å¼•â€ã€‚</li>
<li><strong>å½’å±æ ¡éªŒ</strong>ï¼ˆæ¨èï¼‰ï¼šé˜²æ­¢æ„é€ å‚æ•°å»æ›´æ–°ä»–äººçš„åˆé›†æ’åºã€‚</li>
<li><strong>äº‹åŠ¡</strong>ï¼šæœ¬æ“ä½œæ˜¯â€œå¹‚ç­‰é‡æ’â€ï¼Œé€šå¸¸ä¸å¼ºä¾èµ–äº‹åŠ¡ï¼›å¦‚éœ€ä¿è¯<strong>å…¨æˆå…¨è´¥</strong>ï¼Œå¯åœ¨ Service æ–¹æ³•ä¸ŠåŠ  <code>@Transactional</code>ã€‚</li>
</ul>
<p>UserVideoSeriesMapperä¸­</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰¹é‡é‡æ’åˆé›†é¡ºåº</span></span><br><span class="line"><span class="comment"> * @param videoSeriesList æ¯é¡¹åŒ…å« userId / seriesId / sort</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="selector-tag">void</span> <span class="selector-tag">changeSort</span>(<span class="variable">@Param</span>(<span class="string">&quot;videoSeriesList&quot;</span>) List&lt;UserVideoSeries&gt; videoSeriesList);</span><br></pre></td></tr></table></figure>
<p>UserVideoSeriesMapperXmlä¸­</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!-- æ‰¹é‡æ›´æ–°åˆé›†æ’åºï¼ˆé€æ¡ updateï¼‰ --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;changeSort&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;videoSeriesList&quot;</span> <span class="attr">item</span>=<span class="string">&quot;item&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    update user_video_series</span></span><br><span class="line"><span class="language-xml">       set sort = #</span><span class="template-variable">&#123;item.sort&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">     where user_id   = #</span><span class="template-variable">&#123;item.userId&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">       and series_id = #</span><span class="template-variable">&#123;item.seriesId&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><strong>æ³¨æ„äº‹é¡¹</strong></p>
<ul>
<li>
<p>è¿™é‡Œç”¨</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">foreach</span> <span class="built_in">..</span>. <span class="attribute">separator</span>=<span class="string">&quot;;&quot;</span>&gt;</span><br></pre></td></tr></table></figure>
<p>ä¼šæŠŠ</p>
<p>å¤šæ¡ SQL</p>
<p>æ‹¼æˆä¸€æ¡å­—ç¬¦ä¸²æäº¤ï¼ˆ</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update <span class="string">...</span>; update <span class="string">...</span>; <span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>ï¼‰ã€‚</p>
<ul>
<li><strong>MySQL é©±åŠ¨</strong>é»˜è®¤ä¸å…è®¸ä¸€æ¬¡æ‰§è¡Œå¤šæ¡è¯­å¥ï¼Œéœ€è¦åœ¨è¿æ¥ä¸²å¼€å¯ <code>allowMultiQueries=true</code>ï¼›å¦åˆ™å¯èƒ½æŠ¥é”™ã€‚</li>
<li>æˆ–è€…æ”¹ä¸º<strong>å•æ¡ SQL çš„æ‰¹é‡æ›´æ–°</strong>ï¼ˆè§ä¸‹èŠ‚ä¼˜åŒ–ï¼‰ï¼Œé¿å…å¤šè¯­å¥ä¾èµ–ã€‚</li>
</ul>
</li>
<li>
<p>ä¸ºäº†æ’åºç¨³å®šæ€§ä¸æ€§èƒ½ï¼Œç»™è¡¨åŠ ç´¢å¼•ï¼š</p>
<ul>
<li><code>UNIQUE(user_id, series_id)</code>ï¼ˆæˆ–ä½œä¸ºè”åˆä¸»é”®ï¼‰ï¼›</li>
<li><code>INDEX(user_id, sort)</code>ï¼ˆåˆ—è¡¨å±•ç¤ºæ—¶èµ° <code>order by sort</code>ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1049-1024x952.png" alt="img"></p>
<p>æ”¹ä¸ºè¿™ä¸ªchangeSortCaseåæµ‹è¯•ä¹Ÿæ²¡é—®é¢˜</p>
<p>æµ‹è¯•åæ²¡é—®é¢˜</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1031-1024x359.png" alt="img"></p>
<h4 id="6-åˆé›†ä¸­ï¼ˆé»˜è®¤åªå±•ç¤º5æ¡è§†é¢‘ï¼‰ç‚¹æ›´å¤šä¼šæŸ¥è¯¢åˆ°æ‰€æœ‰çš„è§†é¢‘">6.åˆé›†ä¸­ï¼ˆé»˜è®¤åªå±•ç¤º5æ¡è§†é¢‘ï¼‰ç‚¹æ›´å¤šä¼šæŸ¥è¯¢åˆ°æ‰€æœ‰çš„è§†é¢‘</h4>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1052.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1053.png" alt="img"></p>
<p>UHomeVideoSeriesControllerä¸­</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŠ è½½ç”¨æˆ·çš„æ‰€æœ‰è§†é¢‘åˆé›†ï¼Œå¹¶ä¸ºæ¯ä¸ªåˆé›†é™„å¸¦â€œå‰5æ¡è§†é¢‘â€</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/loadVideoSeriesWithVideo&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">loadVideoSeriesWithVideo</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="title class_">String</span> userId</span>) &#123;</span><br><span class="line">    <span class="comment">// 1) ç»„è£…æŸ¥è¯¢ï¼šç”¨æˆ·ID + åˆé›†æ’åºï¼ˆå‡åºï¼‰</span></span><br><span class="line">    <span class="title class_">UserVideoSeriesQuery</span> seriesQuery = <span class="keyword">new</span> <span class="title class_">UserVideoSeriesQuery</span>();</span><br><span class="line">    seriesQuery.<span class="title function_">setUserId</span>(userId);</span><br><span class="line">    seriesQuery.<span class="title function_">setOrderBy</span>(<span class="string">&quot;sort asc&quot;</span>);      <span class="comment">// æ³¨æ„ï¼šæœåŠ¡ç«¯è¦åšç™½åå•æ§åˆ¶ï¼Œé˜²æ³¨å…¥</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) æŸ¥è¯¢ï¼šè¿”å›çš„æ˜¯ List&lt;UserVideoSeries&gt;ï¼Œæ¯æ¡é‡Œä¼šå¸¦ videoInfoListï¼ˆ&lt;=5æ¡ï¼‰</span></span><br><span class="line">    <span class="title class_">List</span>&lt;<span class="title class_">UserVideoSeries</span>&gt; videoSeries = userVideoSeriesService.<span class="title function_">findListWithVideoList</span>(seriesQuery);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) è¿”å›ç»™å‰ç«¯</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(videoSeries);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UserVideoSeriesServiceä¸­</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"><span class="bullet"> *</span> æŸ¥è¯¢è§†é¢‘åˆé›†ï¼Œå¹¶é™„å¸¦è§†é¢‘åˆ—è¡¨</span><br><span class="line"><span class="bullet"> *</span> @param seriesQuery</span><br><span class="line"><span class="bullet"> *</span> @return</span><br><span class="line"> <span class="emphasis">*/</span></span><br><span class="line"><span class="emphasis">List<span class="language-xml"><span class="tag">&lt;<span class="name">UserVideoSeries</span>&gt;</span></span> findListWithVideoList(UserVideoSeriesQuery seriesQuery);</span></span><br></pre></td></tr></table></figure>
<p>UserVideoSeriesServiceImplä¸­</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">List</span>&lt;<span class="title class_">UserVideoSeries</span>&gt; <span class="title function_">findListWithVideoList</span>(<span class="params"><span class="title class_">UserVideoSeriesQuery</span> query</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> userVideoSeriesMapper.<span class="title function_">selectListWithVideoList</span>(query);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>UserVideoSeriesMapperä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * è·å–ç”¨æˆ·è§†é¢‘ç³»åˆ—åˆ—è¡¨ï¼Œé™„å¸¦è§†é¢‘ä¿¡æ¯</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> p</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	List&lt;T&gt; <span class="title function_">selectListWithVideoList</span><span class="params">(<span class="meta">@Param(&quot;query&quot;)</span> P p)</span>;</span><br></pre></td></tr></table></figure>
<p>UserVideoSeriesMapperXmlä¸­</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">	<span class="comment">&lt;!-- ç»“æœæ˜ å°„ï¼šåœ¨åŸºç¡€å­—æ®µåŸºç¡€ä¸Šï¼Œå¢åŠ ä¸€ä¸ªé›†åˆå±æ€§ videoInfoListï¼ˆå­æŸ¥è¯¢å¡«å……ï¼‰ --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;base_result_map_video&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">           <span class="attr">type</span>=<span class="string">&quot;com.easylive.entity.po.UserVideoSeries&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">           <span class="attr">extends</span>=<span class="string">&quot;base_result_map&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="comment">&lt;!--</span></span></span><br><span class="line"><span class="comment"><span class="language-xml">    collection:</span></span></span><br><span class="line"><span class="comment"><span class="language-xml">      property  = ç›®æ ‡å®ä½“ä¸Šçš„é›†åˆå±æ€§åï¼ˆUserVideoSeries.videoInfoListï¼‰</span></span></span><br><span class="line"><span class="comment"><span class="language-xml">      column    = ä½œä¸ºå­æŸ¥è¯¢å…¥å‚çš„åˆ—ï¼ˆseries_id ä¼šä½œä¸ºå‚æ•°ä¼ ç»™å­æŸ¥è¯¢ï¼‰</span></span></span><br><span class="line"><span class="comment"><span class="language-xml">      select    = å­æŸ¥è¯¢çš„è¯­å¥IDï¼ˆåŒmapperé‡Œçš„ selectVideoListï¼‰</span></span></span><br><span class="line"><span class="comment"><span class="language-xml">  --&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;videoInfoList&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">              <span class="attr">column</span>=<span class="string">&quot;series_id&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">              <span class="attr">select</span>=<span class="string">&quot;com.easylive.mappers.UserVideoSeriesMapper.selectVideoList&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="comment">&lt;!-- å­æŸ¥è¯¢ï¼šæŸ¥è¯¢æŸä¸ªâ€œåˆé›†â€çš„å‰5æ¡è§†é¢‘ï¼Œç”¨äºå¡ç‰‡å†…çš„é¢„è§ˆ --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectVideoList&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.easylive.entity.po.VideoInfo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  SELECT v.video_id, v.video_name, v.video_cover, v.play_count, v.create_time</span></span><br><span class="line"><span class="language-xml">  FROM user_video_series_video sv</span></span><br><span class="line"><span class="language-xml">  INNER JOIN video_info v ON sv.video_id = v.video_id</span></span><br><span class="line"><span class="language-xml">  WHERE sv.series_id = #</span><span class="template-variable">&#123;seriesId&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  ORDER BY sv.sort ASC</span></span><br><span class="line"><span class="language-xml">  LIMIT 5   <span class="comment">&lt;!-- å…³é”®ï¼šåªå–5æ¡ --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="comment">&lt;!-- ä¸»æŸ¥è¯¢ï¼šæ‹‰å–ç”¨æˆ·çš„æ‰€æœ‰åˆé›†ï¼Œæ’åº/åˆ†é¡µå¯é€‰ï¼›æ¯æ¡è®°å½•ä¼šè§¦å‘ä¸€æ¬¡ä¸Šé¢çš„å­æŸ¥è¯¢ --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectListWithVideoList&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;base_result_map_video&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  SELECT</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;base_column_list&quot;</span>/&gt;</span>     <span class="comment">&lt;!-- åˆé›†ä¸»è¡¨å­—æ®µ --&gt;</span></span></span><br><span class="line"><span class="language-xml">  FROM user_video_series u</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;query_condition&quot;</span>/&gt;</span>        <span class="comment">&lt;!-- ä¾‹å¦‚ u.user_id = #</span></span><span class="template-variable">&#123;query.userId&#125;</span><span class="language-xml"><span class="comment"> --&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.orderBy!=null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    ORDER BY $</span><span class="template-variable">&#123;query.orderBy&#125;</span><span class="language-xml">               <span class="comment">&lt;!-- æ³¨æ„ï¼šåŠ¡å¿…ç™½åå•æ§åˆ¶ --&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.simplePage!=null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    LIMIT #</span><span class="template-variable">&#123;query.simplePage.start&#125;</span><span class="language-xml">,#</span><span class="template-variable">&#123;query.simplePage.end&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><strong>è¦ç‚¹</strong></p>
<ul>
<li><code>&lt;collection ... select=&quot;...&quot;&gt;</code> å±äº <strong>MyBatis åµŒå¥—æŸ¥è¯¢</strong>ï¼šä¸»æŸ¥è¯¢è¿”å› N æ¡åˆé›†è®°å½•ï¼Œä¼šè§¦å‘ <strong>N æ¬¡</strong> å­æŸ¥è¯¢ï¼ˆå³å¸¸è¯´çš„ <strong>N+1</strong>ï¼‰ã€‚åˆé›†æ•°é‡é€šå¸¸æœ‰é™ï¼Œä½œä¸ºé¦–é¡µé¢„è§ˆæ˜¯å¯ä»¥æ¥å—çš„ã€‚è‹¥ N å¾ˆå¤§ï¼Œå¯æ”¹ä¸ºä¸€æ¬¡æ€§ <code>JOIN + GROUP_CONCAT</code> æˆ–åˆ†ä¸¤æ¬¡æ‰¹é‡æŸ¥å†åœ¨å†…å­˜ç»„è£…ã€‚</li>
<li><code>LIMIT 5</code> åªä½œç”¨äº<strong>é¢„è§ˆ</strong>ã€‚ç‚¹å‡»ã€æ›´å¤šã€‘æ—¶ï¼Œä¸å†èµ°è¿™ä¸ªæ¥å£ï¼Œè€Œæ˜¯è°ƒç”¨â€œæŸ¥æŸä¸ªåˆé›†å…¨éƒ¨è§†é¢‘â€çš„æ–°æ¥å£ï¼ˆè§ä¸‹ä¸€èŠ‚ï¼‰ã€‚</li>
<li><code>$&#123;query.orderBy&#125;</code> éœ€è¦åç«¯<strong>ç™½åå•</strong>ï¼ˆä¾‹å¦‚ä»…å…è®¸ <code>sort asc/desc</code>ï¼‰ï¼Œé¿å… SQL æ³¨å…¥ã€‚</li>
</ul>
<p>æ³¨æ„è¦åœ¨åœ¨POåŒ…ä¸‹çš„UserVideoSeriesä¸­åŠ å…¥è¿™ä¸€å­—æ®µåŠå…¶å¯¹åº”çš„æ–¹æ³•</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * ä¸“é¢˜ä¸‹çš„è§†é¢‘</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">List</span>&lt;<span class="type">VideoInfo</span>&gt; videoInfoList;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªé›†åˆå­—æ®µå°±æ˜¯ <code>&lt;collection property=&quot;videoInfoList&quot;&gt;</code> çš„è½ç‚¹ã€‚</p>
<p>æµ‹è¯•ä¹‹åæ²¡é—®é¢˜</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1038-1024x421.png" alt="img"></p>
<h2 id="15-åˆ›ä½œä¸­å¿ƒ">15.åˆ›ä½œä¸­å¿ƒ</h2>
<h3 id="1-ç¨¿ä»¶ç®¡ç†ä¸­å½“ç‚¹å‡»ç¼–è¾‘èƒ½å¯¹å·²ç»å‘å¸ƒçš„ç¨¿ä»¶è¿›è¡Œå†æ¬¡ç¼–è¾‘">1.ç¨¿ä»¶ç®¡ç†ä¸­å½“ç‚¹å‡»ç¼–è¾‘èƒ½å¯¹å·²ç»å‘å¸ƒçš„ç¨¿ä»¶è¿›è¡Œå†æ¬¡ç¼–è¾‘</h3>
<p><strong>å›æ˜¾å¹¶å†æ¬¡ç¼–è¾‘ç¨¿ä»¶</strong>ã€<strong>ä¿®æ”¹äº’åŠ¨å¼€å…³</strong>ã€<strong>åˆ é™¤è§†é¢‘ï¼ˆå«çº§è”æ¸…ç†ï¼‰</strong></p>
<p>1ï¼‰å†æ¬¡ç¼–è¾‘ï¼šå›æ˜¾å·²å‘å¸ƒç¨¿ä»¶çš„å®Œæ•´ä¿¡æ¯</p>
<p>æµç¨‹è¦ç‚¹</p>
<ul>
<li>å‰ç«¯ç‚¹å‡»â€œç¼–è¾‘â€â†’ æºå¸¦ <code>videoId</code> è¯·æ±‚ã€‚</li>
<li>æœåŠ¡ç«¯å…ˆåš<strong>å½’å±æ ¡éªŒ</strong>ï¼ˆåªèƒ½ç¼–è¾‘è‡ªå·±çš„ç¨¿ä»¶ï¼‰ã€‚</li>
<li>æŸ¥ä¸¤å—æ•°æ®ï¼š
<ol>
<li><code>video_info_post</code>ï¼šå‘ç¨¿æ—¶ä¿å­˜çš„<strong>ç¨¿ä»¶ä¸»ä½“</strong>ï¼ˆæ ‡é¢˜ã€åˆ†åŒºã€æ ‡ç­¾ã€äº’åŠ¨è®¾ç½®ã€å°é¢ç­‰ï¼‰ã€‚</li>
<li><code>video_info_file_post</code>ï¼š<strong>åˆ†Pæ¸…å•</strong>ï¼ˆæŒ‰ <code>file_index</code> å‡åºï¼‰ã€‚</li>
</ol>
</li>
<li>èšåˆæˆä¸€ä¸ª <code>VideoPostEditInfoVo</code> è¿”å›ï¼Œä¾›å‰ç«¯å›æ˜¾ã€‚</li>
</ul>
<p>UCenterVideoPostControllerä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ® videoId æ‹‰å–â€œå¯ç¼–è¾‘çš„ç¨¿ä»¶ä¿¡æ¯â€ï¼ˆä¸»ä½“ + åˆ†Pæ¸…å•ï¼‰ï¼Œç”¨äºç¼–è¾‘é¡µå›æ˜¾</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/getVideoByVideoId&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseVO <span class="title function_">getVideoByVideoId</span><span class="params">(<span class="meta">@NotEmpty</span> String videoId)</span> &#123;</span><br><span class="line">    <span class="comment">// ç™»å½•æ€ï¼šæ‹¿å½“å‰æ“ä½œè€…</span></span><br><span class="line">    <span class="type">TokenUserInfoDto</span> <span class="variable">token</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1) æŸ¥ç¨¿ä»¶ä¸»ä½“ï¼ˆvideo_info_postï¼‰</span></span><br><span class="line">    <span class="type">VideoInfoPost</span> <span class="variable">vip</span> <span class="operator">=</span> videoInfoPostService.getVideoInfoPostByVideoId(videoId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) å½’å±æ ¡éªŒï¼šä¸å­˜åœ¨æˆ–è€…ä¸æ˜¯å½“å‰ç”¨æˆ·çš„ â†’ 404</span></span><br><span class="line">    <span class="keyword">if</span> (vip == <span class="literal">null</span> || !vip.getUserId().equals(token.getUserId())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_404);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) æŸ¥åˆ†Pæ¸…å•ï¼ˆvideo_info_file_postï¼‰ï¼ŒæŒ‰ file_index å‡åºç¡®ä¿å›æ˜¾é¡ºåºä¸€è‡´</span></span><br><span class="line">    <span class="type">VideoInfoFilePostQuery</span> <span class="variable">q</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoFilePostQuery</span>();</span><br><span class="line">    q.setVideoId(videoId);</span><br><span class="line">    q.setOrderBy(<span class="string">&quot;file_index asc&quot;</span>);</span><br><span class="line">    List&lt;VideoInfoFilePost&gt; fileList = videoInfoFilePostService.findListByParam(q);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) èšåˆè¿”å›</span></span><br><span class="line">    <span class="type">VideoPostEditInfoVo</span> <span class="variable">vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoPostEditInfoVo</span>();</span><br><span class="line">    vo.setVideoInfo(vip);</span><br><span class="line">    vo.setVideoInfoFileList(fileList);</span><br><span class="line">    <span class="keyword">return</span> getSuccessResponseVO(vo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºVideoPostEditInfoVo</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">vo</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">po</span>.<span class="property">VideoInfoFilePost</span>;</span><br><span class="line"><span class="keyword">import</span> com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">po</span>.<span class="property">VideoInfoPost</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">List</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VideoPostEditInfoVo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">VideoInfoPost</span> videoInfo;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">List</span>&lt;<span class="title class_">VideoInfoFilePost</span>&gt; videoInfoFileList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">VideoInfoPost</span> <span class="title function_">getVideoInfo</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> videoInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setVideoInfo</span>(<span class="params"><span class="title class_">VideoInfoPost</span> videoInfo</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">videoInfo</span> = videoInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">List</span>&lt;<span class="title class_">VideoInfoFilePost</span>&gt; <span class="title function_">getVideoInfoFileList</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> videoInfoFileList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setVideoInfoFileList</span>(<span class="params"><span class="title class_">List</span>&lt;<span class="title class_">VideoInfoFilePost</span>&gt; videoInfoFileList</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">videoInfoFileList</span> = videoInfoFileList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1054.png" alt="img"></p>
<p>æˆåŠŸå›æ˜¾</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1042-1024x500.png" alt="img"></p>
<p>å‘å¸ƒçš„æ¥å£postVideoæˆ‘ä»¬å·²ç»å®ç°è¿‡äº†</p>
<p>2ï¼‰ä¿®æ”¹äº’åŠ¨è®¾ç½®ï¼ˆç‚¹èµ/æŠ•å¸/è¯„è®ºç­‰äº¤äº’å¼€å…³ï¼‰</p>
<p>æµç¨‹è¦ç‚¹</p>
<ul>
<li>ä½¿ç”¨<strong>äº‹åŠ¡</strong>ä¿è¯ä¸¤å¤„ä¸€è‡´æ€§ã€‚</li>
<li>ç¼–è¾‘é¡µåˆ‡æ¢å¼€å…³åè°ƒç”¨æ¥å£ï¼š<code>videoId + interaction</code>ï¼ˆå¯ç”¨å­—ç¬¦ä¸²æˆ– JSON å­˜å‚¨ï¼‰ã€‚</li>
<li>åŒæ—¶æ›´æ–°<strong>çº¿ä¸Šè¡¨</strong> <code>video_info</code> å’Œ<strong>ç¨¿ä»¶è¡¨</strong> <code>video_info_post</code>ï¼Œä¿æŒä¸€è‡´ã€‚</li>
</ul>
<p>UCenterVideoPostControllerä¸­</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ä¿å­˜è§†é¢‘äº’åŠ¨ä¿¡æ¯</span></span><br><span class="line"><span class="comment">    * è¯¥æ¥å£ç”¨äºä¿å­˜ç”¨æˆ·å¯¹è§†é¢‘çš„äº’åŠ¨ä¿¡æ¯ï¼Œå¦‚ç‚¹èµã€è¯„è®ºç­‰ã€‚</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> videoId è§†é¢‘IDï¼Œä¸èƒ½ä¸ºç©º</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> interaction äº’åŠ¨ä¿¡æ¯ï¼Œå¦‚ç‚¹èµã€è¯„è®ºç­‰</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> è¿”å›æ“ä½œç»“æœçš„ResponseVOå¯¹è±¡</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@RequestMapping</span>(<span class="string">&quot;/saveVideoInteraction&quot;</span>)</span><br><span class="line">   <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">saveVideoInteraction</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="title class_">String</span> videoId, <span class="title class_">String</span> interaction</span>) &#123;</span><br><span class="line">       <span class="title class_">TokenUserInfoDto</span> tokenUserInfoDto = <span class="title function_">getTokenUserInfoDto</span>();</span><br><span class="line">       videoInfoService.<span class="title function_">changeInteraction</span>(videoId, tokenUserInfoDto.<span class="title function_">getUserId</span>(), interaction);</span><br><span class="line">       <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(<span class="literal">null</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>VideoInfoService</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¿®æ”¹è§†é¢‘äº¤äº’ä¿¡æ¯ï¼ˆçº¿ä¸Šä¸ç¨¿ä»¶ä¸¤å¤„åŒæ­¥ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">changeInteraction</span><span class="params">(<span class="type">String</span> videoId, <span class="type">String</span> userId, <span class="type">String</span> interaction)</span></span>;</span><br></pre></td></tr></table></figure>
<p>VideoInfoServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">changeInteraction</span><span class="params">(String videoId, String userId, String interaction)</span> &#123;</span><br><span class="line">    <span class="comment">// 1) æ›´æ–°çº¿ä¸Šè¡¨ video_infoï¼ˆé™å®š userIdï¼Œé˜²è¶Šæƒï¼‰</span></span><br><span class="line">    <span class="type">VideoInfo</span> <span class="variable">vi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfo</span>();</span><br><span class="line">    vi.setInteraction(interaction);</span><br><span class="line">    <span class="type">VideoInfoQuery</span> <span class="variable">viq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoQuery</span>();</span><br><span class="line">    viq.setVideoId(videoId);</span><br><span class="line">    viq.setUserId(userId);</span><br><span class="line">    videoInfoMapper.updateByParam(vi, viq);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) åŒæ­¥æ›´æ–°ç¨¿ä»¶è¡¨ video_info_post</span></span><br><span class="line">    <span class="type">VideoInfoPost</span> <span class="variable">vip</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoPost</span>();</span><br><span class="line">    vip.setInteraction(interaction);</span><br><span class="line">    <span class="type">VideoInfoPostQuery</span> <span class="variable">vipq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoPostQuery</span>();</span><br><span class="line">    vipq.setVideoId(videoId);</span><br><span class="line">    vipq.setUserId(userId);</span><br><span class="line">    videoInfoPostMapper.updateByParam(vip, vipq);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3ï¼‰åˆ é™¤è§†é¢‘ï¼ˆå«çº§è”åˆ è®°å½• + å¼‚æ­¥åˆ ç‰©ç†æ–‡ä»¶ï¼‰</p>
<p>æµç¨‹è¦ç‚¹</p>
<ul>
<li>
<p>å…¥å£ï¼š<code>videoId</code> + å½“å‰ç™»å½•ç”¨æˆ· <code>userId</code>ã€‚</p>
</li>
<li>
<p>å…ˆåš</p>
<p>å½’å±æ ¡éªŒ</p>
<p>ï¼›éšå</p>
<p>äº‹åŠ¡é‡Œ</p>
<p>åˆ é™¤ï¼š</p>
<ul>
<li><code>video_info</code>ï¼ˆçº¿ä¸Šå¯è§ï¼‰</li>
<li><code>video_info_post</code>ï¼ˆç¨¿ä»¶ï¼‰</li>
</ul>
</li>
<li>
<p>äº‹åŠ¡æäº¤åï¼Œç”¨</p>
<p>çº¿ç¨‹æ± å¼‚æ­¥</p>
<p>æ¸…ç†ï¼š</p>
<ul>
<li><code>video_info_file</code>ã€<code>video_info_file_post</code>ï¼ˆåˆ†Pï¼‰</li>
<li><code>video_danmu</code>ï¼ˆå¼¹å¹•ï¼‰</li>
<li><code>video_comment</code>ï¼ˆè¯„è®ºï¼‰</li>
<li><strong>ç£ç›˜æ–‡ä»¶</strong>ï¼šæ ¹æ®åˆ†Pè®°å½•é‡Œçš„è·¯å¾„åˆ é™¤æ–‡ä»¶/æ–‡ä»¶å¤¹</li>
</ul>
</li>
<li>
<p>é¢„ç•™ TODOï¼š<strong>ç¡¬å¸è¿”è¿˜/æ‰£é™¤</strong>ã€<strong>ES ç´¢å¼•ç§»é™¤</strong>ã€‚</p>
</li>
</ul>
<p>UCenterVideoPostControllerä¸­</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/deleteVideo&quot;</span>)</span><br><span class="line">  <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">deleteVideo</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="title class_">String</span> videoId</span>) &#123;</span><br><span class="line">      <span class="title class_">TokenUserInfoDto</span> tokenUserInfoDto = <span class="title function_">getTokenUserInfoDto</span>();</span><br><span class="line">      videoInfoService.<span class="title function_">deleteVideo</span>(videoId, tokenUserInfoDto.<span class="title function_">getUserId</span>());</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(<span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>VideoInfoService</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * åˆ é™¤è§†é¢‘ä¿¡æ¯åŠå…³è”çš„å¸–å­ä¿¡æ¯</span></span><br><span class="line"><span class="comment">	 * @param videoId</span></span><br><span class="line"><span class="comment">	 * @param userId</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">deleteVideo</span><span class="params">(<span class="type">String</span> videoId, <span class="type">String</span> userId)</span></span>;</span><br></pre></td></tr></table></figure>
<p>VideoInfoServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// å¯å¤ç”¨å…¬å…±çº¿ç¨‹æ± ï¼ˆå»ºè®®æ”¹ä¸º @Bean ç®¡ç†çš„ ThreadPoolTaskExecutorï¼‰</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteVideo</span><span class="params">(String videoId, String userId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1) å½’å±æ ¡éªŒï¼šåªèƒ½åˆ è‡ªå·±çš„è§†é¢‘</span></span><br><span class="line">    <span class="type">VideoInfoPost</span> <span class="variable">vip</span> <span class="operator">=</span> videoInfoPostMapper.selectByVideoId(videoId);</span><br><span class="line">    <span class="keyword">if</span> (vip == <span class="literal">null</span> || (userId != <span class="literal">null</span> &amp;&amp; !userId.equals(vip.getUserId()))) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_404);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) äº‹åŠ¡å†…åˆ é™¤çº¿ä¸Šä¸ç¨¿ä»¶</span></span><br><span class="line">    videoInfoMapper.deleteByVideoId(videoId);</span><br><span class="line">    videoInfoPostMapper.deleteByVideoId(videoId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> ç¡¬å¸ç»“ç®—ï¼ˆè¿”è¿˜/æ‰£å‡ï¼‰</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> åˆ é™¤/ä¸‹çº¿ ES ç´¢å¼•ï¼ˆå¦‚æœ‰æ£€ç´¢åœºæ™¯ï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) æäº¤åå¼‚æ­¥æ¸…ç†â€œé™„å±è®°å½• + ç‰©ç†æ–‡ä»¶â€</span></span><br><span class="line">    executorService.execute(() -&gt; &#123;</span><br><span class="line">        <span class="comment">// 3.1 å…ˆæŸ¥åˆ†Påˆ—è¡¨ï¼ˆç”¨äºæ‹¿åˆ°ç£ç›˜è·¯å¾„ï¼‰</span></span><br><span class="line">        <span class="type">VideoInfoFileQuery</span> <span class="variable">fileQ</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoFileQuery</span>();</span><br><span class="line">        fileQ.setVideoId(videoId);</span><br><span class="line">        List&lt;VideoInfoFile&gt; parts = videoInfoFileMapper.selectList(fileQ);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.2 åˆ åˆ†Pè®°å½•ï¼ˆçº¿ä¸Šã€ç¨¿ä»¶ï¼‰</span></span><br><span class="line">        videoInfoFileMapper.deleteByParam(fileQ);</span><br><span class="line">        <span class="type">VideoInfoFilePostQuery</span> <span class="variable">filePostQ</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoFilePostQuery</span>();</span><br><span class="line">        filePostQ.setVideoId(videoId);</span><br><span class="line">        videoInfoFilePostMapper.deleteByParam(filePostQ);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.3 åˆ å¼¹å¹•</span></span><br><span class="line">        <span class="type">VideoDanmuQuery</span> <span class="variable">danmuQ</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoDanmuQuery</span>();</span><br><span class="line">        danmuQ.setVideoId(videoId);</span><br><span class="line">        videoDanmuMapper.deleteByParam(danmuQ);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.4 åˆ è¯„è®º</span></span><br><span class="line">        <span class="type">VideoCommentQuery</span> <span class="variable">commentQ</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoCommentQuery</span>();</span><br><span class="line">        commentQ.setVideoId(videoId);</span><br><span class="line">        videoCommentMapper.deleteByParam(commentQ);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.5 åˆ ç£ç›˜æ–‡ä»¶ï¼ˆé€ä¸ªè·¯å¾„å°è¯•åˆ é™¤ï¼‰</span></span><br><span class="line">        <span class="keyword">for</span> (VideoInfoFile p : parts) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                FileUtils.deleteDirectory(<span class="keyword">new</span> <span class="title class_">File</span>(appConfig.getProjectFolder() + p.getFilePath()));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;åˆ é™¤æ–‡ä»¶å¤±è´¥ï¼Œæ–‡ä»¶è·¯å¾„: &#123;&#125;&quot;</span>, p.getFilePath(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1055.png" alt="img"></p>
<h3 id="2-åˆ›ä½œä¸­å¿ƒäº’åŠ¨ç®¡ç†éƒ¨åˆ†1ï¼ˆå®Œå–„è¯„è®ºç®¡ç†ï¼‰">2.åˆ›ä½œä¸­å¿ƒäº’åŠ¨ç®¡ç†éƒ¨åˆ†1ï¼ˆå®Œå–„è¯„è®ºç®¡ç†ï¼‰</h3>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1045-1024x385.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1061-1024x334.png" alt="img"></p>
<p>åˆ›å»ºUCenterInteractController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŠ è½½å½“å‰ä½œè€…çš„â€œå…¨éƒ¨è§†é¢‘â€ï¼ˆä¸‹æ‹‰ç­›é€‰ç”¨ï¼‰</span></span><br><span class="line"><span class="comment">     * - åªæŸ¥å½“å‰ç™»å½•ä½œè€…(userId)çš„ä½œå“</span></span><br><span class="line"><span class="comment">     * - æŒ‰åˆ›å»ºæ—¶é—´å€’åºï¼Œæœ€æ–°çš„è§†é¢‘æ’æœ€å‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/loadAllVideo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseVO <span class="title function_">loadAllVideo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">TokenUserInfoDto</span> <span class="variable">token</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line"></span><br><span class="line">        <span class="type">VideoInfoQuery</span> <span class="variable">videoInfoQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoQuery</span>();</span><br><span class="line">        videoInfoQuery.setUserId(token.getUserId());     <span class="comment">// åªçœ‹â€œæˆ‘â€çš„è§†é¢‘</span></span><br><span class="line">        videoInfoQuery.setOrderBy(<span class="string">&quot;create_time desc&quot;</span>);   <span class="comment">// ç™½åå•æ’åºå­—æ®µï¼Œé¿å…æ³¨å…¥</span></span><br><span class="line">        List&lt;VideoInfo&gt; videoInfoList = videoInfoService.findListByParam(videoInfoQuery);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(videoInfoList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ†é¡µåŠ è½½è¯„è®º</span></span><br><span class="line"><span class="comment">     * - æ”¯æŒæŒ‰ videoId è¿‡æ»¤ï¼ˆä¸ä¼ åˆ™æŸ¥è¯¥ä½œè€…çš„æ‰€æœ‰è§†é¢‘çš„è¯„è®ºï¼‰</span></span><br><span class="line"><span class="comment">     * - queryVideoInfo=trueï¼šè¿è¡¨æŠŠè§†é¢‘å/å°é¢ã€è¯„è®ºäºº/è¢«å›å¤äººæ˜µç§°å¤´åƒä¸€å¹¶æŸ¥å‡ºï¼Œä¾¿äºå‰ç«¯ç›´æ¥å±•ç¤º</span></span><br><span class="line"><span class="comment">     * - æŒ‰ comment_id å€’åºï¼šæ–°è¯„è®ºåœ¨å‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/loadComment&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseVO <span class="title function_">loadComment</span><span class="params">(Integer pageNo, String videoId)</span> &#123;</span><br><span class="line">        <span class="type">TokenUserInfoDto</span> <span class="variable">token</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line"></span><br><span class="line">        <span class="type">VideoCommentQuery</span> <span class="variable">commentQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoCommentQuery</span>();</span><br><span class="line">        commentQuery.setVideoUserId(token.getUserId());  <span class="comment">// â€œè¯¥è¯„è®ºå±äºè°çš„è§†é¢‘â€â†’ åªçœ‹æˆ‘çš„è§†é¢‘ä¸‹çš„è¯„è®º</span></span><br><span class="line">        commentQuery.setVideoId(videoId);                <span class="comment">// é€‰ä¸­äº†æŸä¸ªè§†é¢‘æ—¶å¸¦ä¸Šè¿‡æ»¤</span></span><br><span class="line">        commentQuery.setQueryVideoInfo(<span class="literal">true</span>);            <span class="comment">// éœ€è¦è”è¡¨æ‹¿è§†é¢‘&amp;ç”¨æˆ·å±•ç¤ºå­—æ®µ</span></span><br><span class="line">        commentQuery.setOrderBy(<span class="string">&quot;comment_id desc&quot;</span>);      <span class="comment">// ç™½åå•æ’åº</span></span><br><span class="line">        commentQuery.setPageNo(pageNo);                  <span class="comment">// åˆ†é¡µå‚æ•°ï¼ˆpageSize åœ¨æšä¸¾æˆ–é»˜è®¤é‡Œï¼‰</span></span><br><span class="line"></span><br><span class="line">        PaginationResultVO&lt;VideoComment&gt; page =</span><br><span class="line">                videoCommentService.findListByPage(commentQuery);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(page);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ é™¤è¯„è®º</span></span><br><span class="line"><span class="comment">     * - éœ€è¦åœ¨ Service å†…åšæƒé™æ ¡éªŒï¼ˆè¯„è®ºä½œè€…/UP ä¸»/ç®¡ç†å‘˜ï¼‰</span></span><br><span class="line"><span class="comment">     * - è‹¥æ˜¯çˆ¶çº§è¯„è®ºï¼Œé€šå¸¸éœ€è¦çº§è”åˆ é™¤å…¶å­å›å¤ï¼ˆçœ‹ä½ çš„ä¸šåŠ¡è§„åˆ™ï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/delComment&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseVO <span class="title function_">delComment</span><span class="params">(<span class="meta">@NotNull</span> Integer commentId)</span> &#123;</span><br><span class="line">        <span class="type">TokenUserInfoDto</span> <span class="variable">token</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line">        videoCommentService.deleteComment(commentId, token.getUserId());</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>VideoCommentMapper.xmlä¸­ä¸ºselectListæ·»åŠ æ¡ä»¶</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">   <span class="comment">&lt;!-- åˆ†é¡µæŸ¥è¯¢è¯„è®ºåˆ—è¡¨ï¼ˆæ”¯æŒè¿è¡¨å–å±•ç¤ºå­—æ®µï¼‰ --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectList&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;base_result_map&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  SELECT</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;base_column_list&quot;</span>/&gt;</span>  <span class="comment">&lt;!-- v.*ï¼švideo_comment åŸºç¡€åˆ— --&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!-- å½“éœ€è¦åœ¨åˆ—è¡¨ä¸Šç›´æ¥å±•ç¤ºè§†é¢‘&amp;ç”¨æˆ·ä¿¡æ¯æ—¶ï¼Œè¿½åŠ è¿™äº›æŠ•å½±åˆ— --&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.queryVideoInfo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      , vd.video_name   AS video_name      <span class="comment">&lt;!-- è§†é¢‘åï¼ˆç”¨äºåˆ—è¡¨å±•ç¤ºï¼‰ --&gt;</span></span></span><br><span class="line"><span class="language-xml">      , vd.video_cover  AS video_cover     <span class="comment">&lt;!-- è§†é¢‘å°é¢ --&gt;</span></span></span><br><span class="line"><span class="language-xml">      , u.nick_name     AS nick_name       <span class="comment">&lt;!-- è¯„è®ºäººæ˜µç§° --&gt;</span></span></span><br><span class="line"><span class="language-xml">      , u.avatar        AS avatar          <span class="comment">&lt;!-- è¯„è®ºäººå¤´åƒ --&gt;</span></span></span><br><span class="line"><span class="language-xml">      , u2.nick_name    AS replyNickName   <span class="comment">&lt;!-- è¢«å›å¤äººæ˜µç§° --&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  FROM video_comment v</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="comment">&lt;!-- åªåœ¨ queryVideoInfo=true æ—¶å†åš JOINï¼Œé¿å…ä¸å¿…è¦çš„æ€§èƒ½å¼€é”€ --&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.queryVideoInfo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    INNER JOIN video_info vd ON vd.video_id = v.video_id</span></span><br><span class="line"><span class="language-xml">    LEFT  JOIN user_info  u  ON u.user_id  = v.user_id</span></span><br><span class="line"><span class="language-xml">    LEFT  JOIN user_info  u2 ON u2.user_id = v.reply_user_id</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="comment">&lt;!-- å¯å¤ç”¨çš„é€šç”¨ whereï¼ˆç¤ºä¾‹ï¼šæŒ‰è§†é¢‘ä½œè€…/è§†é¢‘IDè¿‡æ»¤ï¼‰ --&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;query_condition&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="comment">&lt;!-- æ’åºï¼šåŠ¡å¿…ç™½åå•ï¼Œæ‹’ç»é€ä¼ ä»»æ„å­—ç¬¦ä¸² --&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.orderBy != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    ORDER BY $</span><span class="template-variable">&#123;query.orderBy&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="comment">&lt;!-- åˆ†é¡µ --&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.simplePage != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    LIMIT #</span><span class="template-variable">&#123;query.simplePage.start&#125;</span><span class="language-xml">, #</span><span class="template-variable">&#123;query.simplePage.end&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><strong>ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ</strong></p>
<ul>
<li><code>queryVideoInfo=true</code> ä½œä¸º<strong>å¼€å…³</strong>ï¼šåœ¨â€œåˆ›ä½œä¸­å¿ƒåˆ—è¡¨é¡µâ€éœ€è¦ç›´æ¥æ˜¾ç¤ºè§†é¢‘å/å°é¢ã€è¯„è®ºäººæ˜µç§°å¤´åƒç­‰ï¼›è€Œåœ¨çº¯åç«¯ç»Ÿè®¡æˆ–å¯¼å‡ºç­‰åœºæ™¯ä¸éœ€è¦ï¼Œå…³æ‰ Join æ›´é«˜æ•ˆã€‚</li>
<li>è¿æ¥ <code>video_info</code> å¯ä¿è¯â€œåªå‡ºç°<strong>æˆ‘çš„è§†é¢‘</strong>ä¸‹çš„è¯„è®ºâ€ï¼ˆä¹Ÿèƒ½ç”¨ <code>WHERE v.video_user_id = ?</code> å®ç°ï¼Œè¿™å–å†³äºä½ çš„ <code>query_condition</code>ï¼‰ã€‚</li>
<li><code>ORDER BY $&#123;&#125;</code> å’Œ <code>LIKE $&#123;&#125;</code> è¿™ç±»å­—ç¬¦ä¸²æ‹¼æ¥ä¸€å®š<strong>ç™½åå•</strong>æ§åˆ¶ï¼Œé¿å… SQL æ³¨å…¥ã€‚</li>
</ul>
<p>ä½ åœ¨ XML é‡Œé€‰æ‹©äº†è¿™äº›åˆ—ï¼Œå°±éœ€è¦åœ¨ <code>VideoComment</code> å®ä½“é‡Œ<strong>å¢åŠ å¯¹åº”çš„éæŒä¹…åŒ–å­—æ®µ</strong>ï¼Œå¦åˆ™ MyBatis æ˜ å°„ä¸ä¸Šã€‚</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * è§†é¢‘åç§°ï¼Œç”¨äºå‰ç«¯å±•ç¤ºç”¨ï¼Œä¸å­˜æ•°æ®åº“</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">String</span> videoName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * è§†é¢‘å°é¢ï¼Œç”¨äºå‰ç«¯å±•ç¤ºç”¨ï¼Œä¸å­˜æ•°æ®åº“</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">String</span> videoCover;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1062.png" alt="img"></p>
<p>æµ‹è¯•æ²¡é—®é¢˜</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1046-1024x488.png" alt="img"></p>
<h3 id="3-åˆ›ä½œä¸­å¿ƒäº’åŠ¨ç®¡ç†éƒ¨åˆ†2ï¼ˆå®Œå–„å¼¹å¹•ç®¡ç†ï¼‰">3.åˆ›ä½œä¸­å¿ƒäº’åŠ¨ç®¡ç†éƒ¨åˆ†2ï¼ˆå®Œå–„å¼¹å¹•ç®¡ç†ï¼‰</h3>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1068.png" alt="img"></p>
<p>UCenterInteractControllerä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * åŠ è½½è§†é¢‘å¼¹å¹•ï¼ˆåˆ†é¡µï¼‰</span></span><br><span class="line"><span class="comment">   * - pageNoï¼šç¬¬å‡ é¡µ</span></span><br><span class="line"><span class="comment">   * - videoIdï¼šå¯é€‰ï¼›æŒ‡å®šåˆ™åªçœ‹è¯¥è§†é¢‘çš„å¼¹å¹•ï¼Œä¸ä¼ åˆ™çœ‹æˆ‘æ‰€æœ‰è§†é¢‘çš„å¼¹å¹•</span></span><br><span class="line"><span class="comment">   * - å…³é”®ç‚¹ï¼švideoUserId = å½“å‰ç™»å½•è€…ï¼Œä½¿æŸ¥è¯¢â€œåªé™å®šåœ¨æˆ‘çš„è§†é¢‘â€èŒƒå›´å†…</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@RequestMapping(&quot;/loadDanmu&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> ResponseVO <span class="title function_">loadDanmu</span><span class="params">(Integer pageNo, String videoId)</span> &#123;</span><br><span class="line">      <span class="comment">// å–å½“å‰ç™»å½•ä½œè€…</span></span><br><span class="line">      <span class="type">TokenUserInfoDto</span> <span class="variable">token</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ç»„è£…æŸ¥è¯¢å¯¹è±¡</span></span><br><span class="line">      <span class="type">VideoDanmuQuery</span> <span class="variable">danmuQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoDanmuQuery</span>();</span><br><span class="line">      danmuQuery.setVideoUserId(token.getUserId()); <span class="comment">// åªæŸ¥â€œæˆ‘â€çš„è§†é¢‘ä¸‹çš„å¼¹å¹•</span></span><br><span class="line">      danmuQuery.setVideoId(videoId);               <span class="comment">// è¿‡æ»¤æŒ‡å®šè§†é¢‘</span></span><br><span class="line">      danmuQuery.setOrderBy(<span class="string">&quot;danmu_id desc&quot;</span>);       <span class="comment">// æŒ‰å¼¹å¹• ID å€’åºï¼ˆç™½åå•å­—æ®µï¼‰</span></span><br><span class="line">      danmuQuery.setPageNo(pageNo);                 <span class="comment">// åˆ†é¡µé¡µç </span></span><br><span class="line">      danmuQuery.setQueryVideoInfo(<span class="literal">true</span>);           <span class="comment">// éœ€è¦è”è¡¨æ‹¿è§†é¢‘å/å°é¢/æ˜µç§°</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// åˆ†é¡µæŸ¥è¯¢</span></span><br><span class="line">      <span class="type">PaginationResultVO</span> <span class="variable">result</span> <span class="operator">=</span> videoDanmuService.findListByPage(danmuQuery);</span><br><span class="line">      <span class="keyword">return</span> getSuccessResponseVO(result);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * åˆ é™¤å¼¹å¹•</span></span><br><span class="line"><span class="comment">   * - ç”±è§†é¢‘ä½œè€…æ‰§è¡Œï¼›Service å†…ä¼šæ ¡éªŒâ€œå¼¹å¹•å½’å±çš„è§†é¢‘æ˜¯å¦å±äºå½“å‰ä½œè€…â€</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@RequestMapping(&quot;/delDanmu&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> ResponseVO <span class="title function_">delDanmu</span><span class="params">(<span class="meta">@NotNull</span> Integer danmuId)</span> &#123;</span><br><span class="line">      <span class="type">TokenUserInfoDto</span> <span class="variable">token</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line">      videoDanmuService.deleteDanmu(token.getUserId(), danmuId);</span><br><span class="line">      <span class="keyword">return</span> getSuccessResponseVO(<span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„å…³é”®æ˜¯ <code>setVideoUserId(å½“å‰ç™»å½•è€…)</code>ï¼Œä½¿ä»»ä½•æŸ¥è¯¢éƒ½åªè½åœ¨â€œä½œè€…è‡ªå·±çš„è§†é¢‘â€èŒƒå›´å†…ï¼›è€Œ <code>queryVideoInfo=true</code> å†³å®šæ˜¯å¦ <strong>JOIN</strong> é¢å¤–å±•ç¤ºå­—æ®µï¼ˆè§†é¢‘åã€å°é¢ã€ç”¨æˆ·æ˜µç§°ï¼‰ã€‚</p>
<p>åœ¨VideoDanMuMapperä¸­ä¸ºselectListæ·»åŠ æ¡ä»¶</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">	<span class="comment">&lt;!-- åˆ†é¡µæŸ¥è¯¢å¼¹å¹•é›†åˆï¼šå¯æŒ‰éœ€è¿è¡¨è¡¥é½å±•ç¤ºå­—æ®µ --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectList&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;base_result_map&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  SELECT</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;base_column_list&quot;</span>/&gt;</span>  <span class="comment">&lt;!-- v.*: video_danmu çš„åŸºç¡€å­—æ®µ --&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!-- å¼€å…³ï¼šéœ€è¦åœ¨åˆ—è¡¨ä¸Šç›´å‡ºè§†é¢‘/ç”¨æˆ·å±•ç¤ºä¿¡æ¯æ—¶è¿½åŠ è¿™äº›æŠ•å½±åˆ— --&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.queryVideoInfo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      , vd.video_name  AS video_name     <span class="comment">&lt;!-- è§†é¢‘åï¼ˆå±•ç¤ºç”¨ï¼Œä¸è½åº“åˆ° video_danmuï¼‰ --&gt;</span></span></span><br><span class="line"><span class="language-xml">      , vd.video_cover AS video_cover    <span class="comment">&lt;!-- è§†é¢‘å°é¢ï¼ˆå±•ç¤ºç”¨ï¼‰ --&gt;</span></span></span><br><span class="line"><span class="language-xml">      , u.nick_name    AS nick_name      <span class="comment">&lt;!-- å¼¹å¹•å‘å¸ƒè€…æ˜µç§°ï¼ˆå±•ç¤ºç”¨ï¼‰ --&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  FROM video_danmu v</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="comment">&lt;!-- ä»…å½“éœ€è¦å±•ç¤ºä¿¡æ¯æ—¶æ‰åš JOINï¼Œé¿å…ä¸å¿…è¦çš„æ€§èƒ½æŸè€— --&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.queryVideoInfo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    INNER JOIN video_info vd ON vd.video_id = v.video_id</span></span><br><span class="line"><span class="language-xml">    LEFT  JOIN user_info  u  ON u.user_id  = v.user_id</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="comment">&lt;!-- é€šç”¨ where æ¡ä»¶ï¼ˆå« video_user_id / video_id ç­‰ï¼‰ --&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;query_condition&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="comment">&lt;!-- æ’åºï¼ˆåŠ¡å¿…åšç™½åå•æ§åˆ¶ï¼Œæ‹’ç»é€ä¼ ä»»æ„å­—ç¬¦ä¸²ï¼‰ --&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.orderBy != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    ORDER BY $</span><span class="template-variable">&#123;query.orderBy&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="comment">&lt;!-- åˆ†é¡µ --&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.simplePage != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    LIMIT #</span><span class="template-variable">&#123;query.simplePage.start&#125;</span><span class="language-xml">, #</span><span class="template-variable">&#123;query.simplePage.end&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><strong>è¦ç‚¹è¯´æ˜</strong></p>
<ul>
<li>æŠŠå±•ç¤ºæ‰€éœ€å­—æ®µæ”¾åœ¨ <code>IF queryVideoInfo</code> ä¸‹ï¼Œçµæ´»æ§åˆ¶æ˜¯å¦ <code>JOIN</code>ï¼›</li>
<li><code>ORDER BY $&#123;&#125;</code> ä¸€å®šè¦èµ°åç«¯ç™½åå•æˆ–æšä¸¾æ˜ å°„ï¼Œé˜²æ³¨å…¥ï¼›</li>
<li><code>query_condition</code> å»ºè®®åŒ…å«ï¼š<code>v.video_id</code>ã€<code>vd.user_id</code>ï¼ˆå³ <code>video_user_id</code>ï¼‰ã€æ—¶é—´åŒºé—´ç­‰ã€‚</li>
</ul>
<p>VideoDanmuServiceä¸­</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * åˆ é™¤è§†é¢‘å¼¹å¹•</span></span><br><span class="line"><span class="comment">	 * @param userId</span></span><br><span class="line"><span class="comment">	 * @param danmuId</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">deleteDanmu</span><span class="params">(<span class="type">String</span> userId, Integer danmuId)</span></span>;</span><br></pre></td></tr></table></figure>
<p>VideoDanmuServiceImplä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * ä»…å…è®¸è§†é¢‘ä½œè€…åˆ é™¤è‡ªå·±è§†é¢‘ä¸‹çš„å¼¹å¹•</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteDanmu</span><span class="params">(String userId, Integer danmuId)</span> &#123;</span><br><span class="line">      <span class="comment">// 1) æŸ¥å¼¹å¹•æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">      <span class="type">VideoDanmu</span> <span class="variable">danmu</span> <span class="operator">=</span> videoDanmuMapper.selectByDanmuId(danmuId);</span><br><span class="line">      <span class="keyword">if</span> (danmu == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// å¯é€‰ï¼šæ”¹æˆç›´æ¥ returnï¼Œå®ç°â€œå¹‚ç­‰åˆ é™¤â€</span></span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 2) æŸ¥è¯¥å¼¹å¹•æ‰€å½’å±çš„è§†é¢‘</span></span><br><span class="line">      <span class="type">VideoInfo</span> <span class="variable">videoInfo</span> <span class="operator">=</span> videoInfoMapper.selectByVideoId(danmu.getVideoId());</span><br><span class="line">      <span class="keyword">if</span> (videoInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 3) æƒé™æ ¡éªŒï¼šå½“å‰ç”¨æˆ·å¿…é¡»æ˜¯è§†é¢‘ä½œè€…</span></span><br><span class="line">      <span class="keyword">if</span> (userId != <span class="literal">null</span> &amp;&amp; !videoInfo.getUserId().equals(userId)) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 4) é€šè¿‡åˆ™åˆ é™¤</span></span><br><span class="line">      videoDanmuMapper.deleteByDanmuId(danmuId);</span><br><span class="line">      <span class="comment">// 5ï¼‰åˆ é™¤åå‡å°‘å¼¹å¹•çš„æ•°é‡ï¼ˆæ›´æ–°å¼¹å¹•æ•°é‡ï¼‰</span></span><br><span class="line">videoInfoMapper.updateCountInfo(danmu.getVideoId(), UserActionTypeEnum.VIDEO_DANMU.getField(), -<span class="number">1</span>);</span><br><span class="line">       <span class="comment">// æ›´æ–°eså¼¹å¹•æ•°é‡</span></span><br><span class="line">esSearchComponent.updateDocCount(danmu.getVideoId(), SearchOrderTypeEnum.VIDEO_DANMU.getField(), -<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„è¦åœ¨VideoDanMué‡ŒåŠ å…¥è¿™3ä¸ªå­—æ®µåŠå…¶get/setæ–¹æ³•ä¸ç„¶å‰ç«¯ä¸ä¼šæ˜¾ç¤ºç›¸å…³ä¿¡æ¯</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è§†é¢‘åç§°åªç”¨äºå‰ç«¯å±•ç¤º</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> videoName;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è§†é¢‘å°é¢åªç”¨äºå‰ç«¯å±•ç¤º</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> videoCover;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç”¨æˆ·æ˜µç§°åªç”¨äºå‰ç«¯å±•ç¤º</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> nickName;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1069-1024x713.png" alt="img"></p>
<p>æµ‹è¯•åå¼¹å¹•ç®¡ç†æ²¡æœ‰é—®é¢˜</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1047-1024x460.png" alt="img"></p>
<h2 id="16-é¦–é¡µæœç´¢æ¨¡å—ï¼ˆESï¼‰">16.é¦–é¡µæœç´¢æ¨¡å—ï¼ˆESï¼‰</h2>
<h3 id="1-ESç®€ä»‹">1.ESç®€ä»‹</h3>
<p>ç•¥ï¼ˆè¯¦è§ESç¯‡ï¼‰</p>
<p>æ³¨è¿™é‡Œæˆ‘ç»™äº†ç«¯å£9201ï¼Œå› ä¸º9200å¹¶å ç”¨äº†ï¼Œå¹¶ä¸”æ”¹äº†kibanaçš„æŒ‡å‘</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1050-1024x864.png" alt="img"></p>
<h3 id="2-ESåˆå§‹åŒ–">2.ESåˆå§‹åŒ–</h3>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1080.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1081.png" alt="img"></p>
<p>åœ¨componentåŒ…ä¸‹åˆ›å»ºEsSearchCompoent</p>
<p>åˆ›å»ºç´¢å¼•</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(<span class="string">&quot;esSearchUtils&quot;</span>)</span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EsSearchComponent</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">AppConfig</span> appConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">RestHighLevelClient</span> restHighLevelClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserInfoMapper</span> userInfoMapper;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** åˆ¤æ–­ç´¢å¼•æ˜¯å¦å­˜åœ¨ï¼ˆå¹‚ç­‰ä¿æŠ¤ï¼‰ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Boolean</span> isExistIndex() <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</span><br><span class="line">        <span class="type">GetIndexRequest</span> getIndexRequest <span class="operator">=</span> new <span class="type">GetIndexRequest</span>(appConfig.getEsIndexVideoName());</span><br><span class="line">        <span class="keyword">return</span> restHighLevelClient.indices().exists(getIndexRequest, <span class="type">RequestOptions</span>.<span class="type">DEFAULT</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** åˆå§‹åŒ–ï¼šä¸å­˜åœ¨å°±åˆ›å»º ES ç´¢å¼•ï¼ˆsettings + mappingï¼‰ */</span></span><br><span class="line">    <span class="keyword">public</span> void createIndex() &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1) å¹‚ç­‰ï¼šå·²å­˜åœ¨å°±ç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="type">Boolean</span>.<span class="type">TRUE</span>.equals(isExistIndex())) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2) æ„é€ åˆ›å»ºè¯·æ±‚ï¼ˆç´¢å¼•åï¼‰</span></span><br><span class="line">            <span class="type">CreateIndexRequest</span> request <span class="operator">=</span> new <span class="type">CreateIndexRequest</span>(appConfig.getEsIndexVideoName());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3) å†™å…¥ settingsï¼šå®šä¹‰ä¸€ä¸ªä»¥é€—å·åˆ†éš”çš„ pattern åˆ†è¯å™¨ï¼ˆç”¨äº tagsï¼‰</span></span><br><span class="line">            request.settings(</span><br><span class="line">                <span class="string">&quot;&#123; <span class="subst">\&quot;</span>analysis<span class="subst">\&quot;</span>: &#123; <span class="subst">\&quot;</span>analyzer<span class="subst">\&quot;</span>: &#123; <span class="subst">\&quot;</span>comma<span class="subst">\&quot;</span>: &#123; <span class="subst">\&quot;</span>type<span class="subst">\&quot;</span>: <span class="subst">\&quot;</span>pattern<span class="subst">\&quot;</span>, <span class="subst">\&quot;</span>pattern<span class="subst">\&quot;</span>: <span class="subst">\&quot;</span>,<span class="subst">\&quot;</span> &#125; &#125; &#125; &#125;&quot;</span>,</span><br><span class="line">                <span class="type">XContentType</span>.<span class="type">JSON</span></span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4) å†™å…¥ mappingï¼šå­—æ®µç±»å‹ã€åˆ†è¯å™¨ã€æ˜¯å¦ç´¢å¼•ã€æ—¥æœŸæ ¼å¼ç­‰</span></span><br><span class="line">            request.mapping(</span><br><span class="line">                <span class="string">&quot;&#123; <span class="subst">\&quot;</span>properties<span class="subst">\&quot;</span>: &#123; &quot;</span> <span class="operator">+</span></span><br><span class="line">                <span class="string">&quot;  <span class="subst">\&quot;</span>videoId<span class="subst">\&quot;</span>:     &#123; <span class="subst">\&quot;</span>type<span class="subst">\&quot;</span>:<span class="subst">\&quot;</span>text<span class="subst">\&quot;</span>,    <span class="subst">\&quot;</span>index<span class="subst">\&quot;</span>:false &#125;,&quot;</span> <span class="operator">+</span></span><br><span class="line">                <span class="string">&quot;  <span class="subst">\&quot;</span>userId<span class="subst">\&quot;</span>:      &#123; <span class="subst">\&quot;</span>type<span class="subst">\&quot;</span>:<span class="subst">\&quot;</span>text<span class="subst">\&quot;</span>,    <span class="subst">\&quot;</span>index<span class="subst">\&quot;</span>:false &#125;,&quot;</span> <span class="operator">+</span></span><br><span class="line">                <span class="string">&quot;  <span class="subst">\&quot;</span>videoCover<span class="subst">\&quot;</span>:  &#123; <span class="subst">\&quot;</span>type<span class="subst">\&quot;</span>:<span class="subst">\&quot;</span>text<span class="subst">\&quot;</span>,    <span class="subst">\&quot;</span>index<span class="subst">\&quot;</span>:false &#125;,&quot;</span> <span class="operator">+</span></span><br><span class="line">                <span class="string">&quot;  <span class="subst">\&quot;</span>videoName<span class="subst">\&quot;</span>:   &#123; <span class="subst">\&quot;</span>type<span class="subst">\&quot;</span>:<span class="subst">\&quot;</span>text<span class="subst">\&quot;</span>,    <span class="subst">\&quot;</span>analyzer<span class="subst">\&quot;</span>:<span class="subst">\&quot;</span>ik_max_word<span class="subst">\&quot;</span> &#125;,&quot;</span> <span class="operator">+</span> <span class="comment">// éœ€å®‰è£… IK</span></span><br><span class="line">                <span class="string">&quot;  <span class="subst">\&quot;</span>tags<span class="subst">\&quot;</span>:        &#123; <span class="subst">\&quot;</span>type<span class="subst">\&quot;</span>:<span class="subst">\&quot;</span>text<span class="subst">\&quot;</span>,    <span class="subst">\&quot;</span>analyzer<span class="subst">\&quot;</span>:<span class="subst">\&quot;</span>comma<span class="subst">\&quot;</span> &#125;,&quot;</span> <span class="operator">+</span></span><br><span class="line">                <span class="string">&quot;  <span class="subst">\&quot;</span>playCount<span class="subst">\&quot;</span>:   &#123; <span class="subst">\&quot;</span>type<span class="subst">\&quot;</span>:<span class="subst">\&quot;</span>integer<span class="subst">\&quot;</span>, <span class="subst">\&quot;</span>index<span class="subst">\&quot;</span>:false &#125;,&quot;</span> <span class="operator">+</span></span><br><span class="line">                <span class="string">&quot;  <span class="subst">\&quot;</span>danmuCount<span class="subst">\&quot;</span>:  &#123; <span class="subst">\&quot;</span>type<span class="subst">\&quot;</span>:<span class="subst">\&quot;</span>integer<span class="subst">\&quot;</span>, <span class="subst">\&quot;</span>index<span class="subst">\&quot;</span>:false &#125;,&quot;</span> <span class="operator">+</span></span><br><span class="line">                <span class="string">&quot;  <span class="subst">\&quot;</span>collectCount<span class="subst">\&quot;</span>:&#123; <span class="subst">\&quot;</span>type<span class="subst">\&quot;</span>:<span class="subst">\&quot;</span>integer<span class="subst">\&quot;</span>, <span class="subst">\&quot;</span>index<span class="subst">\&quot;</span>:false &#125;,&quot;</span> <span class="operator">+</span></span><br><span class="line">                <span class="string">&quot;  <span class="subst">\&quot;</span>createTime<span class="subst">\&quot;</span>:  &#123; <span class="subst">\&quot;</span>type<span class="subst">\&quot;</span>:<span class="subst">\&quot;</span>date<span class="subst">\&quot;</span>,    <span class="subst">\&quot;</span>format<span class="subst">\&quot;</span>:<span class="subst">\&quot;</span>yyyy-MM-dd HH:mm:ss<span class="subst">\&quot;</span>, <span class="subst">\&quot;</span>index<span class="subst">\&quot;</span>:false &#125;&quot;</span> <span class="operator">+</span></span><br><span class="line">                <span class="string">&quot;&#125; &#125;&quot;</span>,</span><br><span class="line">                <span class="type">XContentType</span>.<span class="type">JSON</span></span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 5) å‘é€åˆ›å»ºè¯·æ±‚ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦è¢«é›†ç¾¤æ¥å—</span></span><br><span class="line">            <span class="type">CreateIndexResponse</span> resp <span class="operator">=</span> restHighLevelClient.indices().create(request, <span class="type">RequestOptions</span>.<span class="type">DEFAULT</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="operator">!</span>resp.isAcknowledged()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> new <span class="type">BusinessException</span>(<span class="string">&quot;åˆå§‹åŒ–eså¤±è´¥&quot;</span>); <span class="comment">// é›†ç¾¤æœªç¡®è®¤</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="type">BusinessException</span> e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e; <span class="comment">// ä¸šåŠ¡å¼‚å¸¸å¦‚å®æŠ›å‡º</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="type">Exception</span> e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;åˆå§‹åŒ–eså¤±è´¥&quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> new <span class="type">BusinessException</span>(<span class="string">&quot;åˆå§‹åŒ–eså¤±è´¥&quot;</span>); <span class="comment">// ç»Ÿä¸€æˆä¸šåŠ¡å¼‚å¸¸</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä½ æ‰“å¤šå®ä¾‹å¯åŠ¨ï¼Œä¸¤ä¸ªå®ä¾‹å¯èƒ½<strong>ç«æ€å»ºç´¢å¼•</strong>ï¼Œè™½ç„¶å…ˆæŸ¥åå»ºå·²é™ä½æ¦‚ç‡ï¼Œä½†ä»å¯èƒ½é‡åˆ° <code>resource_already_exists_exception</code>ï¼›å¯åœ¨ <code>catch</code> ä¸­å¯¹è¯¥é”™è¯¯ç åš<strong>å¿½ç•¥å¤„ç†</strong>ã€‚</p>
<p>åœ¨AppConfigä¸­åŠ å…¥ä¸¤ä¸ªå±æ€§ç”¨äºé…ç½®eså¹¶æä¾›getæ–¹æ³•</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(<span class="string">&quot;<span class="subst">$&#123;es.host.port:<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">9201</span>&#125;</span>&quot;</span>)</span></span><br><span class="line"><span class="keyword">private</span> String esHostPort;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(<span class="string">&quot;<span class="subst">$&#123;es.index.video.name:easylive_video&#125;</span>&quot;</span>)</span></span><br><span class="line"><span class="keyword">private</span> String esIndexVideoName;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1082.png" alt="img"></p>
<p>åœ¨configåŒ…ä¸‹åˆ›å»ºEsConfiguration</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.entity.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.<span class="type">RestHighLevelClient</span>;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="type">DisposableBean</span>;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.<span class="type">Bean</span>;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.<span class="type">Configuration</span>;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.client.<span class="type">ClientConfiguration</span>;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.client.<span class="type">RestClients</span>;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.config.<span class="type">AbstractElasticsearchConfiguration</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.<span class="type">Resource</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">EsConfiguration</span> <span class="keyword">extends</span> <span class="title">AbstractElasticsearchConfiguration</span> <span class="title">implements</span> <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">AppConfig</span> appConfig;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">RestHighLevelClient</span> client; <span class="comment">// ç”¨äºåœ¨ destroy() æ—¶æ‰‹åŠ¨å…³é—­</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** å‘ Spring å®¹å™¨å£°æ˜ RestHighLevelClient Bean */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    public <span class="type">RestHighLevelClient</span> elasticsearchClient() &#123;</span><br><span class="line">        <span class="comment">// 1) è¯»å– host:portï¼›å¯æŒ‰éœ€è¿½åŠ è¶…æ—¶/è®¤è¯ç­‰é…ç½®</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">ClientConfiguration</span> clientConfiguration =</span><br><span class="line">                <span class="type">ClientConfiguration</span>.builder()</span><br><span class="line">                                   .connectedTo(appConfig.getEsHostPort())</span><br><span class="line">                                   .build();</span><br><span class="line">        <span class="comment">// 2) åˆ›å»ºå®¢æˆ·ç«¯</span></span><br><span class="line">        client = <span class="type">RestClients</span>.create(clientConfiguration).rest();</span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** å®¹å™¨é”€æ¯æ—¶å…³é—­åº•å±‚å®¢æˆ·ç«¯ï¼Œé¿å…è¿æ¥æ³„éœ² */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public void destroy() <span class="keyword">throws</span> <span class="type">Exception</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (client != <span class="literal">null</span>) &#123;</span><br><span class="line">            client.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯<strong>å¤šèŠ‚ç‚¹é›†ç¾¤</strong>ï¼Œ<code>connectedTo()</code> å¯ä¼ å¤šä¸ª <code>host:port</code>ï¼Œä¾‹å¦‚ <code>connectedTo(&quot;es1:9200&quot;,&quot;es2:9200&quot;)</code>ã€‚</p>
<p>åœ¨å®¢æˆ·ç«¯å¯åŠ¨ç±»ä¸‹é¢åˆ›å»ºInitRun</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.easylive.redis.RedisUtils;</span><br><span class="line"><span class="keyword">import</span> com.easylive.component.EsSearchComponent;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationArguments;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component(&quot;initRun&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InitRun</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(InitRun.class);</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;            <span class="comment">// ç”¨äº DB å¥åº·æ£€æŸ¥</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisUtils redisUtils;            <span class="comment">// ç”¨äº Redis å¥åº·æ£€æŸ¥</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> EsSearchComponent esSearchComponent; <span class="comment">// åˆå§‹åŒ– ES ç´¢å¼•</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">startSuccess</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1) DB å¥åº·æ£€æŸ¥ï¼šèƒ½æ‹¿åˆ°è¿æ¥å³è®¤ä¸º OK</span></span><br><span class="line">            connection = dataSource.getConnection();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2) Redis å¥åº·æ£€æŸ¥ï¼šç®€å• GET ä¸€ä¸‹ï¼ˆä¸å…³å¿ƒè¿”å›å€¼ï¼‰</span></span><br><span class="line">            redisUtils.get(<span class="string">&quot;test&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3) ES ç´¢å¼•åˆå§‹åŒ–ï¼ˆä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰</span></span><br><span class="line">            esSearchComponent.createIndex();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4) å¯åŠ¨æˆåŠŸæ—¥å¿—</span></span><br><span class="line">            logger.error(<span class="string">&quot;æœåŠ¡å¯åŠ¨æˆåŠŸï¼Œå¯ä»¥å¼€å§‹æ„‰å¿«çš„å¼€å‘äº†&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;æ•°æ®åº“é…ç½®é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“é…ç½®&quot;</span>);</span><br><span class="line">            startSuccess = <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;æœåŠ¡å¯åŠ¨å¤±è´¥&quot;</span>, e);</span><br><span class="line">            startSuccess = <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 5) é‡Šæ”¾ DB è¿æ¥</span></span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123; connection.close(); &#125; <span class="keyword">catch</span> (SQLException ignore) &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 6) è‹¥å¯åŠ¨å‰ç½®æ£€æŸ¥å¤±è´¥ï¼Œç›´æ¥é€€å‡ºè¿›ç¨‹ï¼ˆå¯æ”¹æˆæŠ›å¼‚å¸¸è®©å®¹å™¨é‡å¯ï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> (!startSuccess) &#123;</span><br><span class="line">                System.exit(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µâ€œå¯åŠ¨å‰ç½®æ£€æŸ¥â€èƒ½åœ¨<strong>å¼€å‘/æµ‹è¯•</strong>é˜¶æ®µå¿«é€Ÿæš´éœ²é…ç½®é—®é¢˜ã€‚åœ¨çº¿ä¸Šå¯ä»¥æ”¹ä¸ºï¼š<strong>å¤±è´¥æŠ›å¼‚å¸¸è®©å¹³å°é‡å¯</strong>æˆ–<strong>é™çº§å¯åŠ¨å¹¶æ‰“å‘Šè­¦</strong>ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1083.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1051-1024x309.png" alt="img"></p>
<h3 id="3-ESæ–°å¢ä¿®æ”¹åˆ é™¤">3.ESæ–°å¢ä¿®æ”¹åˆ é™¤</h3>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1084.png" alt="img"></p>
<p>åˆ›å»ºVideoInfoEsDto</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ES æ–‡æ¡£æŠ•å½±ï¼šåªæ”¾æ£€ç´¢/å±•ç¤ºéœ€è¦çš„å­—æ®µï¼Œé¿å…æŠŠ DB å…¨é‡å¡è¿› ES</span></span><br><span class="line"><span class="keyword">public</span> class VideoInfoEsDto &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** è§†é¢‘IDï¼ˆåŒæ—¶ä½œä¸º ES æ–‡æ¡£ _idï¼‰ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> videoId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** å°é¢å›¾åœ°å€ï¼ˆä»…å±•ç¤ºï¼Œä¸å‚ä¸æ£€ç´¢ï¼‰ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> videoCover;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** è§†é¢‘æ ‡é¢˜ï¼ˆä¼šèµ°åˆ†è¯æ£€ç´¢ï¼Œè§ mapping çš„ analyzerï¼‰ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> videoName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** ä½œè€…IDï¼ˆå¯ç”¨äºè¿‡æ»¤/èšåˆï¼‰ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> userId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** å‘å¸ƒæ—¶é—´ï¼ˆç»Ÿä¸€è¾“å‡ºæ ¼å¼ï¼Œä¾¿äº Kibana æŸ¥çœ‹ä¸èŒƒå›´è¿‡æ»¤ï¼‰ */</span></span><br><span class="line">    @JSONField(format = <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">Date</span> createTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** æ ‡ç­¾ï¼šç”¨é€—å·æ‹¼æ¥çš„å­—ç¬¦ä¸²ï¼ŒES é‡Œç”¨è‡ªå®šä¹‰ comma åˆ†è¯å™¨æ‹†åˆ† */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> tags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** è®¡æ•°å­—æ®µï¼šæ’­æ”¾ã€å¼¹å¹•ã€æ”¶è—ï¼ˆåˆå§‹åŒ– 0ï¼Œåç»­ç”¨è„šæœ¬å¢é‡æ›´æ–°ï¼‰ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">Integer</span> playCount;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">Integer</span> danmuCount;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">Integer</span> collectCount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®šä¹‰æšä¸¾ç±»SearchOrderTypeEnumï¼š</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">enums</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">SearchOrderTypeEnum</span> &#123;</span><br><span class="line">    <span class="title function_">VIDEO_PLAY</span>(<span class="number">0</span>, <span class="string">&quot;playCount&quot;</span>, <span class="string">&quot;è§†é¢‘æ’­æ”¾æ•°&quot;</span>),</span><br><span class="line">    <span class="title function_">VIDEO_TIME</span>(<span class="number">1</span>, <span class="string">&quot;createTime&quot;</span>, <span class="string">&quot;è§†é¢‘æ—¶é—´&quot;</span>),</span><br><span class="line">    <span class="title function_">VIDEO_DANMU</span>(<span class="number">2</span>, <span class="string">&quot;danmuCount&quot;</span>, <span class="string">&quot;å¼¹å¹•æ•°&quot;</span>),</span><br><span class="line">    <span class="title function_">VIDEO_COLLECT</span>(<span class="number">3</span>, <span class="string">&quot;collectCount&quot;</span>, <span class="string">&quot;è§†é¢‘æ”¶è—&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> <span class="keyword">type</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> field;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> desc;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">SearchOrderTypeEnum</span>(<span class="title class_">Integer</span> <span class="keyword">type</span>, <span class="title class_">String</span> field, <span class="title class_">String</span> desc) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">type</span> = <span class="keyword">type</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">field</span> = field;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">desc</span> = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="title class_">SearchOrderTypeEnum</span> <span class="title function_">getByType</span>(<span class="params"><span class="title class_">Integer</span> <span class="keyword">type</span></span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="title class_">SearchOrderTypeEnum</span> item : <span class="title class_">SearchOrderTypeEnum</span>.<span class="title function_">values</span>()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (item.<span class="title function_">getType</span>().<span class="title function_">equals</span>(<span class="keyword">type</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> item;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getType</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">type</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getDesc</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getField</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1085.png" alt="img"></p>
<p>åœ¨EsSearchComponent</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/** åˆ¤æ–­æŒ‡å®šæ–‡æ¡£æ˜¯å¦å­˜åœ¨ï¼ˆåŸºäº Getï¼Œæ˜“ç†è§£ï¼›ä¹Ÿå¯æ›¿æ¢ä¸º exists æ›´è½»é‡ï¼‰ */</span></span><br><span class="line"><span class="keyword">private</span> Boolean <span class="title function_">docExist</span><span class="params">(String id)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">GetRequest</span> <span class="variable">getRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GetRequest</span>(appConfig.getEsIndexVideoName(), id);</span><br><span class="line">    <span class="type">GetResponse</span> <span class="variable">response</span> <span class="operator">=</span> restHighLevelClient.get(getRequest, RequestOptions.DEFAULT);</span><br><span class="line">    <span class="keyword">return</span> response.isExists();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** ä¿å­˜æ–‡æ¡£ï¼šè‹¥å­˜åœ¨åˆ™è½¬ä¸ºæ›´æ–°ï¼›ä¸å­˜åœ¨å°±æ„å»º DTO é¦–æ¬¡å†™å…¥å¹¶æŠŠè®¡æ•°ç½® 0 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveDoc</span><span class="params">(VideoInfo videoInfo)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (docExist(videoInfo.getVideoId())) &#123;</span><br><span class="line">            updateDoc(videoInfo); <span class="comment">// å·²å­˜åœ¨ â†’ åšå±€éƒ¨æ›´æ–°</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å¤åˆ¶åˆ° ES DTOï¼Œé¿å…æŠŠæ— å…³å­—æ®µå†™å…¥ ES</span></span><br><span class="line">            <span class="type">VideoInfoEsDto</span> <span class="variable">dto</span> <span class="operator">=</span> CopyTools.copy(videoInfo, VideoInfoEsDto.class);</span><br><span class="line">            <span class="comment">// è®¡æ•°å­—æ®µé¦–å‘ç½® 0ï¼Œæ–¹ä¾¿åç»­è„šæœ¬è‡ªå¢</span></span><br><span class="line">            dto.setCollectCount(<span class="number">0</span>);</span><br><span class="line">            dto.setPlayCount(<span class="number">0</span>);</span><br><span class="line">            dto.setDanmuCount(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">IndexRequest</span> <span class="variable">req</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexRequest</span>(appConfig.getEsIndexVideoName());</span><br><span class="line">            req.id(videoInfo.getVideoId())</span><br><span class="line">               .source(JsonUtils.convertObj2Json(dto), XContentType.JSON);</span><br><span class="line">            restHighLevelClient.index(req, RequestOptions.DEFAULT);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;æ–°å¢è§†é¢‘åˆ°eså¤±è´¥&quot;</span>, e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;ä¿å­˜å¤±è´¥&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** å±€éƒ¨æ›´æ–°ï¼šä»…æŠŠéç©ºã€ä¸”å­—ç¬¦ä¸²ä¸ä¸ºç©ºçš„å­—æ®µå†™å…¥ï¼›å¹¶æ˜¾å¼å¿½ç•¥åˆ›å»º/æ›´æ–°æ—¶é—´ */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateDoc</span><span class="params">(VideoInfo videoInfo)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// é˜²æ­¢é”™è¯¯è¦†ç›–ï¼ŒæŠŠæ—¶é—´å­—æ®µç½®ç©ºä»¥é¿å…å†™å…¥ ES</span></span><br><span class="line">        videoInfo.setLastUpdateTime(<span class="literal">null</span>);</span><br><span class="line">        videoInfo.setCreateTime(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; dataMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// é€šè¿‡åå°„éå†æ‰€æœ‰å­—æ®µï¼Œæ”¶é›†éœ€è¦æ›´æ–°çš„é¡¹ï¼ˆnull ä¸ç©ºä¸²è·³è¿‡ï¼‰</span></span><br><span class="line">        <span class="keyword">for</span> (Field field : videoInfo.getClass().getDeclaredFields()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">getter</span> <span class="operator">=</span> <span class="string">&quot;get&quot;</span> + StringTools.upperCaseFirstLetter(field.getName());</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> videoInfo.getClass().getMethod(getter);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">val</span> <span class="operator">=</span> method.invoke(videoInfo);</span><br><span class="line">            <span class="keyword">if</span> ((val <span class="keyword">instanceof</span> String &amp;&amp; !StringTools.isEmpty((String) val))</span><br><span class="line">                    || (val != <span class="literal">null</span> &amp;&amp; !(val <span class="keyword">instanceof</span> String))) &#123;</span><br><span class="line">                dataMap.put(field.getName(), val);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (dataMap.isEmpty()) <span class="keyword">return</span>; <span class="comment">// æ²¡æœ‰å¾…æ›´æ–°å­—æ®µåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line"></span><br><span class="line">        <span class="type">UpdateRequest</span> <span class="variable">ur</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpdateRequest</span>(appConfig.getEsIndexVideoName(), videoInfo.getVideoId());</span><br><span class="line">        ur.doc(dataMap);</span><br><span class="line">        restHighLevelClient.update(ur, RequestOptions.DEFAULT);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;æ›´æ–°è§†é¢‘åˆ°eså¤±è´¥&quot;</span>, e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;ä¿å­˜å¤±è´¥&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** è®¡æ•°å‹å­—æ®µçš„åŸå­è‡ªå¢ï¼šctx._source.field += params.count */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateDocCount</span><span class="params">(String videoId, String fieldName, Integer count)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">UpdateRequest</span> <span class="variable">ur</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpdateRequest</span>(appConfig.getEsIndexVideoName(), videoId);</span><br><span class="line">        <span class="type">Script</span> <span class="variable">script</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Script</span>(</span><br><span class="line">            ScriptType.INLINE, <span class="string">&quot;painless&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ctx._source.&quot;</span> + fieldName + <span class="string">&quot; += params.count&quot;</span>,</span><br><span class="line">            Collections.singletonMap(<span class="string">&quot;count&quot;</span>, count)</span><br><span class="line">        );</span><br><span class="line">        ur.script(script);</span><br><span class="line">        restHighLevelClient.update(ur, RequestOptions.DEFAULT);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;æ›´æ–°æ•°é‡åˆ°eså¤±è´¥&quot;</span>, e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;ä¿å­˜å¤±è´¥&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** åˆ é™¤æ–‡æ¡£ï¼šDB å·²åˆ åï¼ŒES é‡ŒåšåŒæ­¥åˆ é™¤ï¼Œä¿æŒæœç´¢ç»“æœä¸€è‡´ */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delDoc</span><span class="params">(String videoId)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">DeleteRequest</span> <span class="variable">dr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DeleteRequest</span>(appConfig.getEsIndexVideoName(), videoId);</span><br><span class="line">        restHighLevelClient.delete(dr, RequestOptions.DEFAULT);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;ä»esåˆ é™¤è§†é¢‘å¤±è´¥&quot;</span>, e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;åˆ é™¤è§†é¢‘å¤±è´¥&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>å®ç°è¦ç‚¹</strong></p>
<ul>
<li><strong>å¹‚ç­‰</strong>ï¼š<code>saveDoc</code> å†…éƒ¨å…ˆ <code>docExist</code>ï¼Œå­˜åœ¨å°±èµ°æ›´æ–°ï¼Œä¸å­˜åœ¨æ‰æ’å…¥ï¼›<code>delDoc</code> åˆ é™¤ä¸å­˜åœ¨çš„æ–‡æ¡£ä¹Ÿä¸ä¼šæŠ¥é”™ï¼ˆES é»˜è®¤å®¹å¿ï¼‰ã€‚</li>
<li><strong>å¢é‡ä¸€è‡´æ€§</strong>ï¼šäº’åŠ¨è®¡æ•°éƒ½èµ° <code>updateDocCount</code> è„šæœ¬ï¼Œ<strong>é¿å…å¹¶å‘è¦†ç›–</strong>ã€‚</li>
<li><strong>å­—æ®µæ§åˆ¶</strong>ï¼š<code>updateDoc</code> ä¸å†™å…¥ <code>createTime/lastUpdateTime</code>ï¼Œé˜²æ­¢æŠŠ DB çš„ç»´æŠ¤å­—æ®µè¦†ç›– ESã€‚</li>
</ul>
<p>åé¢æˆ‘ä»¬åˆ†åˆ«æµ‹è¯•å¢åˆ æ”¹çœ‹çœ‹è¿™äº›æ–¹æ³•æ˜¯å¦èƒ½ç”Ÿæ•ˆ</p>
<h4 id="1-æµ‹è¯•saveDoc">1.æµ‹è¯•saveDoc</h4>
<p>è¡¥å…¨åœ¨VideoInfoPostServiceImplä¸­çš„TODOï¼Œ<em>ä¿å­˜ä¿¡æ¯åˆ°es</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç®¡ç†å‘˜å®¡æ ¸è§†é¢‘ï¼ˆé€šè¿‡/é©³å›ï¼‰</span></span><br><span class="line"><span class="comment"> * å…³é”®ç‚¹ï¼š</span></span><br><span class="line"><span class="comment"> * 1) çŠ¶æ€æ ¡éªŒï¼šstatus å¿…é¡»æ˜¯ VideoStatusEnum é‡Œåˆæ³•å€¼</span></span><br><span class="line"><span class="comment"> * 2) ä¹è§‚é”ï¼šåªå…è®¸ä»â€œå¾…å®¡æ ¸(2)â€æ›´æ–°ä¸ºç›®æ ‡çŠ¶æ€ï¼ˆwhere status=2ï¼‰</span></span><br><span class="line"><span class="comment"> * 3) é€šè¿‡åˆ™æŠŠæŠ•ç¨¿æ•°æ®å¤åˆ¶åˆ°æ­£å¼è¡¨ï¼›é©³å›åˆ™åªæ›´æ–°çŠ¶æ€ä¸ç†ç”±</span></span><br><span class="line"><span class="comment"> * 4) æ¸…ç†â€œæ–‡ä»¶æ›´æ–°æ ‡å¿—â€ï¼Œæ¸…ç†å¾…åˆ é™¤æ–‡ä»¶é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">auditVideo</span><span class="params">(String videoId, Integer status, String reason)</span> &#123;</span><br><span class="line">	<span class="comment">// --- 0) åŸºç¡€æ ¡éªŒ ---</span></span><br><span class="line">	<span class="type">VideoStatusEnum</span> <span class="variable">targetEnum</span> <span class="operator">=</span> VideoStatusEnum.getByStatus(status);</span><br><span class="line">	<span class="keyword">if</span> (targetEnum == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600); <span class="comment">// éæ³•çŠ¶æ€</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ä»…å…è®¸æŠŠâ€œå¾…å®¡æ ¸(2)â€ -&gt; â€œé€šè¿‡(3)â€æˆ–â€œå¤±è´¥(4)â€ï¼Œå…¶ä½™å˜è¿ä¸æ”¯æŒ</span></span><br><span class="line">	<span class="keyword">if</span> (!(VideoStatusEnum.STATUS3 == targetEnum || VideoStatusEnum.STATUS4 == targetEnum)) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// --- 1) ä¹è§‚é”åœ°æ›´æ–° video_info_post ä¸»è¡¨ ---</span></span><br><span class="line">	<span class="type">VideoInfoPost</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoPost</span>();</span><br><span class="line">	update.setStatus(status);                          <span class="comment">// æ–°çŠ¶æ€</span></span><br><span class="line">	update.setLastUpdateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());              <span class="comment">// æœ€åæ›´æ–°æ—¶é—´</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// where æ¡ä»¶ï¼švideo_id=...? AND status=å¾…å®¡æ ¸(2)</span></span><br><span class="line">	<span class="type">VideoInfoPostQuery</span> <span class="variable">where</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoPostQuery</span>();</span><br><span class="line">	where.setVideoId(videoId);</span><br><span class="line">	where.setStatus(VideoStatusEnum.STATUS2.getStatus()); <span class="comment">// åªåœ¨â€œå¾…å®¡æ ¸â€æ‰èƒ½è¢«å®¡æ ¸</span></span><br><span class="line"></span><br><span class="line">	<span class="type">Integer</span> <span class="variable">affected</span> <span class="operator">=</span> videoInfoPostMapper.updateByParam(update, where);</span><br><span class="line">	<span class="keyword">if</span> (affected == <span class="literal">null</span> || affected == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">// è¯´æ˜ä¸æ˜¯å¾…å®¡æ ¸çŠ¶æ€ï¼ˆå¯èƒ½å·²è¢«åˆ«äººå®¡æ ¸è¿‡ï¼‰ï¼Œæˆ– videoId éæ³•</span></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;å®¡æ ¸å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// --- 2) å½’é›¶æœ¬è½®â€œæ–‡ä»¶æ›´æ–°â€æ ‡å¿—ï¼ˆpost æ–‡ä»¶è¡¨ï¼‰---</span></span><br><span class="line">	<span class="type">VideoInfoFilePost</span> <span class="variable">fileFlagUpdate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoFilePost</span>();</span><br><span class="line">	fileFlagUpdate.setUpdateType(VideoFileUpdateTypeEnum.NO_UPDATE.getStatus());</span><br><span class="line">	<span class="type">VideoInfoFilePostQuery</span> <span class="variable">filePostWhere</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoFilePostQuery</span>();</span><br><span class="line">	filePostWhere.setVideoId(videoId);</span><br><span class="line">	videoInfoFilePostMapper.updateByParam(fileFlagUpdate, filePostWhere);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// --- 3) è‹¥å®¡æ ¸å¤±è´¥ï¼Œç›´æ¥ç»“æŸï¼ˆä¸è¿›å…¥çº¿ä¸Šè¡¨ï¼‰---</span></span><br><span class="line">	<span class="keyword">if</span> (VideoStatusEnum.STATUS4 == targetEnum) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// --- 4) å®¡æ ¸é€šè¿‡ï¼šæŠŠæŠ•ç¨¿æ•°æ®å¤åˆ¶åˆ°æ­£å¼è¡¨ ---</span></span><br><span class="line">	<span class="comment">// 4.1 è¯»å–æœ€æ–°çš„æŠ•ç¨¿ä¸»è¡¨æ•°æ®</span></span><br><span class="line">	<span class="type">VideoInfoPost</span> <span class="variable">infoPost</span> <span class="operator">=</span> videoInfoPostMapper.selectByVideoId(videoId);</span><br><span class="line">	<span class="keyword">if</span> (infoPost == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="comment">// ç†è®ºä¸Šä¸è¯¥å‡ºç°ï¼›åŠ é˜²å¾¡</span></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;å®¡æ ¸å¤±è´¥ï¼Œæ•°æ®ä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 4.2 é¦–æ¬¡å‘å¸ƒå¥–åŠ±ï¼ˆå¯é€‰é¡¹ï¼‰ï¼šè‹¥æ­£å¼è¡¨ä¸å­˜åœ¨è¯¥ videoIdï¼Œè®¤ä¸ºæ˜¯é¦–å‘ï¼Œå¯åŠ ç¡¬å¸</span></span><br><span class="line">	<span class="type">VideoInfo</span> <span class="variable">existOnline</span> <span class="operator">=</span> (VideoInfo) videoInfoMapper.selectByVideoId(videoId);<span class="comment">// æŸ¥æ­£å¼è¡¨</span></span><br><span class="line">	<span class="keyword">if</span> (existOnline == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="type">SysSettingDto</span> <span class="variable">sysSettingDto</span> <span class="operator">=</span> redisComponent.getSysSettingDto();</span><br><span class="line">		<span class="comment">// TODOï¼šç»™ infoPost.getUserId() åŠ ç¡¬å¸ï¼Œé¢åº¦æ¥è‡ª sysSettingDto</span></span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 4.3 å¤åˆ¶â€œä¸»è¡¨â€åˆ°æ­£å¼è¡¨ï¼ˆinsertOrUpdateï¼‰</span></span><br><span class="line">	<span class="type">VideoInfo</span> <span class="variable">online</span> <span class="operator">=</span> CopyTools.copy(infoPost, VideoInfo.class);</span><br><span class="line">	videoInfoMapper.insertOrUpdate(online);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 4.4 æ›¿æ¢â€œæ–‡ä»¶æ¸…å•â€ï¼šå…ˆåˆ æ­£å¼è¡¨æ—§æ¸…å•ï¼Œå†æ‹·è´æŠ•ç¨¿æ–‡ä»¶æ¸…å•</span></span><br><span class="line">	<span class="type">VideoInfoFileQuery</span> <span class="variable">delWhere</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoFileQuery</span>();</span><br><span class="line">	delWhere.setVideoId(videoId);</span><br><span class="line">	videoInfoFileMapper.deleteByParam(delWhere);</span><br><span class="line"></span><br><span class="line">	<span class="type">VideoInfoFilePostQuery</span> <span class="variable">postFilesQ</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoFilePostQuery</span>();</span><br><span class="line">	postFilesQ.setVideoId(videoId);</span><br><span class="line">	List&lt;VideoInfoFilePost&gt; postFiles = videoInfoFilePostMapper.selectList(postFilesQ);</span><br><span class="line"></span><br><span class="line">	List&lt;VideoInfoFile&gt; onlineFiles = CopyTools.copyList(postFiles, VideoInfoFile.class);</span><br><span class="line">	<span class="keyword">if</span> (!onlineFiles.isEmpty()) &#123;</span><br><span class="line">		videoInfoFileMapper.insertBatch(onlineFiles);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// --- 5) æ¸…ç†â€œå¾…åˆ é™¤æ–‡ä»¶é˜Ÿåˆ—â€é‡Œçš„ç‰©ç†æ–‡ä»¶ ---</span></span><br><span class="line">	List&lt;String&gt; filePathList = redisComponent.getDelFileList(videoId); <span class="comment">// æ¯ä¸ª path æ˜¯ç›¸å¯¹è·¯å¾„ï¼šå¦‚ &quot;video/20250812/xxx&quot;</span></span><br><span class="line">	<span class="keyword">if</span> (filePathList != <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">for</span> (String relative : filePathList) &#123;</span><br><span class="line">			<span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(appConfig.getProjectFolder() + Constants.FILE_FOLDER + relative);</span><br><span class="line">			<span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="comment">// æœ‰çš„ path æŒ‡å‘çš„æ˜¯ç›®å½•ï¼ˆå¦‚ uploadId ç›®å½•ï¼‰ï¼Œç”¨é€’å½’åˆ æ›´ç¨³</span></span><br><span class="line">					FileUtils.deleteDirectory(file);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">					log.error(<span class="string">&quot;åˆ é™¤æ–‡ä»¶å¤±è´¥ path=&#123;&#125;&quot;</span>, relative, e);</span><br><span class="line">					<span class="comment">// ä¸æŠ›å‡ºï¼Œè®©äº‹åŠ¡å¯ç»§ç»­ï¼Œé¿å…çº¿ä¸Šæ•°æ®å·²æ›´æ–°å´å› æ¸…ç†å¤±è´¥æ•´ä½“å›æ»š</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	redisComponent.cleanDelFileList(videoId);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// --- 6) æŠŠè§†é¢‘ä¿¡æ¯ç´¢å¼•åˆ° ES</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * ä¿å­˜ä¿¡æ¯åˆ°es</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	esSearchComponent.saveDoc(online);;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1086-1024x341.png" alt="img"></p>
<p>è¿™é‡Œå…ˆå†™æ•°æ®åº“å†å†™esä¿è¯ä¸€è‡´æ€§</p>
<p>æµ‹è¯•</p>
<p>ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡å‰å¯ä»¥çœ‹åˆ°kibanaé‡Œé¢åªæœ‰ç´¢å¼•ï¼Œç´¢å¼•é‡Œé¢æ²¡å†…å®¹</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1057-1024x238.png" alt="img"></p>
<p>ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1058-1024x122.png" alt="img"></p>
<p>åœ¨æ•°æ®åº“ä¸­æ‰¾åˆ°è¿™ä¸ªvideo_idï¼Œåœ¨kibanaé‡ŒæŸ¥çœ‹èƒ½ä¸èƒ½æŸ¥åˆ°</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1059-1024x386.png" alt="img"></p>
<p>æˆåŠŸæŸ¥åˆ°</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1060-1024x300.png" alt="img"></p>
<h4 id="2-æµ‹è¯•updateDoc">2.æµ‹è¯•updateDoc</h4>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1087.png" alt="img"></p>
<p>æµ‹è¯•ä¸€ä¸‹EsSearchCompoentçš„updateDocæ–¹æ³•</p>
<p>ç¼–è¾‘å·²ç»å·²ç»ä¸Šä¼ è¿‡çš„ç¨¿ä»¶åœ¨ç®€ä»‹ä¸­åŠ å…¥æµ‹è¯•EsCompoentçš„updateDocæ–¹æ³•</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1064-1024x466.png" alt="img"></p>
<p>å¦‚å›¾æ›´æ–°æˆåŠŸäº†</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1063-1024x339.png" alt="img"></p>
<h4 id="3-æµ‹è¯•updateDocCount">3.æµ‹è¯•updateDocCount</h4>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1088.png" alt="img"></p>
<p>æ›´æ–°VideoDanmuServiceImplé‡Œä¿å­˜è§†é¢‘å¼¹å¹•é‡Œçš„TODOï¼Œç”¨esä¿å­˜å¼¹å¹•æ•°é‡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * ä¿å­˜è§†é¢‘å¼¹å¹•</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> bean è§†é¢‘å¼¹å¹•å¯¹è±¡</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> BusinessException ä¸šåŠ¡å¼‚å¸¸</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveVideoDanmu</span><span class="params">(VideoDanmu bean)</span> &#123;</span><br><span class="line">		<span class="comment">// é€šè¿‡è§†é¢‘IDæŸ¥è¯¢è§†é¢‘ä¿¡æ¯</span></span><br><span class="line">		<span class="type">VideoInfo</span> <span class="variable">videoInfo</span> <span class="operator">=</span> videoInfoMapper.selectByVideoId(bean.getVideoId());</span><br><span class="line">		<span class="comment">// å¦‚æœè§†é¢‘ä¿¡æ¯ä¸ºç©ºï¼Œåˆ™æŠ›å‡ºä¸šåŠ¡å¼‚å¸¸</span></span><br><span class="line">		<span class="keyword">if</span> (videoInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// æ˜¯å¦å…³é—­å¼¹å¹•</span></span><br><span class="line">		<span class="comment">// å¦‚æœè§†é¢‘ç¦ç”¨äº†å¼¹å¹•ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">		<span class="keyword">if</span> (videoInfo.getInteraction() != <span class="literal">null</span> &amp;&amp; videoInfo.getInteraction().contains(Constants.ONE.toString())) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;UPä¸»å·²å…³é—­å¼¹å¹•&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// ä¿å­˜å¼¹å¹•ä¿¡æ¯</span></span><br><span class="line">		<span class="built_in">this</span>.videoDanmuMapper.insert(bean);</span><br><span class="line">		<span class="comment">// æ›´æ–°è§†é¢‘ä¿¡æ¯çš„å¼¹å¹•æ•°é‡</span></span><br><span class="line">		<span class="built_in">this</span>.videoInfoMapper.updateCountInfo(bean.getVideoId(), UserActionTypeEnum.VIDEO_DANMU.getField(), <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">// TODO æ›´æ–°eså¼¹å¹•æ•°é‡</span></span><br><span class="line">		<span class="comment">// è°ƒç”¨ESæœç´¢ç»„ä»¶æ›´æ–°å¼¹å¹•æ•°é‡</span></span><br><span class="line">		esSearchComponent.updateDocCount(bean.getVideoId(), SearchOrderTypeEnum.VIDEO_DANMU.getField(), <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•æˆ‘ä»¬ç»™åˆšå‘çš„ç¨¿ä»¶é‡Œå‘1ä¸ªå¼¹å¹•</p>
<p>ä¹‹ååœ¨kibanaå†æ¬¡æŸ¥æµ‹è¯•æ²¡é—®é¢˜</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1066-1024x302.png" alt="img"></p>
<p>åœ¨UserActionServiceImplä¸­è¡¥å…¨ saveActionï¼Œè®©æŠŠæ”¶è—æ•°åŠ åˆ°esä¸­</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (actionTypeEnum) &#123;</span><br><span class="line">          <span class="comment">//ç‚¹èµ,æ”¶è—</span></span><br><span class="line">          <span class="keyword">case</span> VIDEO_LIKE:</span><br><span class="line">          <span class="keyword">case</span> VIDEO_COLLECT:</span><br><span class="line">              <span class="comment">// ç‚¹èµæˆ–æ”¶è—ï¼šå¦‚æœå·²ç»æœ‰è¡Œä¸ºè®°å½•ï¼Œåˆ é™¤è®°å½•ï¼›å¦‚æœæ²¡æœ‰ï¼Œæ’å…¥æ–°è®°å½•</span></span><br><span class="line">              <span class="keyword">if</span> (dbAction != <span class="literal">null</span>) &#123;</span><br><span class="line">                  userActionMapper.deleteByActionId(dbAction.getActionId());<span class="comment">// åˆ é™¤æ—§è®°å½•</span></span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  userActionMapper.<span class="built_in">insert</span>(bean);<span class="comment">// æ’å…¥æ–°è®°å½•</span></span><br><span class="line">              &#125;</span><br><span class="line">              Integer changeCount = dbAction == <span class="literal">null</span> ? <span class="number">1</span> : <span class="number">-1</span>;<span class="comment">// å¢åŠ æˆ–å‡å°‘è®¡æ•°</span></span><br><span class="line">              videoInfoMapper.updateCountInfo(bean.getVideoId(), actionTypeEnum.getField(), changeCount); <span class="comment">// æ›´æ–°è§†é¢‘ç»Ÿè®¡ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (actionTypeEnum == UserActionTypeEnum.VIDEO_COLLECT) &#123;</span><br><span class="line">                  <span class="comment">//TODO æ›´æ–°esæ”¶è—æ•°é‡</span></span><br><span class="line">                  esSearchComponent.updateDocCount(videoInfo.getVideoId(), SearchOrderTypeEnum.VIDEO_COLLECT.getField(), changeCount);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>æ”¶è—è§†é¢‘åeså·²ç»æ›´æ–°åˆ°äº†æ•°æ®</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1067-1024x336.png" alt="img"></p>
<h4 id="4-æµ‹è¯•delDoc">4.æµ‹è¯•delDoc</h4>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1089.png" alt="img"></p>
<p>åœ¨VideoInfoServiceImplä¸­è¡¥ä¸Šåˆ é™¤ESçš„TODO</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteVideo</span><span class="params">(String videoId, String userId)</span> &#123;</span><br><span class="line">		<span class="comment">// 1) å½’å±æ ¡éªŒï¼šåªèƒ½åˆ è‡ªå·±çš„è§†é¢‘</span></span><br><span class="line">		<span class="type">VideoInfoPost</span> <span class="variable">vip</span> <span class="operator">=</span> videoInfoPostMapper.selectByVideoId(videoId);</span><br><span class="line">		<span class="keyword">if</span> (vip == <span class="literal">null</span> || (userId != <span class="literal">null</span> &amp;&amp; !userId.equals(vip.getUserId()))) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_404);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 2) äº‹åŠ¡å†…åˆ é™¤çº¿ä¸Šä¸ç¨¿ä»¶</span></span><br><span class="line">		videoInfoMapper.deleteByVideoId(videoId);</span><br><span class="line">		videoInfoPostMapper.deleteByVideoId(videoId);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> ç¡¬å¸ç»“ç®—ï¼ˆè¿”è¿˜/æ‰£å‡ï¼‰</span></span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> åˆ é™¤ES</span></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * åˆ é™¤esä¿¡æ¯</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		esSearchComponent.delDoc(videoId);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 3) æäº¤åå¼‚æ­¥æ¸…ç†â€œé™„å±è®°å½• + ç‰©ç†æ–‡ä»¶â€</span></span><br><span class="line">		executorService.execute(() -&gt; &#123;</span><br><span class="line">			<span class="comment">// 3.1 å…ˆæŸ¥åˆ†Påˆ—è¡¨ï¼ˆç”¨äºæ‹¿åˆ°ç£ç›˜è·¯å¾„ï¼‰</span></span><br><span class="line">			<span class="type">VideoInfoFileQuery</span> <span class="variable">fileQ</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoFileQuery</span>();</span><br><span class="line">			fileQ.setVideoId(videoId);</span><br><span class="line">			List&lt;VideoInfoFile&gt; parts = videoInfoFileMapper.selectList(fileQ);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 3.2 åˆ åˆ†Pè®°å½•ï¼ˆçº¿ä¸Šã€ç¨¿ä»¶ï¼‰</span></span><br><span class="line">			videoInfoFileMapper.deleteByParam(fileQ);</span><br><span class="line">			<span class="type">VideoInfoFilePostQuery</span> <span class="variable">filePostQ</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoFilePostQuery</span>();</span><br><span class="line">			filePostQ.setVideoId(videoId);</span><br><span class="line">			videoInfoFilePostMapper.deleteByParam(filePostQ);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 3.3 åˆ å¼¹å¹•</span></span><br><span class="line">			<span class="type">VideoDanmuQuery</span> <span class="variable">danmuQ</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoDanmuQuery</span>();</span><br><span class="line">			danmuQ.setVideoId(videoId);</span><br><span class="line">			videoDanmuMapper.deleteByParam(danmuQ);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 3.4 åˆ è¯„è®º</span></span><br><span class="line">			<span class="type">VideoCommentQuery</span> <span class="variable">commentQ</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoCommentQuery</span>();</span><br><span class="line">			commentQ.setVideoId(videoId);</span><br><span class="line">			videoCommentMapper.deleteByParam(commentQ);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 3.5 åˆ ç£ç›˜æ–‡ä»¶ï¼ˆé€ä¸ªè·¯å¾„å°è¯•åˆ é™¤ï¼‰</span></span><br><span class="line">			<span class="keyword">for</span> (VideoInfoFile p : parts) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					FileUtils.deleteDirectory(<span class="keyword">new</span> <span class="title class_">File</span>(appConfig.getProjectFolder() + p.getFilePath()));</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">					log.error(<span class="string">&quot;åˆ é™¤æ–‡ä»¶å¤±è´¥ï¼Œæ–‡ä»¶è·¯å¾„: &#123;&#125;&quot;</span>, p.getFilePath(), e);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ä¸€ä¸‹</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1076-1024x471.png" alt="img"></p>
<p>esä¸­å·²ç»æ²¡æœ‰è¿™ä¸ªç¨¿ä»¶çš„ä¿¡æ¯äº†</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1077-1024x229.png" alt="img"></p>
<ul>
<li><strong>å®¡æ ¸å‰</strong>ï¼šåªæœ‰ç´¢å¼•ç»“æ„ï¼Œæ— æ–‡æ¡£ã€‚</li>
<li><strong>å®¡æ ¸é€šè¿‡</strong>ï¼š<code>saveDoc</code> å†™å…¥æˆåŠŸ â†’ Kibana èƒ½æŒ‰ <code>videoId</code> æŸ¥åˆ°æ–‡æ¡£ã€‚</li>
<li><strong>ç¼–è¾‘</strong>ï¼šä¿®æ”¹ç®€ä»‹/æ ‡ç­¾ â†’ <code>updateDoc</code> ç”Ÿæ•ˆï¼Œæ–‡æ¡£å­—æ®µæ›´æ–°ã€‚</li>
<li><strong>å‘å¼¹å¹•/æ”¶è—</strong>ï¼š<code>updateDocCount</code> ç”Ÿæ•ˆï¼Œè®¡æ•°å­—æ®µé€’å¢ã€‚</li>
<li><strong>åˆ é™¤è§†é¢‘</strong>ï¼š<code>delDoc</code> ç”Ÿæ•ˆï¼Œæ–‡æ¡£æ¶ˆå¤±ã€‚</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1090.png" alt="img"></p>
<h3 id="4-ESæœç´¢">4.ESæœç´¢</h3>
<p>EsSearchCompoentä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> PaginationResultVO&lt;VideoInfo&gt; <span class="title function_">search</span><span class="params">(Boolean highlight, String keyword, Integer orderType, Integer pageNo, Integer pageSize)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">SearchOrderTypeEnum</span> <span class="variable">searchOrderTypeEnum</span> <span class="operator">=</span> SearchOrderTypeEnum.getByType(orderType);</span><br><span class="line"></span><br><span class="line">            <span class="type">SearchSourceBuilder</span> <span class="variable">searchSourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">            <span class="comment">//å…³é”®å­—</span></span><br><span class="line">            searchSourceBuilder.query(QueryBuilders.multiMatchQuery(keyword, <span class="string">&quot;videoName&quot;</span>, <span class="string">&quot;tags&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (highlight) &#123;</span><br><span class="line">                <span class="comment">//é«˜äº®</span></span><br><span class="line">                <span class="type">HighlightBuilder</span> <span class="variable">highlightBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>();</span><br><span class="line">                highlightBuilder.field(<span class="string">&quot;videoName&quot;</span>); <span class="comment">// æ›¿æ¢ä¸ºä½ æƒ³è¦é«˜äº®çš„å­—æ®µå</span></span><br><span class="line">                highlightBuilder.preTags(<span class="string">&quot;&lt;span class=&#x27;highlight&#x27;&gt;&quot;</span>);</span><br><span class="line">                highlightBuilder.postTags(<span class="string">&quot;&lt;/span&gt;&quot;</span>);</span><br><span class="line">                searchSourceBuilder.highlighter(highlightBuilder);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//æ’åº</span></span><br><span class="line">            <span class="keyword">if</span> (orderType != <span class="literal">null</span>) &#123;</span><br><span class="line">                searchSourceBuilder.sort(searchOrderTypeEnum.getField(), SortOrder.DESC); <span class="comment">// ç¬¬ä¸€ä¸ªæ’åºå­—æ®µï¼Œå‡åº</span></span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		 searchSourceBuilder.sort(<span class="string">&quot;_score&quot;</span>, SortOrder.DESC); <span class="comment">// ç¬¬ä¸€ä¸ªæ’åºå­—æ®µï¼Œå€’åº</span></span><br><span class="line">	   &#125;</span><br><span class="line">            pageNo = pageNo == <span class="literal">null</span> ? <span class="number">1</span> : pageNo;</span><br><span class="line">            <span class="comment">//åˆ†é¡µæŸ¥è¯¢</span></span><br><span class="line">            pageSize = pageSize == <span class="literal">null</span> ? PageSize.SIZE20.getSize() : pageSize;</span><br><span class="line">            searchSourceBuilder.size(pageSize);</span><br><span class="line">            searchSourceBuilder.from((pageNo - <span class="number">1</span>) * pageSize);</span><br><span class="line"></span><br><span class="line">            <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(appConfig.getEsIndexVideoName());</span><br><span class="line">            searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ‰§è¡ŒæŸ¥è¯¢</span></span><br><span class="line">            <span class="type">SearchResponse</span> <span class="variable">searchResponse</span> <span class="operator">=</span> restHighLevelClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å¤„ç†æŸ¥è¯¢ç»“æœ</span></span><br><span class="line">            <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> searchResponse.getHits();</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">totalCount</span> <span class="operator">=</span> (<span class="type">int</span>) hits.getTotalHits().value;</span><br><span class="line"></span><br><span class="line">            List&lt;VideoInfo&gt; videoInfoList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            List&lt;String&gt; userIdList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (SearchHit hit : hits.getHits()) &#123;</span><br><span class="line">                <span class="type">VideoInfo</span> <span class="variable">videoInfo</span> <span class="operator">=</span> JsonUtils.convertJson2Obj(hit.getSourceAsString(), VideoInfo.class);</span><br><span class="line">                <span class="keyword">if</span> (hit.getHighlightFields().get(<span class="string">&quot;videoName&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                    videoInfo.setVideoName(hit.getHighlightFields().get(<span class="string">&quot;videoName&quot;</span>).fragments()[<span class="number">0</span>].string());</span><br><span class="line">                &#125;</span><br><span class="line">                videoInfoList.add(videoInfo);</span><br><span class="line"></span><br><span class="line">                userIdList.add(videoInfo.getUserId());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">UserInfoQuery</span> <span class="variable">userInfoQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserInfoQuery</span>();</span><br><span class="line">            userInfoQuery.setUserIdList(userIdList);</span><br><span class="line">            List&lt;UserInfo&gt; userInfoList = userInfoMapper.selectList(userInfoQuery);</span><br><span class="line">            Map&lt;String, UserInfo&gt; userInfoMap = userInfoList.stream().collect(Collectors.toMap(item -&gt; item.getUserId(), Function.identity(), (data1, data2) -&gt; data2));</span><br><span class="line">            videoInfoList.forEach(item -&gt; &#123;</span><br><span class="line">                <span class="type">UserInfo</span> <span class="variable">userInfo</span> <span class="operator">=</span> userInfoMap.get(item.getUserId());</span><br><span class="line">                <span class="keyword">if</span> (userInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">                    item.setNickName(userInfo.getNickName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="type">SimplePage</span> <span class="variable">page</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimplePage</span>(pageNo, totalCount, pageSize);</span><br><span class="line">            PaginationResultVO&lt;VideoInfo&gt; result = <span class="keyword">new</span> <span class="title class_">PaginationResultVO</span>(totalCount, page.getPageSize(), page.getPageNo(), page.getPageTotal(), videoInfoList);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BusinessException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;æŸ¥è¯¢è§†é¢‘åˆ°eså¤±è´¥&quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;æŸ¥è¯¢å¤±è´¥&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>é«˜äº®/æ’åº/åˆ†é¡µ å°ç»“</strong></p>
<ul>
<li><strong>é«˜äº®</strong>ï¼šåªå¯¹ <code>videoName</code> åšé«˜äº®ï¼Œè¿”å›åæ›¿æ¢åŸå§‹æ ‡é¢˜ï¼›</li>
<li><strong>æ’åº</strong>ï¼š<code>orderTypeâ†’å­—æ®µæšä¸¾</code>ï¼Œ<strong>é˜²æ³¨å…¥</strong>ï¼›æœªæŒ‡å®šæ—¶èµ° <code>_score</code>ï¼›</li>
<li><strong>åˆ†é¡µ</strong>ï¼šæµ…åˆ†é¡µ OKï¼›è‹¥éœ€â€œç¿»åˆ°å¾ˆå¤šé¡µâ€ï¼Œå»ºè®®æ”¹ <strong><code>search_after</code></strong>ã€‚</li>
</ul>
<p>æ³¨æ„åœ¨UseInfoQueryä¸­åŠ å…¥ä¸€ä¸ªå­—æ®µåŠå…¶get/setæ–¹æ³•</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç”¨æˆ·IDåˆ—è¡¨ï¼Œç”¨äºæ‰¹é‡æŸ¥è¯¢</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> List&lt;<span class="type">String</span>&gt; userIdList;</span><br></pre></td></tr></table></figure>
<p>åœ¨ç”¨æˆ·ç«¯çš„VideoControllerå®šä¹‰æœç´¢è¿™ä¸ªæ¥å£ï¼Œæ™®é€šæœç´¢å’Œæœç´¢æ¨èéƒ½æ˜¯è°ƒçš„searchè¿™ä¸ªæ–¹æ³•</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// æ™®é€šæœç´¢ï¼šå¯é€‰æ’åº + é«˜äº® + åˆ†é¡µ</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/search&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">search</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="title class_">String</span> keyword, <span class="title class_">Integer</span> orderType, <span class="title class_">Integer</span> pageNo</span>) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> è®°å½•æœç´¢çƒ­è¯</span></span><br><span class="line">    <span class="title class_">PaginationResultVO</span> resultVO =</span><br><span class="line">        esSearchComponent.<span class="title function_">search</span>(<span class="literal">true</span>,  <span class="comment">// å¼€å¯é«˜äº®</span></span><br><span class="line">                                 keyword,</span><br><span class="line">                                 orderType,                     <span class="comment">// 0æ’­æ”¾/1æ—¶é—´/2å¼¹å¹•/3æ”¶è—ï¼›null=é»˜è®¤æŒ‰ç›¸å…³åº¦</span></span><br><span class="line">                                 pageNo,</span><br><span class="line">                                 <span class="title class_">PageSize</span>.<span class="property">SIZE30</span>.<span class="title function_">getSize</span>());    <span class="comment">// æ¯é¡µ30</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(resultVO);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// â€œçœ‹äº†åˆçœ‹â€æ¨èï¼šåŸºäºåŒä¸€å…³é”®è¯ï¼ŒæŒ‰æ’­æ”¾é‡å– Top10ï¼Œå¹¶æ’é™¤å½“å‰è§†é¢‘</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/getVideoRecommend&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">getVideoRecommend</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="title class_">String</span> keyword, <span class="meta">@NotEmpty</span> <span class="title class_">String</span> videoId</span>) &#123;</span><br><span class="line">    <span class="title class_">List</span>&lt;<span class="title class_">VideoInfo</span>&gt; list = esSearchComponent</span><br><span class="line">            .<span class="title function_">search</span>(<span class="literal">false</span>, keyword,</span><br><span class="line">                    <span class="title class_">SearchOrderTypeEnum</span>.<span class="property">VIDEO_PLAY</span>.<span class="title function_">getType</span>(),  <span class="comment">// æŒ‰æ’­æ”¾é‡é™åº</span></span><br><span class="line">                    <span class="number">1</span>, <span class="title class_">PageSize</span>.<span class="property">SIZE10</span>.<span class="title function_">getSize</span>())</span><br><span class="line">            .<span class="title function_">getList</span>();</span><br><span class="line">    list = list.<span class="title function_">stream</span>().<span class="title function_">filter</span>(v -&gt; !v.<span class="title function_">getVideoId</span>().<span class="title function_">equals</span>(videoId)).<span class="title function_">collect</span>(<span class="title class_">Collectors</span>.<span class="title function_">toList</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¦ç‚¹ï¼š</p>
<ul>
<li><code>orderType</code> åªæ¥å—æšä¸¾ï¼Œ<strong>æœç»æ‹¼æ¥ä»»æ„æ’åºå­—æ®µ</strong>ï¼›</li>
<li>æ¨èæ¥å£ä¸éœ€è¦é«˜äº®ï¼Œä¸”<strong>è¿‡æ»¤å½“å‰è§†é¢‘</strong>å³å¯ã€‚</li>
</ul>
<p>åœ¨UserInfoMapper.xmlä¸­ä¸ºuserIdListæ·»åŠ æ¡ä»¶</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!-- é€šç”¨æŸ¥è¯¢æ¡ä»¶åˆ—--&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;query_condition&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;base_condition_filed&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.userIdFuzzy!= null  and query.userIdFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                and u.user_id like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.userIdFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.nickNameFuzzy!= null  and query.nickNameFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                and u.nick_name like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.nickNameFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.avatarFuzzy!= null  and query.avatarFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                and u.avatar like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.avatarFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.emailFuzzy!= null  and query.emailFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                and u.email like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.emailFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.passwordFuzzy!= null  and query.passwordFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                and u.password like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.passwordFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.birthdayFuzzy!= null  and query.birthdayFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                and u.birthday like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.birthdayFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.schoolFuzzy!= null  and query.schoolFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                and u.school like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.schoolFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.personIntroductionFuzzy!= null  and query.personIntroductionFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                and u.person_introduction like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.personIntroductionFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.joinTimeStart!= null and query.joinTimeStart!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                &lt;![CDATA[ and  u.join_time&gt;=str_to_date(#</span><span class="template-variable">&#123;query.joinTimeStart&#125;</span><span class="language-xml">, &#x27;%Y-%m-%d&#x27;) ]]&gt;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.joinTimeEnd!= null and query.joinTimeEnd!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                &lt;![CDATA[ and  u.join_time&lt; date_sub(str_to_date(#</span><span class="template-variable">&#123;query.joinTimeEnd&#125;</span><span class="language-xml">,&#x27;%Y-%m-%d&#x27;),interval -1 day) ]]&gt;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.lastLoginTimeStart!= null and query.lastLoginTimeStart!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                &lt;![CDATA[ and  u.last_login_time&gt;=str_to_date(#</span><span class="template-variable">&#123;query.lastLoginTimeStart&#125;</span><span class="language-xml">, &#x27;%Y-%m-%d&#x27;) ]]&gt;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.lastLoginTimeEnd!= null and query.lastLoginTimeEnd!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                &lt;![CDATA[ and  u.last_login_time&lt; date_sub(str_to_date(#</span><span class="template-variable">&#123;query.lastLoginTimeEnd&#125;</span><span class="language-xml">,&#x27;%Y-%m-%d&#x27;),interval -1 day) ]]&gt;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.lastLoginIpFuzzy!= null  and query.lastLoginIpFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                and u.last_login_ip like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.lastLoginIpFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.noticeInfoFuzzy!= null  and query.noticeInfoFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                and u.notice_info like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.noticeInfoFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">              <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.userIdList!= null  and query.userIdList.size()&gt;0&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                and u.user_id in(<span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;query.userIdList&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span> <span class="attr">item</span>=<span class="string">&quot;item&quot;</span>&gt;</span>#</span><span class="template-variable">&#123;item&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">foreach</span>&gt;</span>)</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1091.png" alt="img"></p>
<p>æµ‹è¯•ä¸€ä¸‹æ²¡é—®é¢˜</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1072-1024x399.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1071-1024x514.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1092.png" alt="img"></p>
<p><strong>æ€»ç»“</strong></p>
<ul>
<li>Controller æ”¶å‚å¹¶åš <strong>orderType æ˜ å°„</strong>ï¼›</li>
<li><code>EsSearchComponent.search</code> ç»Ÿä¸€å®Œæˆ <strong>multi_match â†’ é«˜äº® â†’ æ’åº â†’ åˆ†é¡µ</strong>ï¼›</li>
<li>å‘½ä¸­ç»“æœåªå¸¦ userIdï¼Œå†ç”¨ä¸€æ¬¡ SQL <strong>æ‰¹é‡è¡¥é½æ˜µç§°</strong>ï¼›</li>
<li>æ¨èæ¥å£æŒ‰æ’­æ”¾é‡å– TopN å¹¶è¿‡æ»¤å½“å‰è§†é¢‘ã€‚<br>
è¿™å¥—å®ç°æ¸…æ™°ç¨³å¦¥ï¼Œæ˜“äºæ‰©å±•æƒé‡ã€å¬å›å­—æ®µå’Œæ›´å¤šç­›é€‰æ¡ä»¶</li>
</ul>
<h3 id="5-æœç´¢çƒ­è¯">5.æœç´¢çƒ­è¯</h3>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1093.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1094.png" alt="img"></p>
<p>å®Œå–„VideoControllerä¸­çš„searchæ–¹æ³•</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// VideoController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/search&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">search</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="title class_">String</span> keyword, <span class="title class_">Integer</span> orderType, <span class="title class_">Integer</span> pageNo</span>) &#123;</span><br><span class="line">    <span class="comment">// 1) è®°å½•æœç´¢çƒ­è¯ â€”â€” å°† keyword çš„è®¡æ•°åœ¨ Redis é‡Œè‡ªå¢ 1ï¼ˆZINCRBYï¼‰</span></span><br><span class="line">    redisComponent.<span class="title function_">addKeywordCount</span>(keyword);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) æ‰§è¡Œ ES æœç´¢ï¼ˆé«˜äº®/æ’åº/åˆ†é¡µå·²åœ¨ esSearchComponent å†…éƒ¨å®ç°ï¼‰</span></span><br><span class="line">    <span class="title class_">PaginationResultVO</span> resultVO =</span><br><span class="line">        esSearchComponent.<span class="title function_">search</span>(<span class="literal">true</span>, keyword, orderType, pageNo, <span class="title class_">PageSize</span>.<span class="property">SIZE30</span>.<span class="title function_">getSize</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) è¿”å›æœç´¢ç»“æœ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(resultVO);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è·å–â€œçƒ­æœ TopNâ€</span></span><br><span class="line"><span class="comment"> * - ç›´æ¥ä» Redis çš„ ZSET æŒ‰åˆ†æ•°å€’åºå–å‰ N ä¸ªå…³é”®å­—</span></span><br><span class="line"><span class="comment"> * - N ä½¿ç”¨åå°å¸¸é‡ï¼ˆä¾‹ï¼š10ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/getSearchKeywordTop&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">getSearchKeywordTop</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">List</span>&lt;<span class="title class_">String</span>&gt; keywordList = redisComponent.<span class="title function_">getKeywordTop</span>(<span class="title class_">Constants</span>.<span class="property">LENGTH_10</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(keywordList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šä¸¤ä¸ªå…¥å£æŠŠâ€œ<strong>è®¡æ•°</strong>â€å’Œâ€œ<strong>å–æ¦œ</strong>â€ä¸æœç´¢æµç¨‹è§£è€¦ï¼š</p>
<ul>
<li>æœç´¢æœ¬èº«ä¸å—çƒ­è¯å†™å…¥å¤±è´¥å½±å“ï¼›</li>
<li>çƒ­è¯æ¦œåªè¯» Redisï¼Œä¸æ‰“æ•°æ®åº“å‹åŠ›ã€‚</li>
</ul>
<p>åœ¨RedisCompoentä¸­</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœç´¢çƒ­è¯è®¡æ•° +1</span></span><br><span class="line"><span class="comment"> * - KEYï¼šConstants.REDIS_KEY_VIDEO_SEARCH_COUNTï¼ˆå»ºè®®å½¢å¦‚ &quot;video:search:count&quot;ï¼‰</span></span><br><span class="line"><span class="comment"> * - MEMBERï¼škeywordï¼ˆæœç´¢è¯ï¼‰</span></span><br><span class="line"><span class="comment"> * - SCOREï¼šç´¯è®¡æœç´¢æ¬¡æ•°ï¼ˆZINCRBYï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">addKeywordCount</span>(<span class="params"><span class="title class_">String</span> keyword</span>) &#123;</span><br><span class="line">    <span class="comment">// å†…éƒ¨è°ƒç”¨ redisUtils.opsForZSet().incrementScore(key, member, 1)</span></span><br><span class="line">    redisUtils.<span class="title function_">zaddCount</span>(<span class="title class_">Constants</span>.<span class="property">REDIS_KEY_VIDEO_SEARCH_COUNT</span>, keyword);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¯»å–çƒ­æœ TopN</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> top è¦å–çš„å‰ N ä¸ª</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> å€’åºæ’åˆ—çš„å…³é”®å­—åˆ—è¡¨ï¼ˆåˆ†æ•°ä»é«˜åˆ°ä½ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">List</span>&lt;<span class="title class_">String</span>&gt; <span class="title function_">getKeywordTop</span>(<span class="params"><span class="title class_">Integer</span> top</span>) &#123;</span><br><span class="line">    <span class="comment">// reverseRange çš„ end æ˜¯â€œé—­åŒºé—´ç´¢å¼•â€ï¼Œæ‰€ä»¥è¦ä¼  top-1ï¼ˆä¾‹å¦‚ Top10 â‡’ 0..9ï¼‰</span></span><br><span class="line">    <span class="keyword">return</span> redisUtils.<span class="title function_">getZSetList</span>(<span class="title class_">Constants</span>.<span class="property">REDIS_KEY_VIDEO_SEARCH_COUNT</span>, top - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½ å°è£…çš„ <code>zaddCount</code> æ­£æ˜¯ <code>incrementScore</code>ï¼›<code>getZSetList(key, endIndex)</code> å†…éƒ¨ç”¨çš„æ˜¯ <code>reverseRange(key, 0, endIndex)</code>ï¼Œå› æ­¤ä¼  <code>top-1</code> åˆšå¥½å–åˆ° N æ¡ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1095-1024x582.png" alt="img"></p>
<p>æµ‹è¯•åœ¨æœç´¢æ æŠŠå…³é”®è¯å¤šæ¬¡æœç´¢å°±ä¼šä¸Šçƒ­æœé‡Œé¢</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1074-1024x281.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1075-1024x317.png" alt="img"></p>
<h2 id="17-24å°æ—¶çƒ­é—¨æ˜¾ç¤ºä»¥åŠè§†é¢‘è¯¦æƒ…æ•°æ®å¤„ç†">17.24å°æ—¶çƒ­é—¨æ˜¾ç¤ºä»¥åŠè§†é¢‘è¯¦æƒ…æ•°æ®å¤„ç†</h2>
<h3 id="24å°æ—¶çƒ­é—¨æ˜¾ç¤º">24å°æ—¶çƒ­é—¨æ˜¾ç¤º</h3>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1097.png" alt="img"></p>
<p>åœ¨VideoControllerä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŠ è½½çƒ­é—¨è§†é¢‘åˆ—è¡¨</span></span><br><span class="line"><span class="comment"> * æ ¹æ®é¡µç åŠ è½½æœ€è¿‘24å°æ—¶å†…æ’­æ”¾é‡è¾ƒé«˜çš„è§†é¢‘åˆ—è¡¨ï¼Œå¹¶åŒ…å«ä½œè€…æ˜µç§°/å¤´åƒç­‰å±•ç¤ºå­—æ®µã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pageNo åˆ†é¡µé¡µç </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> æˆåŠŸå“åº”å¯¹è±¡ï¼ŒåŒ…å«çƒ­é—¨è§†é¢‘åˆ—è¡¨çš„åˆ†é¡µç»“æœ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/loadHotVideoList&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseVO <span class="title function_">loadHotVideoList</span><span class="params">(Integer pageNo)</span> &#123;</span><br><span class="line">    <span class="type">VideoInfoQuery</span> <span class="variable">videoInfoQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoQuery</span>();</span><br><span class="line">    videoInfoQuery.setPageNo(pageNo);                 <span class="comment">// åˆ†é¡µé¡µç ï¼ˆpageSize èµ°é»˜è®¤æˆ–æšä¸¾ï¼‰</span></span><br><span class="line">    videoInfoQuery.setQueryUserInfo(<span class="literal">true</span>);            <span class="comment">// éœ€è¦è¿è¡¨æ‹¿ä½œè€…æ˜µç§°/å¤´åƒç­‰å±•ç¤ºå­—æ®µ</span></span><br><span class="line">    videoInfoQuery.setOrderBy(<span class="string">&quot;play_count desc&quot;</span>);     <span class="comment">// æŒ‰æ€»æ’­æ”¾é‡å€’åº</span></span><br><span class="line">    videoInfoQuery.setLastPlayHour(Constants.HOUR_24);<span class="comment">// åªçœ‹æœ€è¿‘24å°æ—¶å†…æœ‰æ’­æ”¾è¡Œä¸ºçš„</span></span><br><span class="line">    <span class="type">PaginationResultVO</span> <span class="variable">resultVO</span> <span class="operator">=</span> videoInfoService.findListByPage(videoInfoQuery);</span><br><span class="line">    <span class="keyword">return</span> getSuccessResponseVO(resultVO);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨videoInfoQueryä¸­åŠ å…¥LastPlayHourçš„å­—æ®µåŠå…¶get/setæ–¹æ³•</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * æœ€åæ’­æ”¾å°æ—¶ï¼Œç”¨äºæŸ¥è¯¢æŸä¸ªå°æ—¶å†…è¢«è§‚çœ‹çš„è§†é¢‘ï¼ˆä¾‹å¦‚ï¼šæœ€è¿‘24å°æ—¶å†…çš„è§†é¢‘ï¼‰</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="built_in">Integer</span> lastPlayHour;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1098.png" alt="img"></p>
<p>åœ¨xmlä¸­è¿‡æ»¤è¿™ä¸ªå­—æ®µ</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!-- é€šç”¨æŸ¥è¯¢æ¡ä»¶åˆ—--&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;query_condition&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	 <span class="tag">&lt;<span class="name">where</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;base_condition_filed&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.videoIdFuzzy!= null  and query.videoIdFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 and  v.video_id like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.videoIdFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.videoCoverFuzzy!= null  and query.videoCoverFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 and  v.video_cover like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.videoCoverFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.videoNameFuzzy!= null  and query.videoNameFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 and  v.video_name like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.videoNameFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.userIdFuzzy!= null  and query.userIdFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 and  v.user_id like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.userIdFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.createTimeStart!= null and query.createTimeStart!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 &lt;![CDATA[ and  v.create_time&gt;=str_to_date(#</span><span class="template-variable">&#123;query.createTimeStart&#125;</span><span class="language-xml">, &#x27;%Y-%m-%d&#x27;) ]]&gt;</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.createTimeEnd!= null and query.createTimeEnd!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 &lt;![CDATA[ and  v.create_time&lt; date_sub(str_to_date(#</span><span class="template-variable">&#123;query.createTimeEnd&#125;</span><span class="language-xml">,&#x27;%Y-%m-%d&#x27;),interval -1 day) ]]&gt;</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.lastUpdateTimeStart!= null and query.lastUpdateTimeStart!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 &lt;![CDATA[ and  v.last_update_time&gt;=str_to_date(#</span><span class="template-variable">&#123;query.lastUpdateTimeStart&#125;</span><span class="language-xml">, &#x27;%Y-%m-%d&#x27;) ]]&gt;</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.lastUpdateTimeEnd!= null and query.lastUpdateTimeEnd!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 &lt;![CDATA[ and  v.last_update_time&lt; date_sub(str_to_date(#</span><span class="template-variable">&#123;query.lastUpdateTimeEnd&#125;</span><span class="language-xml">,&#x27;%Y-%m-%d&#x27;),interval -1 day) ]]&gt;</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.originInfoFuzzy!= null  and query.originInfoFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 and  v.origin_info like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.originInfoFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.tagsFuzzy!= null  and query.tagsFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 and  v.tags like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.tagsFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.introductionFuzzy!= null  and query.introductionFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 and  v.introduction like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.introductionFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.interactionFuzzy!= null  and query.interactionFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 and  v.interaction like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.interactionFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.lastPlayTimeStart!= null and query.lastPlayTimeStart!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 &lt;![CDATA[ and  v.last_play_time&gt;=str_to_date(#</span><span class="template-variable">&#123;query.lastPlayTimeStart&#125;</span><span class="language-xml">, &#x27;%Y-%m-%d&#x27;) ]]&gt;</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.lastPlayTimeEnd!= null and query.lastPlayTimeEnd!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 &lt;![CDATA[ and  v.last_play_time&lt; date_sub(str_to_date(#</span><span class="template-variable">&#123;query.lastPlayTimeEnd&#125;</span><span class="language-xml">,&#x27;%Y-%m-%d&#x27;),interval -1 day) ]]&gt;</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">		 <span class="comment">&lt;!--è¡¥å……çš„æ¡ä»¶--&gt;</span></span></span><br><span class="line"><span class="language-xml">		 <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.categoryIdOrPCategoryId!=null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			 and (category_id = #</span><span class="template-variable">&#123;query.categoryIdOrPCategoryId&#125;</span><span class="language-xml"> or p_category_id = #</span><span class="template-variable">&#123;query.categoryIdOrPCategoryId&#125;</span><span class="language-xml">)</span></span><br><span class="line"><span class="language-xml">		 <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">		 <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.videoIdArray!=null and query.videoIdArray.length&gt;0&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			 and video_id in(<span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;query.videoIdArray&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span> <span class="attr">item</span>=<span class="string">&quot;item&quot;</span>&gt;</span>#</span><span class="template-variable">&#123;item&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">foreach</span>&gt;</span>)</span></span><br><span class="line"><span class="language-xml">		 <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">		 <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.excludeVideoIdArray!=null and query.excludeVideoIdArray.length&gt;0&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			 and video_id not in(<span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;query.excludeVideoIdArray&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span> <span class="attr">item</span>=<span class="string">&quot;item&quot;</span>&gt;</span>#</span><span class="template-variable">&#123;item&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">foreach</span>&gt;</span>)</span></span><br><span class="line"><span class="language-xml">		 <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">		 <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.lastPlayHour!=null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			 &lt;![CDATA[ and  v.last_play_time&gt;=date_sub(now(), interval #</span><span class="template-variable">&#123;query.lastPlayHour&#125;</span><span class="language-xml"> hour) ]]&gt;</span></span><br><span class="line"><span class="language-xml">		 <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">	 <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<h3 id="è§†é¢‘è¯¦æƒ…æ•°æ®å¤„ç†">è§†é¢‘è¯¦æƒ…æ•°æ®å¤„ç†</h3>
<p>åœ¨æ’­æ”¾è§†é¢‘æ—¶åˆ‡æ¢åˆ†pï¼Œæˆ‘ä»¬å¹¶ä¸æ˜¯è®°ä¸€ä¸ªè§†é¢‘çš„æ’­æ”¾ä¿¡æ¯å°±ä½œä¸ºæ€»çš„ä¿¡æ¯ï¼Œæ˜¯æ‰€æœ‰åˆ†påŠ åœ¨ä¸€èµ·çš„æ’­æ”¾ä¿¡æ¯æ‰æ˜¯æ€»çš„æ’­æ”¾ä¿¡æ¯ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å®Œæˆè¿™ä¸€é€»è¾‘</p>
<p>å½“æ’­æ”¾å™¨è¯·æ±‚ <code>m3u8</code> æ—¶ï¼Œæˆ‘ä»¬<strong>é¡ºæ‰‹æŠ•é€’</strong>ä¸€æ¡â€œæ’­æ”¾äº‹ä»¶â€åˆ° Redis é˜Ÿåˆ—ï¼ˆä¸é˜»å¡è§†é¢‘è¿”å›ï¼‰ï¼›ç”±åå°çº¿ç¨‹å¼‚æ­¥å¤„ç†ï¼Œå‡å°‘å¯¹æ’­æ”¾å»¶è¿Ÿçš„å½±å“ã€‚</p>
<p>åˆ›å»ºVideoPlayInfoDto</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">dto</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.<span class="property">fasterxml</span>.<span class="property">jackson</span>.<span class="property">annotation</span>.<span class="property">JsonIgnoreProperties</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">Serializable</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@JsonIgnoreProperties</span>(ignoreUnknown = <span class="literal">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VideoPlayInfoDto</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> videoId;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> userId;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> fileIndex;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getVideoId</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> videoId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setVideoId</span>(<span class="params"><span class="title class_">String</span> videoId</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">videoId</span> = videoId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getUserId</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setUserId</span>(<span class="params"><span class="title class_">String</span> userId</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userId</span> = userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getFileIndex</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> fileIndex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setFileIndex</span>(<span class="params"><span class="title class_">Integer</span> fileIndex</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">fileIndex</span> = fileIndex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨FileControllerè¡¥å…¨ä¹‹å‰videoResourceè¿™ä¸ªæ–¹æ³•çš„TODO</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è·å–è§†é¢‘èµ„æº(m3u8)å¹¶åŸ‹ç‚¹æ’­æ”¾äº‹ä»¶</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/videoResource/&#123;fileId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">videoResource</span><span class="params">(HttpServletResponse response, <span class="meta">@PathVariable</span> <span class="meta">@NotEmpty</span> String fileId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1) æŸ¥åˆ†Pæ–‡ä»¶ä¿¡æ¯ï¼ˆåŒ…å« videoId / fileIndex / filePathï¼‰</span></span><br><span class="line">    <span class="type">VideoInfoFile</span> <span class="variable">videoInfoFile</span> <span class="operator">=</span> videoInfoFileService.getVideoInfoFileByFileId(fileId);</span><br><span class="line">    <span class="keyword">if</span> (videoInfoFile == <span class="literal">null</span>) &#123;                       <span class="comment">// å¥å£®æ€§ï¼šé¿å… NPE</span></span><br><span class="line">        response.setStatus(HttpServletResponse.SC_NOT_FOUND);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) ç›´æ¥æŠŠ m3u8 è¿”å›ç»™å‰ç«¯ï¼ˆä¸é˜»å¡åŸ‹ç‚¹ï¼‰</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> videoInfoFile.getFilePath();</span><br><span class="line">    readFile(response, filePath + <span class="string">&quot;/&quot;</span> + Constants.M3U8_NAME);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) ç»„ç»‡â€œæ’­æ”¾äº‹ä»¶â€æŠ•é€’åˆ° Redis é˜Ÿåˆ—ï¼ˆå¼‚æ­¥å†å¤„ç†ï¼‰</span></span><br><span class="line">    <span class="type">VideoPlayInfoDto</span> <span class="variable">dto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoPlayInfoDto</span>();</span><br><span class="line">    dto.setVideoId(videoInfoFile.getVideoId());        <span class="comment">// è§†é¢‘ID</span></span><br><span class="line">    dto.setFileIndex(videoInfoFile.getFileIndex());    <span class="comment">// ç¬¬å‡ Pï¼ˆå¯ç”¨äºç»†ç²’åº¦ç»Ÿè®¡ï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯é€‰ï¼šä» cookie è§£æå½“å‰ç™»å½•ç”¨æˆ·ï¼Œç”¨äºå›å¡«â€œè§‚çœ‹å†å²/ä¸ªæ€§åŒ–æ¨èâ€</span></span><br><span class="line">    <span class="type">TokenUserInfoDto</span> <span class="variable">tokenUserInfoDto</span> <span class="operator">=</span> getTokenInfoFromCookie();</span><br><span class="line">    <span class="keyword">if</span> (tokenUserInfoDto != <span class="literal">null</span>) &#123;</span><br><span class="line">        dto.setUserId(tokenUserInfoDto.getUserId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) æ¨å…¥é˜Ÿåˆ—ï¼ˆLPUSHï¼‰ï¼Œä¸è®¾ç½®è¿‡æœŸ</span></span><br><span class="line">    redisComponent.addVideoPlay(dto);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨RedisComponentä¸­åŠ å…¥addVideoPlayæ–¹æ³•</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** æ’­æ”¾äº‹ä»¶å…¥é˜Ÿï¼šZSET éå¸¸é€‚åˆæ¦œå•ï¼›è¿™é‡Œæ’­æ”¾äº‹ä»¶ç”¨ List é˜Ÿåˆ—æ›´åˆé€‚ */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addVideoPlay</span>(<span class="params">VideoPlayInfoDto dto</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// key: queue:video:play:   value: dto(JSON)   listè¯­ä¹‰ï¼šLPUSH/RPOP</span></span><br><span class="line">    redisUtils.lpush(Constants.REDIS_KEY_QUEUE_VIDEO_PLAY, dto, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢ <code>incrementex</code> ä¼šåœ¨ç¬¬ä¸€æ¬¡å‡ºç°æ—¶è®¾å®š TTLï¼›æ¬¡æ—¥è‡ªç„¶è¿‡æœŸï¼Œä¾¿äºåšâ€œå½“æ—¥/æ˜¨æ—¥â€æ¦œå•æˆ–å›¾è¡¨ã€‚</p>
<p>å…¶ä¸­REDIS_KEY_QUEUE_VIDEO_PLAY</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è§†é¢‘æ’­æ”¾é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">static</span> <span class="keyword">final</span> <span class="type">String</span> REDIS_KEY_QUEUE_VIDEO_PLAY = REDIS_KEY_PREFIX + <span class="string">&quot;queue:video:play:&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>åœ¨å®¢æˆ·ç«¯çš„ABaseControlleråŠ å…¥</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * ä»Cookieä¸­è·å–Tokenä¿¡æ¯å¹¶è¿”å›TokenUserInfoDtoå¯¹è±¡</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> TokenUserInfoDtoå¯¹è±¡ï¼Œå¦‚æœæœªæ‰¾åˆ°Tokenåˆ™è¿”å›null</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="title class_">TokenUserInfoDto</span> <span class="title function_">getTokenInfoFromCookie</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// ä»RequestContextHolderä¸­è·å–HttpServletRequestå¯¹è±¡</span></span><br><span class="line">      <span class="title class_">HttpServletRequest</span> request = ((<span class="title class_">ServletRequestAttributes</span>) <span class="title class_">RequestContextHolder</span>.<span class="title function_">getRequestAttributes</span>()).<span class="title function_">getRequest</span>();</span><br><span class="line">      <span class="comment">// ä»Cookieä¸­è·å–Token</span></span><br><span class="line">      <span class="title class_">String</span> token = <span class="title function_">getTokenFromCookie</span>(request);</span><br><span class="line">      <span class="keyword">if</span> (token == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// å¦‚æœæœªæ‰¾åˆ°Tokenï¼Œåˆ™è¿”å›null</span></span><br><span class="line">          <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ä»Redisä¸­è·å–Tokenå¯¹åº”çš„TokenUserInfoDtoå¯¹è±¡</span></span><br><span class="line">      <span class="keyword">return</span> redisComponent.<span class="title function_">getTokenInfo</span>(token);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * ä»HTTPè¯·æ±‚ä¸­è·å–Token</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> request HTTPè¯·æ±‚å¯¹è±¡</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> å¦‚æœè¯·æ±‚ä¸­åŒ…å«åä¸º&#123;<span class="doctag">@link</span> Constants#TOKEN_WEB&#125;çš„Cookieï¼Œåˆ™è¿”å›å…¶å€¼ï¼›å¦åˆ™è¿”å›null</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title class_">String</span> <span class="title function_">getTokenFromCookie</span>(<span class="params"><span class="title class_">HttpServletRequest</span> request</span>) &#123;</span><br><span class="line">      <span class="comment">// ä»HTTPè¯·æ±‚ä¸­è·å–æ‰€æœ‰çš„Cookie</span></span><br><span class="line">      <span class="title class_">Cookie</span>[] cookies = request.<span class="title function_">getCookies</span>();</span><br><span class="line">      <span class="comment">// å¦‚æœæ²¡æœ‰Cookieï¼Œåˆ™è¿”å›null</span></span><br><span class="line">      <span class="keyword">if</span> (cookies == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// éå†æ‰€æœ‰çš„Cookie</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="title class_">Cookie</span> cookie : cookies) &#123;</span><br><span class="line">          <span class="comment">// å¦‚æœCookieçš„åç§°ä¸Constants.TOKEN_WEBç›¸ç­‰ï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰</span></span><br><span class="line">          <span class="keyword">if</span> (cookie.<span class="title function_">getName</span>().<span class="title function_">equalsIgnoreCase</span>(<span class="title class_">Constants</span>.<span class="property">TOKEN_WEB</span>)) &#123;</span><br><span class="line">              <span class="comment">// è¿”å›è¯¥Cookieçš„å€¼</span></span><br><span class="line">              <span class="keyword">return</span> cookie.<span class="title function_">getValue</span>();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å¦‚æœæ²¡æœ‰æ‰¾åˆ°åä¸ºConstants.TOKEN_WEBçš„Cookieï¼Œåˆ™è¿”å›null</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ExecuteQueueTaskæ·»åŠ å¯¹è§†é¢‘æ’­æ”¾çš„å¤„ç†</p>
<p>åå°æ¶ˆè´¹é˜Ÿåˆ—ï¼šåŠ  DB æ’­æ”¾é‡ã€è®°å½“æ—¥æ’­æ”¾ã€åŒæ­¥ ES</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"> @PostConstruct</span><br><span class="line">public <span class="literal">void</span> consumeVideoPlayQueue() &#123;</span><br><span class="line">    executorService.execute<span class="function"><span class="params">(() -&gt; &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">try</span> &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="regexp">// 1) ä»é˜Ÿåˆ—æœ«å°¾å–å‡ºä¸€ä¸ªæ’­æ”¾äº‹ä»¶ï¼ˆæ— é˜»å¡ï¼Œç©ºåˆ™ sleepï¼‰</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">                VideoPlayInfoDto dto =</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">                    (VideoPlayInfoDto) redisUtils.rpop(Constants.REDIS_KEY_QUEUE_VIDEO_PLAY);</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function"></span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">                if (dto == null) &#123;</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">                    Thread.sleep(1500);   //</span> ä½è´Ÿè½½ä¸‹ä¼‘çœ ï¼Œé¿å…ç©ºè½¬</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">continue</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">                &#125;</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="regexp">// 2) æ•°æ®åº“é‡ŒæŠŠè§†é¢‘æ€»æ’­æ”¾é‡ +1ï¼ˆåŒæ—¶è®°å¾—æ›´æ–° last_play_time = now()ï¼‰</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">                videoInfoService.addReadCount(dto.getVideoId());</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function"></span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">                //</span> <span class="number">3</span>)</span> å¯é€‰ï¼šè®°å½•è§‚çœ‹å†å²ï¼ˆé¢å‘â€œç»§ç»­çœ‹/ä¸ªæ€§æ¨èâ€ï¼Œè¿™é‡Œé¢„ç•™ <span class="title">TODO</span>ï¼‰</span></span><br><span class="line"><span class="function">                <span class="title">if</span> <span class="params">(!StringTools.isEmpty(dto.getUserId()))</span> &#123;</span></span><br><span class="line"><span class="function">                    // <span class="title">TODO</span> è®°å½•å†å²</span></span><br><span class="line"><span class="function">                &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">                // 4) æŒ‰å¤©ç´¯è®¡æ’­æ”¾é‡ï¼ˆåšçœ‹æ¿ï¼‰</span></span><br><span class="line"><span class="function">                <span class="title">redisComponent</span>.<span class="title">recordVideoPlayCount</span><span class="params">(dto.getVideoId())</span>;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">                // 5) <span class="title">ES</span> ä¸­çš„ <span class="title">playCount</span> åŸå­è‡ªå¢ï¼ˆç”¨äºæœç´¢æ’åºï¼‰</span></span><br><span class="line"><span class="function">                <span class="title">esSearchComponent</span>.<span class="title">updateDocCount</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">                    dto.getVideoId(),</span></span></span><br><span class="line"><span class="params"><span class="function">                    SearchOrderTypeEnum.VIDEO_PLAY.getField(),</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="number">1</span></span></span></span><br><span class="line"><span class="params"><span class="function">                )</span>;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">            &#125; <span class="title">catch</span> <span class="params">(Exception e)</span> &#123;</span></span><br><span class="line"><span class="function">                <span class="title">log</span>.<span class="title">error</span><span class="params">(<span class="string">&quot;è·å–è§†é¢‘æ’­æ”¾æ–‡ä»¶é˜Ÿåˆ—ä¿¡æ¯å¤±è´¥&quot;</span>, e)</span>;</span></span><br><span class="line"><span class="function">            &#125;</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">    &#125;);</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<p>1.åœ¨VideoInfoServiceæ·»åŠ addReadCountæ–¹æ³•</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * å¢åŠ æ’­æ”¾é‡</span></span><br><span class="line"><span class="comment">	 * @param videoId</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">addReadCount</span><span class="params">(<span class="type">String</span> videoId)</span></span>;</span><br></pre></td></tr></table></figure>
<p>VideoInfoServiceImplä¸­è°ƒç”¨Mapperé‡Œçš„updateCountInfoï¼ˆæˆ‘ä»¬ä¹‹å‰å·²ç»å®ç°äº†è¿™ä¸ªæ–¹æ³•ï¼‰</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">addReadCount</span>(<span class="params"><span class="title class_">String</span> videoId</span>) &#123;</span><br><span class="line">    <span class="comment">// ç­‰ä»·ï¼šupdate video_info set play_count = play_count + 1, last_play_time = now() where video_id = ?</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">videoInfoMapper</span>.<span class="title function_">updateCountInfo</span>(</span><br><span class="line">        videoId,</span><br><span class="line">        <span class="title class_">UserActionTypeEnum</span>.<span class="property">VIDEO_PLAY</span>.<span class="title function_">getField</span>(), <span class="comment">// &quot;play_count&quot;</span></span><br><span class="line">        <span class="number">1</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è¦ç‚¹</strong>ï¼šæ•°æ®åº“é‡Œé™¤äº† <code>play_count += 1</code>ï¼ŒåŠ¡å¿…åŒæ­¥åˆ·æ–° <code>last_play_time = now()</code>ï¼Œè¿™æ ·â€œ24h çƒ­é—¨â€æ‰èƒ½å‡†ç¡®å‘½ä¸­æœ€è¿‘è§‚çœ‹çš„è§†é¢‘ã€‚ä½ ç›®å‰å±•ç¤ºçš„ XML æ¡ä»¶ä¾èµ– <code>v.last_play_time</code>ã€‚</p>
<p>2.RedisCompoentä¸­å®šä¹‰recordVideoPlayCountæ–¹æ³•</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** æŒ‰â€œå¤©â€ç»´åº¦ç´¯è®¡æ’­æ”¾ï¼Œç”¨äºæ•°æ®çœ‹æ¿/è¶‹åŠ¿ */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="literal">void</span> recordVideoPlayCount(<span class="built_in">String</span> videoId) &#123;</span><br><span class="line">       <span class="built_in">String</span> <span class="built_in">date</span> = DateUtil.format(<span class="literal">new</span> <span class="built_in">Date</span>(), DateTimePatternEnum.YYYY_MM_DD.getPattern());</span><br><span class="line">       <span class="comment">// è‡ªå¢å¹¶è®¾ç½®è¿‡æœŸï¼ˆä¿ç•™2å¤©åšç®€å•çª—å£ï¼‰ï¼škey=video:play:count:YYYY-MM-DD:videoId</span></span><br><span class="line">       redisUtils.incrementex(</span><br><span class="line">               Constants.REDIS_KEY_VIDEO_PLAY_COUNT + <span class="built_in">date</span> + <span class="string">&quot;:&quot;</span> + videoId,</span><br><span class="line">               Constants.REDIS_KEY_EXPIRES_DAY * <span class="number">2</span>L</span><br><span class="line">       );</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1099.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1100.png" alt="img"></p>
<p>æµ‹è¯•ï¼š</p>
<p>è§†é¢‘è¯¦æƒ…é¡µå·²ç»å¯ä»¥æ›´æ–°è§†é¢‘æ’­æ”¾é‡äº†</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1078-1024x426.png" alt="img"></p>
<p>è¿™ä¸ªæ—¶å€™å°±å¯ä»¥æŸ¥çœ‹24å°æ—¶çƒ­é—¨æ˜¾ç¤ºäº†ï¼ˆå› ä¸º24å°æ—¶çƒ­é—¨å°±åŸºäºæ’­æ”¾é‡æ’åºçš„ï¼‰</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1079-1024x371.png" alt="img"></p>
<h2 id="18-AOPç™»å½•æ•ˆéªŒ">18.AOPç™»å½•æ•ˆéªŒ</h2>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1101.png" alt="img"></p>
<p>1.åœ¨å®¢æˆ·ç«¯ä¸‹å»ºåŒ…annotationé‡Œé¢åˆ›å»ºGlobalInterceptorç±»</p>
<p>1ï¼‰æ³¨è§£ï¼š<code>GlobalInterceptor</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.web.annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span> <span class="comment">// æ—¢å¯æ ‡åœ¨â€œæ–¹æ³•â€ä¹Ÿå¯æ ‡åœ¨â€œç±»â€ä¸Š</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span>            <span class="comment">// è¿è¡ŒæœŸå¯é€šè¿‡åå°„è¯»å–</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> GlobalInterceptor &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ˜¯å¦æ ¡éªŒç™»å½•ï¼š</span></span><br><span class="line"><span class="comment">     *  - trueï¼šè¿›å…¥åˆ‡é¢çš„ç™»å½•æ£€æŸ¥</span></span><br><span class="line"><span class="comment">     *  - falseï¼šåªåšå ä½ï¼ˆç›®å‰åˆ‡é¢é‡Œä»…å¤„ç†ç™»å½•æ ¡éªŒï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">checkLogin</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»™éœ€è¦çš„ç™»å½•çš„æ–¹æ³•ä¸ŠåŠ ä¸Š@GlobalInterceptor(checkLogin = true)å³å¯ï¼Œæ— éœ€ç™»å½•çš„æ–¹æ³•åŠ å…¥@GlobalInterceptorå³å¯</p>
<p>2ï¼‰åˆ‡é¢ï¼š<code>GlobalOperationAspect</code></p>
<p>åœ¨å®¢æˆ·ç«¯å»ºåŒ…aspectï¼Œåœ¨ä¸­å»ºGlobalOperationAspectç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.web.aspect;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.constants.Constants;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.dto.TokenUserInfoDto;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.enums.ResponseCodeEnum;</span><br><span class="line"><span class="keyword">import</span> com.easylive.exception.BusinessException;</span><br><span class="line"><span class="keyword">import</span> com.easylive.redis.RedisUtils;</span><br><span class="line"><span class="keyword">import</span> com.easylive.utils.StringTools;</span><br><span class="line"><span class="keyword">import</span> com.easylive.web.annotation.GlobalInterceptor;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.JoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.reflect.MethodSignature;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component(&quot;operationAspect&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalOperationAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisUtils redisUtils; <span class="comment">// è®¿é—® Redis è¯»å– token å¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‰ç½®é€šçŸ¥ï¼šæ‹¦æˆªâ€œå¸¦æœ‰ @GlobalInterceptor æ³¨è§£çš„æ–¹æ³•â€</span></span><br><span class="line">    <span class="meta">@Before(&quot;@annotation(com.easylive.web.annotation.GlobalInterceptor)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">interceptorDo</span><span class="params">(JoinPoint point)</span> &#123;</span><br><span class="line">        <span class="comment">// å–åˆ°å½“å‰è¢«è°ƒç”¨çš„æ–¹æ³•ç­¾å</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> ((MethodSignature) point.getSignature()).getMethod();</span><br><span class="line">        <span class="comment">// è¯»å–æ–¹æ³•ä¸Šçš„ @GlobalInterceptor æ³¨è§£</span></span><br><span class="line">        <span class="type">GlobalInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> method.getAnnotation(GlobalInterceptor.class);</span><br><span class="line">        <span class="keyword">if</span> (interceptor == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>; <span class="comment">// ç†è®ºä¸Šä¸ä¼šä¸º nullï¼ˆå‘½ä¸­æ¡ä»¶æœ¬å°±è¦æ±‚å¸¦æ³¨è§£ï¼‰</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è‹¥å£°æ˜äº†éœ€è¦ç™»å½•æ ¡éªŒï¼Œåˆ™æ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">if</span> (interceptor.checkLogin()) &#123;</span><br><span class="line">            checkLogin();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å®é™…çš„ç™»å½•æ ¡éªŒé€»è¾‘</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkLogin</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// ä» Spring Web ä¸Šä¸‹æ–‡å–å½“å‰è¯·æ±‚</span></span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span></span><br><span class="line">            ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1) ä»è¯·æ±‚å¤´é‡Œæ‹¿ tokenï¼šçº¦å®šä½¿ç”¨ TOKEN_WEB</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(Constants.TOKEN_WEB);</span><br><span class="line">        <span class="keyword">if</span> (StringTools.isEmpty(token)) &#123;</span><br><span class="line">            <span class="comment">// æ—  tokenï¼šæœªç™»å½• / ç™»å½•è¶…æ—¶</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_901);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2) ç”¨ â€œREDIS_KEY_TOKEN_WEB + tokenâ€ å» Redis å–ç™»å½•ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">        <span class="type">TokenUserInfoDto</span> <span class="variable">tokenUserInfoDto</span> <span class="operator">=</span></span><br><span class="line">            (TokenUserInfoDto) redisUtils.get(Constants.REDIS_KEY_TOKEN_WEB + token);</span><br><span class="line">        <span class="keyword">if</span> (tokenUserInfoDto == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// token å¤±æ•ˆæˆ–ä¸å­˜åœ¨</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_901);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é€šè¿‡åˆ™ç›´æ¥è¿”å›ï¼Œç»§ç»­æ‰§è¡ŒåŸæ–¹æ³•</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1102.png" alt="img"></p>
<h2 id="19-AOPè®°å½•æ¶ˆæ¯">19.AOPè®°å½•æ¶ˆæ¯</h2>
<h3 id="1-å»ºè¡¨-2">1.å»ºè¡¨</h3>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for user_message</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> `user_message`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_message`  (</span><br><span class="line">  `message_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">&#x27;æ¶ˆæ¯IDè‡ªå¢&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ç”¨æˆ·ID&#x27;</span>,</span><br><span class="line">  `video_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ä¸»ä½“ID&#x27;</span>,</span><br><span class="line">  `message_type` tinyint(<span class="number">1</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æ¶ˆæ¯ç±»å‹&#x27;</span>,</span><br><span class="line">  `send_user_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;å‘é€äººID&#x27;</span>,</span><br><span class="line">  `read_type` tinyint(<span class="number">1</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;0:æœªè¯» 1:å·²è¯»&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;åˆ›å»ºæ—¶é—´&#x27;</span>,</span><br><span class="line">  `extend_json` <span class="type">text</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æ‰©å±•ä¿¡æ¯&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (`message_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_user_id`(`user_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_read_type`(`read_type`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_message_type`(`message_type`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE = InnoDB AUTO_INCREMENT = <span class="number">23</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4 <span class="keyword">COLLATE</span> = utf8mb4_general_ci <span class="keyword">COMMENT</span> = <span class="string">&#x27;ç”¨æˆ·æ¶ˆæ¯è¡¨&#x27;</span> ROW_FORMAT = DYNAMIC;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for video_play_history</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> `video_play_history`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `video_play_history`  (</span><br><span class="line">  `user_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ç”¨æˆ·ID&#x27;</span>,</span><br><span class="line">  `video_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;è§†é¢‘ID&#x27;</span>,</span><br><span class="line">  `file_index` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æ–‡ä»¶ç´¢å¼•&#x27;</span>,</span><br><span class="line">  `last_update_time` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æœ€åæ›´æ–°æ—¶é—´&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (`user_id`(<span class="number">4</span>), `video_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_video_id`(`video_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">INDEX</span> `idx_user_id`(`user_id`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE = InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4 <span class="keyword">COLLATE</span> = utf8mb4_general_ci <span class="keyword">COMMENT</span> = <span class="string">&#x27;è§†é¢‘æ’­æ”¾å†å²&#x27;</span> ROW_FORMAT = DYNAMIC;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for statistics_info</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> `statistics_info`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `statistics_info`  (</span><br><span class="line">  `statistics_date` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ç»Ÿè®¡æ—¥æœŸ&#x27;</span>,</span><br><span class="line">  `user_id` <span class="type">varchar</span>(<span class="number">10</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ç”¨æˆ·ID&#x27;</span>,</span><br><span class="line">  `data_type` tinyint(<span class="number">1</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;æ•°æ®ç»Ÿè®¡ç±»å‹&#x27;</span>,</span><br><span class="line">  `statistics_count` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;ç»Ÿè®¡æ•°é‡&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (`statistics_date`, `user_id`, `data_type`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE = InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> = utf8mb4 <span class="keyword">COLLATE</span> = utf8mb4_general_ci <span class="keyword">COMMENT</span> = <span class="string">&#x27;æ•°æ®ç»Ÿè®¡&#x27;</span> ROW_FORMAT = DYNAMIC;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1103.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1104.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1105.png" alt="img"></p>
<p>æ€»ä½“è¯´æ˜ï¼ˆè¿™ä¸‰å¼ è¡¨çš„å…³ç³»ï¼‰</p>
<ul>
<li><code>user_message</code>ï¼šå<strong>ç”¨æˆ·é€šçŸ¥/äº’åŠ¨</strong>å±‚é¢ã€‚</li>
<li><code>video_play_history</code>ï¼šå<strong>ç”¨æˆ·è¡Œä¸ºæ—¥å¿—</strong>ï¼Œä¾§é‡â€œçœ‹äº†ä»€ä¹ˆâ€ã€‚</li>
<li><code>statistics_info</code>ï¼šå<strong>æ±‡æ€»ç»Ÿè®¡</strong>ï¼Œæ˜¯å¯¹å‰ä¸¤ç±»æ•°æ®ä¹ƒè‡³æ›´å¤šåŸ‹ç‚¹æ•°æ®çš„èšåˆã€‚</li>
</ul>
<p>ä¸‰è€…ç»“åˆï¼š</p>
<ul>
<li>ç”¨æˆ·è§‚çœ‹è§†é¢‘ï¼ˆ<code>video_play_history</code>ï¼‰ â†’ ç³»ç»Ÿç»Ÿè®¡æ´»è·ƒåº¦ï¼ˆ<code>statistics_info</code>ï¼‰ã€‚</li>
<li>ç”¨æˆ·äº’åŠ¨è§¦å‘é€šçŸ¥ï¼ˆ<code>user_message</code>ï¼‰ â†’ ç³»ç»Ÿæ¨åŠ¨ç”¨æˆ·å›æµï¼Œå¢å¼ºç²˜æ€§ã€‚</li>
</ul>
<h3 id="2-AOPè®°å½•æ¶ˆæ¯çš„å®ç°">2.AOPè®°å½•æ¶ˆæ¯çš„å®ç°</h3>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1110.png" alt="img"></p>
<p>åœ¨Commonæ¨¡å—é‡Œå»ºåŒ…annotationé‡Œé¢å»ºRecordUserMessageç±»</p>
<p>å£°æ˜æ³¨è§£ï¼š<code>@RecordUserMessage</code></p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Target</span>(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span><br><span class="line"><span class="variable">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line">public <span class="variable">@interface</span> RecordUserMessage &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** è¿™æ¬¡æ“ä½œçš„â€œé»˜è®¤æ¶ˆæ¯ç±»å‹â€ã€‚</span></span><br><span class="line"><span class="comment">     *  å®é™…æ‰§è¡Œæ—¶ï¼Œåˆ‡é¢é‡Œè¿˜ä¼šæ ¹æ®å…·ä½“ actionTypeï¼ˆå¦‚æ”¶è—ï¼‰åšä¸€æ¬¡è¦†ç›–ã€‚*/</span></span><br><span class="line">    <span class="selector-tag">MessageTypeEnum</span> <span class="selector-tag">messageType</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¦ç‚¹ï¼š</p>
<ul>
<li>å¯æ ‡åœ¨<strong>æ–¹æ³•æˆ–ç±»</strong>ï¼Œæœ¬å®ç°é€šè¿‡ <code>@Around(&quot;@annotation(...)&quot;)</code> æ‹¦â€œæ–¹æ³•çº§â€ï¼›</li>
<li>ä¼ ä¸€ä¸ª<strong>é»˜è®¤æ¶ˆæ¯ç±»å‹</strong>ï¼ˆä¾‹å¦‚è¯„è®º/ç³»ç»Ÿï¼‰ï¼Œåç»­åˆ‡é¢å¯æ ¹æ®å…¥å‚å†åšä¸€æ¬¡â€œç»†åˆ†ç±»å‹â€çš„æ˜ å°„ã€‚</li>
</ul>
<p>åœ¨Commonæ¨¡å—é‡Œå»ºåŒ…aspecté‡Œé¢å»ºUserMessageOperationAspectç±»</p>
<p>åˆ‡é¢ï¼š<code>UserMessageOperationAspect</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component(&quot;userMessageOperationAspect&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserMessageOperationAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PARAMETERS_VIDEO_ID</span> <span class="operator">=</span> <span class="string">&quot;videoId&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PARAMETERS_ACTION_TYPE</span> <span class="operator">=</span> <span class="string">&quot;actionType&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PARAMETERS_REPLY_COMMENTID</span> <span class="operator">=</span> <span class="string">&quot;replyCommentId&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PARAMETERS_AUDIT_REJECT_REASON</span> <span class="operator">=</span> <span class="string">&quot;reason&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PARAMETERS_CONTENT</span> <span class="operator">=</span> <span class="string">&quot;content&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span> <span class="keyword">private</span> RedisUtils redisUtils;</span><br><span class="line">    <span class="meta">@Resource</span> <span class="keyword">private</span> UserMessageService userMessageService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** ç¯ç»•å¢å¼ºï¼šä»…æ‹¦æˆªâ€œæ‰“äº† <span class="doctag">@RecordUserMessage</span>â€çš„æ–¹æ³• */</span></span><br><span class="line">    <span class="meta">@Around(&quot;@annotation(com.easylive.annotation.RecordUserMessage)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseVO <span class="title function_">interceptorDo</span><span class="params">(ProceedingJoinPoint point)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1) å…ˆæ‰§è¡Œä¸šåŠ¡æ–¹æ³•ï¼ˆè‹¥æŠ›å¼‚å¸¸åˆ™ä¸è®°æ¶ˆæ¯ï¼‰</span></span><br><span class="line">            <span class="type">ResponseVO</span> <span class="variable">result</span> <span class="operator">=</span> (ResponseVO) point.proceed();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2) è¯»å–æ–¹æ³•ä¸Šçš„æ³¨è§£</span></span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> ((MethodSignature) point.getSignature()).getMethod();</span><br><span class="line">            <span class="type">RecordUserMessage</span> <span class="variable">recordUserMessage</span> <span class="operator">=</span> method.getAnnotation(RecordUserMessage.class);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3) æˆåŠŸè¿”å›åï¼Œé‡‡é›†å…¥å‚å¹¶è½æ¶ˆæ¯</span></span><br><span class="line">            <span class="keyword">if</span> (recordUserMessage != <span class="literal">null</span>) &#123;</span><br><span class="line">                saveUserMessage(recordUserMessage, point.getArgs(), method.getParameters());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BusinessException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;å…¨å±€æ‹¦æˆªå™¨å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> e; <span class="comment">// ä¸šåŠ¡å¼‚å¸¸å¦‚å®æŠ›å‡º</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;å…¨å±€æ‹¦æˆªå™¨å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;å…¨å±€æ‹¦æˆªå™¨å¼‚å¸¸&quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_500);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** è¯»å–æ–¹æ³•å…¥å‚ â†’ å½’ä¸€åŒ–æ¶ˆæ¯ç±»å‹ â†’ å–ç™»å½•äºº â†’ è°ƒç”¨æœåŠ¡å¼‚æ­¥è½åº“ */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">saveUserMessage</span><span class="params">(RecordUserMessage recordUserMessage,</span></span><br><span class="line"><span class="params">                                 Object[] arguments, Parameter[] parameters)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">videoId</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">actionType</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">replyCommentId</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1) é€šè¿‡â€œå‚æ•°åâ€æå–å…³é”®ä¿¡æ¯ï¼ˆéœ€ -parameters æˆ–ç”¨ @RequestParam æŒ‡å®šï¼‰</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; parameters.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (PARAMETERS_VIDEO_ID.equals(parameters[i].getName())) &#123;</span><br><span class="line">                videoId = (String) arguments[i];</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (PARAMETERS_ACTION_TYPE.equals(parameters[i].getName())) &#123;</span><br><span class="line">                actionType = (Integer) arguments[i];</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (PARAMETERS_REPLY_COMMENTID.equals(parameters[i].getName())) &#123;</span><br><span class="line">                replyCommentId = (Integer) arguments[i];</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (PARAMETERS_AUDIT_REJECT_REASON.equals(parameters[i].getName())) &#123;</span><br><span class="line">                content = (String) arguments[i]; <span class="comment">// å®¡æ ¸â€œç†ç”±â€ä¹Ÿè®°åˆ° content</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (PARAMETERS_CONTENT.equals(parameters[i].getName())) &#123;</span><br><span class="line">                content = (String) arguments[i]; <span class="comment">// è¯„è®ºå†…å®¹</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2) åŸºäºæ³¨è§£çš„é»˜è®¤ç±»å‹ï¼Œç»“åˆ actionTypeï¼ˆå¦‚æ”¶è—ï¼‰åšä¸€æ¬¡â€œç»†åˆ†ç±»å‹â€è¦†ç›–</span></span><br><span class="line">        <span class="type">MessageTypeEnum</span> <span class="variable">messageTypeEnum</span> <span class="operator">=</span> recordUserMessage.messageType();</span><br><span class="line">        <span class="keyword">if</span> (UserActionTypeEnum.VIDEO_COLLECT.getType().equals(actionType)) &#123;</span><br><span class="line">            messageTypeEnum = MessageTypeEnum.COLLECTION;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3) å–å½“å‰ç™»å½•äººï¼ˆWeb ç«¯ TOKENï¼‰â€” ç®¡ç†ç«¯å¯èƒ½å–ä¸åˆ°ï¼ˆç³»ç»Ÿæ¶ˆæ¯ï¼‰</span></span><br><span class="line">        <span class="type">TokenUserInfoDto</span> <span class="variable">tokenUserInfoDto</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4) å¼‚æ­¥å…¥åº“ï¼švideoIdã€å‘é€è€…IDï¼ˆå¯ç©º=ç³»ç»Ÿï¼‰ã€ç±»å‹ã€å†…å®¹ã€è¢«å›å¤è¯„è®ºID</span></span><br><span class="line">        userMessageService.saveUserMessage(</span><br><span class="line">                videoId,</span><br><span class="line">                tokenUserInfoDto == <span class="literal">null</span> ? <span class="literal">null</span> : tokenUserInfoDto.getUserId(),</span><br><span class="line">                messageTypeEnum,</span><br><span class="line">                content,</span><br><span class="line">                replyCommentId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** ä»è¯·æ±‚å¤´æ‹¿ TOKEN_WEBï¼Œå†å» Redis æ¢ TokenUserInfoDto */</span></span><br><span class="line">    <span class="keyword">private</span> TokenUserInfoDto <span class="title function_">getTokenUserInfoDto</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span></span><br><span class="line">            ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(Constants.TOKEN_WEB);</span><br><span class="line">        <span class="keyword">return</span> (TokenUserInfoDto) redisUtils.get(Constants.REDIS_KEY_TOKEN_WEB + token);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¦ç‚¹ï¼š</p>
<ul>
<li><strong>åªåœ¨ä¸šåŠ¡æˆåŠŸå</strong>å†™æ¶ˆæ¯ï¼ˆå›´ç»• <code>point.proceed()</code> ä¹‹åï¼‰ï¼›</li>
<li>é€šè¿‡ <strong>å‚æ•°å</strong> æŠ“ <code>videoId / actionType / replyCommentId / content|reason</code>ï¼›</li>
<li><strong>messageType</strong> å…è®¸è¢« <code>actionType</code> ç²¾ç»†åŒ–è¦†ç›–ï¼ˆæ”¶è—ï¼‰ï¼›</li>
<li>å–ä¸åˆ°ç™»å½•äºº â†’ ä½œä¸º<strong>ç³»ç»Ÿæ¶ˆæ¯</strong>ï¼ˆå¦‚å®¡æ ¸ï¼‰ï¼›</li>
<li>è°ƒ Service è¿›å…¥<strong>å¼‚æ­¥</strong>è½åº“ã€‚</li>
</ul>
<blockquote>
<p>âš ï¸ <strong>å‚æ•°åè·å–çš„å‘</strong>ï¼š<code>parameters[i].getName()</code> æƒ³æ‹¿åˆ°å½¢å‚åï¼Œéœ€åœ¨ç¼–è¯‘æ—¶å¼€å¯ <code>-parameters</code>ï¼Œå¦åˆ™å¯èƒ½æ˜¯ <code>arg0/arg1</code>ã€‚å¯é€‰æ›¿ä»£ï¼šåœ¨ Controller ä¸Šç”¨ <code>@RequestParam(&quot;videoId&quot;)</code> ç­‰æ˜ç¡®å®šåï¼Œæˆ–ç›´æ¥åœ¨åˆ‡é¢è¯»å– <code>HttpServletRequest</code> çš„å‚æ•° Mapã€‚</p>
</blockquote>
<p>UserMessageServiceä¸­</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¿å­˜ç”¨æˆ·æ¶ˆæ¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">saveUserMessage</span><span class="params">(<span class="type">String</span> videoId, <span class="type">String</span> s, MessageTypeEnum messageTypeEnum, <span class="type">String</span> content, Integer replyCommentId)</span></span>;</span><br></pre></td></tr></table></figure>
<p>UserMessageServiceImplä¸­</p>
<p>æœåŠ¡å±‚ï¼š<code>UserMessageServiceImpl.saveUserMessage</code>ï¼ˆå¼‚æ­¥ &amp; ä¸šåŠ¡è§„çº¦ï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Async</span> <span class="comment">// å¼‚æ­¥è½åº“ï¼Œéœ€å¯ç”¨ @EnableAsyncï¼Œå¹¶é…ç½®çº¿ç¨‹æ± </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveUserMessage</span><span class="params">(String videoId, String sendUserId,</span></span><br><span class="line"><span class="params">                            MessageTypeEnum messageTypeEnum,</span></span><br><span class="line"><span class="params">                            String content, Integer replyCommentId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1) æŸ¥â€œè§†é¢‘å½’å±äººâ€ï¼ˆç»™è°å‘ï¼‰â€”â€”è¿™é‡ŒæŸ¥çš„æ˜¯ç¨¿ä»¶è¡¨/çº¿ä¸Šè¡¨ï¼ŒæŒ‰ä½ å®é™… Mapper ä¸ºå‡†</span></span><br><span class="line">    <span class="type">VideoInfo</span> <span class="variable">videoInfo</span> <span class="operator">=</span> <span class="built_in">this</span>.videoInfoPostMapper.selectByVideoId(videoId);</span><br><span class="line">    <span class="keyword">if</span> (videoInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>; <span class="comment">// è§†é¢‘ä¸å­˜åœ¨ï¼Œç›´æ¥å¿½ç•¥</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) æ‰©å±•ä¿¡æ¯ï¼šè¯„è®ºå†…å®¹/å®¡æ ¸ç†ç”±/è¢«å›å¤å†…å®¹ç­‰</span></span><br><span class="line">    <span class="type">UserMessageExtendDto</span> <span class="variable">extendDto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserMessageExtendDto</span>();</span><br><span class="line">    extendDto.setMessageContent(content);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é»˜è®¤æ¥æ”¶è€…ï¼šè§†é¢‘ä½œè€…</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> videoInfo.getUserId();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) ç‚¹èµ/æ”¶è—â€œå»é‡â€ï¼šåŒä¸€ä¸ªå‘é€è€…é’ˆå¯¹åŒä¸€è§†é¢‘çš„ç›¸åŒæ¶ˆæ¯ç±»å‹åªè®°ä¸€æ¬¡</span></span><br><span class="line">    <span class="keyword">if</span> (ArrayUtils.contains(<span class="keyword">new</span> <span class="title class_">Integer</span>[]&#123;</span><br><span class="line">            MessageTypeEnum.LIKE.getType(), MessageTypeEnum.COLLECTION.getType()</span><br><span class="line">        &#125;, messageTypeEnum.getType())) &#123;</span><br><span class="line">        <span class="type">UserMessageQuery</span> <span class="variable">q</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserMessageQuery</span>();</span><br><span class="line">        q.setSendUserId(sendUserId);</span><br><span class="line">        q.setVideoId(videoId);</span><br><span class="line">        q.setMessageType(messageTypeEnum.getType());</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> userMessageMapper.selectCount(q);</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) <span class="keyword">return</span>; <span class="comment">// å·²å­˜åœ¨åˆ™ä¸å†è®°å½•</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) ç»„è£…æ¶ˆæ¯å®ä½“ï¼ˆå…ˆä¸å†™ extendJson çš„â€œè¢«å›å¤å†…å®¹â€ï¼‰</span></span><br><span class="line">    <span class="type">UserMessage</span> <span class="variable">um</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserMessage</span>();</span><br><span class="line">    um.setUserId(userId); <span class="comment">// æ¥æ”¶è€…</span></span><br><span class="line">    um.setVideoId(videoId);</span><br><span class="line">    um.setReadType(MessageReadTypeEnum.NO_READ.getType()); <span class="comment">// æœªè¯»</span></span><br><span class="line">    um.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    um.setMessageType(messageTypeEnum.getType());</span><br><span class="line">    um.setSendUserId(sendUserId); <span class="comment">// å‘é€è€…ï¼ˆå¯èƒ½ä¸º null=ç³»ç»Ÿï¼‰</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5) è¯„è®ºâ€œå›å¤â€åœºæ™¯ï¼šæŠŠæ¥æ”¶è€…æ”¹æˆâ€œè¢«å›å¤çš„äººâ€ï¼Œå¹¶è®°å½•å¯¹æ–¹åŸè¯„è®ºå†…å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (replyCommentId != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">VideoComment</span> <span class="variable">c</span> <span class="operator">=</span> videoCommentMapper.selectByCommentId(replyCommentId);</span><br><span class="line">        <span class="keyword">if</span> (c != <span class="literal">null</span>) &#123;</span><br><span class="line">            userId = c.getUserId(); <span class="comment">// æ¥æ”¶è€… â†’ è¢«å›å¤çš„äºº</span></span><br><span class="line">            extendDto.setMessageContentReply(c.getContent()); <span class="comment">// è¡¥å……â€œå¯¹æ–¹åŸè¯„è®ºâ€</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6) è‡ªå·±ç»™è‡ªå·±å‘çš„æ¶ˆæ¯ä¸è®°å½•ï¼ˆæ¯”å¦‚è‡ªå·±è¯„è®º/èµè‡ªå·±çš„å†…å®¹ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (userId.equals(sendUserId)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 7) ç³»ç»Ÿæ¶ˆæ¯ï¼ˆå®¡æ ¸ï¼‰ç‰¹æ®Šå¤„ç†ï¼šæŠŠå®¡æ ¸çŠ¶æ€å†™åˆ°æ‰©å±•é‡Œ</span></span><br><span class="line">    <span class="keyword">if</span> (MessageTypeEnum.SYS == messageTypeEnum) &#123;</span><br><span class="line">        <span class="type">VideoInfoPost</span> <span class="variable">vip</span> <span class="operator">=</span> videoInfoPostMapper.selectByVideoId(videoId);</span><br><span class="line">        extendDto.setAuditStatus(vip.getStatus());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 8) å†™æ‰©å±• JSON å¹¶çœŸæ­£å…¥åº“</span></span><br><span class="line">    um.setUserId(userId); <span class="comment">// æ³¨æ„ï¼šå›å¤æ—¶å¯èƒ½å·²è¢«æ”¹æˆâ€œè¢«å›å¤çš„äººâ€</span></span><br><span class="line">    um.setExtendJson(JsonUtils.convertObj2Json(extendDto));</span><br><span class="line">    <span class="built_in">this</span>.userMessageMapper.insert(um);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¦ç‚¹ï¼š</p>
<ul>
<li><strong>@Async</strong> å¼‚æ­¥ï¼Œä¸é˜»å¡ä¸»æµç¨‹ï¼›</li>
<li><strong>ç‚¹èµ/æ”¶è—å»é‡</strong>ï¼ˆåŒäººã€åŒè§†é¢‘ã€åŒç±»å‹ä¸é‡å¤è®°ï¼‰ï¼›</li>
<li><strong>å›å¤è¯„è®º</strong>ï¼šæ¥æ”¶è€…æ”¹ä¸ºâ€œè¢«å›å¤çš„äººâ€ï¼Œå¹¶æŠŠå¯¹æ–¹åŸè¯„è®ºæ”¾è¿› <code>extend_json</code>ï¼›</li>
<li><strong>ç³»ç»Ÿæ¶ˆæ¯</strong>ï¼šæºå¸¦æœ€æ–°å®¡æ ¸çŠ¶æ€ï¼›</li>
<li><strong>è‡ªå·±ç»™è‡ªå·±</strong>ä¸è®°ï¼Œé¿å…å™ªå£°ã€‚</li>
</ul>
<blockquote>
<p>å»ºè®®åœ¨ <code>user_message</code> ä¸Šå¢åŠ <strong>å¹‚ç­‰ç´¢å¼•</strong>ï¼ˆå¦‚ <code>(send_user_id, video_id, message_type)</code> å”¯ä¸€ç´¢å¼•ï¼Œå…è®¸ <code>send_user_id</code> ä¸ºç©ºæ—¶ç”¨è”åˆå‡½æ•°æˆ–å…ˆè½¬ä¸ºå ä½å€¼ï¼‰ï¼Œä»<strong>æ•°æ®åº“å±‚</strong>å…œåº•å»é‡ã€‚</p>
</blockquote>
<p>å…¶ä¸­UserMessageExtendDto</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">dto</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserMessageExtendDto</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> messageContent;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> messageContentReply;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å®¡æ ¸çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> auditStatus;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getMessageContent</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> messageContent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setMessageContent</span>(<span class="params"><span class="title class_">String</span> messageContent</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">messageContent</span> = messageContent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getMessageContentReply</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> messageContentReply;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setMessageContentReply</span>(<span class="params"><span class="title class_">String</span> messageContentReply</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">messageContentReply</span> = messageContentReply;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getAuditStatus</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> auditStatus;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setAuditStatus</span>(<span class="params"><span class="title class_">Integer</span> auditStatus</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">auditStatus</span> = auditStatus;</span><br></pre></td></tr></table></figure>
<p>MessageReadTypeEnumä¸º</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">enums</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">MessageReadTypeEnum</span> &#123;</span><br><span class="line">    <span class="title function_">NO_READ</span>(<span class="number">0</span>, <span class="string">&quot;æœªè¯»&quot;</span>),</span><br><span class="line">    <span class="title function_">READ</span>(<span class="number">1</span>, <span class="string">&quot;å·²è¯»&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> <span class="keyword">type</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> desc;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">MessageReadTypeEnum</span>(<span class="title class_">Integer</span> status, <span class="title class_">String</span> desc) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">type</span> = status;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">desc</span> = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getType</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">type</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getDesc</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="title class_">MessageReadTypeEnum</span> <span class="title function_">getByStatus</span>(<span class="params"><span class="title class_">Integer</span> status</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="title class_">MessageReadTypeEnum</span> statusEnum : <span class="title class_">MessageReadTypeEnum</span>.<span class="title function_">values</span>()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (statusEnum.<span class="title function_">getType</span>().<span class="title function_">equals</span>(status)) &#123;</span><br><span class="line">                <span class="keyword">return</span> statusEnum;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1111.png" alt="img"></p>
<p>æ³¨æ„è¦åœ¨å¯¹åº”å‘æ”¾ä¸ŠåŠ ä¸Šæ³¨è§£</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨æˆ·å¯¹è§†é¢‘æ‰§è¡Œæ“ä½œ</span></span><br><span class="line"><span class="comment">     * è¯¥æ¥å£ç”¨äºå¤„ç†ç”¨æˆ·å¯¹è§†é¢‘çš„å„ç§æ“ä½œï¼Œå¦‚ç‚¹èµã€è¯„è®ºç­‰ï¼Œå¹¶è®°å½•æ“ä½œè¡Œä¸ºã€‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> videoId è§†é¢‘IDï¼Œä¸èƒ½ä¸ºç©º</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> actionType æ“ä½œç±»å‹ï¼Œä¸èƒ½ä¸ºç©º</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> actionCount æ“ä½œæ¬¡æ•°ï¼Œå–å€¼èŒƒå›´ä¸º1åˆ°2ï¼Œä¸èƒ½ä¸ºç©º</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> commentId è¯„è®ºIDï¼Œå¯ä¸ºç©ºï¼Œé»˜è®¤ä¸º0</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è¿”å›æ“ä½œæˆåŠŸçš„å“åº”å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">&quot;doAction&quot;</span>)</span><br><span class="line">    <span class="meta">@GlobalInterceptor</span>(checkLogin = <span class="literal">true</span>)</span><br><span class="line">    <span class="meta">@RecordUserMessage</span>(messageType = <span class="title class_">MessageTypeEnum</span>.<span class="property">LIKE</span>)<span class="comment">// é»˜è®¤ LIKEï¼Œæ”¶è—ä¼šåœ¨åˆ‡é¢é‡Œè¦†ç›–ä¸º COLLECTION</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">doAction</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="title class_">String</span> videoId,</span></span><br><span class="line"><span class="params">                               <span class="meta">@NotEmpty</span> <span class="title class_">Integer</span> actionType,</span></span><br><span class="line"><span class="params">                               <span class="meta">@Max</span>(<span class="number">2</span>) <span class="meta">@Min</span>(<span class="number">1</span>) <span class="title class_">Integer</span> actionCount,</span></span><br><span class="line"><span class="params">                               <span class="title class_">Integer</span> commentId</span>) &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»º UserAction å¯¹è±¡ï¼Œå°è£…ç”¨æˆ·è¡Œä¸ºä¿¡æ¯</span></span><br><span class="line">        <span class="title class_">UserAction</span> userAction = <span class="keyword">new</span> <span class="title class_">UserAction</span>();</span><br><span class="line">        userAction.<span class="title function_">setUserId</span>(<span class="title function_">getTokenUserInfoDto</span>().<span class="title function_">getUserId</span>()); <span class="comment">// è·å–å½“å‰ç™»å½•ç”¨æˆ·ID</span></span><br><span class="line">        userAction.<span class="title function_">setVideoId</span>(videoId);<span class="comment">// è§†é¢‘ID</span></span><br><span class="line">        userAction.<span class="title function_">setActionType</span>(actionType);<span class="comment">// ç”¨æˆ·è¡Œä¸ºç±»å‹ï¼ˆç‚¹èµã€æ”¶è—ç­‰ï¼‰</span></span><br><span class="line">        actionCount = actionCount == <span class="literal">null</span> ? <span class="title class_">Constants</span>.<span class="property">ONE</span> : actionCount;<span class="comment">// é»˜è®¤æ“ä½œæ•°ä¸º1</span></span><br><span class="line">        userAction.<span class="title function_">setActionCount</span>(actionCount);<span class="comment">// è®¾ç½®æ“ä½œæ•°</span></span><br><span class="line">        commentId = commentId == <span class="literal">null</span> ? <span class="number">0</span> : commentId;<span class="comment">// è¯„è®ºIDï¼Œé»˜è®¤ä¸º0</span></span><br><span class="line">        userAction.<span class="title function_">setCommentId</span>(commentId); <span class="comment">// è®¾ç½®è¯„è®ºID</span></span><br><span class="line">        <span class="comment">// ä¿å­˜ç”¨æˆ·è¡Œä¸º</span></span><br><span class="line">        userActionService.<span class="title function_">saveAction</span>(userAction);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(<span class="literal">null</span>); <span class="comment">// è¿”å›æ“ä½œæˆåŠŸå“åº”</span></span><br><span class="line">    &#125;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å®¡æ ¸è§†é¢‘æ¥å£</span></span><br><span class="line"><span class="comment">     * è¯¥æ¥å£ç”¨äºå®¡æ ¸è§†é¢‘ï¼Œé€šè¿‡ä¼ å…¥è§†é¢‘IDã€å®¡æ ¸çŠ¶æ€å’Œå®¡æ ¸ç†ç”±æ¥æ‰§è¡Œå®¡æ ¸æ“ä½œï¼Œå¹¶è¿”å›æ“ä½œç»“æœã€‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> videoId  è§†é¢‘IDï¼Œä¸èƒ½ä¸ºç©º</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status   å®¡æ ¸çŠ¶æ€ï¼Œä¸èƒ½ä¸ºç©ºï¼Œé€šå¸¸ä½¿ç”¨é¢„å®šä¹‰çš„æ•´æ•°å€¼è¡¨ç¤ºä¸åŒçš„å®¡æ ¸çŠ¶æ€</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reason   å®¡æ ¸ç†ç”±ï¼Œå¯ä»¥ä¸ºç©º</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è¿”å›æ“ä½œç»“æœçš„ResponseVOå¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">&quot;/auditVideo&quot;</span>)</span><br><span class="line">    <span class="meta">@RecordUserMessage</span>(messageType = <span class="title class_">MessageTypeEnum</span>.<span class="property">SYS</span>)<span class="comment">// ç³»ç»Ÿæ¶ˆæ¯ï¼šå®¡æ ¸é€šè¿‡/é©³å›</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">auditVideo</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="title class_">String</span> videoId, <span class="meta">@NotNull</span> <span class="title class_">Integer</span> status, <span class="title class_">String</span> reason</span>) &#123;</span><br><span class="line">        videoInfoPostService.<span class="title function_">auditVideo</span>(videoId, status, reason);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å‘å¸ƒè§†é¢‘è¯„è®º</span></span><br><span class="line"><span class="comment">     * ç”¨æˆ·é€šè¿‡è¯¥æ¥å£å¯ä»¥å‘å¸ƒå¯¹è§†é¢‘çš„è¯„è®ºï¼ŒåŒ…æ‹¬å›å¤è¯„è®ºçš„æƒ…å†µã€‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> videoId       è§†é¢‘IDï¼Œä¸èƒ½ä¸ºç©º</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> replyCommentId å›å¤çš„è¯„è®ºIDï¼Œå¯ä»¥ä¸ºç©ºï¼Œè¡¨ç¤ºä¸æ˜¯å›å¤è¯„è®ºè€Œæ˜¯ç›´æ¥è¯„è®ºè§†é¢‘</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content       è¯„è®ºå†…å®¹ï¼Œä¸èƒ½ä¸ºç©ºä¸”æœ€å¤§é•¿åº¦ä¸º500</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> imgPath       è¯„è®ºå›¾ç‰‡è·¯å¾„ï¼Œæœ€å¤§é•¿åº¦ä¸º50</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> è¿”å›æ“ä½œç»“æœçš„å“åº”å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">&quot;/postComment&quot;</span>)</span><br><span class="line">    <span class="meta">@RecordUserMessage</span>(messageType = <span class="title class_">MessageTypeEnum</span>.<span class="property">COMMENT</span>)<span class="comment">// è¯„è®ºæ¶ˆæ¯</span></span><br><span class="line">    <span class="meta">@GlobalInterceptor</span>(checkLogin = <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">postComment</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="title class_">String</span> videoId,</span></span><br><span class="line"><span class="params">                                  <span class="title class_">Integer</span> replyCommentId,  <span class="comment">// å›å¤çš„è¯„è®ºIDï¼Œè‹¥ä¸ºç©ºåˆ™è¡¨ç¤ºéå›å¤è¯„è®º</span></span></span><br><span class="line"><span class="params">                                  <span class="meta">@NotEmpty</span> <span class="meta">@Size</span>(max = <span class="number">500</span>) <span class="title class_">String</span> content,  <span class="comment">// è¯„è®ºå†…å®¹</span></span></span><br><span class="line"><span class="params">                                  <span class="meta">@Size</span>(max = <span class="number">50</span>) <span class="title class_">String</span> imgPath</span>) &#123;  <span class="comment">// è¯„è®ºé™„å¸¦çš„å›¾ç‰‡è·¯å¾„</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–å½“å‰ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯</span></span><br><span class="line">        <span class="title class_">TokenUserInfoDto</span> tokenUserInfoDto = <span class="title function_">getTokenUserInfoDto</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºè¯„è®ºå¯¹è±¡</span></span><br><span class="line">        <span class="title class_">VideoComment</span> comment = <span class="keyword">new</span> <span class="title class_">VideoComment</span>();</span><br><span class="line">        comment.<span class="title function_">setUserId</span>(tokenUserInfoDto.<span class="title function_">getUserId</span>());  <span class="comment">// è®¾ç½®ç”¨æˆ·ID</span></span><br><span class="line">        comment.<span class="title function_">setAvatar</span>(tokenUserInfoDto.<span class="title function_">getAvatar</span>());  <span class="comment">// è®¾ç½®ç”¨æˆ·å¤´åƒ</span></span><br><span class="line">        comment.<span class="title function_">setNickName</span>(tokenUserInfoDto.<span class="title function_">getNickName</span>());  <span class="comment">// è®¾ç½®ç”¨æˆ·æ˜µç§°</span></span><br><span class="line">        comment.<span class="title function_">setVideoId</span>(videoId);  <span class="comment">// è®¾ç½®è§†é¢‘ID</span></span><br><span class="line">        comment.<span class="title function_">setContent</span>(content);  <span class="comment">// è®¾ç½®è¯„è®ºå†…å®¹</span></span><br><span class="line">        comment.<span class="title function_">setImgPath</span>(imgPath);  <span class="comment">// è®¾ç½®è¯„è®ºå›¾ç‰‡è·¯å¾„ï¼ˆå¯é€‰ï¼‰</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// è°ƒç”¨æœåŠ¡å±‚æ–¹æ³•å‘å¸ƒè¯„è®º</span></span><br><span class="line">        videoCommentService.<span class="title function_">postComment</span>(comment, replyCommentId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®å›å¤è¯„è®ºçš„ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚æœæ˜¯å›å¤è¯„è®ºï¼‰</span></span><br><span class="line">        comment.<span class="title function_">setReplyAvatar</span>(tokenUserInfoDto.<span class="title function_">getAvatar</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(comment);  <span class="comment">// è¿”å›æˆåŠŸå“åº”ï¼ŒåŒ…å«è¯„è®ºå¯¹è±¡</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1113-1024x471.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1112.png" alt="img"></p>
<p>æµ‹è¯•ï¼šå¦‚å›¾å½“ç»™ç¨¿ä»¶ç‚¹èµæ—¶ï¼Œæ•°æ®åº“çš„ç”¨æˆ·æ¶ˆæ¯è¡¨å·²ç»æœ‰æ•°æ®äº†</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1106-1024x465.png" alt="img"></p>
<h2 id="20-æ¶ˆæ¯ç®¡ç†">20.æ¶ˆæ¯ç®¡ç†</h2>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1115.png" alt="img"></p>
<p>åˆ›å»ºUserMessageController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.web.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.dto.TokenUserInfoDto;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.dto.UserMessageCountDto;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.enums.MessageReadTypeEnum;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.po.UserMessage;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.query.UserMessageQuery;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.vo.PaginationResultVO;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.vo.ResponseVO;</span><br><span class="line"><span class="keyword">import</span> com.easylive.service.UserMessageService;</span><br><span class="line"><span class="keyword">import</span> com.easylive.web.annotation.GlobalInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.annotation.Validated;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.NotNull;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/message&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserMessageContrller</span> <span class="keyword">extends</span> <span class="title class_">ABaseController</span> &#123;</span><br><span class="line"></span><br><span class="line">     <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserMessageService userMessageService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„â€œæœªè¯»æ¶ˆæ¯æ€»æ•°â€</span></span><br><span class="line"><span class="comment">     * - æœªç™»å½•ï¼šå…œåº•è¿”å› 0ï¼ˆé˜²æ­¢å‰ç«¯ç©ºæŒ‡é’ˆï¼‰</span></span><br><span class="line"><span class="comment">     * - è¿‡æ»¤æ¡ä»¶ï¼šuser_id = å½“å‰ç”¨æˆ· AND read_type = 0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/getNoReadCount&quot;)</span></span><br><span class="line">    <span class="meta">@GlobalInterceptor(checkLogin = true)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseVO <span class="title function_">getNoReadCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">TokenUserInfoDto</span> <span class="variable">token</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line">        <span class="keyword">if</span> (token == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> getSuccessResponseVO(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">UserMessageQuery</span> <span class="variable">q</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserMessageQuery</span>();</span><br><span class="line">        q.setUserId(token.getUserId());</span><br><span class="line">        q.setReadType(MessageReadTypeEnum.NO_READ.getType()); <span class="comment">// 0=æœªè¯»</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> userMessageService.findCountByParam(q);</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(count);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–â€œæŒ‰æ¶ˆæ¯ç±»å‹åˆ†ç»„â€çš„æœªè¯»æ•°åˆ—è¡¨</span></span><br><span class="line"><span class="comment">     * - è¿”å› [&#123;messageType: X, messageCount: N&#125;, ...]</span></span><br><span class="line"><span class="comment">     * - ä¾¿äºå‰ç«¯åœ¨æ¯ä¸ªTabä¸Šæ˜¾ç¤ºè§’æ ‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/getNoReadCountGroup&quot;)</span></span><br><span class="line">    <span class="meta">@GlobalInterceptor(checkLogin = true)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseVO <span class="title function_">getNoReadCountGroup</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">TokenUserInfoDto</span> <span class="variable">token</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line">        List&lt;UserMessageCountDto&gt; dataList =</span><br><span class="line">                userMessageService.getMessageTypeNoReadCount(token.getUserId());</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(dataList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸€é”®è®¾å·²è¯»</span></span><br><span class="line"><span class="comment">     * - å¯å¸¦ messageTypeï¼šåªæŠŠè¯¥ç±»å‹çš„æ¶ˆæ¯è®¾ä¸ºå·²è¯»</span></span><br><span class="line"><span class="comment">     * - ä¸å¸¦åˆ™æŠŠâ€œæˆ‘çš„æ‰€æœ‰æ¶ˆæ¯â€è®¾ä¸ºå·²è¯»</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/readAll&quot;)</span></span><br><span class="line">    <span class="meta">@GlobalInterceptor(checkLogin = true)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseVO <span class="title function_">readAll</span><span class="params">(Integer messageType)</span> &#123;</span><br><span class="line">        <span class="type">TokenUserInfoDto</span> <span class="variable">token</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// where æ¡ä»¶ï¼šæˆ‘çš„æ¶ˆæ¯ + å¯é€‰çš„ messageType</span></span><br><span class="line">        <span class="type">UserMessageQuery</span> <span class="variable">where</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserMessageQuery</span>();</span><br><span class="line">        where.setUserId(token.getUserId());</span><br><span class="line">        where.setMessageType(messageType);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// set å­å¥ï¼šread_type = 1</span></span><br><span class="line">        <span class="type">UserMessage</span> <span class="variable">patch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserMessage</span>();</span><br><span class="line">        patch.setReadType(MessageReadTypeEnum.READ.getType()); <span class="comment">// 1=å·²è¯»</span></span><br><span class="line"></span><br><span class="line">        userMessageService.updateByParam(patch, where);</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ†é¡µåŠ è½½æ¶ˆæ¯åˆ—è¡¨</span></span><br><span class="line"><span class="comment">     * - å¿…å¡« messageTypeï¼ˆå‰ç«¯ä¸€ä¸ªTabå¯¹åº”ä¸€ç§ç±»å‹ï¼‰</span></span><br><span class="line"><span class="comment">     * - é™åºæŒ‰ message_idï¼Œæœ€æ–°åœ¨å‰</span></span><br><span class="line"><span class="comment">     * - ç»“æœä¸­â€œæºå¸¦å‘é€äººå¤´åƒ/æ˜µç§°ã€è§†é¢‘å/å°é¢â€ç­‰å±•ç¤ºå­—æ®µï¼ˆè§ XML çš„è”è¡¨ï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/loadMessage&quot;)</span></span><br><span class="line">    <span class="meta">@GlobalInterceptor(checkLogin = true)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseVO <span class="title function_">loadMessage</span><span class="params">(<span class="meta">@NotNull</span> Integer messageType, Integer pageNo)</span> &#123;</span><br><span class="line">        <span class="type">TokenUserInfoDto</span> <span class="variable">token</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line">        <span class="type">UserMessageQuery</span> <span class="variable">q</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserMessageQuery</span>();</span><br><span class="line">        q.setMessageType(messageType);</span><br><span class="line">        q.setPageNo(pageNo);</span><br><span class="line">        q.setUserId(token.getUserId());</span><br><span class="line">        q.setOrderBy(<span class="string">&quot;message_id desc&quot;</span>); <span class="comment">// ä»…å…è®¸ç™½åå•æ’åºï¼Œé˜²æ³¨å…¥</span></span><br><span class="line">        <span class="type">PaginationResultVO</span> <span class="variable">result</span> <span class="operator">=</span> userMessageService.findListByPage(q);</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ é™¤ä¸€æ¡æ¶ˆæ¯ï¼ˆåªå…è®¸åˆ é™¤â€œæˆ‘è‡ªå·±çš„æ¶ˆæ¯â€ï¼‰</span></span><br><span class="line"><span class="comment">     * - whereï¼šuser_id = æˆ‘ï¼Œmessage_id = è¿™æ¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/delMessage&quot;)</span></span><br><span class="line">    <span class="meta">@GlobalInterceptor(checkLogin = true)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseVO <span class="title function_">delMessage</span><span class="params">(<span class="meta">@NotNull</span> Integer messageId)</span> &#123;</span><br><span class="line">        <span class="type">TokenUserInfoDto</span> <span class="variable">token</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line">        <span class="type">UserMessageQuery</span> <span class="variable">where</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserMessageQuery</span>();</span><br><span class="line">        where.setUserId(token.getUserId());</span><br><span class="line">        where.setMessageId(messageId);</span><br><span class="line">        userMessageService.deleteByParam(where);</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æŒ‰ç±»å‹æœªè¯»åˆ†ç»„çš„ DTO</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1116-1024x838.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1117-1024x703.png" alt="img"></p>
<p>UserMessageCountDtoä¸º</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">dto</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserMessageCountDto</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> messageType;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> messageCount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getMessageType</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> messageType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setMessageType</span>(<span class="params"><span class="title class_">Integer</span> messageType</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">messageType</span> = messageType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getMessageCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> messageCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setMessageCount</span>(<span class="params"><span class="title class_">Integer</span> messageCount</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">messageCount</span> = messageCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨UserMessageServiceä¸­</p>
<figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * è·å–æ¶ˆæ¯ç±»å‹æœªè¯»æ•°é‡</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="title class_">List</span><span class="operator">&lt;</span><span class="title class_">UserMessageCountDto</span><span class="operator">&gt;</span> <span class="title function_">getMessageTypeNoReadCount</span>(<span class="title class_">String</span> <span class="variable">userId</span>);</span><br></pre></td></tr></table></figure>
<p>UserMessageServiceImplä¸­</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">List</span>&lt;<span class="title class_">UserMessageCountDto</span>&gt; <span class="title function_">getMessageTypeNoReadCount</span>(<span class="params"><span class="title class_">String</span> userId</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">userMessageMapper</span>.<span class="title function_">getMessageTypeNoReadCount</span>(userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UserMessageMapperä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * æ ¹æ®ç”¨æˆ·idè·å–æœªè¯»æ¶ˆæ¯æ•°é‡</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	List&lt;UserMessageCountDto&gt; <span class="title function_">getMessageTypeNoReadCount</span><span class="params">(<span class="meta">@Param(&quot;userId&quot;)</span> String userId)</span>;</span><br></pre></td></tr></table></figure>
<p>UserMessageMapper.xmlä¸­</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">select</span> id=<span class="string">&quot;getMessageTypeNoReadCount&quot;</span> resultType=<span class="string">&quot;com.easylive.entity.dto.UserMessageCountDto&quot;</span>&gt;</span><br><span class="line">		<span class="keyword">select</span> message_type messageType,<span class="built_in">count</span>(<span class="number">1</span>) messageCount <span class="keyword">from</span> user_message <span class="keyword">where</span> user_id = #&#123;userId&#125; <span class="keyword">and</span> read_type = <span class="number">0</span> <span class="keyword">group</span> <span class="keyword">by</span> message_type</span><br><span class="line">	&lt;/<span class="keyword">select</span>&gt;</span><br></pre></td></tr></table></figure>
<p>æ¶ˆæ¯åˆ—è¡¨æŸ¥è¯¢ï¼šè”è¡¨è¡¥é½å±•ç¤ºå­—æ®µ</p>
<blockquote>
<p>ä¸ºäº†è®©å‰ç«¯ç›´æ¥æ¸²æŸ“â€œå‘é€äººæ˜µç§°/å¤´åƒã€è§†é¢‘æ ‡é¢˜/å°é¢â€ï¼Œåœ¨ <code>selectList</code> é‡Œ<strong>è”è¡¨</strong> <code>video_info_post</code> ä¸ <code>user_info</code>ï¼Œå¹¶åœ¨ <code>UserMessage</code> å®ä½“å¢åŠ å¯¹åº”<strong>éæŒä¹…åŒ–å­—æ®µ</strong>ã€‚</p>
</blockquote>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;!<span class="comment">-- æŸ¥è¯¢é›†åˆï¼šæ¶ˆæ¯ä¸»è¡¨ + å‘é€äºº + è§†é¢‘ä¿¡æ¯ --&gt;</span></span><br><span class="line">&lt;<span class="keyword">select</span> id=&quot;selectList&quot; resultMap=&quot;base_result_map&quot;&gt;</span><br><span class="line">  <span class="keyword">SELECT</span></span><br><span class="line">    &lt;<span class="keyword">include</span> refid=&quot;base_column_list&quot;/&gt;,  <span class="comment">-- u.*: user_message çš„åŸºç¡€åˆ—</span></span><br><span class="line">    <span class="keyword">user</span>.avatar     <span class="keyword">AS</span> sendUserAvatar,    <span class="comment">-- å‘é€äººå¤´åƒï¼ˆå‰ç«¯å±•ç¤ºï¼‰</span></span><br><span class="line">    <span class="keyword">user</span>.nick_name  <span class="keyword">AS</span> sendUserName,      <span class="comment">-- å‘é€äººæ˜µç§°ï¼ˆå‰ç«¯å±•ç¤ºï¼‰</span></span><br><span class="line">    v.video_name    <span class="keyword">AS</span> video_name,        <span class="comment">-- è§†é¢‘æ ‡é¢˜ï¼ˆå‰ç«¯å±•ç¤ºï¼‰</span></span><br><span class="line">    v.video_cover   <span class="keyword">AS</span> video_cover        <span class="comment">-- è§†é¢‘å°é¢ï¼ˆå‰ç«¯å±•ç¤ºï¼‰</span></span><br><span class="line">  <span class="keyword">FROM</span> user_message u</span><br><span class="line">  <span class="keyword">LEFT JOIN</span> video_info_post v <span class="keyword">ON</span> u.video_id = v.video_id</span><br><span class="line">  <span class="keyword">LEFT JOIN</span> user_info      <span class="keyword">user</span> <span class="keyword">ON</span> <span class="keyword">user</span>.user_id = u.send_user_id</span><br><span class="line">  &lt;<span class="keyword">include</span> refid=&quot;query_condition&quot;/&gt;</span><br><span class="line">  &lt;<span class="keyword">if</span> test=&quot;query.orderBy != null&quot;&gt;</span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> $&#123;query.orderBy&#125;</span><br><span class="line">  &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">  &lt;<span class="keyword">if</span> test=&quot;query.simplePage != null&quot;&gt;</span><br><span class="line">    <span class="keyword">LIMIT</span> #&#123;query.simplePage.<span class="keyword">start</span>&#125;, #&#123;query.simplePage.<span class="keyword">end</span>&#125;</span><br><span class="line">  &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">&lt;/<span class="keyword">select</span>&gt;</span><br></pre></td></tr></table></figure>
<p><strong>å®‰å…¨æç¤º</strong>ï¼š<code>ORDER BY $&#123;&#125;</code> å¿…é¡»åªå…è®¸<strong>ç™½åå•å­—æ®µ</strong>ï¼ˆä¾‹å¦‚è¿™é‡Œåªå…è®¸ <code>message_id desc</code>ï¼‰ï¼Œä¸è¦æŠŠç”¨æˆ·è¾“å…¥ç›´æ¥é€ä¼ ã€‚</p>
<p>å¹¶åœ¨UserMessageä¸­æ·»åŠ è¿™å‡ ä¸ªæ‰©å±•å­—æ®µåŠå…¶get/setæ–¹æ³•ï¼Œè¿™é‡Œé¢è¦è§£æä¸€ä¸ªå¯¹è±¡ä¸ç„¶å‰ç«¯æŠ¥é”™</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">private</span> <span class="type">String</span> videoName;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="type">String</span> videoCover;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="type">String</span> sendUserName;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="type">String</span> sendUserAvatar;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰©å±•ä¿¡æ¯å¯¹è±¡å°è£…ï¼Œæ–¹ä¾¿å‰ç«¯å±•ç¤ºä½¿ç”¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> UserMessageExtendDto extendDto;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserMessageExtendDto <span class="title">getExtendDto</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> StringTools.<span class="built_in">isEmpty</span>(extendJson) ? <span class="keyword">new</span> <span class="built_in">UserMessageExtendDto</span>() : JsonUtils.<span class="built_in">convertJson2Obj</span>(extendJson, UserMessageExtendDto.<span class="keyword">class</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">void</span> <span class="title">setExtendDto</span><span class="params">(UserMessageExtendDto extendDto)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.extendDto = extendDto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1118-1024x927.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1119-1024x811.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1120-1024x888.png" alt="img"></p>
<p>æµ‹è¯•</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1107-1024x438.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1108-1024x374.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1109-1024x309.png" alt="img"></p>
<h2 id="21-æ’­æ”¾å†å²">21.æ’­æ”¾å†å²</h2>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1123-1024x652.png" alt="img"></p>
<p>åœ¨ExecuteQueueTaskä¸­è¡¥å…¨ä¹‹å‰çš„TODO</p>
<p>é˜Ÿåˆ—æ¶ˆè´¹é‡Œè¡¥é½â€œä¿å­˜å†å²â€</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@Resource</span><br><span class="line">private VideoPlayHistoryService videoPlayHistoryService;</span><br><span class="line"> @PostConstruct</span><br><span class="line">public <span class="literal">void</span> consumeVideoPlayQueue() &#123;</span><br><span class="line">    executorService.execute<span class="function"><span class="params">(() -&gt; &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">try</span> &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="regexp">// 1) ä»é˜Ÿåˆ—æœ«å°¾å–å‡ºä¸€ä¸ªæ’­æ”¾äº‹ä»¶ï¼ˆæ— é˜»å¡ï¼Œç©ºåˆ™ sleepï¼‰</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">                VideoPlayInfoDto dto =</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">                        (VideoPlayInfoDto) redisUtils.rpop(Constants.REDIS_KEY_QUEUE_VIDEO_PLAY);</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function"></span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">                if (dto == null) &#123;</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">                    Thread.sleep(1500);   //</span> ä½è´Ÿè½½ä¸‹ä¼‘çœ ï¼Œé¿å…ç©ºè½¬</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">continue</span>;</span></span></span><br><span class="line"><span class="params"><span class="function">                &#125;</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="regexp">// 2) æ•°æ®åº“é‡ŒæŠŠè§†é¢‘æ€»æ’­æ”¾é‡ +1ï¼ˆåŒæ—¶è®°å¾—æ›´æ–° last_play_time = now()ï¼‰</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">                videoInfoService.addReadCount(dto.getVideoId());</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function"></span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">                //</span> <span class="number">3</span>)</span> ä»…å½“æœ‰ç™»å½•ç”¨æˆ·æ—¶ï¼Œè®°å½•æ’­æ”¾å†å²ï¼ˆç»§ç»­è§‚çœ‹/æ¨èä¼šç”¨åˆ°ï¼‰</span></span><br><span class="line"><span class="function">                <span class="title">if</span> <span class="params">(!StringTools.isEmpty(dto.getUserId()))</span> &#123;</span></span><br><span class="line"><span class="function">                    // è®°å½•å†å²</span></span><br><span class="line"><span class="function">                    <span class="title">videoPlayHistoryService</span>.<span class="title">saveHistory</span><span class="params">(dto.getUserId(), dto.getVideoId(), dto.getFileIndex())</span>;</span></span><br><span class="line"><span class="function">                &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">               // 4) <span class="title">Redis</span>ï¼šæŒ‰å¤©æ’­æ”¾é‡è®¡æ•°ï¼ˆåšçœ‹æ¿/è¶‹åŠ¿ï¼‰</span></span><br><span class="line"><span class="function">                <span class="title">redisComponent</span>.<span class="title">recordVideoPlayCount</span><span class="params">(dto.getVideoId())</span>;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">                  // 5) <span class="title">ES</span>ï¼š<span class="title">playCount</span> åŸå­è‡ªå¢ï¼ˆç”¨äºæœç´¢æ’åºï¼‰</span></span><br><span class="line"><span class="function">                <span class="title">esSearchComponent</span>.<span class="title">updateDocCount</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">                        dto.getVideoId(),</span></span></span><br><span class="line"><span class="params"><span class="function">                        SearchOrderTypeEnum.VIDEO_PLAY.getField(),</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="number">1</span></span></span></span><br><span class="line"><span class="params"><span class="function">                )</span>;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">            &#125; <span class="title">catch</span> <span class="params">(Exception e)</span> &#123;</span></span><br><span class="line"><span class="function">                <span class="title">log</span>.<span class="title">error</span><span class="params">(<span class="string">&quot;è·å–è§†é¢‘æ’­æ”¾æ–‡ä»¶é˜Ÿåˆ—ä¿¡æ¯å¤±è´¥&quot;</span>, e)</span>;</span></span><br><span class="line"><span class="function">            &#125;</span></span><br><span class="line"><span class="function">        &#125;</span></span><br><span class="line"><span class="function">    &#125;);</span></span><br></pre></td></tr></table></figure>
<p>å…³é”®ç‚¹ï¼š<strong>åªè¦æœ‰ userId å°±è®°å†å²</strong>ï¼›æ²¡æœ‰ç™»å½•ç”¨æˆ·å°±<strong>ä¸å†™å†å²</strong>ï¼ˆé¿å…è„æ•°æ®ï¼‰ã€‚</p>
<p>åœ¨VideoPlayHistoryServiceä¸­</p>
<p>Serviceï¼šå†å²è½åº“ï¼ˆUpsertï¼‰</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ä¿å­˜æ’­æ”¾å†å²ï¼ˆå­˜åœ¨åˆ™æ›´æ–°æ—¶é—´ä¸åˆ†Pï¼Œä¸å­˜åœ¨åˆ™æ’å…¥ï¼‰</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="type">void</span> <span class="title">saveHistory</span><span class="params">(<span class="type">String</span> userId, <span class="type">String</span> videoId, Integer fileIndex)</span></span>;</span><br></pre></td></tr></table></figure>
<p>VideoPlayHistoryServiceImplä¸­</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">saveHistory</span>(<span class="params"><span class="title class_">String</span> userId, <span class="title class_">String</span> videoId, <span class="title class_">Integer</span> fileIndex</span>) &#123;</span><br><span class="line">    <span class="comment">// ç»„è£…ä¸€æ¡â€œæœ€åä¸€æ¬¡è§‚çœ‹è®°å½•â€</span></span><br><span class="line">    <span class="title class_">VideoPlayHistory</span> history = <span class="keyword">new</span> <span class="title class_">VideoPlayHistory</span>();</span><br><span class="line">    history.<span class="title function_">setVideoId</span>(videoId);</span><br><span class="line">    history.<span class="title function_">setFileIndex</span>(fileIndex);</span><br><span class="line">    history.<span class="title function_">setUserId</span>(userId);</span><br><span class="line">    history.<span class="title function_">setLastUpdateTime</span>(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    <span class="comment">// insert or updateï¼ˆæ ¹æ®å”¯ä¸€é”® userId+videoId åšå¹‚ç­‰ï¼‰</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">videoPlayHistoryMapper</span>.<span class="title function_">insertOrUpdate</span>(history);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®¢æˆ·ç«¯ä¸‹åˆ›å»ºVideoPlayHistoryController</p>
<p>Controllerï¼šæŸ¥è¯¢/æ¸…ç©º/åˆ é™¤å†å²</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.web.controller;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.dto.TokenUserInfoDto;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.query.VideoPlayHistoryQuery;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.vo.ResponseVO;</span><br><span class="line"><span class="keyword">import</span> com.easylive.service.VideoPlayHistoryService;</span><br><span class="line"><span class="keyword">import</span> com.easylive.web.<span class="keyword">annotation</span>.GlobalInterceptor;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.<span class="keyword">annotation</span>.Validated;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"><span class="keyword">import</span> javax.validation.constraints.NotEmpty;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="meta">@RequestMapping(<span class="string">&quot;/history&quot;</span>)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VideoPlayHistoryController</span> <span class="title">extends</span> <span class="title">ABaseController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> VideoPlayHistoryService videoPlayHistoryService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ†é¡µæ‹‰å–æˆ‘çš„æ’­æ”¾å†å²</span></span><br><span class="line"><span class="comment">     * - é»˜è®¤æŒ‰ last_update_time DESC</span></span><br><span class="line"><span class="comment">     * - queryVideoDetail=true æ—¶ï¼Œå·¦è”è¡¨è§†é¢‘è¡¨ï¼Œç›´æ¥æŠŠå°é¢/æ ‡é¢˜å¸¦å›å‰ç«¯</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(<span class="string">&quot;/loadHistory&quot;</span>)</span></span><br><span class="line">    <span class="meta">@GlobalInterceptor(checkLogin = true)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseVO loadHistory(Integer pageNo) &#123;</span><br><span class="line">        TokenUserInfoDto token = getTokenUserInfoDto();</span><br><span class="line">        VideoPlayHistoryQuery q = new VideoPlayHistoryQuery();</span><br><span class="line">        q.setUserId(token.getUserId());</span><br><span class="line">        q.setOrderBy(<span class="string">&quot;last_update_time desc&quot;</span>); <span class="comment">// ç™½åå•æ’åºå­—æ®µï¼Œé˜²æ³¨å…¥</span></span><br><span class="line">        q.setPageNo(pageNo);</span><br><span class="line">        q.setQueryVideoDetail(<span class="literal">true</span>);          <span class="comment">// è”è§†é¢‘é¢‘ä¿¡æ¯</span></span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(videoPlayHistoryService.findListByPage(q));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** æ¸…ç©ºæˆ‘çš„å…¨éƒ¨å†å² */</span></span><br><span class="line">    <span class="meta">@RequestMapping(<span class="string">&quot;/cleanHistory&quot;</span>)</span></span><br><span class="line">    <span class="meta">@GlobalInterceptor(checkLogin = true)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseVO cleanHistory() &#123;</span><br><span class="line">        TokenUserInfoDto token = getTokenUserInfoDto();</span><br><span class="line">        VideoPlayHistoryQuery q = new VideoPlayHistoryQuery();</span><br><span class="line">        q.setUserId(token.getUserId());</span><br><span class="line">        videoPlayHistoryService.deleteByParam(q);</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** åˆ é™¤æŸä¸ªè§†é¢‘çš„å†å² */</span></span><br><span class="line">    <span class="meta">@RequestMapping(<span class="string">&quot;/delHistory&quot;</span>)</span></span><br><span class="line">    <span class="meta">@GlobalInterceptor(checkLogin = true)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseVO delHistory(<span class="meta">@NotEmpty</span> String videoId) &#123;</span><br><span class="line">        TokenUserInfoDto token = getTokenUserInfoDto();</span><br><span class="line">        videoPlayHistoryService.deleteVideoPlayHistoryByUserIdAndVideoId(</span><br><span class="line">            token.getUserId(), videoId);</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‰ä¸ªæ¥å£éƒ½åŠ äº† <code>@GlobalInterceptor(checkLogin=true)</code>ï¼Œç¡®ä¿<strong>ä»…æ“ä½œè‡ªå·±çš„å†å²</strong>ã€‚</p>
<p>åœ¨VideoPlayHistoryQueryä¸­æ·»åŠ è¿™ä¸ªå­—æ®µåŠå…¶get/setæ–¹æ³•</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ˜¯å¦æŸ¥è¯¢è§†é¢‘è¯¦æƒ…</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">Boolean</span> queryVideoDetail;</span><br></pre></td></tr></table></figure>
<p>åœ¨VideoPlayHistoryä¸­åŠ å…¥è¿™ä¸¤ä¸ªå­—æ®µåŠå…¶get/setæ–¹æ³•</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * è§†é¢‘å°é¢</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">String</span> videoCover;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * è§†é¢‘åç§°</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">String</span> videoName;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1124-1024x525.png" alt="img"></p>
<p>æ”¹é€ VideoPlayHistoryMapper.xmlé‡ŒselectListé‡Œçš„æ¡ä»¶</p>
<p>Mapper XMLï¼šåˆ—è¡¨æŸ¥è¯¢ï¼ˆæŒ‰éœ€è”è¡¨ï¼‰</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"> <span class="comment">&lt;!-- åˆ†é¡µæŸ¥è¯¢æ’­æ”¾å†å² --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectList&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;base_result_map&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  SELECT</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;base_column_list&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.queryVideoDetail&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      , d.video_cover AS videoCover</span></span><br><span class="line"><span class="language-xml">      , d.video_name  AS videoName</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  FROM video_play_history v</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.queryVideoDetail&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    LEFT JOIN video_info d ON d.video_id = v.video_id</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;query_condition&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.orderBy != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    ORDER BY $</span><span class="template-variable">&#123;query.orderBy&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.simplePage != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    LIMIT #</span><span class="template-variable">&#123;query.simplePage.start&#125;</span><span class="language-xml">, #</span><span class="template-variable">&#123;query.simplePage.end&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><strong>æ³¨æ„</strong>ï¼š<code>ORDER BY $&#123;&#125;</code> å¿…é¡»é…åˆ<strong>åç«¯ç™½åå•</strong>ï¼ˆåªæ”¾è¡Œ <code>last_update_time desc</code> ç­‰å®‰å…¨å­—æ®µï¼‰ä»¥é˜²æ³¨å…¥ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1125-1024x876.png" alt="img"></p>
<p>æµ‹è¯•å±•ç¤ºå†å²è®°å½•ï¼Œæ¸…ç©ºæ‰€æœ‰å†å²è®°å½•ï¼Œæ¸…é™¤å•ä¸ªè§†é¢‘çš„å†å²è®°å½•å‡æ²¡æœ‰é—®é¢˜</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1114-1024x464.png" alt="img"></p>
<h2 id="22-å‰©ä½™TODOçš„å¤„ç†">22.å‰©ä½™TODOçš„å¤„ç†</h2>
<p><strong>å‰©ä½™ TODO çš„å¤„ç†</strong>â€æŒ‰åŠŸèƒ½ï¼š<strong>(1) å¤´åƒæ‚¬æµ®ç»Ÿè®¡ â†’ (2) åˆ é™¤åˆ†ç±»å‰æ ¡éªŒ â†’ (3) æ³¨å†Œä¸ç”¨æˆ·è¯¦æƒ…æ±‡æ€» â†’ (4) å®¡æ ¸é¦–å‘å¥–åŠ±ç¡¬å¸ â†’ (5) åˆ é™¤è§†é¢‘æ‰£å›ç¡¬å¸ â†’ (6) é€šç”¨çš„ç¡¬å¸å¢å‡æ¥å£</strong>ã€‚</p>
<p>UserCountInfoDto</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">dto</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserCountInfoDto</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> fansCount;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> currentCoinCount;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> focusCount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getFansCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> fansCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setFansCount</span>(<span class="params"><span class="title class_">Integer</span> fansCount</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">fansCount</span> = fansCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getCurrentCoinCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> currentCoinCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setCurrentCoinCount</span>(<span class="params"><span class="title class_">Integer</span> currentCoinCount</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">currentCoinCount</span> = currentCoinCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getFocusCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> focusCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setFocusCount</span>(<span class="params"><span class="title class_">Integer</span> focusCount</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">focusCount</span> = focusCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-å¤„ç†å®¢æˆ·ç«¯çš„AccountControllerçš„TODOå½“é¼ æ ‡æ‚¬æµ®åœ¨å¤´åƒä¸Šæ—¶ä¼šæ˜¾ç¤ºå…³æ³¨æ•°ã€ç²‰ä¸æ•°ã€ç¡¬å¸æ•°">1.å¤„ç†å®¢æˆ·ç«¯çš„AccountControllerçš„TODOå½“é¼ æ ‡æ‚¬æµ®åœ¨å¤´åƒä¸Šæ—¶ä¼šæ˜¾ç¤ºå…³æ³¨æ•°ã€ç²‰ä¸æ•°ã€ç¡¬å¸æ•°</h3>
<ol>
<li>å®¢æˆ·ç«¯å¤´åƒæ‚¬æµ®ç»Ÿè®¡ï¼šå…³æ³¨/ç²‰ä¸/ç¡¬å¸</li>
</ol>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value = <span class="string">&quot;/getUserCountInfo&quot;</span>)</span><br><span class="line">   @GlobalInterceptor(checkLogin = true)</span><br><span class="line">   public ResponseVO getUserCountInfo() &#123;</span><br><span class="line">       TokenUserInfoD<span class="keyword">to</span> tokenUserInfoD<span class="keyword">to</span> = getTokenUserInfoD<span class="keyword">to</span>();</span><br><span class="line">       UserCountInfoD<span class="keyword">to</span> <span class="keyword">user</span>CountInfoD<span class="keyword">to</span> = <span class="keyword">user</span>InfoService.getUserCountInfo(tokenUserInfoD<span class="keyword">to</span>.getUserId());</span><br><span class="line">       return getSuccessResponseVO(<span class="keyword">user</span>CountInfoD<span class="keyword">to</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨UserInfoService</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** è·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯ï¼šç²‰ä¸ã€å…³æ³¨ã€å½“å‰ç¡¬å¸ */</span></span><br><span class="line"><span class="function">UserCountInfoDto <span class="title">getUserCountInfo</span><span class="params">(<span class="type">String</span> userId)</span></span>;</span><br></pre></td></tr></table></figure>
<p>Implä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> UserCountInfoDto <span class="title function_">getUserCountInfo</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1) è¯»æœ¬äººåŸºç¡€ä¿¡æ¯ï¼ˆæ‹¿å½“å‰ç¡¬å¸ä½™é¢ï¼‰</span></span><br><span class="line">    <span class="type">UserInfo</span> <span class="variable">user</span> <span class="operator">=</span> getUserInfoByUserId(userId);</span><br><span class="line">    <span class="comment">// 2) ç»Ÿè®¡ç²‰ä¸æ•°ï¼ˆåˆ«äººå…³æ³¨äº†æˆ‘ï¼‰</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">fansCount</span> <span class="operator">=</span> userFocusMapper.selectFansCount(userId);</span><br><span class="line">    <span class="comment">// 3) ç»Ÿè®¡å…³æ³¨æ•°ï¼ˆæˆ‘å…³æ³¨äº†åˆ«äººï¼‰</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">focusCount</span> <span class="operator">=</span> userFocusMapper.selectFocusCount(userId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) ç»„è£…è¿”å›</span></span><br><span class="line">    <span class="type">UserCountInfoDto</span> <span class="variable">dto</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserCountInfoDto</span>();</span><br><span class="line">    dto.setFansCount(fansCount);</span><br><span class="line">    dto.setFocusCount(focusCount);</span><br><span class="line">    dto.setCurrentCoinCount(user.getCurrentCoinCount());</span><br><span class="line">    <span class="keyword">return</span> dto;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è¦ç‚¹</strong>ï¼šè¿™ä¸‰ä¸ªæ•°éƒ½åœ¨<strong>å•è¡¨/ç®€å•èšåˆ</strong>ä¸Šå®Œæˆï¼Œæ¥å£éå¸¸è½»ï¼›å¦‚è®¿é—®é‡è¾ƒå¤§ï¼Œå¯è€ƒè™‘åŠ  30s çŸ­ç¼“å­˜æˆ–æŒ‰ç”¨æˆ·åšæœ¬åœ°ç¼“å­˜ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1121-1024x234.png" alt="img"></p>
<h3 id="2-CategoryInfoServiceImplä¸­å®Œæˆåˆ é™¤åˆ†ç±»çš„TODOï¼š-æŸ¥è¯¢åˆ†ç±»ä¸‹æ˜¯å¦æœ‰è§†é¢‘">2.CategoryInfoServiceImplä¸­å®Œæˆåˆ é™¤åˆ†ç±»çš„TODOï¼š æŸ¥è¯¢åˆ†ç±»ä¸‹æ˜¯å¦æœ‰è§†é¢‘</h3>
<ol start="2">
<li>åˆ é™¤åˆ†ç±»å‰æ ¡éªŒï¼šç±»ç›®ä¸‹å­˜åœ¨è§†é¢‘æ—¶ç¦æ­¢åˆ é™¤</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * åˆ é™¤åˆ†ç±»</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> categoryId åˆ†ç±»ID</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception å¦‚æœæŸ¥è¯¢åˆ†ç±»ä¸‹æ˜¯å¦æœ‰è§†é¢‘æˆ–åˆ é™¤åˆ†ç±»æ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delCategory</span><span class="params">(Integer categoryId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1) å…ˆæŸ¥â€œæ­¤ç±»ç›®æˆ–å…¶å­ç±»ç›®â€ä¸‹æ˜¯å¦å­˜åœ¨è§†é¢‘</span></span><br><span class="line">    <span class="type">VideoInfoQuery</span> <span class="variable">vq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoQuery</span>();</span><br><span class="line">    <span class="comment">// è‡ªå®šä¹‰æ¡ä»¶ï¼šcategory_id = ? OR p_category_id = ?</span></span><br><span class="line">    vq.setCategoryIdOrPCategoryId(categoryId);</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> videoInfoService.findCountByParam(vq);</span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// æœ‰è§†é¢‘ â†’ ç¦æ­¢åˆ é™¤ï¼Œé¿å…â€œå­¤å„¿è§†é¢‘â€</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;åˆ†ç±»ä¸‹æœ‰è§†é¢‘ä¿¡æ¯ï¼Œæ— æ³•åˆ é™¤&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) æ„é€ åˆ é™¤æ¡ä»¶ï¼šåŒæ ·åŒ¹é…è‡ªå·±ä¸å­ç±»</span></span><br><span class="line">    <span class="type">CategoryInfoQuery</span> <span class="variable">cq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CategoryInfoQuery</span>();</span><br><span class="line">    cq.setCategoryIdOrPCategoryId(categoryId);</span><br><span class="line">    <span class="comment">// æ”¯æŒä¸€æ¬¡åˆ æ‰â€œçˆ¶+å­â€åˆ†ç±»</span></span><br><span class="line">    categoryInfoMapper.deleteByParam(cq);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) åˆ·æ–°åˆ†ç±»ç¼“å­˜ï¼ˆä¿è¯å‰ç«¯ç«‹å³å›æ˜¾æœ€æ–°æ ‘ï¼‰</span></span><br><span class="line">    save2Redis();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨VideoInfoMapper.xmlä¸­ä¸ºcategoryIdOrPCategoryIdåŠ ä¸Šè¿‡æ»¤æ¡ä»¶</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"> <span class="comment">&lt;!-- é€šç”¨æŸ¥è¯¢æ¡ä»¶ --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;query_condition&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">where</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!-- çœç•¥å…¶å®ƒæ¡ä»¶ --&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!-- å…³é”®ï¼šåŒä¸€å‚æ•°åŒ¹é…çˆ¶/å­ä¸¤åˆ—ï¼Œä¾¿äºâ€œçˆ¶åˆ å¸¦å­â€æˆ–â€œç»Ÿè®¡çˆ¶å«å­çš„è§†é¢‘æ•°â€ --&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.categoryIdOrPCategoryId!=null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      and (category_id = #</span><span class="template-variable">&#123;query.categoryIdOrPCategoryId&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">           or  p_category_id = #</span><span class="template-variable">&#123;query.categoryIdOrPCategoryId&#125;</span><span class="language-xml">)</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><strong>è¦ç‚¹</strong>ï¼š</p>
<ul>
<li>å…ˆæ ¡éªŒ<strong>æ˜¯å¦å­˜åœ¨è§†é¢‘</strong>ï¼Œå†åˆ çˆ¶/å­åˆ†ç±»ï¼›</li>
<li>è®°å¾—<strong>åç§°ä¸€è‡´</strong>ï¼šJava å­—æ®µ <code>categoryIdOrPCategoryId</code> è¦ä¸ XML æ¡ä»¶ä¸€è‡´ï¼ˆé¿å…ä¹‹å‰é‡åˆ°çš„ Getter ä¸å­˜åœ¨æŠ¥é”™ï¼‰ï¼›</li>
<li>åˆ é™¤å<strong>ç«‹å³åˆ·æ–° Redis ç¼“å­˜</strong>ï¼Œä¸éœ€è¦å‰ç«¯åˆ·æ–°é¡µé¢å³å¯çœ‹åˆ°æœ€æ–°æ ‘ã€‚</li>
</ul>
<h3 id="3-UserInfoServiceImplä¸­å®Œæˆæ³¨å†Œç”¨æˆ·çš„TODOï¼šåˆå§‹åŒ–ç¡¬å¸æ•°ï¼Œä»¥åŠæ ¹æ®ç”¨æˆ·IDè·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯çš„TODOè·å–æ’­æ”¾é‡ã€ç‚¹èµæ•°ã€æ”¶è—æ•°">3.UserInfoServiceImplä¸­å®Œæˆæ³¨å†Œç”¨æˆ·çš„TODOï¼šåˆå§‹åŒ–ç¡¬å¸æ•°ï¼Œä»¥åŠæ ¹æ®ç”¨æˆ·IDè·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯çš„TODOè·å–æ’­æ”¾é‡ã€ç‚¹èµæ•°ã€æ”¶è—æ•°</h3>
<ol start="3">
<li>æ³¨å†Œåˆå§‹åŒ–ç¡¬å¸ &amp; ç”¨æˆ·è¯¦æƒ…é¡µèšåˆæŒ‡æ ‡</li>
</ol>
<p>æ³¨å†Œï¼šæŒ‰ç³»ç»Ÿé…ç½®å‘æ”¾â€œæ³¨å†Œå¥–åŠ±ç¡¬å¸â€</p>
<p>ç”¨æˆ·è¯¦æƒ…ï¼šæ’­æ”¾é‡/ç‚¹èµæ•°æ±‡æ€» + å…³æ³¨/ç²‰ä¸ + æ˜¯å¦å·²å…³æ³¨</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * æ³¨å†Œç”¨æˆ·</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> <span class="variable">email</span></span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> <span class="variable">nickName</span></span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> <span class="variable">registerPassword</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">register</span>(<span class="params"><span class="title class_">String</span> email, <span class="title class_">String</span> nickName, <span class="title class_">String</span> registerPassword</span>) &#123;</span><br><span class="line">	<span class="title class_">UserInfo</span> userInfo = <span class="variable language_">this</span>.<span class="property">userInfoMapper</span>.<span class="title function_">selectByEmail</span>(email);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != userInfo) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;é‚®ç®±è´¦å·å·²ç»å­˜åœ¨&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="title class_">UserInfo</span> nickNameUser = <span class="variable language_">this</span>.<span class="property">userInfoMapper</span>.<span class="title function_">selectByNickName</span>(nickName);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != nickNameUser) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;æ˜µç§°å·²ç»è¢«å ç”¨&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	userInfo = <span class="keyword">new</span> <span class="title class_">UserInfo</span>();</span><br><span class="line">	<span class="comment">//ç”¨æˆ·IDè®¾ç½®ä¸º10ä½éšæœºæ•°</span></span><br><span class="line">	<span class="title class_">String</span> userId = <span class="title class_">StringTools</span>.<span class="title function_">getRandomNumber</span>(<span class="title class_">Constants</span>.<span class="property">LENGTH_10</span>);</span><br><span class="line">	<span class="comment">//è®¾ç½®ç”¨æˆ·ID</span></span><br><span class="line">        userInfo.<span class="title function_">setUserId</span>(userId);</span><br><span class="line">	<span class="comment">//è®¾ç½®ç”¨æˆ·æ˜µç§°</span></span><br><span class="line">        userInfo.<span class="title function_">setNickName</span>(nickName);</span><br><span class="line">		<span class="comment">//è®¾ç½®ç”¨æˆ·é‚®ç®±</span></span><br><span class="line">		userInfo.<span class="title function_">setEmail</span>(email);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//è®¾ç½®ç”¨æˆ·å¯†ç ,å¯¹å¯†ç è¿›è¡ŒMD5åŠ å¯†å¤„ç†</span></span><br><span class="line">        userInfo.<span class="title function_">setPassword</span>(<span class="title class_">StringTools</span>.<span class="title function_">encodeByMd5</span>(registerPassword));</span><br><span class="line">	<span class="comment">//è®¾ç½®ç”¨æˆ·åŠ å…¥æ—¶é—´</span></span><br><span class="line">        userInfo.<span class="title function_">setJoinTime</span>(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">	<span class="comment">//è®¾ç½®ç”¨æˆ·çŠ¶æ€ï¼Œé»˜è®¤å¯ç”¨</span></span><br><span class="line">        userInfo.<span class="title function_">setStatus</span>(<span class="title class_">UserStatusEnum</span>.<span class="property">ENABLE</span>.<span class="title function_">getStatus</span>());</span><br><span class="line">	<span class="comment">//è®¾ç½®ç”¨æˆ·æ€§åˆ«ï¼Œé»˜è®¤ä¿å¯†</span></span><br><span class="line">        userInfo.<span class="title function_">setSex</span>(<span class="title class_">UserSexEnum</span>.<span class="property">SECRECY</span>.<span class="title function_">getType</span>());</span><br><span class="line">	<span class="comment">//è®¾ç½®ä¸»é¢˜</span></span><br><span class="line">        userInfo.<span class="title function_">setTheme</span>(<span class="title class_">Constants</span>.<span class="property">ONE</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// åˆå§‹åŒ–ç”¨æˆ·çš„ç¡¬å¸</span></span><br><span class="line">		<span class="title class_">SysSettingDto</span> sysSettingDto = redisComponent.<span class="title function_">getSysSettingDto</span>();</span><br><span class="line">		userInfo.<span class="title function_">setTotalCoinCount</span>(sysSettingDto.<span class="title function_">getRegisterCoinCount</span>());</span><br><span class="line">		userInfo.<span class="title function_">setCurrentCoinCount</span>(sysSettingDto.<span class="title function_">getRegisterCoinCount</span>());</span><br><span class="line">	<span class="comment">//å°†ç”¨æˆ·ä¿¡æ¯æ’å…¥æ•°æ®åº“</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">userInfoMapper</span>.<span class="title function_">insert</span>(userInfo);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * æ ¹æ®ç”¨æˆ·IDè·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> currentUserId å½“å‰ç”¨æˆ·ID</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> userId          ç”¨æˆ·ID</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> UserInfo ç”¨æˆ·è¯¦ç»†ä¿¡æ¯</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> BusinessException ä¸šåŠ¡å¼‚å¸¸</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">UserInfo</span> <span class="title function_">getUserDetailInfo</span>(<span class="params"><span class="title class_">String</span> currentUserId, <span class="title class_">String</span> userId</span>) &#123;</span><br><span class="line">    <span class="comment">// 1) åŸºç¡€ä¿¡æ¯</span></span><br><span class="line">    <span class="title class_">UserInfo</span> user = <span class="title function_">getUserInfoByUserId</span>(userId);</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="title class_">ResponseCodeEnum</span>.<span class="property">CODE_404</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) èšåˆè§†é¢‘æŒ‡æ ‡ï¼šæ’­æ”¾æ€»é‡ã€ç‚¹èµæ€»é‡ï¼ˆå¯æ‰© collectCountï¼‰</span></span><br><span class="line">    <span class="title class_">CountInfoDto</span> sum = videoInfoMapper.<span class="title function_">selectSumCountInfo</span>(userId);</span><br><span class="line">    <span class="title class_">CopyTools</span>.<span class="title function_">copyProperties</span>(sum, user);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) ç¤¾äº¤æŒ‡æ ‡ï¼šç²‰ä¸ã€å…³æ³¨</span></span><br><span class="line">    user.<span class="title function_">setFansCount</span>(userFocusMapper.<span class="title function_">selectFansCount</span>(userId));</span><br><span class="line">    user.<span class="title function_">setFocusCount</span>(userFocusMapper.<span class="title function_">selectFocusCount</span>(userId));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) æ˜¯å¦å·²å…³æ³¨ï¼ˆåœ¨ç™»å½•æ€ä¸‹åˆ¤æ–­â€œæˆ‘â†’Taâ€æ˜¯å¦å­˜åœ¨ä¸€æ¡å…³æ³¨å…³ç³»ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (currentUserId == <span class="literal">null</span>) &#123;</span><br><span class="line">        user.<span class="title function_">setHaveFocus</span>(<span class="literal">false</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title class_">UserFocus</span> uf = userFocusMapper.<span class="title function_">selectByUserIdAndFocusUserId</span>(currentUserId, userId);</span><br><span class="line">        user.<span class="title function_">setHaveFocus</span>(uf != <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œéœ€è¦å¯¼å…¥CountInfoDto</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">dto</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CountInfoDto</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> playCount;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> likeCount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getPlayCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> playCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setPlayCount</span>(<span class="params"><span class="title class_">Integer</span> playCount</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">playCount</span> = playCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getLikeCount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> likeCount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setLikeCount</span>(<span class="params"><span class="title class_">Integer</span> likeCount</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">likeCount</span> = likeCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>VideoInfoMapperä¸­åˆ›å»ºselectSumCountInfoæ–¹æ³•</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢æ’­æ”¾é‡ã€ç‚¹èµæ•°ã€æ”¶è—æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="selector-tag">CountInfoDto</span> <span class="selector-tag">selectSumCountInfo</span>(<span class="variable">@Param</span>(<span class="string">&quot;userId&quot;</span>) String userId);</span><br></pre></td></tr></table></figure>
<p>VideoInfoMapper.xmlä¸­</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!--    æŸ¥è¯¢æ’­æ”¾é‡ã€ç‚¹èµæ•°ã€æ”¶è—æ•°--&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectSumCountInfo&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.easylive.entity.dto.CountInfoDto&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">		select ifnull(sum(play_count),0) playCount,ifnull(sum(like_count),0) likeCount from video_info</span></span><br><span class="line"><span class="language-xml">		where user_id = #</span><span class="template-variable">&#123;userId&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1129-1024x929.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1122-1024x494.png" alt="img"></p>
<h3 id="4-VideoInfoPostServiceImplä¸­ç®¡ç†å‘˜å®¡æ ¸è§†é¢‘çš„TODOï¼šé¦–æ¬¡å‘å¸ƒå¥–åŠ±ä¸ºç”¨æˆ·åŠ ç¡¬å¸">4.VideoInfoPostServiceImplä¸­ç®¡ç†å‘˜å®¡æ ¸è§†é¢‘çš„TODOï¼šé¦–æ¬¡å‘å¸ƒå¥–åŠ±ä¸ºç”¨æˆ·åŠ ç¡¬å¸</h3>
<ol start="4">
<li>ç®¡ç†å‘˜å®¡æ ¸ï¼šé¦–å‘å¥–åŠ±ç¡¬å¸ï¼ˆä»…é¦–æ¬¡å‘å¸ƒï¼‰</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç®¡ç†å‘˜å®¡æ ¸è§†é¢‘ï¼ˆé€šè¿‡/é©³å›ï¼‰</span></span><br><span class="line"><span class="comment"> * å…³é”®ç‚¹ï¼š</span></span><br><span class="line"><span class="comment"> * 1) çŠ¶æ€æ ¡éªŒï¼šstatus å¿…é¡»æ˜¯ VideoStatusEnum é‡Œåˆæ³•å€¼</span></span><br><span class="line"><span class="comment"> * 2) ä¹è§‚é”ï¼šåªå…è®¸ä»â€œå¾…å®¡æ ¸(2)â€æ›´æ–°ä¸ºç›®æ ‡çŠ¶æ€ï¼ˆwhere status=2ï¼‰</span></span><br><span class="line"><span class="comment"> * 3) é€šè¿‡åˆ™æŠŠæŠ•ç¨¿æ•°æ®å¤åˆ¶åˆ°æ­£å¼è¡¨ï¼›é©³å›åˆ™åªæ›´æ–°çŠ¶æ€ä¸ç†ç”±</span></span><br><span class="line"><span class="comment"> * 4) æ¸…ç†â€œæ–‡ä»¶æ›´æ–°æ ‡å¿—â€ï¼Œæ¸…ç†å¾…åˆ é™¤æ–‡ä»¶é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">auditVideo</span><span class="params">(String videoId, Integer status, String reason)</span> &#123;</span><br><span class="line">	<span class="comment">// --- 0) åŸºç¡€æ ¡éªŒ ---</span></span><br><span class="line">	<span class="type">VideoStatusEnum</span> <span class="variable">targetEnum</span> <span class="operator">=</span> VideoStatusEnum.getByStatus(status);</span><br><span class="line">	<span class="keyword">if</span> (targetEnum == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600); <span class="comment">// éæ³•çŠ¶æ€</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ä»…å…è®¸æŠŠâ€œå¾…å®¡æ ¸(2)â€ -&gt; â€œé€šè¿‡(3)â€æˆ–â€œå¤±è´¥(4)â€ï¼Œå…¶ä½™å˜è¿ä¸æ”¯æŒ</span></span><br><span class="line">	<span class="keyword">if</span> (!(VideoStatusEnum.STATUS3 == targetEnum || VideoStatusEnum.STATUS4 == targetEnum)) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// --- 1) ä¹è§‚é”åœ°æ›´æ–° video_info_post ä¸»è¡¨ ---</span></span><br><span class="line">	<span class="type">VideoInfoPost</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoPost</span>();</span><br><span class="line">	update.setStatus(status);                          <span class="comment">// æ–°çŠ¶æ€</span></span><br><span class="line">	update.setLastUpdateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());              <span class="comment">// æœ€åæ›´æ–°æ—¶é—´</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// where æ¡ä»¶ï¼švideo_id=...? AND status=å¾…å®¡æ ¸(2)</span></span><br><span class="line">	<span class="type">VideoInfoPostQuery</span> <span class="variable">where</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoPostQuery</span>();</span><br><span class="line">	where.setVideoId(videoId);</span><br><span class="line">	where.setStatus(VideoStatusEnum.STATUS2.getStatus()); <span class="comment">// åªåœ¨â€œå¾…å®¡æ ¸â€æ‰èƒ½è¢«å®¡æ ¸</span></span><br><span class="line"></span><br><span class="line">	<span class="type">Integer</span> <span class="variable">affected</span> <span class="operator">=</span> videoInfoPostMapper.updateByParam(update, where);</span><br><span class="line">	<span class="keyword">if</span> (affected == <span class="literal">null</span> || affected == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">// è¯´æ˜ä¸æ˜¯å¾…å®¡æ ¸çŠ¶æ€ï¼ˆå¯èƒ½å·²è¢«åˆ«äººå®¡æ ¸è¿‡ï¼‰ï¼Œæˆ– videoId éæ³•</span></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;å®¡æ ¸å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// --- 2) å½’é›¶æœ¬è½®â€œæ–‡ä»¶æ›´æ–°â€æ ‡å¿—ï¼ˆpost æ–‡ä»¶è¡¨ï¼‰---</span></span><br><span class="line">	<span class="type">VideoInfoFilePost</span> <span class="variable">fileFlagUpdate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoFilePost</span>();</span><br><span class="line">	fileFlagUpdate.setUpdateType(VideoFileUpdateTypeEnum.NO_UPDATE.getStatus());</span><br><span class="line">	<span class="type">VideoInfoFilePostQuery</span> <span class="variable">filePostWhere</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoFilePostQuery</span>();</span><br><span class="line">	filePostWhere.setVideoId(videoId);</span><br><span class="line">	videoInfoFilePostMapper.updateByParam(fileFlagUpdate, filePostWhere);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// --- 3) è‹¥å®¡æ ¸å¤±è´¥ï¼Œç›´æ¥ç»“æŸï¼ˆä¸è¿›å…¥çº¿ä¸Šè¡¨ï¼‰---</span></span><br><span class="line">	<span class="keyword">if</span> (VideoStatusEnum.STATUS4 == targetEnum) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// --- 4) å®¡æ ¸é€šè¿‡ï¼šæŠŠæŠ•ç¨¿æ•°æ®å¤åˆ¶åˆ°æ­£å¼è¡¨ ---</span></span><br><span class="line">	<span class="comment">// 4.1 è¯»å–æœ€æ–°çš„æŠ•ç¨¿ä¸»è¡¨æ•°æ®</span></span><br><span class="line">	<span class="type">VideoInfoPost</span> <span class="variable">infoPost</span> <span class="operator">=</span> videoInfoPostMapper.selectByVideoId(videoId);</span><br><span class="line">	<span class="keyword">if</span> (infoPost == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="comment">// ç†è®ºä¸Šä¸è¯¥å‡ºç°ï¼›åŠ é˜²å¾¡</span></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;å®¡æ ¸å¤±è´¥ï¼Œæ•°æ®ä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 4.2 é¦–æ¬¡å‘å¸ƒå¥–åŠ±ï¼ˆå¯é€‰é¡¹ï¼‰ï¼šè‹¥æ­£å¼è¡¨ä¸å­˜åœ¨è¯¥ videoIdï¼Œè®¤ä¸ºæ˜¯é¦–å‘ï¼Œå¯åŠ ç¡¬å¸</span></span><br><span class="line">	<span class="type">VideoInfo</span> <span class="variable">existOnline</span> <span class="operator">=</span> (VideoInfo) videoInfoMapper.selectByVideoId(videoId);<span class="comment">// æŸ¥æ­£å¼è¡¨</span></span><br><span class="line">	<span class="keyword">if</span> (existOnline == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="type">SysSettingDto</span> <span class="variable">sysSettingDto</span> <span class="operator">=</span> redisComponent.getSysSettingDto();</span><br><span class="line">		 <span class="comment">// ç»™ä½œè€…åŠ ç¡¬å¸ï¼ˆæ€»æ•° &amp; ä½™é¢éƒ½åœ¨ Mapper é‡Œç»´æŠ¤ï¼‰</span></span><br><span class="line">		userInfoMapper.updateCoinCountInfo(infoPost.getUserId(), sysSettingDto.getPostVideoCoinCount());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 4.3 å¤åˆ¶â€œä¸»è¡¨â€åˆ°æ­£å¼è¡¨ï¼ˆinsertOrUpdateï¼‰</span></span><br><span class="line">	<span class="type">VideoInfo</span> <span class="variable">online</span> <span class="operator">=</span> CopyTools.copy(infoPost, VideoInfo.class);</span><br><span class="line">	videoInfoMapper.insertOrUpdate(online);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 4.4 æ›¿æ¢â€œæ–‡ä»¶æ¸…å•â€ï¼šå…ˆåˆ æ­£å¼è¡¨æ—§æ¸…å•ï¼Œå†æ‹·è´æŠ•ç¨¿æ–‡ä»¶æ¸…å•</span></span><br><span class="line">	<span class="type">VideoInfoFileQuery</span> <span class="variable">delWhere</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoFileQuery</span>();</span><br><span class="line">	delWhere.setVideoId(videoId);</span><br><span class="line">	videoInfoFileMapper.deleteByParam(delWhere);</span><br><span class="line"></span><br><span class="line">	<span class="type">VideoInfoFilePostQuery</span> <span class="variable">postFilesQ</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoFilePostQuery</span>();</span><br><span class="line">	postFilesQ.setVideoId(videoId);</span><br><span class="line">	List&lt;VideoInfoFilePost&gt; postFiles = videoInfoFilePostMapper.selectList(postFilesQ);</span><br><span class="line"></span><br><span class="line">	List&lt;VideoInfoFile&gt; onlineFiles = CopyTools.copyList(postFiles, VideoInfoFile.class);</span><br><span class="line">	<span class="keyword">if</span> (!onlineFiles.isEmpty()) &#123;</span><br><span class="line">		videoInfoFileMapper.insertBatch(onlineFiles);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// --- 5) æ¸…ç†â€œå¾…åˆ é™¤æ–‡ä»¶é˜Ÿåˆ—â€é‡Œçš„ç‰©ç†æ–‡ä»¶ ---</span></span><br><span class="line">	List&lt;String&gt; filePathList = redisComponent.getDelFileList(videoId); <span class="comment">// æ¯ä¸ª path æ˜¯ç›¸å¯¹è·¯å¾„ï¼šå¦‚ &quot;video/20250812/xxx&quot;</span></span><br><span class="line">	<span class="keyword">if</span> (filePathList != <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">for</span> (String relative : filePathList) &#123;</span><br><span class="line">			<span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(appConfig.getProjectFolder() + Constants.FILE_FOLDER + relative);</span><br><span class="line">			<span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="comment">// æœ‰çš„ path æŒ‡å‘çš„æ˜¯ç›®å½•ï¼ˆå¦‚ uploadId ç›®å½•ï¼‰ï¼Œç”¨é€’å½’åˆ æ›´ç¨³</span></span><br><span class="line">					FileUtils.deleteDirectory(file);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">					log.error(<span class="string">&quot;åˆ é™¤æ–‡ä»¶å¤±è´¥ path=&#123;&#125;&quot;</span>, relative, e);</span><br><span class="line">					<span class="comment">// ä¸æŠ›å‡ºï¼Œè®©äº‹åŠ¡å¯ç»§ç»­ï¼Œé¿å…çº¿ä¸Šæ•°æ®å·²æ›´æ–°å´å› æ¸…ç†å¤±è´¥æ•´ä½“å›æ»š</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	redisComponent.cleanDelFileList(videoId);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// --- 6) æŠŠè§†é¢‘ä¿¡æ¯ç´¢å¼•åˆ° ES</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * ä¿å­˜ä¿¡æ¯åˆ°es</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	esSearchComponent.saveDoc(online);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è¦ç‚¹</strong>ï¼š</p>
<ul>
<li>â€œé¦–æ¬¡å‘å¸ƒå¥–åŠ±â€çš„åˆ¤å®šä½¿ç”¨â€œ<strong>çº¿ä¸Šè¡¨æ˜¯å¦å­˜åœ¨è¯¥ videoId</strong>â€ï¼›</li>
<li>å¥–åŠ±é¢åº¦ä» <code>SysSettingDto</code> è¯»å–ï¼Œä¾¿äºåå°é…ç½®ï¼›</li>
<li>æ¸…ç†æ–‡ä»¶å¤±è´¥<strong>ä¸å›æ»š</strong>ä¸»äº‹åŠ¡ï¼Œé¿å…çº¿ä¸Šæ•°æ®å·²æ›´æ–°å´æ•´ä½“å¤±è´¥ã€‚</li>
</ul>
<h3 id="5-VideoInfoServiceImplä¸­å®Œæˆåˆ é™¤è§†é¢‘çš„TODOï¼šå½“åˆ é™¤è§†é¢‘åå‡å»ç”¨æˆ·å¢åŠ çš„ç¡¬å¸">5.VideoInfoServiceImplä¸­å®Œæˆåˆ é™¤è§†é¢‘çš„TODOï¼šå½“åˆ é™¤è§†é¢‘åå‡å»ç”¨æˆ·å¢åŠ çš„ç¡¬å¸</h3>
<ol start="5">
<li>åˆ é™¤è§†é¢‘ï¼šæ‰£å›å¥–åŠ±ç¡¬å¸ + åˆ é™¤ ES + å¼‚æ­¥æ¸…ç†é™„å±æ•°æ®</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteVideo</span><span class="params">(String videoId, String userId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1) åªèƒ½åˆ é™¤â€œè‡ªå·±çš„â€è§†é¢‘ï¼ˆä¿æŠ¤æ€§æ ¡éªŒï¼‰</span></span><br><span class="line">    <span class="type">VideoInfoPost</span> <span class="variable">vip</span> <span class="operator">=</span> videoInfoPostMapper.selectByVideoId(videoId);</span><br><span class="line">    <span class="keyword">if</span> (vip == <span class="literal">null</span> || (userId != <span class="literal">null</span> &amp;&amp; !userId.equals(vip.getUserId())))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_404);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) äº‹åŠ¡å†…åˆ çº¿ä¸Šä¸æŠ•ç¨¿</span></span><br><span class="line">    videoInfoMapper.deleteByVideoId(videoId);</span><br><span class="line">    videoInfoPostMapper.deleteByVideoId(videoId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) æ‰£å›ç¡¬å¸ï¼ˆæŒ‰â€œé¦–å‘å¥–åŠ±â€é¢åº¦å–è´Ÿæ•°ï¼‰</span></span><br><span class="line">    <span class="type">SysSettingDto</span> <span class="variable">setting</span> <span class="operator">=</span> redisComponent.getSysSettingDto();</span><br><span class="line">    userInfoService.updateCoinCountInfo(vip.getUserId(), -setting.getPostVideoCoinCount());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) åˆ é™¤ ES æ–‡æ¡£</span></span><br><span class="line">    esSearchComponent.delDoc(videoId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5) æäº¤åå¼‚æ­¥æ¸…ç†åˆ†Pã€å¼¹å¹•ã€è¯„è®ºä¸ç£ç›˜æ–‡ä»¶</span></span><br><span class="line">    executorService.execute(() -&gt; &#123;</span><br><span class="line">        <span class="comment">// 5.1 å…ˆæ‹¿æ–‡ä»¶æ¸…å•ï¼ˆç”¨äºå®šä½ç£ç›˜ç›®å½•ï¼‰</span></span><br><span class="line">        <span class="type">VideoInfoFileQuery</span> <span class="variable">q</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoFileQuery</span>();</span><br><span class="line">        q.setVideoId(videoId);</span><br><span class="line">        List&lt;VideoInfoFile&gt; parts = videoInfoFileMapper.selectList(q);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.2 åˆ è®°å½•</span></span><br><span class="line">        videoInfoFileMapper.deleteByParam(q);</span><br><span class="line">        <span class="type">VideoInfoFilePostQuery</span> <span class="variable">pq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfoFilePostQuery</span>();</span><br><span class="line">        pq.setVideoId(videoId);</span><br><span class="line">        videoInfoFilePostMapper.deleteByParam(pq);</span><br><span class="line"></span><br><span class="line">        <span class="type">VideoDanmuQuery</span> <span class="variable">dq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoDanmuQuery</span>(); dq.setVideoId(videoId);</span><br><span class="line">        videoDanmuMapper.deleteByParam(dq);</span><br><span class="line"></span><br><span class="line">        <span class="type">VideoCommentQuery</span> <span class="variable">cq</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoCommentQuery</span>(); cq.setVideoId(videoId);</span><br><span class="line">        videoCommentMapper.deleteByParam(cq);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5.3 åˆ ç‰©ç†æ–‡ä»¶</span></span><br><span class="line">        <span class="keyword">for</span> (VideoInfoFile p : parts) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                FileUtils.deleteDirectory(<span class="keyword">new</span> <span class="title class_">File</span>(appConfig.getProjectFolder() + p.getFilePath()));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;åˆ é™¤æ–‡ä»¶å¤±è´¥ï¼Œæ–‡ä»¶è·¯å¾„: &#123;&#125;&quot;</span>, p.getFilePath(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è¦ç‚¹</strong>ï¼š</p>
<ul>
<li>æ‰£å›ç¡¬å¸æ—¶é€šè¿‡ <code>UserInfoService.updateCoinCountInfo</code> ç»Ÿä¸€æ‰£å‡ã€å…œåº•ä¸ä¸ºè´Ÿï¼›</li>
<li>å¤§é‡æ¸…ç†æ“ä½œ<strong>æ”¾åˆ°å¼‚æ­¥</strong>ï¼Œé¿å…é˜»å¡æ¥å£ã€‚</li>
</ul>
<p>åœ¨UserInfoServiceä¸­</p>
<figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">	 * æ›´æ–°ç”¨æˆ·ç¡¬å¸ä¿¡æ¯</span><br><span class="line">	 * <span class="meta">@param</span> userId</span><br><span class="line">	 * <span class="meta">@param</span> changeCount</span><br><span class="line">	 * <span class="meta">@return</span></span><br><span class="line">	 */</span><br><span class="line">	<span class="built_in">Integer</span> updateCoinCountInfo(<span class="built_in">String</span> userId, <span class="built_in">Integer</span> changeCount);</span><br></pre></td></tr></table></figure>
<p>UserInfoServiceImplä¸­</p>
<ol start="6">
<li>é€šç”¨ï¼šç¡¬å¸å¢å‡æ¥å£ï¼ˆé˜²æ­¢è´Ÿæ•°ï¼‰</li>
</ol>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ›´æ–°ç”¨æˆ·ç¡¬å¸ï¼ˆæ­£æ•°=åŠ ï¼Œè´Ÿæ•°=å‡ï¼›ä¿è¯ä½™é¢ä¸ä¸ºè´Ÿï¼‰</span></span><br><span class="line"><span class="comment"> * @return å®é™…å˜åŠ¨é‡ï¼ˆæˆ–æ›´æ–°åçš„ä½™é¢ï¼Œè§† Mapper å®ç°è€Œå®šï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">Integer</span> updateCoinCountInfo(<span class="built_in">String</span> userId, <span class="built_in">Integer</span> changeCount) &#123;</span><br><span class="line">    <span class="comment">// 1) è‹¥æ˜¯æ‰£å‡ï¼Œä¿è¯ä¸ä¼šæ‰£æˆè´Ÿæ•°ï¼šæŠŠ change è°ƒæ•´ä¸ºâ€œæœ€å¤šæ‰£åˆ° 0â€</span></span><br><span class="line">    <span class="keyword">if</span> (changeCount &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        UserInfo user = getUserInfoByUserId(userId);</span><br><span class="line">        <span class="keyword">if</span> (user.getCurrentCoinCount() + changeCount &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            changeCount = <span class="params">-user.getCurrentCoinCount</span>(); <span class="comment">// æŠŠæ¬ æ‰£å˜æˆâ€œæ‰£åˆ° 0â€</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2) äº¤ç»™ Mapper åšåŸå­æ›´æ–°ï¼ˆå¯ä½¿ç”¨ UPDATE ... SET current = current + #&#123;change&#125;ï¼‰</span></span><br><span class="line">    <span class="keyword">return</span> userInfoMapper.updateCoinCountInfo(userId, changeCount);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è¦ç‚¹</strong>ï¼šé¿å…å‡ºç°<strong>è´Ÿä½™é¢</strong>ï¼›å¦‚éœ€å®¡è®¡å¯å¦è®°â€œç¡¬å¸æµæ°´è¡¨â€ï¼ŒåŒ…å«â€œåŸå› ï¼ˆæ³¨å†Œã€é¦–å‘ã€åˆ é™¤è§†é¢‘ç­‰ï¼‰â€ã€‚</p>
<p>Mapperä¸­çš„updateCoinCountInfoä¹‹å‰å·²ç»å®ç°è¿‡äº†</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1130-1024x328.png" alt="img"></p>
<h2 id="23-åˆ›ä½œä¸­å¿ƒæ•°æ®ç»Ÿè®¡">23.åˆ›ä½œä¸­å¿ƒæ•°æ®ç»Ÿè®¡</h2>
<p>ä»<strong>å®šæ—¶ä»»åŠ¡è§¦å‘ â†’ æ±‡æ€»å£å¾„ â†’ æ•°æ®æ¥æºä¸æ±‡èš â†’ æ‰¹é‡å…¥åº“/æ›´æ–° â†’ ä¸´æ—¶æ–‡ä»¶æ¸…ç†</strong></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1131-1024x432.png" alt="img"></p>
<p>å®¢æˆ·ç«¯æ¨¡å—ä¸‹taskåŒ…ä¸‹åˆ›å»ºSysTask</p>
<p>å®šæ—¶ä»»åŠ¡ SysTaskï¼ˆä¸¤ä»¶äº‹ï¼šç»Ÿè®¡ + æ¸…ç†ï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.web.task;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.config.AppConfig;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.constants.Constants;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.enums.DateTimePatternEnum;</span><br><span class="line"><span class="keyword">import</span> com.easylive.service.StatisticsInfoService;</span><br><span class="line"><span class="keyword">import</span> com.easylive.utils.DateUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SysTask</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StatisticsInfoService statisticsInfoService;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AppConfig appConfig;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// â¶ æ¯å¤© 00:00:00 ç»Ÿè®¡æ˜¨å¤©çš„æ•°æ®ï¼ˆT-1ï¼‰</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 0 0 * * ?&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">statisticsData</span><span class="params">()</span> &#123;</span><br><span class="line">        statisticsInfoService.statisticsData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// â· æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡çš„ä¸´æ—¶æ–‡ä»¶æ¸…ç†ï¼ˆæ³¨é‡Šé‡Œç»™äº†ä¸€ä¸ªæ›´åˆç†çš„æ¯æ—¥ 03:00ï¼‰</span></span><br><span class="line">    <span class="comment">// å»ºè®®æœ€ç»ˆæ”¹ä¸ºï¼š0 0 3 * * ?</span></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;0 */1 * * * ?&quot;)</span> <span class="comment">// 0 0 3 * * ?</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delTempFile</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// temp ç›®å½•ï¼š&#123;projectFolder&#125;/file/temp</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">tempFolderName</span> <span class="operator">=</span> appConfig.getProjectFolder() + Constants.FILE_FOLDER + Constants.FILE_FOLDER_TEMP;</span><br><span class="line">        <span class="type">File</span> <span class="variable">folder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(tempFolderName);</span><br><span class="line">        File[] listFile = folder.listFiles();</span><br><span class="line">        <span class="keyword">if</span> (listFile == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¡ç®—â€œä¸¤å¤©å‰â€çš„æ—¥æœŸï¼ˆyyyyMMddï¼‰ï¼Œä½äºç­‰äºè¯¥æ—¥æœŸçš„ç›®å½•å…¨éƒ¨æ¸…ç†</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">twoDaysAgo</span> <span class="operator">=</span> DateUtil.format(DateUtil.getDayAgo(<span class="number">2</span>), DateTimePatternEnum.YYYYMMDD.getPattern()).toLowerCase();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">dayInt</span> <span class="operator">=</span> Integer.parseInt(twoDaysAgo);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (File file : listFile) &#123;</span><br><span class="line">            <span class="comment">// temp ç›®å½•æŒ‰â€œyyyyMMddâ€å‘½åï¼Œè¿™é‡ŒæŠŠç›®å½•åè½¬ int æ¥æ¯”è¾ƒ</span></span><br><span class="line">            <span class="type">Integer</span> <span class="variable">fileDate</span> <span class="operator">=</span> Integer.parseInt(file.getName());</span><br><span class="line">            <span class="keyword">if</span> (fileDate &lt;= dayInt) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    FileUtils.deleteDirectory(file);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;åˆ é™¤ä¸´æ—¶æ–‡ä»¶å¤±è´¥&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è¦ç‚¹</strong>ï¼š</p>
<ul>
<li>ç»Ÿè®¡å£å¾„<strong>å¯¹æ˜¨å¤©</strong>ï¼ˆé¿å…â€œè¾¹å†™è¾¹è¯»â€çš„å½“å¤©æŠ–åŠ¨ï¼‰ã€‚</li>
<li>æ¸…ç†æ”¹ä¸º<strong>æ¯æ—¥ä½å³°</strong>æ‰§è¡Œæ›´åˆç†ï¼ˆ03:00ï¼‰ï¼Œé¿å…é¢‘ç¹æ‰«æç›®å½•ã€‚</li>
</ul>
<p>åœ¨StatisticsInfoServiceä¸­</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å®šæ—¶ä»»åŠ¡ï¼šç»Ÿè®¡æ•°æ®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">statisticsData</span>()</span>;</span><br></pre></td></tr></table></figure>
<p>StatisticsInfoServiceImplä¸­</p>
<p>æ ¸å¿ƒç»Ÿè®¡é€»è¾‘ <code>StatisticsInfoServiceImpl.statisticsData()</code></p>
<p>ç»Ÿä¸€æŠŠ T-1 çš„æ•°æ®æ±‡æ€»æˆã€Œä½œè€…ç»´åº¦ã€çš„<strong>æ—¥ç»Ÿè®¡</strong>ï¼Œæœ€ç»ˆè½åˆ° <code>statistics_info</code>ï¼Œè‹¥å·²å­˜åœ¨åˆ™<strong>æ›´æ–°</strong>ã€‚</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public <span class="literal">void</span> statisticsData() &#123;</span><br><span class="line">    List&lt;StatisticsInfo&gt; statisticsInfoList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="regexp">// 1) ç»Ÿè®¡æ—¥æœŸï¼šæ˜¨å¤©ï¼ˆyyyy-MM-ddï¼‰</span></span><br><span class="line"><span class="regexp">    final String statisticsDate = DateUtil.getBeforeDayDate(1);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    /* ========== A. æ’­æ”¾é‡ï¼šæ¥è‡ª Redis çš„â€œæŒ‰å¤©æ’­æ”¾è®¡æ•°â€ ========== */</span></span><br><span class="line"><span class="regexp">    //</span> Redis ä¸­æ˜¨å¤©çš„â€œè§†é¢‘çº§æ’­æ”¾è®¡æ•°â€<span class="built_in">Map</span>ï¼š</span><br><span class="line">    <span class="regexp">// key å½¢å¦‚  video:play:count:YYYY-MM-DD:videoId</span></span><br><span class="line"><span class="regexp">    //</span> value ä¸ºè¯¥è§†é¢‘åœ¨å½“å¤©çš„æ’­æ”¾æ¬¡æ•°</span><br><span class="line">    <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, Integer&gt; videoPlayCountMap = redisComponent.getVideoPlayCount(statisticsDate);</span><br><span class="line"></span><br><span class="line">    <span class="regexp">// æå–å‡ºæ‰€æœ‰ videoIdï¼ˆä» key çš„æœ€åä¸€ä¸ªå†’å·åæˆªå–ï¼‰</span></span><br><span class="line"><span class="regexp">    List&lt;String&gt; playVideoKeys = new ArrayList&lt;&gt;(videoPlayCountMap.keySet());</span></span><br><span class="line"><span class="regexp">    playVideoKeys = playVideoKeys.stream()</span></span><br><span class="line"><span class="regexp">        .map(item -&gt; item.substring(item.lastIndexOf(&quot;:&quot;) + 1))</span></span><br><span class="line"><span class="regexp">        .collect(Collectors.toList());</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    //</span> æŸ¥å‡ºè¿™äº›è§†é¢‘å¯¹åº”çš„ä½œè€…ï¼ˆvideo_info é‡Œæœ‰ user_idï¼‰</span><br><span class="line">    VideoInfoQuery videoInfoQuery = <span class="keyword">new</span> VideoInfoQuery();</span><br><span class="line">    videoInfoQuery.setVideoIdArray(playVideoKeys.toArray(<span class="keyword">new</span> <span class="built_in">String</span>[<span class="number">0</span>]));</span><br><span class="line">    List&lt;VideoInfo&gt; videoInfoList = videoInfoMapper.selectList(videoInfoQuery);</span><br><span class="line"></span><br><span class="line">    <span class="regexp">// ä»¥â€œä½œè€…IDâ€åˆ†ç»„ï¼ŒæŠŠå„è‡ªæ‰€æœ‰è§†é¢‘çš„æ’­æ”¾æ¬¡æ•°åŠ æ€»ï¼ˆä½œè€…ç»´åº¦çš„æ’­æ”¾é‡ï¼‰</span></span><br><span class="line"><span class="regexp">    Map&lt;String, Integer&gt; videoCountMap = videoInfoList.stream()</span></span><br><span class="line"><span class="regexp">        .collect(Collectors.groupingBy(</span></span><br><span class="line"><span class="regexp">            VideoInfo::getUserId,</span></span><br><span class="line"><span class="regexp">            Collectors.summingInt(item -&gt; &#123;</span></span><br><span class="line"><span class="regexp">                Integer count = videoPlayCountMap.get(</span></span><br><span class="line"><span class="regexp">                    Constants.REDIS_KEY_VIDEO_PLAY_COUNT + statisticsDate + &quot;:&quot; + item.getVideoId());</span></span><br><span class="line"><span class="regexp">                return count == null ? 0 : count;</span></span><br><span class="line"><span class="regexp">            &#125;)</span></span><br><span class="line"><span class="regexp">        ));</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    //</span> ç»„è£…å…¥åº“å¯¹è±¡ï¼šdata_type=PLAY(<span class="number">0</span>)</span><br><span class="line">    videoCountMap.forEach<span class="function"><span class="params">((userId, sumPlay) -&gt; &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        StatisticsInfo s = <span class="keyword">new</span> StatisticsInfo();</span></span></span><br><span class="line"><span class="params"><span class="function">        s.setStatisticsDate(statisticsDate);</span></span></span><br><span class="line"><span class="params"><span class="function">        s.setUserId(userId);</span></span></span><br><span class="line"><span class="params"><span class="function">        s.setDataType(StatisticsTypeEnum.PLAY.getType());</span></span></span><br><span class="line"><span class="params"><span class="function">        s.setStatisticsCount(sumPlay);</span></span></span><br><span class="line"><span class="params"><span class="function">        statisticsInfoList.add(s);</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;)</span>;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    /* ========== <span class="title">B</span>. ç²‰ä¸ï¼šå½“å¤©æ–°å¢ç²‰ä¸æ•°ï¼ˆè¢«å…³æ³¨è€…ç»´åº¦ï¼‰ ========== */</span></span><br><span class="line"><span class="function">    <span class="title">List</span>&lt;<span class="title">StatisticsInfo</span>&gt; <span class="title">fansDataList</span> = <span class="title">this</span>.<span class="title">statisticsInfoMapper</span>.<span class="title">selectStatisticsFans</span><span class="params">(statisticsDate)</span>;</span></span><br><span class="line"><span class="function">    <span class="title">for</span> <span class="params">(StatisticsInfo s : fansDataList)</span> &#123;</span></span><br><span class="line"><span class="function">        <span class="title">s</span>.<span class="title">setStatisticsDate</span><span class="params">(statisticsDate)</span>;</span></span><br><span class="line"><span class="function">        <span class="title">s</span>.<span class="title">setDataType</span><span class="params">(StatisticsTypeEnum.FANS.getType())</span>; // 1</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">    <span class="title">statisticsInfoList</span>.<span class="title">addAll</span><span class="params">(fansDataList)</span>;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    /* ========== <span class="title">C</span>. è¯„è®ºï¼šå½“å¤©æ”¶åˆ°çš„è¯„è®ºæ€»é‡ï¼ˆä½œè€…ç»´åº¦ï¼‰ ========== */</span></span><br><span class="line"><span class="function">    <span class="title">List</span>&lt;<span class="title">StatisticsInfo</span>&gt; <span class="title">commentDataList</span> = <span class="title">this</span>.<span class="title">statisticsInfoMapper</span>.<span class="title">selectStatisticsComment</span><span class="params">(statisticsDate)</span>;</span></span><br><span class="line"><span class="function">    <span class="title">for</span> <span class="params">(StatisticsInfo s : commentDataList)</span> &#123;</span></span><br><span class="line"><span class="function">        <span class="title">s</span>.<span class="title">setStatisticsDate</span><span class="params">(statisticsDate)</span>;</span></span><br><span class="line"><span class="function">        <span class="title">s</span>.<span class="title">setDataType</span><span class="params">(StatisticsTypeEnum.COMMENT.getType())</span>; // 5</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">    <span class="title">statisticsInfoList</span>.<span class="title">addAll</span><span class="params">(commentDataList)</span>;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    /* ========== <span class="title">D</span>. å…¶å®ƒäº’åŠ¨ï¼šç‚¹èµ/æ”¶è—/æŠ•å¸ï¼ˆä½œè€…ç»´åº¦ï¼‰ ========== */</span></span><br><span class="line"><span class="function">    <span class="title">List</span>&lt;<span class="title">StatisticsInfo</span>&gt; <span class="title">others</span> = <span class="title">this</span>.<span class="title">statisticsInfoMapper</span>.<span class="title">selectStatisticsInfo</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        statisticsDate,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">new</span> Integer[]&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            UserActionTypeEnum.VIDEO_LIKE.getType(),    <span class="regexp">// ç‚¹èµ</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">            UserActionTypeEnum.VIDEO_COIN.getType(),    //</span> æŠ•å¸</span></span></span><br><span class="line"><span class="params"><span class="function">            UserActionTypeEnum.VIDEO_COLLECT.getType()  <span class="regexp">// æ”¶è—</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">        &#125;);</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function"></span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">    //</span> å°† user_action çš„ action_typeï¼ˆäº‹ä»¶æšä¸¾ï¼‰è½¬æ¢ä¸ºç»Ÿè®¡å£å¾„æšä¸¾ï¼ˆStatisticsTypeEnumï¼‰</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">for</span> (StatisticsInfo s : others) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        s.setStatisticsDate(statisticsDate);</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">if</span> (UserActionTypeEnum.VIDEO_LIKE.getType().equals(s.getDataType())) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            s.setDataType(StatisticsTypeEnum.LIKE.getType());        <span class="regexp">// 2</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">        &#125; else if (UserActionTypeEnum.VIDEO_COLLECT.getType().equals(s.getDataType())) &#123;</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">            s.setDataType(StatisticsTypeEnum.COLLECTION.getType());  //</span> <span class="number">3</span></span></span></span><br><span class="line"><span class="params"><span class="function">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (UserActionTypeEnum.VIDEO_COIN.getType().equals(s.getDataType())) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">            s.setDataType(StatisticsTypeEnum.COIN.getType());        <span class="regexp">// 4</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">        &#125;</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">    &#125;</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">    statisticsInfoList.addAll(others);</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function"></span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">    /* ========== E. æ‰¹é‡ upsertï¼šå½“å¤©+ä½œè€…+æ•°æ®ç±»å‹ å”¯ä¸€ ========== */</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">    this.statisticsInfoMapper.insertOrUpdateBatch(statisticsInfoList);</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">&#125;</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function"></span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">/** ä» Redis å–å‡ºâ€œæŸå¤©æ‰€æœ‰è§†é¢‘çš„æ’­æ”¾è®¡æ•°â€Map</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function"> *  key:  video:play:count:YYYY-MM-DD:videoId</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function"> *  val:  å½“å¤©æ’­æ”¾æ•°</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function"> */</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">public Map&lt;String, Integer&gt; getVideoPlayCount(String date) &#123;</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">    Map&lt;String, Integer&gt; map = redisUtils.getBatch(Constants.REDIS_KEY_VIDEO_PLAY_COUNT + date);</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">    return map;</span></span></span></span><br><span class="line"><span class="regexp"><span class="params"><span class="function">&#125;</span></span></span></span><br></pre></td></tr></table></figure>
<p><strong>å£å¾„è¯´æ˜</strong>ï¼š</p>
<ul>
<li><strong>æ’­æ”¾é‡</strong>ï¼šä» Redis çš„ T-1ã€Œè§†é¢‘çº§è®¡æ•°ã€èšåˆåˆ°<strong>ä½œè€…ç»´åº¦</strong>ï¼›è¿™æ ·é¿å…é€æ¡æ‰«æå·¨å¤§è¡Œä¸ºè¡¨ã€‚</li>
<li><strong>ç²‰ä¸/è¯„è®º</strong>ï¼šç›´æ¥æŒ‰ T-1 çš„æ—¶é—´æ¡ä»¶åœ¨ DB ç»Ÿè®¡ï¼ˆåˆ†ç»„å£å¾„è§ä¸‹æ–‡ XMLï¼‰ã€‚</li>
<li><strong>ç‚¹èµ/æ”¶è—/æŠ•å¸</strong>ï¼šæ¥è‡ª <code>user_action</code> çš„ T-1 æ•°æ®ï¼ŒæŒ‰ <code>video_user_id</code>ï¼ˆè¢«æ“ä½œçš„è§†é¢‘ä½œè€…ï¼‰åˆ†ç»„å³å¯ã€‚</li>
<li>æœ€ç»ˆå†™å…¥ <code>statistics_info</code>ï¼Œä»¥ <code>(statistics_date, user_id, data_type)</code> ä½œä¸ºä¸»é”®<strong>å»é‡/æ›´æ–°</strong>ã€‚</li>
</ul>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1132-1024x540.png" alt="img"></p>
<p>è¿™é‡Œéœ€è¦StatisticsTypeEnum</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">enums</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">StatisticsTypeEnum</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">PLAY</span>(<span class="number">0</span>, <span class="string">&quot;æ’­æ”¾é‡&quot;</span>),</span><br><span class="line">    <span class="title function_">FANS</span>(<span class="number">1</span>, <span class="string">&quot;ç²‰ä¸&quot;</span>),</span><br><span class="line">    <span class="title function_">LIKE</span>(<span class="number">2</span>, <span class="string">&quot;ç‚¹èµ&quot;</span>),</span><br><span class="line">    <span class="title function_">COLLECTION</span>(<span class="number">3</span>, <span class="string">&quot;æ”¶è—&quot;</span>),</span><br><span class="line">    <span class="title function_">COIN</span>(<span class="number">4</span>, <span class="string">&quot;æŠ•å¸&quot;</span>),</span><br><span class="line">    <span class="title function_">COMMENT</span>(<span class="number">5</span>, <span class="string">&quot;è¯„è®º&quot;</span>),</span><br><span class="line">    <span class="title function_">DANMU</span>(<span class="number">6</span>, <span class="string">&quot;å¼¹å¹•&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> <span class="keyword">type</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> desc;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">StatisticsTypeEnum</span>(<span class="title class_">Integer</span> <span class="keyword">type</span>, <span class="title class_">String</span> desc) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">type</span> = <span class="keyword">type</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">desc</span> = desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="title class_">StatisticsTypeEnum</span> <span class="title function_">getByType</span>(<span class="params"><span class="title class_">Integer</span> <span class="keyword">type</span></span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="title class_">StatisticsTypeEnum</span> item : <span class="title class_">StatisticsTypeEnum</span>.<span class="title function_">values</span>()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (item.<span class="title function_">getType</span>().<span class="title function_">equals</span>(<span class="keyword">type</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> item;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getType</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">type</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getDesc</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setDesc</span>(<span class="params"><span class="title class_">String</span> desc</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">desc</span> = desc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨DateUtil</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title class_">String</span> <span class="title function_">getBeforeDayDate</span>(<span class="params"><span class="title class_">Integer</span> day</span>) &#123;</span><br><span class="line">       <span class="title class_">Calendar</span> calendar = <span class="title class_">Calendar</span>.<span class="title function_">getInstance</span>();</span><br><span class="line">       calendar.<span class="title function_">add</span>(<span class="title class_">Calendar</span>.<span class="property">DAY_OF_YEAR</span>, -day);</span><br><span class="line">       <span class="keyword">return</span> <span class="title function_">format</span>(calendar.<span class="title function_">getTime</span>(), <span class="title class_">DateTimePatternEnum</span>.<span class="property">YYYY_MM_DD</span>.<span class="title function_">getPattern</span>());</span><br><span class="line">   &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title class_">Date</span> <span class="title function_">getDayAgo</span>(<span class="params"><span class="title class_">Integer</span> day</span>) &#123;</span><br><span class="line">       <span class="title class_">Calendar</span> calendar = <span class="title class_">Calendar</span>.<span class="title function_">getInstance</span>();</span><br><span class="line">       calendar.<span class="title function_">add</span>(<span class="title class_">Calendar</span>.<span class="property">DAY_OF_YEAR</span>, -day);</span><br><span class="line">       <span class="keyword">return</span> calendar.<span class="title function_">getTime</span>();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨RedisComponent</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** æŒ‰â€œå¤©â€ç»´åº¦ç´¯è®¡æ’­æ”¾ï¼Œç”¨äºæ•°æ®çœ‹æ¿/è¶‹åŠ¿ */</span></span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Integer</span>&gt; getVideoPlayCount(<span class="built_in">String</span> <span class="built_in">date</span>) &#123;</span><br><span class="line">       <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Integer</span>&gt; videoPlayMap = redisUtils.getBatch(Constants.REDIS_KEY_VIDEO_PLAY_COUNT + <span class="built_in">date</span>);</span><br><span class="line">       <span class="keyword">return</span> videoPlayMap;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1134-1024x325.png" alt="img"></p>
<p>StatisticsInfoMapperä¸­</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®StatisticsDateè·å–ç²‰ä¸æ•°æ®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">List&lt;T&gt; selectStatisticsFans(<span class="meta">@Param</span>(<span class="string">&quot;statisticsDate&quot;</span>) <span class="keyword">String</span> statisticsDate);</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®StatisticsDateè·å–è¯„è®ºæ•°æ®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">List&lt;T&gt; selectStatisticsComment(<span class="meta">@Param</span>(<span class="string">&quot;statisticsDate&quot;</span>) <span class="keyword">String</span> statisticsDate);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®StatisticsDateè·å–å…¶ä»–æ•°æ®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">List&lt;T&gt; selectStatisticsInfo(<span class="meta">@Param</span>(<span class="string">&quot;statisticsDate&quot;</span>) <span class="keyword">String</span> statisticsDate,</span><br><span class="line">							 <span class="meta">@Param</span>(<span class="string">&quot;actionTypeArray&quot;</span>) Integer[] actionTypeArray);</span><br></pre></td></tr></table></figure>
<p>StatisticsInfoMapper.xml</p>
<p>Mapper ç»Ÿè®¡ SQLï¼ˆé€å¥è§£é‡Š &amp; å°ä¼˜åŒ–å»ºè®®ï¼‰</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!-- â¶ æ˜¨å¤©æ–°å¢ç²‰ä¸ï¼šè¢«å…³æ³¨è€…ç»´åº¦ï¼ˆfocus_user_idï¼‰ï¼Œèšåˆä¸ºâ€œä¸€ä¸ªä½œè€…çš„æ–°å¢ç²‰ä¸æ•°â€ --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectStatisticsFans&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;base_result_map&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  select focus_user_id user_id,</span></span><br><span class="line"><span class="language-xml">         count(1)      statistics_count</span></span><br><span class="line"><span class="language-xml">  from   user_focus</span></span><br><span class="line"><span class="language-xml">  where  &lt;![CDATA[ DATE_FORMAT(focus_time,&#x27;%Y-%m-%d&#x27;) = #</span><span class="template-variable">&#123;statisticsDate&#125;</span><span class="language-xml"> ]]&gt;</span></span><br><span class="line"><span class="language-xml">  group by focus_user_id</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="comment">&lt;!-- â· æ˜¨å¤©æ”¶åˆ°çš„è¯„è®ºæ•°ï¼šä½œè€…ç»´åº¦ï¼ˆvideo_user_idï¼‰</span></span></span><br><span class="line"><span class="comment"><span class="language-xml">     ï¼ˆå¤‡æ³¨ï¼šå½“å‰ SQL group by video_idï¼Œä¼šå¾—åˆ°â€œæ¯ä¸ªè§†é¢‘çš„è¯„è®ºæ•°â€ã€‚</span></span></span><br><span class="line"><span class="comment"><span class="language-xml">       è‹¥å¸Œæœ›â€œä½œè€…æ‰€æœ‰è§†é¢‘çš„è¯„è®ºæ•°æ±‡æ€»â€ï¼Œå»ºè®® group by video_user_idï¼‰ --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectStatisticsComment&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;base_result_map&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  select video_user_id user_id,</span></span><br><span class="line"><span class="language-xml">         count(1)      statistics_count</span></span><br><span class="line"><span class="language-xml">  from   video_comment</span></span><br><span class="line"><span class="language-xml">  where  &lt;![CDATA[ DATE_FORMAT(post_time,&#x27;%Y-%m-%d&#x27;) = #</span><span class="template-variable">&#123;statisticsDate&#125;</span><span class="language-xml"> ]]&gt;</span></span><br><span class="line"><span class="language-xml">  group by video_id</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="comment">&lt;!-- â¸ æ˜¨å¤©çš„ç‚¹èµ/æ”¶è—/æŠ•å¸ï¼šä½œè€…ç»´åº¦ï¼ˆvideo_user_idï¼‰ï¼Œå¹¶ä¿ç•™ action_type æ–¹ä¾¿ä¸Šå±‚æ˜ å°„ --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectStatisticsInfo&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;base_result_map&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  select video_user_id   user_id,</span></span><br><span class="line"><span class="language-xml">         action_type     data_type,</span></span><br><span class="line"><span class="language-xml">         sum(action_count) statistics_count</span></span><br><span class="line"><span class="language-xml">  from   user_action</span></span><br><span class="line"><span class="language-xml">  where  &lt;![CDATA[ DATE_FORMAT(action_time,&#x27;%Y-%m-%d&#x27;) = #</span><span class="template-variable">&#123;statisticsDate&#125;</span><span class="language-xml"> ]]&gt;</span></span><br><span class="line"><span class="language-xml">     and action_type in</span></span><br><span class="line"><span class="language-xml">       (<span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;actionTypeArray&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span> <span class="attr">item</span>=<span class="string">&quot;item&quot;</span>&gt;</span>#</span><span class="template-variable">&#123;item&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">foreach</span>&gt;</span>)</span></span><br><span class="line"><span class="language-xml">  group by video_user_id, action_type</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1133-1024x344.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1135-1024x1017.png" alt="img"></p>
<p>æµ‹è¯•ï¼šæ•°æ®ç»Ÿè®¡è¡¨èƒ½æˆåŠŸæ‹¿åˆ°ä¿¡æ¯</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1127.png" alt="img"></p>
<h2 id="24-åˆ›ä½œä¸­å¿ƒå‰ç«¯é¡µé¢å›æ˜¾æ•°æ®ç»Ÿè®¡">24.åˆ›ä½œä¸­å¿ƒå‰ç«¯é¡µé¢å›æ˜¾æ•°æ®ç»Ÿè®¡</h2>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1136-1024x255.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1137-1024x634.png" alt="img"></p>
<p>ä¸Šä¸€å°èŠ‚æˆ‘ä»¬åªå®Œæˆäº†æ¥å£ï¼Œè¦æƒ³çœ‹æ•ˆæœåªèƒ½åœ¨æ•°æ®åº“é‡Œçœ‹ï¼Œè¿™ä¸€å°èŠ‚æˆ‘ä»¬åœ¨å‰ç«¯é¡µé¢ä¹Ÿèƒ½æ˜¾ç¤ºæ•°æ®ç»Ÿè®¡</p>
<p>åœ¨å®¢æˆ·ç«¯æ¨¡å—åˆ›å»ºUCenterstatisticsController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.web.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.dto.TokenUserInfoDto;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.po.StatisticsInfo;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.query.StatisticsInfoQuery;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.vo.ResponseVO;</span><br><span class="line"><span class="keyword">import</span> com.easylive.service.StatisticsInfoService;</span><br><span class="line"><span class="keyword">import</span> com.easylive.utils.DateUtil;</span><br><span class="line"><span class="keyword">import</span> com.easylive.web.annotation.GlobalInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.annotation.Validated;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/ucenter&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UCenterstatisticsController</span> <span class="keyword">extends</span> <span class="title class_">ABaseController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StatisticsInfoService statisticsInfoService;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * â‘  æ˜¨æ—¥ç»Ÿè®¡ + å½“å‰ç´¯è®¡æ€»é‡</span></span><br><span class="line"><span class="comment">     * - æ˜¨æ—¥ï¼šç›´æ¥è¯»ç»Ÿè®¡è¡¨ statistics_infoï¼ˆT-1 çš„ç¦»çº¿æ±‡æ€»ï¼‰</span></span><br><span class="line"><span class="comment">     * - ç´¯è®¡ï¼šç›´æ¥ sum(video_info) ä¸­å„è®¡æ•°å­—æ®µï¼›ç²‰ä¸æ•°å•ç‹¬æŸ¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/getActualTimeStatisticsInfo&quot;)</span></span><br><span class="line">    <span class="meta">@GlobalInterceptor</span> <span class="comment">// éœ€ç™»å½•ï¼ˆä» token ä¸­å– userIdï¼‰</span></span><br><span class="line">    <span class="keyword">public</span> ResponseVO <span class="title function_">getActualTimeStatisticsInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// æ˜¨æ—¥ yyyy-MM-ddï¼ˆT-1ï¼‰</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">preDate</span> <span class="operator">=</span> DateUtil.getBeforeDayDate(<span class="number">1</span>);</span><br><span class="line">        <span class="type">TokenUserInfoDto</span> <span class="variable">tokenUserInfoDto</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1) æ˜¨æ—¥å„æŒ‡æ ‡ï¼šä»ç»Ÿè®¡è¡¨æŒ‰â€œæ—¥æœŸ+ä½œè€…â€æŸ¥</span></span><br><span class="line">        <span class="type">StatisticsInfoQuery</span> <span class="variable">param</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StatisticsInfoQuery</span>();</span><br><span class="line">        param.setStatisticsDate(preDate);</span><br><span class="line">        param.setUserId(tokenUserInfoDto.getUserId());</span><br><span class="line">        List&lt;StatisticsInfo&gt; preDayData = statisticsInfoService.findListByParam(param);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç»„è£…æˆ dataType -&gt; count çš„ Mapï¼ˆè‹¥åŒé”®å†²çªå–åè€…ï¼‰</span></span><br><span class="line">        Map&lt;Integer, Integer&gt; preDayDataMap = preDayData.stream()</span><br><span class="line">            .collect(Collectors.toMap(StatisticsInfo::getDataType,</span><br><span class="line">                                      StatisticsInfo::getStatisticsCount,</span><br><span class="line">                                      (item1, item2) -&gt; item2));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2) ç´¯è®¡æ€»é‡ï¼šsum(video_info) + ç²‰ä¸æ•°</span></span><br><span class="line">        Map&lt;String, Integer&gt; totalCountInfo =</span><br><span class="line">            statisticsInfoService.getStatisticsInfoActualTime(tokenUserInfoDto.getUserId());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3) èšåˆè¿”å›</span></span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        result.put(<span class="string">&quot;preDayData&quot;</span>, preDayDataMap);</span><br><span class="line">        result.put(<span class="string">&quot;totalCountInfo&quot;</span>, totalCountInfo);</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * â‘¡ æœ€è¿‘ 7 å¤©è¶‹åŠ¿ï¼ˆæŸä¸€ä¸ª dataTypeï¼Œå¦‚ï¼šæ’­æ”¾/ç‚¹èµâ€¦ï¼‰</span></span><br><span class="line"><span class="comment">     * - ç”Ÿæˆè¿‡å» 7 å¤©çš„æ—¥æœŸåˆ—è¡¨</span></span><br><span class="line"><span class="comment">     * - æŸ¥è¯¢ [èµ·å§‹æ—¥, ç»“æŸæ—¥] å†…è¯¥ä½œè€…è¯¥ dataType çš„ç»Ÿè®¡</span></span><br><span class="line"><span class="comment">     * - ä»¥æ—¥æœŸä¸ºé”®è¡¥é½ç¼ºå¤±é¡¹ï¼ˆç½® 0ï¼‰ï¼Œå¹¶æŒ‰æ—¥æœŸå‡åºè¿”å›</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/getWeekStatisticsInfo&quot;)</span></span><br><span class="line">    <span class="meta">@GlobalInterceptor</span></span><br><span class="line">    <span class="keyword">public</span> ResponseVO <span class="title function_">getWeekStatisticsInfo</span><span class="params">(Integer dataType)</span> &#123;</span><br><span class="line">        <span class="type">TokenUserInfoDto</span> <span class="variable">tokenUserInfoDto</span> <span class="operator">=</span> getTokenUserInfoDto();</span><br><span class="line">        <span class="comment">// ç”Ÿæˆè¿‡å» 7 å¤©çš„ yyyy-MM-dd åˆ—è¡¨ï¼ˆä¸å«â€œä»Šå¤©â€ï¼‰</span></span><br><span class="line">        List&lt;String&gt; dateList = DateUtil.getBeforeDates(<span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŸ¥è¯¢è¯¥ä½œè€…ã€è¯¥ dataTypeã€åœ¨èµ·æ­¢æ—¥æœŸå†…çš„ç»Ÿè®¡</span></span><br><span class="line">        <span class="type">StatisticsInfoQuery</span> <span class="variable">param</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StatisticsInfoQuery</span>();</span><br><span class="line">        param.setDataType(dataType);</span><br><span class="line">        param.setUserId(tokenUserInfoDto.getUserId());</span><br><span class="line">        param.setStatisticsDateStart(dateList.get(<span class="number">0</span>));</span><br><span class="line">        param.setStatisticsDateEnd(dateList.get(dateList.size() - <span class="number">1</span>));</span><br><span class="line">        param.setOrderBy(<span class="string">&quot;statistics_date asc&quot;</span>);</span><br><span class="line"></span><br><span class="line">        List&lt;StatisticsInfo&gt; statisticsInfoList = statisticsInfoService.findListByParam(param);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ä»¥â€œæ—¥æœŸâ€ä½œä¸º keyï¼Œä¾¿äºè¡¥é›¶</span></span><br><span class="line">        Map&lt;String, StatisticsInfo&gt; dataMap = statisticsInfoList.stream()</span><br><span class="line">            .collect(Collectors.toMap(StatisticsInfo::getStatisticsDate,</span><br><span class="line">                                      Function.identity(),</span><br><span class="line">                                      (data1, data2) -&gt; data2));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŒ‰æ—¥æœŸåˆ—è¡¨é¡ºåºè¡¥é½ç¼ºå¤±ï¼ˆç½® 0ï¼‰ï¼Œä¿æŒé•¿åº¦=7ï¼Œé¡ºåº=å‡åº</span></span><br><span class="line">        List&lt;StatisticsInfo&gt; resultDataList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String date : dateList) &#123;</span><br><span class="line">            <span class="type">StatisticsInfo</span> <span class="variable">dataItem</span> <span class="operator">=</span> dataMap.get(date);</span><br><span class="line">            <span class="keyword">if</span> (dataItem == <span class="literal">null</span>) &#123;</span><br><span class="line">                dataItem = <span class="keyword">new</span> <span class="title class_">StatisticsInfo</span>();</span><br><span class="line">                dataItem.setStatisticsCount(<span class="number">0</span>);</span><br><span class="line">                dataItem.setStatisticsDate(date);</span><br><span class="line">            &#125;</span><br><span class="line">            resultDataList.add(dataItem);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(resultDataList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨DateUtilä¸­</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> public static List&lt;String&gt; getBeforeDates(Integer beforeDays) &#123;</span><br><span class="line">    // ä»¥â€œä»Šå¤©â€ä¸ºåŸºç‚¹ï¼Œå‘å‰å– N å¤©ï¼ˆä¸åŒ…å«ä»Šå¤©ï¼‰</span><br><span class="line">    LocalDate endDate <span class="operator">=</span> LocalDate.now()<span class="comment">;</span></span><br><span class="line">    List&lt;String&gt; dateList <span class="operator">=</span> new ArrayList&lt;&gt;()<span class="comment">;</span></span><br><span class="line">    DateTimeFormatter formatter <span class="operator">=</span> DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd&quot;</span>)<span class="comment">;</span></span><br><span class="line">    for (int i <span class="operator">=</span> beforeDays<span class="comment">; i &gt; 0; i--) &#123;</span></span><br><span class="line">        // ä»Šå¤©-<span class="number">1</span>ã€-<span class="number">2</span>â€¦æ ¼å¼åŒ–ä¸º yyyy-MM-dd</span><br><span class="line">        dateList.add(endDate.minusDays(i).format(formatter))<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">    return dateList<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>StatisticsInfoServiceä¸­</p>
<figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * è·å–å®æ—¶ç»Ÿè®¡æ•°æ®</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="title class_">Map</span><span class="operator">&lt;</span><span class="title class_">String</span>, <span class="title class_">Integer</span><span class="operator">&gt;</span> <span class="title function_">getStatisticsInfoActualTime</span>(<span class="title class_">String</span> <span class="variable">userId</span>);</span><br></pre></td></tr></table></figure>
<p>StatisticsInfoServiceImplä¸­</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è·å–â€œç´¯è®¡æ€»é‡â€</span></span><br><span class="line"><span class="comment"> * - play/like/danmu/comment/coin/collectï¼šsum(video_info.*_count)</span></span><br><span class="line"><span class="comment"> * - userCountï¼šä½œè€…ç²‰ä¸æ€»æ•°ï¼ˆè‹¥ userId ä¸ºç©ºåˆ™ç»Ÿè®¡ç”¨æˆ·æ€»é‡ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Override</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Integer</span>&gt; getStatisticsInfoActualTime(<span class="built_in">String</span> userId) &#123;</span><br><span class="line">    <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Integer</span>&gt; result = statisticsInfoMapper.selectTotalCountInfo(userId);</span><br><span class="line">    <span class="keyword">if</span> (!StringTools.isEmpty(userId)) &#123;</span><br><span class="line">        <span class="comment">// æˆ‘ä½œä¸ºä½œè€…çš„ç²‰ä¸æ•°</span></span><br><span class="line">        result.put(<span class="string">&quot;userCount&quot;</span>, userFocusMapper.selectFansCount(userId));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å…œåº•ï¼šå–ç³»ç»Ÿç”¨æˆ·æ€»æ•°</span></span><br><span class="line">        result.put(<span class="string">&quot;userCount&quot;</span>, userInfoMapper.selectCount(<span class="literal">new</span> UserInfoQuery()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>StatisticsInfoMapperä¸­</p>
<figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * æŸ¥è¯¢æ€»æ•°æ®</span><br><span class="line"> * <span class="meta">@param</span> userId</span><br><span class="line"> * <span class="meta">@return</span></span><br><span class="line"> */</span><br><span class="line">Map&lt;<span class="built_in">String</span>, <span class="built_in">Integer</span>&gt; selectTotalCountInfo(<span class="meta">@Param</span>(<span class="string">&quot;userId&quot;</span>) <span class="built_in">String</span> userId);</span><br></pre></td></tr></table></figure>
<p>StatisticsInfoMapper.xmlä¸­</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">	&lt;!<span class="comment">-- ç»Ÿè®¡â€œç´¯è®¡æ€»é‡â€ï¼ˆä½œè€…ç»´åº¦ï¼‰ --&gt;</span></span><br><span class="line">&lt;<span class="keyword">select</span> id=&quot;selectTotalCountInfo&quot; resultType=&quot;java.util.Map&quot;&gt;</span><br><span class="line">  <span class="keyword">select</span></span><br><span class="line">    ifnull(sum(play_count),   <span class="number">0</span>) playCount,   <span class="comment">-- ç´¯è®¡æ’­æ”¾</span></span><br><span class="line">    ifnull(sum(like_count),   <span class="number">0</span>) likeCount,   <span class="comment">-- ç´¯è®¡ç‚¹èµ</span></span><br><span class="line">    ifnull(sum(danmu_count),  <span class="number">0</span>) danmuCount,  <span class="comment">-- ç´¯è®¡å¼¹å¹•</span></span><br><span class="line">    ifnull(sum(comment_count),<span class="number">0</span>) commentCount,<span class="comment">-- ç´¯è®¡è¯„è®º</span></span><br><span class="line">    ifnull(sum(coin_count),   <span class="number">0</span>) coinCount,   <span class="comment">-- ç´¯è®¡æŠ•å¸</span></span><br><span class="line">    ifnull(sum(collect_count),<span class="number">0</span>) collectCount <span class="comment">-- ç´¯è®¡æ”¶è—</span></span><br><span class="line">  <span class="keyword">from</span> video_info</span><br><span class="line">  &lt;<span class="keyword">where</span>&gt;</span><br><span class="line">    &lt;<span class="keyword">if</span> test=&quot;userId!=null&quot;&gt;</span><br><span class="line">      <span class="keyword">and</span> user_id = #&#123;userId&#125;                 <span class="comment">-- æŒ‰ä½œè€…è¿‡æ»¤ï¼ˆåˆ›ä½œä¸­å¿ƒåªçœ‹â€œæˆ‘çš„â€ï¼‰</span></span><br><span class="line">    &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">  &lt;/<span class="keyword">where</span>&gt;</span><br><span class="line">&lt;/<span class="keyword">select</span>&gt;</span><br></pre></td></tr></table></figure>
<p>æŒ‰ä½œè€…èšåˆæ‰€æœ‰ä¸Šçº¿è§†é¢‘çš„å„ç±»è®¡æ•°ï¼Œè¿”å› Mapï¼Œå‰ç«¯å¯ä»¥ç›´æ¥å–é”®ç»˜åˆ¶å¡ç‰‡</p>
<p>åœ¨StatisticsInfoQueryåˆ›å»ºè¿™ä¸¤ä¸ªå­—æ®µåŠå…¶get/setæ–¹æ³•</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç»Ÿè®¡æ—¥æœŸå¼€å§‹æ—¶é—´</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> statisticsDateStart;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç»Ÿè®¡æ—¥æœŸç»“æŸæ—¶é—´</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> statisticsDateEnd;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1138-1024x859.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1139.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1128-1024x499.png" alt="img"></p>
<h2 id="25-ç®¡ç†ç«¯ç®¡ç†åå°-æ•°æ®ç»Ÿè®¡">25.ç®¡ç†ç«¯ç®¡ç†åå°-æ•°æ®ç»Ÿè®¡</h2>
<p>ç®¡ç†ç«¯çš„è§†é¢‘ç»Ÿè®¡é¢æ¿</p>
<p>åœ¨ç®¡ç†ç«¯æ¨¡å—ä¸‹åˆ›å»ºindexController</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@RequestMapping(<span class="string">&quot;/index&quot;</span>)</span><br><span class="line">@Validated</span><br><span class="line"><span class="keyword">public</span> class IndexController extends ABaseController &#123;</span><br><span class="line"></span><br><span class="line">    @Resource</span><br><span class="line">    <span class="keyword">private</span> StatisticsInfoService statisticsInfoService;</span><br><span class="line">    @Resource</span><br><span class="line">    <span class="keyword">private</span> UserInfoService userInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¹³å°çº§â€œæ˜¨æ—¥æ¦‚è§ˆ + ç´¯è®¡æ¦‚è§ˆâ€</span></span><br><span class="line"><span class="comment">     * - æ˜¨æ—¥ï¼šåŸºäº statistics_info çš„ T-1 æ±‡æ€»ï¼ˆå¹³å°ç»´åº¦ï¼Œä¸å¸¦ userIdï¼‰</span></span><br><span class="line"><span class="comment">     * - ç²‰ä¸ï¼šæŠŠâ€œæ˜¨æ—¥ç²‰ä¸â€æ›¿æ¢ä¸ºâ€œå½“å‰å…¨ç«™ç”¨æˆ·æ€»æ•°â€ï¼ˆç†è§£ä¸ºç”¨æˆ·è§„æ¨¡ï¼‰</span></span><br><span class="line"><span class="comment">     * - ç´¯è®¡ï¼šå„è®¡æ•°æ€»å’Œ + å…¨ç«™ç”¨æˆ·æ€»é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @RequestMapping(<span class="string">&quot;/getActualTimeStatisticsInfo&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> ResponseVO getActualTimeStatisticsInfo() &#123;</span><br><span class="line">        <span class="built_in">String</span> preDate = DateUtil.getBeforeDayDate(<span class="number">1</span>);                 <span class="comment">// æ˜¨æ—¥ yyyy-MM-dd</span></span><br><span class="line">        StatisticsInfoQuery param = <span class="literal">new</span> StatisticsInfoQuery();</span><br><span class="line">        param.setStatisticsDate(preDate);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// â‘  æ˜¨æ—¥å„é¡¹ï¼šå¹³å°åˆè®¡ï¼ˆMapper ä¼š sum å¹¶ group by data_type, statistics_dateï¼‰</span></span><br><span class="line">        <span class="built_in">List</span>&lt;StatisticsInfo&gt; preDayData =</span><br><span class="line">                statisticsInfoService.findListTotalInfoByParam(param);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// â‘¡ ç”¨å…¨ç«™ç”¨æˆ·æ€»æ•°è¦†ç›–â€œç²‰ä¸â€é¡¹</span></span><br><span class="line">        <span class="built_in">Integer</span> userCount = userInfoService.findCountByParam(<span class="literal">new</span> UserInfoQuery());</span><br><span class="line">        preDayData.forEach(item -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (StatisticsTypeEnum.FANS.getType().<span class="keyword">equals</span>(item.getDataType())) &#123;</span><br><span class="line">                item.setStatisticsCount(userCount);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// â‘¢ è½¬æˆ map: dataType -&gt; countï¼Œä¾¿äºå‰ç«¯æŒ‰æšä¸¾æ¸²æŸ“å¡ç‰‡</span></span><br><span class="line">        <span class="built_in">Map</span>&lt;<span class="built_in">Integer</span>, <span class="built_in">Integer</span>&gt; preDayDataMap = preDayData.stream()</span><br><span class="line">                .collect(Collectors.toMap(StatisticsInfo<span class="type">::getDataType</span>,</span><br><span class="line">                                          StatisticsInfo<span class="type">::getStatisticsCount</span>,</span><br><span class="line">                                          (a, b) -&gt; b));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// â‘£ ç´¯è®¡æ¦‚è§ˆï¼šä¼  null â†’ ç»Ÿè®¡å¹³å°æ€»é‡ï¼›åŒæ—¶è¿”å› userCountï¼ˆå…¨ç«™ç”¨æˆ·æ•°ï¼‰</span></span><br><span class="line">        <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Integer</span>&gt; totalCountInfo =</span><br><span class="line">                statisticsInfoService.getStatisticsInfoActualTime(<span class="built_in">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, Object&gt; result = <span class="literal">new</span> HashMap&lt;&gt;();</span><br><span class="line">        result.put(<span class="string">&quot;preDayData&quot;</span>, preDayDataMap);</span><br><span class="line">        result.put(<span class="string">&quot;totalCountInfo&quot;</span>, totalCountInfo);</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¹³å°çº§â€œè¿‘7å¤©è¶‹åŠ¿â€</span></span><br><span class="line"><span class="comment">     * - dataType é FANSï¼šå– statistics_info çš„å¹³å°æ±‡æ€»</span></span><br><span class="line"><span class="comment">     * - dataType = FANSï¼šå– user_info æŒ‰ join_time çš„æ¯æ—¥è®¡æ•°</span></span><br><span class="line"><span class="comment">     * - å¯¹ç¼ºå¤±æ—¥æœŸè¡¥ 0ï¼Œä¿è¯ 7 å¤©ç­‰é•¿åºåˆ—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @RequestMapping(<span class="string">&quot;/getWeekStatisticsInfo&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> ResponseVO getWeekStatisticsInfo(<span class="built_in">Integer</span> dataType) &#123;</span><br><span class="line">        <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; dateList = DateUtil.getBeforeDates(<span class="number">7</span>);             <span class="comment">// æœ€è¿‘7å¤©æ—¥æœŸï¼ˆä¸å«ä»Šå¤©ï¼‰</span></span><br><span class="line"></span><br><span class="line">        StatisticsInfoQuery param = <span class="literal">new</span> StatisticsInfoQuery();</span><br><span class="line">        param.setDataType(dataType);</span><br><span class="line">        param.setStatisticsDateStart(dateList.get(<span class="number">0</span>));</span><br><span class="line">        param.setStatisticsDateEnd(dateList.get(dateList.size() - <span class="number">1</span>));</span><br><span class="line">        param.setOrderBy(<span class="string">&quot;statistics_date asc&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// FANS èµ° user_info èšåˆï¼Œå…¶å®ƒèµ° statistics_info èšåˆ</span></span><br><span class="line">        <span class="built_in">List</span>&lt;StatisticsInfo&gt; statisticsInfoList =</span><br><span class="line">                !StatisticsTypeEnum.FANS.getType().<span class="keyword">equals</span>(dataType)</span><br><span class="line">                ? statisticsInfoService.findListTotalInfoByParam(param)</span><br><span class="line">                : statisticsInfoService.findUserCountTotalInfoByParam(param);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ˜ å°„ä¸º date -&gt; itemï¼Œä¾¿äºè¡¥é›¶</span></span><br><span class="line">        <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, StatisticsInfo&gt; dataMap = statisticsInfoList.stream()</span><br><span class="line">                .collect(Collectors.toMap(StatisticsInfo<span class="type">::getStatisticsDate</span>,</span><br><span class="line">                                          Function.identity(),</span><br><span class="line">                                          (a, b) -&gt; b));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æŒ‰æ—¥æœŸé¡ºåºè¡¥é›¶è¾“å‡º</span></span><br><span class="line">        <span class="built_in">List</span>&lt;StatisticsInfo&gt; resultDataList = <span class="literal">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        for (<span class="built_in">String</span> <span class="built_in">date</span> : dateList) &#123;</span><br><span class="line">            StatisticsInfo item = dataMap.get(<span class="built_in">date</span>);</span><br><span class="line">            <span class="keyword">if</span> (item == <span class="built_in">null</span>) &#123;</span><br><span class="line">                item = <span class="literal">new</span> StatisticsInfo();</span><br><span class="line">                item.setStatisticsDate(<span class="built_in">date</span>);</span><br><span class="line">                item.setStatisticsCount(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            resultDataList.add(item);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(resultDataList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1146-1024x466.png" alt="img"></p>
<p>StatisticsInfoServiceä¸­</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * æ ¹æ®æ¡ä»¶æŸ¥è¯¢æ€»æ•°ä¿¡æ¯</span><br><span class="line"> * @<span class="keyword">param</span> <span class="keyword">param</span></span><br><span class="line"> * @<span class="keyword">return</span></span><br><span class="line"> */</span><br><span class="line">List&lt;StatisticsInfo&gt; findListTotalInfoByParam(StatisticsInfoQuery <span class="keyword">param</span>);</span><br><span class="line"></span><br><span class="line">List&lt;StatisticsInfo&gt; findUserCountTotalInfoByParam(StatisticsInfoQuery <span class="keyword">param</span>);</span><br></pre></td></tr></table></figure>
<p>StatisticsInfoServiceImplä¸­</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">List</span>&lt;<span class="title class_">StatisticsInfo</span>&gt; <span class="title function_">findListTotalInfoByParam</span>(<span class="params"><span class="title class_">StatisticsInfoQuery</span> param</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> statisticsInfoMapper.<span class="title function_">selectListTotalInfoByParam</span>(param);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title class_">List</span>&lt;<span class="title class_">StatisticsInfo</span>&gt; <span class="title function_">findUserCountTotalInfoByParam</span>(<span class="params"><span class="title class_">StatisticsInfoQuery</span> param</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> statisticsInfoMapper.<span class="title function_">selectUserCountTotalInfoByParam</span>(param);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1147-1024x879.png" alt="img"></p>
<p>StatisticsInfoMapperä¸­</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ¹æ®æ¡ä»¶æŸ¥è¯¢æ€»æ•°ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">List</span>&lt;<span class="type">T</span>&gt; selectListTotalInfoByParam(<span class="meta">@Param</span>(<span class="string">&quot;query&quot;</span>) <span class="type">P</span> p);</span><br><span class="line"></span><br><span class="line"><span class="type">List</span>&lt;<span class="type">T</span>&gt; selectUserCountTotalInfoByParam(<span class="meta">@Param</span>(<span class="string">&quot;query&quot;</span>) <span class="type">P</span> p);</span><br></pre></td></tr></table></figure>
<p>StatisticsInfoMapper.xmlä¸­</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">select</span> id=<span class="string">&quot;selectListTotalInfoByParam&quot;</span> resultMap=<span class="string">&quot;base_result_map&quot;</span>&gt;</span><br><span class="line">	<span class="keyword">select</span> <span class="built_in">ifnull</span>(<span class="built_in">sum</span>(statistics_count),<span class="number">0</span>) statistics_count,statistics_date,data_type <span class="keyword">from</span> statistics_info s <span class="keyword">group</span> <span class="keyword">by</span> data_type,statistics_date</span><br><span class="line">&lt;/<span class="keyword">select</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;<span class="keyword">select</span> id=<span class="string">&quot;selectUserCountTotalInfoByParam&quot;</span> resultMap=<span class="string">&quot;base_result_map&quot;</span>&gt;</span><br><span class="line">	<span class="keyword">select</span> <span class="built_in">count</span>(<span class="number">1</span>) statistics_count,DATE_FORMAT(join_time,<span class="string">&#x27;%Y-%m-%d&#x27;</span>) statistics_date <span class="keyword">from</span> user_info <span class="keyword">group</span> <span class="keyword">by</span> statistics_date <span class="keyword">order</span> <span class="keyword">by</span> statistics_date <span class="keyword">asc</span></span><br><span class="line">&lt;/<span class="keyword">select</span>&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1148-1024x1003.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1140-1024x446.png" alt="img"></p>
<h2 id="26-ç®¡ç†ç«¯ç®¡ç†åå°-ç¨¿ä»¶ç®¡ç†">26.ç®¡ç†ç«¯ç®¡ç†åå°-ç¨¿ä»¶ç®¡ç†</h2>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1149.png" alt="img"></p>
<p>1.ç®¡ç†å‘˜æ¨èè§†é¢‘</p>
<p>åœ¨VideoInfoControllerä¸­</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç®¡ç†å‘˜åˆ‡æ¢â€œæ¨è/å–æ¶ˆæ¨èâ€</span></span><br><span class="line"><span class="comment"> * - å‚æ•°ï¼švideoIdï¼ˆå¿…å¡«ï¼‰</span></span><br><span class="line"><span class="comment"> * - é€»è¾‘ï¼šå­˜åœ¨æ€§æ ¡éªŒ + recommendType çŠ¶æ€åˆ‡æ¢</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@RequestMapping</span>(<span class="string">&quot;/recommendVideo&quot;</span>)</span><br><span class="line">public ResponseVO <span class="built_in">recommendVideo</span>(<span class="variable">@NotEmpty</span> String videoId) &#123;</span><br><span class="line">    <span class="selector-tag">videoInfoService</span><span class="selector-class">.recommendVideo</span>(videoId);</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">getSuccessResponseVO</span>(null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>VideoInfoServiceä¸­</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¨èè§†é¢‘</span></span><br><span class="line"><span class="comment"> * @param videoId</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">recommendVideo</span><span class="params">(<span class="type">String</span> videoId)</span></span>;</span><br></pre></td></tr></table></figure>
<p>VideoInfoServiceImplä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">	<span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">recommendVideo</span><span class="params">(String videoId)</span> &#123;</span><br><span class="line">    <span class="comment">// 1) è¯»å–è§†é¢‘</span></span><br><span class="line">    <span class="type">VideoInfo</span> <span class="variable">videoInfo</span> <span class="operator">=</span> videoInfoMapper.selectByVideoId(videoId);</span><br><span class="line">    <span class="keyword">if</span> (videoInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ç»Ÿä¸€çš„ä¸šåŠ¡å¼‚å¸¸æšä¸¾ï¼ŒCODE_600 å¯ç†è§£ä¸ºâ€œéæ³•å‚æ•°/çŠ¶æ€â€</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(ResponseCodeEnum.CODE_600);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2) è®¡ç®—è¦æ›´æ–°æˆçš„ recommendTypeï¼ˆå¼€å…³ï¼‰</span></span><br><span class="line">    Integer nextType;</span><br><span class="line">    <span class="keyword">if</span> (VideoRecommendTypeEnum.RECOMMEND.getType().equals(videoInfo.getRecommendType())) &#123;</span><br><span class="line">        nextType = VideoRecommendTypeEnum.NO_RECOMMEND.getType();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        nextType = VideoRecommendTypeEnum.RECOMMEND.getType();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3) ä»…æ›´æ–° recommendType å­—æ®µï¼Œé¿å…è¯¯è¦†ç›–å…¶å®ƒå­—æ®µ</span></span><br><span class="line">    <span class="type">VideoInfo</span> <span class="variable">patch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VideoInfo</span>();</span><br><span class="line">    patch.setRecommendType(nextType);</span><br><span class="line">    videoInfoMapper.updateByVideoId(patch, videoId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4) ï¼ˆå¯é€‰ï¼‰è‹¥é¦–é¡µ/æ¦œå•æœ‰ç¼“å­˜æˆ– ES æ’åºç”¨åˆ° recommendTypeï¼Œè¿™é‡ŒåŒæ­¥åˆ·æ–°</span></span><br><span class="line">    <span class="comment">//    esSearchComponent.updateDocField(videoId, &quot;recommendType&quot;, nextType);</span></span><br><span class="line">    <span class="comment">//    redisComponent.refreshRecommendListCache();</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å°æç¤ºï¼šè‹¥æ¨èä½ä¾èµ–ç¼“å­˜/ES æ’åºï¼Œè®°å¾—åŒæ­¥<strong>åˆ·æ–°ç¼“å­˜æˆ–æ›´æ–°ç´¢å¼•</strong>ï¼Œå¦åˆ™å‰å°å›æ˜¾ä¼šæœ‰å»¶è¿Ÿã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1141-1024x461.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1142-1024x499.png" alt="img"></p>
<p>2ç®¡ç†å‘˜åˆ é™¤è§†é¢‘</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1150-1024x339.png" alt="img"></p>
<p>æ·»åŠ è¿™ä¸ªæ¥å£å³å¯ï¼ŒServiceä¹‹å‰ç”¨æˆ·åˆ›ä½œä¸­å¿ƒçš„ç¨¿ä»¶ç®¡ç†é‡Œå·²ç»å®ç°è¿‡äº†</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç®¡ç†å‘˜åˆ é™¤è§†é¢‘</span></span><br><span class="line"><span class="comment"> * - ä»…ç®¡ç†å‘˜å¯ç”¨ï¼ˆç”± TOKEN_ADMIN æ‹¦æˆªå™¨ä¿è¯ï¼‰</span></span><br><span class="line"><span class="comment"> * - ä¼  null è·³è¿‡â€œæœ¬äººæ‰èƒ½åˆ é™¤â€çš„æ ¡éªŒ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@RequestMapping</span>(<span class="string">&quot;/deleteVideo&quot;</span>)</span><br><span class="line">public ResponseVO <span class="built_in">deleteVideo</span>(<span class="variable">@NotEmpty</span> String videoId) &#123;</span><br><span class="line">    <span class="selector-tag">videoInfoService</span><span class="selector-class">.deleteVideo</span>(videoId, null);</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">getSuccessResponseVO</span>(null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼šåˆ é™¤æ˜¯<strong>é«˜å±æ“ä½œ</strong>ï¼Œå»ºè®®ï¼š</p>
<ol>
<li>æ¥å£èµ° <strong>POST</strong> å¹¶æœ‰äºŒæ¬¡ç¡®è®¤ï¼›</li>
<li>è®°å½•<strong>å®¡è®¡æ—¥å¿—</strong>ï¼ˆç®¡ç†å‘˜ã€æ—¶é—´ã€IPã€è§†é¢‘IDï¼‰ï¼›</li>
<li>å¯é…ç½®â€œé€»è¾‘åˆ é™¤ + å®šæ—¶ç‰©ç†æ¸…ç†â€ï¼Œä»¥æ”¯æŒè¯¯åˆ å›æ»šã€‚</li>
</ol>
<p>3.ç®¡ç†å‘˜æŸ¥çœ‹ç¨¿ä»¶è¯¦æƒ…ï¼ˆåˆ† P åˆ—è¡¨ï¼‰</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç®¡ç†å‘˜æŸ¥çœ‹ç¨¿ä»¶çš„åˆ†Pæ¸…å•ï¼ˆæŠ•ç¨¿è¡¨æ•°æ®ï¼‰</span></span><br><span class="line"><span class="comment"> * - ä¾¿äºæ ¸å¯¹æ¯ä¸€Pçš„æ–‡ä»¶åã€æ—¶é•¿ã€æ¸…æ™°åº¦ã€å°é¢ç­‰ï¼ˆå–å†³äºè¡¨ç»“æ„ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/loadVideoPList&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">loadVideoPList</span>(<span class="params"><span class="meta">@NotEmpty</span> <span class="title class_">String</span> videoId</span>) &#123;</span><br><span class="line">    <span class="title class_">VideoInfoFilePostQuery</span> q = <span class="keyword">new</span> <span class="title class_">VideoInfoFilePostQuery</span>();</span><br><span class="line">    q.<span class="title function_">setVideoId</span>(videoId);</span><br><span class="line">    q.<span class="title function_">setOrderBy</span>(<span class="string">&quot;file_index asc&quot;</span>); <span class="comment">// æŒ‰åˆ†Pé¡ºåºå±•ç¤º</span></span><br><span class="line">    <span class="title class_">List</span>&lt;<span class="title class_">VideoInfoFilePost</span>&gt; list = videoInfoFilePostService.<span class="title function_">findListByParam</span>(q);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1151-1024x659.png" alt="img"></p>
<p><strong>å°ç»“</strong></p>
<ul>
<li><strong>æ¨èå¼€å…³</strong>ï¼šæŸ¥å­˜åœ¨ â†’ åˆ‡æ¢æšä¸¾ â†’ ä»…æ›´æ–° <code>recommendType</code>ï¼Œå¿…è¦æ—¶åˆ·æ–°ç¼“å­˜/ESï¼›</li>
<li><strong>åˆ é™¤è§†é¢‘</strong>ï¼šç®¡ç†ç«¯ç›´æ¥èµ°å…¬å…± Serviceï¼Œä¼  <code>null</code> è·³è¿‡â€œæœ¬äººæ ¡éªŒâ€ï¼ŒåŒæ­¥/å¼‚æ­¥æ¸…ç†ä¸€æ¡é¾™ï¼›</li>
<li><strong>æŸ¥çœ‹åˆ†P</strong>ï¼šæŒ‰ <code>file_index</code> å‡åºè¿”å›æŠ•ç¨¿æ¸…å•ï¼Œä¾¿äºæ ¸éªŒã€‚<br>
ä»¥ä¸Šå®ç°ä¸æ–‡æ¡£å®Œå…¨ä¸€è‡´ï¼Œç›´æ¥å¯ç”¨åˆ°ä½ çš„ç®¡ç†ç«¯åå°ä¸­ã€‚</li>
</ul>
<h2 id="27-ç®¡ç†ç«¯ç®¡ç†åå°-äº’åŠ¨ç®¡ç†">27.ç®¡ç†ç«¯ç®¡ç†åå°-äº’åŠ¨ç®¡ç†</h2>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1152-1024x509.png" alt="img"></p>
<p>åœ¨ç®¡ç†ç«¯åˆ›å»ºInteractController</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/** å¼¹å¹•åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µ + è§†é¢‘åæ¨¡ç³Šï¼‰ */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">&quot;/loadDanmu&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">loadDanmu</span>(<span class="params"><span class="title class_">Integer</span> pageNo, <span class="title class_">String</span> videoNameFuzzy</span>) &#123;</span><br><span class="line">        <span class="title class_">VideoDanmuQuery</span> q = <span class="keyword">new</span> <span class="title class_">VideoDanmuQuery</span>();</span><br><span class="line">        q.<span class="title function_">setOrderBy</span>(<span class="string">&quot;danmu_id desc&quot;</span>);  <span class="comment">// å®‰å…¨çš„ç™½åå•æ’åºï¼ˆå›ºå®šå­—æ®µï¼‰</span></span><br><span class="line">        q.<span class="title function_">setPageNo</span>(pageNo);            <span class="comment">// åˆ†é¡µé¡µç ï¼ˆé…åˆ PageSize åœ¨åŸºç±»é‡Œç”Ÿæ•ˆï¼‰</span></span><br><span class="line">        q.<span class="title function_">setQueryVideoInfo</span>(<span class="literal">true</span>);      <span class="comment">// å¼€å¯â€œè”æŸ¥è§†é¢‘ä¿¡æ¯â€ï¼Œæ‰èƒ½æŒ‰è§†é¢‘åç­›</span></span><br><span class="line">        q.<span class="title function_">setVideoNameFuzzy</span>(videoNameFuzzy); <span class="comment">// è§†é¢‘åæ¨¡ç³ŠåŒ¹é…</span></span><br><span class="line">        <span class="title class_">PaginationResultVO</span> result = videoDanmuService.<span class="title function_">findListByPage</span>(q);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** åˆ é™¤å¼¹å¹•ï¼ˆç®¡ç†å‘˜ï¼šuserId ä¼  nullï¼Œç»•è¿‡æƒé™åˆ¤æ–­ï¼‰ */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">&quot;/delDanmu&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">delDanmu</span>(<span class="params"><span class="meta">@NotNull</span> <span class="title class_">Integer</span> danmuId</span>) &#123;</span><br><span class="line">        videoDanmuService.<span class="title function_">deleteDanmu</span>(<span class="literal">null</span>, danmuId);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** è¯„è®ºåˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µ + è§†é¢‘åæ¨¡ç³Šï¼‰ */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">&quot;/loadComment&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">loadComment</span>(<span class="params"><span class="title class_">Integer</span> pageNo, <span class="title class_">String</span> videoNameFuzzy</span>) &#123;</span><br><span class="line">        <span class="title class_">VideoCommentQuery</span> q = <span class="keyword">new</span> <span class="title class_">VideoCommentQuery</span>();</span><br><span class="line">        q.<span class="title function_">setOrderBy</span>(<span class="string">&quot;comment_id desc&quot;</span>); <span class="comment">// å›ºå®šå€’åºå­—æ®µï¼Œé¿å… SQL æ³¨å…¥</span></span><br><span class="line">        q.<span class="title function_">setPageNo</span>(pageNo);</span><br><span class="line">        q.<span class="title function_">setQueryVideoInfo</span>(<span class="literal">true</span>);       <span class="comment">// éœ€è¦è”æŸ¥è§†é¢‘ä¿¡æ¯</span></span><br><span class="line">        q.<span class="title function_">setVideoNameFuzzy</span>(videoNameFuzzy);</span><br><span class="line">        <span class="title class_">PaginationResultVO</span> result = videoCommentService.<span class="title function_">findListByPage</span>(q);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** åˆ é™¤è¯„è®ºï¼ˆç®¡ç†å‘˜ï¼šuserId ä¼  nullï¼‰ */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">&quot;/delComment&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">ResponseVO</span> <span class="title function_">delComment</span>(<span class="params"><span class="meta">@NotNull</span> <span class="title class_">Integer</span> commentId</span>) &#123;</span><br><span class="line">        videoCommentService.<span class="title function_">deleteComment</span>(commentId, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>è¦ç‚¹</strong></p>
<ul>
<li><code>queryVideoInfo=true</code>ï¼šå‘Šè¯‰åº•å±‚ Mapper <strong>å·¦è”è§†é¢‘è¡¨</strong>ï¼Œè¿™æ ·æ‰èƒ½åœ¨ where é‡Œå†™ <code>vd.video_name like ...</code>ã€‚</li>
<li><code>orderBy</code> ç›´æ¥ç»™äº†å›ºå®šå­—æ®µå­—ç¬¦ä¸²ï¼Œ<strong>é¿å…æ³¨å…¥</strong>ã€‚</li>
<li>åˆ é™¤æ¥å£<strong>ä¸å¸¦åˆ†é¡µ/ç­›é€‰</strong>ï¼Œåªæ“ä½œæŒ‡å®šä¸»é”®ã€‚</li>
</ul>
<p>åœ¨VideoCommentMapper.xmlä¸­ä¸ºvideoNameFuzzyæ·»åŠ è¿‡æ»¤</p>
<figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!-- é€šç”¨æŸ¥è¯¢æ¡ä»¶åˆ—--&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;query_condition&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	 <span class="tag">&lt;<span class="name">where</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;base_condition_filed&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.videoIdFuzzy!= null  and query.videoIdFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 and  v.video_id like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.videoIdFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.videoUserIdFuzzy!= null  and query.videoUserIdFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 and  v.video_user_id like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.videoUserIdFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.contentFuzzy!= null  and query.contentFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 and  v.content like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.contentFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.imgPathFuzzy!= null  and query.imgPathFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 and  v.img_path like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.imgPathFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.userIdFuzzy!= null  and query.userIdFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 and  v.user_id like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.userIdFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.replyUserIdFuzzy!= null  and query.replyUserIdFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 and  v.reply_user_id like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.replyUserIdFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.postTimeStart!= null and query.postTimeStart!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 &lt;![CDATA[ and  v.post_time&gt;=str_to_date(#</span><span class="template-variable">&#123;query.postTimeStart&#125;</span><span class="language-xml">, &#x27;%Y-%m-%d&#x27;) ]]&gt;</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.postTimeEnd!= null and query.postTimeEnd!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">				 &lt;![CDATA[ and  v.post_time&lt; date_sub(str_to_date(#</span><span class="template-variable">&#123;query.postTimeEnd&#125;</span><span class="language-xml">,&#x27;%Y-%m-%d&#x27;),interval -1 day) ]]&gt;</span></span><br><span class="line"><span class="language-xml">			<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">		   <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.videoNameFuzzy!=null and query.videoNameFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">			 and vd.video_name like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.videoNameFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">		   <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	 <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">	<span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1153-930x1024.png" alt="img"></p>
<p>æ³¨æ„åœ¨VideoCommentServiceImplä¸­ï¼Œç»™ç®¡ç†å‘˜æƒé™åˆ é™¤</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3) æƒé™åˆ¤æ–­ï¼šæ“ä½œè€…å¿…é¡»æ˜¯ UP ä¸» æˆ– è¯„è®ºä½œè€…æœ¬äººè¿˜æœ‰ä¸€ç§æƒ…å†µç®¡ç†å‘˜åå°ä¹Ÿå¯ä»¥åˆ é™¤</span></span><br><span class="line">			<span class="built_in">boolean</span> isVideoOwner = videoInfo.getUserId().<span class="built_in">equals</span>(userId);</span><br><span class="line">			<span class="built_in">boolean</span> isCommentOwner = comment.getUserId().<span class="built_in">equals</span>(userId);</span><br><span class="line">			<span class="comment">//userId=nullä»£è¡¨ç€æ˜¯ç®¡ç†å‘˜</span></span><br><span class="line">			<span class="keyword">if</span> (!isVideoOwner &amp;&amp; !isCommentOwner &amp;&amp; userId!=<span class="literal">null</span>) &#123;</span><br><span class="line">				throw <span class="keyword">new</span> BusinessException(ResponseCodeEnum.CODE_600); <span class="comment">// æ— æƒåˆ é™¤</span></span><br><span class="line">			&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1154.png" alt="img"></p>
<p>æµ‹è¯•è¯„è®ºç®¡ç†å¼¹å¹•ç®¡ç†å‡æ²¡é—®é¢˜</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1143-1024x429.png" alt="img"></p>
<h2 id="28-ç®¡ç†ç«¯ç®¡ç†åå°-ç”¨æˆ·ç®¡ç†å’Œç³»ç»Ÿè®¾ç½®">28.ç®¡ç†ç«¯ç®¡ç†åå° ç”¨æˆ·ç®¡ç†å’Œç³»ç»Ÿè®¾ç½®</h2>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1155.png" alt="img"></p>
<p>ç”¨æˆ·ç®¡ç†</p>
<p>åˆ›å»ºUserController</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/user&quot;</span>)</span><br><span class="line"><span class="meta">@Validated</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">ABaseController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserInfoService</span> userInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ†é¡µåŠ è½½ç”¨æˆ·åˆ—è¡¨</span></span><br><span class="line"><span class="comment">     * - å…¥å‚ï¼šUserInfoQueryï¼ˆè‡ªåŠ¨ç»‘å®šåˆ†é¡µä¸ç­›é€‰å­—æ®µï¼‰</span></span><br><span class="line"><span class="comment">     * - ç»Ÿä¸€æŒ‰ç…§æ³¨å†Œæ—¶é—´å€’åºï¼Œé¿å…å‰ç«¯ä¼ å…¥ä»»æ„ orderBy é€ æˆæ³¨å…¥é£é™©</span></span><br><span class="line"><span class="comment">     * - è¿”å›ï¼šPaginationResultVOï¼ˆlist + pageInfoï¼‰</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">&quot;/loadUser&quot;</span>)</span><br><span class="line">    public <span class="type">ResponseVO</span> loadUser(<span class="type">UserInfoQuery</span> userInfoQuery) &#123;</span><br><span class="line">        <span class="comment">// å›ºå®šæ’åºï¼ˆç™½åå•ï¼‰ï¼Œç¡®ä¿ SQL å®‰å…¨</span></span><br><span class="line">        userInfoQuery.setOrderBy(<span class="string">&quot;join_time desc&quot;</span>);</span><br><span class="line">        <span class="type">PaginationResultVO</span> resultVO = userInfoService.findListByPage(userInfoQuery);</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(resultVO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ‡æ¢ç”¨æˆ·çŠ¶æ€ï¼ˆå¯ç”¨/ç¦ç”¨ï¼‰</span></span><br><span class="line"><span class="comment">     * - å‚æ•°ï¼šuserIdï¼ˆå¿…å¡«ï¼‰ã€statusï¼ˆå¿…å¡«ï¼Œå»ºè®®ç”¨æšä¸¾æ ¡éªŒï¼‰</span></span><br><span class="line"><span class="comment">     * - ä»…æ‰“è¡¥ä¸æ›´æ–° status å­—æ®µï¼Œé¿å…è¯¯è¦†ç›–å…¶ä»–å­—æ®µ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">&quot;/changeStatus&quot;</span>)</span><br><span class="line">    public <span class="type">ResponseVO</span> changeStatus(<span class="type">String</span> userId, <span class="type">Integer</span> status) &#123;</span><br><span class="line">        <span class="type">UserInfo</span> patch = <span class="keyword">new</span> <span class="type">UserInfo</span>();</span><br><span class="line">        patch.setStatus(status);</span><br><span class="line">        <span class="comment">// æ ¹æ® userId å®šä½è®°å½•å¹¶ä»…æ›´æ–°éç©ºå­—æ®µ</span></span><br><span class="line">        userInfoService.updateUserInfoByUserId(patch, userId);</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯´æ˜ï¼š<code>findListByPage</code> å†…éƒ¨é€šå¸¸ä¼šæ ¹æ® <code>pageNo/pageSize</code> è®¡ç®— LIMITï¼Œå¹¶å°è£…æ€»æ•°ä¸åˆ—è¡¨ï¼›<code>updateUserInfoByUserId</code> åº”åªæ›´æ–°éç©ºå­—æ®µï¼Œé¿å…è¦†ç›–ã€‚</p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1144-1024x427.png" alt="img"></p>
<p>ç³»ç»Ÿè®¾ç½®</p>
<p>SettingController</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@RestController</span></span><br><span class="line"><span class="variable">@RequestMapping</span>(<span class="string">&quot;/setting&quot;</span>)</span><br><span class="line"><span class="variable">@Validated</span></span><br><span class="line"><span class="variable">@Slf4j</span></span><br><span class="line">public class SettingController extends ABaseController &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">@Resource</span></span><br><span class="line">    private RedisComponent redisComponent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯»å–ç³»ç»Ÿè®¾ç½®</span></span><br><span class="line"><span class="comment">     * - ç›´æ¥ä» RedisComponent è·å–ï¼ˆå†…å«é»˜è®¤å€¼å…œåº•ï¼‰</span></span><br><span class="line"><span class="comment">     * - å‰ç«¯å±•ç¤ºé…ç½®è¡¨å•ç”¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="variable">@RequestMapping</span>(<span class="string">&quot;/getSetting&quot;</span>)</span><br><span class="line">    public ResponseVO <span class="built_in">getSetting</span>() &#123;</span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">getSuccessResponseVO</span>(redisComponent.<span class="built_in">getSysSettingDto</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¿å­˜ç³»ç»Ÿè®¾ç½®</span></span><br><span class="line"><span class="comment">     * - å…¥å‚ï¼šSysSettingDtoï¼ˆè¡¨å•ç»‘å®šï¼‰</span></span><br><span class="line"><span class="comment">     * - æŒä¹…åŒ–åˆ° Redisï¼ˆé›†ä¸­é…ç½®ä¸­å¿ƒï¼‰ï¼Œç«‹åˆ»ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="comment">     * - å»ºè®®ï¼šå‚æ•°æ ¡éªŒï¼ˆèŒƒå›´/éè´Ÿç­‰ï¼‰ï¼Œå¹¶è®°å½•æ“ä½œå®¡è®¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @<span class="selector-tag">RequestMapping</span>(<span class="string">&quot;/saveSetting&quot;</span>)</span><br><span class="line">    <span class="selector-tag">public</span> <span class="selector-tag">ResponseVO</span> <span class="selector-tag">saveSetting</span>(SysSettingDto sysSettingDto) &#123;</span><br><span class="line">        <span class="selector-tag">redisComponent</span><span class="selector-class">.saveSettingDto</span>(sysSettingDto);</span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">getSuccessResponseVO</span>(null);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RedisComponentä¸­</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void saveSettingD<span class="keyword">to</span>(SysSettingD<span class="keyword">to</span> sysSettingD<span class="keyword">to</span>) &#123;</span><br><span class="line">     redisUtils.<span class="built_in">set</span>(Constants.REDIS_KEY_SYS_SETTING, sysSettingD<span class="keyword">to</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1156.png" alt="img"></p>
<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/08/image-1145-1024x425.png" alt="img"></p>
<h2 id="å•æœåŠ¡ç‰ˆæœ¬å®Œç»“">å•æœåŠ¡ç‰ˆæœ¬å®Œç»“</h2>
</article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>GQ Videoå•æœåŠ¡ç‰ˆæœ¬è®°å½•</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://itgeqian.github.io/posts/37.html">https://itgeqian.github.io/posts/37.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a"><h>ä½œè€…</h><div class="post-copyright-cc-info"><h>geqian's BlogğŸ­</h></div></div><div class="post-copyright-c"><h>å‘å¸ƒäº</h><div class="post-copyright-cc-info"><h>2025-04-02</h></div></div><div class="post-copyright-u"><h>æ›´æ–°äº</h><div class="post-copyright-cc-info"><h>2025-08-12</h></div></div><div class="post-copyright-c"><h>è®¸å¯åè®®</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%A1%B9%E7%9B%AE%E7%9B%B8%E5%85%B3/"><div class="tags-punctuation"><svg class="faa-tada icon" style="height:1.1em;width:1.1em;fill:currentColor;position:relative;top:2px;margin-right:3px" aria-hidden="true"><use xlink:href="#icon-sekuaibiaoqian"></use></svg></div>é¡¹ç›®ç›¸å…³</a></div></div><link rel="stylesheet" href="/css/coin.css" media="defer" onload="this.media='all'"/><div class="post-reward"><button class="tip-button reward-button"><span class="tip-button__text">æŠ•å–‚ä½œè€…</span><div class="coin-wrapper"><div class="coin"><div class="coin__middle"></div><div class="coin__back"></div><div class="coin__front"></div></div></div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://java-geqian.oss-cn-beijing.aliyuncs.com/%E5%BE%AE%E4%BF%A1PAY.jpg" target="_blank"><img class="post-qr-code-img" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/%E5%BE%AE%E4%BF%A1PAY.jpg" alt="å¾®ä¿¡"/></a><div class="post-qr-code-desc">å¾®ä¿¡</div></li><li class="reward-item"><a href="https://java-geqian.oss-cn-beijing.aliyuncs.com/%E6%94%AF%E4%BB%98%E5%AE%9DPAY.jpg" target="_blank"><img class="post-qr-code-img" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/%E6%94%AF%E4%BB%98%E5%AE%9DPAY.jpg" alt="æ”¯ä»˜å®"/></a><div class="post-qr-code-desc">æ”¯ä»˜å®</div></li></ul></div></button></div><audio id="coinAudio" src="https://npm.elemecdn.com/akilar-candyassets@1.0.36/audio/aowu.m4a"></audio><script defer="defer" src="/js/coin.js"></script><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/44.html"><img class="prev-cover" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/geqian-Blos/%E7%99%BD%E8%90%9D.jpg" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">é€Ÿé€šå‰ç«¯å·¥ç¨‹åŒ–</div></div></a></div><div class="next-post pull-right"><a href="/posts/40.html"><img class="next-cover" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/geqian-Blos/%E7%99%BD%E4%B8%9D%E8%83%A1%E6%A1%83.jpg" onerror="onerror=null;src='/assets/r2.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">10åˆ†é’Ÿå­¦ä¼šSessionã€JWTã€Token</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/posts/58.html" title="GQ Musicé¡¹ç›®æ¼”ç¤ºå›¾"><img class="cover" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/geqian-Blos/18.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2025-09-26</div><div class="title">GQ Musicé¡¹ç›®æ¼”ç¤ºå›¾</div></div></a></div><div><a href="/posts/43.html" title="GQ Videoé¡¹ç›®ä¼˜åŒ–è®°å½•"><img class="cover" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2025-08-03</div><div class="title">GQ Videoé¡¹ç›®ä¼˜åŒ–è®°å½•</div></div></a></div><div><a href="/posts/41.html" title="GQ Videoå•æœåŠ¡æ”¹é€ å¾®æœåŠ¡"><img class="cover" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2025-08-11</div><div class="title">GQ Videoå•æœåŠ¡æ”¹é€ å¾®æœåŠ¡</div></div></a></div><div><a href="/posts/54.html" title="ä»£ç ç”Ÿæˆå™¨è¯¦è§£"><img class="cover" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/geqian-Blos/%E4%B8%89%E5%9B%BD%E6%97%A0%E5%8F%8C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2025-09-11</div><div class="title">ä»£ç ç”Ÿæˆå™¨è¯¦è§£</div></div></a></div><div><a href="/posts/55.html" title="é¡¹ç›®ä¸­çš„VOå’ŒDTO"><img class="cover" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/geqian-Blos/%E7%8E%9B%E5%A5%87%E7%8E%9B2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="fas fa-history fa-fw"></i> 2025-09-12</div><div class="title">é¡¹ç›®ä¸­çš„VOå’ŒDTO</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><svg class="meta_icon" style="width:22px;height:22px;position:relative;top:5px"><use xlink:href="#icon-mulu1"></use></svg><span style="font-weight:bold">ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">1.ç¯å¢ƒå‡†å¤‡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1%E6%8A%80%E6%9C%AF%E6%A0%88"><span class="toc-text">1.1æŠ€æœ¯æ ˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3"><span class="toc-text">1.2æ¥å£æ–‡æ¡£</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3%E9%A1%B9%E7%9B%AE%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-text">1.3é¡¹ç›®ç›®å½•ç»“æ„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4pom%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">1.4pomé…ç½®æ–‡ä»¶</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B9pom-xml"><span class="toc-text">æ ¹pom.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#common%E6%A8%A1%E5%9D%97pom-xml"><span class="toc-text">commonæ¨¡å—pom.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#admin%E6%A8%A1%E5%9D%97pom-xml"><span class="toc-text">adminæ¨¡å—pom.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#web%E6%A8%A1%E5%9D%97pom-xml"><span class="toc-text">webæ¨¡å—pom.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#logback%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">logbacké…ç½®æ–‡ä»¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#application-yml%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">application.ymlé…ç½®æ–‡ä»¶</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">1.5æ•°æ®åº“</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%99%BB%E5%BD%95%E4%B8%8E%E6%B3%A8%E5%86%8C"><span class="toc-text">2.ç™»å½•ä¸æ³¨å†Œ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-text">1.éªŒè¯ç </span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8session"><span class="toc-text">ç”¨session</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%B9%E9%80%A0%E4%BB%A3%E7%A0%81%E7%94%A8Redis%E6%8E%A5%E6%94%B6%E9%AA%8C%E8%AF%81%E7%A0%81"><span class="toc-text">æ”¹é€ ä»£ç ç”¨Redisæ¥æ”¶éªŒè¯ç </span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%97%AE%E9%A2%98"><span class="toc-text">ä¿®æ”¹é—®é¢˜</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AE%9E%E7%8E%B0%E6%B3%A8%E5%86%8C"><span class="toc-text">2.å®ç°æ³¨å†Œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%94%A8%E6%88%B7%E7%AB%AF-%E7%99%BB%E5%BD%95%EF%BC%88%E9%87%87%E7%94%A8token%EF%BC%89"><span class="toc-text">3.ç”¨æˆ·ç«¯ ç™»å½•ï¼ˆé‡‡ç”¨tokenï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%99%AE%E9%80%9A%E7%99%BB%E5%BD%95"><span class="toc-text">æ™®é€šç™»å½•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E7%99%BB%E5%BD%95"><span class="toc-text">è‡ªåŠ¨ç™»å½•</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E9%80%80%E5%87%BA"><span class="toc-text">4.é€€å‡º</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%83%A8%E7%BD%B2%E5%89%8D%E7%AB%AF%EF%BC%88%E5%AE%8C%E6%88%90%E7%AE%A1%E7%90%86%E7%AB%AF%E7%99%BB%E5%BD%95%E9%80%80%E5%87%BA%EF%BC%89"><span class="toc-text">3.éƒ¨ç½²å‰ç«¯ï¼ˆå®Œæˆç®¡ç†ç«¯ç™»å½•é€€å‡ºï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E7%AE%A1%E7%90%86%E7%AB%AF-%E5%88%86%E7%B1%BB%E7%AE%A1%E7%90%86"><span class="toc-text">4.ç®¡ç†ç«¯ åˆ†ç±»ç®¡ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%89%8D%E7%BD%AE%E5%87%86%E5%A4%87-%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-text">1.å‰ç½®å‡†å¤‡ -æ‹¦æˆªå™¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%88%86%E7%B1%BB"><span class="toc-text">2.åˆ†ç±»</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">å»ºæ•°æ®åº“</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%8E%B7%E5%8F%96%E5%88%86%E7%B1%BB"><span class="toc-text">1.è·å–åˆ†ç±»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%96%B0%E5%A2%9E%E5%88%86%E7%B1%BB-%E4%BF%AE%E6%94%B9%E5%88%86%E7%B1%BB"><span class="toc-text">2.æ–°å¢åˆ†ç±»&#x2F;ä¿®æ”¹åˆ†ç±»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%88%A0%E9%99%A4%E5%88%86%E7%B1%BB"><span class="toc-text">3.åˆ é™¤åˆ†ç±»</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%8F%98%E6%8D%A2%E5%88%86%E7%B1%BB%E4%BD%8D%E7%BD%AE%EF%BC%88%E4%B8%8A%E7%A7%BB-%E4%B8%8B%E7%A7%BB%EF%BC%89"><span class="toc-text">4.å˜æ¢åˆ†ç±»ä½ç½®ï¼ˆä¸Šç§»&#x2F;ä¸‹ç§»ï¼‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%88%B7%E6%96%B0%E7%BC%93%E5%AD%98"><span class="toc-text">5.åˆ·æ–°ç¼“å­˜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87"><span class="toc-text">6.ä¸Šä¼ å›¾ç‰‡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-%E8%8E%B7%E5%8F%96%E6%96%87%E4%BB%B6"><span class="toc-text">7.è·å–æ–‡ä»¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%8E%B7%E5%8F%96%E5%85%A8%E9%83%A8%E5%88%86%E7%B1%BB"><span class="toc-text">8.å®¢æˆ·ç«¯è·å–å…¨éƒ¨åˆ†ç±»</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E8%A7%86%E9%A2%91%E7%AE%A1%E7%90%86"><span class="toc-text">5.è§†é¢‘ç®¡ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%9E%84%E5%BB%BA%E8%A7%86%E9%A2%91%E8%A1%A8"><span class="toc-text">1.æ„å»ºè§†é¢‘è¡¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%96%87%E4%BB%B6%E9%A2%84%E4%B8%8A%E4%BC%A0"><span class="toc-text">2.æ–‡ä»¶é¢„ä¸Šä¼ </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%A7%86%E9%A2%91%E4%B8%8A%E4%BC%A0"><span class="toc-text">3.è§†é¢‘ä¸Šä¼ </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%88%A0%E9%99%A4%E4%B8%8A%E4%BC%A0%E7%9A%84%E8%A7%86%E9%A2%91"><span class="toc-text">4.åˆ é™¤ä¸Šä¼ çš„è§†é¢‘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9F%E8%AE%BE%E7%BD%AE"><span class="toc-text">5.è·å–ç³»ç»Ÿè®¾ç½®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E6%8A%95%E7%A8%BF%E4%B8%AD%E7%9A%84uploadImage"><span class="toc-text">6.æŠ•ç¨¿ä¸­çš„uploadImage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E5%8F%91%E5%B8%83%E8%A7%86%E9%A2%91"><span class="toc-text">7.å‘å¸ƒè§†é¢‘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-%E5%B0%86%E4%BF%9D%E5%AD%98%E5%9C%A8temp%E9%87%8C%E7%9A%84%E5%88%86%E7%89%87%E7%A7%BB%E5%88%B0video%E7%9B%AE%E5%BD%95%E5%B9%B6%E5%90%88%E5%B9%B6%E4%B8%BA%E8%A7%86%E9%A2%91"><span class="toc-text">8.å°†ä¿å­˜åœ¨tempé‡Œçš„åˆ†ç‰‡ç§»åˆ°videoç›®å½•å¹¶åˆå¹¶ä¸ºè§†é¢‘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-%E5%86%99loadVideoPost%E6%8E%A5%E5%8F%A3%EF%BC%8C%E8%AE%A9%E7%94%A8%E6%88%B7%E8%87%AA%E5%B7%B1%E8%83%BD%E7%9C%8B%E5%88%B0%E8%87%AA%E5%B7%B1%E5%8F%91%E5%B8%83%E8%BF%87%E7%9A%84%E8%A7%86%E9%A2%91"><span class="toc-text">9.å†™loadVideoPostæ¥å£ï¼Œè®©ç”¨æˆ·è‡ªå·±èƒ½çœ‹åˆ°è‡ªå·±å‘å¸ƒè¿‡çš„è§†é¢‘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-%E7%AE%A1%E7%90%86%E7%AB%AF%E8%83%BD%E7%9C%8B%E5%88%B0%E7%94%A8%E6%88%B7%E7%AB%AF%E5%BE%85%E5%AE%A1%E6%A0%B8%E7%9A%84%E8%A7%86%E9%A2%91"><span class="toc-text">10.ç®¡ç†ç«¯èƒ½çœ‹åˆ°ç”¨æˆ·ç«¯å¾…å®¡æ ¸çš„è§†é¢‘</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E7%AE%A1%E7%90%86%E5%91%98%E5%AE%A1%E6%A0%B8%E8%A7%86%E9%A2%91"><span class="toc-text">6.ç®¡ç†å‘˜å®¡æ ¸è§†é¢‘</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E7%94%A8%E6%88%B7%E7%AB%AF%E8%8E%B7%E5%8F%96%E8%A7%86%E9%A2%91%E5%88%97%E8%A1%A8"><span class="toc-text">7.ç”¨æˆ·ç«¯è·å–è§†é¢‘åˆ—è¡¨</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8%E7%94%A8%E6%88%B7%E7%AB%AF%E8%8E%B7%E5%8F%96%E8%A7%86%E9%A2%91%E8%AF%A6%E6%83%85%E5%B9%B6%E6%92%AD%E6%94%BE"><span class="toc-text">8ç”¨æˆ·ç«¯è·å–è§†é¢‘è¯¦æƒ…å¹¶æ’­æ”¾</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%9A%E5%85%88%E5%AE%8C%E6%88%90%E5%88%86%E6%89%B9%E5%88%97%E8%A1%A8%E7%9A%84%E5%B1%95%E7%A4%BA%E5%92%8C%E6%A0%87%E9%A2%98%E7%AE%80%E4%BB%8B%E7%AD%89%E7%9A%84%E5%B1%95%E7%A4%BA"><span class="toc-text">ç¬¬ä¸€éƒ¨åˆ†ï¼šå…ˆå®Œæˆåˆ†æ‰¹åˆ—è¡¨çš„å±•ç¤ºå’Œæ ‡é¢˜ç®€ä»‹ç­‰çš„å±•ç¤º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%EF%BC%9A%E8%AE%A9%E8%A7%86%E9%A2%91%E8%83%BD%E5%A4%9F%E6%92%AD%E6%94%BE"><span class="toc-text">ç¬¬äºŒéƒ¨åˆ†ï¼šè®©è§†é¢‘èƒ½å¤Ÿæ’­æ”¾</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E8%A7%86%E9%A2%91%E5%BC%B9%E5%B9%95"><span class="toc-text">9.è§†é¢‘å¼¹å¹•</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%9E%84%E5%BB%BA%E8%A7%86%E9%A2%91%E5%BC%B9%E5%B9%95%E8%A1%A8%E3%80%81%E8%A7%86%E9%A2%91%E8%AF%84%E8%AE%BA%E8%A1%A8%E3%80%81%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E8%A1%A8"><span class="toc-text">1.æ„å»ºè§†é¢‘å¼¹å¹•è¡¨ã€è§†é¢‘è¯„è®ºè¡¨ã€ç”¨æˆ·è¡Œä¸ºè¡¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%8F%91%E5%B8%83%E5%BC%B9%E5%B9%95%E5%92%8C%E5%B1%95%E7%A4%BA%E5%BC%B9%E5%B9%95"><span class="toc-text">2.å‘å¸ƒå¼¹å¹•å’Œå±•ç¤ºå¼¹å¹•</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-%E7%82%B9%E8%B5%9E%E6%94%B6%E8%97%8F"><span class="toc-text">10.ç‚¹èµæ”¶è—</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-%E6%8A%95%E5%B8%81"><span class="toc-text">11.æŠ•å¸</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-%E8%AF%84%E8%AE%BA%E6%A8%A1%E5%9D%97"><span class="toc-text">12.è¯„è®ºæ¨¡å—</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%8F%91%E5%B8%83%E8%AF%84%E8%AE%BA"><span class="toc-text">1.å‘å¸ƒè¯„è®º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9F%A5%E8%AF%A2%E8%AF%84%E8%AE%BA%E5%B9%B6%E8%83%BD%E5%A4%9F%E5%AD%90%E5%9B%9E%E5%A4%8D%E5%92%8C%E7%BD%AE%E9%A1%B6%E8%AF%84%E8%AE%BA"><span class="toc-text">2.æŸ¥è¯¢è¯„è®ºå¹¶èƒ½å¤Ÿå­å›å¤å’Œç½®é¡¶è¯„è®º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E8%AF%84%E8%AE%BA%E8%A1%8C%E4%B8%BA%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-text">3.è¯„è®ºè¡Œä¸ºçš„å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E7%94%A8%E6%88%B7%E5%8F%AF%E4%BB%A5%E5%88%A0%E9%99%A4%E8%87%AA%E5%B7%B1%E5%8F%91%E7%9A%84%E8%AF%84%E8%AE%BA%EF%BC%8Cup%E4%B8%BB%E5%8F%AF%E4%BB%A5%E5%AF%B9%E8%AF%84%E8%AE%BA%E8%BF%9B%E8%A1%8C%E5%88%A0%E9%99%A4%E5%92%8C%E7%BD%AE%E9%A1%B6"><span class="toc-text">4.ç”¨æˆ·å¯ä»¥åˆ é™¤è‡ªå·±å‘çš„è¯„è®ºï¼Œupä¸»å¯ä»¥å¯¹è¯„è®ºè¿›è¡Œåˆ é™¤å’Œç½®é¡¶</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-%E8%A7%86%E9%A2%91%E5%9C%A8%E7%BA%BF%E4%BA%BA%E6%95%B0"><span class="toc-text">13.è§†é¢‘åœ¨çº¿äººæ•°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83"><span class="toc-text">14.ä¸ªäººä¸­å¿ƒ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%BB%BA%E8%A1%A8"><span class="toc-text">1.å»ºè¡¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E5%B1%95%E7%A4%BA%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E5%8F%8A%E6%9B%B4%E6%94%B9%E8%83%8C%E6%99%AF%E4%B8%BB%E9%A2%98"><span class="toc-text">2.ä¸ªäººä¸­å¿ƒå±•ç¤ºç”¨æˆ·ä¿¡æ¯åŠæ›´æ”¹èƒŒæ™¯ä¸»é¢˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E5%85%B3%E6%B3%A8-%E5%8F%96%E6%B6%88%E5%85%B3%E6%B3%A8"><span class="toc-text">3.ä¸ªäººä¸­å¿ƒå…³æ³¨&#x2F;å–æ¶ˆå…³æ³¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E6%98%BE%E7%A4%BA%E5%85%B3%E6%B3%A8%E6%95%B0%E5%92%8C%E7%B2%89%E4%B8%9D%E6%95%B0%E7%AD%89%E4%BF%A1%E6%81%AF%EF%BC%88%E4%BD%A0%E5%85%B3%E6%B3%A8%E4%BA%86%E8%B0%81-%E4%BD%A0%E7%9A%84%E7%B2%89%E4%B8%9D%E6%98%AF%E8%B0%81-%E8%B0%81%E8%B7%9F%E4%BD%A0%E4%BA%92%E7%B2%89%E4%BA%86%EF%BC%89"><span class="toc-text">4.ä¸ªäººä¸­å¿ƒæ˜¾ç¤ºå…³æ³¨æ•°å’Œç²‰ä¸æ•°ç­‰ä¿¡æ¯ï¼ˆä½ å…³æ³¨äº†è°&#x2F;ä½ çš„ç²‰ä¸æ˜¯è°&#x2F;è°è·Ÿä½ äº’ç²‰äº†ï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E8%A7%86%E9%A2%91%E5%88%97%E8%A1%A8%E3%80%81%E6%94%B6%E8%97%8F%E7%9A%84%E5%B1%95%E7%A4%BA"><span class="toc-text">5.ä¸ªäººä¸­å¿ƒè§†é¢‘åˆ—è¡¨ã€æ”¶è—çš„å±•ç¤º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E4%B8%AD%E8%A7%86%E9%A2%91%E5%90%88%E9%9B%86"><span class="toc-text">6.ä¸ªäººä¸­å¿ƒä¸­è§†é¢‘åˆé›†</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%B1%95%E7%A4%BA%E8%A7%86%E9%A2%91%E5%90%88%E9%9B%86"><span class="toc-text">1.å±•ç¤ºè§†é¢‘åˆé›†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%BF%9D%E5%AD%98%E8%A7%86%E9%A2%91%E5%90%88%E9%9B%86"><span class="toc-text">2.ä¿å­˜è§†é¢‘åˆé›†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%B7%BB%E5%8A%A0getVideoSeriesDetail%E6%8E%A5%E5%8F%A3%EF%BC%8C%E5%BD%93%E5%9C%A8%E5%90%88%E9%9B%86%E9%A1%B5%E9%9D%A2%E7%82%B9%E5%87%BB%E5%90%88%E9%9B%86%E9%87%8C%E7%9A%84%E4%BB%BB%E6%84%8F%E8%A7%86%E9%A2%91%E5%B0%B1%E5%8F%AF%E4%BB%A5%E8%BF%9B%E5%85%A5%E8%A7%86%E9%A2%91%E8%AF%A6%E6%83%85%E9%A1%B5"><span class="toc-text">3.æ·»åŠ getVideoSeriesDetailæ¥å£ï¼Œå½“åœ¨åˆé›†é¡µé¢ç‚¹å‡»åˆé›†é‡Œçš„ä»»æ„è§†é¢‘å°±å¯ä»¥è¿›å…¥è§†é¢‘è¯¦æƒ…é¡µ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%9C%A8%E5%B7%B2%E6%9C%89%E7%9A%84%E5%90%88%E9%9B%86%E9%87%8C%E6%B7%BB%E5%8A%A0%E8%A7%86%E9%A2%91%EF%BC%8C%E5%88%A0%E9%99%A4%E5%B7%B2%E6%9C%89%E5%90%88%E9%9B%86%E4%B8%AD%E7%9A%84%E8%A7%86%E9%A2%91%EF%BC%8C%E5%88%A0%E9%99%A4%E6%95%B4%E4%B8%AA%E5%90%88%E9%9B%86"><span class="toc-text">4.åœ¨å·²æœ‰çš„åˆé›†é‡Œæ·»åŠ è§†é¢‘ï¼Œåˆ é™¤å·²æœ‰åˆé›†ä¸­çš„è§†é¢‘ï¼Œåˆ é™¤æ•´ä¸ªåˆé›†</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E5%AF%B9%E5%90%88%E9%9B%86%E8%BF%9B%E8%A1%8C%E6%8E%92%E5%BA%8F"><span class="toc-text">5.å¯¹åˆé›†è¿›è¡Œæ’åº</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E5%90%88%E9%9B%86%E4%B8%AD%EF%BC%88%E9%BB%98%E8%AE%A4%E5%8F%AA%E5%B1%95%E7%A4%BA5%E6%9D%A1%E8%A7%86%E9%A2%91%EF%BC%89%E7%82%B9%E6%9B%B4%E5%A4%9A%E4%BC%9A%E6%9F%A5%E8%AF%A2%E5%88%B0%E6%89%80%E6%9C%89%E7%9A%84%E8%A7%86%E9%A2%91"><span class="toc-text">6.åˆé›†ä¸­ï¼ˆé»˜è®¤åªå±•ç¤º5æ¡è§†é¢‘ï¼‰ç‚¹æ›´å¤šä¼šæŸ¥è¯¢åˆ°æ‰€æœ‰çš„è§†é¢‘</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-%E5%88%9B%E4%BD%9C%E4%B8%AD%E5%BF%83"><span class="toc-text">15.åˆ›ä½œä¸­å¿ƒ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%A8%BF%E4%BB%B6%E7%AE%A1%E7%90%86%E4%B8%AD%E5%BD%93%E7%82%B9%E5%87%BB%E7%BC%96%E8%BE%91%E8%83%BD%E5%AF%B9%E5%B7%B2%E7%BB%8F%E5%8F%91%E5%B8%83%E7%9A%84%E7%A8%BF%E4%BB%B6%E8%BF%9B%E8%A1%8C%E5%86%8D%E6%AC%A1%E7%BC%96%E8%BE%91"><span class="toc-text">1.ç¨¿ä»¶ç®¡ç†ä¸­å½“ç‚¹å‡»ç¼–è¾‘èƒ½å¯¹å·²ç»å‘å¸ƒçš„ç¨¿ä»¶è¿›è¡Œå†æ¬¡ç¼–è¾‘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%88%9B%E4%BD%9C%E4%B8%AD%E5%BF%83%E4%BA%92%E5%8A%A8%E7%AE%A1%E7%90%86%E9%83%A8%E5%88%861%EF%BC%88%E5%AE%8C%E5%96%84%E8%AF%84%E8%AE%BA%E7%AE%A1%E7%90%86%EF%BC%89"><span class="toc-text">2.åˆ›ä½œä¸­å¿ƒäº’åŠ¨ç®¡ç†éƒ¨åˆ†1ï¼ˆå®Œå–„è¯„è®ºç®¡ç†ï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%88%9B%E4%BD%9C%E4%B8%AD%E5%BF%83%E4%BA%92%E5%8A%A8%E7%AE%A1%E7%90%86%E9%83%A8%E5%88%862%EF%BC%88%E5%AE%8C%E5%96%84%E5%BC%B9%E5%B9%95%E7%AE%A1%E7%90%86%EF%BC%89"><span class="toc-text">3.åˆ›ä½œä¸­å¿ƒäº’åŠ¨ç®¡ç†éƒ¨åˆ†2ï¼ˆå®Œå–„å¼¹å¹•ç®¡ç†ï¼‰</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#16-%E9%A6%96%E9%A1%B5%E6%90%9C%E7%B4%A2%E6%A8%A1%E5%9D%97%EF%BC%88ES%EF%BC%89"><span class="toc-text">16.é¦–é¡µæœç´¢æ¨¡å—ï¼ˆESï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-ES%E7%AE%80%E4%BB%8B"><span class="toc-text">1.ESç®€ä»‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-ES%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">2.ESåˆå§‹åŒ–</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-ES%E6%96%B0%E5%A2%9E%E4%BF%AE%E6%94%B9%E5%88%A0%E9%99%A4"><span class="toc-text">3.ESæ–°å¢ä¿®æ”¹åˆ é™¤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%B5%8B%E8%AF%95saveDoc"><span class="toc-text">1.æµ‹è¯•saveDoc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%B5%8B%E8%AF%95updateDoc"><span class="toc-text">2.æµ‹è¯•updateDoc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%B5%8B%E8%AF%95updateDocCount"><span class="toc-text">3.æµ‹è¯•updateDocCount</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%B5%8B%E8%AF%95delDoc"><span class="toc-text">4.æµ‹è¯•delDoc</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-ES%E6%90%9C%E7%B4%A2"><span class="toc-text">4.ESæœç´¢</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%90%9C%E7%B4%A2%E7%83%AD%E8%AF%8D"><span class="toc-text">5.æœç´¢çƒ­è¯</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#17-24%E5%B0%8F%E6%97%B6%E7%83%AD%E9%97%A8%E6%98%BE%E7%A4%BA%E4%BB%A5%E5%8F%8A%E8%A7%86%E9%A2%91%E8%AF%A6%E6%83%85%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86"><span class="toc-text">17.24å°æ—¶çƒ­é—¨æ˜¾ç¤ºä»¥åŠè§†é¢‘è¯¦æƒ…æ•°æ®å¤„ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#24%E5%B0%8F%E6%97%B6%E7%83%AD%E9%97%A8%E6%98%BE%E7%A4%BA"><span class="toc-text">24å°æ—¶çƒ­é—¨æ˜¾ç¤º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%86%E9%A2%91%E8%AF%A6%E6%83%85%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86"><span class="toc-text">è§†é¢‘è¯¦æƒ…æ•°æ®å¤„ç†</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#18-AOP%E7%99%BB%E5%BD%95%E6%95%88%E9%AA%8C"><span class="toc-text">18.AOPç™»å½•æ•ˆéªŒ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#19-AOP%E8%AE%B0%E5%BD%95%E6%B6%88%E6%81%AF"><span class="toc-text">19.AOPè®°å½•æ¶ˆæ¯</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%BB%BA%E8%A1%A8-2"><span class="toc-text">1.å»ºè¡¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-AOP%E8%AE%B0%E5%BD%95%E6%B6%88%E6%81%AF%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-text">2.AOPè®°å½•æ¶ˆæ¯çš„å®ç°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#20-%E6%B6%88%E6%81%AF%E7%AE%A1%E7%90%86"><span class="toc-text">20.æ¶ˆæ¯ç®¡ç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#21-%E6%92%AD%E6%94%BE%E5%8E%86%E5%8F%B2"><span class="toc-text">21.æ’­æ”¾å†å²</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-%E5%89%A9%E4%BD%99TODO%E7%9A%84%E5%A4%84%E7%90%86"><span class="toc-text">22.å‰©ä½™TODOçš„å¤„ç†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%A4%84%E7%90%86%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84AccountController%E7%9A%84TODO%E5%BD%93%E9%BC%A0%E6%A0%87%E6%82%AC%E6%B5%AE%E5%9C%A8%E5%A4%B4%E5%83%8F%E4%B8%8A%E6%97%B6%E4%BC%9A%E6%98%BE%E7%A4%BA%E5%85%B3%E6%B3%A8%E6%95%B0%E3%80%81%E7%B2%89%E4%B8%9D%E6%95%B0%E3%80%81%E7%A1%AC%E5%B8%81%E6%95%B0"><span class="toc-text">1.å¤„ç†å®¢æˆ·ç«¯çš„AccountControllerçš„TODOå½“é¼ æ ‡æ‚¬æµ®åœ¨å¤´åƒä¸Šæ—¶ä¼šæ˜¾ç¤ºå…³æ³¨æ•°ã€ç²‰ä¸æ•°ã€ç¡¬å¸æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-CategoryInfoServiceImpl%E4%B8%AD%E5%AE%8C%E6%88%90%E5%88%A0%E9%99%A4%E5%88%86%E7%B1%BB%E7%9A%84TODO%EF%BC%9A-%E6%9F%A5%E8%AF%A2%E5%88%86%E7%B1%BB%E4%B8%8B%E6%98%AF%E5%90%A6%E6%9C%89%E8%A7%86%E9%A2%91"><span class="toc-text">2.CategoryInfoServiceImplä¸­å®Œæˆåˆ é™¤åˆ†ç±»çš„TODOï¼š æŸ¥è¯¢åˆ†ç±»ä¸‹æ˜¯å¦æœ‰è§†é¢‘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-UserInfoServiceImpl%E4%B8%AD%E5%AE%8C%E6%88%90%E6%B3%A8%E5%86%8C%E7%94%A8%E6%88%B7%E7%9A%84TODO%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96%E7%A1%AC%E5%B8%81%E6%95%B0%EF%BC%8C%E4%BB%A5%E5%8F%8A%E6%A0%B9%E6%8D%AE%E7%94%A8%E6%88%B7ID%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E8%AF%A6%E7%BB%86%E4%BF%A1%E6%81%AF%E7%9A%84TODO%E8%8E%B7%E5%8F%96%E6%92%AD%E6%94%BE%E9%87%8F%E3%80%81%E7%82%B9%E8%B5%9E%E6%95%B0%E3%80%81%E6%94%B6%E8%97%8F%E6%95%B0"><span class="toc-text">3.UserInfoServiceImplä¸­å®Œæˆæ³¨å†Œç”¨æˆ·çš„TODOï¼šåˆå§‹åŒ–ç¡¬å¸æ•°ï¼Œä»¥åŠæ ¹æ®ç”¨æˆ·IDè·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯çš„TODOè·å–æ’­æ”¾é‡ã€ç‚¹èµæ•°ã€æ”¶è—æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-VideoInfoPostServiceImpl%E4%B8%AD%E7%AE%A1%E7%90%86%E5%91%98%E5%AE%A1%E6%A0%B8%E8%A7%86%E9%A2%91%E7%9A%84TODO%EF%BC%9A%E9%A6%96%E6%AC%A1%E5%8F%91%E5%B8%83%E5%A5%96%E5%8A%B1%E4%B8%BA%E7%94%A8%E6%88%B7%E5%8A%A0%E7%A1%AC%E5%B8%81"><span class="toc-text">4.VideoInfoPostServiceImplä¸­ç®¡ç†å‘˜å®¡æ ¸è§†é¢‘çš„TODOï¼šé¦–æ¬¡å‘å¸ƒå¥–åŠ±ä¸ºç”¨æˆ·åŠ ç¡¬å¸</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-VideoInfoServiceImpl%E4%B8%AD%E5%AE%8C%E6%88%90%E5%88%A0%E9%99%A4%E8%A7%86%E9%A2%91%E7%9A%84TODO%EF%BC%9A%E5%BD%93%E5%88%A0%E9%99%A4%E8%A7%86%E9%A2%91%E5%90%8E%E5%87%8F%E5%8E%BB%E7%94%A8%E6%88%B7%E5%A2%9E%E5%8A%A0%E7%9A%84%E7%A1%AC%E5%B8%81"><span class="toc-text">5.VideoInfoServiceImplä¸­å®Œæˆåˆ é™¤è§†é¢‘çš„TODOï¼šå½“åˆ é™¤è§†é¢‘åå‡å»ç”¨æˆ·å¢åŠ çš„ç¡¬å¸</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#23-%E5%88%9B%E4%BD%9C%E4%B8%AD%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1"><span class="toc-text">23.åˆ›ä½œä¸­å¿ƒæ•°æ®ç»Ÿè®¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#24-%E5%88%9B%E4%BD%9C%E4%B8%AD%E5%BF%83%E5%89%8D%E7%AB%AF%E9%A1%B5%E9%9D%A2%E5%9B%9E%E6%98%BE%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1"><span class="toc-text">24.åˆ›ä½œä¸­å¿ƒå‰ç«¯é¡µé¢å›æ˜¾æ•°æ®ç»Ÿè®¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#25-%E7%AE%A1%E7%90%86%E7%AB%AF%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0-%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1"><span class="toc-text">25.ç®¡ç†ç«¯ç®¡ç†åå°-æ•°æ®ç»Ÿè®¡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#26-%E7%AE%A1%E7%90%86%E7%AB%AF%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0-%E7%A8%BF%E4%BB%B6%E7%AE%A1%E7%90%86"><span class="toc-text">26.ç®¡ç†ç«¯ç®¡ç†åå°-ç¨¿ä»¶ç®¡ç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#27-%E7%AE%A1%E7%90%86%E7%AB%AF%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0-%E4%BA%92%E5%8A%A8%E7%AE%A1%E7%90%86"><span class="toc-text">27.ç®¡ç†ç«¯ç®¡ç†åå°-äº’åŠ¨ç®¡ç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#28-%E7%AE%A1%E7%90%86%E7%AB%AF%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86%E5%92%8C%E7%B3%BB%E7%BB%9F%E8%AE%BE%E7%BD%AE"><span class="toc-text">28.ç®¡ç†ç«¯ç®¡ç†åå° ç”¨æˆ·ç®¡ç†å’Œç³»ç»Ÿè®¾ç½®</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E6%9C%8D%E5%8A%A1%E7%89%88%E6%9C%AC%E5%AE%8C%E7%BB%93"><span class="toc-text">å•æœåŠ¡ç‰ˆæœ¬å®Œç»“</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background-color: transparent;"><div id="footer-wrap"><div id="ft"><div class="ft-item-1"><div class="t-top"><div class="t-t-l"><p class="ft-t t-l-t">æ ¼è¨€ğŸ§¬</p><div class="bg-ad"><div>å†çœ‹çœ‹é‚£ä¸ªå…‰ç‚¹ï¼Œå®ƒå°±åœ¨è¿™é‡Œï¼Œè¿™æ˜¯å®¶å›­ï¼Œè¿™æ˜¯æˆ‘ä»¬ â€”â€” ä½ æ‰€çˆ±çš„æ¯ä¸€ä¸ªäººï¼Œä½ è®¤è¯†çš„ä¸€ä¸ªäººï¼Œä½ å¬è¯´è¿‡çš„æ¯ä¸€ä¸ªäººï¼Œæ›¾ç»æœ‰è¿‡çš„æ¯ä¸€ä¸ªäººï¼Œéƒ½åœ¨å®ƒä¸Šé¢åº¦è¿‡ä»–ä»¬çš„ä¸€ç”Ÿâœ¨</div><div class="btn-xz-box"><a class="btn-xz" target="_blank" rel="noopener" href="https://stellarium.org/">ç‚¹å‡»å¼€å¯æ˜Ÿè¾°ä¹‹æ—…</a></div></div></div><div class="t-t-r"><p class="ft-t t-l-t">çŒœä½ æƒ³çœ‹ğŸ’¡</p><ul class="ft-links"><li><a href="/comments/">ç•™ç‚¹ä»€ä¹ˆ</a><a href="/archives/">æ–‡ç« å½’æ¡£</a></li><li><a href="/categories/">æ–‡ç« åˆ†ç±»</a><a href="/tags/">æ–‡ç« æ ‡ç­¾</a></li><li><a href="/box/Gallery/">æˆ‘çš„ç”»å»Š</a><a href="/personal/bb/">æˆ‘çš„å” å¨</a></li><li><a href="/site/time/">å»ºè®¾è¿›ç¨‹</a><a href="/site/census/">ç½‘ç«™ç»Ÿè®¡</a></li></ul></div></div></div><div class="ft-item-2"><p class="ft-t">æ¨èå‹é“¾âŒ›</p><div class="ft-img-group"><div class="img-group-item"></div></div></div></div><div class="copyright"><span><b>&copy;2022-2025</b></span><span><b>&nbsp;&nbsp;By geqian's BlogğŸ­</b></span></div><div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://icp.gov.moe/?keyword=20230913" style="margin-inline:5px" title="æœ¬ç«™å·²åŠ å…¥èŒICPè±ªåå¥—é¤ï¼ŒèŒICPå¤‡20230913å·"><img src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/20230913.svg" alt=""/></a></p></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><a class="icon-V hidden" onclick="switchNightMode()" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><svg width="25" height="25" viewBox="0 0 1024 1024"><use id="modeicon" xlink:href="#icon-moon"></use></svg></a><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button><button class="share" type="button" title="å³é”®æ¨¡å¼" onclick="changeMouseMode()"><i class="fas fa-mouse"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog right_side"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button class="share" type="button" title="åˆ†äº«é“¾æ¥" onclick="share()"><i class="fas fa-share-nodes"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i><span id="percent">0<span>%</span></span></button><button id="go-down" type="button" title="ç›´è¾¾åº•éƒ¨" onclick="btf.scrollToDest(document.body.scrollHeight, 500)"><i class="fas fa-arrow-down"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div class="js-pjax" id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa fa-arrow-right"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa fa-refresh"></i></a><a class="rightMenu-item" href="javascript:rmf.scrollToTop();"><i class="fa fa-arrow-up"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa fa-copy"></i><span>å¤åˆ¶</span></a><a class="rightMenu-item" href="javascript:window.open(&quot;https://www.baidu.com/s?wd=&quot;+window.getSelection().toString());window.location.reload();"><i class="fa fa-search"></i><span>ç™¾åº¦æœç´¢</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-too"><a class="rightMenu-item" href="javascript:window.open(window.getSelection().toString());window.location.reload();"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-paste"><a class="rightMenu-item" href="javascript:rmf.paste()"><i class="fa fa-copy"></i><span>ç²˜è´´</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-post"><a class="rightMenu-item" href="#post-comment"><i class="fas fa-comment"></i><span>ç©ºé™è¯„è®º</span></a><a class="rightMenu-item" href="javascript:rmf.copyWordsLink()"><i class="fa fa-link"></i><span>å¤åˆ¶æœ¬æ–‡åœ°å€</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-to"><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" id="menu-too" href="javascript:rmf.open()"><i class="fa fa-link"></i><span>è½¬åˆ°é“¾æ¥</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-img"><a class="rightMenu-item" href="javascript:rmf.saveAs()"><i class="fa fa-download"></i><span>ä¿å­˜å›¾ç‰‡</span></a><a class="rightMenu-item" href="javascript:rmf.openWithNewTab()"><i class="fa fa-window-restore"></i><span>åœ¨æ–°çª—å£æ‰“å¼€</span></a><a class="rightMenu-item" href="javascript:rmf.copyLink()"><i class="fa fa-copy"></i><span>å¤åˆ¶å›¾ç‰‡é“¾æ¥</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:randomPost()"><i class="fa fa-paper-plane"></i><span>éšä¾¿é€›é€›</span></a><a class="rightMenu-item" href="javascript:switchNightMode();"><i class="fa fa-moon"></i><span>æ˜¼å¤œåˆ‡æ¢</span></a><a class="rightMenu-item" href="/personal/about/"><i class="fa fa-info-circle"></i><span>å…³äºåšå®¢</span></a><a class="rightMenu-item" href="javascript:toggleWinbox();"><i class="fas fa-cog"></i><span>ç¾åŒ–è®¾ç½®</span></a><a class="rightMenu-item" href="javascript:rmf.fullScreen();"><i class="fas fa-expand"></i><span>åˆ‡æ¢å…¨å±</span></a><a class="rightMenu-item" href="javascript:window.print();"><i class="fa-solid fa-print"></i><span>æ‰“å°é¡µé¢</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.staticfile.org/fancyapps-ui/4.0.31/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><script async="async">var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())
setTimeout(function(){preloader.endLoading();}, 5000);
document.getElementById('loading-box').addEventListener('click',()=> {preloader.endLoading()})</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: '',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: '',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.staticfile.org/twikoo/1.6.8/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><script src="https://cdn.staticfile.org/jquery/3.6.3/jquery.min.js"></script><script async src="https://cdn1.tianli0.top/npm/vue@2.6.14/dist/vue.min.js"></script><script async src="https://cdn1.tianli0.top/npm/element-ui@2.15.6/lib/index.js"></script><script async src="https://cdn.bootcdn.net/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script><script defer type="text/javascript" src="https://cdn1.tianli0.top/npm/sweetalert2@8.19.0/dist/sweetalert2.all.js"></script><script async src="//npm.elemecdn.com/pace-js@1.2.4/pace.min.js"></script><script defer src="https://cdn1.tianli0.top/gh/nextapps-de/winbox/dist/winbox.bundle.min.js"></script><script async src="//at.alicdn.com/t/c/font_3586335_hsivh70x0fm.js"></script><script async src="//at.alicdn.com/t/c/font_3636804_gr02jmjr3y9.js"></script><script async src="//at.alicdn.com/t/c/font_3612150_kfv55xn3u2g.js"></script><script async src="https://cdn.wpon.cn/2022-sucai/Gold-ingot.js"></script><canvas id="universe"></canvas><canvas id="snow"></canvas><script defer src="/js/fomal.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdnjs.cloudflare.com/ajax/libs/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn1.tianli0.top/npm/js-heo@1.0.12/metingjs/Meting.min.js"></script><script src="https://lib.baomitu.com/pjax/0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show","#web_bg",".js-pjax","#bibi","body > title","#app","#tag-echarts","#posts-echart","#categories-echarts"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/å­¦ä¹ ç¬”è®°/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¡ geqianã®å­¦ä¹ ç¬”è®° (10)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/æ‚é¡¹/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¼ geqianã®æ‚é¡¹ (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/é¡¹ç›®/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ‰ geqianã®é¡¹ç›®ç¬”è®° (6)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/AI/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¨ geqianã®AIå¤§æ¨¡å‹ (6)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/ç®—æ³•/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸŸ geqianã®ç®—æ³•å­¦ä¹ ç¬”è®° (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/é¢è¯•/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¥ geqianã®é¢è¯• (18)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/JUC/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸŒ geqianã®JUC (4)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/JVM/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸœ geqianã®JVM (5)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/äº‘åŸç”Ÿ/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ” geqianã®äº‘åŸç”Ÿç›¸å…³ (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/MQ/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ“± geqianã®æ¶ˆæ¯é˜Ÿåˆ— (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/å‰ç«¯/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ›ï¸ geqianã®å‰ç«¯å·¥ç¨‹ (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/mybatis-mybatis-plus/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ¨ geqianã®mybatisç³»åˆ— (1)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/å¾®æœåŠ¡/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ—ºï¸ geqianã®SpringCloudç³»åˆ— (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/SSM/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ“– geqianã®SSM+SpringBootç³»åˆ— (7)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/ruoyi/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ“ geqianã®è‹¥ä¾æ¡†æ¶ (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/mysql/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">â“ geqianã®mysql (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://itgeqian.github.io/categories/Redis/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">ğŸ’– geqianã®Redis (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item" style="visibility: hidden"></div><a class="magnet_link_more"  href="https://itgeqian.github.io/categories/" style="flex:1;text-align: center;margin-bottom: 10px;">æŸ¥çœ‹æ›´å¤š...</a></div></div>';
    console.log('å·²æŒ‚è½½magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(33.333333333333336% - 5px);background: #e9e9e9;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: var(--text-bg-hover)}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementById('recent-posts');
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/60.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/geqian-Blos/%E5%8F%A4%E9%A3%8E.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-09-30</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/60.html&quot;);" href="javascript:void(0);" alt="">é€Ÿé€šSpring AI Alibaba </a><div class="blog-slider__text">é€Ÿé€šSpring AI Alibaba å®Œç»“</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/60.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/37.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-04-02</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/37.html&quot;);" href="javascript:void(0);" alt="">GQ Videoå•æœåŠ¡ç‰ˆæœ¬è®°å½•</a><div class="blog-slider__text">GQ Videoå•æœåŠ¡ç‰ˆæœ¬è®°å½•ï¼ˆå®Œæ•´è®°å½•GQ Videoä»0åˆ°1çš„å…¨è®°å½•ï¼‰</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/37.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/74.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-09-06</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/74.html&quot;);" href="javascript:void(0);" alt="">Mysqlç›¸å…³é¢è¯•é¢˜</a><div class="blog-slider__text">æˆ‘å¯¹mysqlçš„ç›¸å…³ç†è§£</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/74.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/77.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://u7imgblog.oss-cn-hangzhou.aliyuncs.com/blogbackground/wallhaven-o59q2m.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-10-07</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/77.html&quot;);" href="javascript:void(0);" alt="">javase+é›†åˆç›¸å…³é¢è¯•é¢˜</a><div class="blog-slider__text">æˆ‘å¯¹javaåŸºç¡€å’Œé›†åˆç±»çš„ç›¸å…³ç†è§£</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/77.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" onclick="pjax.loadUrl(&quot;posts/68.html&quot;);" href="javascript:void(0);" alt=""><img width="48" height="48" src="https://java-geqian.oss-cn-beijing.aliyuncs.com/geqian-Blos/22.jpg" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-10-01</span><a class="blog-slider__title" onclick="pjax.loadUrl(&quot;posts/68.html&quot;);" href="javascript:void(0);" alt="">JUCé¢è¯•é¢˜</a><div class="blog-slider__text">æˆ‘å¯¹JUCçš„ç†è§£</div><a class="blog-slider__button" onclick="pjax.loadUrl(&quot;posts/68.html&quot;);" href="javascript:void(0);" alt="">è¯¦æƒ…       </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('å·²æŒ‚è½½butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper@1.0.12/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper@1.0.12/lib/swiper_init.js"></script><script data-pjax src="https://npm.elemecdn.com/hexo-filter-gitcalendar/lib/gitcalendar.js"></script><script data-pjax>
  function gitcalendar_injector_config(){
      var parent_div_git = document.getElementById('gitZone');
      var item_html = '<div class="recent-post-item" id="gitcalendarBar" style="width:100%;height:auto;padding:10px;"><style>#git_container{min-height: 320px}@media screen and (max-width:650px) {#git_container{min-height: 0px}}</style><div id="git_loading" style="width:10%;height:100%;margin:0 auto;display: block;"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve"><path fill="#d0d0d0" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z" transform="rotate(275.098 25 25)"><animatetransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"></animatetransform></path></svg><style>#git_container{display: none;}</style></div><div id="git_container"></div></div>';
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      console.log('å·²æŒ‚è½½gitcalendar')
      }

    if( document.getElementById('gitZone') && (location.pathname ==='/site/census/'|| '/site/census/' ==='all')){
        gitcalendar_injector_config()
        GitCalendarInit("/api?null",['#d9e0df', '#c6e0dc', '#a8dcd4', '#9adcd2', '#89ded1', '#77e0d0', '#5fdecb', '#47dcc6', '#39dcc3', '#1fdabe', '#00dab9'],'null')
    }
  </script><div class="js-pjax"><script async="async">var arr = document.getElementsByClassName('recent-post-item');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script><script async="async">var arr = document.getElementsByClassName('card-widget');
for(var i = 0;i<arr.length;i++){
    arr[i].classList.add('wow');
    arr[i].classList.add('animate__zoomIn');
    arr[i].setAttribute('data-wow-duration', '2s');
    arr[i].setAttribute('data-wow-delay', '200ms');
    arr[i].setAttribute('data-wow-offset', '30');
    arr[i].setAttribute('data-wow-iteration', '1');
  }</script></div><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow.min.js"></script><script defer src="https://npm.elemecdn.com/hexo-butterfly-wowjs/lib/wow_init.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>