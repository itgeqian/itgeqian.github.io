<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>geqian&#39;s Blog🍭</title>
  
  
  <link href="https://itgeqian.github.io/atom.xml" rel="self"/>
  
  <link href="https://itgeqian.github.io/"/>
  <updated>2025-11-27T12:15:57.863Z</updated>
  <id>https://itgeqian.github.io/</id>
  
  <author>
    <name>geqian&#39;s Blog🍭</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title></title>
    <link href="https://itgeqian.github.io/posts/0.html"/>
    <id>https://itgeqian.github.io/posts/0.html</id>
    <published>2025-11-27T12:15:57.698Z</published>
    <updated>2025-11-27T12:15:57.863Z</updated>
    
    <content type="html"><![CDATA[<h1 id="GQ-JUC">GQ JUC</h1><h2 id="JUC">JUC</h2><h3 id="进程、线程、协程的区别">进程、线程、协程的区别</h3><p>进程负责“资源”，线程负责“执行”，协程负责“更轻量的执行方式”。</p><h4 id="进程是什么？（资源隔离-独立内存）">进程是什么？（资源隔离+独立内存）</h4><ul><li>进程<strong>就是一个程序的运行实例</strong>，<strong>比如你打开一个微信，就是一个进程</strong>。</li><li><strong>每个进程有自己独立的内存空间、文件句柄</strong>等资源，<strong>是操作系统中资源分配的最小单位</strong>。</li><li>不同进程之间互不影响，因此<strong>稳定性高，但创建和切换成本大</strong>。</li></ul><h4 id="线程是什么？（执行单元-更轻量）">线程是什么？（执行单元+更轻量）</h4><p><strong>线程是进程内部的“执行流”，一个进程可以有多个线程</strong>。<br><strong>线程之间共享同一个进程的内存</strong>，因此通信非常方便，但安全性要靠加锁保证。<br>线程是<strong>CPU 调度的最小单位</strong>，切换比进程轻量，但仍需要 OS 参与调度。</p><h4 id="协程是什么？（用户态、极轻、高并发）">协程是什么？（用户态、极轻、高并发）</h4><p><strong>协程是比线程更轻量的“用户态调度”的执行方式，不会被 OS 感知。</strong><br>它把切换时机交给程序自己决定，而不是让 OS 抢占式调度，因此切换开销极低。<br>常用于大量 I/O 任务，比如 Go 的 goroutine、Java 的虚拟线程。</p><ul><li>进程：资源独立、安全但重 → “房子”</li><li>线程：共享资源、切换轻 → “房子里的房间”</li><li>协程：极轻量、用户态调度 → “房间里的小隔断，不需要 OS 管”</li></ul><h4 id="执行成本对比">执行成本对比</h4><table><thead><tr><th>对比项</th><th>进程</th><th>线程</th><th>协程</th></tr></thead><tbody><tr><td>创建成本</td><td>高</td><td>中</td><td>很低</td></tr><tr><td>切换成本</td><td>高（OS 切换）</td><td>中（OS 切换）</td><td>极低（用户态切换）</td></tr><tr><td>内存隔离</td><td>完全隔离</td><td>共享</td><td>共享，逻辑更轻</td></tr><tr><td>调度者</td><td>OS</td><td>OS</td><td>程序自身</td></tr></tbody></table><h4 id="小结">小结</h4><ul><li><strong>进程是操作系统分配资源的单位，每个进程有独立的内存，因此安全但切换成本高</strong>。</li><li><strong>线程是进程里的执行单元，共享进程资源，切换比进程快但需要同步锁来保证安全</strong>。</li><li><strong>协程更轻量，它在用户态调度，不需要 OS 参与，所以切换成本非常低，非常适合 I/O 密集的高并发场景，比如 Go 的 goroutine 或 Java 的虚拟线程</strong>。</li></ul><h4 id="什么是-Java-中的线程同步？">什么是 Java 中的线程同步？</h4><p>线程同步其实就是在多线程环境中，<strong>保证同一时刻只有一个线程能访问某个共享资源</strong>，<strong>避免多个线程同时操作同一个资源时出现数据不一致或竞争条件的问题。</strong></p><p>线程同步有很多方式，常用的包括 <strong>synchronized、ReentrantLock 和原子类</strong>，它们的<strong>主要目的是保证数据的一致性和线程间的协调。</strong></p><ul><li>synchronized：它可以锁定代码块或者方法，确保同一时刻只有一个线程能执行这个方法或代码块</li><li>ReentrantLock 也是一种很常用的同步工具，它提供了更高的灵活性，比如可以尝试加锁、定时加锁等</li><li>Java 还提供了 Atomic 类系列，比如 AtomicInteger、AtomicLong 等，这些类通过原子操作来保证线程安全，避免了锁的使用<ul><li>原理是这些原子类通过<strong>硬件级别的原子操作</strong>来实现操作的原子性。</li></ul></li></ul><h3 id="并行与并发-同步与异步">并行与并发,同步与异步</h3><ul><li>同步:<strong>需要等待结果返回</strong>，才能继续运行</li><li>异步:<strong>不需要等待结果返回</strong>，就能继续运行</li><li>并行：在同一时刻，有多个指令在多个 CPU 上同时执行, <strong>同一时间同时做多件事情的能力</strong>。多个人做多件事。</li><li>并发：在同一时刻，有多个指令在单个 CPU 上交替执行, <strong>同一时间段处理多件事情的能力</strong>。一个人做多件事。</li></ul><h3 id="Java-中的线程安全是什么意思？">Java 中的线程安全是什么意思？</h3><p>线程安全指的是<strong>在多线程环境下，多个线程同时访问某个共享资源时，不会出现数据不一致或修改错误的情况</strong>。当一个类或方法是线程安全的时，多个线程可以并发访问它，不需要担心在执行过程中数据会被其他线程改变。它能够确保在执行的过程中，不会出现<strong>竞争条件、死锁</strong>等问题。</p><p><strong>为什么线程安全很重要？</strong></p><p>在多线程环境中，<strong>多个线程可能会同时对同一数据进行操作</strong>。如果没有合适的同步措施，可能会导致数据被意外修改，最终产生不一致的结果。线程安全可以避免这种情况，保证每个线程访问的数据都是正确和一致的。</p><h3 id="什么是协程？Java-支持协程吗？">什么是协程？Java 支持协程吗？</h3><p>协程其实<strong>是比线程更加轻量的执行单元</strong>，它允许在执行过程中暂停，然后恢复执行，像是在线程内做任务切换，但比线程效率更高。<br>jdk19引入了虚拟线程，jdk21确认,可以认为是java对协程的一种实现。</p><p>通过虚拟线程，我们可以在同一个线程池里高效地管理成千上万个线程，这样就能大大提高并发性能，特别是在需要大量并发但每个任务执行时间短的场景下。</p><h3 id="线程的生命周期在-Java-中是如何定义的？">线程的生命周期在 Java 中是如何定义的？</h3><h4 id="从-Java-API-层面来描述的有六种状态">从 Java API 层面来描述的有六种状态</h4><img src="https://pic.code-nav.cn/mianshiya/question_picture/1942188251568476161/hqsWVhAF_image-1282-1024x707_mianshiya.png" alt="image-1282-1024x707.png" width="100%" /><img src="https://pic.code-nav.cn/mianshiya/question_picture/1942188251568476161/aHn58qBx_image_mianshiya.png" alt="image.png" width="100%" /><img src="https://pic.code-nav.cn/mianshiya/question_picture/1942188251568476161/X7NwTGDu_Snipaste_2025-11-01_21-45-22_mianshiya.png" alt="Snipaste_2025-11-01_21-45-22.png" width="100%" /><h4 id="从-操作系统-层面来描述有五种状态">从 操作系统 层面来描述有五种状态</h4><img src="https://pic.code-nav.cn/mianshiya/question_picture/1942188251568476161/teERwW4V_Snipaste_2025-11-01_21-46-15_mianshiya.png" alt="Snipaste_2025-11-01_21-46-15.png" width="100%" /><img src="https://pic.code-nav.cn/mianshiya/question_picture/1942188251568476161/g0PGz6c3_Snipaste_2025-11-01_21-46-35_mianshiya.png" alt="Snipaste_2025-11-01_21-46-35.png" width="100%" /><h3 id="Java-中线程之间如何进行通信？">Java 中线程之间如何进行通信？</h3><p>在 Java 中，线程之间的通信通常是为了实现多个线程在共享资源上进行协作。主要的方式包括：</p><ol><li>共享变量</li></ol><p>多个线程可以通过访问共享变量来交换信息。为了确保线程安全，必须小心使用共享数据，避免线程间的竞争条件或数据不一致。<br>2. 同步机制</p><p>常见的同步机制包括：</p><ul><li>synchronized：用 Java 中的 synchronized 关键字来保证同一时刻只有一个线程能访问共享资源。线程间通过 wait() 和 notify() 等方法进行通信。</li><li>ReentrantLock：提供了类似于 synchronized 的锁机制，允许线程在执行过程中对共享资源进行同步。</li><li>BlockingQueue：提供阻塞队列来控制生产者与消费者的消费模式。</li><li>CountDownLatch：允许一个或多个线程等待，直到其他线程完成某项操作。</li><li>CyclicBarrier：允许多个线程相互等待，直到某个条件满足才继续执行。</li><li>Semaphore：用于控制访问共享资源的线程数量，限制并发线程的数量。</li></ul><h3 id="Java-中如何创建多线程？">Java 中如何创建多线程？</h3><p>在Java中创建多线程有几种常见的方式：</p><ol><li>使用 Thread 类：<br>通过继承 Thread 类，重写 run() 方法，并调用 start() 来启动线程。这是最基础的方式，但它不够灵活，<strong>任务和线程是绑定在一起的，无法重用任务。</strong></li></ol><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public void run() &#123;</span><br><span class="line">        <span class="type">System</span>.out.println(<span class="string">&quot;Thread running&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">MyThread</span> thread = <span class="keyword">new</span> <span class="type">MyThread</span>();</span><br><span class="line">thread.start();</span><br></pre></td></tr></table></figure><ol start="2"><li>使用 Runnable 配合 Thread：<br>这种方法通过实现 Runnable 接口来<strong>分离任务和线程</strong>。创建一个 Runnable 实例，将其传递给 Thread 来启动线程。这种方式更灵活，任务可以被多个线程重用，且更适合与线程池等高级API一起使用。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Runnable</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Thread running&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r);</span><br><span class="line">t.start();</span><br></pre></td></tr></table></figure><ol start="3"><li>使用 FutureTask 配合 Callable：<br><strong>当线程需要返回结果时</strong>，使用 Callable 接口代替 Runnable，并配合 FutureTask 来执行任务。<strong>FutureTask 可以获取任务的返回结果，并且支持异常捕获</strong>。</li></ol><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Callable&lt;<span class="built_in">Integer</span>&gt; task = <span class="literal">new</span> Callable&lt;<span class="built_in">Integer</span>&gt;() &#123;</span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">Integer</span> call() throws Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">FutureTask&lt;<span class="built_in">Integer</span>&gt; futureTask = <span class="literal">new</span> FutureTask&lt;&gt;(task);</span><br><span class="line"><span class="keyword">Thread</span> <span class="keyword">thread</span> = <span class="literal">new</span> <span class="keyword">Thread</span>(futureTask);</span><br><span class="line"><span class="keyword">thread</span>.start();</span><br><span class="line"><span class="built_in">Integer</span> result = futureTask.get();  <span class="comment">// 阻塞等待结果</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ol start="4"><li>使用线程池 (ExecutorService)：<br><strong>使用 ExecutorService 管理线程池</strong>，可以方便地提交 Runnable 或 Callable 任务，适合处理大量并发任务而不需要手动管理线程。</li></ol><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService executor = Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">executor.submit<span class="function"><span class="params">(() -&gt; System.out.println(<span class="string">&quot;Running in thread pool&quot;</span>))</span>;</span></span><br><span class="line"><span class="function"><span class="title">executor</span>.<span class="title">shutdown</span><span class="params">()</span>;</span></span><br></pre></td></tr></table></figure><ol start="5"><li>使用 CompletableFuture：<br>Java 8 引入了 CompletableFuture，提供了<strong>更方便的异步任务执行和任务间的依赖关系处理</strong>。<strong>它是基于线程池（默认使用 ForkJoinPool）实现的，可以链式调用不同的异步操作</strong>。</li></ol><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture.runAsync<span class="function"><span class="params">(() -&gt; &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    System.out.println(<span class="string">&quot;Async task running&quot;</span>);</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;)</span>.<span class="title">thenAccept</span><span class="params">(result -&gt; System.out.println(<span class="string">&quot;Task completed&quot;</span>))</span>;</span></span><br></pre></td></tr></table></figure><h4 id="总结：">总结：</h4><ul><li>如果只是简单的创建一个线程，可以直接使用 Thread 类。</li><li>如果想解耦任务和线程，更灵活且复用性强，推荐使用 Runnable 配合 Thread。</li><li>如果需要线程执行后有返回值，使用 Callable 和 FutureTask。</li><li>如果有大量并发任务，使用线程池来管理线程。</li><li>如果任务之间有依赖关系，使用 CompletableFuture 处理异步任务。</li></ul><h3 id="你了解-Java-线程池的原理吗？">你了解 Java 线程池的原理吗？</h3><p>线程池：一个容纳多个线程的容器，容器中的线程可以重复使用，省去了频繁创建和销毁线程对象的操作</p><p>线程池作用：</p><ul><li>降低资源消耗，减少了创建和销毁线程的次数，每个工作线程都可以被重复利用，可执行多个任务</li><li>提高响应速度，当任务到达时，如果有线程可以直接用，不会出现系统僵死</li><li>提高线程的可管理性，如果无限制的创建线程，不仅会消耗系统资源，还会降低系统的稳定性，使用线程池可以进行统一的分配，调优和监控</li></ul><p>线程池的核心思想：<strong>线程复用</strong>，同一个线程可以被重复使用，来处理多个任务</p><p>池化技术 (Pool) ：一种编程技巧，核心思想是资源复用，在请求量大时能优化应用性能，降低系统频繁建连的资源开销</p><p>线程池的工作原理可以分为几个关键步骤：</p><ul><li>核心线程数（corePoolSize）：这是线程池中最小的线程数量。即使没有任务，线程池也会维持这些线程处于空闲状态。</li><li>最大线程数（maximumPoolSize）：线程池可以创建的最大线程数量。当有大量任务同时到达时，线程池会创建新线程，直到达到最大线程数。</li><li>空闲时间（keepAliveTime）：空闲线程在一定时间内没有任务执行时，线程池会回收它们以节省资源。这个时间是可以调节的。</li><li>时间单位</li><li>工作队列（workQueue）：这是用于保存提交的任务的队列。如果线程池中所有核心线程都在忙碌，任务就会被放入队列等待。</li><li>线程工厂（ThreadFactory）：用来创建新线程的工厂，可以自定义线程的创建方式。</li><li>拒绝策略（RejectedExecutionHandler）：当线程池中的任务数量达到最大线程数且队列已满时，线程池会采取拒绝策略，<strong>通常包括丢弃任务、抛出异常或者让任务在其他地方执行</strong>。</li></ul><p>常见的线程池类型包括：</p><ul><li>FixedThreadPool：一个固定大小的线程池，适用于负载较为稳定的场景。</li><li>CachedThreadPool：可以根据需要创建新线程，但在空闲时会回收线程，适用于任务数量不确定，且任务执行时间短的情况。</li><li>ScheduledThreadPool：可以定期执行任务或延迟执行任务的线程池。</li><li>SingleThreadExecutor：只有一个线程的线程池，适用于串行执行任务的场景。</li></ul><p>总结来说，线程池是为了避免频繁创建和销毁线程的性能问题，同时也提供了灵活的线程管理和任务调度机制，适用于大规模并发处理的场景。</p><p>补充：拒绝策略</p><img src="https://pic.code-nav.cn/mianshiya/question_picture/1942188251568476161/Is34VHXx_Snipaste_2025-11-02_20-27-12_mianshiya.png" alt="Snipaste_2025-11-02_20-27-12.png" width="100%" /><h3 id="如何合理地设置-Java-线程池的线程数？">如何合理地设置 Java 线程池的线程数？</h3><p>对于如何合理地设置 Java 线程池的线程数，可以通过<strong>分析任务的类型</strong>来进行优化。通常，任务类型可以分为两类：<strong>CPU 密集型任务</strong>和<strong>I/O 密集型任务</strong>。</p><ol><li><p><strong>CPU 密集型任务</strong>：<strong>这些任务主要依赖 CPU 进行计算，如数学运算等</strong>。在这种情况下，线程数的设置应根据 CPU 核心数来决定。为了充分利用 CPU 的计算资源，线程池的核心线程数可以设置为 <strong>CPU 核心数 + 1</strong>，这样可以充分利用 CPU 的空闲时间，避免过多线程的竞争。</p></li><li><p><strong>I/O 密集型任务</strong>：这类任务大多依赖 I/O 操作，如文件读写、网络请求等。在进行 I/O 操作时，线程并不占用 CPU 资源，因此可以增加线程池的线程数。通常可以将线程数设置为 <strong>2 倍 CPU 核心数</strong>，因为大多数 I/O 操作会阻塞线程，这时可以充分利用 CPU 执行其他任务。</p></li></ol><p>总结：</p><ul><li>对于 <strong>CPU 密集型</strong> 任务，线程数应该设置为 <strong>CPU 核心数 + 1</strong>，这样可以避免线程过多导致的上下文切换和 CPU 资源浪费。</li><li>对于 <strong>I/O 密集型</strong> 任务，线程数可以设置为 <strong>2 倍 CPU 核心数</strong>，这样可以充分利用线程池的线程而不造成过多阻塞。</li></ul><p>如果业务中同时有这两种类型的任务，推荐根据任务的比例来动态调整线程池的大小。</p><h3 id="Java-线程池有哪些拒绝策略？">Java 线程池有哪些拒绝策略？</h3><p>在 Java 中，线程池有四种拒绝策略：</p><ul><li>默认是 AbortPolicy，也就是<strong>当线程池满了，系统会抛出异常</strong>，提醒你有任务无法被处理。</li><li>CallerRunsPolicy 是<strong>让提交任务的线程（调用者线程）自己执行任务</strong>。适合你希望通过减缓任务提交的速度来避免系统过载的场景。</li><li>DiscardOldestPolicy 则会<strong>丢弃队列中最旧的任务</strong>，保留新的任务继续执行。如果你希望保留当前任务并丢弃掉早些提交的任务，这个策略就很合适。</li><li>DiscardPolicy 是最简单粗暴的，它会<strong>直接丢弃任务</strong>，不做任何处理，适合在高负载时只保留最重要的任务。</li></ul><h3 id="Java-并发库中提供了哪些线程池实现？它们有什么区别？">Java 并发库中提供了哪些线程池实现？它们有什么区别？</h3><p>在 Java 的并发库中，主要有五种常见的线程池实现，它们分别是：</p><ul><li>FixedThreadPool：这是一个<strong>固定大小的线程池</strong>。线程数是固定的，如果有任务来时，线程池会先检查当前是否有空闲线程，如果有就执行任务，如果没有，它会将任务排队等待。适合任务量稳定的场景。</li><li>CachedThreadPool：这个线程池<strong>可以动态调整线程数。线程池会根据任务需求创建新线程</strong>，如果现有的线程没有被使用，它会在60秒后自动回收。这种线程池适合处理大量短时间任务的场景，但如果任务量过多，可能会导致内存溢出（OOM）。</li><li>SingleThreadExecutor：这就是一个<strong>单线程池</strong>，它只会有一个线程来执行所有任务。如果一个任务执行失败，后续的任务也会被阻塞，直到当前任务完成。<strong>适用于需要确保任务按顺序执行的场景</strong>。</li><li>ScheduledThreadPool：这是一个<strong>支持定时任务的线程池</strong>。它可以定期或延迟执行任务，适用于定时执行任务或延时执行的场景。</li><li>WorkStealingPool：这个线程池是<strong>基于工作窃取算法设计</strong>的。它是<strong>从多个线程中窃取工作来优化任务执行</strong>，适用于任务之间相对独立，且负载不均匀的情况。</li></ul><p><strong>总结：如果你有一堆任务并且任务量比较大，固定线程池和缓存线程池更适合；如果任务量不大，但需要定时执行，使用 ScheduledThreadPool。如果任务之间有很强的顺序性，可以使用 SingleThreadExecutor。如果任务负载不均匀，WorkStealingPool 是一个不错的选择。</strong></p><h3 id="Java-线程池核心线程数在运行过程中能修改吗？如何修改？">Java 线程池核心线程数在运行过程中能修改吗？如何修改？</h3><p>在 Java 中，我们是可以动态地调整线程池的核心线程数的。可以通过调用 ThreadPoolExecutor 的 setCorePoolSize() 方法来修改核心线程数。需要注意的是，减少核心线程数时，空闲的多余线程不会立刻回收，只有等到它们一段时间没有任务执行后才会被回收。而且，这个修改不会影响正在执行的任务，所以它是即时生效的。</p><h3 id="Java-线程池中-shutdown-与-shutdownNow-的区别是什么？">Java 线程池中 shutdown 与 shutdownNow 的区别是什么？</h3><ul><li>shutdown() 用于优雅地关闭线程池，<strong>它会停止接受新任务，但会继续执行队列中已提交的任务</strong>，直到全部完成为止。</li><li>shutdownNow() 会<strong>立即尝试停止所有任务</strong>，返回当前尚未执行的任务列表，并<strong>尽可能通过中断线程来停止正在执行的任务</strong>。如果任务无法处理中断，它们仍然可能继续执行，直到任务完成。</li></ul><p>这两种方法主要的区别在于是否会强制中断正在执行的任务，shutdown() 是平稳退出，而 shutdownNow() 是立即中止。</p><h3 id="Java-线程池内部任务出异常后，如何知道是哪个线程出了异常？">Java 线程池内部任务出异常后，如何知道是哪个线程出了异常？</h3><p>在Java的线程池中，如果线程执行的任务抛出异常，<strong>默认情况下线程池并不会主动告诉你是哪个线程出了问题</strong>，但我们有几种方式可以捕获这个异常信息。</p><ul><li><p>首先，如果你使用 ThreadFactory 来创建线程池，<strong>可以自定义 UncaughtExceptionHandler 来处理每个线程中的异常</strong>。这样，线程在遇到未处理的异常时，就会调用 UncaughtExceptionHandler，你可以在其中记录线程的异常信息。</p></li><li><p>其次，在线程任务执行时，我们可以使用 <strong>Future</strong>。当使用 submit() 提交任务时，我们可以通过返回的 Future 对象来检查任务是否执行成功，如果任务有异常，可以通过 get() 方法时候try-catch捕获异常。</p></li><li><p>最后，在<strong>run方法内部</strong>，我们还可以使用 <strong>try-catch</strong> 来捕获异常，避免任务因为异常直接失败。在捕获异常后，我们可以记录或者处理异常，也能确保任务不会导致线程池停止。</p></li></ul><p>总的来说，我们可以通过 ThreadFactory 来为每个线程设置异常处理器，使用 Future 对象来捕获任务异常，并在任务内部加入 try-catch 来处理异常，确保线程池中的任务都能被监控和管理。</p><h3 id="Java-中的-DelayQueue-和-ScheduledThreadPool-有什么区别？">Java 中的 DelayQueue 和 ScheduledThreadPool 有什么区别？</h3><p>在 Java 中，DelayQueue 和 ScheduledThreadPoolExecutor 都是用于处理延迟任务的工具，但它们的实现原理和使用场景有所不同。</p><ol><li>DelayQueue：</li></ol><p>DelayQueue 是一个<strong>阻塞队列</strong>，它<strong>基于元素的延迟时间来控制任务的执行顺序</strong>。每个元素都有一个指定的延迟时间，元素不会立刻被处理，只有在延迟时间到了之后，它才会从队列中被取出执行。</p><p>它通常与 ReentrantLock 和 Condition 配合使用，确保任务在合适的时间被执行。</p><ol start="2"><li>ScheduledThreadPoolExecutor：</li></ol><p>这是一个专门<strong>用于执行定时任务和周期任务的线程池</strong>。它允许你<strong>定期执行任务或延迟执行任务</strong>，常用于周期性任务的调度。</p><p>ScheduledThreadPoolExecutor 提供了比 DelayQueue 更灵活的任务调度功能，比如支持固定延迟任务、定时执行等。</p><h3 id="什么是-Java-的-Timer？">什么是 Java 的 Timer？</h3><p>Java 中的 Timer 是用来<strong>定时执行任务的工具</strong>，通常和<strong>TimerTask</strong>搭配使用，TimerTask是需要执行的任务。你可以用 <strong>schedule() 来延时执行任务</strong>，或者用 <strong>scheduleAtFixedRate() 来做周期性任务</strong>。它内部有一个专门的线程去管理这些任务。</p><p>不过，<strong>Timer 是单线程的</strong>，如果任务的执行时间比预定的时间长，可能会影响后续任务的执行，造成任务延迟。因此在高并发场景下，Timer 可能不是最优选择，通常我们会推荐使用 <strong>ScheduledExecutorService 来替代 Timer</strong>，因为它提供了更高效的多线程任务调度。</p><h3 id="你了解时间轮（Time-Wheel）吗？有哪些应用场景？">你了解时间轮（Time Wheel）吗？有哪些应用场景？</h3><p>时间轮是一种高效的定时任务调度算法，<strong>它通过将时间切分为多个固定的时间槽，并将任务分配到这些时间槽中，来实现任务的定时执行</strong>。当时间轮转到某个槽时，槽内的任务就会执行。这个算法特别适合于需要处理大量定时任务的场景，因为它避免了频繁的时间比较，提升了效率。比如在高并发的网络服务中，时间轮可以用来优化定时任务的调度，减少系统的负担。</p><h3 id="你使用过哪些-Java-并发工具类？">你使用过哪些 Java 并发工具类？</h3><img src="https://pic.code-nav.cn/mianshiya/question_picture/1942188251568476161/OqI0Cf8H_Snipaste_2025-11-04_14-15-17_mianshiya.png" alt="Snipaste_2025-11-04_14-15-17.png" width="100%" /><h3 id="什么是-Java-的-Semaphore？">什么是 Java 的 Semaphore？</h3><p>在 Java 中，Semaphore（信号量）是一个用于控制访问共享资源的工具类。<strong>它通过维护一定数量的许可证来管理线程访问资源的权限</strong>，确保在任何时刻，只有限定数量的线程能够访问资源。线程需要先通过 acquire() 获取许可证才能访问资源，使用完毕后必须通过 release() 来释放许可证。它支持两种模式：<strong>公平模式</strong>，线程按照顺序获取许可，<strong>避免饥饿</strong>；<strong>非公平模式</strong>，则是线程可以抢先获取许可证，可能导致<strong>不公平的资源分配</strong>。</p><h3 id="什么是-Java-的-CyclicBarrier？">什么是 Java 的 CyclicBarrier？</h3><p>CyclicBarrier 是一种同步工具类，<strong>允许一组线程在执行某些任务时相互等待，直到所有线程都到达某个指定的“屏障点”时，才会继续执行</strong>。它通常用于需要协调多个线程按一定顺序执行的场景。</p><blockquote><p>工作原理：</p></blockquote><p>CyclicBarrier 内部维护<strong>一个计数器</strong>，表示需要等待的线程数。<strong>每当一个线程执行 await() 方法时，计数器就会减1，直到计数器的值为0，所有等待的线程才会被唤醒，继续执行。</strong></p><p>可以通过传入一个 Runnable 的 barrierAction 来定义屏障到达时要执行的操作，这个操作会在所有线程到达屏障后执行。</p><blockquote><p>应用场景：</p></blockquote><ul><li>并行任务协调：比如，多个线程执行某些计算任务，并且在每个阶段后需要等待其他线程，保证每个阶段都同步进行。</li><li>批量任务处理：在分布式计算或者并行任务处理时，可以用来协调多个线程的工作，确保所有线程都完成了某个阶段的工作后才进入下一个阶段。</li></ul><h3 id="什么是-Java-的-CountDownLatch？">什么是 Java 的 CountDownLatch？</h3><p>CountDownLatch 是一个同步辅助工具，属于 JUC（Java 并发工具包）的一部分，<strong>它允许一个线程等待多个线程完成某项任务</strong>。通过一个计数器来实现，每当一个线程完成工作时，就会减少一个数字，当计数器的值减到零时，所有等待的线程将被唤醒并继续执行。</p><p>主要功能：</p><ul><li>等待其他线程完成任务：通过 await() 方法，线程会等待其他线程完成其任务。</li><li>减少计数器：当某个线程完成工作时，调用 countDown() 方法将计数器的值减一。</li><li>所有线程完成时再执行：当计数器的值减到零时，所有等待的线程会被唤醒，继续执行。</li></ul><p>应用场景：</p><ul><li><strong>并行任务的协同工作</strong>：比如有多个线程并行执行任务，主线程需要等所有线程都完成后再继续执行。CountDownLatch 很适合这种场景，比如启动多个线程进行并行处理，主线程在所有线程完成任务后再进行合并处理。</li></ul><p>比较CountDownLatch 和 CyclicBarrier 的区别</p><ul><li>CyclicBarrier 是可以重用的，所有线程到达屏障后自动重置。</li><li>CountDownLatch 一次性使用，一旦计数器归零就不能再使用。</li></ul><h3 id="什么是-Java-的-StampedLock？">什么是 Java 的 StampedLock？</h3><p>StampedLock 是 Java 8 新增的一种锁机制，它通过<strong>引入乐观读锁提高了性能</strong>，特别适用于<strong>读多写少的场景</strong>。它有三种锁模式：写锁、悲观读锁和乐观读锁。<br>写锁</p><ul><li>独占锁，类似于 ReentrantLock 的写锁。它确保其他线程不能获取到写锁或读锁。</li></ul><p>悲观读锁</p><ul><li>共享锁，允许多个线程同时获取读锁，但不允许有线程获取写锁。</li></ul><p>乐观读锁</p><ul><li>不加锁，允许线程在没有竞争的情况下进行快速读。只有在检测到写操作发生时，它才会回退到悲观读锁。</li></ul><p>最特别的是，StampedLock 还会返回一个时间戳，代表当前锁的状态，线程可以利用这个时间戳来判断锁是否还有效，从而决定是否继续执行操作。</p><h3 id="什么是-Java-的-CompletableFuture？">什么是 Java 的 CompletableFuture？</h3><p>在 Java 8 中，<strong>CompletableFuture 是为了简化异步编程而引入的工具</strong>。你可以把它想象成一个<strong>可以在后台执行任务的对象</strong>，它支持异步执行，也就是你可以启动一个任务，它会在后台进行计算，计算结果一旦出来，你可以拿到它做后续处理。</p><p>最核心的几个特性是：</p><ul><li><strong>异步执行</strong>：使用 runAsync() 或 supplyAsync() 方法，你可以<strong>让任务在后台异步执行，这样不会阻塞主线程</strong>。</li><li><strong>任务组合</strong>：你可以使用 thenApply() 或 thenAccept() 等方法<strong>在任务完成后进行处理，支持链式调用。</strong></li><li><strong>并行任务</strong>：CompletableFuture <strong>允许你同时执行多个任务</strong>，并且可以通过 .allOf() 来<strong>合并这些任务的结果</strong>。</li><li><strong>异常处理</strong>：如果异步任务执行过程中出错，你可以<strong>使用 exceptionally() 来处理异常</strong>，避免程序崩溃。</li></ul><p>CompletableFuture 的优势在于<strong>它让你可以轻松地处理异步操作，特别是当你需要执行多个任务并且希望它们能并行执行时，非常适合用它</strong>。而且，通过链式调用，你可以简化代码逻辑，不需要复杂的回调函数。&quot;</p><p>总结<br>CompletableFuture 是<strong>处理异步编程非常强大的工具</strong>，它提供了各种方法来<strong>执行异步任务，管理结果，处理异常，并支持多个任务的并行执行</strong>，特别适合在<strong>需要高效处理并发任务的场景中使用</strong>。</p><h3 id="什么是-Java-的-ForkJoinPool？">什么是 Java 的 ForkJoinPool？</h3><p>ForkJoinPool 是 Java 7 引入的一个线程池，主要用来<strong>处理大规模的并行任务</strong>。它采用了“<strong>分而治之</strong>”的方式，<strong>把一个大任务分解成多个小任务进行并行处理</strong>，<strong>所有任务完成后再合并结果</strong>。它的工作方式是通过两个操作：<strong>fork 来分解任务</strong>，<strong>join 来合并结果</strong>。</p><p>ForkJoinPool 使用了<strong>工作窃取算法</strong>，ForkJoinPool是WorkStealingPool的底层，<strong>这意味着如果有线程空闲，它会去偷取其他线程没有完成的任务，从而提高并行度和资源利用率</strong>。常见的相关任务类是 RecursiveTask（有返回值的任务）和 RecursiveAction（无返回值的任务）。</p><p>这个池子<strong>特别适合用于需要大量并行处理的计算任务，比如大数据处理或者需要执行递归算法的场景</strong>。</p><h3 id="如何在-Java-中控制多个线程的执行顺序？">如何在 Java 中控制多个线程的执行顺序？</h3><p>在 Java 中，控制多个线程的执行顺序有多种方式，常用的方法包括：</p><ol><li><p><strong>CompletableFuture 的 <code>thenRun</code> 方法</strong>：</p><ul><li>如果你有多个任务（例如 T1、T2、T3），你可以使用 <code>thenRun</code> 方法来保证这些任务按顺序执行。每个任务会在上一个任务完成后才开始执行。这种方法适合于处理并发任务，并且保证顺序。</li></ul><p>示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture.runAsync(() -&gt; &#123; doTask1(); &#125;)</span><br><span class="line">    .thenRun(() -&gt; &#123; doTask2(); &#125;)</span><br><span class="line">    .thenRun(() -&gt; &#123; doTask3(); &#125;);</span><br></pre></td></tr></table></figure></li><li><p><strong>synchronized + wait/notify</strong>：</p><ul><li>使用 <code>synchronized</code> 来加锁，结合 <code>wait</code> 和 <code>notify</code> 来控制线程间的执行顺序。<code>wait</code> 用于让一个线程暂停，直到收到其他线程的通知（<code>notify</code>）才继续执行。</li></ul></li><li><p><strong>ReentrantLock 配合 Condition 的 <code>await</code>、<code>signal</code>、<code>signalAll</code></strong>：</p><ul><li>通过 <code>ReentrantLock</code> 和 <code>Condition</code>，你可以更加细粒度地控制线程的执行顺序。例如，使用 <code>await</code> 使线程等待，直到其他线程通过 <code>signal</code> 或 <code>signalAll</code> 通知它们继续执行。</li></ul></li><li><p><strong>CountDownLatch</strong>：</p><ul><li><code>CountDownLatch</code> <strong>可以用来让多个线程等待直到其他线程完成指定的工作</strong>。通过调用 <code>countDown()</code> 来减少计数，直到计数为零，所有线程才会继续执行。</li></ul></li><li><p><strong>CyclicBarrier</strong>：</p><ul><li><code>CyclicBarrier</code> <strong>允许一组线程在一个公共点等待，直到所有线程都到达这个点后再继续执行</strong>。适用于并行处理多任务，确保每个线程都完成到达某个阶段后再继续。</li></ul></li><li><p><strong>Thread 类的 <code>join()</code> 方法</strong>：</p><ul><li><strong><code>join()</code> 方法可以让一个线程等待另一个线程完成后再执行</strong>。通过调用 <code>join()</code>，主线程可以等待其他线程执行完后再继续。</li></ul></li><li><p><strong>LockSupport 的 <code>park</code> 和 <code>unpark</code> 方法</strong>：</p><ul><li><code>LockSupport</code> 提供了更底层的控制方法，<code>park()</code> 用来挂起线程，<code>unpark()</code> 用来恢复线程的执行。</li></ul></li><li><p><strong>Semaphore</strong>：</p><ul><li><code>Semaphore</code> 控制并发的线程数量，适用于控制访问某些资源的线程数量。通过设置许可数来限制并发线程的数量。</li></ul></li><li><p><strong>ExecutorService 的单线程执行</strong>：</p><ul><li>如果不关心线程池中的线程，<code>ExecutorService</code> 提供了顺序执行任务的功能，可以将任务提交给一个单线程执行。</li></ul></li></ol><h4 id="小结：">小结：</h4><ul><li><strong>最简洁</strong>的方式是 <code>Thread.join()</code>，非常直接，适合顺序依赖的场景。</li><li>如果你需要更复杂的控制，比如多个线程并发执行后再同步，使用 <code>CountDownLatch</code> 或 <code>CyclicBarrier</code> 更合适。</li><li>你可以根据任务的复杂度选择适合的工具，比如 <code>ReentrantLock</code> 和 <code>Condition</code> 提供更细粒度的控制。</li></ul><h3 id="你使用过-Java-中的哪些阻塞队列？">你使用过 Java 中的哪些阻塞队列？</h3><p>Java 提供了几种常见的阻塞队列，主要用于在多线程环境下处理线程间的任务传递。常见的有：</p><ul><li><strong>ArrayBlockingQueue</strong>：这是一个<strong>基于数组实现</strong>的队列，容量固定。生产者往队列里放数据时，如果队列满了，就会被阻塞；消费者取数据时，如果队列空了，也会被阻塞。<strong>适用于生产者-消费者模型</strong>。</li><li><strong>LinkedBlockingQueue</strong>：这是<strong>基于链表实现</strong>的队列，<strong>可以是有界的也可以是无界的</strong>。它在队列满时阻塞生产者，在队列空时阻塞消费者。</li><li><strong>PriorityBlockingQueue</strong>：这个队列<strong>没有容量限制</strong>，且任务<strong>按优先级排队</strong>。<strong>优先级高的任务会先被处理</strong>，适合需要优先级调度的场景。</li><li><strong>DelayQueue</strong>：这是一个专门<strong>处理延迟任务的队列</strong>，<strong>只有当任务的延迟时间到达时，才能取出</strong>。这适合用在需要定时执行的任务中。</li><li><strong>SynchronousQueue</strong>：这个队列没有任何容量，每一个put操作必须等待一个take操作。因此，它常用于<strong>线程之间直接的任务传递</strong>。</li><li><strong>TransferQueue</strong>：它是<strong>在LinkedBlockingQueue的基础上新增了transfer方法的队列</strong>。put操作不会立即阻塞，直到有一个take操作时，队列才会执行传递任务。</li></ul><h3 id="你使用过-Java-中的哪些原子类？">你使用过 Java 中的哪些原子类？</h3><p>在多线程编程中，有时候我们需要对共享数据进行操作，这时<strong>为了避免线程冲突和数据不一致的问题，我们通常会使用 Java 中的原子类</strong>。它们通过内置的原子性操作来确保线程安全，避免了传统的加锁操作。</p><p>最常用的原子类包括：</p><ul><li><strong>AtomicInteger</strong> 用来原子地增加或减少整数，比如在计数器等场景下；</li><li>AtomicLong 是 AtomicInteger 的长整型版本；</li><li>AtomicBoolean 用于处理布尔值，适用于类似于标志位的场景；</li><li><strong>AtomicReference</strong> 适用于<strong>引用类型的数据</strong>，能保证在多线程环境中更新对象的引用；</li><li><strong>AtomicStampedReference 则解决了 ABA 问题，它通过添加一个版本号来避免由于值相同导致的误判断。</strong></li><li>如果需要对数组中的每个元素进行类似的原子操作，可以使用 AtomicIntegerArray 和 AtomicLongArray。</li></ul><h3 id="你使用过-Java-的累加器吗？">你使用过 Java 的累加器吗？</h3><p>前提：为什么需要累加器？</p><p>AtomicLong 在并发很高时，所有线程都会去竞争同一个变量的 CAS 操作，导致严重的总线争用（CPU cache contention），性能急剧下降。</p><p>什么是java中的累加器？</p><p>在 Java 中，“累加器”通常指的是 LongAdder 和 DoubleAdder 这两个类。</p><p>它们是 JDK 1.8 引入的，目的是在高并发场景下提升计数性能，是对传统 AtomicLong、AtomicDouble 的优化。</p><p>LongAdder和DoubleAdder它们内部通过维护多个分段计数单元（Cell），让不同线程通过CAS更新不同的单元，最后再汇总求和，从而降低 CAS 冲突，提升性能。</p><h3 id="什么是-Java-的-CAS（Compare-And-Swap）操作？">什么是 Java 的 CAS（Compare-And-Swap）操作？</h3><p>CAS，全称是 Compare And Swap（比较并交换），是一种<strong>实现并发中原子操作的机制</strong>。</p><p>在修改一个变量时，CAS 会：</p><p>1.先读取变量当前的值（内存值）；<br>2.与期望值比较；</p><ul><li>2.1如果相等，则将变量更新为新值；</li><li>2.2如果不相等，说明其他线程修改过该值，则更新失败，通常会选择自旋重试。</li></ul><p>CAS 的<strong>底层是由 CPU 的原子指令</strong>（如 x86 的 CMPXCHG） 实现的，<strong>整个过程是不可中断的</strong>，因此能保证操作的原子性。</p><h4 id="CAS-的优点">CAS 的优点</h4><ul><li><strong>无锁并发</strong>：<strong>在不使用传统锁的情况下，也能保证线程安全</strong>，提高并发性能。</li><li><strong>原子性保障</strong>：<strong>借助硬件级别的指令支持</strong>，确保修改操作不会被打断。</li></ul><h4 id="CAS-的缺点与解决方案">CAS 的缺点与解决方案</h4><p>1.ABA 问题</p><ul><li>问题：一个变量从 A → B → A，CAS 检查时发现值没变，但实际上经历了变化。</li><li>解决：使用版本号机制，如AtomicStampedReference，在 CAS 时同时比较值和版本号。</li></ul><p>2.自旋开销大</p><ul><li>问题：如果多个线程频繁失败，会导致长时间自旋，浪费 CPU 资源。</li><li>解决：在一些高并发组件（如 SynchronousQueue）中限制自旋次数或结合锁机制使用。</li></ul><blockquote><p>CAS+锁这一套组合挺常见比如CourrentHashMap就是这样实现的，CAS 用于无锁写入，如果冲突严重再退化为锁定特定桶的头结点。</p></blockquote><p>3.只能操作一个共享变量<br>问题：CAS 只能针对单一变量进行原子操作。<br>解决：使用 AtomicReference 将多个变量封装为一个对象，实现复合 CAS。</p><h4 id="总结一句话">总结一句话</h4><p>CAS 是一种基于 CPU 原子指令的无锁机制，通过比较内存值和预期值，一致则更新，否则重试。</p><p>它的优点是高并发、无锁和线程安全，但缺点是可能出现 ABA问题、自旋开销大、无法操作多个变量，可以通过版本号或 AtomicReference 来优化</p><h3 id="说说-AQS-吧？">说说 AQS 吧？</h3><p>一.AQS 是什么</p><p>AQS，全称 AbstractQueuedSynchronizer（抽象队列同步器），是 JUC（java.util.concurrent）包中构建锁和同步器的基础框架。</p><p>AQS起到了一个抽象、封装的作用，将一些排队、入队、加锁、中断等方法提取出来，便于其他相关JUC锁的使用，具体加锁时机、入队时机等都需要实现类自己控制(它通过统一的同步状态管理和队列机制，简化了各种同步器（如锁、信号量、栅栏）的实现)。</p><p>二.AQS 的核心思想</p><p>AQS 通过维护一个同步状态变量（state）和一个FIFO 等待队列，来管理多个线程对共享资源的竞争。</p><ol><li>同步状态（state）</li></ol><ul><li><p>是一个 volatile int 变量，表示资源的占用情况。</p></li><li><p>对于独占锁：state = 0 表示未加锁，state = 1 表示已加锁。</p></li><li><p>对于共享锁：state 表示可同时获取锁的线程数（例如 Semaphore 的剩余许可数）。</p></li><li><p>等待队列（FIFO）</p></li><li><p>当线程获取锁失败时，会被封装为一个 Node 节点加入队列尾部。</p></li><li><p>当锁被释放时，AQS 会唤醒队列中第一个等待线程尝试获取锁。</p></li><li><p>队列是一个基于 CLH（Craig, Landin, and Hagersten） 算法实现的双向链表结构，保证线程排队公平。</p></li></ul><p>三、AQS 的工作流程</p><ul><li><p>线程尝试获取锁 → 修改 state（CAS 操作）。</p></li><li><p>如果失败 → 封装为 Node 节点加入队列，进入等待状态。</p></li><li><p>当前持锁线程释放锁后 → AQS 唤醒队列中的下一个节点线程。</p></li></ul><p>这样，AQS 就实现了一个通用的“排队获取锁”机制。</p><p>四、AQS 的典型实现类</p><p>基于 AQS 的同步组件包括：</p><ul><li><p>独占模式：ReentrantLock</p></li><li><p>共享模式：Semaphore、CountDownLatch、ReentrantReadWriteLock</p></li><li><p>条件队列：Condition（基于 AQS 的条件队列实现）</p></li></ul><p>五.总结一句话（精简口述版）</p><p>AQS 是 JUC 中实现各种锁和同步工具的核心框架。</p><p>它通过一个 state 状态变量和一个 FIFO 队列来管理线程的竞争。</p><p>加锁失败的线程会进入队列排队，释放锁后再唤醒队首线程。</p><p>常见的实现类包括 ReentrantLock、Semaphore、CountDownLatch 等。</p><p>一句话记忆口诀：</p><p>AQS：<strong>一个 state + 一个队列，构建所有并发锁</strong>。</p><h3 id="Java-中-ReentrantLock-的实现原理是什么？">Java 中 ReentrantLock 的实现原理是什么？</h3><p>ReentrantLock 实现原理</p><p>一、ReentrantLock 是基于 AQS 的实现</p><p>ReentrantLock 是 Java 中基于 AQS（AbstractQueuedSynchronizer） 的锁实现。</p><p>它支持以下特性：</p><ul><li><p>可重入性：同一线程可以多次获取锁。</p></li><li><p>公平与非公平：支持公平锁和非公平锁的选择。</p></li><li><p>可中断：可以响应中断，避免死锁。</p></li></ul><p>二、ReentrantLock 的内部结构</p><p>内部通过一个state变量和两个队列（同步队列和等待队列）来实现</p><p>1.state 变量</p><p>ReentrantLock 使用一个 state（通常是一个整数）来记录锁的状态。</p><p>例如，state = 0 表示锁没有被占用，state &gt; 0 表示锁已被线程占用，state 值还表示该线程持有锁的次数。</p><ol start="2"><li>同步队列（Sync Queue）</li></ol><p>用于存放所有等待获取锁的线程，是一个双向链表。线程在获取锁失败时会被加入同步队列，按照 FIFO 排队，直到锁可用。</p><p>3.等待队列（Condition Queue）</p><p>用于存放等待特定条件的线程，即使用 Condition 时会涉及到的队列，存放需要等待某些条件才能继续执行的线程。它是一个单向链表。</p><p>三、锁的公平性机制</p><ul><li>公平锁（Fair Lock）：</li></ul><p>当请求锁时，公平锁会判断当前线程是否是同步队列的第一个线程。如果是，它会尝试获取锁。如果不是，它会等到前面的线程释放锁后再尝试获取。公平锁避免了“饥饿”问题，保证线程按照请求的顺序获取锁。</p><ul><li>非公平锁（Non-fair Lock）：</li></ul><p>非公平锁则不会强制按照队列顺序获取锁，它会直接尝试获取锁，如果失败才会加入同步队列。这使得非公平锁获取锁的速度更快，但可能会导致一些线程长时间得不到锁（即“线程饥饿”问题）。</p><p>四、获取锁的过程</p><p>在 公平锁 中，获取锁时：</p><ul><li><p>首先判断当前线程是否为同步队列的第一个线程，或者同步队列是否为空。</p></li><li><p>如果是第一个线程，则尝试获取锁。</p></li><li><p>否则，当前线程会加入队列，等待前一个线程释放锁后再尝试。</p></li></ul><p>在 非公平锁 中，获取锁时：</p><ul><li>直接尝试获取锁，不做任何排队判断，如果获取失败，才加入同步队列进行排队。</li></ul><p>五、总结</p><p>ReentrantLock 是一个非常强大的锁，它不仅提供了可重入性，还通过 AQS 实现了灵活的线程排队机制。</p><p>通过选择 公平锁 或 非公平锁，可以根据具体场景优化性能。</p><p>精简口述版</p><p>ReentrantLock 是基于 AQS 实现的，支持可重入、可中断以及公平/非公平模式。</p><p>它通过一个 state 变量和两个队列（同步队列、等待队列）管理线程。同步队列用于排队获取锁的线程，等待队列则用于存放等待特定条件的线程。</p><p>公平锁会优先考虑队列中第一个线程，而非公平锁则直接尝试获取锁，效率更高，但可能导致线程饥饿。</p><h3 id="Java-的-synchronized-是怎么实现的？">Java 的 synchronized 是怎么实现的？</h3><p>一、synchronized 的实现原理</p><p>synchronized 是 Java 中最基础的同步手段，它依赖 JVM 内部的 Monitor（监视器锁） 来实现线程同步。</p><p>每个对象在 JVM 层面都与一个 Monitor 相关联，当线程获取对象锁时，实际上就是获取了这个对象的 Monitor。</p><p>同时，synchronized 的加锁信息存储在对象的 对象头（Object Header） 中。</p><p>对象头包含 Mark Word 字段，其中记录了锁的状态（无锁、偏向锁、轻量级锁、重量级锁等）以及线程 ID 等信息。</p><p>二、synchronized 在字节码层面的实现</p><p>1.修饰方法</p><p>当 synchronized 修饰方法时，编译器会在该方法的字节码中添加一个 ACC_SYNCHRONIZED 标志位。</p><ul><li><p>当线程调用该方法时，JVM 会自动尝试获取该方法所属对象的 Monitor。</p></li><li><p>如果获取成功，执行方法体；否则线程会阻塞等待。</p></li><li><p>方法执行完毕后，JVM 会自动释放锁。</p></li></ul><ol start="2"><li>修饰代码块</li></ol><p>当 synchronized 修饰代码块时，编译后的字节码会在同步代码块前后生成：</p><ul><li><p>monitorenter（进入同步块，加锁）</p></li><li><p>monitorexit（退出同步块，释放锁）</p></li></ul><p>这两个字节码指令配合使用，确保线程执行完同步代码后锁能被正确释放。</p><p>三、synchronized 的锁优化机制</p><p>从 JDK 1.6 开始，JVM 对 synchronized 进行了多次性能优化，引入了锁的四种状态：</p><ul><li>无锁（Unlocked）</li><li>偏向锁（Biased Lock）</li><li>轻量级锁（Lightweight Lock）</li><li>重量级锁（Heavyweight Lock）</li></ul><p>锁会根据竞争情况在这几种状态之间自动升级，以提升并发性能。</p><p>四、总结一句话（精简口述版）</p><p>synchronized 是基于 JVM 实现的同步机制，通过对象的 Monitor（监视器锁） 来保证线程安全。</p><p>修饰方法时，会在方法标志中添加 ACC_SYNCHRONIZED 标志；</p><p>修饰代码块时，通过 monitorenter / monitorexit 字节码实现加锁和解锁。</p><p>另外，从 JDK1.6 起，JVM 还通过偏向锁、轻量级锁等机制对它进行了性能优化。</p><p>一句话口诀：</p><p>Monitor + Object Header + 字节码指令 = synchronized 的底层实现</p><h3 id="Synchronized-修饰静态方法和修饰普通方法有什么区别？">Synchronized 修饰静态方法和修饰普通方法有什么区别？</h3><p>synchronized 修饰静态方法：锁住的是类的 Class 对象，因此所有该类的实例共享同一把锁，多个线程调用同一个类的静态同步方法时会互斥执行。</p><p>synchronized 修饰实例方法：锁住的是当前对象实例，每个实例有自己独立的锁，不同实例之间可以并发执行同步方法；但同一个实例的多个线程调用实例方法时会互斥执行。</p><p>总结：</p><ul><li><p>synchronized 修饰 静态方法 时锁住的是 类级别的锁。</p></li><li><p>synchronized 修饰 实例方法 时锁住的是 实例级别的锁。</p></li></ul><h3 id="Java-中的-synchronized-轻量级锁是否会进行自旋？">Java 中的 synchronized 轻量级锁是否会进行自旋？</h3><p><strong>jdk8</strong>中轻量级锁 CAS失败了之后，会直接进入重量级锁膨胀过程。</p><p>重量级锁竞争失败会有自旋操作，轻量级锁没有这个动作。</p><h3 id="Synchronized-能不能禁止指令重排序？">Synchronized 能不能禁止指令重排序？</h3><ul><li><p>synchronized 本身并不能完全禁止指令重排序。但是它能够通过 内存屏障 保证 线程的可见性和有序性，在加锁和解锁操作时，JVM 会插入合适的内存屏障来保证语义上的顺序性。</p></li><li><p>volatile 更能保证禁止指令重排序，并且它保证变量的 可见性，但是 不能保证原子性，也无法像 synchronized 一样提供 互斥锁。</p></li></ul><p>总结:是否可以禁止指令重排序？</p><p>synchronized 能在一定程度上防止指令重排序，但不如 volatile 那么直接。</p><p>如果你需要更严格地禁止指令重排序，使用 volatile 更加合适。</p><h3 id="当-Java-的-synchronized-升级到重量级锁后，所有线程都释放锁了，此时它还是重量级锁吗？">当 Java 的 synchronized 升级到重量级锁后，所有线程都释放锁了，此时它还是重量级锁吗？</h3><ul><li><p>如果在重量级锁状态下，所有线程都释放了锁，那么该锁就会恢复为可用状态，也就是没有任何线程持有该锁(无锁状态)。</p></li><li><p>当下次有线程尝试获取锁时，JVM 会根据当前的线程竞争情况决定是否继续使用重量级锁，或者降级为轻量级锁甚至偏向锁。</p></li></ul><h3 id="什么是-Java-中的锁自适应自旋？">什么是 Java 中的锁自适应自旋？</h3><p>自适应锁是一种用来优化并发性能的锁机制，特别是在低竞争环境下。当多个线程争用同一个锁时，JVM 会首先尝试自旋，让线程在短时间内不断尝试获取锁，避免频繁的上下文切换。</p><ul><li><p>在锁竞争较轻的情况下，自旋会节省CPU资源，并且可以提高并发性能。</p></li><li><p>如果自旋失败，JVM 会根据当前的竞争情况动态调整自旋次数，避免线程一直在自旋而浪费过多的CPU时间。</p></li><li><p>自适应锁通过这种方式，减少了阻塞锁的开销，但如果线程竞争激烈，最终会转为重量级锁，并导致线程的阻塞和上下文切换。</p></li></ul><p>优点：</p><ul><li><p>在低竞争的环境中，避免了线程频繁的挂起和唤醒，提高了效率。</p></li><li><p>相比于传统的锁，能更有效地减少锁的竞争。</p></li></ul><p>缺点：</p><ul><li>自旋会浪费CPU资源，尤其在锁竞争非常激烈的情况下，线程会一直在自旋等待，反而会增加CPU的负担。</li></ul><h3 id="Synchronized-和-ReentrantLock-有什么区别？">Synchronized 和 ReentrantLock 有什么区别？</h3><p>1.实现机制：</p><ul><li><p>Synchronized 是 Java 中的关键字，基于 JVM 层面通过 Monitor（监视器锁） 实现同步。</p></li><li><p>ReentrantLock 是 java.util.concurrent 包下的类，基于 AQS（抽象队列同步器） 实现，通过自定义同步器来实现锁的获取和释放。</p></li></ul><p>2.锁的获取和释放：</p><ul><li><p>Synchronized 是隐式获取锁，线程进入同步代码块或方法时自动获取锁，执行完毕自动释放锁。</p></li><li><p>ReentrantLock 需要显式调用 lock() 获取锁，调用 unlock() 释放锁，灵活性更强。</p></li></ul><p>3.锁的公平性：</p><ul><li><p>Synchronized 默认是非公平锁，线程的获取顺序不一定按照请求顺序。</p></li><li><p>ReentrantLock 默认是非公平锁，也可以通过构造函数设置为公平锁，保证按照请求顺序获取锁，但可能会降低性能。</p></li></ul><p>4.锁的重入性：</p><ul><li><p>Synchronized 是可重入锁，同一个线程可以多次获取同一个锁。</p></li><li><p>ReentrantLock 也是可重入锁，通过内部计数器管理重入次数，直到重入次数为0时才真正释放锁。</p></li></ul><p>5.性能：</p><ul><li><p>Synchronized 在 JDK1.6 之前性能较差，但 JDK 1.6 之后进行了优化，支持偏向锁、轻量级锁等。</p></li><li><p>ReentrantLock 功能更强大，支持条件变量、读写锁等，适用于复杂的并发场景。</p></li></ul><h3 id="Volatile-与-Synchronized-的区别是什么？">Volatile 与 Synchronized 的区别是什么？</h3><p><code>volatile</code> 和 <code>synchronized</code> 都是 Java 中用于实现线程安全的机制，但是它们的工作原理和使用场景有很大的不同。</p><ol><li><p><strong><code>volatile</code> 变量：</strong></p><ul><li><code>volatile</code> <strong>用于保证某个变量的可见性</strong>。<strong>它能确保当一个线程修改了 <code>volatile</code> 变量的值后，其他线程能够立即看到这个更新</strong>。也就是说，<strong>它确保所有线程读取该变量时，会直接从主内存中读取，而不是从线程自己的缓存中读取</strong>。</li><li>但是，<code>volatile</code> 只<strong>保证了“可见性”，并不能保证“原子性”</strong>。比如你想执行 <code>i++</code> 这样的操作，虽然 <code>volatile</code> 会保证变量值的最新性，但由于这不是一个原子操作，多个线程同时修改同一个 <code>volatile</code> 变量时，仍然会出现竞争条件。</li></ul></li><li><p><strong><code>synchronized</code> 关键字：</strong></p><ul><li><code>synchronized</code> 是用来修饰方法或代码块的，它通过加锁的方式<strong>确保同一时刻只有一个线程可以执行该方法或代码块。这不仅保证了变量的可见性，还保证了操作的“原子性”</strong>。</li><li>使用 <code>synchronized</code> 会引起<strong>性能开销</strong>，因为它需要获取和释放锁。锁的获取和释放会导致线程阻塞，尤其是多个线程争用锁时，可能会发生上下文切换，影响性能。</li></ul></li></ol><p><strong>关键区别总结：</strong></p><ul><li><code>volatile</code> 主要保证变量的<strong>可见性</strong>，但不能保证<strong>原子性</strong>。</li><li><code>synchronized</code> 不仅保证变量的可见性，还能保证操作的<strong>原子性</strong>，但会导致线程的<strong>性能开销</strong>，因为它涉及到加锁和释放锁。</li></ul><h3 id="如何优化-Java-中的锁的使用？">如何优化 Java 中的锁的使用？</h3><p><strong>优化 Java 中锁的使用</strong></p><ul><li>首先要<strong>减少锁的持有时间</strong>。尽量缩小锁定范围，避免长时间占用锁资源。</li><li>其次，<strong>减少锁的粒度</strong>，可以通<strong>过加细粒度的锁</strong>来提高并发性，例如使用<strong>读写锁（ReadWriteLock）</strong> 来处理读多写少的场景。</li><li>最后我们要<strong>减少锁的使用</strong>：而在一些简单的并发场景中，我们可以用 <strong>CAS 操作或者原子类</strong>（比如 AtomicInteger）来代替传统的锁，避免不必要的性能损失。</li></ul><h3 id="你了解-Java-中的读写锁吗？">你了解 Java 中的读写锁吗？</h3><p><strong>读写锁</strong>（<code>ReadWriteLock</code>）是<strong>为了优化多线程环境下的读操作</strong>而设计的。Java 中的 <code>ReentrantReadWriteLock</code> 是实现该锁的一个主要工具。</p><ul><li><strong>读锁</strong>（Read Lock）：<strong>允许多个线程同时读取共享资源，只要没有线程在写入</strong>。这就避免了读线程之间的互斥，提升了系统的并发性。</li><li><strong>写锁</strong>（Write Lock）：是<strong>独占锁</strong>，<strong>在一个线程获取写锁后，其他所有读写操作都无法进行，直到该线程释放写锁</strong>。这保证了数据的一致性。</li></ul><p><strong>ReentrantReadWriteLock</strong> <strong>允许一个线程在获取写锁后，也可以重新获取它，这使得它支持递归锁（Reentrant）。而且，它还支持将读锁和写锁分开，极大提升了多线程读取时的效率。</strong></p><h4 id="总结：-2">总结：</h4><ul><li><strong>读锁和写锁分开</strong>，多个读线程可以并发访问，<strong>写线程必须等所有读线程完成后才能访问</strong>。</li><li><strong>适用场景</strong>：特别适合<strong>读多写少</strong>的场景，比如<strong>缓存、日志</strong>等高并发读取的系统。</li></ul><h3 id="什么是-Java-内存模型（JMM）">什么是 Java 内存模型（JMM）?</h3><p>Java 内存模型是 Java Memory Model（JMM），本身是一种抽象的概念，实际上并不存在，<strong>描述的是一组规则或规范，通过这组规范定义了程序中各个变量（包括实例字段，静态字段和构成数组对象的元素）的访问方式</strong>.</p><blockquote><p>为什么需要JMM?</p></blockquote><ul><li>屏蔽各种硬件和操作系统的内存访问差异，<strong>实现让 Java 程序在各种平台下都能达到一致的内存访问效果</strong></li><li>规定了线程和内存之间的一些关系</li></ul><p>JMM 主要关注三大特性：<strong>可见性、原子性和有序性</strong>。</p><ol><li><p><strong>可见性</strong>：<br><strong>保证一个线程对变量的修改，其他线程能立即看到</strong>。比如，使用 <strong><code>volatile</code></strong> 关键字可以保证一个线程修改变量后，其他线程能立刻从主内存中读取到修改后的值。</p></li><li><p><strong>原子性</strong>：<br><strong>保证对共享变量的操作是不可分割的</strong>，某个线程执行时，不会被其他线程打断。Java 的原子类（如 <code>AtomicInteger</code>）就确保了对变量的原子操作。</p></li><li><p><strong>有序性</strong>：</p></li></ol><ul><li><p><strong>保证指令的执行顺序不会被打乱，确保代码的执行顺序符合程序的设计逻辑</strong>。例如，<code>synchronized</code> 关键字能够确保同一时刻只有一个线程能够访问某个代码块，保证操作的顺序执行。</p></li><li><p>happens-before 原则：JMM 定义了 happens-before 规则，用于约束操作之间的有序性。如果一个操作 A happens-before 操作 B，那么 A 的结果对于 B 是可见的，且 A 的执行顺序在 B 之前。</p></li></ul><p>简而言之，JMM 就是一个<strong>为多线程提供规范和规则的机制</strong>，它保证了多个线程间的同步和内存一致性问题。</p><h3 id="什么是-Java-中的原子性、可见性和有序性？">什么是 Java 中的原子性、可见性和有序性？</h3><p><strong>可见性</strong>：</p><ul><li><strong>保证一个线程对变量的修改，其他线程能立即看到</strong>。比如，使用 **volatile **关键字可以保证一个线程修改变量后，其他线程能立刻从主内存中读取到修改后的值。</li></ul><p><strong>原子性</strong>：</p><ul><li><strong>保证对共享变量的操作是不可分割的，某个线程执行时，不会被其他线程打断</strong>。Java 的原子类（如 AtomicInteger）就确保了对变量的原子操作。</li></ul><p><strong>有序性</strong>：</p><ul><li><strong>保证指令的执行顺序不会被打乱，确保代码的执行顺序符合程序的设计逻辑</strong>。例如，synchronized 关键字能够确保同一时刻只有一个线程能够访问某个代码块，保证操作的顺序执行。</li><li><strong>happens-before</strong> 原则：JMM 定义了 happens-before 规则，用于约束操作之间的有序性。如果一个操作 A happens-before 操作 B，那么 A 的结果对于 B 是可见的，且 A 的执行顺序在 B 之前。</li></ul><h3 id="什么是-Java-的-happens-before-规则？">什么是 Java 的 happens-before 规则？</h3><p>happens-before 是 JMM 中用于规定 <strong>“内存可见性与执行顺序</strong>” 的<strong>逻辑关系</strong>。<br>如果 A happens-before B，那么：</p><ul><li>A 的执行结果对 B 是可见的</li><li>A 一定发生在 B 之前</li></ul><p>happens-before 的 8 条规则（JSR-133 规定）</p><table><thead><tr><th>规则编号</th><th>描述</th><th>举例代码</th></tr></thead><tbody><tr><td>①</td><td>程序顺序规则：一个线程中语句按写的顺序执行</td><td><code>int x=1; int y=x+1;</code></td></tr><tr><td>②</td><td>监视器规则：解锁 happens-before 随后的加锁（同一锁对象）</td><td><code>synchronized(obj)</code> 块之间</td></tr><tr><td>③</td><td>volatile 规则：volatile 写 happens-before 随后的读</td><td><code>volatile boolean flag</code></td></tr><tr><td>④</td><td>线程启动规则：start () happens-before 线程内任何操作</td><td><code>main线程调用 t.start()</code></td></tr><tr><td>⑤</td><td>线程终止规则：线程内操作 happens-before 其他线程检测它结束</td><td><code>t.join()</code> 或 <code>!t.isAlive()</code></td></tr><tr><td>⑥</td><td>线程中断规则：interrupt () happens-before 被检测到中断</td><td><code>t.interrupt()</code> 后用 <code>isInterrupted()</code> 检测</td></tr><tr><td>⑦</td><td>对象终结规则：构造完成 happens-before finalize ()</td><td>Java GC 自动触发</td></tr><tr><td>⑧</td><td>传递性：A hb→B，B hb→C，则 A hb→C</td><td>A 设置值 → B 发信号 → C 读取所有结果</td></tr></tbody></table><img src="https://pic.code-nav.cn/mianshiya/question_picture/1942188251568476161/lNVo2Sgh_Snipaste_2025-11-04_18-31-59_mianshiya.png" alt="Snipaste_2025-11-04_18-31-59.png" width="100%" /><h3 id="什么是-Java-中的指令重排？">什么是 Java 中的指令重排？</h3><p>指令重排是现代<strong>处理器和编译器用来优化代码执行的一种手段</strong>，它通过改变指令的执行顺序来提高程序的性能。</p><blockquote><p>为什么要有指令重排这项优化呢？从 CPU 执行指令的原理来理解一下吧</p></blockquote><p>为什么 CPU 要重排？</p><p>为了提高性能，现代 CPU 实现了以下机制：</p><ol><li>指令流水线（Pipeline）</li></ol><p>五级流水线：取指令 → 指令译码 → 执行 → 访存 → 写回<br>每条指令被分成多个阶段，这些阶段可以被多个指令<strong>并行执行</strong>。</p><p>这样做可以<strong>提高吞吐率</strong>（Throughput）。</p><ol start="2"><li>超标量（SuperScalar）</li></ol><p>现代 CPU 拥有多个执行单元（如整数、浮点、加载单元）<br>可以在一个时钟周期内<strong>执行多条指令</strong>，即 IPC &gt; 1（Instruction per Clock）</p><h4 id="指令重排的弊端">指令重排的弊端</h4><p>指令重排有时会导致<strong>并发程序中的问题，尤其是在多线程环境下</strong>。举个例子，<strong>假设有两个线程A和B，A执行某个任务后修改一个共享变量，B线程读取这个变量。如果没有适当的同步机制，由于指令重排，B可能会在A尚未修改变量时读取到一个不一致的值</strong>，这可能导致程序出现错误。</p><blockquote><p>JMM 如何应对重排？</p></blockquote><p>Java 内存模型（JMM）允许重排序，<strong>但通过 Happens-Before 规则和 volatile/synchronized 等机制来屏蔽 “坏的重排”</strong>。</p><h4 id="扩展-演示一下指令重排">扩展- 演示一下指令重排</h4><ol><li>诡异的结果</li></ol><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> num = <span class="number">0</span>;</span><br><span class="line"><span class="type">boolean</span> ready = <span class="literal">false</span>;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">void</span> <span class="title">actor1</span><span class="params">(I_Result r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ready) &#123;</span><br><span class="line">        r.r1 = num + num;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        r.r1 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">void</span> <span class="title">actor2</span><span class="params">(I_Result r)</span> </span>&#123;</span><br><span class="line">    num = <span class="number">2</span>;</span><br><span class="line">    ready = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>你可能会觉得结果只有：</p><p>1：因为 ready == false<br>4：因为 ready == true 且 num = 2<br>但事实上，还可能出现一个诡异的结果：<code>r1  == 0</code></p><ol start="2"><li>为什么会出现 r1 == 0？</li></ol><p>这是 指令重排（Instruction Reordering） 的锅：</p><p>actor2 看似顺序是：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">num</span> = <span class="number">2</span><span class="comment">;</span></span><br><span class="line"><span class="attr">ready</span> = <span class="literal">true</span><span class="comment">;</span></span><br></pre></td></tr></table></figure><p>但实际上，JIT 编译器或 CPU 为了性能可能重排序为：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ready</span> = <span class="literal">true</span><span class="comment">;</span></span><br><span class="line"><span class="attr">num</span> = <span class="number">2</span><span class="comment">;</span></span><br></pre></td></tr></table></figure><ol start="3"><li>线程交叉执行导致问题<br>设想线程切换如下：</li></ol><table><thead><tr><th>时间</th><th>执行线程</th><th>执行内容</th></tr></thead><tbody><tr><td>T1</td><td>actor2</td><td><code>ready = true</code> ✅ 重排了</td></tr><tr><td>T2</td><td>actor1</td><td><code>if (ready)</code> 进入 if 分支</td></tr><tr><td>T3</td><td>actor1</td><td>读取 <code>num = 0</code>，返回 <code>0</code></td></tr><tr><td>T4</td><td>actor2</td><td><code>num = 2</code> 补上了</td></tr></tbody></table><p>此时：</p><ul><li>ready = true</li><li>num 还没来得及变成 2</li><li>所以 num + num = 0 + 0 = 0</li></ul><ol start="4"><li>用 JCStress 工具验证这种微小并发问题</li></ol><img src="https://pic.code-nav.cn/mianshiya/question_picture/1942188251568476161/EIyqlG3D_Snipaste_2025-11-04_18-49-45_mianshiya.png" alt="Snipaste_2025-11-04_18-49-45.png" width="100%" />5. 如何解决？<ul><li>方法一：使用 volatile</li></ul><p>修改代码为：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span> <span class="type">boolean</span> ready = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure><p>效果：</p><ul><li>volatile 具有 可见性 和 禁止重排序 的语义</li><li>它会在 ready = true 写操作前，确保之前所有写操作（包括 num = 2）都已完成</li><li>执行压测后，0 就不再出现了，说明问题彻底解决。</li></ul><p>总结：多线程环境下，不加 volatile 或同步机制，即使代码看起来顺序执行，也可能由于 “重排序” 导致结果诡异！</p><h3 id="Java-中的-final-关键字是否能保证变量的可见性？">Java 中的 final 关键字是否能保证变量的可见性？</h3><p>final 关键字确实<strong>能确保变量的值一旦被设置后不可再改变</strong>，但它<strong>不能保证变量在多个线程中的可见性</strong>。</p><ul><li>对于基本数据类型，它只能保证值不变；</li><li>对于引用类型的 final 变量，它只能保证引用指向的对象不可改变，但是对象内部的数据，其他线程仍然可能看不到最新的值。</li></ul><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">YesFinalTest</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> a;  <span class="comment">// final 变量</span></span><br><span class="line">    <span class="type">int</span> b; <span class="comment">// 普通变量</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">YesFinalTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        a = <span class="number">1</span>;</span><br><span class="line">        b = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="type">static</span> <span class="type">void</span> <span class="title">main</span><span class="params">(<span class="type">String</span>[] args)</span> </span>&#123;</span><br><span class="line">        YesFinalTest testObj = <span class="keyword">new</span> <span class="built_in">YesFinalTest</span>();  <span class="comment">// 创建对象</span></span><br><span class="line">        testObj.b = <span class="number">3</span>; <span class="comment">// 允许修改</span></span><br><span class="line">        <span class="comment">// testObj.a = 4; // 不能修改，a 是 final 的</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在这个例子中，a 是 final 变量，它一旦赋值就不可更改。而 b 是普通变量，它是可以修改的。<strong>如果在多线程中对这些变量进行操作，final 并不能保证在其他线程中 a 和 b 的值能及时可见</strong>，<strong>除非使用 volatile 或其他同步机制</strong>。</p><p>为了确保线程安全和数据可见性。通常我们需要额外使用 volatile 或 synchronized 来确保数据的一致性和可见性。</p><h3 id="为什么在-Java-中需要使用-ThreadLocal？">为什么在 Java 中需要使用 ThreadLocal？</h3><p>在 Java 中使用 ThreadLocal 主要是<strong>为了避免多线程环境下共享数据的安全问题</strong>。<br>通常，多个线程同时访问共享资源时，如果没有适当的同步机制，就会导致线程安全问题。<strong>而 ThreadLocal 通过为每个线程提供一个独立的副本，避免了这种多线程争用共享资源的情况。</strong></p><p>ThreadLocal的好处如下：</p><ul><li><strong>避免竞争</strong>：ThreadLocal 是一种<strong>为每个线程提供独立副本的机制</strong>。每个线程在访问 ThreadLocal 变量时，会得到自己的副本，<strong>确保了数据隔离，避免了不同线程之间的竞争</strong>。</li><li><strong>高效</strong>：因为每个线程都有自己的副本，<strong>线程之间不需要进行同步</strong>（如 synchronized），<strong>从而提高了效率</strong>，特别是在高并发情况下。</li></ul><p><strong>适用场景</strong>：ThreadLocal <strong>非常适用于每个线程需要独立操作的数据</strong>。例如，<strong>数据库连接、会话信息</strong>等。使用 ThreadLocal 可以确保每个线程的数据独立，避免了共享资源带来的问题。</p><blockquote><p>ThreadLocal会造成什么问题</p></blockquote><p>ThreadLocal可能会造成内存泄漏的问题[<a href="https://www.mianshiya.com/bank/1789249312885223425/question/1780933295085744130">https://www.mianshiya.com/bank/1789249312885223425/question/1780933295085744130</a>]</p><h3 id="Java-中的-ThreadLocal-是如何实现线程资源隔离的？">Java 中的 ThreadLocal 是如何实现线程资源隔离的？</h3><p>ThreadLocal 为每个线程提供了一个独立的 <strong>ThreadLocalMap</strong>，该 map 的<strong>键是 ThreadLocal 对象</strong>，<strong>值是存储在线程本地的具体数据</strong>。每个线程可以通过 ThreadLocal.get() 方法获取它自己的数据副本，其他线程无法直接访问到。</p><p>主要操作：</p><ul><li>set(value)：将线程本地的值存入 ThreadLocalMap 中，键是 ThreadLocal 对象，值是具体的值。</li><li>get()：根据当前线程获取到该线程对应的 ThreadLocalMap，进而访问其中存储的值。</li></ul><p>优点：</p><ul><li>线程安全：每个线程都有自己的副本，线程之间互不干扰，不会发生竞争。</li><li>简化线程处理：避免了显式的同步操作，减少了线程间的复杂性。</li></ul><p>使用场景：</p><ul><li>ThreadLocal 适用于每个线程需要持有独立副本的情况，例如：数据库连接、Session信息、用户上下文等。</li></ul><h3 id="为什么-Java-中的-ThreadLocal-对-key-的引用为弱引用？">为什么 Java 中的 ThreadLocal 对 key 的引用为弱引用？</h3><p>在 Java 中，ThreadLocal <strong>对于存储线程局部变量的 key 使用了弱引用</strong>。弱引用的主要作用是<strong>尽可能的避免内存泄漏</strong>，<strong>并允许 JVM 在内存紧张时回收不再使用的对象</strong>。</p><ul><li>防止内存泄漏：每个线程都有一个与之关联的 ThreadLocalMap，ThreadLocal 中的 key 被弱引用，这意味着当一个线程结束或不再使用某个 ThreadLocal 对象时，ThreadLocalMap 可以被垃圾回收器回收，避免了内存泄漏。</li><li>有效管理内存：使用弱引用，当线程本地存储的对象不再被使用时，JVM 会自动回收内存。弱引用的 ThreadLocal 可以在系统内存不足时有效释放资源。</li></ul><blockquote><p>为什么value不设为弱引用？</p></blockquote><p>我们不会把 value 也设置为弱引用，主要是<strong>为了保证线程能够稳定访问到自己的局部数据。如果 value 也使用弱引用的话，可能在垃圾回收时被回收掉，这样线程就无法正常访问自己的数据了</strong>。而且，ThreadLocal 本身就用弱引用管理 key，通过清理无效的 key 来避免内存泄漏，value 用强引用确保它在生命周期内都能被正确访问</p><h3 id="Java-中使用-ThreadLocal-的最佳实践是什么？">Java 中使用 ThreadLocal 的最佳实践是什么？</h3><p>在 Java 中使用 <code>ThreadLocal</code> 时，一些最佳实践包括：</p><ol><li><p><strong>避免滥用 <code>ThreadLocal</code>：</strong><br><code>ThreadLocal</code> <strong>适用于每个线程需要维护独立变量的场景</strong>，比如数据库连接、用户会话等。<strong>如果需要共享数据，<code>ThreadLocal</code> 不适用</strong>，应该使用其他线程安全的方式。</p></li><li><p><strong>线程结束后清理：</strong><br>使用 <code>ThreadLocal</code> 时，<strong>一定要在任务完成后清理数据</strong>。可以通过调用 <code>remove()</code> 方法确保释放资源，<strong>避免因资源未清理导致内存泄漏</strong>。</p></li><li><p><strong>使用合适的生命周期：</strong><br><strong>确保 <code>ThreadLocal</code> 只在当前线程中有效，线程结束时清理资源</strong>。<strong>避免 ThreadLocal 被长时间占用</strong>，最好在任务执行完后及时清理。</p></li><li><p><strong>合理使用 <code>initialValue()</code>：</strong><br>使用 <code>ThreadLocal</code> 时，可以通过 <code>withInitial()</code> 方法<strong>提供初始值</strong>，这样可以<strong>确保每个线程有默认的值，避免没有初始化的情况</strong>。</p></li><li><p><strong>避免静态存储大型对象：</strong><br><code>ThreadLocal</code> <strong>不应被用来存储大型对象</strong>，如数据库连接池等。因为每个线程都可能对这些数据进行修改，使用 <code>ThreadLocal</code> 存储这类资源并不合适，容易引发竞争条件。</p></li></ol><p>总的来说，<code>ThreadLocal</code> 的最佳实践是：<strong>确保只在需要时使用，并且及时清理资源，避免内存泄漏或不必要的内存占用</strong>。</p><h3 id="Java-中的-InheritableThreadLocal-是什么？">Java 中的 InheritableThreadLocal 是什么？</h3><p>InheritableThreadLocal 就是 ThreadLocal 的一种变种，<strong>允许子线程访问和继承父线程中的本地变量</strong>。</p><p><strong>一般来说，如果你需要在父线程和子线程之间共享一些数据，且希望子线程能够访问父线程设置的值，可以使用 InheritableThreadLocal</strong>。</p><p>它会在创建子线程时，将父线程中 InheritableThreadLocal 的值传递给子线程。<strong>需要注意的是，子线程的修改不会影响父线程的值，而且父线程的值也不会被子线程修改</strong>。</p><h3 id="ThreadLocal-的缺点？">ThreadLocal 的缺点？</h3><ul><li><p>首先是内存泄漏的问题。ThreadLocal 对象在每个线程中有独立的副本，<strong>如果我们没有显式地使用 remove() 清除它们，这些线程局部的变量就不会被及时回收，可能会导致内存泄漏</strong>，尤其是在有大量线程的情况下。</p></li><li><p>其次是性能问题。如果我们使用 ThreadLocal 来<strong>存储大量数据</strong>，或者在一些<strong>线程池中使用 ThreadLocal 变量</strong>，可能会遇到<strong>性能瓶颈</strong>。这是因为每次获取或者设置值时，<strong>ThreadLocal 都需要访问其内部的数据结构，而这可能导致一些性能损耗，特别是当出现 hash 冲突时，性能会进一步下降</strong>(线性探测法效率低）。</p></li><li><p>最后，如果使用不当，ThreadLocal 会带来不必要的复杂性。例如，处理不同线程间的共享数据时，可能需要更多的管理工作，<strong>而 ThreadLocal 更适合一些轻量级的线程局部存储场景</strong>。”</p></li></ul><h3 id="什么是-Java-的-TransmittableThreadLocal？">什么是 Java 的 TransmittableThreadLocal？</h3><p>TransmittableThreadLocal 是为了主要用于解决 <strong>ThreadLocal 在线程池中或跨线程的传递问题</strong>，<strong>它增强了 InheritableThreadLocal 的功能。通过捕获、重放、恢复三个步骤，它确保父线程的数据能够传递到子线程，从而避免了线程池中数据丢失的问题</strong>。</p><p>这就是为什么在涉及到线程池或多线程环境时，我们可以使用 TransmittableThreadLocal，它能够更好地保证线程间的数据共享和传递</p><blockquote><p>ThreadLocal、InheritableThreadLocal 和 TransmittableThreadLocal 的简要比较</p></blockquote><ul><li>ThreadLocal <strong>用于确保每个线程有自己的变量，并且这些变量不能被其他线程访问</strong>。它适用于每个线程都需要独立存储的数据，比如数据库连接或用户信息。</li><li>InheritableThreadLocal <strong>让子线程能够继承父线程的 ThreadLocal 数据，这对于处理父子线程之间的数据传递是很有用的，但它不会在后续的子线程操作中进行更新</strong>。</li><li>TransmittableThreadLocal 则扩展了 InheritableThreadLocal，<strong>支持跨线程池传递数据，它还可以在任务执行完成后清理数据，避免内存泄漏的问题</strong>。</li></ul><h3 id="Java-中-Thread-sleep-和-Thread-yield-的区别？">Java 中 Thread.sleep 和 Thread.yield 的区别？</h3><p>Thread.sleep() 和 Thread.yield() 都是用来控制线程执行行为的方法，但它们的底层机制和效果不同。</p><p>1.从线程状态上看：</p><ul><li>sleep() 会让线程进入 TIMED_WAITING（计时等待）状态，在指定时间内不会参与 CPU 调度。</li><li>yield() 只是让当前线程从 RUNNABLE（可运行）状态 暂时让出 CPU 执行权，但不会阻塞，下一次调度时可能马上又被选中执行。</li></ul><p>2.从 CPU 调度上看：</p><ul><li>sleep() 一定会让出 CPU 执行时间；</li><li>yield() 只是“建议”调度器让出 CPU，是否让出、让给谁，由 JVM 和操作系统调度策略决定。</li></ul><ol start="3"><li>从异常机制上看：</li></ol><ul><li>sleep() 会显式抛出 InterruptedException，需要捕获或声明；</li><li>yield() 不会抛出任何异常。</li></ul><p>4.从优先级角度看：</p><ul><li>sleep() 不考虑线程优先级，直接暂停；</li><li>yield() 通常只会让给相同或更高优先级的线程。</li></ul><p>5.共同点：</p><p><strong>两者都不会释放已持有的锁</strong>。</p><p>（也就是说，如果在线程同步块里调用 sleep 或 yield，锁依旧被该线程占用。）</p><p>总结：</p><ul><li>sleep 是“强制暂停一段时间”；</li><li>yield 是“自愿让出一次 CPU 机会”；</li><li>sleep 会进入等待状态且抛异常，yield 只是回到就绪状态，不一定真的让出执行权。</li></ul><h3 id="Java-中-Thread-sleep-0-的作用是什么？">Java 中 Thread.sleep(0) 的作用是什么？</h3><p>Thread.sleep(0) 表示当前线程主动让出 CPU 的执行权，但不真正进入休眠。</p><p>它会触发一次线程调度，让系统有机会让其他同优先级或更高优先级的线程执行。</p><p>如果没有可运行的线程，调度器可能会重新选中自己执行。</p><p>可以理解为一种轻量级的线程切换，在某些系统上和 yield() 效果类似，但更“强制”一些。</p><h4 id="sleep-0-的应用：">sleep(0)的应用：</h4><p>在高性能多线程程序中，有时会用 sleep(0) 做线程调度优化，比如防止一个线程长时间占用 CPU，但这属于底层微调，一般开发中用得较少。</p><h4 id="sleep-0-与-yield-的对比">sleep(0) 与 yield()的对比:</h4><p>sleep(0) 与 yield() 的底层实现与调度策略不同：</p><ul><li><p>sleep(0) 调用的是系统级 sleep/nanosleep，会强制触发一次调度；</p></li><li><p>yield() 只是告诉调度器“我可以让出”，但调度器可以忽略这个请求。</p></li></ul><h3 id="Java-中的-wait、notify-和-notifyAll-方法有什么作用？">Java 中的 wait、notify 和 notifyAll 方法有什么作用？</h3><p><strong>这三个方法主要用于线程间的同步和通信，确保多线程之间不会相互干扰</strong>。</p><ul><li>首先，wait() 会让<strong>当前线程进入等待状态</strong>，<strong>释放锁</strong>，让其他线程可以使用该锁。</li><li>调用 notify() <strong>会唤醒一个在同一对象上等待的线程</strong>，</li><li>而 notifyAll() <strong>会唤醒所有等待的线程</strong>。</li></ul><p>这些方法<strong>都需要在 synchronized 块中使用</strong>，因为它们都涉及到共享资源的访问和修改。</p><p>简而言之，wait() 会让线程进入休眠并释放锁，notify() 唤醒一个等待的线程，而 notifyAll() 唤醒所有等待的线程。</p><h3 id="Java-中什么情况会导致死锁？如何避免？">Java 中什么情况会导致死锁？如何避免？</h3><p>死锁就是两个或多个线程互相等待对方持有的锁，导致都无法继续执行。</p><p>它产生必须满足四个条件：互斥、占有且等待、不可抢占、循环等待。</p><p>只要破坏其中任意一个条件就能避免死锁。</p><p>实际开发中常见做法是：</p><ul><li><p>保证加锁顺序一致；</p></li><li><p>对锁操作设置超时时间，避免无限等待；</p></li><li><p>尽量减小锁的粒度，降低死锁的风险；</p></li><li><p>必要时用 jstack 分析线程快照定位死锁。</p></li></ul><h4 id="补充：为什么“减小锁的粒度”有助于避免死锁？">补充：为什么“减小锁的粒度”有助于避免死锁？</h4><p>先理解死锁的本质：</p><p>死锁发生的根源在于多个线程同时争抢多个锁资源，并且形成循环等待。</p><p>如果锁的粒度太大，意味着：</p><ul><li><p>一个线程拿到的锁可能包含了多个关键资源；</p></li><li><p>另一个线程也需要访问其中部分资源时，也要等这把“大锁”；</p></li><li><p>多个线程间锁的依赖关系就复杂了，更容易形成循环等待链条。</p></li></ul><p>相反，如果我们降低锁的粒度（即让每个锁控制的范围更小）：</p><ul><li><p>各线程锁住的资源重叠减少；</p></li><li><p>同时持有多个锁的概率变小；</p></li><li><p>就不太容易出现“我等你、你等我”的循环依赖。</p></li></ul><p>结论：锁粒度小 → 资源竞争减少 → 同时持有多把锁的可能性低 → 死锁风险降低。</p><h3 id="Java-中-volatile-关键字的作用是什么？">Java 中 volatile 关键字的作用是什么？</h3><p>volatile可以用来修饰成员变量和静态成员变量，<strong>主要作用是保证变量的可见性和禁止指令重排优化</strong>。加了 volatile 之后<strong>线程不能从自己工作缓存中读取变量的值，必须去到主内存中获取变量的最新值</strong>。</p><blockquote><p>volatile 与 synchronized 的可见性对比</p></blockquote><table><thead><tr><th>特性</th><th><code>volatile</code></th><th><code>synchronized</code></th></tr></thead><tbody><tr><td>可见性</td><td>✅ 强制主内存交互</td><td>✅ 解锁前刷新主内存</td></tr><tr><td>原子性</td><td>❌</td><td>✅ 加锁保证互斥</td></tr><tr><td>性能</td><td>高</td><td>低（重量级锁）</td></tr><tr><td>语义</td><td>轻量</td><td>阻塞 / 解阻塞</td></tr></tbody></table><h4 id="volatile-原理">volatile 原理</h4><p>volatile 的底层实现原理是内存屏障，Memory Barrier（Memory Fence）</p><ul><li>对 volatile 变量的写指令后会加入写屏障</li><li>对 volatile 变量的读指令前会加入读屏障</li></ul><table><thead><tr><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>写屏障 sfence</td><td>保证之前的写操作会刷新到主内存</td></tr><tr><td>读屏障 lfence</td><td>保证之后的读操作从主内存加载最新数据</td></tr></tbody></table><h4 id="如何保证可见性">如何保证可见性</h4><ul><li>写屏障（sfence）保证在该屏障之前的，对共享变量的改动，都同步到主存当中</li></ul><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">void</span> <span class="title">actor2</span><span class="params">(I_Result r)</span> </span>&#123;</span><br><span class="line">   num = <span class="number">2</span>;</span><br><span class="line">   ready = <span class="literal">true</span>; <span class="comment">// ready 是 volatile，写操作后插入写屏障</span></span><br><span class="line">   <span class="comment">// 写屏障</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>而读屏障（lfence）保证在该屏障之后，对共享变量的读取，加载的是主存中最新数据</li></ul><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">void</span> <span class="title">actor1</span><span class="params">(I_Result r)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 读屏障</span></span><br><span class="line">   <span class="comment">// ready 是 volatile 读取值带读屏障</span></span><br><span class="line">   <span class="keyword">if</span>(ready) &#123;</span><br><span class="line">       r.r1 = num + num;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       r.r1 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过 volatile ready，确保 actor2 的 num=2 先于 ready=true 被主内存可见；actor1 会在读 ready 之后拿到 num=2。</p><img src="https://pic.code-nav.cn/mianshiya/question_picture/1942188251568476161/iJtGDzJL_image-1430_mianshiya.png" alt="image-1430.png" width="75%" /><h4 id="如何保证有序性（禁止指令重排序）">如何保证有序性（禁止指令重排序）</h4><ul><li>写屏障会确保指令重排序时，不会将写屏障之前的代码排在写屏障之后</li></ul><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">void</span> <span class="title">actor2</span><span class="params">(I_Result r)</span> </span>&#123;</span><br><span class="line">   num = <span class="number">2</span>;</span><br><span class="line">   ready = <span class="literal">true</span>; <span class="comment">// ready 是 volatile 赋值带写屏障</span></span><br><span class="line">   <span class="comment">// 写屏障</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>读屏障会确保指令重排序时，不会将读屏障之后的代码排在读屏障之前</li></ul><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">void</span> <span class="title">actor1</span><span class="params">(I_Result r)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 读屏障</span></span><br><span class="line">   <span class="comment">// ready 是 volatile 读取值带读屏障</span></span><br><span class="line">   <span class="keyword">if</span>(ready) &#123;</span><br><span class="line">       r.r1 = num + num;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       r.r1 = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="https://pic.code-nav.cn/mianshiya/question_picture/1942188251568476161/pdbuUtag_3_mianshiya.png" alt="3.png" width="75%" /><p>还是那句话，<strong>不能解决指令交错</strong>：</p><ul><li>写屏障仅仅是保证之后的读能够读到最新的结果，但不能保证读跑到它前面去</li><li>而有序性的保证也只是保证了本线程内相关代码不被重排序</li></ul><p><strong>即volatile无法阻止线程间指令交错执行，它只控制当前线程的读写顺序，无法强制让别的线程“看不见/先执行”</strong></p><blockquote><p>volatile无法阻止线程间指令交错执行，它只控制当前线程的读写顺序，无法强制让别的线程“看不见/先执行”与volatile禁止重排序是否矛盾？</p></blockquote><p>不矛盾</p><table><thead><tr><th>层面</th><th>代表术语</th><th>volatile 的作用</th></tr></thead><tbody><tr><td>✅ 当前线程<strong>内部</strong>顺序</td><td>指令重排序（reordering）</td><td>禁止特定重排序 ✔️</td></tr><tr><td>❌ 多线程<strong>之间</strong>交叉执行</td><td>并发交叉 / 非同步执行</td><td>无法阻止 ❌</td></tr></tbody></table><img src="https://pic.code-nav.cn/mianshiya/question_picture/1942188251568476161/sqyMghdJ_4_mianshiya.png" alt="4.png" width="50%" /><img src="https://pic.code-nav.cn/mianshiya/question_picture/1942188251568476161/booE4a2G_5_mianshiya.png" alt="5.png" width="50%" /><img src="https://pic.code-nav.cn/mianshiya/question_picture/1942188251568476161/ZME2jOCp_6_mianshiya.png" alt="6.png" width="50%" /><p>volatile 禁止 自身线程内的指令重排序，<strong>保证 “我写完作业再发信号”</strong><br>volatile 无法阻止 线程之间的交错执行，<strong>不能保证 “别人不抢先读取信号”</strong></p><p>两句话不矛盾，分别针对：</p><ul><li>内部顺序保障（禁止重排）</li><li>外部同步保障（需要锁）</li></ul><h3 id="什么是-Java-中的-ABA-问题？">什么是 Java 中的 ABA 问题？</h3><p>ABA 问题</p><ul><li>问题：一个变量从 A → B → A，CAS 检查时发现值没变，但实际上经历了变化，从而导致错误的判断和操作</li><li>解决：使用版本号机制，在每次更新一个变量时,不仅更新变量的值,还更新一个版本号。如AtomicStampedReference，在 CAS 时同时比较值和版本号。</li></ul><h3 id="在-Java-中主线程如何知晓创建的子线程是否执行成功？">在 Java 中主线程如何知晓创建的子线程是否执行成功？</h3><p>主线程通常有几种方式来知道子线程是否成功执行。总结来说，常见的方式包括：</p><h4 id="1-使用-Thread-join-方法">1. 使用 <code>Thread.join()</code> 方法</h4><ul><li><strong>原理</strong>：<strong>当主线程调用子线程的 <code>join()</code> 方法时，它会阻塞等待直到子线程执行完毕</strong>。如果子线程正常执行结束，主线程会继续执行，否则如果子线程抛出异常，主线程可以捕获到这些异常。</li><li><strong>应用场景</strong>：这种方式<strong>适合于简单的线程等待和执行结果的检查</strong>。</li></ul><h4 id="2-使用-Callable-和-Future">2. 使用 <code>Callable</code> 和 <code>Future</code></h4><ul><li><strong>原理</strong>：<strong>使用 <code>Callable</code> 接口创建返回结果的任务</strong>，并<strong>通过 <code>Future.get()</code> 方法来获取子线程的执行结果</strong>。如果子线程执行成功，<strong><code>get()</code> 返回正常结果</strong>；如果抛出异常，<code>get()</code> 会抛出相应的异常。</li><li><strong>应用场景</strong>：这种方式<strong>更适合需要返回结果的任务</strong>，或者需要捕获子线程异常的场景。</li></ul><h4 id="3-使用回调机制">3. 使用回调机制</h4><ul><li><strong>原理</strong>：回调机制是<strong>通过主线程传递一个回调函数给子线程，子线程执行完任务后调用回调函数通知主线程</strong>。主线程可以通过这些回调函数来检查任务是否成功完成。</li><li><strong>应用场景</strong>：适用于<strong>复杂的多线程场景</strong>，可以在任务结束时获取执行状态。</li></ul><h4 id="4-使用-CountDownLatch-或其他-JUC-类">4. 使用 <code>CountDownLatch</code> 或其他 JUC 类</h4><ul><li><strong>原理</strong>：通过 <code>CountDownLatch</code> 等同步工具类，<strong>主线程可以等待子线程完成任务。当子线程完成任务时，会调用 <code>countDown()</code> 方法来通知主线程任务已完成</strong>。<strong>主线程通过 <code>await()</code> 方法等待直到所有子线程完成</strong>。</li><li><strong>应用场景</strong>：适用于等待多个子线程的场景。</li></ul><p>结合具体的业务需求选择合适的方案。例如，当只关心子线程是否完成任务时，可以使用 <code>join()</code>；当需要获取任务结果或者捕获异常时，推荐使用 <code>Callable</code> 和 <code>Future</code>。</p><h3 id="Java-创建线程池有哪些方式？">Java 创建线程池有哪些方式？</h3><p><strong>Java 创建线程池的方式</strong></p><ol><li><p><strong>使用 <code>Executors</code> 工具类</strong></p><ul><li><p>Java 提供了 <code>Executors</code> 工具类来方便地创建线程池。最常见的是 <code>Executors.newFixedThreadPool(int n)</code>，它创建一个固定大小的线程池。线程池中有固定数量的线程来执行任务，一旦任务完成，线程就会被复用。</p></li><li><p>示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>使用 <code>ThreadPoolExecutor</code> 直接创建线程池</strong></p><ul><li><p>如果需要更灵活的配置，可以使用 <code>ThreadPoolExecutor</code> 类直接创建线程池。它可以让你自定义线程池的参数，如核心线程数、最大线程数、线程空闲保持时间等。</p></li><li><p>示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">    <span class="number">5</span>,                  <span class="comment">// corePoolSize</span></span><br><span class="line">    <span class="number">10</span>,                 <span class="comment">// maximumPoolSize</span></span><br><span class="line">    <span class="number">60</span>,                 <span class="comment">// keepAliveTime</span></span><br><span class="line">    TimeUnit.SECONDS,   <span class="comment">// TimeUnit</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="number">100</span>)  <span class="comment">// BlockingQueue</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>使用 <code>ForkJoinPool</code> 创建线程池</strong></p><ul><li><p><code>ForkJoinPool</code> 用于并行任务的执行，它在任务拆分和合并方面非常高效。它特别适合需要递归任务或任务能拆分的场景。</p></li><li><p>示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ForkJoinPool</span> <span class="variable">forkJoinPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>();</span><br><span class="line">forkJoinPool.submit(() -&gt; &#123;</span><br><span class="line">    <span class="comment">// Task</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li></ul></li></ol><p>具体选择哪个方式取决于你的应用场景。</p><ul><li>如果需要简单的线程池，可以用 <code>Executors</code> 工具类；</li><li>如果需要更高的定制性，选择 <code>ThreadPoolExecutor</code>；</li><li>对于递归任务，<code>ForkJoinPool</code> 是一个很好的选择。</li></ul><h3 id="Java-线程安全的集合有哪些">Java 线程安全的集合有哪些?</h3><p><strong>Java 线程安全的集合</strong><br>常见的线程安全集合包括：</p><ol><li><p><strong>Vector</strong></p><ul><li>类型：线程安全的动态数组</li><li>特点：每个方法都有锁，适用于多线程修改的场景。但由于性能较差，已经不推荐使用。</li></ul></li><li><p><strong>Hashtable</strong></p><ul><li>类型：线程安全的哈希表</li><li>特点：每个方法都有锁，适用于多线程共享的哈希表，但性能较低，已被 <code>ConcurrentHashMap</code> 替代。</li></ul></li><li><p><strong>ConcurrentHashMap</strong></p><ul><li>类型：线程安全的哈希表</li><li>特点：分段锁设计，支持高并发，适用于高并发环境，如缓存、分布式系统等。</li></ul></li><li><p><strong>CopyOnWriteArrayList</strong></p><ul><li>类型：线程安全的动态数组</li><li>特点：用于读多写少的场景，每次写操作时会复制整个数组，避免锁，适合监听集合等场景。</li></ul></li><li><p><strong>CopyOnWriteArraySet</strong></p><ul><li>类型：线程安全的集合</li><li>特点：基于 <code>CopyOnWriteArrayList</code> 实现，适合读多写少的场景。</li></ul></li><li><p><strong>BlockingQueue</strong></p><ul><li>类型：线程安全的队列</li><li>特点：用于生产者-消费者模式，支持阻塞操作，适用于多线程的队列操作。</li></ul></li><li><p><strong>ConcurrentSkipListMap 和 ConcurrentSkipListSet</strong></p><ul><li>类型：线程安全的 Map 和 Set</li><li>特点：基于跳表实现，支持高并发操作，适合需要顺序访问的集合操作。</li></ul></li><li><p><strong>LinkedBlockingQueue</strong></p><ul><li>类型：线程安全的阻塞队列</li><li>特点：支持高并发的队列操作，适用于任务队列等场景。</li></ul></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;GQ-JUC&quot;&gt;GQ JUC&lt;/h1&gt;
&lt;h2 id=&quot;JUC&quot;&gt;JUC&lt;/h2&gt;
&lt;h3 id=&quot;进程、线程、协程的区别&quot;&gt;进程、线程、协程的区别&lt;/h3&gt;
&lt;p&gt;进程负责“资源”，线程负责“执行”，协程负责“更轻量的执行方式”。&lt;/p&gt;
&lt;h4 id=&quot;进程是</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>7分钟彻底搞懂Java各种锁</title>
    <link href="https://itgeqian.github.io/posts/65.html"/>
    <id>https://itgeqian.github.io/posts/65.html</id>
    <published>2025-10-14T02:09:03.000Z</published>
    <updated>2025-10-14T03:01:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>原视频地址【【程序员必看】Java各种锁详解：7分钟彻底搞懂Java各种锁！】<a href="https://www.bilibili.com/video/BV1yzs3zQEvD?vd_source=46212c2d164ea5464f361bff483cf8f6">https://www.bilibili.com/video/BV1yzs3zQEvD?vd_source=46212c2d164ea5464f361bff483cf8f6</a></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-20-1024x411.png" alt="img"></p><h2 id="1-悲观锁vs乐观锁">1.悲观锁vs乐观锁</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-21-1024x673.png" alt="img"></p><p>这一组锁是根据并发冲突的假设不同而进行区分，我们用上厕所来理解</p><p>悲观锁是被害妄想症（总假设会冲突），它就会锁上门再办事（先加锁再操作），java中我们熟悉的synchronized和Reentrantlock就是这种类型，只要一个线程抢到了锁，别的线程就只能阻塞等待，这种锁用在像秒杀减库存这种场景特别合适，虽然有点笨重但胜在绝对安全</p><p>那乐观锁呢，正好相反，它去上厕所，门都不锁，直接推门进去。等办完事出来检查一下，我进来时放的纸巾还是原来的品牌吗。如何还是，说明没人来过，万事大吉。如果被人换了，之前的就是白上了，需要重新再来一次。这个检查并替换的动作就是java中的CAS（Compare-And-Swap），咱们常用的AtomicInterger、AtomicLong这些原子类就是靠的这手绝活，它特别适合更新帖子阅读数这种竞争不太激烈的场景，性能起飞。不过它也有个坑就是经典的ABA问题。就是你女朋友找你分手了，她又找了个新男友，然后又分手了，最后来找你复合，她还是那个她，但中间发生过啥，你还真不知道。想解决也很简单，加个版本号就行，AtomicStampedReference就是干这个的</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-22.png" alt="img"></p><p>口述版本：</p><p><strong>悲观锁</strong>：</p><blockquote><p>悲观锁假设冲突总是会发生，因此每次操作时都加锁，确保没有其他线程干扰。<code>synchronized</code> 和 <code>ReentrantLock</code> 都是悲观锁的实现，适合数据一致性要求高的场景，但性能较低，因为每个线程都需要等待锁释放。</p></blockquote><p><strong>乐观锁</strong>：</p><blockquote><p>乐观锁假设冲突不会发生，线程不加锁，操作前后检查数据是否被修改。如果没被修改，就完成操作；如果被修改，就重新尝试。CAS（Compare-And-Swap）是乐观锁的典型实现，像 <code>AtomicInteger</code> 就是通过 CAS 实现的。适合冲突较少的场景，但存在ABA问题，可以通过版本号来解决。</p></blockquote><h2 id="2-公平锁vs非公平锁">2.公平锁vs非公平锁</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-24-1024x684.png" alt="img"></p><p>这一组是根据排队的规矩来分的，公平锁就像银行叫号，主打的就是先来先到，非公平锁就像路边招手打车，谁快谁上。</p><p>公平锁的优点：童叟无欺，确保每个线程都有出头之日，但是坏处也很明显，银行叫号中一个老太太办业务又慢又麻烦，其他人也只能在那之后乖乖等着，队伍不长才怪（吞吐量低），常用的ReentrantLock可以添加一个布尔型的参数true就表示采用的公平锁</p><p>非公平锁的优点：就像路边打车他才不管有没有人排队，谁动作快抢到了车谁就上，这么做的好处很明显，相比于公平锁省去了叫号、线程唤醒的麻烦，整个系统吞吐量一下就上去了，而锁的最大敌人就是吞吐量，所以ReentrantLock默认就是非公平锁，同样的synchronized也是默认非公平锁，因此除非你的业务有严格的先后顺序要求，否则就用默认的非公平锁，因为它更快</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-25.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-26.png" alt="img"></p><p>口述版本：</p><p><strong>公平锁</strong>：</p><blockquote><p>公平锁保证线程按照请求锁的顺序来获取锁，先来先得。一个典型的例子就是 <code>ReentrantLock(true)</code>，它通过队列来保证每个线程都能公平地获取锁。适合需要严格控制线程获取顺序的场景，但性能相对较低，因为线程管理开销较大。</p></blockquote><p><strong>非公平锁</strong>：</p><p>非公平锁允许线程在竞争时插队，后到的线程有可能抢到锁。<code>ReentrantLock</code> 默认就是非公平锁，性能较高，因为不需要维护严格的线程顺序。适合高并发、吞吐量要求高的场景，但有可能导致某些线程长时间无法获取锁（线程饥饿）。</p><h2 id="3-排他锁vs共享锁">3.排他锁vs共享锁</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-27-1024x698.png" alt="img"></p><p>排他锁和共享锁，它们的核心区别就是是否允许有线程并发。</p><p>排他锁（写锁）顾名思义就是排斥他人，它就像你去KTV的包间，你一个人进去了，不管你在里面唱歌跳舞还是睡觉，反正门一关谁也别想进来。在系统当中这就是独占锁，一个线程把资源占住了，其他的读写操作全部排斥，都只能乖乖等着，synchronized和ReentrantLock都是这种锁</p><p>但有时候我们不需要这么霸道，比如大家一起看报纸，这就是一种不影响报纸内容的读操作，多少人看都无所谓这就是共享锁（读锁），一个线程占住了读锁其他线程也可以同样拿到读锁，这就是读读并发，但是这个时候如果想要在报纸上涂鸦，这就变成了改变报纸内容的写操作了，他必须得所有看书的人都走了才行，而且他涂鸦的时候谁都不能看。java你想实现共享锁也很容易，可以用ReentrantReadWriteLock，这个强大的工具，它里面就同时维护了读锁和写锁，在读多写少的场景，更多的是使用读锁，能让并发性能原地起飞，这对于性能调优非常的重要</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-29-779x1024.png" alt="img"></p><table><thead><tr><th>对比项</th><th>排他锁（写锁）</th><th>共享锁（读锁）</th></tr></thead><tbody><tr><td>并发性</td><td>只允许一个线程持有</td><td>可允许多个线程同时读取</td></tr><tr><td>是否阻塞</td><td>阻塞其他读写线程</td><td>仅阻塞写线程，不阻塞其他读线程</td></tr><tr><td>性能表现</td><td>并发度低</td><td>并发度高，适合读多写少场景</td></tr><tr><td>Java 实现</td><td><code>synchronized</code>、<code>ReentrantLock</code></td><td><code>ReentrantReadWriteLock.readLock()</code></td></tr><tr><td>应用场景</td><td>秒杀扣库存、数据修改</td><td>配置读取、缓存访问</td></tr></tbody></table><p>补充：</p><ul><li><code>ReentrantReadWriteLock</code> 内部使用 <strong>AQS（AbstractQueuedSynchronizer）</strong> 来实现不同模式的同步控制。</li><li>在实际开发中，<strong>读多写少的业务逻辑</strong>（如缓存读取、系统配置查询）使用共享锁可以显著提升系统吞吐量。</li><li>而在<strong>写操作频繁或强一致性要求高</strong>的场景（如订单状态更新），则更适合使用排他锁。</li></ul><p>精简版口述答案：排他锁（写锁）是独占的，一个线程获取后其他线程不能再访问，典型实现是 <code>synchronized</code> 和 <code>ReentrantLock</code>；<br>共享锁（读锁）允许多个线程同时读取，但写线程必须等待所有读线程释放锁才能写，<code>ReentrantReadWriteLock</code> 就是典型实现。<br>简单来说，写锁防冲突，读锁提性能，读多写少时用读写锁效果最佳。</p><h2 id="4-可重入锁">4.可重入锁</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-28-1024x848.png" alt="img"></p><p>可重入锁表示同一线程是否可以重复持有自己的锁，这个非常重要因为java中天天用的这个<code>Reentrant</code>它的意思就是可重入的意思，啥叫可重入呢？就是你拿你的钥匙打开了大门进屋了，然后发现你的卧室门也需要同一把钥匙打开，这时候你不需要去找其他钥匙，直接用手里的钥匙去开卧室门。一个线程拿到锁以后，就可以反复进入这个锁保护的代码块而不会被自己锁住，<code>synchronized</code>、<code>ReentrantLock</code>都是可重入的，它们内部有个计数器，你每进去一层就+1出去一层就-1，直到计数器变成0，才算真正把锁还回去。</p><p>要是锁是不可重入的，那你进入大门想再开卧室门的时候，发现钥匙已经被大门锁占住了，结果自己把自己锁死在了客厅</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-31.png" alt="img"></p><p>口述版本：</p><p><strong>可重入锁</strong>：</p><p>可重入锁允许一个线程多次获取自己已经持有的锁，而不会导致死锁。它通过内部计数器来实现，每进入一次锁，计数器加 1，退出一次减 1，直到计数器为 0 锁才被释放。</p><p><strong>举个例子</strong>：你有一把钥匙（锁），先打开大门（获取锁），再用同一把钥匙打开卧室门（再次进入锁保护的区域），不需要重新找钥匙。</p><p><strong>Java 实现</strong>：<code>synchronized</code> 和 <code>ReentrantLock</code> 都是可重入锁，<code>ReentrantLock</code> 通过计数器管理锁的重入。</p><h2 id="5-synchronized的智能升级">5.<code>synchronized</code>的智能升级</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-30-1024x516.png" alt="img"></p><p>核心维度：根据“竞争激烈程度”自动优化锁状态，实现了强大的自动升级功能</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-32.png" alt="img"></p><p>我们以一个小故事来讲清楚偏向锁-&gt;轻量级锁-&gt;重量级锁的演化过程</p><p>你们公司有一台<strong>共享打印机</strong>（表示<strong>临界资源</strong>），程序员小王和其他同事每天都要用它打印资料。为了不冲突，公司安排了三种打印控制机制来「优化效率」，正好对应 JVM 中的三种锁状态。</p><p>锁优化三种形态对比类比</p><table><thead><tr><th>JVM 锁类型</th><th>类比打印控制机制</th><th>特点</th></tr></thead><tbody><tr><td>偏向锁（Biased）</td><td><strong>打印机记住上一个用户是谁</strong> 如果是同一个人再次使用，<strong>不做任何检查</strong>，直接打印</td><td>无竞争时性能最好（零开销）</td></tr><tr><td>轻量级锁（Lightweight）</td><td>多人要打印，先<strong>排队轮询查看是否空闲</strong>，只要打印机还没结束上一个人的工作，就<strong>自旋等待</strong>几次</td><td>低冲突下仍能保持高性能（无阻塞）</td></tr><tr><td>重量级锁（Heavyweight）</td><td>冲突太多了，打印任务就被<strong>挂起 / 唤醒</strong>，由操作系统调度谁先打印</td><td>冲突激烈时保障正确性，但性能最差</td></tr></tbody></table><hr><p>场景详解</p><p>偏向锁（Biased Lock）</p><ul><li>小王是第一个用打印机的人</li><li>打印机会<strong>记住小王的身份</strong></li><li>后面只要小王再次来打印，打印机就<strong>直接开工，不检查排队系统</strong>，因为它 “偏向” 小王</li></ul><blockquote><p>就像对象 MarkWord 中记录了某个线程的 ID，只有当其他线程来竞争才撤销偏向锁</p></blockquote><hr><p>轻量级锁（Lightweight Lock）</p><ul><li>小王打印时，小李也来了</li><li>打印机会说：“先别挂起，等等看小王是不是很快结束”</li><li>小李就在打印机旁边 “<strong>自旋等待</strong>”</li><li>如果小王很快结束了，小李就立即上，<strong>没有阻塞、也没有上下文切换</strong></li></ul><blockquote><p>自旋锁本质：用 CPU 忙等来换取线程不挂起</p></blockquote><hr><p>重量级锁（Heavyweight Lock）</p><ul><li>现在来了十几个人都要打印，等太久了</li><li>打印机会说：“别等了，我排个队号，通知你们一个个来”</li><li>系统就开始用 <strong>阻塞 → 唤醒 → 再阻塞</strong>的方式调度线程</li></ul><blockquote><p>操作系统介入调度，线程切换代价高，效率最低</p></blockquote><hr><p>最后总结：</p><table><thead><tr><th>情况</th><th>JVM 锁</th><th>打印类比</th><th>特点</th></tr></thead><tbody><tr><td>单线程使用资源</td><td>偏向锁</td><td>打印机只认上一次的使用者</td><td>零开销，最快</td></tr><tr><td>少量线程争用</td><td>轻量级锁</td><td>排队观察是否释放</td><td>快速尝试获取锁</td></tr><tr><td>多线程激烈争用</td><td>重量级锁</td><td>线程挂起等待系统调度</td><td>安全但慢</td></tr></tbody></table><p>补充：Java为了提升<code>synchronized</code>的性能，其实自己也在不断优化，JDK17取消了偏向锁，锁升级变得更加的顺滑</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-34.png" alt="img"></p><p>口述版本：</p><p><strong>synchronized的智能升级</strong>：</p><p><code>synchronized</code> 锁会根据线程竞争的情况自动升级，从而优化性能：</p><ol><li><strong>偏向锁（Biased Lock）</strong>：<br>当没有线程竞争时，偏向锁会让同一线程重复获取锁时几乎没有开销。就像打印机记住了上一个用户，下一次他直接使用，不用排队。</li><li><strong>轻量级锁（Lightweight Lock）</strong>：<br>当有少量线程竞争时，轻量级锁通过自旋等待的方式减少阻塞，性能较高。类似于多个用户排队等待打印机，只有前一个操作完成才能继续。</li><li><strong>重量级锁（Heavyweight Lock）</strong>：<br>当线程竞争激烈时，使用重量级锁，操作系统介入调度线程，代价较高。就像多人争抢打印机时，需要挂起线程排队等候。</li></ol><p><strong>总结</strong>：</p><ul><li><strong>偏向锁</strong>：适用于没有竞争的场景，零开销。</li><li><strong>轻量级锁</strong>：适用于竞争较少的场景，高效但不阻塞。</li><li><strong>重量级锁</strong>：适用于激烈竞争的场景，但性能最差。</li></ul><p>JDK17去掉了偏向锁，使锁的升级过程更加顺畅。</p><h2 id="总结">总结</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-33-1024x529.png" alt="img"></p>]]></content>
    
    
    <summary type="html">7分钟彻底搞懂Java各种锁，全程干货无废话</summary>
    
    
    
    <category term="面试" scheme="https://itgeqian.github.io/categories/%E9%9D%A2%E8%AF%95/"/>
    
    
    <category term="java面试题" scheme="https://itgeqian.github.io/tags/java%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    
  </entry>
  
  <entry>
    <title>7分钟速通mysql的核心面试题</title>
    <link href="https://itgeqian.github.io/posts/64.html"/>
    <id>https://itgeqian.github.io/posts/64.html</id>
    <published>2025-10-14T02:09:03.000Z</published>
    <updated>2025-10-14T03:01:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>原视频地址：<a href="https://www.bilibili.com/video/BV1asx6zUEge/?spm_id_from=333.1007.top_right_bar_window_default_collection.content.click&amp;vd_source=95e42b15b90c31bd4e580b92f2c79b91">【程序员必看】MySQL各种锁详解：7分钟彻底搞懂MySQL的各种锁_哔哩哔哩_bilibili</a></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-12-1024x496.png" alt="img"></p><p>首先要有大局观，比如你要锁东西是把整栋楼锁住还是只锁一个房间，或者干脆只锁一个抽屉呢，这就是锁的粒度，也就是锁的范围大小，在MYSQL中锁的粒度如下</p><h2 id="MYSQL锁的粒度">MYSQL锁的粒度</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-13-1024x512.png" alt="img"></p><ul><li>全局锁：锁住整个数据库（相当于给整个大楼给封了），一个命令下来整个库谁也别想写数据，<ul><li>作用：显而易见用于全库备份时使用，全库备份需要保证数据一动不动，这就是全局锁的作用了</li></ul></li><li>表锁：锁住整张表（相当于锁一个房间），像老一点的MyISAM引擎默认就是表锁。<ul><li>好处：简单直接，开销小</li><li>坏处：只要有一个人在房间操作其他所有人都要在门口排队，即并发差</li></ul></li><li>行锁：锁住当行数据（相当于只锁一个抽屉），这也是目前InnoDB用的<ul><li>好处：并发高，你给你的数据我改我的数据只要不是同一行数据咱两就互不影响</li><li>坏处：开销大（管一堆钥匙，要比只管大门钥匙要麻烦很多），可能死锁（你拿着我的钥匙我拿着你的钥匙两人就卡着不动了）</li></ul></li></ul><h2 id="MYSQL锁的派别">MYSQL锁的派别</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-14-1024x583.png" alt="img"></p><ul><li>悲观锁：它认为只要我改数据肯定就有人给我抢，所以它在干活前就用select…for update语句来锁住把数据锁的死死的，谁也别想动<ul><li>场景:用在秒杀，抢库存这一类高并发的场景中（写多读少），并发写操作多，冲突概率极大必须先下手为强</li></ul></li><li>乐观锁：它是乐天派，认为改数据时没那么多人跟我抢，所以它不加锁，直接去操作数据，只在最后要提交的时候，用版本号或者时间戳来比对一下，看看我干活的这期间有没有人都过我的数据，如果有人改了，这次提交就失败<ul><li>场景：适合像改文章，改商品信息这一类读多写少的场景，因为它省去了加锁的开销，性能就会好很多</li></ul></li></ul><h2 id="MYSQL中锁自带的两种基本类型">MYSQL中锁自带的两种基本类型</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-15-1024x600.png" alt="img"></p><p>相当于在图书馆看书时</p><p>共享锁（S锁/读锁）：它就等于大家一起看书，一本书可以被很多人同时看，只要大家不在上面写字就行，即读读共享，读写互斥，在mysql中可以用lock in share mode这个语句加的就是一个读锁</p><p>排他锁（X锁/写锁）：当我要改书的时候必须要把这本书拿走，自己一个人改，在你改完还回来之前，别人既不能看也不能改，即写写互斥，读写互斥，在mysql中可以用for update这个语句加的就是一个读锁</p><h2 id="MYSQL中意向锁（Intention-Lock）">MYSQL中意向锁（Intention Lock）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-16-1024x398.png" alt="img"></p><p>但它想成一个挂在表门口的通知牌，它的作用就是为了提高效率，如果事务A锁了表里面的某一行数据，这个时候事务B它想要给整个表加一个锁，那MYSQL咋办呢，难道一行一行去检查有没有行锁吗，那表里面如果有上千万行数据查到猴年马月去，这数据库直接就会被卡死，所以InnoDB就设计了这个通知牌，当事务A给某一行加锁的时候，InnoDB会自动在这个表的门口上面挂个牌子，上面写着里面有人正在操作请注意，这样当事务B想来锁整张表的时候抬头一看这张表的门口上有个牌子，立刻就知道里面有行锁，有冲突，自己得等着，效率一下就上来了，所以意向锁本身它是一个表级锁，但它不是用来锁数据的，而是用来打配合提高效率的，</p><p>有了意向锁这个帮手我们再来看看InnoDB真正在一线干活的几个核心武器</p><h2 id="MYSQL中记录锁（Record-Lock）">MYSQL中记录锁（Record Lock）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-17-1024x327.png" alt="img"></p><p>第一个记录锁，记录锁这就是最纯粹的行锁，指哪打哪，只锁定你查询命中的那一条记录，比如能用注解where id = 10去更新，那他就只锁ID等于10这一行，这是我们最希望看到的最理想的情况</p><p>但是如果查询条件不是唯一的呢，比如查age&gt;18这样的范围，这时候面试必考的知识点就来了-<strong>幻读</strong></p><p>为了解决幻读InnoDB就掏出来他的大杀器间隙锁&amp;临键锁</p><h2 id="MYSQL中的间隙锁-临键锁">MYSQL中的间隙锁&amp;临键锁</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-18-1024x361.png" alt="img"></p><p>间隙锁它不锁任何已经存在的数据，就是一个开区间，它只是锁住记录和记录之间的那个缝，比如说索引里面有10和20，那他就锁住10-20这一个区间，让你没法在这个缝隙里面插入新的数据，它就像给数据之间放了个结界，任何新的换的数据都不允许冒出来。</p><p>而临键锁呢，他就是记录锁+间隙锁，它不但锁住记录本身，还把这条记录前面的那个缝也锁住了，这才是InnoDB在可重复读隔离级别下默认使用的锁，它就像一张大网，把记录和它旁边的缝全给罩住，让幻读无处遁形</p><h2 id="所以说为什么有了MVCC还需要锁来防止幻读呢">所以说为什么有了MVCC还需要锁来防止幻读呢</h2><p>MVCC保证了你读的时候看不到幻影，而临键锁保证了在别人写的时候造不出幻影，一个防读，一个防写</p><p>详细的解释：</p><hr><h3 id="🌱-背景：MVCC-与-幻读">🌱 背景：MVCC 与 幻读</h3><p>在 MySQL 的 <strong>可重复读（REPEATABLE READ）</strong> 隔离级别中，主要通过 <strong>MVCC（多版本并发控制）</strong> 来解决「脏读」和「不可重复读」问题。</p><ul><li><strong>MVCC 的核心思想</strong> 是：每个事务在开始时，会看到一个“快照”（Snapshot）——也就是数据库在那个时间点上的一致性视图。</li><li>因此，当事务读取时，不管其他事务后来插入/修改了什么，它都<strong>不会看到新数据</strong>（这是 MVCC 的作用）。</li></ul><p>但是：<br>MVCC 只能保证<strong>读到的内容一致</strong>，却<strong>不能防止别的事务在你读的同时插入新的记录</strong>。这就导致了“幻读”的问题。</p><hr><h3 id="🧩-幻读（Phantom-Read）">🧩 幻读（Phantom Read）</h3><p>假设事务 A 执行：</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> age &gt; <span class="number">20</span>;</span><br></pre></td></tr></table></figure><p>此时事务 B 在事务 A 未提交期间执行：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO <span class="built_in">users</span>(age) <span class="built_in">VALUES</span>(<span class="number">25</span>);</span><br></pre></td></tr></table></figure><p>那么事务 A <strong>再次执行相同的 SELECT</strong> 时，会发现多了一行——这就是“幻影行”，即<strong>幻读</strong>。</p><hr><h3 id="🔒-那为什么-MVCC-不够？">🔒 那为什么 MVCC 不够？</h3><p>MVCC 只解决了“读一致性”的问题，它的作用是：</p><blockquote><p>“你在读时，看不到别人已经提交的新数据。”</p></blockquote><p>但它<strong>不能阻止别人去插入新行</strong>。换句话说：</p><ul><li>你读时，看不到幻影（MVCC 起作用）；</li><li>但别人写时，可能造出幻影（MVCC 无法阻止）。</li></ul><p>所以当你要防止别人“造幻影”时，必须依赖 <strong>锁（尤其是 Next-Key Lock 临键锁）</strong>。</p><hr><h3 id="⚙️-临键锁（Next-Key-Lock）的作用">⚙️ 临键锁（Next-Key Lock）的作用</h3><p>在 InnoDB 中，<strong>Next-Key Lock = 行锁 + 间隙锁</strong>。<br>它不只锁住已有的行，还锁住这些行之间的间隙（gap），从而阻止别的事务往这些间隙插入新行。</p><blockquote><p>举例：</p><p>如果表中有 <code>age = 18, 25, 30</code> 三行，<br>那么查询 <code>age &gt; 20</code> 时，InnoDB 可能会锁住区间 <code>(20, 30)</code>，<br>这使得别人无法在 20~30 之间插入新数据。</p></blockquote><hr><h3 id="🧠-理解那句话：">🧠 理解那句话：</h3><blockquote><p>“MVCC 保证了你读的时候看不到幻影，而临键锁保证了在别人写的时候造不出幻影，一个防读，一个防写。”</p></blockquote><p>意思是：</p><ul><li><strong>MVCC</strong>：让你在读时看到的世界是稳定的，不会因为别的事务插入/修改而“看见幻影”；</li><li><strong>临键锁（Next-Key Lock）</strong>：防止别人在你事务期间插入“幻影行”，即从“写的角度”避免幻读的出现。</li></ul><p>换句话说：</p><ul><li>MVCC 是 <strong>“读一致性”</strong> 的机制；</li><li>锁是 <strong>“写互斥”</strong> 的机制；<br>两者配合，才能在高并发下既读得快又能保证事务隔离性。</li></ul><hr><h3 id="✅-小结类比">✅ 小结类比</h3><table><thead><tr><th>机制</th><th>防止什么</th><th>方式</th><th>说明</th></tr></thead><tbody><tr><td>MVCC</td><td>读到幻影（读时不一致）</td><td>读快照</td><td>“别人改了也不影响我现在看的”</td></tr><tr><td>临键锁</td><td>别人造幻影（写时插入）</td><td>锁定间隙</td><td>“别人不能在我查过的范围插入新行”</td></tr></tbody></table><hr><h2 id="总结">总结</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-19-1024x403.png" alt="img"></p><p>总结;锁这个东西从来没有绝对的好与坏，全局锁虽然暴力，但是在备份的时候离不开它，行锁虽然精细，但你得承担死锁的风险，临键锁虽然能解决幻读，但它也可能锁住没有必要的范围，牺牲了一些性能</p>]]></content>
    
    
    <summary type="html">7分钟速通mysql的核心面试题，全程干货无废话</summary>
    
    
    
    <category term="面试" scheme="https://itgeqian.github.io/categories/%E9%9D%A2%E8%AF%95/"/>
    
    
    <category term="mysql面试题" scheme="https://itgeqian.github.io/tags/mysql%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    
  </entry>
  
  <entry>
    <title>7分钟速通RocketMQ的核心面试题</title>
    <link href="https://itgeqian.github.io/posts/63.html"/>
    <id>https://itgeqian.github.io/posts/63.html</id>
    <published>2025-10-14T02:09:03.000Z</published>
    <updated>2025-10-14T03:01:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>原视频地址：<a href="https://www.bilibili.com/video/BV1pXnwz7EGY/?spm_id_from=333.1387.favlist.content.click&amp;vd_source=95e42b15b90c31bd4e580b92f2c79b91">程序员必看：7分钟一次性讲透RocketMQ核心面试题，全程干货无废话，吊打面试官！_哔哩哔哩_bilibili</a></p><h2 id="第一问：什么是消息队列？有什么用？">第一问：什么是消息队列？有什么用？</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-3-1024x697.png" alt="img"></p><p>我们先从一个场景开始，服务A需要远程调用服务B的服务，但A服务每秒发送两百个请求，但B服务每秒只能处理一百个请求，那么B服务就会分分钟被压垮，怎么办呢，那就在中间加一层中间件-消息队列，A是生产者，负责发送消息，B是消费者，负责处理消息。生产者发送的消息在消息队列中排队，并且给它分配一个编号，消费者按照自己的速度从消息队列中拉取消息来进行消费，并且记录自己的处理进度，称为offset偏移量，有了中间的消息队列作为缓冲，那B服务就可以按照自己的速度来处理消息，这样一个基础的消息队列就成型了。</p><h2 id="第二问：如何扩展性能？">第二问：如何扩展性能？</h2><p>但这是一个简陋的消息队列，当消费者多了，怎么提升性能，机器挂了数据丢了怎么办？</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-4-1024x692.png" alt="img"></p><p>第一步处理性能瓶颈，B处理不过来，消息会产生堆积。我们就找多个业务逻辑相同的B组成一个消费者组ConsumerGroup大家一起干，那问题来了，所有人都在抢一个队列，还是会有性能瓶颈，解决分案就是给消息进行分类，就是Topic，一个Topic再分成多个实际存储消息的message queue，生产者指定Topic发送消息，消息会尽量均匀地写入到不同的message queue队列中，每个队列再去分配给消费者组当中的某一个消费者进行消费，这样呢每个message queue的消费进度互不干涉，自然就能分工协作了，就好比超市结账原本一个收银台，现在开了多个，效率就快很多了</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-5-1024x542.png" alt="img"></p><p>然后在消息队列的服务端分别记录每个message queue上消息写入的进度，称为代理者位点，还有每个消费者组的消费进度，称为消费者位点，这样就能够有效的监控每个message queue上的消息的消费进度了，RocketMQ就是通过这些位点来监控消息的处理进度，如果发现了消息的堆积，也可以通过这些位点数据快速的分析出来</p><h2 id="第三问：如果所有的message-queue队列都在一台机器上，那消息一多磁盘不就爆了吗">第三问：如果所有的message queue队列都在一台机器上，那消息一多磁盘不就爆了吗</h2><p>没错！所以我们要搞broker集群实现水平扩展，由于每个message queue都是在单独管理自己的数据和位点，我们可以把一个Topic下的多个message queue尽量均匀的分配到不同的broker上，这样就可以减少每一个服务端的读写压力。</p><h2 id="第四问：如何保证高可用？">第四问：如何保证高可用？</h2><p>第二步，来解决高可用问题</p><p>如果一个broker挂了，那么上面的数据就全都没了，高可用怎么谈呢？</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-6-1024x706.png" alt="img"></p><p>这就涉及到RocketMQ的主从架构了，在RocketMQ中每个主的broker称为master，从的broker称为slave，master节点负责干活，实际处理客户端读写消息的请求，slave只负责一件事，拼命同步master的数据，当master挂了之后，slave立刻顶上变成新的master，这样就保证了服务不中断</p><h2 id="第五问：那生产者怎么知道我的消息要发送到哪个broker呢？消费者又从哪里去拉取消息呢？如果broker挂了主从发生了切换它们怎么知道呢？">第五问：那生产者怎么知道我的消息要发送到哪个broker呢？消费者又从哪里去拉取消息呢？如果broker挂了主从发生了切换它们怎么知道呢？</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-7-1024x793.png" alt="img"></p><p>这个问题涉及到了集群的大脑，在RocketMQ中这个大脑就是自主设计的NameServer，NameServer就是RocketMQ的注册中心，它极其轻量但干着非常重要的工作，第一管户口，所有的broker都需要向NameServer报到，并且通过心跳告诉NameServer，它是不是还活着。第二管地图，NameServer手中有张完美的路由信息表，就知道每个topic的队列在哪些机器上。第三当向导，生产者和消费者都要问它要地图，然后才能找到正确的broker通道，接下来进行后续的消息通讯。为了保证向导自己不出事，NameServer自己也是得做集群部署的</p><h2 id="第六问：RocketMQ为什么要自主设计一个NameServer，而不用其他现成的注册中心zookeeper，nacos？">第六问：RocketMQ为什么要自主设计一个NameServer，而不用其他现成的注册中心zookeeper，nacos？</h2><p>这个问题直击RocketMQ的设计核心，因为RocketMQ的核心是金融，电商这类非常灵活的业务场景服务的，这使得RocketMQ的整个设计思想和Kafka这样追求极致的吞吐的消息中间件有根本的区别，在保证高性能的同时，对于服务的可靠性也要做到极致。一方面NameServer采用一种极为轻量级的集群方案，每个NameServer节点之间不需要和集群当中的其他节点发生任何的数据交互，这样可以保证NameServer集群当中只要有任何一个节点正常工作，那么整个NameServer集群就能够保持正常。另一方面，业务的频繁更迭，使得RocketMQ也需要及时进行升级，自主研发的NameServer可以更灵活的应对新的业务场景</p><p>其他面试题</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-8-1024x198.png" alt="img"></p><p>例如面试官常问，RocketMQ为什么要设计生产者组呢？而Kafka中却不需要呢</p><p>这本质上还是因为RocketMQ的核心是为金融，电商这类严肃的业务场景服务的，而Kafka的核心则是为了分布式日志这一类对吞吐量要求极高的业务场景服务的，在RocketMQ的业务场景下，事务消息是刚需，比如下单这个操作就要保证生产者本地的创建订单和基于RocketMQ发送的扣减库存的消息要么都处理成功要么都失败，不允许有中间状态。RocketMQ中的broker在处理这类事务时就需要反向来检查生产者的状态，这时生产者组的作用就来了，它会告诉broker我们是同一个业务的，你随便向我们组里的任何一个人问，都能知道这个事务最终是成功还是失败，如果某一个生产者实例挂了，broker可以通过回查同一个生产者组内的其他实例，来确定事务的最终状态，这就是RocketMQ为了保证业务万无一失做的独特设计</p><p>其他常见的高阶面试题：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-9-1024x475.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-10-1024x325.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-11-1024x231.png" alt="img"></p>]]></content>
    
    
    <summary type="html">7分钟速通RocketMQ的核心面试题，全程干货无废话</summary>
    
    
    
    <category term="面试" scheme="https://itgeqian.github.io/categories/%E9%9D%A2%E8%AF%95/"/>
    
    
    <category term="RocketMQ面试题" scheme="https://itgeqian.github.io/tags/RocketMQ%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    
  </entry>
  
  <entry>
    <title>Redis分布式锁的理解</title>
    <link href="https://itgeqian.github.io/posts/66.html"/>
    <id>https://itgeqian.github.io/posts/66.html</id>
    <published>2025-10-14T02:09:03.000Z</published>
    <updated>2025-10-14T03:01:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>背景：小徐是一个程序员，他开发了一个秒杀功能，但出现了超卖问题。</p><ul><li>超卖问题的出现：多线程并发环境下，如果同时对一个共享资源进行读写，数据会出现错乱的问题</li></ul><p>这一次他加了一个同步锁 synchronized，这次终于不会超卖了，那我们都知道当多线程并发情况下我们加了同步锁，在同一时刻保证只有一个线程能拿到锁，其他进程进来会进行一个互斥，需要排队等待需要等持有锁线程处理完释放锁</p><p>但是随着用户量越来越多小徐发现服务器压力越来越大，性能达到了瓶颈，于是小徐通过nginx进行了负载均衡，他将服务器进行了水平扩展，通过nginx进行了分布式集群部署，但是测试时吞吐量确实上来了，但是秒杀功能又出现了超卖问题，经过发现原来是同步锁的问题，<strong>因为同步锁它是JVM级别的，它只能锁住单个进程，但是经过分布式部署之后呢，每台服务器在并发的情况下只能锁住一个线程</strong></p><p>所以要解决这个问题我们就要用到分布式锁，分布式锁，顾名思义，<strong>分布式锁就是分布式场景下的锁，比如多台不同服务器上的进程，去竞争同一项资源，就是分布式锁。</strong></p><p>主流的分布式锁的解决方案有Redis和zookeeper</p><p>这里我们主要讲解Redis的分布式锁</p><h3 id="1-我们先实现一个最简单的分布式锁">1.我们先实现一个最简单的分布式锁</h3><p>直接用Redis的setnx命令，这个命令的语法是：setnx key value如果key不存在，则会将key设置为value，并返回1；如果key存在，不会有任务影响，返回0。</p><p>基于这个特性，我们就可以用setnx实现加锁的目的：通过setnx加锁，加锁之后其他服务无法加锁，用完之后，再通过delete解锁。</p><p>但是一定要加过期时间，<strong>因为如果用户在请求的过程中，服务器挂了，那么其他的服务器正常请求时，就会出现一个阻塞的情况</strong>，因为其他服务器的线程通过setnx进行上锁的时候，发现这个键里面一直有值，就会永远不会上锁成功，之前挂掉的服务器它一直持有锁从而造成了一个死锁的现象，所以此时我们要加上一个过期时间进行兜底，经过这个时间后锁就会自动释放，从而不影响其他服务器的正常请求</p><h3 id="二个问题的解决（锁续期与锁误删）以及Lua脚本">二个问题的解决（锁续期与锁误删）以及Lua脚本</h3><p>虽然业务的扩展，我们又发现了问题，<strong>当业务（线程1）的处理时间超过了这把锁的过期时间时，此时业务还没有处理完，锁就释放掉了</strong>，其他的线程（线程2）就会趁虚而入，线程1处理完业务后，回来释放锁，此时释放的就是线程2的锁，而其他的线程此时又会趁虚而入，以此类推。<strong>总结下来就是有两个问题：</strong></p><ul><li><strong>锁过期时线程还在处理业务当中</strong></li><li><strong>存在线程1释放掉线程2的锁，即锁误删现象</strong>（<strong>分布式锁需要满足谁申请谁释放原则，不能释放别人的锁，也就是说，分布式锁，是要有归属的</strong>。）</li></ul><p>我们先来解决第一个问题-锁过期时线程还在处理业务当中怎么办呢</p><ul><li>我们可以加长锁的一个过期时间，并且我们还需要考虑到如果我加长的这个时间还是不够怎么办呢，我们增加一个兜底的方案，在业务代码当中我们添加一个子线程，每10秒去确认主线程是不是在线，如果在线则将过期时间重置，也就是将锁续期</li></ul><p>我们再来解决第二个问题-锁误删现象怎么解决</p><ul><li>就是我们给锁增加一个唯一ID（UUID），这样就能保证每一把锁的它的KEY是绑定的自己的那一个线程，从而业务执行完毕后会先检查锁是不是自己的，最后进行释放。就不会释放其他线程的锁</li></ul><h4 id="Lua脚本">Lua脚本</h4><p>也就是说我们完整的流程是竞争者获取锁执行任务，执行完毕后检查锁是不是自己的，最后进行释放。但是执行完毕后，检查锁，再释放，这些操作如何保证它是原子化的操作呢？Redis还有个特性，专门整合原子操作，就是Lua脚本。</p><p>Lua脚本可以保证原子性，因为Redis会将Lua脚本封装成一个单独的事务，而这个单独的事务会在Redis客户端运行时，由Redis服务器自行处理并完成整个事务，如果在这个进程中有其他客户端请求的时候，Redis将会把它暂存起来，等到 Lua 脚本处理完毕后，才会再把被暂存的请求恢复。</p><p>但是我们发现如果我们自己实现锁误删和锁续期这些代码非常的麻烦，还要保证它的一个健壮性，所以Redis有没有提供相关的组件来完成这些功能呢，有的兄弟有的，这就是Redisson</p><h3 id="Redisson原理">Redisson原理</h3><p>Redis提供了一个Redisson完成我们刚刚说到的功能，实现起来也非常的简单，只要添加Redisson相关的一个依赖，把Redisson的客户端自动装配起来通过lock.lock（）就可以实现Redisson的分布式锁</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/11/image-20251103140343453-1024x624.png" alt="img"></p><p>我们来说说Redisson的原理是什么，同样的多个线程请求同一资源，当然只有一个线程才能获取这把锁，比如线程1获取到了这把锁，它的key呢就如我们刚刚所说，它用的是UUID+线程ID合并起来保证我们的key和当前线程绑定在一起，这样就不会出现锁误删的问题，当线程1获取锁成功去处理业务的时候，它内部会有一个看门狗机制，它呢会每隔10秒看一下当前线程是否还持有锁，如果持有的话就延长生存时间，从而给这把锁续命。如果我们实现了Redis的集群呢，它就会选择Redis当中的某一个集群</p><p>那如果没有获取到锁的话，线程就会不停的自旋尝试获取锁只到超时为止</p><p>以上就是Redisson的实现原理</p><h4 id="红锁的实现">红锁的实现</h4><p>在Redis中如果使用了主从集群的一个模式，因为Redis采用的是AP模式，也就是<strong>它只能保证这个高可用和高性能，但是不能保证高一致性</strong>，当我们设置一个锁的时候它其实只会往一个节点去设置一个锁，设置完了就会立马告诉你设置成功，然后内部进行主从同步，<strong>如果我们把这个key设置到了主节点，我们主从同步的时候正好主节点挂了，从节点并没有同步到这把锁</strong>，<strong>导致新的主节点也没有同步过来锁信息，客户端可能重新获取新的主节点的锁，出现了多客户端同时持锁，导致数据不一致的问题</strong>。（<strong>主从异步复制+主从切换可能出现“旧主没释放锁，新主也没这把锁”的锁丢失/多客户端同时持锁问题。</strong>）这个时候应该怎么做呢</p><p>其实Redis也提供了相应的解决方法，那就是红锁RedLock，Redlock 是 Redis 官方提出的分布式锁算法，<strong>通过在N个（通常为5）相互独立的 master 上同时加锁，并且拿到多数派的锁(≥ N/2+1) 才算成功</strong>，来提升锁的安全性和可用性。<strong>如果没有RedLock就如我们刚刚所说，我们往一个主节点去设置一个锁，设置完了就会立马响应设置成功，而不去管从节点是否完成了同步，我们使用了RedLock，它要保证你提供的多数派节点（5个主节点，其中要5/2+1,即4个）都存储完毕了，它才会给你响应设置完成，来提升锁的安全性和可用性</strong></p>]]></content>
    
    
    <summary type="html">Redis分布式锁的理解</summary>
    
    
    
    <category term="面试" scheme="https://itgeqian.github.io/categories/%E9%9D%A2%E8%AF%95/"/>
    
    
    <category term="Redis面试题" scheme="https://itgeqian.github.io/tags/Redis%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    
  </entry>
  
  <entry>
    <title>雨云服务器Linux挂载磁盘</title>
    <link href="https://itgeqian.github.io/posts/62.html"/>
    <id>https://itgeqian.github.io/posts/62.html</id>
    <published>2025-10-12T02:09:03.000Z</published>
    <updated>2025-10-12T03:01:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>如果您在控制台新增了一块磁盘，您可以按照本小结挂载硬盘</p><h3 id="前置条件">前置条件</h3><p>如果您是RockyLinux9、CentOS7/8/9请先安装以下依赖</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CentOS7的源已失效，如果无法安装可以先尝试更换一个源</span></span><br><span class="line">yum <span class="keyword">install</span> nano</span><br></pre></td></tr></table></figure><h3 id="确认需要操作的磁盘">确认需要操作的磁盘</h3><p>使用 <code>fdisk -l</code>命令根据大小及其他信息确认需要操作的磁盘</p><blockquote><p>可以看到，本例子中新增的硬盘为sdb</p></blockquote><p><img src="https://cn-sy1.rains3.com/rainyun-assets/pic/2025/10/20251008-185815.png" alt="img"></p><h3 id="创建分区">创建分区</h3><p>输入命令</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sdx为您需要操作的分区，如本例子为sdb</span></span><br><span class="line">fdisk <span class="regexp">/dev/</span>sdx</span><br></pre></td></tr></table></figure><p>在fdisk中输入<strong>n</strong>，然后多次回车使用默认值，看到<code>Created a new partition 1 of type 'Linux' ....</code>后，输入<strong>w</strong>写入到分区表</p><p><img src="https://cn-sy1.rains3.com/rainyun-assets/pic/2025/10/20251008-190135.png" alt="img"></p><h3 id="格式化分区">格式化分区</h3><p>再次输入<code>fdisk -l</code>命令确认新创建的分区</p><blockquote><p>可以看到，本例子中新增的分区为sdb1</p></blockquote><p><img src="https://cn-sy1.rains3.com/rainyun-assets/pic/2025/10/20251008-190531.png" alt="img"></p><p>输入以下命令格式化磁盘为ext4</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sdxx为您看到的分区，如本例子为sdb1</span></span><br><span class="line">mkfs.ext4 <span class="regexp">/dev/</span>sdxx</span><br></pre></td></tr></table></figure><p><img src="https://cn-sy1.rains3.com/rainyun-assets/pic/2025/10/20251008-190619.png" alt="img"></p><h3 id="挂载磁盘">挂载磁盘</h3><p>创建一个空目录用作挂载磁盘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 路径可以任意，但是需要为空目录，本例子为/mnt/disk-1</span></span><br><span class="line"><span class="built_in">mkdir</span> /mnt/disk-1</span><br></pre></td></tr></table></figure><p>由于挂载磁盘的sdx顺序可能会改变，如改变可能会导致系统无法启动，所以需要使用UUID挂载 输入以下命令获取blkid</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">blkid</span></span><br></pre></td></tr></table></figure><blockquote><p>可以看到，本例子中，磁盘的UUID为f5c1d999-19ec-457d-be82-c830094d9b70</p></blockquote><p><img src="https://cn-sy1.rains3.com/rainyun-assets/pic/2025/10/20251008-190916.png" alt="img"></p><p>最后输入<code>nano /etc/fstab</code>编辑fstab文件，在其中插入，插入完成后按<code>Ctrl+X</code>，然后输入<code>Y</code>并回车保存即可</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注：UUID需要替换为您从blkid命令中获取的；/mnt/disk-1挂载路径也需要替换为您实际的</span></span><br><span class="line"><span class="attribute">UUID</span>=<span class="string">&quot;f5c1d999-19ec-457d-be82-c830094d9b70&quot;</span> /mnt/disk-<span class="number">1</span> ext4 defaults <span class="number">0</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><p><img src="https://cn-sy1.rains3.com/rainyun-assets/pic/2025/10/20251008-191505.png" alt="img"></p><h3 id="重启服务器">重启服务器</h3><p>重启服务器后，即可看到成功挂载</p>]]></content>
    
    
    <summary type="html">雨云服务器Linux挂载磁盘教程</summary>
    
    
    
    <category term="杂项" scheme="https://itgeqian.github.io/categories/%E6%9D%82%E9%A1%B9/"/>
    
    
    <category term="雨云服务器" scheme="https://itgeqian.github.io/tags/%E9%9B%A8%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>GQ Video项目部署</title>
    <link href="https://itgeqian.github.io/posts/2.html"/>
    <id>https://itgeqian.github.io/posts/2.html</id>
    <published>2025-10-06T10:19:03.000Z</published>
    <updated>2025-10-06T14:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<table><thead><tr><th>服务名称</th><th>英文名</th><th>端口号</th><th>版本号</th><th>服务类别</th></tr></thead><tbody><tr><td>数据库</td><td>mysql</td><td>3306</td><td>v8.26</td><td>环境依赖</td></tr><tr><td>搜索引擎</td><td>es</td><td>9201</td><td>3.1.9</td><td>环境依赖</td></tr><tr><td>缓存</td><td>Redis</td><td>6379</td><td>v8</td><td>环境依赖</td></tr><tr><td>消息队列</td><td>RocketMQ</td><td></td><td>2.3.0</td><td>环境依赖</td></tr><tr><td>注册中心</td><td>nacos</td><td>8848</td><td>v2.2.0</td><td>环境依赖</td></tr><tr><td>网关服务</td><td>easylive-cloud-gateway</td><td>7071</td><td>java8</td><td>项目</td></tr><tr><td>分布式事务</td><td>Seata</td><td>7091</td><td>2021.0.5.0</td><td>环境依赖</td></tr><tr><td>对象存储</td><td>Minio</td><td>9000</td><td>2024-09-13T20-26-02Z</td><td>环境依赖</td></tr><tr><td>管理端服务</td><td>easylive-cloud-admin</td><td>7070</td><td>java8</td><td>项目</td></tr><tr><td>用户端服务</td><td>easylive-cloud-web</td><td>7072</td><td>java8</td><td>项目</td></tr><tr><td>交互服务</td><td>easylive-cloud-interact</td><td>7073</td><td>java8</td><td>项目</td></tr><tr><td>资源服务</td><td>easylive-cloud-resource</td><td>7074</td><td>java8</td><td>项目</td></tr><tr><td></td><td></td><td></td><td></td><td></td></tr></tbody></table><h1 id="微服务项目部署指导">微服务项目部署指导</h1><p><em>Exported on 2025/10/6 at GMT+8 0:12:27 from Cursor (1.4.2)</em></p><hr><p><strong>User</strong></p><p>整个项目已经完结，请你仔细查看一下项目的结构，我现在想要把这个微服务项目部署到一个我已经准备好的4核4g的服务器上该如何部署，是选择用宝塔面板还是用docker compose部署呢，请你指引着我一步步完成部署@c:\Users\wanglei\Desktop\<a href="http://xn--i0yq5pe7ol9g.md">项目部署.md</a></p><hr><p><strong>Cursor</strong></p><p>我先快速查看各微服务的配置文件端口与外部依赖（Nacos、Redis、RocketMQ、Minio 等）的指向，确保 docker-compose 方案能一次性把依赖与服务都编排好。随后我会给出一步步部署清单与可直接使用的 compose 文件与构建命令。</p><p>我将先创建一个部署任务清单，随后直接给出推荐方案（Docker Compose）与可运行的命令、配置与文件模板。接下来我会把全部步骤一次性写全，便于你按部就班执行。</p><p>我先并行打开各微服务的配置文件，确认注册中心、配置名与端口设置，以便给出可直接可用的 docker-compose 参数和环境变量。接着我会确定采用 Docker Compose 的总体策略并开始给出脚本。</p><p>我已确认各服务的 <code>bootstrap.yml</code> 通过 Nacos 加载共享配置且默认指向 127.0.0.1:8848，容器化时需用环境变量覆盖为 nacos:8848。现在我先确定采用 Docker Compose 方案，并开始给出安装与编排文件。接下来把“安装 Docker/Compose”设为进行中。</p><p>我将并行打开各服务的 dev 配置文件，确认数据库、存储和消息队列的连接信息，以便在 docker-compose 中正确注入环境变量。</p><p>我将把“安装 Docker/Compose”完成并开始“创建目录结构与 .env 机密变量”，随后给出<code>.env</code>和<code>docker-compose.yml</code>模板与执行命令。接着我会继续推进依赖与应用编排等步骤，并同步勾选对应待办。</p><p>我已经确定采用 Docker Compose 部署，并开始输出目录结构、<code>.env</code> 与依赖编排模板，随后给出后端镜像构建与应用编排、前端与 Nginx 配置。接着我会把“创建目录结构与 .env”标记完成，并开启“依赖服务编排”和“应用编排”。</p><p>我已确认采用 Docker Compose 并核对了各微服务的 Nacos 配置与端口。现在我会直接给出一步步部署清单、必要命令与可用模板（.env、docker-compose、Dockerfile、Nginx），你可以按顺序执行。随后我会把清单项勾选完成。### 结论与建议</p><ul><li>建议使用 Docker Compose 部署。原因：<ul><li>多个基础依赖（MySQL/Redis/Nacos/RocketMQ/Minio/ES/Seata）与 5 个 SpringBoot 微服务需要统一编排、网络与持久化，更易复现与维护。</li><li>日志、重启策略、资源限制、备份与迁移都更容易标准化。</li></ul></li><li>4 核 4G 机器资源偏紧。建议先上线核心链路（MySQL、Redis、Nacos、Minio、网关与核心三服务），RocketMQ/ES/Seata如非强依赖可延后启用，或按需独立机器。</li></ul><h3 id="端口规划（来自你的部署文档）">端口规划（来自你的部署文档）</h3><ul><li>数据库 MySQL: 3306</li><li>Nacos: 8848</li><li>网关 <code>easylive-cloud-gateway</code>: 7071</li><li>管理端 <code>easylive-cloud-admin</code>: 7070</li><li>用户端 <code>easylive-cloud-web</code>: 7072</li><li>交互 <code>easylive-cloud-interact</code>: 7073</li><li>资源 <code>easylive-cloud-resource</code>: 7074</li><li>Redis: 6379</li><li>Minio: 9000(服务) + 9001(控制台)</li><li>RocketMQ/ES/Seata：按需启用（建议后置）</li></ul><p>下面步骤直接可执行，按顺序来。</p><h3 id="1-安装-Docker-Compose（以-Ubuntu-20-04-22-04-为例）">1) 安装 Docker &amp; Compose（以 Ubuntu 20.04/22.04 为例）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1) 基础依赖</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get update -y</span><br><span class="line"><span class="built_in">sudo</span> apt-get install -y ca-certificates curl gnupg lsb-release</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) Docker 仓库</span></span><br><span class="line"><span class="built_in">sudo</span> install -m 0755 -d /etc/apt/keyrings</span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg \</span><br><span class="line"> | <span class="built_in">sudo</span> gpg --dearmor -o /etc/apt/keyrings/docker.gpg</span><br><span class="line"><span class="built_in">echo</span> \</span><br><span class="line">  <span class="string">&quot;deb [arch=<span class="subst">$(dpkg --print-architecture)</span> signed-by=/etc/apt/keyrings/docker.gpg] \</span></span><br><span class="line"><span class="string">  https://download.docker.com/linux/ubuntu <span class="subst">$(lsb_release -cs)</span> stable&quot;</span> \</span><br><span class="line"> | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line"><span class="built_in">sudo</span> apt-get update -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3) 安装</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4) 免 sudo（重新登录生效）</span></span><br><span class="line"><span class="built_in">sudo</span> usermod -aG docker <span class="variable">$USER</span></span><br></pre></td></tr></table></figure><h3 id="2-目录结构与时区">2) 目录结构与时区</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /opt/easylive/&#123;mysql/data,mysql/init,redis,data,nacos,data,minio/data,nginx/conf.d,frontend/&#123;web,admin&#125;,logs&#125;</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /opt/easylive/&#123;gateway,admin,web,interact,resource&#125;/config</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /opt/easylive/&#123;rocketmq/&#123;namesrv,broker&#125;,es/data,seata&#125;</span><br><span class="line"><span class="built_in">sudo</span> timedatectl set-timezone Asia/Shanghai</span><br></pre></td></tr></table></figure><h3 id="3-env（放到-opt-easylive-env）">3) .env（放到 /opt/easylive/.env）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">TZ=Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="comment"># MySQL</span></span><br><span class="line">MYSQL_ROOT_PASSWORD=YourStrongRootPass!</span><br><span class="line">MYSQL_DATABASE=easylive</span><br><span class="line"></span><br><span class="line"><span class="comment"># Nacos</span></span><br><span class="line">NACOS_VERSION=v2.2.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># Minio</span></span><br><span class="line">MINIO_ROOT_USER=admin</span><br><span class="line">MINIO_ROOT_PASSWORD=YourStrongMinioPass!</span><br><span class="line"></span><br><span class="line"><span class="comment"># Java 内存建议（4G 机器尽量克制）</span></span><br><span class="line">JAVA_XMS=256m</span><br><span class="line">JAVA_XMX=512m</span><br></pre></td></tr></table></figure><h3 id="4-docker-compose-yml（放到-opt-easylive-docker-compose-yml）">4) docker-compose.yml（放到 /opt/easylive/docker-compose.yml）</h3><p>为节省内存，RocketMQ/ES/Seata 先注释，核心链路先跑通。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.9&quot;</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">easylive</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">easylive-net:</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">mysql-data:</span></span><br><span class="line">  <span class="attr">redis-data:</span></span><br><span class="line">  <span class="attr">nacos-data:</span></span><br><span class="line">  <span class="attr">minio-data:</span></span><br><span class="line">  <span class="attr">es-data:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--default-authentication-plugin=mysql_native_password</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--character-set-server=utf8mb4</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--collation-server=utf8mb4_unicode_ci</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_ROOT_PASSWORD=$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_DATABASE=$&#123;MYSQL_DATABASE&#125;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3306:3306&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql-data:/var/lib/mysql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./mysql/init:/docker-entrypoint-initdb.d</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD-SHELL&quot;</span>,<span class="string">&quot;mysqladmin ping -uroot -p$&#123;MYSQL_ROOT_PASSWORD&#125; | grep &#x27;mysqld is alive&#x27;&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:6.2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">command:</span> [ <span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;--appendonly&quot;</span>, <span class="string">&quot;yes&quot;</span> ]</span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-data:/data</span></span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">nacos:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nacos/nacos-server:$&#123;NACOS_VERSION&#125;</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MODE=standalone</span></span><br><span class="line">      <span class="comment"># 使用 MySQL 做持久化（推荐）</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PLATFORM=mysql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_SERVICE_HOST=mysql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_SERVICE_DB_NAME=nacos_config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_SERVICE_PORT=3306</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_SERVICE_USER=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_SERVICE_PASSWORD=$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="comment"># JVM 缩小</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JVM_XMS=256m</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JVM_XMX=512m</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JVM_XMN=256m</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="attr">mysql:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">service_healthy</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8848:8848&quot;</span></span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">minio:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">minio/minio:RELEASE.2024-09-13T20-26-02Z</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">minio</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MINIO_ROOT_USER=$&#123;MINIO_ROOT_USER&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MINIO_ROOT_PASSWORD=$&#123;MINIO_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">server</span> <span class="string">/data</span> <span class="string">--console-address</span> <span class="string">&quot;:9001&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">minio-data:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9000:9000&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9001:9001&quot;</span></span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 如无强依赖，先不启动下列服务，稳定后再启用</span></span><br><span class="line">  <span class="comment"># rocketmq-namesrv:</span></span><br><span class="line">  <span class="comment">#   image: apache/rocketmq:5.2.0</span></span><br><span class="line">  <span class="comment">#   container_name: rmq-namesrv</span></span><br><span class="line">  <span class="comment">#   ports: [&quot;9876:9876&quot;]</span></span><br><span class="line">  <span class="comment">#   environment:</span></span><br><span class="line">  <span class="comment">#     - TZ=$&#123;TZ&#125;</span></span><br><span class="line">  <span class="comment">#     - JAVA_OPT_EXT=-Xms256m -Xmx512m</span></span><br><span class="line">  <span class="comment">#   networks: [easylive-net]</span></span><br><span class="line">  <span class="comment">#   restart: always</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># rocketmq-broker:</span></span><br><span class="line">  <span class="comment">#   image: apache/rocketmq:5.2.0</span></span><br><span class="line">  <span class="comment">#   container_name: rmq-broker</span></span><br><span class="line">  <span class="comment">#   environment:</span></span><br><span class="line">  <span class="comment">#     - NAMESRV_ADDR=rmq-namesrv:9876</span></span><br><span class="line">  <span class="comment">#     - TZ=$&#123;TZ&#125;</span></span><br><span class="line">  <span class="comment">#     - JAVA_OPT_EXT=-Xms256m -Xmx512m</span></span><br><span class="line">  <span class="comment">#   depends_on: [rocketmq-namesrv]</span></span><br><span class="line">  <span class="comment">#   ports: [&quot;10911:10911&quot;,&quot;10909:10909&quot;,&quot;10912:10912&quot;]</span></span><br><span class="line">  <span class="comment">#   networks: [easylive-net]</span></span><br><span class="line">  <span class="comment">#   restart: always</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># es:</span></span><br><span class="line">  <span class="comment">#   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.22</span></span><br><span class="line">  <span class="comment">#   container_name: es</span></span><br><span class="line">  <span class="comment">#   environment:</span></span><br><span class="line">  <span class="comment">#     - discovery.type=single-node</span></span><br><span class="line">  <span class="comment">#     - xpack.security.enabled=false</span></span><br><span class="line">  <span class="comment">#     - ES_JAVA_OPTS=-Xms512m -Xmx512m</span></span><br><span class="line">  <span class="comment">#     - TZ=$&#123;TZ&#125;</span></span><br><span class="line">  <span class="comment">#   ulimits:</span></span><br><span class="line">  <span class="comment">#     memlock:</span></span><br><span class="line">  <span class="comment">#       soft: -1</span></span><br><span class="line">  <span class="comment">#       hard: -1</span></span><br><span class="line">  <span class="comment">#   ports:</span></span><br><span class="line">  <span class="comment">#     - &quot;9201:9200&quot;</span></span><br><span class="line">  <span class="comment">#   volumes:</span></span><br><span class="line">  <span class="comment">#     - es-data:/usr/share/elasticsearch/data</span></span><br><span class="line">  <span class="comment">#   networks: [easylive-net]</span></span><br><span class="line">  <span class="comment">#   restart: always</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># seata:</span></span><br><span class="line">  <span class="comment">#   image: seataio/seata-server:1.6.1</span></span><br><span class="line">  <span class="comment">#   container_name: seata</span></span><br><span class="line">  <span class="comment">#   environment:</span></span><br><span class="line">  <span class="comment">#     - SEATA_PORT=7091</span></span><br><span class="line">  <span class="comment">#     - TZ=$&#123;TZ&#125;</span></span><br><span class="line">  <span class="comment">#   ports: [&quot;7091:7091&quot;]</span></span><br><span class="line">  <span class="comment">#   networks: [easylive-net]</span></span><br><span class="line">  <span class="comment">#   restart: always</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ------------------ 应用服务 ------------------</span></span><br><span class="line">  <span class="attr">gateway:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">easylive-cloud-gateway:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">gateway</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVER_PORT=7071</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=dev</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848</span></span><br><span class="line">    <span class="attr">depends_on:</span> [<span class="string">nacos</span>]</span><br><span class="line">    <span class="attr">ports:</span> [<span class="string">&quot;7071:7071&quot;</span>]</span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">admin:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">easylive-cloud-admin:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVER_PORT=7070</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=dev</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="comment"># 覆盖数据库与 Redis（如 Nacos 未配置完整）</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/easylive?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_USERNAME=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PASSWORD=$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_HOST=redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_PORT=6379</span></span><br><span class="line">    <span class="attr">depends_on:</span> [<span class="string">mysql</span>, <span class="string">redis</span>, <span class="string">nacos</span>]</span><br><span class="line">    <span class="attr">ports:</span> [<span class="string">&quot;7070:7070&quot;</span>]</span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">easylive-cloud-web:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVER_PORT=7072</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=dev</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/easylive?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_USERNAME=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PASSWORD=$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_HOST=redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_PORT=6379</span></span><br><span class="line">    <span class="attr">depends_on:</span> [<span class="string">mysql</span>, <span class="string">redis</span>, <span class="string">nacos</span>]</span><br><span class="line">    <span class="attr">ports:</span> [<span class="string">&quot;7072:7072&quot;</span>]</span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">interact:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">easylive-cloud-interact:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">interact</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVER_PORT=7073</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=dev</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/easylive?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_USERNAME=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PASSWORD=$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_HOST=redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_PORT=6379</span></span><br><span class="line">    <span class="attr">depends_on:</span> [<span class="string">mysql</span>, <span class="string">redis</span>, <span class="string">nacos</span>]</span><br><span class="line">    <span class="attr">ports:</span> [<span class="string">&quot;7073:7073&quot;</span>]</span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">resource:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">easylive-cloud-resource:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">resource</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVER_PORT=7074</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=dev</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/easylive?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_USERNAME=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PASSWORD=$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_HOST=redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_PORT=6379</span></span><br><span class="line">      <span class="comment"># 如资源服务用到 Minio，请在 Nacos 配置或此处补充访问参数</span></span><br><span class="line">      <span class="comment"># - MINIO_ENDPOINT=http://minio:9000</span></span><br><span class="line">      <span class="comment"># - MINIO_ACCESS_KEY=$&#123;MINIO_ROOT_USER&#125;</span></span><br><span class="line">      <span class="comment"># - MINIO_SECRET_KEY=$&#123;MINIO_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="comment"># - MINIO_BUCKET=your-bucket</span></span><br><span class="line">    <span class="attr">depends_on:</span> [<span class="string">mysql</span>, <span class="string">redis</span>, <span class="string">nacos</span>, <span class="string">minio</span>]</span><br><span class="line">    <span class="attr">ports:</span> [<span class="string">&quot;7074:7074&quot;</span>]</span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.25</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">depends_on:</span> [<span class="string">gateway</span>]</span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx/conf.d:/etc/nginx/conf.d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./frontend/web:/usr/share/nginx/html</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./frontend/admin:/usr/share/nginx/html/admin</span></span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br></pre></td></tr></table></figure><h3 id="5-后端服务镜像构建">5) 后端服务镜像构建</h3><p>建议每个服务放一个最简 Dockerfile（以 <code>easylive-cloud-gateway</code> 为例）：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 放在 easylive-server/easylive-cloud/easylive-cloud-gateway/Dockerfile</span></span><br><span class="line"><span class="keyword">FROM</span> eclipse-temurin:<span class="number">8</span>-jre</span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> target/*.jar app.jar</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">7071</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>,<span class="string">&quot;-Xms<span class="variable">$&#123;JAVA_XMS:-256m&#125;</span>&quot;</span>,<span class="string">&quot;-Xmx<span class="variable">$&#123;JAVA_XMX:-512m&#125;</span>&quot;</span>,<span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;/app/app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>构建步骤（在你的仓库根目录执行；其他四个服务同理更换路径与镜像名/端口）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打包全部（跳过测试）</span></span><br><span class="line"><span class="built_in">cd</span> /path/to/easylive-springcloud/easylive-server</span><br><span class="line">./mvnw -v || mvn -v</span><br><span class="line">mvn -DskipTests clean package</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建镜像（五个服务）</span></span><br><span class="line">docker build -t easylive-cloud-gateway:latest \</span><br><span class="line">  easylive-cloud/easylive-cloud-gateway</span><br><span class="line"></span><br><span class="line">docker build -t easylive-cloud-admin:latest \</span><br><span class="line">  easylive-cloud/easylive-cloud-admin</span><br><span class="line"></span><br><span class="line">docker build -t easylive-cloud-web:latest \</span><br><span class="line">  easylive-cloud/easylive-cloud-web</span><br><span class="line"></span><br><span class="line">docker build -t easylive-cloud-interact:latest \</span><br><span class="line">  easylive-cloud/easylive-cloud-interact</span><br><span class="line"></span><br><span class="line">docker build -t easylive-cloud-resource:latest \</span><br><span class="line">  easylive-cloud/easylive-cloud-resource</span><br></pre></td></tr></table></figure><p>注意：</p><ul><li>端口通过 <code>SERVER_PORT</code> 覆盖为 7071/7070/7072/7073/7074，跟你的表一致。</li><li>Nacos 地址在容器间为 <code>nacos:8848</code>（已在 compose 中用环境变量覆盖）。</li><li>数据库/Redis 在容器间为 <code>mysql:3306</code>、<code>redis:6379</code>。</li></ul><h3 id="6-Nginx-反代与前端">6) Nginx 反代与前端</h3><p><code>/opt/easylive/nginx/conf.d/easylive.conf</code>：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">server_name</span> _;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 用户端 Web 静态</span></span><br><span class="line">  <span class="attribute">root</span> /usr/share/nginx/html;</span><br><span class="line">  <span class="attribute">index</span> index.html;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 管理端静态（访问 /admin/）</span></span><br><span class="line">  <span class="section">location</span> /admin/ &#123;</span><br><span class="line">    <span class="attribute">alias</span> /usr/share/nginx/html/admin/;</span><br><span class="line">    <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /admin/index.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 反向代理到网关（和 gateway 的路由保持一致）</span></span><br><span class="line">  <span class="section">location</span> /web/       &#123; <span class="attribute">proxy_pass</span> http://gateway:7071/web/; &#125;</span><br><span class="line">  <span class="section">location</span> /interact/  &#123; <span class="attribute">proxy_pass</span> http://gateway:7071/interact/; &#125;</span><br><span class="line">  <span class="section">location</span> /user/      &#123; <span class="attribute">proxy_pass</span> http://gateway:7071/user/; &#125;</span><br><span class="line">  <span class="section">location</span> /file/      &#123; <span class="attribute">proxy_pass</span> http://gateway:7071/file/; &#125;</span><br><span class="line">  <span class="section">location</span> /adminapi/  &#123; <span class="attribute">proxy_pass</span> http://gateway:7071/admin/; &#125; <span class="comment"># 避免静态路径冲突，给管理端 API 换前缀</span></span><br><span class="line"></span><br><span class="line">  <span class="attribute">proxy_set_header</span> Host              <span class="variable">$host</span>;</span><br><span class="line">  <span class="attribute">proxy_set_header</span> X-Real-IP         <span class="variable">$remote_addr</span>;</span><br><span class="line">  <span class="attribute">proxy_set_header</span> X-Forwarded-For   <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">  <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>构建前端并拷贝静态资源：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用户端</span></span><br><span class="line"><span class="built_in">cd</span> /path/to/easylive-springcloud/easylive-front/easylive-front-web</span><br><span class="line">npm ci || npm install</span><br><span class="line">npm run build</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> -r dist/* /opt/easylive/frontend/web/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 管理端</span></span><br><span class="line"><span class="built_in">cd</span> /path/to/easylive-springcloud/easylive-front/easylive-front-admin</span><br><span class="line">npm ci || npm install</span><br><span class="line">npm run build</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /opt/easylive/frontend/admin</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> -r dist/* /opt/easylive/frontend/admin/</span><br></pre></td></tr></table></figure><p>如前端请求网关的基地址可配置，建议改为相对路径并按上面 Nginx 反代规则访问。</p><h3 id="7-Minio-初始化（可选）">7) Minio 初始化（可选）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run --<span class="built_in">rm</span> --network easylive_easylive-net -it \</span><br><span class="line">  minio/mc sh -c <span class="string">&quot;</span></span><br><span class="line"><span class="string">mc alias set minio http://minio:9000 <span class="variable">$&#123;MINIO_ROOT_USER&#125;</span> <span class="variable">$&#123;MINIO_ROOT_PASSWORD&#125;</span> &amp;&amp; \</span></span><br><span class="line"><span class="string">mc mb -p minio/easylive &amp;&amp; \</span></span><br><span class="line"><span class="string">mc anonymous set download minio/easylive&quot;</span></span><br></pre></td></tr></table></figure><h3 id="8-Nacos-配置">8) Nacos 配置</h3><ul><li>访问 <code>http://服务器IP:8848/nacos</code>，默认无鉴权或按镜像默认设置。</li><li>为每个服务新增配置：<ul><li><code>easylive-cloud-admin-dev.yml</code></li><li><code>easylive-cloud-web-dev.yml</code></li><li><code>easylive-cloud-interact-dev.yml</code></li><li><code>easylive-cloud-resource-dev.yml</code></li><li>内容至少包含数据库与 Redis 连接（参考你仓库中 dev yml，将 host 从 127.0.0.1 改为 <code>mysql</code>、<code>redis</code>）：</li></ul></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://mysql:3306/easylive?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure><ul><li>资源服务若使用 Minio，请在对应 yml 增加 Minio 配置项（按你项目属性命名），指向 <code>http://minio:9000</code>。</li></ul><h3 id="9-启动与验证">9) 启动与验证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/easylive</span><br><span class="line">docker compose pull   <span class="comment"># 第一次可忽略</span></span><br><span class="line">docker compose up -d  <span class="comment"># 启动</span></span><br><span class="line">docker compose ps     <span class="comment"># 查看状态</span></span><br><span class="line">docker logs -f gateway</span><br><span class="line">docker logs -f admin</span><br><span class="line">docker logs -f web</span><br><span class="line">docker logs -f interact</span><br><span class="line">docker logs -f resource</span><br></pre></td></tr></table></figure><ul><li>浏览器访问：<ul><li>Nacos: <code>http://服务器IP:8848/nacos</code></li><li>Minio: <code>http://服务器IP:9001</code></li><li>前端: <code>http://服务器IP/</code>（用户端）与 <code>http://服务器IP/admin/</code>（管理端）</li></ul></li><li>后端连通性：网关 <code>http://服务器IP:7071</code> 下的 <code>/web/**</code>、<code>/interact/**</code>、<code>/user/**</code>、<code>/file/**</code>、<code>/admin/**</code>。</li></ul><h3 id="10-域名与-HTTPS（可选快速）">10) 域名与 HTTPS（可选快速）</h3><ul><li>用 Nginx + Certbot：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install -y certbot python3-certbot-nginx</span><br><span class="line"><span class="built_in">sudo</span> certbot --nginx -d your.domain.com -m your@email \</span><br><span class="line">  --agree-tos --no-eff-email --redirect</span><br></pre></td></tr></table></figure><ul><li>或用 Caddy（更简单，自动签发）：将 Nginx 换成 <code>caddy:2</code>，用 Caddyfile 一行反代网关和静态。</li></ul><h3 id="11-常见资源与优化建议">11) 常见资源与优化建议</h3><ul><li>4G 机器内存紧张：先不上 RocketMQ/ES/Seata，JVM 堆保持 <code>-Xms256m -Xmx512m</code>；Nacos JVM 也已收敛。</li><li>MySQL/ES/Minio 数据请使用卷持久化（compose 已配置）。</li><li>日志落盘到容器 stdout，建议再配 ELK/Vector 后续接入。</li></ul><p>你现在可以按以上顺序执行；如果遇到端口/内存/配置问题，发我报错我继续帮你排查。</p><ul><li>我已经完成部署方案选择与全部步骤指引，包含 <code>.env</code>、<code>docker-compose.yml</code>、后端 Dockerfile、Nginx 反代与初始化要点。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 1) 基础依赖</span><br><span class="line">sudo apt-get update -y</span><br><span class="line">sudo apt-get install -y ca-certificates curl gnupg lsb-release</span><br><span class="line"></span><br><span class="line"># 2) Docker 仓库</span><br><span class="line">sudo install -m 0755 -d /etc/apt/keyrings</span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg \</span><br><span class="line"> | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg</span><br><span class="line">echo \</span><br><span class="line">  &quot;deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \</span><br><span class="line">  https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&quot; \</span><br><span class="line"> | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line">sudo apt-get update -y</span><br><span class="line"></span><br><span class="line"># 3) 安装</span><br><span class="line">sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br><span class="line"></span><br><span class="line"># 4) 免 sudo（重新登录生效）</span><br><span class="line">sudo usermod -aG docker $USER</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /opt/easylive/&#123;mysql/data,mysql/init,redis,data,nacos,data,minio/data,nginx/conf.d,frontend/&#123;web,admin&#125;,logs&#125;</span><br><span class="line">sudo mkdir -p /opt/easylive/&#123;gateway,admin,web,interact,resource&#125;/config</span><br><span class="line">sudo mkdir -p /opt/easylive/&#123;rocketmq/&#123;namesrv,broker&#125;,es/data,seata&#125;</span><br><span class="line">sudo timedatectl set-timezone Asia/Shanghai</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">TZ=Asia/Shanghai</span><br><span class="line"></span><br><span class="line"># MySQL</span><br><span class="line">MYSQL_ROOT_PASSWORD=YourStrongRootPass!</span><br><span class="line">MYSQL_DATABASE=easylive</span><br><span class="line"></span><br><span class="line"># Nacos</span><br><span class="line">NACOS_VERSION=v2.2.0</span><br><span class="line"></span><br><span class="line"># Minio</span><br><span class="line">MINIO_ROOT_USER=admin</span><br><span class="line">MINIO_ROOT_PASSWORD=YourStrongMinioPass!</span><br><span class="line"></span><br><span class="line"># Java 内存建议（4G 机器尽量克制）</span><br><span class="line">JAVA_XMS=256m</span><br><span class="line">JAVA_XMX=512m</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.9&quot;</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">easylive</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">easylive-net:</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">mysql-data:</span></span><br><span class="line">  <span class="attr">redis-data:</span></span><br><span class="line">  <span class="attr">nacos-data:</span></span><br><span class="line">  <span class="attr">minio-data:</span></span><br><span class="line">  <span class="attr">es-data:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--default-authentication-plugin=mysql_native_password</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--character-set-server=utf8mb4</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--collation-server=utf8mb4_unicode_ci</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_ROOT_PASSWORD=$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_DATABASE=$&#123;MYSQL_DATABASE&#125;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3306:3306&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql-data:/var/lib/mysql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./mysql/init:/docker-entrypoint-initdb.d</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD-SHELL&quot;</span>,<span class="string">&quot;mysqladmin ping -uroot -p$&#123;MYSQL_ROOT_PASSWORD&#125; | grep &#x27;mysqld is alive&#x27;&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:6.2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">command:</span> [ <span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;--appendonly&quot;</span>, <span class="string">&quot;yes&quot;</span> ]</span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-data:/data</span></span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">nacos:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nacos/nacos-server:$&#123;NACOS_VERSION&#125;</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MODE=standalone</span></span><br><span class="line">      <span class="comment"># 使用 MySQL 做持久化（推荐）</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PLATFORM=mysql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_SERVICE_HOST=mysql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_SERVICE_DB_NAME=nacos_config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_SERVICE_PORT=3306</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_SERVICE_USER=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_SERVICE_PASSWORD=$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="comment"># JVM 缩小</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JVM_XMS=256m</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JVM_XMX=512m</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JVM_XMN=256m</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="attr">mysql:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">service_healthy</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8848:8848&quot;</span></span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">minio:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">minio/minio:RELEASE.2024-09-13T20-26-02Z</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">minio</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MINIO_ROOT_USER=$&#123;MINIO_ROOT_USER&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MINIO_ROOT_PASSWORD=$&#123;MINIO_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">server</span> <span class="string">/data</span> <span class="string">--console-address</span> <span class="string">&quot;:9001&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">minio-data:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9000:9000&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9001:9001&quot;</span></span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 如无强依赖，先不启动下列服务，稳定后再启用</span></span><br><span class="line">  <span class="comment"># rocketmq-namesrv:</span></span><br><span class="line">  <span class="comment">#   image: apache/rocketmq:5.2.0</span></span><br><span class="line">  <span class="comment">#   container_name: rmq-namesrv</span></span><br><span class="line">  <span class="comment">#   ports: [&quot;9876:9876&quot;]</span></span><br><span class="line">  <span class="comment">#   environment:</span></span><br><span class="line">  <span class="comment">#     - TZ=$&#123;TZ&#125;</span></span><br><span class="line">  <span class="comment">#     - JAVA_OPT_EXT=-Xms256m -Xmx512m</span></span><br><span class="line">  <span class="comment">#   networks: [easylive-net]</span></span><br><span class="line">  <span class="comment">#   restart: always</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># rocketmq-broker:</span></span><br><span class="line">  <span class="comment">#   image: apache/rocketmq:5.2.0</span></span><br><span class="line">  <span class="comment">#   container_name: rmq-broker</span></span><br><span class="line">  <span class="comment">#   environment:</span></span><br><span class="line">  <span class="comment">#     - NAMESRV_ADDR=rmq-namesrv:9876</span></span><br><span class="line">  <span class="comment">#     - TZ=$&#123;TZ&#125;</span></span><br><span class="line">  <span class="comment">#     - JAVA_OPT_EXT=-Xms256m -Xmx512m</span></span><br><span class="line">  <span class="comment">#   depends_on: [rocketmq-namesrv]</span></span><br><span class="line">  <span class="comment">#   ports: [&quot;10911:10911&quot;,&quot;10909:10909&quot;,&quot;10912:10912&quot;]</span></span><br><span class="line">  <span class="comment">#   networks: [easylive-net]</span></span><br><span class="line">  <span class="comment">#   restart: always</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># es:</span></span><br><span class="line">  <span class="comment">#   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.22</span></span><br><span class="line">  <span class="comment">#   container_name: es</span></span><br><span class="line">  <span class="comment">#   environment:</span></span><br><span class="line">  <span class="comment">#     - discovery.type=single-node</span></span><br><span class="line">  <span class="comment">#     - xpack.security.enabled=false</span></span><br><span class="line">  <span class="comment">#     - ES_JAVA_OPTS=-Xms512m -Xmx512m</span></span><br><span class="line">  <span class="comment">#     - TZ=$&#123;TZ&#125;</span></span><br><span class="line">  <span class="comment">#   ulimits:</span></span><br><span class="line">  <span class="comment">#     memlock:</span></span><br><span class="line">  <span class="comment">#       soft: -1</span></span><br><span class="line">  <span class="comment">#       hard: -1</span></span><br><span class="line">  <span class="comment">#   ports:</span></span><br><span class="line">  <span class="comment">#     - &quot;9201:9200&quot;</span></span><br><span class="line">  <span class="comment">#   volumes:</span></span><br><span class="line">  <span class="comment">#     - es-data:/usr/share/elasticsearch/data</span></span><br><span class="line">  <span class="comment">#   networks: [easylive-net]</span></span><br><span class="line">  <span class="comment">#   restart: always</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># seata:</span></span><br><span class="line">  <span class="comment">#   image: seataio/seata-server:1.6.1</span></span><br><span class="line">  <span class="comment">#   container_name: seata</span></span><br><span class="line">  <span class="comment">#   environment:</span></span><br><span class="line">  <span class="comment">#     - SEATA_PORT=7091</span></span><br><span class="line">  <span class="comment">#     - TZ=$&#123;TZ&#125;</span></span><br><span class="line">  <span class="comment">#   ports: [&quot;7091:7091&quot;]</span></span><br><span class="line">  <span class="comment">#   networks: [easylive-net]</span></span><br><span class="line">  <span class="comment">#   restart: always</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ------------------ 应用服务 ------------------</span></span><br><span class="line">  <span class="attr">gateway:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">easylive-cloud-gateway:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">gateway</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVER_PORT=7071</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=dev</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848</span></span><br><span class="line">    <span class="attr">depends_on:</span> [<span class="string">nacos</span>]</span><br><span class="line">    <span class="attr">ports:</span> [<span class="string">&quot;7071:7071&quot;</span>]</span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">admin:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">easylive-cloud-admin:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVER_PORT=7070</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=dev</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="comment"># 覆盖数据库与 Redis（如 Nacos 未配置完整）</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/easylive?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_USERNAME=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PASSWORD=$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_HOST=redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_PORT=6379</span></span><br><span class="line">    <span class="attr">depends_on:</span> [<span class="string">mysql</span>, <span class="string">redis</span>, <span class="string">nacos</span>]</span><br><span class="line">    <span class="attr">ports:</span> [<span class="string">&quot;7070:7070&quot;</span>]</span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">easylive-cloud-web:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVER_PORT=7072</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=dev</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/easylive?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_USERNAME=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PASSWORD=$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_HOST=redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_PORT=6379</span></span><br><span class="line">    <span class="attr">depends_on:</span> [<span class="string">mysql</span>, <span class="string">redis</span>, <span class="string">nacos</span>]</span><br><span class="line">    <span class="attr">ports:</span> [<span class="string">&quot;7072:7072&quot;</span>]</span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">interact:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">easylive-cloud-interact:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">interact</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVER_PORT=7073</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=dev</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/easylive?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_USERNAME=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PASSWORD=$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_HOST=redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_PORT=6379</span></span><br><span class="line">    <span class="attr">depends_on:</span> [<span class="string">mysql</span>, <span class="string">redis</span>, <span class="string">nacos</span>]</span><br><span class="line">    <span class="attr">ports:</span> [<span class="string">&quot;7073:7073&quot;</span>]</span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">resource:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">easylive-cloud-resource:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">resource</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVER_PORT=7074</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=dev</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/easylive?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_USERNAME=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PASSWORD=$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_HOST=redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_PORT=6379</span></span><br><span class="line">      <span class="comment"># 如资源服务用到 Minio，请在 Nacos 配置或此处补充访问参数</span></span><br><span class="line">      <span class="comment"># - MINIO_ENDPOINT=http://minio:9000</span></span><br><span class="line">      <span class="comment"># - MINIO_ACCESS_KEY=$&#123;MINIO_ROOT_USER&#125;</span></span><br><span class="line">      <span class="comment"># - MINIO_SECRET_KEY=$&#123;MINIO_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="comment"># - MINIO_BUCKET=your-bucket</span></span><br><span class="line">    <span class="attr">depends_on:</span> [<span class="string">mysql</span>, <span class="string">redis</span>, <span class="string">nacos</span>, <span class="string">minio</span>]</span><br><span class="line">    <span class="attr">ports:</span> [<span class="string">&quot;7074:7074&quot;</span>]</span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.25</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">depends_on:</span> [<span class="string">gateway</span>]</span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx/conf.d:/etc/nginx/conf.d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./frontend/web:/usr/share/nginx/html</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./frontend/admin:/usr/share/nginx/html/admin</span></span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br></pre></td></tr></table></figure><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 放在 easylive-server/easylive-cloud/easylive-cloud-gateway/Dockerfile</span></span><br><span class="line"><span class="keyword">FROM</span> eclipse-temurin:<span class="number">8</span>-jre</span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> target/*.jar app.jar</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">7071</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>,<span class="string">&quot;-Xms<span class="variable">$&#123;JAVA_XMS:-256m&#125;</span>&quot;</span>,<span class="string">&quot;-Xmx<span class="variable">$&#123;JAVA_XMX:-512m&#125;</span>&quot;</span>,<span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;/app/app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 打包全部（跳过测试）</span><br><span class="line">cd /path/to/easylive-springcloud/easylive-server</span><br><span class="line">./mvnw -v || mvn -v</span><br><span class="line">mvn -DskipTests clean package</span><br><span class="line"></span><br><span class="line"># 构建镜像（五个服务）</span><br><span class="line">docker build -t easylive-cloud-gateway:latest \</span><br><span class="line">  easylive-cloud/easylive-cloud-gateway</span><br><span class="line"></span><br><span class="line">docker build -t easylive-cloud-admin:latest \</span><br><span class="line">  easylive-cloud/easylive-cloud-admin</span><br><span class="line"></span><br><span class="line">docker build -t easylive-cloud-web:latest \</span><br><span class="line">  easylive-cloud/easylive-cloud-web</span><br><span class="line"></span><br><span class="line">docker build -t easylive-cloud-interact:latest \</span><br><span class="line">  easylive-cloud/easylive-cloud-interact</span><br><span class="line"></span><br><span class="line">docker build -t easylive-cloud-resource:latest \</span><br><span class="line">  easylive-cloud/easylive-cloud-resource</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name _;</span><br><span class="line"></span><br><span class="line">  # 用户端 Web 静态</span><br><span class="line">  root /usr/share/nginx/html;</span><br><span class="line">  index index.html;</span><br><span class="line"></span><br><span class="line">  # 管理端静态（访问 /admin/）</span><br><span class="line">  location /admin/ &#123;</span><br><span class="line">    alias /usr/share/nginx/html/admin/;</span><br><span class="line">    try_files $uri $uri/ /admin/index.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # 反向代理到网关（和 gateway 的路由保持一致）</span><br><span class="line">  location /web/       &#123; proxy_pass http://gateway:7071/web/; &#125;</span><br><span class="line">  location /interact/  &#123; proxy_pass http://gateway:7071/interact/; &#125;</span><br><span class="line">  location /user/      &#123; proxy_pass http://gateway:7071/user/; &#125;</span><br><span class="line">  location /file/      &#123; proxy_pass http://gateway:7071/file/; &#125;</span><br><span class="line">  location /adminapi/  &#123; proxy_pass http://gateway:7071/admin/; &#125; # 避免静态路径冲突，给管理端 API 换前缀</span><br><span class="line"></span><br><span class="line">  proxy_set_header Host              $host;</span><br><span class="line">  proxy_set_header X-Real-IP         $remote_addr;</span><br><span class="line">  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;</span><br><span class="line">  proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 用户端</span><br><span class="line">cd /path/to/easylive-springcloud/easylive-front/easylive-front-web</span><br><span class="line">npm ci || npm install</span><br><span class="line">npm run build</span><br><span class="line">sudo cp -r dist/* /opt/easylive/frontend/web/</span><br><span class="line"></span><br><span class="line"># 管理端</span><br><span class="line">cd /path/to/easylive-springcloud/easylive-front/easylive-front-admin</span><br><span class="line">npm ci || npm install</span><br><span class="line">npm run build</span><br><span class="line">sudo mkdir -p /opt/easylive/frontend/admin</span><br><span class="line">sudo cp -r dist/* /opt/easylive/frontend/admin/</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm --network easylive_easylive-net -it \</span><br><span class="line">  minio/mc sh -c &quot;</span><br><span class="line">mc alias set minio http://minio:9000 $&#123;MINIO_ROOT_USER&#125; $&#123;MINIO_ROOT_PASSWORD&#125; &amp;&amp; \</span><br><span class="line">mc mb -p minio/easylive &amp;&amp; \</span><br><span class="line">mc anonymous set download minio/easylive&quot;</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://mysql:3306/easylive?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/easylive</span><br><span class="line">docker compose pull   # 第一次可忽略</span><br><span class="line">docker compose up -d  # 启动</span><br><span class="line">docker compose ps     # 查看状态</span><br><span class="line">docker logs -f gateway</span><br><span class="line">docker logs -f admin</span><br><span class="line">docker logs -f web</span><br><span class="line">docker logs -f interact</span><br><span class="line">docker logs -f resource</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y certbot python3-certbot-nginx</span><br><span class="line">sudo certbot --nginx -d your.domain.com -m your@email \</span><br><span class="line">  --agree-tos --no-eff-email --redirect</span><br></pre></td></tr></table></figure><hr><p><strong>User</strong></p><p>4核8g的服务器是否够用能把所有的环境都配上呢，保险起见我是不是应该换个4核8g的服务器</p><hr><p><strong>Cursor</strong></p><p>结论先说：</p><ul><li>4核8G基本能把全套（MySQL/Redis/Nacos/Minio/ES/RocketMQ/Seata + 5个Java服务 + 网关）跑起来，但比较“紧”，需要严格限内存与低负载场景，属于可用但不太宽裕。</li><li>若计划“全部组件长期开启 + 有一定并发”，建议至少换到4核8G；若要更稳，优先把 ES 或 RocketMQ 单独拆机，或直接上更高规格（如8核16G）。</li></ul><p>快速内存预算（保守建议，单位≈GiB）：</p><ul><li>Nacos: 0.5</li><li>MySQL: 0.5–1.0（取决于 innodb_buffer_pool_size）</li><li>Redis: 0.1–0.3</li><li>Minio: 0.3–0.5</li><li>RocketMQ: 0.8–1.2（namesrv 0.3–0.5，broker 0.5–0.7）</li><li>Elasticsearch: 1.0–2.0（堆1–2G，且需 vm.max_map_count）</li><li>Seata: 0.3–0.5</li><li>5个SpringBoot服务: 1.3–2.5（每个 256–512M）</li><li>合计：约 5.3–8.5G（随设置和负载浮动）<br>=&gt; 4核8G在“全部开启”时边缘可用，需非常克制的JVM与DB配置。</li></ul><p>给你两种选择：</p><ul><li>想省事稳一点：换成4核8G（或更高），然后严格控内存即可全开；更理想是把 ES 或 RocketMQ 独立出去。</li><li>先不换服务器：保留4核4G/8G，只启核心链路（MySQL/Redis/Nacos/Minio/网关+业务服务），把 ES/RocketMQ/Seata 暂时关闭或托管到云上，等业务量起来再扩。</li></ul><p>若坚持在4核8G全开运行，务必：</p><ul><li>JVM：所有Java进程统一 -Xms256m -Xmx512m（Nacos、各微服务、Seata、RocketMQ），ES 堆设 1G 起步。</li><li>MySQL：innodb_buffer_pool_size 512M 起；慢慢再调大。</li><li>开启2–4G swap 兜底（仅兜底，不可依赖）。</li><li>用 docker-compose 限制每个容器内存并监控 docker stats。</li><li>优先上线无强依赖的路径；ES/RocketMQ 负载上来后优先拆分或升配。</li></ul><p>简短建议：</p><ul><li>如果你希望“一台机全家桶 + 可留有余量”，我建议换到4核8G（更稳）或把 ES/RocketMQ 外置/托管。</li><li>如果是演示/低QPS场景，4核8G可行；4核4G就建议按我给的最小化编排先跑核心链路。</li></ul>]]></content>
    
    
    <summary type="html">微服务项目GQ Video项目部署</summary>
    
    
    
    <category term="项目相关" scheme="https://itgeqian.github.io/categories/%E9%A1%B9%E7%9B%AE%E7%9B%B8%E5%85%B3/"/>
    
    
    <category term="项目部署" scheme="https://itgeqian.github.io/tags/%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2/"/>
    
    <category term="GQ Video" scheme="https://itgeqian.github.io/tags/GQ-Video/"/>
    
  </entry>
  
  <entry>
    <title>Docker Desktop安装到D盘</title>
    <link href="https://itgeqian.github.io/posts/61.html"/>
    <id>https://itgeqian.github.io/posts/61.html</id>
    <published>2025-10-02T02:09:03.000Z</published>
    <updated>2025-10-02T03:01:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>Docker默认安装路径为<code>C:\Program Files\Docker</code>。</p><p>提前准备好安装包</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-1024x597.png" alt="img"></p><p>powershell中用WSL安装</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D:<span class="string">\浏览器下载&gt;start</span> /w <span class="string">&quot;&quot;</span> <span class="string">&quot;Docker Desktop Installer.exe&quot;</span> install --backend=wsl-<span class="number">2</span> --installation-dir=D:<span class="string">\Program</span> Files<span class="string">\Docker\docker</span> --wsl-<span class="keyword">default</span>-data-root=D:<span class="string">\Program</span> Files<span class="string">\Docker\wsl</span> --accept-license</span><br></pre></td></tr></table></figure><p>安装后打开如果WSL版本过低无法运行Docker Desktop</p><ol><li>打开 <strong>PowerShell（以管理员身份）</strong>；</li><li>输入：</li></ol><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl <span class="comment">--update</span></span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-1-1024x529.png" alt="img"></p><p>若仍失败，可以尝试强制从微软服务器下载更新：</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">wsl</span> <span class="literal">--</span><span class="comment">update</span> <span class="literal">--</span><span class="comment">web</span><span class="literal">-</span><span class="comment">download</span></span><br></pre></td></tr></table></figure><p>更新完毕后，重启 Docker Desktop 即可。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/10/image-2-1024x581.png" alt="img"></p>]]></content>
    
    
    <summary type="html">Docker Desktop安装到D盘</summary>
    
    
    
    <category term="学习笔记" scheme="https://itgeqian.github.io/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="报错解决" scheme="https://itgeqian.github.io/tags/%E6%8A%A5%E9%94%99%E8%A7%A3%E5%86%B3/"/>
    
  </entry>
  
  <entry>
    <title>速通Spring AI Alibaba </title>
    <link href="https://itgeqian.github.io/posts/60.html"/>
    <id>https://itgeqian.github.io/posts/60.html</id>
    <published>2025-09-30T09:09:03.000Z</published>
    <updated>2025-10-02T12:01:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-Spring-AI-Alibaba理论概述">1.Spring AI Alibaba理论概述</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-271.png" alt="img"></p><h3 id="1-是什么">1.是什么</h3><h4 id="什么是-Spring-AI-Alibaba">什么是 Spring AI Alibaba</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-273.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-272.png" alt="img"></p><h4 id="SAA公式化一句话表达">SAA公式化一句话表达</h4><p>Spring AI Alibaba 开源项目基于 Spring AI 构建，是阿里云通义系列模型及服务在 Java AI 应用开发领域的最佳实践，提供高层次的 AI API 抽象与云原生基础设施集成方案和企业级 AI 应用生态集成。</p><h4 id="官网知识出处">官网知识出处</h4><p>SpringAI官网：<a href="https://spring.io/projects/spring-ai#learn">https://spring.io/projects/spring-ai#learn</a></p><p>Spring AI Alibaba 1.0 GA 正式发布：<a href="https://java2ai.com/">https://java2ai.com/</a></p><p><a href="https://java2ai.com/blog/spring-ai-alibaba-10-ga-release/?spm=5176.29160081.0.0.2856aa5cww2t9D">https://java2ai.com/blog/spring-ai-alibaba-10-ga-release/?spm=5176.29160081.0.0.2856aa5cww2t9D</a></p><p>阿里云百炼平台：<a href="https://bailian.console.aliyun.com/console?tab=model#/model-market">https://bailian.console.aliyun.com/console?tab=model#/model-market</a></p><h3 id="2-能干嘛">2.能干嘛</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-274-1024x286.png" alt="img"></p><p>Spring AI Alibaba 基于 Spring AI 构建，因此SAA继承了SpringAI 的所有原子能力抽象并在此<br>基础上扩充丰富了模型、向量存储、记忆、RAG 等核心组件适配，让其能够接入阿里云的 AI 生态。</p><h3 id="3-去哪下">3.去哪下</h3><p>Spring AI 官网：<a href="https://spring.io/projects/spring-ai#overview">https://spring.io/projects/spring-ai#overview</a><br>Spring AI Alibaba 官网：<a href="https://java2ai.com">https://java2ai.com</a><br>Spring AI Alibaba 仓库：<a href="https://github.com/alibaba/spring-ai-alibaba">https://github.com/alibaba/spring-ai-alibaba</a><br>Spring AI Alibaba 官方示例仓库：<a href="https://github.com/springaialibaba/spring-ai-alibaba-examples">https://github.com/springaialibaba/spring-ai-alibaba-examples</a><br>Spring AI 1.0 GA 文章：<a href="https://java2ai.com/blog/spring-ai-100-ga-released">https://java2ai.com/blog/spring-ai-100-ga-released</a><br>Spring AI 仓库：<a href="https://github.com/spring-projects/spring-ai">https://github.com/spring-projects/spring-ai</a></p><h3 id="4-怎么用">4.怎么用</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-276-1024x580.png" alt="img"></p><h3 id="5-SpringAI-VS-SpringAI-Alibaba-VS-LangChain4J">5.SpringAI VS SpringAI Alibaba VS LangChain4J</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-278.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-277.png" alt="img"></p><h2 id="2-永远的HelloWorld">2.永远的HelloWorld</h2><h3 id="1-前置约定">1.前置约定</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-279.png" alt="img"></p><h4 id="SpringAI-Alibaba-与-SpringAI、SpringBoot版本依赖关系">SpringAI Alibaba 与 SpringAI、SpringBoot版本依赖关系</h4><p><a href="https://java2ai.com/docs/1.0.0.2/faq/?spm=4347728f.6d9f13c1.0.0.17177187POpLHJ#%E6%80%8E%E4%B9%88%E7%A1%AE%E5%AE%9A-spring-ai-alibaba-%E4%B8%8E-spring-aispring-boot-%E7%89%88%E6%9C%AC%E7%9A%84%E5%85%BC%E5%AE%B9%E5%85%B3%E7%B3%BB">https://java2ai.com/docs/1.0.0.2/faq/?spm=4347728f.6d9f13c1.0.0.17177187POpLHJ#%E6%80%8E%E4%B9%88%E7%A1%AE%E5%AE%9A-spring-ai-alibaba-%E4%B8%8E-spring-aispring-boot-%E7%89%88%E6%9C%AC%E7%9A%84%E5%85%BC%E5%AE%B9%E5%85%B3%E7%B3%BB</a></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-280.png" alt="img"></p><h4 id="配置门道和关键点">配置门道和关键点</h4><p>通过后续讲解配置规则，所有调用均基于 OpenAI协议标准或者SpringAI Aalibaba官方推荐模型服务灵积(DashScope)整合规则，实现一致的接口设计与规范，确保多模型切换的便利性，提供高度可扩展的开发支持</p><h3 id="2-阿里云百炼平台入口官网">2.阿里云百炼平台入口官网</h3><h4 id="接入阿里百炼平台的通义模型">接入阿里百炼平台的通义模型</h4><p><a href="https://bailian.console.aliyun.com">https://bailian.console.aliyun.com</a></p><p>大模型调用三件套</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-281.png" alt="img"></p><p>小总结</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-282.png" alt="img"></p><h3 id="3-IDEA工具中建project父工程">3.IDEA工具中建project父工程</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-283-645x1024.png" alt="img"></p><p><a href="https://java2ai.com/docs/1.0.0.2/tutorials/starters-and-quick-guide/?spm=5176.29160081.0.0.2856aa5c0l3sEA#%E4%BD%BF%E7%94%A8-bom-%E7%AE%A1%E7%90%86%E4%BE%9D%E8%B5%96%E7%89%88%E6%9C%AC">https://java2ai.com/docs/1.0.0.2/tutorials/starters-and-quick-guide/?spm=5176.29160081.0.0.2856aa5c0l3sEA#%E4%BD%BF%E7%94%A8-bom-%E7%AE%A1%E7%90%86%E4%BE%9D%E8%B5%96%E7%89%88%E6%9C%AC</a></p><p>初始总POM</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SpringAIAlibaba-atguiguV1<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>SpringAIAlibaba-Maven父工程POM配置<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    </span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>21<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="comment">&lt;!-- Spring Boot 新建2025.9--&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>3.5.5<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="comment">&lt;!-- Spring AI 新建2025.9--&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">spring-ai.version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">spring-ai.version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="comment">&lt;!-- Spring AI Alibaba 新建2025.9--&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">SpringAIAlibaba.version</span>&gt;</span>1.0.0.2<span class="tag">&lt;/<span class="name">SpringAIAlibaba.version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="comment">&lt;!-- Spring Boot --&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;spring-boot.version&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="comment">&lt;!-- Spring AI Alibaba --&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-alibaba-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;SpringAIAlibaba.version&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="comment">&lt;!-- Spring AI --&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;spring-ai.version&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;spring-boot.version&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h4 id="1-建Module">1.建Module</h4><h4 id="2-改POM">2.改POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SpringAIAlibaba-atguiguV1<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SAA-01HelloWorld<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 引入 springai alibaba DashScope 模型适配的 Starter --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-alibaba-starter-dashscope<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--hutool--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-parameters<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="3-写YML">3.写YML</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="number">8001</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#大模型对话中文乱码UTF8编码处理</span></span><br><span class="line"><span class="attr">server.servlet.encoding.enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.force</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.charset</span>=UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.application.name</span>=SAA-<span class="number">01</span>HelloWorld</span><br><span class="line"></span><br><span class="line"><span class="comment"># ====SpringAIAlibaba Config=============</span></span><br><span class="line"><span class="attr">spring.ai.dashscope.api-key</span>=<span class="variable">$&#123;aliQwen-api&#125;</span></span><br><span class="line"><span class="attr">spring.ai.dashscope.base-url</span>=https://dashscope.aliyuncs.com/compatible-mode/v1</span><br><span class="line"><span class="attr">spring.ai.dashscope.chat.options.model</span>=qwen-plus</span><br></pre></td></tr></table></figure><h4 id="4-主启动">4.主启动</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">study</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">SpringApplication</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">autoconfigure</span>.<span class="property">SpringBootApplication</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Saa01HelloWorldApplication</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="title function_">main</span>(<span class="params"><span class="title class_">String</span>[] args</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">SpringApplication</span>.<span class="title function_">run</span>(<span class="title class_">Saa01HelloWorldApplication</span>.<span class="property">class</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-业务类">4.业务类</h3><p>ApiKey不可以明文需配置进环境变量</p><p>配置类SaaLLMConfig</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.api.DashScopeApi;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-22 0:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SaaLLMConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*方式1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    1.1</span></span><br><span class="line"><span class="comment">    yml文件配置：spring.ai.dashscope.api-key=$&#123;aliQwen-api&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    1.2</span></span><br><span class="line"><span class="comment">    @Value(&quot;$&#123;spring.ai.dashscope.api-key&#125;&quot;)</span></span><br><span class="line"><span class="comment">    private String apiKey;、</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    1.3</span></span><br><span class="line"><span class="comment">    @Bean</span></span><br><span class="line"><span class="comment">    public DashScopeApi dashScopeApi()</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        return DashScopeApi.builder().apiKey(apiKey).build();</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方式2</span></span><br><span class="line"><span class="comment">     * yml文件配置：spring.ai.dashscope.api-key=$&#123;aliQwen-api&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DashScopeApi dashScopeApi()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DashScopeApi.builder()</span><br><span class="line">                    .apiKey(System.getenv(<span class="string">&quot;aliQwen-api&quot;</span>))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>方式1：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.api.DashScopeApi;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-22 0:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SaaLLMConfig</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方式1:$&#123;&#125;</span></span><br><span class="line"><span class="comment">     * 持有yml文件配置：spring.ai.dashscope.api-key=$&#123;aliQwen-api&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value(<span class="string">&quot;<span class="subst">$&#123;spring.ai.dashscope.api-key&#125;</span>&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> String apiKey;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DashScopeApi dashScopeApi()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DashScopeApi.builder().apiKey(apiKey).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>方式2：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.api.DashScopeApi;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-22 0:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SaaLLMConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方式2:System.getenv(&quot;环境变量&quot;)</span></span><br><span class="line"><span class="comment">     * 持有yml文件配置：spring.ai.dashscope.api-key=$&#123;aliQwen-api&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DashScopeApi dashScopeApi()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DashScopeApi.builder()</span><br><span class="line">                    .apiKey(System.getenv(<span class="string">&quot;aliQwen-api&quot;</span>))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-对话模型-Chat-Model">1.对话模型(Chat Model)</h4><p>ChatModel，文本聊天交互模型</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-284.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-285.png" alt="img"></p><p><a href="https://java2ai.com/docs/1.0.0.2/tutorials/basics/chat-model/?spm=5176.29160081.0.0.2856aa5ctpxysy">https://java2ai.com/docs/1.0.0.2/tutorials/basics/chat-model/?spm=5176.29160081.0.0.2856aa5ctpxysy</a></p><h4 id="2-controller">2.controller</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-22 0:47</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatHelloController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource</span> <span class="comment">//阿里云百炼</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel dashScopeChatModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8001/hello/dochat</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/hello/dochat&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> String doChat(<span class="meta">@RequestParam(name = <span class="string">&quot;msg&quot;</span>,defaultValue = <span class="string">&quot;你是谁&quot;</span>)</span> String msg)</span><br><span class="line">    &#123;</span><br><span class="line">        String result = dashScopeChatModel.call(msg);</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">&quot;响应：&quot;</span> + result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  http://localhost:8001/hello/streamchat</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/hello/streamchat&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; streamChat(<span class="meta">@RequestParam(name = <span class="string">&quot;msg&quot;</span>,defaultValue = <span class="string">&quot;你是谁&quot;</span>)</span> String msg)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> dashScopeChatModel.stream(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-测试">3.测试</h4><p><a href="http://localhost:8001/hello/dochat">http://localhost:8001/hello/dochat</a></p><p><a href="http://localhost:8001/hello/streamchat">http://localhost:8001/hello/streamchat</a></p><h4 id="4-切换大模型">4.切换大模型</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="number">8001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server.servlet.encoding.enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.force</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.charset</span>=UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.application.name</span>=SAA-<span class="number">01</span>HelloWorld</span><br><span class="line"></span><br><span class="line"><span class="comment"># ====SpringAIAlibaba Config=============</span></span><br><span class="line"><span class="attr">spring.ai.dashscope.api-key</span>=<span class="variable">$&#123;aliQwen-api&#125;</span></span><br><span class="line"><span class="attr">spring.ai.dashscope.chat.options.model</span>=deepseek-v3</span><br></pre></td></tr></table></figure><h4 id="5-和OpenAI协议对比下">5.和OpenAI协议对比下</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-286-1024x727.png" alt="img"></p><h2 id="3-Ollama私有化部署和对接本地大模型">3.Ollama私有化部署和对接本地大模型</h2><h3 id="1-Ollama本地大模型部署">1.Ollama本地大模型部署</h3><p>略</p><h3 id="2-微服务对接本地大模型">2.微服务对接本地大模型</h3><h4 id="改POM">改POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SpringAIAlibaba-atguiguV1<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SAA-02Ollama<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--spring-ai-alibaba dashscope--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-alibaba-starter-dashscope<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--ollama--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-starter-model-ollama<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--hutool--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-parameters<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="写YML">写YML</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="number">8002</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server.servlet.encoding.enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.force</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.charset</span>=UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.application.name</span>=SAA-<span class="number">02</span>Ollama</span><br><span class="line"></span><br><span class="line"><span class="comment"># ====ollama Config=============</span></span><br><span class="line"><span class="attr">spring.ai.dashscope.api-key</span>=<span class="variable">$&#123;aliQwen-api&#125;</span></span><br><span class="line"><span class="attr">spring.ai.ollama.base-url</span>=http://localhost:<span class="number">11434</span></span><br><span class="line"><span class="attr">spring.ai.ollama.chat.model</span>=qwen2.<span class="number">5</span>:latest </span><br></pre></td></tr></table></figure><p>主启动</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">study</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">SpringApplication</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">autoconfigure</span>.<span class="property">SpringBootApplication</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> <span class="variable">zzyy</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-22 18:50</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Saa02OllamaApplication</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="title function_">main</span>(<span class="params"><span class="title class_">String</span>[] args</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">SpringApplication</span>.<span class="title function_">run</span>(<span class="title class_">Saa02OllamaApplication</span>.<span class="property">class</span>,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="业务类">业务类</h4><p>controller</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-22 18:56</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OllamaController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource(name = <span class="string">&quot;ollamaChatModel&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel chatModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8002/ollama/chat?msg=你是谁</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/ollama/chat&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> String chat(<span class="meta">@RequestParam(name = <span class="string">&quot;msg&quot;</span>)</span> String msg)</span><br><span class="line">    &#123;</span><br><span class="line">        String result = chatModel.call(msg);</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">&quot;---结果：&quot;</span> + result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/ollama/streamchat&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; streamchat(<span class="meta">@RequestParam(name = <span class="string">&quot;msg&quot;</span>,defaultValue = <span class="string">&quot;你是谁&quot;</span>)</span> String msg)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> chatModel.stream(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>或者</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-22 18:56</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OllamaController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*@Resource(name = &quot;ollamaChatModel&quot;)</span></span><br><span class="line"><span class="comment">    private ChatModel chatModel;*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//方式2</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="meta">@Qualifier(<span class="string">&quot;ollamaChatModel&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel chatModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8002/ollama/chat?msg=你是谁</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/ollama/chat&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> String chat(<span class="meta">@RequestParam(name = <span class="string">&quot;msg&quot;</span>)</span> String msg)</span><br><span class="line">    &#123;</span><br><span class="line">        String result = chatModel.call(msg);</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">&quot;---结果：&quot;</span> + result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/ollama/streamchat&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; streamchat(<span class="meta">@RequestParam(name = <span class="string">&quot;msg&quot;</span>,defaultValue = <span class="string">&quot;你是谁&quot;</span>)</span> String msg)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> chatModel.stream(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-ChatClient-VS-ChatModel">4.ChatClient VS ChatModel</h2><p>1.问题回顾：</p><p>之前的调用都是使用ChatModel进行</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-287.png" alt="img"></p><p>认识一个新的接口ChatClient</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-288.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-289.png" alt="img"></p><h3 id="1-ChatModel">1.ChatModel</h3><h4 id="官网">官网</h4><p><a href="https://java2ai.com/docs/1.0.0.2/tutorials/basics/chat-model/?spm=5176.29160081.0.0.2856aa5cmUTyXC">https://java2ai.com/docs/1.0.0.2/tutorials/basics/chat-model/?spm=5176.29160081.0.0.2856aa5cmUTyXC</a></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-290.png" alt="img"></p><h4 id="说明">说明</h4><p>对话模型(ChatModel)是底层接口，直接与具体大语言模型交互，<br>提供call()和stream()方法，<strong>适合简单大模型交互场景</strong></p><h3 id="2-ChatClient">2.ChatClient</h3><h4 id="官网-2">官网</h4><p><a href="https://java2ai.com/docs/1.0.0.2/tutorials/basics/chat-client/?spm=5176.29160081.0.0.2856aa5cmUTyXC">https://java2ai.com/docs/1.0.0.2/tutorials/basics/chat-client/?spm=5176.29160081.0.0.2856aa5cmUTyXC</a></p><p>何为样板代码？<br>ChatClient对ChatModel吐槽</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-291.png" alt="img"></p><h4 id="说明-2">说明</h4><p>ChatClient是高级封装，基于ChatModel构建，适合快速构建标准化复杂AI服务，支持同步和流式交互，集成多种高级功能。</p><h4 id="编码案例">编码案例</h4><p>改POM</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SpringAIAlibaba-atguiguV1<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SAA-03ChatModelChatClient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--spring-ai-alibaba dashscope--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-alibaba-starter-dashscope<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--hutool--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-parameters<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>写YML</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="number">8003</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server.servlet.encoding.enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.force</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.charset</span>=UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.application.name</span>=SAA-<span class="number">03</span>ChatModelChatClient</span><br><span class="line"></span><br><span class="line"><span class="comment"># ====SpringAIAlibaba Config=============</span></span><br><span class="line"><span class="attr">spring.ai.dashscope.api-key</span>=<span class="variable">$&#123;aliQwen-api&#125;</span></span><br></pre></td></tr></table></figure><p>主启动</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">study</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">SpringApplication</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">autoconfigure</span>.<span class="property">SpringBootApplication</span>;</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Saa03ChatModelChatClientApplication</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="title function_">main</span>(<span class="params"><span class="title class_">String</span>[] args</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">SpringApplication</span>.<span class="title function_">run</span>(<span class="title class_">Saa03ChatModelChatClientApplication</span>.<span class="property">class</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="业务类第1版">业务类第1版</h5><p>Only ChatModel</p><p>新建配置类 SaaLLMConfig</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.api.DashScopeApi;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-22 0:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SaaLLMConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DashScopeApi dashScopeApi()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DashScopeApi.builder().apiKey(System.getenv(<span class="string">&quot;aliQwen-api&quot;</span>)).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>controller</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.api.DashScopeApi;</span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-23 18:20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatModelController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource</span> <span class="comment">//阿里云百炼</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel dashScopeChatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/chatmodel/dochat&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> String doChat(<span class="meta">@RequestParam(name = <span class="string">&quot;msg&quot;</span>,defaultValue = <span class="string">&quot;你是谁&quot;</span>)</span> String msg)</span><br><span class="line">    &#123;</span><br><span class="line">        String result = dashScopeChatModel.call(msg);</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">&quot;响应：&quot;</span> + result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>进一步新增ChatClient</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-292.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-293-1024x277.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-294.png" alt="img"></p><h5 id="业务类第2版">业务类第2版</h5><p>知识出处</p><p>chat源码：<a href="https://java2ai.com/docs/1.0.0.2/spring-ai-sourcecode-explained/chapter-1-chat-first-experience/?spm=5176.29160081.0.0.2856aa5cbeDVer">https://java2ai.com/docs/1.0.0.2/spring-ai-sourcecode-explained/chapter-1-chat-first-experience/?spm=5176.29160081.0.0.2856aa5cbeDVer</a></p><p>ChatClient使用：<a href="https://java2ai.com/docs/1.0.0.2/tutorials/basics/chat-client/?spm=5176.29160081.0.0.2856aa5cmUTyXC#%E5%88%9B%E5%BB%BA-chatclient">https://java2ai.com/docs/1.0.0.2/tutorials/basics/chat-client/?spm=5176.29160081.0.0.2856aa5cmUTyXC#%E5%88%9B%E5%BB%BA-chatclient</a></p><p>Only ChatClient</p><p>新建ChatClientController</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-23 19:22</span></span><br><span class="line"><span class="comment"> * 知识出处：</span></span><br><span class="line"><span class="comment"> * https://java2ai.com/docs/1.0.0.2/tutorials/basics/chat-client/?spm=5176.29160081.0.0.2856aa5cmUTyXC#%E5%88%9B%E5%BB%BA-chatclient</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatClientController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChatClient dashScopechatClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用自动配置的 ChatClient.Builder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dashscopeChatModel</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> ChatClientController(ChatModel dashscopeChatModel)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.dashScopechatClient = ChatClient.builder(dashscopeChatModel).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8003/chatclient/dochat</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/chatclient/dochat&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> String doChat(<span class="meta">@RequestParam(name = <span class="string">&quot;msg&quot;</span>,defaultValue = <span class="string">&quot;2加4等于几&quot;</span>)</span> String msg)</span><br><span class="line">    &#123;</span><br><span class="line">        String result = dashScopechatClient.prompt().user(msg).call().content();</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">&quot;响应：&quot;</span> + result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ChatModel对ChatClient吐槽：离开我你什么都不是，ChatModel是ChatClient的底层</p><h5 id="业务类第3版">业务类第3版</h5><p>ChatModel + ChatClient混合使用</p><p>修改配置类SaaLLMConfig</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.api.DashScopeApi;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-22 0:51</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SaaLLMConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DashScopeApi dashScopeApi()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DashScopeApi.builder()</span><br><span class="line">                    .apiKey(System.getenv(<span class="string">&quot;aliQwen-api&quot;</span>))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 知识出处：</span></span><br><span class="line"><span class="comment">     * https://java2ai.com/docs/1.0.0.2/tutorials/basics/chat-client/?spm=5176.29160081.0.0.2856aa5cmUTyXC#%E5%88%9B%E5%BB%BA-chatclient</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dashscopeChatModel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatClient chatClient(ChatModel dashscopeChatModel)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ChatClient.builder(dashscopeChatModel).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure><p>新建ChatClientControllerV2</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.api.DashScopeApi;</span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-23 19:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatClientControllerV2</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * chatModel + ChatClient 混合使用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel chatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient dashScopechatClientv2;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8003/chatclientv2/dochat</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/chatclientv2/dochat&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> String doChat(<span class="meta">@RequestParam(name = <span class="string">&quot;msg&quot;</span>,defaultValue = <span class="string">&quot;你是谁&quot;</span>)</span> String msg)</span><br><span class="line">    &#123;</span><br><span class="line">        String result = dashScopechatClientv2.prompt().user(msg).call().content();</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">&quot;ChatClient响应：&quot;</span> + result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8003/chatmodelv2/dochat</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/chatmodelv2/dochat&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> String doChat2(<span class="meta">@RequestParam(name = <span class="string">&quot;msg&quot;</span>,defaultValue = <span class="string">&quot;你是谁&quot;</span>)</span> String msg)</span><br><span class="line">    &#123;</span><br><span class="line">        String result = chatModel.call(msg);</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">&quot;ChatModel响应：&quot;</span> + result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>小总结</p><p>生产推荐：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-295.png" alt="img"></p><h2 id="5-Server-SentEvents-SSE-实现Stream流式输出及多模型共存">5.Server-SentEvents(SSE)实现Stream流式输出及多模型共存</h2><h3 id="1-Response-Streaming流式输出">1.Response Streaming流式输出</h3><h4 id="流式输出-StreamingOutput">流式输出(StreamingOutput)</h4><p>是一种<strong>逐步返回大模型生成结果</strong>的技术，生成一点返回一点，允许服务器将响应内容<br><strong>分批次实时传输给客户端</strong>，而不是等待全部内容生成完毕后再一次性返回。</p><p>这种机制能显著提升用户体验，<strong>尤其适用于大模型响应较慢的场景</strong>（如生成长文本或复杂推理结果）。</p><h4 id="SpringAI-Alibaba流式输出有两种">SpringAI Alibaba流式输出有两种</h4><ul><li>通过ChatModel实现stream实现流式输出</li><li>通过ChatClient实现stream实现流式输出</li></ul><h3 id="2-SSE-Server-Sent-Events-服务器发送事件">2.SSE(Server-Sent Events)服务器发送事件</h3><p>Server-Sent：由服务器发送。</p><p>Events：事件，指服务器主动推送给客户端的数据或消息</p><h4 id="Server-SentEvents-SSE-服务器发送事件实现流式输出">Server-SentEvents(SSE)服务器发送事件实现流式输出</h4><p>Server-Sent Events (SSE) 是一种允许<strong>服务端可以持续推送数据片段（如逐词或逐句）到前端</strong>的 Web 技术。<strong>通过单向的HTTP长连接</strong>，使用一个长期存在的连接，让服务器可以主动将数据&quot;推&quot;给客户端，SSE是轻量级的单向通信协议，适合AI对话这类服务端主导的场景</p><p>核心概念<br>SSE 的核心思想是：客户端发起一个请求，服务器保持这个连接打开并在有新数据时，通过这个连接将数据发送给客户端。这与传统的请求-响应模式（客户端请求一次，服务器响应一次，连接关闭）有本质区别。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-296.png" alt="img"></p><p>总结来说：SSE就是一种让服务器能够主动、持续地向客户端（比如你的网页浏览器）推送数据的技术</p><h4 id="SSE适用场景">SSE适用场景</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-297.png" alt="img"></p><h3 id="3-开发步骤">3.开发步骤</h3><p>目标：要求同时存在多种大模型产品在系统里共存使用</p><h4 id="改POM-2">改POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SpringAIAlibaba-atguiguV1<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SAA-04StreamingOutput<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--spring-ai-alibaba dashscope--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-alibaba-starter-dashscope<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--hutool--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-parameters<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="写YML-2">写YML</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="number">8004</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server.servlet.encoding.enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.force</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.charset</span>=UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.application.name</span>=SAA-<span class="number">04</span>StreamingOutput</span><br><span class="line"></span><br><span class="line"><span class="comment"># ====SpringAIAlibaba Config=============</span></span><br><span class="line"><span class="attr">spring.ai.dashscope.api-key</span>=<span class="variable">$&#123;aliQwen-api&#125;</span> </span><br></pre></td></tr></table></figure><h4 id="主启动">主启动</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">study</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">SpringApplication</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">autoconfigure</span>.<span class="property">SpringBootApplication</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-25 18:53</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 流式输出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Saa04StreamingOutputApplication</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="title function_">main</span>(<span class="params"><span class="title class_">String</span>[] args</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">SpringApplication</span>.<span class="title function_">run</span>(<span class="title class_">Saa04StreamingOutputApplication</span>.<span class="property">class</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="业务类-2">业务类</h4><ul><li>通过ChatModel实现stream实现流式输出</li></ul><p>1.配置类LLMConfig</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.api.DashScopeApi;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.chat.DashScopeChatOptions;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.ChatOptions;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-25 18:53</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> ChatModel+ChatClient+多模型共存</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SaaLLMConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 模型名称常量定义</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String DEEPSEEK_MODEL = <span class="string">&quot;deepseek-v3&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String QWEN_MODEL = <span class="string">&quot;qwen-plus&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="string">&quot;deepseek&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel deepSeek()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DashScopeChatModel.builder()</span><br><span class="line">                        .dashScopeApi(DashScopeApi.builder()</span><br><span class="line">                                    .apiKey(System.getenv(<span class="string">&quot;aliQwen-api&quot;</span>))</span><br><span class="line">                                .build())</span><br><span class="line">                .defaultOptions(</span><br><span class="line">                        DashScopeChatOptions.builder().withModel(DEEPSEEK_MODEL).build()</span><br><span class="line">                )</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="string">&quot;qwen&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel qwen()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DashScopeChatModel.builder().dashScopeApi(DashScopeApi.builder()</span><br><span class="line">                        .apiKey(System.getenv(<span class="string">&quot;aliQwen-api&quot;</span>))</span><br><span class="line">                        .build())</span><br><span class="line">                .defaultOptions(</span><br><span class="line">                        DashScopeChatOptions.builder()</span><br><span class="line">                                .withModel(QWEN_MODEL)</span><br><span class="line">                                .build()</span><br><span class="line">                )</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.controller第1版</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-25 18:53</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 流式输出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StreamOutputController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//V1 通过ChatModel实现stream实现流式输出</span></span><br><span class="line">    <span class="meta">@Resource(name = <span class="string">&quot;deepseek&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel deepseekChatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = <span class="string">&quot;qwen&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel qwenChatModel;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = <span class="string">&quot;/stream/chatflux1&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; chatflux(<span class="meta">@RequestParam(name = <span class="string">&quot;question&quot;</span>,defaultValue = <span class="string">&quot;你是谁&quot;</span>)</span> String question)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> deepseekChatModel.stream(question);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = <span class="string">&quot;/stream/chatflux2&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; chatflux2(<span class="meta">@RequestParam(name = <span class="string">&quot;question&quot;</span>,defaultValue = <span class="string">&quot;你是谁&quot;</span>)</span> String question)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> qwenChatModel.stream(question);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>通过ChatClient实现stream实现流式输出</li></ul><p>1.配置类LLMConfig</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.api.DashScopeApi;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.chat.DashScopeChatOptions;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.ChatOptions;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-25 18:53</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> ChatModel+ChatClient+多模型共存</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SaaLLMConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 模型名称常量定义</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String DEEPSEEK_MODEL = <span class="string">&quot;deepseek-v3&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String QWEN_MODEL = <span class="string">&quot;qwen-plus&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="string">&quot;deepseek&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel deepSeek()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DashScopeChatModel.builder()</span><br><span class="line">                        .dashScopeApi(DashScopeApi.builder()</span><br><span class="line">                                    .apiKey(System.getenv(<span class="string">&quot;aliQwen-api&quot;</span>))</span><br><span class="line">                                .build())</span><br><span class="line">                .defaultOptions(</span><br><span class="line">                        DashScopeChatOptions.builder().withModel(DEEPSEEK_MODEL).build()</span><br><span class="line">                )</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="string">&quot;qwen&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel qwen()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DashScopeChatModel.builder().dashScopeApi(DashScopeApi.builder()</span><br><span class="line">                        .apiKey(System.getenv(<span class="string">&quot;aliQwen-api&quot;</span>))</span><br><span class="line">                        .build())</span><br><span class="line">                .defaultOptions(</span><br><span class="line">                        DashScopeChatOptions.builder()</span><br><span class="line">                                .withModel(QWEN_MODEL)</span><br><span class="line">                                .build()</span><br><span class="line">                )</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="string">&quot;deepseekChatClient&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> ChatClient deepseekChatClient(<span class="meta">@Qualifier(<span class="string">&quot;deepseek&quot;</span>)</span> ChatModel deepSeek)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ChatClient.builder(deepSeek)</span><br><span class="line">                .defaultOptions(ChatOptions.builder()</span><br><span class="line">                        .model(DEEPSEEK_MODEL)</span><br><span class="line">                        .build())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="string">&quot;qwenChatClient&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> ChatClient qwenChatClient(<span class="meta">@Qualifier(<span class="string">&quot;qwen&quot;</span>)</span> ChatModel qwen)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ChatClient.builder(qwen)</span><br><span class="line">                .defaultOptions(ChatOptions.builder()</span><br><span class="line">                        .model(QWEN_MODEL)</span><br><span class="line">                        .build())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.controller第2版</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-25 18:53</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 流式输出</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StreamOutputController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//V1 通过ChatModel实现stream实现流式输出</span></span><br><span class="line">    <span class="meta">@Resource(name = <span class="string">&quot;deepseek&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel deepseekChatModel;</span><br><span class="line">    <span class="meta">@Resource(name = <span class="string">&quot;qwen&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel qwenChatModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//V2 通过ChatClient实现stream实现流式输出</span></span><br><span class="line">    <span class="meta">@Resource(name = <span class="string">&quot;deepseekChatClient&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient deepseekChatClient;</span><br><span class="line">    <span class="meta">@Resource(name = <span class="string">&quot;qwenChatClient&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient qwenChatClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = <span class="string">&quot;/stream/chatflux1&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; chatflux(<span class="meta">@RequestParam(name = <span class="string">&quot;question&quot;</span>,defaultValue = <span class="string">&quot;你是谁&quot;</span>)</span> String question)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> deepseekChatModel.stream(question);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = <span class="string">&quot;/stream/chatflux2&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; chatflux2(<span class="meta">@RequestParam(name = <span class="string">&quot;question&quot;</span>,defaultValue = <span class="string">&quot;你是谁&quot;</span>)</span> String question)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> qwenChatModel.stream(question);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = <span class="string">&quot;/stream/chatflux3&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; chatflux3(<span class="meta">@RequestParam(name = <span class="string">&quot;question&quot;</span>,defaultValue = <span class="string">&quot;你是谁&quot;</span>)</span> String question)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> deepseekChatClient.prompt(question).stream().content();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = <span class="string">&quot;/stream/chatflux4&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; chatflux4(<span class="meta">@RequestParam(name = <span class="string">&quot;question&quot;</span>,defaultValue = <span class="string">&quot;你是谁&quot;</span>)</span> String question)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> qwenChatClient.prompt(question).stream().content();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="新增前端代码">新增前端代码</h4><p>效果：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-298-1024x300.png" alt="img"></p><p>SSE</p><p>index.html</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>SSE流式chat<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-family</span>: Arial, sans-serif;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="number">#f4f4f4</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-id">#messageInput</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">90%</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">16px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#ccc</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-bottom</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">button</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">10px</span> <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">16px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="number">#007bff</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: white;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>: none;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">4px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">cursor</span>: pointer;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">button</span><span class="selector-pseudo">:hover</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="number">#0056b3</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-id">#messages</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-top</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">15px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="number">#f9f9f9</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#ddd</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">max-height</span>: <span class="number">300px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">overflow-y</span>: auto;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">2px</span> <span class="number">4px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.1</span>);</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-id">#messages</span> <span class="selector-tag">div</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">8px</span> <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="number">#eee</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">14px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#333</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-id">#messages</span> <span class="selector-tag">div</span><span class="selector-pseudo">:last-child</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-bottom</span>: none;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">&quot;messageInput&quot;</span> <span class="attr">rows</span>=<span class="string">&quot;4&quot;</span> <span class="attr">cols</span>=<span class="string">&quot;50&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入你的问题...&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;sendMsg()&quot;</span>&gt;</span>发送提问<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;messages&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">sendMsg</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 获取用户输入的消息</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> message = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;messageInput&#x27;</span>).<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (message == <span class="string">&quot;&quot;</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//1 客户端使用 JavaScript 的 EventSource 对象连接到服务器上的一个特定端点（URL）</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> eventSource = <span class="keyword">new</span> <span class="title class_">EventSource</span>(<span class="string">&#x27;stream/chatflux2?question=&#x27;</span> + message);</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//2 监听消息事件</span></span></span><br><span class="line"><span class="language-javascript">        eventSource.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 获取流式返回的数据</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> data = event.<span class="property">data</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 将接收到的数据展示到页面上</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">const</span> messagesDiv = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;messages&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            messagesDiv.<span class="property">innerHTML</span> += event.<span class="property">data</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="comment">//3 监听错误事件</span></span></span><br><span class="line"><span class="language-javascript">        eventSource.<span class="property">onerror</span> = <span class="keyword">function</span> (<span class="params">error</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;EventSource 发生错误：&#x27;</span>, error);</span></span><br><span class="line"><span class="language-javascript">            eventSource.<span class="title function_">close</span>(); <span class="comment">// 关闭连接</span></span></span><br><span class="line"><span class="language-javascript">        &#125;;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>测试：<a href="http://localhost:8004/index.html">http://localhost:8004/index.html</a></p><h2 id="6-提示词Prompt">6.提示词Prompt</h2><h3 id="1-DeepSeek提示词样例">1.DeepSeek提示词样例</h3><p><a href="https://api-docs.deepseek.com/zh-cn/prompt-library">https://api-docs.deepseek.com/zh-cn/prompt-library</a></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-299-1024x620.png" alt="img"></p><h3 id="2-是什么">2.是什么</h3><p>官网</p><p><a href="https://java2ai.com/docs/1.0.0.2/tutorials/basics/prompt/?spm=5176.29160081.0.0.2856aa5cdeol7a">https://java2ai.com/docs/1.0.0.2/tutorials/basics/prompt/?spm=5176.29160081.0.0.2856aa5cdeol7a</a></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-300.png" alt="img"></p><h4 id="先从最简单的API调用说起">先从最简单的API调用说起</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-301.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-302.png" alt="img"></p><p>可以近似的理解<br>Prompt &gt; Message &gt; String简单的字符串</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-303.png" alt="img"></p><h4 id="再从源码Prompt说起">再从源码Prompt说起</h4><p>1.String</p><p>最初的Prompt只是简单的文本字符串提问</p><p>2.Message</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-304.png" alt="img"></p><p>enum MessageType</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-305-1024x540.png" alt="img"></p><p>上述也称为</p><p>Prompt 中的四大角色（Role）</p><p>3.Prompt</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-306-1024x568.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-307.png" alt="img"></p><p>可以近似的理解<br>Prompt &gt; Message &gt; String 简单的文本字符串提问</p><h3 id="3-Prompt中的四大角色（Role）">3.Prompt中的四大角色（Role）</h3><p>总体概述</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-308.png" alt="img"></p><p>源码说明</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-309-1024x381.png" alt="img"></p><p>4大角色：</p><h4 id="system">system</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-310.png" alt="img"></p><p>设定AI行为边界/角色/定位。指导AI的行为和响应方式，设置AI如何解释和回复输入的</p><h4 id="user">user</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-311.png" alt="img"></p><p>用户原始提问输入。代表用户的输入他们向AI提出的问题、命令或陈述。</p><h4 id="assistant">assistant</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-312.png" alt="img"></p><ul><li>AI返回的响应信息，定义为”助手角色”消息。用它可以确保上下文能够连贯的交互。</li><li>记忆对话，积累回答</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-313.png" alt="img"></p><h4 id="tool">tool</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-314.png" alt="img"></p><p>桥接外部服务，可以进行函数调用如，支付/数据查询等操作，类似调用第3方util工具类，后面章节详细介绍</p><h4 id="总结">总结</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-315.png" alt="img"></p><h3 id="4-开发步骤">4.开发步骤</h3><h4 id="1-改POM">1.改POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zzyy.stduy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SpringAI-zyfanV1<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springAI-05chat-Prompt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--spring-ai-openai--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-starter-model-openai<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--hutool--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.34<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-parameters<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="2-写YML">2.写YML</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="number">8005</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server.servlet.encoding.enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.force</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.charset</span>=UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.application.name</span>=SAA-<span class="number">05</span>Prompt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ====SpringAIAlibaba Config=============</span></span><br><span class="line"><span class="attr">spring.ai.dashscope.api-key</span>=<span class="variable">$&#123;aliQwen-api&#125;</span></span><br></pre></td></tr></table></figure><h4 id="3-主启动">3.主启动</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">study</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">SpringApplication</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">autoconfigure</span>.<span class="property">SpringBootApplication</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-25 20:56</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 知识出处，https://java2ai.com/docs/1.0.0.2/tutorials/basics/prompt/?spm=5176.29160081.0.0.2856aa5cdeol7a</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Saa05PromptApplication</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="title function_">main</span>(<span class="params"><span class="title class_">String</span>[] args</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">SpringApplication</span>.<span class="title function_">run</span>(<span class="title class_">Saa05PromptApplication</span>.<span class="property">class</span>,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-业务类-2">4.业务类</h4><p>配置类LLMConfig</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.api.DashScopeApi;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.chat.DashScopeChatOptions;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.ChatOptions;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-25 18:53</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> ChatModel+ChatClient+多模型共存</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SaaLLMConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 模型名称常量定义</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String DEEPSEEK_MODEL = <span class="string">&quot;deepseek-v3&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String QWEN_MODEL = <span class="string">&quot;qwen-plus&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="string">&quot;deepseek&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel deepSeek()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DashScopeChatModel.builder()</span><br><span class="line">                        .dashScopeApi(DashScopeApi.builder()</span><br><span class="line">                                    .apiKey(System.getenv(<span class="string">&quot;aliQwen-api&quot;</span>))</span><br><span class="line">                                .build())</span><br><span class="line">                .defaultOptions(</span><br><span class="line">                        DashScopeChatOptions.builder().withModel(DEEPSEEK_MODEL).build()</span><br><span class="line">                )</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="string">&quot;qwen&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel qwen()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DashScopeChatModel.builder().dashScopeApi(DashScopeApi.builder()</span><br><span class="line">                        .apiKey(System.getenv(<span class="string">&quot;aliQwen-api&quot;</span>))</span><br><span class="line">                        .build())</span><br><span class="line">                .defaultOptions(</span><br><span class="line">                        DashScopeChatOptions.builder()</span><br><span class="line">                                .withModel(QWEN_MODEL)</span><br><span class="line">                                .build()</span><br><span class="line">                )</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="string">&quot;deepseekChatClient&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> ChatClient deepseekChatClient(<span class="meta">@Qualifier(<span class="string">&quot;deepseek&quot;</span>)</span> ChatModel deepSeek)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ChatClient.builder(deepSeek)</span><br><span class="line">                .defaultOptions(ChatOptions.builder()</span><br><span class="line">                        .model(DEEPSEEK_MODEL)</span><br><span class="line">                        .build())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="string">&quot;qwenChatClient&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> ChatClient qwenChatClient(<span class="meta">@Qualifier(<span class="string">&quot;qwen&quot;</span>)</span> ChatModel qwen)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ChatClient.builder(qwen)</span><br><span class="line">                .defaultOptions(ChatOptions.builder()</span><br><span class="line">                        .model(QWEN_MODEL)</span><br><span class="line">                        .build())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>controller第1版</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.AssistantMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.SystemMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.UserMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.Prompt;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-25 21:25</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 知识出处，https://java2ai.com/docs/1.0.0.2/tutorials/basics/prompt/?spm=5176.29160081.0.0.2856aa5cdeol7a</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PromptController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource(name = <span class="string">&quot;deepseek&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel deepseekChatModel;</span><br><span class="line">    <span class="meta">@Resource(name = <span class="string">&quot;qwen&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel qwenChatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = <span class="string">&quot;deepseekChatClient&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient deepseekChatClient;</span><br><span class="line">    <span class="meta">@Resource(name = <span class="string">&quot;qwenChatClient&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient qwenChatClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// http://localhost:8005/prompt/chat?question=火锅介绍下</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/prompt/chat&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; chat(String question)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> deepseekChatClient.prompt()</span><br><span class="line">                <span class="comment">// AI 能力边界</span></span><br><span class="line">                              .system(<span class="string">&quot;你是一个法律助手，只回答法律问题，其它问题回复，我只能回答法律相关问题，其它无可奉告&quot;</span>)</span><br><span class="line">                .user(question)</span><br><span class="line">                .stream()</span><br><span class="line">                .content();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过ChatClient实现</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-316.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-317.png" alt="img"></p><p>测试</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-318.png" alt="img"></p><p>controller第2版</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">study</span>.<span class="property">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="property">annotation</span>.<span class="property">Resource</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">ai</span>.<span class="property">chat</span>.<span class="property">client</span>.<span class="property">ChatClient</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">ai</span>.<span class="property">chat</span>.<span class="property">messages</span>.<span class="property">AssistantMessage</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">ai</span>.<span class="property">chat</span>.<span class="property">messages</span>.<span class="property">SystemMessage</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">ai</span>.<span class="property">chat</span>.<span class="property">messages</span>.<span class="property">UserMessage</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">ai</span>.<span class="property">chat</span>.<span class="property">model</span>.<span class="property">ChatModel</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">ai</span>.<span class="property">chat</span>.<span class="property">model</span>.<span class="property">ChatResponse</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">ai</span>.<span class="property">chat</span>.<span class="property">prompt</span>.<span class="property">Prompt</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">web</span>.<span class="property">bind</span>.<span class="property">annotation</span>.<span class="property">GetMapping</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">web</span>.<span class="property">bind</span>.<span class="property">annotation</span>.<span class="property">RestController</span>;</span><br><span class="line"><span class="keyword">import</span> reactor.<span class="property">core</span>.<span class="property">publisher</span>.<span class="property">Flux</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-25 21:25</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 知识出处，https://java2ai.com/docs/1.0.0.2/tutorials/basics/prompt/?spm=5176.29160081.0.0.2856aa5cdeol7a</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PromptController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource</span>(name = <span class="string">&quot;deepseek&quot;</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">ChatModel</span> deepseekChatModel;</span><br><span class="line">    <span class="meta">@Resource</span>(name = <span class="string">&quot;qwen&quot;</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">ChatModel</span> qwenChatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span>(name = <span class="string">&quot;deepseekChatClient&quot;</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">ChatClient</span> deepseekChatClient;</span><br><span class="line">    <span class="meta">@Resource</span>(name = <span class="string">&quot;qwenChatClient&quot;</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">ChatClient</span> qwenChatClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// http://localhost:8005/prompt/chat?question=火锅介绍下</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">&quot;/prompt/chat&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Flux</span>&lt;<span class="title class_">String</span>&gt; <span class="title function_">chat</span>(<span class="params"><span class="title class_">String</span> question</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> deepseekChatClient.<span class="title function_">prompt</span>()</span><br><span class="line">                <span class="comment">// AI 能力边界</span></span><br><span class="line">                .<span class="title function_">system</span>(<span class="string">&quot;你是一个法律助手，只回答法律问题，其它问题回复，我只能回答法律相关问题，其它无可奉告&quot;</span>)</span><br><span class="line">                .<span class="title function_">user</span>(question)</span><br><span class="line">                .<span class="title function_">stream</span>()</span><br><span class="line">                .<span class="title function_">content</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">&quot;/prompt/chat2&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Flux</span>&lt;<span class="title class_">ChatResponse</span>&gt; <span class="title function_">chat2</span>(<span class="params"><span class="title class_">String</span> question</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 用户消息</span></span><br><span class="line">        <span class="title class_">UserMessage</span> userMessage = <span class="keyword">new</span> <span class="title class_">UserMessage</span>(question);</span><br><span class="line">        <span class="comment">// 系统消息</span></span><br><span class="line">        <span class="title class_">SystemMessage</span> systemMessage = <span class="keyword">new</span> <span class="title class_">SystemMessage</span>(<span class="string">&quot;你是一个讲故事的助手,每个故事控制在300字以内&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Prompt</span> prompt = <span class="keyword">new</span> <span class="title class_">Prompt</span>(userMessage, systemMessage);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> deepseekChatModel.<span class="title function_">stream</span>(prompt);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">&quot;/prompt/chat3&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Flux</span>&lt;<span class="title class_">String</span>&gt; <span class="title function_">chat3</span>(<span class="params"><span class="title class_">String</span> question</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 用户消息</span></span><br><span class="line">        <span class="title class_">UserMessage</span> userMessage = <span class="keyword">new</span> <span class="title class_">UserMessage</span>(question);</span><br><span class="line">        <span class="comment">// 系统消息</span></span><br><span class="line">        <span class="title class_">SystemMessage</span> systemMessage = <span class="keyword">new</span> <span class="title class_">SystemMessage</span>(<span class="string">&quot;你是一个讲故事的助手,每个故事控制在300字以内&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Prompt</span> prompt = <span class="keyword">new</span> <span class="title class_">Prompt</span>(userMessage, systemMessage);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> deepseekChatModel.<span class="title function_">stream</span>(prompt)</span><br><span class="line">                .<span class="title function_">map</span>(response -&gt; response.<span class="title function_">getResults</span>().<span class="title function_">get</span>(<span class="number">0</span>).<span class="title function_">getOutput</span>().<span class="title function_">getText</span>());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>controller第3版</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">study</span>.<span class="property">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="property">annotation</span>.<span class="property">Resource</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">ai</span>.<span class="property">chat</span>.<span class="property">client</span>.<span class="property">ChatClient</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">ai</span>.<span class="property">chat</span>.<span class="property">messages</span>.<span class="property">AssistantMessage</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">ai</span>.<span class="property">chat</span>.<span class="property">messages</span>.<span class="property">SystemMessage</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">ai</span>.<span class="property">chat</span>.<span class="property">messages</span>.<span class="property">UserMessage</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">ai</span>.<span class="property">chat</span>.<span class="property">model</span>.<span class="property">ChatModel</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">ai</span>.<span class="property">chat</span>.<span class="property">model</span>.<span class="property">ChatResponse</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">ai</span>.<span class="property">chat</span>.<span class="property">prompt</span>.<span class="property">Prompt</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">web</span>.<span class="property">bind</span>.<span class="property">annotation</span>.<span class="property">GetMapping</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">web</span>.<span class="property">bind</span>.<span class="property">annotation</span>.<span class="property">RestController</span>;</span><br><span class="line"><span class="keyword">import</span> reactor.<span class="property">core</span>.<span class="property">publisher</span>.<span class="property">Flux</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-25 21:25</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 知识出处，https://java2ai.com/docs/1.0.0.2/tutorials/basics/prompt/?spm=5176.29160081.0.0.2856aa5cdeol7a</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PromptController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource</span>(name = <span class="string">&quot;deepseek&quot;</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">ChatModel</span> deepseekChatModel;</span><br><span class="line">    <span class="meta">@Resource</span>(name = <span class="string">&quot;qwen&quot;</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">ChatModel</span> qwenChatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span>(name = <span class="string">&quot;deepseekChatClient&quot;</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">ChatClient</span> deepseekChatClient;</span><br><span class="line">    <span class="meta">@Resource</span>(name = <span class="string">&quot;qwenChatClient&quot;</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">ChatClient</span> qwenChatClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// http://localhost:8005/prompt/chat?question=火锅介绍下</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">&quot;/prompt/chat&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Flux</span>&lt;<span class="title class_">String</span>&gt; <span class="title function_">chat</span>(<span class="params"><span class="title class_">String</span> question</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> deepseekChatClient.<span class="title function_">prompt</span>()</span><br><span class="line">                <span class="comment">// AI 能力边界</span></span><br><span class="line">                .<span class="title function_">system</span>(<span class="string">&quot;你是一个法律助手，只回答法律问题，其它问题回复，我只能回答法律相关问题，其它无可奉告&quot;</span>)</span><br><span class="line">                .<span class="title function_">user</span>(question)</span><br><span class="line">                .<span class="title function_">stream</span>()</span><br><span class="line">                .<span class="title function_">content</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">&quot;/prompt/chat2&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Flux</span>&lt;<span class="title class_">ChatResponse</span>&gt; <span class="title function_">chat2</span>(<span class="params"><span class="title class_">String</span> question</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 用户消息</span></span><br><span class="line">        <span class="title class_">UserMessage</span> userMessage = <span class="keyword">new</span> <span class="title class_">UserMessage</span>(question);</span><br><span class="line">        <span class="comment">// 系统消息</span></span><br><span class="line">        <span class="title class_">SystemMessage</span> systemMessage = <span class="keyword">new</span> <span class="title class_">SystemMessage</span>(<span class="string">&quot;你是一个讲故事的助手,每个故事控制在300字以内&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Prompt</span> prompt = <span class="keyword">new</span> <span class="title class_">Prompt</span>(userMessage, systemMessage);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> deepseekChatModel.<span class="title function_">stream</span>(prompt);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">&quot;/prompt/chat3&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Flux</span>&lt;<span class="title class_">String</span>&gt; <span class="title function_">chat3</span>(<span class="params"><span class="title class_">String</span> question</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 用户消息</span></span><br><span class="line">        <span class="title class_">UserMessage</span> userMessage = <span class="keyword">new</span> <span class="title class_">UserMessage</span>(question);</span><br><span class="line">        <span class="comment">// 系统消息</span></span><br><span class="line">        <span class="title class_">SystemMessage</span> systemMessage = <span class="keyword">new</span> <span class="title class_">SystemMessage</span>(<span class="string">&quot;你是一个讲故事的助手,每个故事控制在300字以内&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Prompt</span> prompt = <span class="keyword">new</span> <span class="title class_">Prompt</span>(userMessage, systemMessage);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> deepseekChatModel.<span class="title function_">stream</span>(prompt)</span><br><span class="line">                .<span class="title function_">map</span>(response -&gt; response.<span class="title function_">getResults</span>().<span class="title function_">get</span>(<span class="number">0</span>).<span class="title function_">getOutput</span>().<span class="title function_">getText</span>());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">&quot;/prompt/chat4&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">chat4</span>(<span class="params"><span class="title class_">String</span> question</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">AssistantMessage</span> assistantMessage = deepseekChatClient.<span class="title function_">prompt</span>()</span><br><span class="line">                    .<span class="title function_">user</span>(question)</span><br><span class="line">                    .<span class="title function_">call</span>()</span><br><span class="line">                    .<span class="title function_">chatResponse</span>()</span><br><span class="line">                    .<span class="title function_">getResult</span>()</span><br><span class="line">                    .<span class="title function_">getOutput</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> assistantMessage.<span class="title function_">getText</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-319.png" alt="img"></p><p>controller第4版</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.AssistantMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.SystemMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.ToolResponseMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.UserMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.Prompt;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-25 21:25</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 知识出处，https://java2ai.com/docs/1.0.0.2/tutorials/basics/prompt/?spm=5176.29160081.0.0.2856aa5cdeol7a</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PromptController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource(name = &quot;deepseek&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel deepseekChatModel;</span><br><span class="line">    <span class="meta">@Resource(name = &quot;qwen&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel qwenChatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;deepseekChatClient&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient deepseekChatClient;</span><br><span class="line">    <span class="meta">@Resource(name = &quot;qwenChatClient&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient qwenChatClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// http://localhost:8005/prompt/chat?question=火锅介绍下</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/prompt/chat&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">chat</span><span class="params">(String question)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> deepseekChatClient.prompt()</span><br><span class="line">                <span class="comment">// AI 能力边界</span></span><br><span class="line">                .system(<span class="string">&quot;你是一个法律助手，只回答法律问题，其它问题回复，我只能回答法律相关问题，其它无可奉告&quot;</span>)</span><br><span class="line">                .user(question)</span><br><span class="line">                .stream()</span><br><span class="line">                .content();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8005/prompt/chat2?question=葫芦娃</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> question</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/prompt/chat2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;ChatResponse&gt; <span class="title function_">chat2</span><span class="params">(String question)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 系统消息</span></span><br><span class="line">        <span class="type">SystemMessage</span> <span class="variable">systemMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SystemMessage</span>(<span class="string">&quot;你是一个讲故事的助手,每个故事控制在300字以内&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 用户消息</span></span><br><span class="line">        <span class="type">UserMessage</span> <span class="variable">userMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserMessage</span>(question);</span><br><span class="line"></span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Prompt</span>(userMessage, systemMessage);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> deepseekChatModel.stream(prompt);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8005/prompt/chat3?question=葫芦娃</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> question</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/prompt/chat3&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">chat3</span><span class="params">(String question)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 系统消息</span></span><br><span class="line">        <span class="type">SystemMessage</span> <span class="variable">systemMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SystemMessage</span>(<span class="string">&quot;你是一个讲故事的助手,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;每个故事控制在600字以内且以HTML格式返回&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 用户消息</span></span><br><span class="line">        <span class="type">UserMessage</span> <span class="variable">userMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserMessage</span>(question);</span><br><span class="line"></span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Prompt</span>(userMessage, systemMessage);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> deepseekChatModel.stream(prompt)</span><br><span class="line">                .map(response -&gt; response.getResults().get(<span class="number">0</span>).getOutput().getText());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8005/prompt/chat4?question=葫芦娃</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> question</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/prompt/chat4&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">chat4</span><span class="params">(String question)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">AssistantMessage</span> <span class="variable">assistantMessage</span> <span class="operator">=</span> deepseekChatClient.prompt()</span><br><span class="line">                    .user(question)</span><br><span class="line">                    .call()</span><br><span class="line">                    .chatResponse()</span><br><span class="line">                    .getResult()</span><br><span class="line">                    .getOutput();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> assistantMessage.getText();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8005/prompt/chat5?city=北京</span></span><br><span class="line"><span class="comment">     * 近似理解Tool后面章节讲解......</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> city</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/prompt/chat5&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">chat5</span><span class="params">(String city)</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">answer</span> <span class="operator">=</span> deepseekChatClient.prompt()</span><br><span class="line">                .user(city + <span class="string">&quot;未来3天天气情况如何?&quot;</span>)</span><br><span class="line">                .call()</span><br><span class="line">                .chatResponse()</span><br><span class="line">                .getResult()</span><br><span class="line">                .getOutput()</span><br><span class="line">                .getText();</span><br><span class="line"></span><br><span class="line">        <span class="type">ToolResponseMessage</span> <span class="variable">toolResponseMessage</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ToolResponseMessage</span>(</span><br><span class="line">                        List.of(<span class="keyword">new</span> <span class="title class_">ToolResponseMessage</span>.ToolResponse(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;获得天气&quot;</span>,city)</span><br><span class="line">                        )</span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">toolResponse</span> <span class="operator">=</span> toolResponseMessage.getText();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> answer + toolResponse;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-320.png" alt="img"></p><p>测试效果</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-321-1024x187.png" alt="img"></p><h4 id="5-小总结">5.小总结</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-322-1024x517.png" alt="img"></p><h2 id="7-提示词Prompt-Template">7.提示词Prompt Template</h2><h3 id="1-Prompt演化历程">1.Prompt演化历程</h3><ul><li>简单纯字符串提问问题<ul><li>最初的Prompt只是简单的文本字符串。</li></ul></li><li>多角色消息<ul><li>将消息分为不同角色（如用户、助手、系统等），设置功能边界，增强交互的复杂性和上下文感知能力</li><li>springai vs langchain4j vs spring ai alibaba</li></ul></li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-323-1024x572.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-324-1024x627.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-325.png" alt="img"></p><ul><li>占位符(Prompt Template)<ul><li>引入占位符(如{占位符变量名})以动态插入内容。</li></ul></li></ul><h3 id="2-提示词模板是什么">2.提示词模板是什么</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-326.png" alt="img"></p><p>知识出处</p><p><a href="https://java2ai.com/docs/1.0.0.2/tutorials/basics/prompt/?spm=4347728f.4dc6f515.0.0.538b4305NobuzA#prompt-template">https://java2ai.com/docs/1.0.0.2/tutorials/basics/prompt/?spm=4347728f.4dc6f515.0.0.538b4305NobuzA#prompt-template</a></p><p>模板</p><ul><li>入职邀请函模板</li></ul><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">主题：欢迎加入！给 [候选人姓名] 的入职邀请函</span><br><span class="line"> </span><br><span class="line">嗨 [候选人姓名]，</span><br><span class="line"> </span><br><span class="line">重磅好消息！经过团队的一致认可，我们真诚地邀请你加入我司，成为我们的 [职位名称]！</span><br><span class="line">从面试中的沟通，我们深深感受到了你的专业能力和对工作的热情，相信你的加入一定会让我们的团队更加出色。</span><br><span class="line">以下是你的入职详情，请查收：</span><br><span class="line">职位： [职位名称]</span><br><span class="line">团队： [部门/团队名称]</span><br><span class="line">工作地点： [公司地址]</span><br><span class="line">入职时间： [年]月[日](星期[几])，记得那天 [时间] 来找我们哦！</span><br><span class="line">薪资待遇：</span><br><span class="line">月薪：[金额] 元（税前）</span><br><span class="line">试用期：[时长]，薪资为转正后的 [百分比]<span class="comment">%</span></span><br><span class="line">五险一金：齐全！公司会为你全额缴纳。</span><br><span class="line">其他福利，如：零食饮料无限供应、年度旅游、弹性工作时间等</span><br><span class="line">在第一天，你需要准备：</span><br><span class="line">身份证、学历学位证、离职证明的原件和复印件</span><br><span class="line">一张开心的笑脸！：）</span><br><span class="line">为了能顺利迎接你，请在 [日期] 前回复这封邮件告诉我们“我愿意！”</span><br><span class="line">如果你有任何疑问，别客气，随时找我聊（联系人：[<span class="symbol">HR</span>姓名]，电话：[电话]）。</span><br><span class="line">非常期待与你见面，一起做些酷的事情！</span><br><span class="line"><span class="symbol">Best</span> regards,</span><br><span class="line">[你的名字/<span class="symbol">HR</span>名字]</span><br><span class="line">[公司名称] 团队</span><br><span class="line">[日期]</span><br></pre></td></tr></table></figure><ul><li>短信模板</li><li>邮件模板</li></ul><p>PromptTemplate</p><h3 id="3-开发步骤-2">3.开发步骤</h3><p>改POM</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SpringAIAlibaba-atguiguV1<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SAA-06PromptTemplate<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--spring-ai-alibaba dashscope--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-alibaba-starter-dashscope<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--hutool--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-parameters<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span> </span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>写YML</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="number">8006</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server.servlet.encoding.enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.force</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.charset</span>=UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.application.name</span>=SAA-<span class="number">06</span>PromptTemplate</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ====SpringAIAlibaba Config=============</span></span><br><span class="line"><span class="attr">spring.ai.dashscope.api-key</span>=<span class="variable">$&#123;aliQwen-api&#125;</span></span><br></pre></td></tr></table></figure><p>主启动</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">study</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">SpringApplication</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">autoconfigure</span>.<span class="property">SpringBootApplication</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Saa06PromptTemplateApplication</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="title function_">main</span>(<span class="params"><span class="title class_">String</span>[] args</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">SpringApplication</span>.<span class="title function_">run</span>(<span class="title class_">Saa06PromptTemplateApplication</span>.<span class="property">class</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>改POM</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SpringAIAlibaba-atguiguV1<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SAA-06PromptTemplate<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--spring-ai-alibaba dashscope--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-alibaba-starter-dashscope<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--hutool--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-parameters<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span> </span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>写YML</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="number">8006</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server.servlet.encoding.enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.force</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.charset</span>=UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.application.name</span>=SAA-<span class="number">06</span>PromptTemplate</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ====SpringAIAlibaba Config=============</span></span><br><span class="line"><span class="attr">spring.ai.dashscope.api-key</span>=<span class="variable">$&#123;aliQwen-api&#125;</span></span><br></pre></td></tr></table></figure><p>主启动</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">study</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">SpringApplication</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">autoconfigure</span>.<span class="property">SpringBootApplication</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Saa06PromptTemplateApplication</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="title function_">main</span>(<span class="params"><span class="title class_">String</span>[] args</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">SpringApplication</span>.<span class="title function_">run</span>(<span class="title class_">Saa06PromptTemplateApplication</span>.<span class="property">class</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="业务类-3">业务类</h4><p>配置类LLMConfig</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.api.DashScopeApi;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.chat.DashScopeChatOptions;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.ChatOptions;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-25 18:53</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> ChatModel+ChatClient+多模型共存</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SaaLLMConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 模型名称常量定义</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String DEEPSEEK_MODEL = <span class="string">&quot;deepseek-v3&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String QWEN_MODEL = <span class="string">&quot;qwen-plus&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="string">&quot;deepseek&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel deepSeek()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DashScopeChatModel.builder()</span><br><span class="line">                        .dashScopeApi(DashScopeApi.builder()</span><br><span class="line">                                    .apiKey(System.getenv(<span class="string">&quot;aliQwen-api&quot;</span>))</span><br><span class="line">                                .build())</span><br><span class="line">                .defaultOptions(</span><br><span class="line">                        DashScopeChatOptions.builder().withModel(DEEPSEEK_MODEL).build()</span><br><span class="line">                )</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="string">&quot;qwen&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel qwen()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DashScopeChatModel.builder().dashScopeApi(DashScopeApi.builder()</span><br><span class="line">                        .apiKey(System.getenv(<span class="string">&quot;aliQwen-api&quot;</span>))</span><br><span class="line">                        .build())</span><br><span class="line">                .defaultOptions(</span><br><span class="line">                        DashScopeChatOptions.builder()</span><br><span class="line">                                .withModel(QWEN_MODEL)</span><br><span class="line">                                .build()</span><br><span class="line">                )</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="string">&quot;deepseekChatClient&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> ChatClient deepseekChatClient(<span class="meta">@Qualifier(<span class="string">&quot;deepseek&quot;</span>)</span> ChatModel deepSeek)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ChatClient.builder(deepSeek)</span><br><span class="line">                .defaultOptions(ChatOptions.builder()</span><br><span class="line">                        .model(DEEPSEEK_MODEL)</span><br><span class="line">                        .build())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="string">&quot;qwenChatClient&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> ChatClient qwenChatClient(<span class="meta">@Qualifier(<span class="string">&quot;qwen&quot;</span>)</span> ChatModel qwen)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ChatClient.builder(qwen)</span><br><span class="line">                .defaultOptions(ChatOptions.builder()</span><br><span class="line">                        .model(QWEN_MODEL)</span><br><span class="line">                        .build())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-PromptTemplate基本使用">1.PromptTemplate基本使用</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.SystemMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.UserMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.Prompt;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.PromptTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.SystemPromptTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-26 16:25</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PromptTemplateController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource(name = <span class="string">&quot;deepseek&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel deepseekChatModel;</span><br><span class="line">    <span class="meta">@Resource(name = <span class="string">&quot;qwen&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel qwenChatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = <span class="string">&quot;deepseekChatClient&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient deepseekChatClient;</span><br><span class="line">    <span class="meta">@Resource(name = <span class="string">&quot;qwenChatClient&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient qwenChatClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: PromptTemplate基本使用，使用占位符设置模版 PromptTemplate</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Auther</span>: zzyybs@126.com</span></span><br><span class="line"><span class="comment">     * 测试地址</span></span><br><span class="line"><span class="comment">     * http://localhost:8006/prompttemplate/chat?topic=java&amp;output_format=html&amp;wordCount=200</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/prompttemplate/chat&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; chat(String topic, String output_format, String wordCount)</span><br><span class="line">    &#123;</span><br><span class="line">        PromptTemplate promptTemplate = new PromptTemplate(<span class="string">&quot;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;讲一个关于&#123;topic&#125;的故事&quot;</span> +</span><br><span class="line">                <span class="string">&quot;并以&#123;output_format&#125;格式输出，&quot;</span> +</span><br><span class="line">                <span class="string">&quot;字数在&#123;wordCount&#125;左右&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// PromptTempate -&gt; Prompt</span></span><br><span class="line">        Prompt prompt = promptTemplate.create(Map.of(</span><br><span class="line">                <span class="string">&quot;topic&quot;</span>, topic,</span><br><span class="line">                <span class="string">&quot;output_format&quot;</span>,output_format,</span><br><span class="line">                <span class="string">&quot;wordCount&quot;</span>,wordCount));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> deepseekChatClient.prompt(prompt).stream().content();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-PromptTemplate读取模版文件实现模版功能">2.PromptTemplate读取模版文件实现模版功能</h4><p>讲一个关于{topic}的故事，并以{output_format}格式输出。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-332-1024x560.png" alt="img"></p><p>代码：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.SystemMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.UserMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.Prompt;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.PromptTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.SystemPromptTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-26 16:25</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PromptTemplateController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource(name = <span class="string">&quot;deepseek&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel deepseekChatModel;</span><br><span class="line">    <span class="meta">@Resource(name = <span class="string">&quot;qwen&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel qwenChatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = <span class="string">&quot;deepseekChatClient&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient deepseekChatClient;</span><br><span class="line">    <span class="meta">@Resource(name = <span class="string">&quot;qwenChatClient&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient qwenChatClient;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(<span class="string">&quot;classpath:/prompttemplate/atguigu-template.txt&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> org.springframework.core.io.Resource userTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: PromptTemplate基本使用，使用占位符设置模版 PromptTemplate</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Auther</span>: zzyybs@126.com</span></span><br><span class="line"><span class="comment">     * 测试地址</span></span><br><span class="line"><span class="comment">     * http://localhost:8006/prompttemplate/chat?topic=java&amp;output_format=html&amp;wordCount=200</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/prompttemplate/chat&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; chat(String topic, String output_format, String wordCount)</span><br><span class="line">    &#123;</span><br><span class="line">        PromptTemplate promptTemplate = new PromptTemplate(<span class="string">&quot;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;讲一个关于&#123;topic&#125;的故事&quot;</span> +</span><br><span class="line">                <span class="string">&quot;并以&#123;output_format&#125;格式输出，&quot;</span> +</span><br><span class="line">                <span class="string">&quot;字数在&#123;wordCount&#125;左右&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// PromptTempate -&gt; Prompt</span></span><br><span class="line">        Prompt prompt = promptTemplate.create(Map.of(</span><br><span class="line">                <span class="string">&quot;topic&quot;</span>, topic,</span><br><span class="line">                <span class="string">&quot;output_format&quot;</span>,output_format,</span><br><span class="line">                <span class="string">&quot;wordCount&quot;</span>,wordCount));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> deepseekChatClient.prompt(prompt).stream().content();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: PromptTemplate读取模版文件实现模版功能</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Auther</span>: zzyybs@126.com</span></span><br><span class="line"><span class="comment">     * 测试地址</span></span><br><span class="line"><span class="comment">     * http://localhost:8006/prompttemplate/chat2?topic=java&amp;output_format=html</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/prompttemplate/chat2&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> String chat2(String topic,String output_format)</span><br><span class="line">    &#123;</span><br><span class="line">        PromptTemplate promptTemplate = new PromptTemplate(userTemplate);</span><br><span class="line"></span><br><span class="line">        Prompt prompt = promptTemplate.create(Map.of(<span class="string">&quot;topic&quot;</span>, topic, <span class="string">&quot;output_format&quot;</span>, output_format));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> deepseekChatClient.prompt(prompt).call().content();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-PromptTemplate多角色设定">3.PromptTemplate多角色设定</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.SystemMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.UserMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.Prompt;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.PromptTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.SystemPromptTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-26 16:25</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PromptTemplateController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource(name = &quot;deepseek&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel deepseekChatModel;</span><br><span class="line">    <span class="meta">@Resource(name = &quot;qwen&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel qwenChatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;deepseekChatClient&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient deepseekChatClient;</span><br><span class="line">    <span class="meta">@Resource(name = &quot;qwenChatClient&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient qwenChatClient;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;classpath:/prompttemplate/atguigu-template.txt&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> org.springframework.core.io.Resource userTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: PromptTemplate基本使用，使用占位符设置模版 PromptTemplate</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Auther</span>: zzyybs@126.com</span></span><br><span class="line"><span class="comment">     * 测试地址</span></span><br><span class="line"><span class="comment">     * http://localhost:8006/prompttemplate/chat?topic=java&amp;output_format=html&amp;wordCount=200</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/prompttemplate/chat&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">chat</span><span class="params">(String topic, String output_format, String wordCount)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">PromptTemplate</span> <span class="variable">promptTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PromptTemplate</span>(<span class="string">&quot;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;讲一个关于&#123;topic&#125;的故事&quot;</span> +</span><br><span class="line">                <span class="string">&quot;并以&#123;output_format&#125;格式输出，&quot;</span> +</span><br><span class="line">                <span class="string">&quot;字数在&#123;wordCount&#125;左右&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// PromptTempate -&gt; Prompt</span></span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> promptTemplate.create(Map.of(</span><br><span class="line">                <span class="string">&quot;topic&quot;</span>, topic,</span><br><span class="line">                <span class="string">&quot;output_format&quot;</span>,output_format,</span><br><span class="line">                <span class="string">&quot;wordCount&quot;</span>,wordCount));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> deepseekChatClient.prompt(prompt).stream().content();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: PromptTemplate读取模版文件实现模版功能</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Auther</span>: zzyybs@126.com</span></span><br><span class="line"><span class="comment">     * 测试地址</span></span><br><span class="line"><span class="comment">     * http://localhost:8006/prompttemplate/chat2?topic=java&amp;output_format=html</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/prompttemplate/chat2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">chat2</span><span class="params">(String topic,String output_format)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">PromptTemplate</span> <span class="variable">promptTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PromptTemplate</span>(userTemplate);</span><br><span class="line"></span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> promptTemplate.create(Map.of(<span class="string">&quot;topic&quot;</span>, topic, <span class="string">&quot;output_format&quot;</span>, output_format));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> deepseekChatClient.prompt(prompt).call().content();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  <span class="doctag">@Auther</span>: zzyybs@126.com</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment">     * 系统消息(SystemMessage)：设定AI的行为规则和功能边界(xxx助手/什么格式返回/字数控制多少)。</span></span><br><span class="line"><span class="comment">     * 用户消息(UserMessage)：用户的提问/主题</span></span><br><span class="line"><span class="comment">     * http://localhost:8006/prompttemplate/chat3?sysTopic=法律&amp;userTopic=知识产权法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * http://localhost:8006/prompttemplate/chat3?sysTopic=法律&amp;userTopic=夫妻肺片</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/prompttemplate/chat3&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">chat3</span><span class="params">(String sysTopic, String userTopic)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 1.SystemPromptTemplate</span></span><br><span class="line">        <span class="type">SystemPromptTemplate</span> <span class="variable">systemPromptTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SystemPromptTemplate</span>(<span class="string">&quot;你是&#123;systemTopic&#125;助手，只回答&#123;systemTopic&#125;其它无可奉告，以HTML格式的结果。&quot;</span>);</span><br><span class="line">        <span class="type">Message</span> <span class="variable">sysMessage</span> <span class="operator">=</span> systemPromptTemplate.createMessage(Map.of(<span class="string">&quot;systemTopic&quot;</span>, sysTopic));</span><br><span class="line">        <span class="comment">// 2.PromptTemplate</span></span><br><span class="line">        <span class="type">PromptTemplate</span> <span class="variable">userPromptTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PromptTemplate</span>(<span class="string">&quot;解释一下&#123;userTopic&#125;&quot;</span>);</span><br><span class="line">        <span class="type">Message</span> <span class="variable">userMessage</span> <span class="operator">=</span> userPromptTemplate.createMessage(Map.of(<span class="string">&quot;userTopic&quot;</span>, userTopic));</span><br><span class="line">        <span class="comment">// 3.组合【关键】 多个 Message -&gt; Prompt</span></span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Prompt</span>(List.of(sysMessage, userMessage));</span><br><span class="line">        <span class="comment">// 4.调用 LLM</span></span><br><span class="line">        <span class="keyword">return</span> deepseekChatClient.prompt(prompt).call().content();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-333-1024x259.png" alt="img"></p><h4 id="4-PromptTemplate人物设定">4.PromptTemplate人物设定</h4><ul><li>通过ChatModel实现</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.SystemMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.UserMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.Prompt;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.PromptTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.SystemPromptTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-26 16:25</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PromptTemplateController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource(name = &quot;deepseek&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel deepseekChatModel;</span><br><span class="line">    <span class="meta">@Resource(name = &quot;qwen&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel qwenChatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;deepseekChatClient&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient deepseekChatClient;</span><br><span class="line">    <span class="meta">@Resource(name = &quot;qwenChatClient&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient qwenChatClient;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;classpath:/prompttemplate/atguigu-template.txt&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> org.springframework.core.io.Resource userTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: PromptTemplate基本使用，使用占位符设置模版 PromptTemplate</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Auther</span>: zzyybs@126.com</span></span><br><span class="line"><span class="comment">     * 测试地址</span></span><br><span class="line"><span class="comment">     * http://localhost:8006/prompttemplate/chat?topic=java&amp;output_format=html&amp;wordCount=200</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/prompttemplate/chat&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">chat</span><span class="params">(String topic, String output_format, String wordCount)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">PromptTemplate</span> <span class="variable">promptTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PromptTemplate</span>(<span class="string">&quot;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;讲一个关于&#123;topic&#125;的故事&quot;</span> +</span><br><span class="line">                <span class="string">&quot;并以&#123;output_format&#125;格式输出，&quot;</span> +</span><br><span class="line">                <span class="string">&quot;字数在&#123;wordCount&#125;左右&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// PromptTempate -&gt; Prompt</span></span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> promptTemplate.create(Map.of(</span><br><span class="line">                <span class="string">&quot;topic&quot;</span>, topic,</span><br><span class="line">                <span class="string">&quot;output_format&quot;</span>,output_format,</span><br><span class="line">                <span class="string">&quot;wordCount&quot;</span>,wordCount));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> deepseekChatClient.prompt(prompt).stream().content();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: PromptTemplate读取模版文件实现模版功能</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Auther</span>: zzyybs@126.com</span></span><br><span class="line"><span class="comment">     * 测试地址</span></span><br><span class="line"><span class="comment">     * http://localhost:8006/prompttemplate/chat2?topic=java&amp;output_format=html</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/prompttemplate/chat2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">chat2</span><span class="params">(String topic,String output_format)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">PromptTemplate</span> <span class="variable">promptTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PromptTemplate</span>(userTemplate);</span><br><span class="line"></span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> promptTemplate.create(Map.of(<span class="string">&quot;topic&quot;</span>, topic, <span class="string">&quot;output_format&quot;</span>, output_format));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> deepseekChatClient.prompt(prompt).call().content();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  <span class="doctag">@Auther</span>: zzyybs@126.com</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment">     * 系统消息(SystemMessage)：设定AI的行为规则和功能边界(xxx助手/什么格式返回/字数控制多少)。</span></span><br><span class="line"><span class="comment">     * 用户消息(UserMessage)：用户的提问/主题</span></span><br><span class="line"><span class="comment">     * http://localhost:8006/prompttemplate/chat3?sysTopic=法律&amp;userTopic=知识产权法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * http://localhost:8006/prompttemplate/chat3?sysTopic=法律&amp;userTopic=夫妻肺片</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/prompttemplate/chat3&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">chat3</span><span class="params">(String sysTopic, String userTopic)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 1.SystemPromptTemplate</span></span><br><span class="line">        <span class="type">SystemPromptTemplate</span> <span class="variable">systemPromptTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SystemPromptTemplate</span>(<span class="string">&quot;你是&#123;systemTopic&#125;助手，只回答&#123;systemTopic&#125;其它无可奉告，以HTML格式的结果。&quot;</span>);</span><br><span class="line">        <span class="type">Message</span> <span class="variable">sysMessage</span> <span class="operator">=</span> systemPromptTemplate.createMessage(Map.of(<span class="string">&quot;systemTopic&quot;</span>, sysTopic));</span><br><span class="line">        <span class="comment">// 2.PromptTemplate</span></span><br><span class="line">        <span class="type">PromptTemplate</span> <span class="variable">userPromptTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PromptTemplate</span>(<span class="string">&quot;解释一下&#123;userTopic&#125;&quot;</span>);</span><br><span class="line">        <span class="type">Message</span> <span class="variable">userMessage</span> <span class="operator">=</span> userPromptTemplate.createMessage(Map.of(<span class="string">&quot;userTopic&quot;</span>, userTopic));</span><br><span class="line">        <span class="comment">// 3.组合【关键】 多个 Message -&gt; Prompt</span></span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Prompt</span>(List.of(sysMessage, userMessage));</span><br><span class="line">        <span class="comment">// 4.调用 LLM</span></span><br><span class="line">        <span class="keyword">return</span> deepseekChatClient.prompt(prompt).call().content();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: 人物角色设定，通过SystemMessage来实现人物设定，本案例用ChatModel实现</span></span><br><span class="line"><span class="comment">     * 设定AI为”医疗专家”时，仅回答医学相关问题</span></span><br><span class="line"><span class="comment">     * 设定AI为编程助手”时，专注于技术问题解答</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Auther</span>: zzyybs@126.com</span></span><br><span class="line"><span class="comment">     * http://localhost:8006/prompttemplate/chat4?question=牡丹花</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/prompttemplate/chat4&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">chat4</span><span class="params">(String question)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//1 系统消息</span></span><br><span class="line">        <span class="type">SystemMessage</span> <span class="variable">systemMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SystemMessage</span>(<span class="string">&quot;你是一个Java编程助手，拒绝回答非技术问题。&quot;</span>);</span><br><span class="line">        <span class="comment">//2 用户消息</span></span><br><span class="line">        <span class="type">UserMessage</span> <span class="variable">userMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserMessage</span>(question);</span><br><span class="line">        <span class="comment">//3 系统消息+用户消息=完整提示词</span></span><br><span class="line">        <span class="comment">//Prompt prompt = new Prompt(systemMessage, userMessage);</span></span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Prompt</span>(List.of(systemMessage, userMessage));</span><br><span class="line">        <span class="comment">//4 调用LLM</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> deepseekChatModel.call(prompt).getResult().getOutput().getText();</span><br><span class="line">        System.out.println(result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>通过ChatClient实现</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.SystemMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.UserMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.Prompt;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.PromptTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.SystemPromptTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-26 16:25</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PromptTemplateController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource(name = &quot;deepseek&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel deepseekChatModel;</span><br><span class="line">    <span class="meta">@Resource(name = &quot;qwen&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel qwenChatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource(name = &quot;deepseekChatClient&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient deepseekChatClient;</span><br><span class="line">    <span class="meta">@Resource(name = &quot;qwenChatClient&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient qwenChatClient;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;classpath:/prompttemplate/atguigu-template.txt&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> org.springframework.core.io.Resource userTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: PromptTemplate基本使用，使用占位符设置模版 PromptTemplate</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Auther</span>: zzyybs@126.com</span></span><br><span class="line"><span class="comment">     * 测试地址</span></span><br><span class="line"><span class="comment">     * http://localhost:8006/prompttemplate/chat?topic=java&amp;output_format=html&amp;wordCount=200</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/prompttemplate/chat&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">chat</span><span class="params">(String topic, String output_format, String wordCount)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">PromptTemplate</span> <span class="variable">promptTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PromptTemplate</span>(<span class="string">&quot;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;讲一个关于&#123;topic&#125;的故事&quot;</span> +</span><br><span class="line">                <span class="string">&quot;并以&#123;output_format&#125;格式输出，&quot;</span> +</span><br><span class="line">                <span class="string">&quot;字数在&#123;wordCount&#125;左右&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// PromptTempate -&gt; Prompt</span></span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> promptTemplate.create(Map.of(</span><br><span class="line">                <span class="string">&quot;topic&quot;</span>, topic,</span><br><span class="line">                <span class="string">&quot;output_format&quot;</span>,output_format,</span><br><span class="line">                <span class="string">&quot;wordCount&quot;</span>,wordCount));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> deepseekChatClient.prompt(prompt).stream().content();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: PromptTemplate读取模版文件实现模版功能</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Auther</span>: zzyybs@126.com</span></span><br><span class="line"><span class="comment">     * 测试地址</span></span><br><span class="line"><span class="comment">     * http://localhost:8006/prompttemplate/chat2?topic=java&amp;output_format=html</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/prompttemplate/chat2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">chat2</span><span class="params">(String topic,String output_format)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">PromptTemplate</span> <span class="variable">promptTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PromptTemplate</span>(userTemplate);</span><br><span class="line"></span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> promptTemplate.create(Map.of(<span class="string">&quot;topic&quot;</span>, topic, <span class="string">&quot;output_format&quot;</span>, output_format));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> deepseekChatClient.prompt(prompt).call().content();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  <span class="doctag">@Auther</span>: zzyybs@126.com</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>:</span></span><br><span class="line"><span class="comment">     * 系统消息(SystemMessage)：设定AI的行为规则和功能边界(xxx助手/什么格式返回/字数控制多少)。</span></span><br><span class="line"><span class="comment">     * 用户消息(UserMessage)：用户的提问/主题</span></span><br><span class="line"><span class="comment">     * http://localhost:8006/prompttemplate/chat3?sysTopic=法律&amp;userTopic=知识产权法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * http://localhost:8006/prompttemplate/chat3?sysTopic=法律&amp;userTopic=夫妻肺片</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/prompttemplate/chat3&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">chat3</span><span class="params">(String sysTopic, String userTopic)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 1.SystemPromptTemplate</span></span><br><span class="line">        <span class="type">SystemPromptTemplate</span> <span class="variable">systemPromptTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SystemPromptTemplate</span>(<span class="string">&quot;你是&#123;systemTopic&#125;助手，只回答&#123;systemTopic&#125;其它无可奉告，以HTML格式的结果。&quot;</span>);</span><br><span class="line">        <span class="type">Message</span> <span class="variable">sysMessage</span> <span class="operator">=</span> systemPromptTemplate.createMessage(Map.of(<span class="string">&quot;systemTopic&quot;</span>, sysTopic));</span><br><span class="line">        <span class="comment">// 2.PromptTemplate</span></span><br><span class="line">        <span class="type">PromptTemplate</span> <span class="variable">userPromptTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PromptTemplate</span>(<span class="string">&quot;解释一下&#123;userTopic&#125;&quot;</span>);</span><br><span class="line">        <span class="type">Message</span> <span class="variable">userMessage</span> <span class="operator">=</span> userPromptTemplate.createMessage(Map.of(<span class="string">&quot;userTopic&quot;</span>, userTopic));</span><br><span class="line">        <span class="comment">// 3.组合【关键】 多个 Message -&gt; Prompt</span></span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Prompt</span>(List.of(sysMessage, userMessage));</span><br><span class="line">        <span class="comment">// 4.调用 LLM</span></span><br><span class="line">        <span class="keyword">return</span> deepseekChatClient.prompt(prompt).call().content();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: 人物角色设定，通过SystemMessage来实现人物设定，本案例用ChatModel实现</span></span><br><span class="line"><span class="comment">     * 设定AI为”医疗专家”时，仅回答医学相关问题</span></span><br><span class="line"><span class="comment">     * 设定AI为编程助手”时，专注于技术问题解答</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Auther</span>: zzyybs@126.com</span></span><br><span class="line"><span class="comment">     * http://localhost:8006/prompttemplate/chat4?question=牡丹花</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/prompttemplate/chat4&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">chat4</span><span class="params">(String question)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//1 系统消息</span></span><br><span class="line">        <span class="type">SystemMessage</span> <span class="variable">systemMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SystemMessage</span>(<span class="string">&quot;你是一个Java编程助手，拒绝回答非技术问题。&quot;</span>);</span><br><span class="line">        <span class="comment">//2 用户消息</span></span><br><span class="line">        <span class="type">UserMessage</span> <span class="variable">userMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserMessage</span>(question);</span><br><span class="line">        <span class="comment">//3 系统消息+用户消息=完整提示词</span></span><br><span class="line">        <span class="comment">//Prompt prompt = new Prompt(systemMessage, userMessage);</span></span><br><span class="line">        <span class="type">Prompt</span> <span class="variable">prompt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Prompt</span>(List.of(systemMessage, userMessage));</span><br><span class="line">        <span class="comment">//4 调用LLM</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> deepseekChatModel.call(prompt).getResult().getOutput().getText();</span><br><span class="line">        System.out.println(result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: 人物角色设定，通过SystemMessage来实现人物设定，本案例用ChatClient实现</span></span><br><span class="line"><span class="comment">     * 设定AI为”医疗专家”时，仅回答医学相关问题</span></span><br><span class="line"><span class="comment">     * 设定AI为编程助手”时，专注于技术问题解答</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Auther</span>: zzyybs@126.com</span></span><br><span class="line"><span class="comment">     * http://localhost:8006/prompttemplate/chat5?question=火锅</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/prompttemplate/chat5&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">chat5</span><span class="params">(String question)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> deepseekChatClient.prompt()</span><br><span class="line">                .system(<span class="string">&quot;你是一个Java编程助手，拒绝回答非技术问题。&quot;</span>)</span><br><span class="line">                .user(question)</span><br><span class="line">                .stream()</span><br><span class="line">                .content();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="8-格式化输出-Structured-Output">8.格式化输出(Structured Output)</h2><h3 id="1-是什么-2">1.是什么</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-334.png" alt="img"></p><p><a href="https://java2ai.com/docs/1.0.0.2/tutorials/basics/structured-output/?spm=5176.29160081.0.0.2856aa5cPJ9Ha8">https://java2ai.com/docs/1.0.0.2/tutorials/basics/structured-output/?spm=5176.29160081.0.0.2856aa5cPJ9Ha8</a></p><h3 id="2-开发步骤">2.开发步骤</h3><p>目标：假设我们期望将模型输出转换为Record记录类结构体，不再是传统的String</p><p>新建子模块Module SAA-07StructuredOutput</p><p>改POM</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SpringAIAlibaba-atguiguV1<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SAA-07StructuredOutput<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--spring-ai-alibaba dashscope--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-alibaba-starter-dashscope<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--hutool--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-parameters<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>写YML</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="number">8006</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server.servlet.encoding.enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.force</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.charset</span>=UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.application.name</span>=SAA-<span class="number">06</span>PromptTemplate</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ====SpringAIAlibaba Config=============</span></span><br><span class="line"><span class="attr">spring.ai.dashscope.api-key</span>=<span class="variable">$&#123;aliQwen-api&#125;</span></span><br></pre></td></tr></table></figure><p>主启动</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">study</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">SpringApplication</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">autoconfigure</span>.<span class="property">SpringBootApplication</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-26 17:16</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 知识出处，https://java2ai.com/docs/1.0.0.2/tutorials/basics/structured-output/?spm=5176.29160081.0.0.2856aa5cPJ9Ha8</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Saa07StructuredOutputApplication</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="title function_">main</span>(<span class="params"><span class="title class_">String</span>[] args</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">SpringApplication</span>.<span class="title function_">run</span>(<span class="title class_">Saa07StructuredOutputApplication</span>.<span class="property">class</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="业务类-4">业务类</h3><p>配置类LLMConfig</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.api.DashScopeApi;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.chat.DashScopeChatOptions;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.ChatOptions;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-25 18:53</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> ChatModel+ChatClient+多模型共存</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SaaLLMConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 模型名称常量定义</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String DEEPSEEK_MODEL = <span class="string">&quot;deepseek-v3&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String QWEN_MODEL = <span class="string">&quot;qwen-plus&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="string">&quot;deepseek&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel deepSeek()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DashScopeChatModel.builder()</span><br><span class="line">                        .dashScopeApi(DashScopeApi.builder()</span><br><span class="line">                                    .apiKey(System.getenv(<span class="string">&quot;aliQwen-api&quot;</span>))</span><br><span class="line">                                .build())</span><br><span class="line">                .defaultOptions(</span><br><span class="line">                        DashScopeChatOptions.builder().withModel(DEEPSEEK_MODEL).build()</span><br><span class="line">                )</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="string">&quot;qwen&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel qwen()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DashScopeChatModel.builder().dashScopeApi(DashScopeApi.builder()</span><br><span class="line">                        .apiKey(System.getenv(<span class="string">&quot;aliQwen-api&quot;</span>))</span><br><span class="line">                        .build())</span><br><span class="line">                .defaultOptions(</span><br><span class="line">                        DashScopeChatOptions.builder()</span><br><span class="line">                                .withModel(QWEN_MODEL)</span><br><span class="line">                                .build()</span><br><span class="line">                )</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="string">&quot;deepseekChatClient&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> ChatClient deepseekChatClient(<span class="meta">@Qualifier(<span class="string">&quot;deepseek&quot;</span>)</span> ChatModel deepSeek)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ChatClient.builder(deepSeek)</span><br><span class="line">                .defaultOptions(ChatOptions.builder()</span><br><span class="line">                        .model(DEEPSEEK_MODEL)</span><br><span class="line">                        .build())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="string">&quot;qwenChatClient&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> ChatClient qwenChatClient(<span class="meta">@Qualifier(<span class="string">&quot;qwen&quot;</span>)</span> ChatModel qwen)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ChatClient.builder(qwen)</span><br><span class="line">                .defaultOptions(ChatOptions.builder()</span><br><span class="line">                        .model(QWEN_MODEL)</span><br><span class="line">                        .build())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重点步骤</p><h4 id="1-新建记录类StudentRecord">1.新建记录类StudentRecord</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">study</span>.<span class="property">records</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-26 17:18</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> jdk14后的新特性，记录类替代lombok</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> record <span class="title class_">StudentRecord</span>(<span class="title class_">String</span> id,<span class="title class_">String</span> sname,<span class="title class_">String</span> major,<span class="title class_">String</span> email) &#123; &#125;</span><br></pre></td></tr></table></figure><h4 id="2-controllerV1">2.controllerV1</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.study.records.StudentRecord;</span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.function.Consumer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-26 17:16</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StructuredOutputController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource(name = <span class="string">&quot;qwenChatClient&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient qwenChatClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8007/structuredoutput/chat?sname=李四&amp;email=zzyybs@126.com</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sname</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/structuredoutput/chat&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> StudentRecord chat(String sname,String email)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> qwenChatClient.prompt()</span><br><span class="line">                .user(new Consumer&lt;ChatClient.PromptUserSpec&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> void accept(ChatClient.PromptUserSpec promptUserSpec)</span><br><span class="line">            &#123;</span><br><span class="line">                promptUserSpec.text(<span class="string">&quot;学号1001,我叫&#123;sname&#125;,大学专业是计算机科学与技术,邮箱&#123;email&#125;&quot;</span>)</span><br><span class="line">                        .param(<span class="string">&quot;sname&quot;</span>,sname)</span><br><span class="line">                        .param(<span class="string">&quot;email&quot;</span>,email);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).call().entity(StudentRecord.<span class="keyword">class</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-controllerV2">3.controllerV2</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.study.records.StudentRecord;</span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.function.Consumer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-26 17:16</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StructuredOutputController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource(name = <span class="string">&quot;qwenChatClient&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient qwenChatClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8007/structuredoutput/chat?sname=李四&amp;email=zzyybs@126.com</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sname</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/structuredoutput/chat&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> StudentRecord chat(String sname,String email)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> qwenChatClient.prompt()</span><br><span class="line">                .user(new Consumer&lt;ChatClient.PromptUserSpec&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> void accept(ChatClient.PromptUserSpec promptUserSpec)</span><br><span class="line">            &#123;</span><br><span class="line">                promptUserSpec.text(<span class="string">&quot;学号1001,我叫&#123;sname&#125;,大学专业是计算机科学与技术,邮箱&#123;email&#125;&quot;</span>)</span><br><span class="line">                        .param(<span class="string">&quot;sname&quot;</span>,sname)</span><br><span class="line">                        .param(<span class="string">&quot;email&quot;</span>,email);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).call().entity(StudentRecord.<span class="keyword">class</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8007/structuredoutput/chat2?sname=孙伟&amp;email=zzyybs@126.com</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sname</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/structuredoutput/chat2&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> StudentRecord chat2(<span class="meta">@RequestParam(name = <span class="string">&quot;sname&quot;</span>)</span> String sname,</span><br><span class="line">                               <span class="meta">@RequestParam(name = <span class="string">&quot;email&quot;</span>)</span> String email)</span><br><span class="line">    &#123;</span><br><span class="line">        String stringTemplate = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                学号1002,我叫&#123;sname&#125;,大学专业是软件工程,邮箱&#123;email&#125;</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> qwenChatClient.prompt()</span><br><span class="line">                .user(promptUserSpec -&gt; promptUserSpec.text(stringTemplate)</span><br><span class="line">                        .param(<span class="string">&quot;sname&quot;</span>,sname)</span><br><span class="line">                        .param(<span class="string">&quot;email&quot;</span>,email))</span><br><span class="line">                .call()</span><br><span class="line">                .entity(StudentRecord.<span class="keyword">class</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="9-Chat-Memory连续对话保存和持久化">9.Chat Memory连续对话保存和持久化</h2><h3 id="1-是什么-3">1.是什么</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-335.png" alt="img"></p><p>记忆对话，积累回答</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-336.png" alt="img"></p><p>一句话总结：Spring AI Alibaba中的聊天记忆提供了维护 AI 聊天应用程序的对话上下文和历史的机制</p><h4 id="记忆类型">记忆类型</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-337.png" alt="img"></p><p>因大模型本身不存储数据，需将历史对话信息一次性提供给它以实现连续对话，不然服务一重启就什么都没了……所以，必须持久化</p><h4 id="痛点2个">痛点2个</h4><ul><li>持久化媒介</li><li>消息对话窗口，聊天记录上限</li></ul><h3 id="2-持久化开发步骤">2.持久化开发步骤</h3><h4 id="1-业务类">1.业务类</h4><h5 id="前置知识">前置知识</h5><ul><li>ChatMemoryRepository接口</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-338-1024x459.png" alt="img"></p><p>1.实现SpringAI框架规定的ChatMemoryRepository接口</p><p>2.接口ChatMemoryRepository</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-339-1024x366.png" alt="img"></p><p>3.RedisChatMemoryRepository源码</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-340-1024x554.png" alt="img"></p><p>4.编码新建RedisMemoryConfig配置类</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.memory.redis.RedisChatMemoryRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.memory.ChatMemory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-28 18:24</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisMemoryConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Value(<span class="string">&quot;<span class="subst">$&#123;spring.data.redis.host&#125;</span>&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="meta">@Value(<span class="string">&quot;<span class="subst">$&#123;spring.data.redis.port&#125;</span>&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> int port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisChatMemoryRepository redisChatMemoryRepository()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> RedisChatMemoryRepository.builder()</span><br><span class="line">                    .host(host)</span><br><span class="line">                    .port(port)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>MessageWindowChatMemory 消息窗口聊天记忆</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-341.png" alt="img"></p><ul><li>顾问（Advisors）MessageChatMemoryAdvisor</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-342-1024x356.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-343-1024x616.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-345.png" alt="img"></p><h5 id="配置类SaaLLMConfig">配置类SaaLLMConfig</h5><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-347-1024x682.png" alt="img"></p><h5 id="controller">controller</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> static org.springframework.ai.chat.memory.ChatMemory.CONVERSATION_ID;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.function.Consumer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-28 18:40</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatMemory4RedisController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource(name = <span class="string">&quot;qwenChatClient&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient qwenChatClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/chatmemory/chat&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> String chat(String msg, String userId)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/*return qwenChatClient.prompt(msg).advisors(new Consumer&lt;ChatClient.AdvisorSpec&gt;()</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            @Override</span></span><br><span class="line"><span class="comment">            public void accept(ChatClient.AdvisorSpec advisorSpec)</span></span><br><span class="line"><span class="comment">            &#123;</span></span><br><span class="line"><span class="comment">                advisorSpec.param(CONVERSATION_ID, cid);</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;).call().content();*/</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> qwenChatClient.prompt(msg)</span><br><span class="line">                .advisors(advisorSpec -&gt; advisorSpec.param(CONVERSATION_ID, userId))</span><br><span class="line">                .call()</span><br><span class="line">                .content();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-测试">2.测试</h4><p><a href="http://localhost:8008/chatmemory/chat?msg=2%E5%8A%A05%E7%AD%89%E4%BA%8E%E5%A4%9A%E5%B0%91&amp;userId=7">http://localhost:8008/chatmemory/chat?msg=2加5等于多少&amp;userId=7</a></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-348.png" alt="img"></p><h2 id="10-文生图">10.文生图</h2><h3 id="1-阿里百炼文生图">1.阿里百炼文生图</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-349-1024x495.png" alt="img"></p><p><a href="https://help.aliyun.com/zh/model-studio/text-to-image?spm=a2c4g.11186623.help-menu-2400256.d_0_5_0.1a457d9dv6o7Kc&amp;accounttraceid=6ec3bf09599f424a91a2a88b27b31570nrdd">https://help.aliyun.com/zh/model-studio/text-to-image?spm=a2c4g.11186623.help-menu-2400256.d_0_5_0.1a457d9dv6o7Kc&amp;accounttraceid=6ec3bf09599f424a91a2a88b27b31570nrdd</a></p><h3 id="2-开发步骤-2">2.开发步骤</h3><p>通义万相-文生图V2版API参考</p><p><a href="https://help.aliyun.com/zh/model-studio/text-to-image-v2-api-reference?spm=a2c4g.11186623.0.0.79c74680qv54KQ">https://help.aliyun.com/zh/model-studio/text-to-image-v2-api-reference?spm=a2c4g.11186623.0.0.79c74680qv54KQ</a></p><h4 id="新建子模块Module">新建子模块Module</h4><p>SAA-09Text2image</p><h4 id="改POM-3">改POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SpringAIAlibaba-atguiguV1<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SAA-09Text2image<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--spring-ai-alibaba dashscope--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-alibaba-starter-dashscope<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--hutool--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-parameters<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="写YML-3">写YML</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="number">8009</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置响应的字符编码</span></span><br><span class="line"><span class="attr">server.servlet.encoding.charset</span>=utf-<span class="number">8</span></span><br><span class="line"><span class="attr">server.servlet.encoding.enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.force</span>=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.application.name</span>=SAA-<span class="number">09</span>Text2image</span><br><span class="line"></span><br><span class="line"><span class="comment"># ====SpringAIAlibaba Config=============</span></span><br><span class="line"><span class="attr">spring.ai.dashscope.api-key</span>=<span class="variable">$&#123;aliQwen-api&#125;</span></span><br></pre></td></tr></table></figure><h4 id="主启动-2">主启动</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">study</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">SpringApplication</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">autoconfigure</span>.<span class="property">SpringBootApplication</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Saa09Text2imageApplication</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="title function_">main</span>(<span class="params"><span class="title class_">String</span>[] args</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">SpringApplication</span>.<span class="title function_">run</span>(<span class="title class_">Saa09Text2</span>imageApplication.<span class="property">class</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="业务类-5">业务类</h4><p>controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.audio.DashScopeSpeechSynthesisModel;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.audio.DashScopeSpeechSynthesisOptions;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.audio.synthesis.SpeechSynthesisModel;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.audio.synthesis.SpeechSynthesisOptions;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.audio.synthesis.SpeechSynthesisPrompt;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.audio.synthesis.SpeechSynthesisResponse;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.image.DashScopeImageOptions;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.image.ImageModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.image.ImagePrompt;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-28 20:10</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> 知识出处</span></span><br><span class="line"><span class="comment"> * https://help.aliyun.com/zh/model-studio/text-to-image?spm=a2c4g.11186623.help-menu-2400256.d_0_5_0.1a457d9dv6o7Kc&amp;accounttraceid=6ec3bf09599f424a91a2a88b27b31570nrdd</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Text2ImageController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// img model</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">IMAGE_MODEL</span> <span class="operator">=</span> <span class="string">&quot;wanx2.1-t2i-turbo&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ImageModel imageModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/t2i/image&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">image</span><span class="params">(<span class="meta">@RequestParam(name = &quot;prompt&quot;,defaultValue = &quot;刺猬&quot;)</span> String prompt)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> imageModel.call(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">ImagePrompt</span>(prompt, DashScopeImageOptions.builder().withModel(IMAGE_MODEL).build())</span><br><span class="line">                )</span><br><span class="line">                .getResult()</span><br><span class="line">                .getOutput()</span><br><span class="line">                .getUrl();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="11-文生音">11.文生音</h2><h3 id="1-阿里百炼文生音">1.阿里百炼文生音</h3><h4 id="语音合成-CosyVoice">语音合成-CosyVoice</h4><p><a href="https://help.aliyun.com/zh/model-studio/cosyvoice-large-model-for-speech-synthesis/?spm=a2c4g.11186623.help-menu-2400256.d_2_6_0.2a7474473XyDNE&amp;scm=20140722.H_2817551._.OR_help-T_cn~zh-V_1">https://help.aliyun.com/zh/model-studio/cosyvoice-large-model-for-speech-synthesis/?spm=a2c4g.11186623.help-menu-2400256.d_2_6_0.2a7474473XyDNE&amp;scm=20140722.H_2817551._.OR_help-T_cn~zh-V_1</a></p><h4 id="语音合成CosyVoice-Java-SDK">语音合成CosyVoice Java SDK</h4><p><a href="https://help.aliyun.com/zh/model-studio/cosyvoice-java-sdk?spm=a2c4g.11186623.0.0.77e07447jgP4N0">https://help.aliyun.com/zh/model-studio/cosyvoice-java-sdk?spm=a2c4g.11186623.0.0.77e07447jgP4N0</a></p><h4 id="SpeechSynthesizer类提供了语音合成的关键接口">SpeechSynthesizer类提供了语音合成的关键接口</h4><p>同步提交语音合成任务，直接获取完整结果</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-350-1024x372.png" alt="img"></p><p>提交文本后，服务端立即处理并返回完整的语音合成结果。整个过程是阻塞式的，客户端需要等待服务端完成处理后才能继续下一步操作。适合短文本语音合成场景</p><p>阿里内置接口一览</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-351-1024x434.png" alt="img"></p><h4 id="DashScopeSpeechSynthesisOptions">DashScopeSpeechSynthesisOptions</h4><p>SpeechSynthesisParam的链式方法配置模型、音色等参数</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-352.png" alt="img"></p><p><a href="https://help.aliyun.com/zh/model-studio/cosyvoice-java-sdk#2e9a9a89aclc8">https://help.aliyun.com/zh/model-studio/cosyvoice-java-sdk#2e9a9a89aclc8</a></p><p>代码：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-353-1024x546.png" alt="img"></p><h3 id="2-开发步骤-3">2.开发步骤</h3><h4 id="新建子模块Module-2">新建子模块Module</h4><p>SAA-10Text2voice</p><h4 id="改POM-4">改POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SpringAIAlibaba-atguiguV1<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SAA-10Text2voice<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--spring-ai-alibaba dashscope--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-alibaba-starter-dashscope<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--hutool--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-parameters<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="写YML-4">写YML</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="number">8010</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置响应的字符编码</span></span><br><span class="line"><span class="attr">server.servlet.encoding.charset</span>=utf-<span class="number">8</span></span><br><span class="line"><span class="attr">server.servlet.encoding.enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.force</span>=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.application.name</span>=SAA-<span class="number">10</span>Text2voice</span><br><span class="line"></span><br><span class="line"><span class="comment"># ====SpringAIAlibaba Config=============</span></span><br><span class="line"><span class="attr">spring.ai.dashscope.api-key</span>=<span class="variable">$&#123;aliQwen-api&#125;</span></span><br></pre></td></tr></table></figure><h4 id="主启动-3">主启动</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">study</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">SpringApplication</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">autoconfigure</span>.<span class="property">SpringBootApplication</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Saa10Text2voiceApplication</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="title function_">main</span>(<span class="params"><span class="title class_">String</span>[] args</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">SpringApplication</span>.<span class="title function_">run</span>(<span class="title class_">Saa10Text2</span>voiceApplication.<span class="property">class</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="业务类-6">业务类</h4><p>音色列表配置</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-354.png" alt="img"></p><p><a href="https://help.aliyun.com/zh/model-studio/cosyvoice-java-sdk#722dd7ca66a6x">https://help.aliyun.com/zh/model-studio/cosyvoice-java-sdk#722dd7ca66a6x</a></p><p>controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.audio.DashScopeSpeechSynthesisOptions;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.audio.synthesis.SpeechSynthesisModel;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.audio.synthesis.SpeechSynthesisPrompt;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.audio.synthesis.SpeechSynthesisResponse;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-29 18:35</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Text2VoiceController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SpeechSynthesisModel speechSynthesisModel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// voice model</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BAILIAN_VOICE_MODEL</span> <span class="operator">=</span> <span class="string">&quot;cosyvoice-v2&quot;</span>;</span><br><span class="line">    <span class="comment">// voice timber 音色列表：https://help.aliyun.com/zh/model-studio/cosyvoice-java-sdk#722dd7ca66a6x</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BAILIAN_VOICE_TIMBER</span> <span class="operator">=</span> <span class="string">&quot;longyingcui&quot;</span>;<span class="comment">//龙应催</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8010/t2v/voice</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/t2v/voice&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">voice</span><span class="params">(<span class="meta">@RequestParam(name = &quot;msg&quot;,defaultValue = &quot;温馨提醒，支付宝到账100元请注意查收&quot;)</span> String msg)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> <span class="string">&quot;d:\\&quot;</span> + UUID.randomUUID() + <span class="string">&quot;.mp3&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1 语音参数设置</span></span><br><span class="line">        <span class="type">DashScopeSpeechSynthesisOptions</span> <span class="variable">options</span> <span class="operator">=</span> DashScopeSpeechSynthesisOptions.builder()</span><br><span class="line">                .model(BAILIAN_VOICE_MODEL)</span><br><span class="line">                .voice(BAILIAN_VOICE_TIMBER)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2 调用大模型语音生成对象</span></span><br><span class="line">        <span class="type">SpeechSynthesisResponse</span> <span class="variable">response</span> <span class="operator">=</span> speechSynthesisModel.call(<span class="keyword">new</span> <span class="title class_">SpeechSynthesisPrompt</span>(msg, options));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3 字节流语音转换</span></span><br><span class="line">        <span class="type">ByteBuffer</span> <span class="variable">byteBuffer</span> <span class="operator">=</span> response.getResult().getOutput().getAudio();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4 文件生成</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(filePath))</span><br><span class="line">        &#123;</span><br><span class="line">            fileOutputStream.write(byteBuffer.array());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//5 生成路径OK</span></span><br><span class="line">        <span class="keyword">return</span> filePath;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="12-向量化和向量数据库">12.向量化和向量数据库</h2><h3 id="1-向量">1.向量</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-355-1024x189.png" alt="img"></p><h3 id="2-文本向量化">2.文本向量化</h3><h4 id="1-是什么-4">1.是什么</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-356-1024x443.png" alt="img"></p><p>官网-嵌入模型 (Embedding Model)</p><p><a href="https://java2ai.com/docs/1.0.0.2/tutorials/basics/embedding/?spm=5176.29160081.0.0.2856aa5cXggpMJ">https://java2ai.com/docs/1.0.0.2/tutorials/basics/embedding/?spm=5176.29160081.0.0.2856aa5cXggpMJ</a></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-357.png" alt="img"></p><h4 id="案例1">案例1</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-358.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-359.png" alt="img"></p><h4 id="案列2">案列2</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-360.png" alt="img"></p><h4 id="嵌入模型小总结">嵌入模型小总结</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-361.png" alt="img"></p><h3 id="3-向量数据库">3.向量数据库</h3><h4 id="1-向量存储是什么">1.向量存储是什么</h4><p>官网-向量存储(Vector Store）</p><p><a href="https://java2ai.com/docs/1.0.0.2/tutorials/basics/vectorstore/?spm=5176.29160081.0.0.2856aa5cXggpMJ">https://java2ai.com/docs/1.0.0.2/tutorials/basics/vectorstore/?spm=5176.29160081.0.0.2856aa5cXggpMJ</a></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-362.png" alt="img"></p><p>一句话：一种专门用于存储、管理和检索向量数据（即高维数值数组）的数据库系统。</p><p>其核心功能是通过高效的索引结构和相似性计算算法，支持大规模向量数据的快速查询与分析，向量数据库维度越高，查询精准度也越高，查询效果也越好。</p><p>下方是LangChain4J支持的向量数据库List清单</p><p><a href="https://docs.langchain4j.dev/integrations/embedding-stores">https://docs.langchain4j.dev/integrations/embedding-stores</a></p><p>下方是SpringAI支持的向量数据库List清单</p><p><a href="https://docs.spring.io/spring-ai/reference/api/vectordbs.html">https://docs.spring.io/spring-ai/reference/api/vectordbs.html</a></p><h4 id="2-向量数据库能干嘛">2.向量数据库能干嘛</h4><p>将文本、图像和视频转换为称为向量（Vectors）的浮点数数组在 VectorStore中，查询与传统关系数据库不同。它们执行相似性搜索，而不是精确匹配。当给定一个向量作为查询时，VectorStore 返回与查询向量“相似”的向量</p><h5 id="指征特点">指征特点</h5><ul><li>捕捉复杂的词汇关系（如语义相似性、同义词、多义词）</li><li>向量嵌入为检索增强生成 (RAG) 应用程序提供支持</li></ul><h5 id="小总结">小总结</h5><ul><li>将文本映射到高维空间中的点，使语义相似的文本在这个空间中距离较近。<ul><li>例如，“肯德基”和”麦当劳”的向量可能会比”肯德基”和”新疆大盘鸡”的向量更接近</li></ul></li></ul><h3 id="4-开发步骤-2">4.开发步骤</h3><h4 id="1-用redisStack作为向量存储">1.用redisStack作为向量存储</h4><p><a href="https://docs.spring.io/spring-ai/reference/api/vectordbs/redis.html">https://docs.spring.io/spring-ai/reference/api/vectordbs/redis.html</a></p><p>RedisStack是什么</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-363.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-364.png" alt="img"></p><p>RedisStack核心组件</p><ul><li>RediSearch：提供全文搜索能力，支持复杂的文本搜索、聚合和过滤，以及向量数据的存储和检索</li><li>RedisJSON：原生支持JSON数据的存储、索引I和查询，可高效存储和操作嵌套的JSON文档。</li><li>RedisGraph：支持图数据模型，使用Cypher查询语言进行图遍历查询。</li><li>RedisBloom:支持 Bloom、Cuckoo、Count-Min Sketch等概率数据结构。</li></ul><h5 id="一句话-重要"><strong>一句话(重要)</strong></h5><p>RedisStack = 原生Redis + 搜索 + 图 + 时间序列 + JSON + 概率结构 + 可视化工具 + 开发框架支持</p><p>RedisStack安装</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name redis-stack-server -p <span class="number">6379</span>:<span class="number">6379</span> redis/redis-stack-server</span><br></pre></td></tr></table></figure><h5 id="基础api">基础api</h5><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-365.png" alt="img"></p><h4 id="2-业务类">2.业务类</h4><p>知识出处</p><p><a href="https://docs.spring.io/spring-ai/reference/api/vectordbs.html">https://docs.spring.io/spring-ai/reference/api/vectordbs.html</a></p><p>controller 文本向量化 向量化存储 向量化查询</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.embedding.DashScopeEmbeddingOptions;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.document.Document;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.embedding.EmbeddingModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.embedding.EmbeddingRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.embedding.EmbeddingResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.vectorstore.SearchRequest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.vectorstore.VectorStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-29 19:54</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Embed2VectorController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> EmbeddingModel embeddingModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> VectorStore vectorStore;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文本向量化</span></span><br><span class="line"><span class="comment">     * http://localhost:8011/text2embed?msg=射雕英雄传</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/text2embed&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> EmbeddingResponse <span class="title function_">text2Embed</span><span class="params">(String msg)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//EmbeddingResponse embeddingResponse = embeddingModel.call(new EmbeddingRequest(List.of(msg), null));</span></span><br><span class="line"></span><br><span class="line">        <span class="type">EmbeddingResponse</span> <span class="variable">embeddingResponse</span> <span class="operator">=</span> embeddingModel.call(<span class="keyword">new</span> <span class="title class_">EmbeddingRequest</span>(List.of(msg),</span><br><span class="line">                DashScopeEmbeddingOptions.builder().withModel(<span class="string">&quot;text-embedding-v3&quot;</span>).build()));</span><br><span class="line"></span><br><span class="line">        System.out.println(Arrays.toString(embeddingResponse.getResult().getOutput()));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> embeddingResponse;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/embed2vector/add&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        List&lt;Document&gt; documents = List.of(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Document</span>(<span class="string">&quot;i study LLM&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Document</span>(<span class="string">&quot;i love java&quot;</span>)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        vectorStore.add(documents);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/embed2vector/get&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List <span class="title function_">getAll</span><span class="params">(<span class="meta">@RequestParam(name = &quot;msg&quot;)</span> String msg)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> SearchRequest.builder()</span><br><span class="line">                .query(msg)</span><br><span class="line">                .topK(<span class="number">2</span>)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        List&lt;Document&gt; list = vectorStore.similaritySearch(searchRequest);</span><br><span class="line"></span><br><span class="line">        System.out.println(list);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><ul><li><a href="http://localhost:8011/text2embed?msg=%E5%B0%84%E9%9B%95%E8%8B%B1%E9%9B%84%E4%BC%A0">http://localhost:8011/text2embed?msg=射雕英雄传</a></li><li><a href="http://localhost:8011/embed2vector/get?msg=LLM">http://localhost:8011/embed2vector/get?msg=LLM</a></li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-366-1024x469.png" alt="img"></p><h4 id="3-实现原理">3.实现原理</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-367.png" alt="img"></p><h2 id="13-RAG（Retrieval-Augmented-Generation）">13.RAG（Retrieval Augmented Generation）</h2><h3 id="1-前言">1.前言</h3><p>RAG (Retrieval-Augmented Generation)检索增强生成</p><p>需求</p><ul><li>AI智能运维助手，通过提供的错误编码，给出异常解释辅助运维人员更好的定位问题和维护系统</li><li>SpringAI+阿里百炼嵌入模型text-embedding-v3+向量数据库RedisStack+DeepSeek来实现RAG功能。</li></ul><p>LLM的缺陷</p><ul><li>LLM的知识不是实时的，不具备知识更新.</li><li>LLM可能不知道你私有的领域/业务知识.</li><li>LLM有时会在回答中生成看似合理但实际上是错误的信息</li></ul><h3 id="2-RAG是什么">2.RAG是什么</h3><p>官网</p><p>RAG (Retrieval-Augmented Generation)</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-368.png" alt="img"></p><p>LLM 的知识仅限于它所接受的训练数据。如果你想让一个 LLM 了解特定领域的知识或专有数据，你可以</p><h4 id="什么是RAG">什么是RAG?</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-369.png" alt="img"></p><h4 id="幻觉？">幻觉？</h4><ul><li>已读乱回</li><li>已读不回</li><li>似是而非</li></ul><p>springai中的RAG</p><p><a href="https://docs.spring.io/spring-ai/reference/api/retrieval-augmented-generation.html">https://docs.spring.io/spring-ai/reference/api/retrieval-augmented-generation.html</a></p><h4 id="springai-alibaba中的RAG叫做文档检索-Document-Retriever">springai alibaba中的RAG叫做文档检索 (Document Retriever)</h4><p><a href="https://java2ai.com/docs/1.0.0.2/tutorials/basics/retriever/?spm=5176.29160081.0.0.2856aa5cXggpMJ">https://java2ai.com/docs/1.0.0.2/tutorials/basics/retriever/?spm=5176.29160081.0.0.2856aa5cXggpMJ</a></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-370-1024x483.png" alt="img"></p><h3 id="3-RAG核心设计理念">3.RAG核心设计理念</h3><p>RAG技术就像给AI大模型装上了「实时百科大脑」，为了让大模型获取足够的上下文，以便获得更加广泛的信息源，通过先查资料后回答的机制，让AI摆脱传统模型的”知识遗忘和幻觉回复”困境</p><p>一句话</p><p>类似考试时有不懂的，给你准备了小抄，对大模型知识盲区的一种补充</p><h3 id="4-RAG能干嘛">4.RAG能干嘛</h3><p>通过引入外部知识源来增强LLM的输出能力，传统的LLM通常基于其训练数据生成响应，但这些数据可能过时或不够全面。RAG允许模型在生成答案之前，从特定的知识库中检索相关信息，从而提供更准确和上下文相关的回答</p><h3 id="5-RAG怎么用">5.RAG怎么用</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-371.png" alt="img"></p><p>RAG流程分为两个不同的阶段：索引和检索</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-372.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-373.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-374.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-375.png" alt="img"></p><h3 id="6-开发步骤">6.开发步骤</h3><p>需求：</p><ul><li>AI智能运维助手，通过提供的错误编码，给出异常解释辅助运维人员更好的定位问题和维护系统</li><li>SpringAI+阿里百炼嵌入模型text-embedding-v3+向量数据库RedisStack+DeepSeek来实现RAG功能。</li></ul><h4 id="建Module">建Module</h4><p>SAA-12RAG4AiOps</p><h4 id="改POM-5">改POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SpringAIAlibaba-atguiguV1<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SAA-12RAG4AiOps<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--spring-ai-alibaba dashscope--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-alibaba-starter-dashscope<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 添加 Redis 向量数据库依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-starter-vector-store-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--hutool--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-parameters<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="写YML-5">写YML</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="number">8012</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置全局编码格式</span></span><br><span class="line"><span class="attr">server.servlet.encoding.enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.force</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.charset</span>=UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.application.name</span>=SAA-<span class="number">12</span>RAG4AiDatabase</span><br><span class="line"></span><br><span class="line"><span class="comment"># ====SpringAIAlibaba Config=============</span></span><br><span class="line"><span class="attr">spring.ai.dashscope.api-key</span>=<span class="variable">$&#123;aliQwen-api&#125;</span></span><br><span class="line"><span class="attr">spring.ai.dashscope.chat.options.model</span>=deepseek-r1</span><br><span class="line"><span class="attr">spring.ai.dashscope.embedding.options.model</span>=text-embedding-v3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># =======Redis Stack==========</span></span><br><span class="line"><span class="attr">spring.data.redis.host</span>=localhost</span><br><span class="line"><span class="attr">spring.data.redis.port</span>=<span class="number">6379</span></span><br><span class="line"><span class="attr">spring.data.redis.username</span>=default</span><br><span class="line"><span class="attr">spring.data.redis.password</span>=</span><br><span class="line"><span class="attr">spring.ai.vectorstore.redis.initialize-schema</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">spring.ai.vectorstore.redis.index-name</span>=atguigu-index</span><br><span class="line"><span class="attr">spring.ai.vectorstore.redis.prefix</span>=atguigu-prefix</span><br></pre></td></tr></table></figure><p>阿里云百炼平台向量大模型 text-embedding-v3</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-376-1024x505.png" alt="img"></p><p>配置参考信息来源和知识出处</p><p><a href="https://docs.spring.io/spring-ai/reference/api/vectordbs/redis.html">https://docs.spring.io/spring-ai/reference/api/vectordbs/redis.html</a></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-377.png" alt="img"></p><h4 id="主启动-4">主启动</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">study</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">SpringApplication</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">autoconfigure</span>.<span class="property">SpringBootApplication</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Saa12Rag4AiOpsApplication</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="title function_">main</span>(<span class="params"><span class="title class_">String</span>[] args</span>)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">SpringApplication</span>.<span class="title function_">run</span>(<span class="title class_">Saa12Rag4AiOpsApplication</span>.<span class="property">class</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="提供ErrorCode脚本让他存入向量数据库RedisStack，形成文档知识库">提供ErrorCode脚本让他存入向量数据库RedisStack，形成文档知识库</h4><p>ops.txt</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000</span> 系统OK正确执行后的返回</span><br><span class="line">A0001 用户端错误一级宏观错误码</span><br><span class="line">A0100 用户注册错误二级宏观错误码</span><br><span class="line"><span class="keyword">B1111 </span>支付接口超时</span><br><span class="line">C2222 Kafka消息解压严重</span><br></pre></td></tr></table></figure><h3 id="7-业务类第一版">7.业务类第一版</h3><h4 id="SpringAI源代码接口-VectorStore">SpringAI源代码接口 VectorStore</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-378-1024x375.png" alt="img"></p><h4 id="用redis作为向量存储">用redis作为向量存储</h4><p>安装 redis-stack-server</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name redis-stack-server -p <span class="number">6379</span>:<span class="number">6379</span> redis/redis-stack-server</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-379.png" alt="img"></p><h4 id="配置类">配置类</h4><p>配置类LLMConfig</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.api.DashScopeApi;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.chat.DashScopeChatModel;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.chat.DashScopeChatOptions;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.ChatOptions;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.rag.advisor.RetrievalAugmentationAdvisor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.rag.retrieval.search.VectorStoreDocumentRetriever;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.vectorstore.VectorStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-25 18:53</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> ChatModel+ChatClient+多模型共存</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SaaLLMConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 模型名称常量定义</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String DEEPSEEK_MODEL = <span class="string">&quot;deepseek-v3&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String QWEN_MODEL = <span class="string">&quot;qwen-plus&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="string">&quot;deepseek&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel deepSeek()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DashScopeChatModel.builder()</span><br><span class="line">                        .dashScopeApi(DashScopeApi.builder()</span><br><span class="line">                                    .apiKey(System.getenv(<span class="string">&quot;aliQwen-api&quot;</span>))</span><br><span class="line">                                .build())</span><br><span class="line">                .defaultOptions(</span><br><span class="line">                        DashScopeChatOptions.builder().withModel(DEEPSEEK_MODEL).build()</span><br><span class="line">                )</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="string">&quot;qwen&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> ChatModel qwen()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DashScopeChatModel.builder().dashScopeApi(DashScopeApi.builder()</span><br><span class="line">                        .apiKey(System.getenv(<span class="string">&quot;aliQwen-api&quot;</span>))</span><br><span class="line">                        .build())</span><br><span class="line">                .defaultOptions(</span><br><span class="line">                        DashScopeChatOptions.builder()</span><br><span class="line">                                .withModel(QWEN_MODEL)</span><br><span class="line">                                .build()</span><br><span class="line">                )</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="string">&quot;deepseekChatClient&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> ChatClient deepseekChatClient(<span class="meta">@Qualifier(<span class="string">&quot;deepseek&quot;</span>)</span> ChatModel deepSeek)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ChatClient.builder(deepSeek)</span><br><span class="line">                .defaultOptions(ChatOptions.builder()</span><br><span class="line">                        .model(DEEPSEEK_MODEL)</span><br><span class="line">                        .build())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="string">&quot;qwenChatClient&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> ChatClient qwenChatClient(<span class="meta">@Qualifier(<span class="string">&quot;qwen&quot;</span>)</span> ChatModel qwen)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ChatClient.builder(qwen)</span><br><span class="line">                .defaultOptions(ChatOptions.builder()</span><br><span class="line">                        .model(QWEN_MODEL)</span><br><span class="line">                        .build())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>InitVectorDatabaseConfig(第一版)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.crypto.SecureUtil;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.document.Document;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.reader.TextReader;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.transformer.splitter.TokenTextSplitter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.vectorstore.VectorStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-30 12:16</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InitVectorDatabaseConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> VectorStore vectorStore;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;classpath:ops.txt&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Resource sqlFile;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 1.读取文件</span></span><br><span class="line">        <span class="type">TextReader</span> <span class="variable">textReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TextReader</span>(sqlFile);</span><br><span class="line">        textReader.setCharset(Charset.defaultCharset());</span><br><span class="line">        <span class="comment">// 2.文件转换成向量（分词）</span></span><br><span class="line">        List&lt;Document&gt; list = <span class="keyword">new</span> <span class="title class_">TokenTextSplitter</span>().transform(textReader.read());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.写入向量数据库（Redis）,无法去重复版</span></span><br><span class="line">        vectorStore.add(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Controller">Controller</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.rag.advisor.RetrievalAugmentationAdvisor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.rag.retrieval.search.VectorStoreDocumentRetriever;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.vectorstore.VectorStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-30 12:21</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RagController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource(name = <span class="string">&quot;qwenChatClient&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient chatClient;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> VectorStore vectorStore;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8012/rag4aiops?msg=00000</span></span><br><span class="line"><span class="comment">     * http://localhost:8012/rag4aiops?msg=C2222</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/rag4aiops&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; rag(String msg)</span><br><span class="line">    &#123;</span><br><span class="line">        String systemInfo = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                你是一个运维工程师,按照给出的编码给出对应故障解释,否则回复找不到信息。</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        RetrievalAugmentationAdvisor advisor = RetrievalAugmentationAdvisor.builder()</span><br><span class="line">                .documentRetriever(</span><br><span class="line">                        VectorStoreDocumentRetriever.builder()</span><br><span class="line">                                .vectorStore(vectorStore)</span><br><span class="line">                                .build()</span><br><span class="line">                )</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> chatClient.prompt()</span><br><span class="line">                .system(systemInfo)</span><br><span class="line">                .user(msg)</span><br><span class="line">                .advisors(advisor) <span class="comment">// RAG功能,向量数据库查询</span></span><br><span class="line">                .stream()</span><br><span class="line">                .content();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="测试">测试</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-380.png" alt="img"></p><h4 id="其它问题">其它问题</h4><p>重启下微服务：重复数据写入问题需考虑，不然每次重启都要新增</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-381.png" alt="img"></p><h3 id="8-业务类第二版-向量数据库去重问题解决">8.业务类第二版 向量数据库去重问题解决</h3><h4 id="使用RedisSetNX去重">使用RedisSetNX去重</h4><p>RedisConfig</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">zzyy</span>.<span class="property">study</span>.<span class="property">config</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.<span class="property">extern</span>.<span class="property">slf4j</span>.<span class="property">Slf4j</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">context</span>.<span class="property">annotation</span>.<span class="property">Bean</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">context</span>.<span class="property">annotation</span>.<span class="property">Configuration</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">data</span>.<span class="property">redis</span>.<span class="property">connection</span>.<span class="property">RedisConnectionFactory</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">data</span>.<span class="property">redis</span>.<span class="property">core</span>.<span class="property">RedisTemplate</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">data</span>.<span class="property">redis</span>.<span class="property">serializer</span>.<span class="property">GenericJackson2JsonRedisSerializer</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">data</span>.<span class="property">redis</span>.<span class="property">serializer</span>.<span class="property">StringRedisSerializer</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> <span class="variable">zzyy</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2024-03-07 10:45</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * RedisTemplate配置</span></span><br><span class="line"><span class="comment">     * redis序列化的工具配置类，下面这个请一定开启配置</span></span><br><span class="line"><span class="comment">     * 127.0.0.1:6379&gt; keys *</span></span><br><span class="line"><span class="comment">     * 1) &quot;ord:102&quot;  序列化过</span></span><br><span class="line"><span class="comment">     * 2) &quot;\xac\xed\x00\x05t\x00\aord:102&quot;   野生，没有序列化过</span></span><br><span class="line"><span class="comment">     * this.redisTemplate.opsForValue(); //提供了操作string类型的所有方法</span></span><br><span class="line"><span class="comment">     * this.redisTemplate.opsForList(); // 提供了操作list类型的所有方法</span></span><br><span class="line"><span class="comment">     * this.redisTemplate.opsForSet(); //提供了操作set的所有方法</span></span><br><span class="line"><span class="comment">     * this.redisTemplate.opsForHash(); //提供了操作hash表的所有方法</span></span><br><span class="line"><span class="comment">     * this.redisTemplate.opsForZSet(); //提供了操作zset的所有方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> <span class="variable">redisConnectionFactor</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">RedisTemplate</span>&lt;<span class="title class_">String</span>, <span class="title class_">Object</span>&gt; <span class="title function_">redisTemplate</span>(<span class="params"><span class="title class_">RedisConnectionFactory</span> redisConnectionFactor</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">RedisTemplate</span>&lt;<span class="title class_">String</span>,<span class="title class_">Object</span>&gt; redisTemplate = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        redisTemplate.<span class="title function_">setConnectionFactory</span>(redisConnectionFactor);</span><br><span class="line">        <span class="comment">//设置key序列化方式string</span></span><br><span class="line">        redisTemplate.<span class="title function_">setKeySerializer</span>(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        <span class="comment">//设置value的序列化方式json，使用GenericJackson2JsonRedisSerializer替换默认序列化</span></span><br><span class="line">        redisTemplate.<span class="title function_">setValueSerializer</span>(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line"></span><br><span class="line">        redisTemplate.<span class="title function_">setHashKeySerializer</span>(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        redisTemplate.<span class="title function_">setHashValueSerializer</span>(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line"></span><br><span class="line">        redisTemplate.<span class="title function_">afterPropertiesSet</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="InitVectorDatabaseConfig-第二版">InitVectorDatabaseConfig(第二版)</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.crypto.SecureUtil;</span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="keyword">annotation</span>.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.document.Document;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.reader.TextReader;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.transformer.splitter.TokenTextSplitter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.vectorstore.AbstractVectorStoreBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.vectorstore.VectorStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.<span class="keyword">data</span>.redis.core.RedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-30 12:16</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InitVectorDatabaseConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> VectorStore vectorStore;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String,String&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(<span class="string">&quot;classpath:ops.txt&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> Resource opsFile;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> void <span class="keyword">init</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//1 读取文件</span></span><br><span class="line">        TextReader textReader = new TextReader(opsFile);</span><br><span class="line">        textReader.setCharset(Charset.defaultCharset());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2 文件转换为向量(开启分词)</span></span><br><span class="line">        List&lt;Document&gt; list = new TokenTextSplitter().transform(textReader.read());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3 写入向量数据库RedisStack</span></span><br><span class="line">        <span class="comment">//vectorStore.add(list);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解决上面第3步，向量数据重复问题，使用redis setnx命令处理</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//4 去重复版本</span></span><br><span class="line"></span><br><span class="line">        String sourceMetadata = (String)textReader.getCustomMetadata().<span class="keyword">get</span>(<span class="string">&quot;source&quot;</span>);</span><br><span class="line"></span><br><span class="line">        String textHash = SecureUtil.md5(sourceMetadata);</span><br><span class="line">        String redisKey = <span class="string">&quot;vector-xxx:&quot;</span> + textHash;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断是否存入过,redisKey如果可以成功插入表示以前没有过，可以假如向量数据</span></span><br><span class="line">        <span class="built_in">Boolean</span> retFlag = redisTemplate.opsForValue().setIfAbsent(redisKey, <span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">&quot;****retFlag : &quot;</span>+retFlag);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">Boolean</span>.TRUE.equals(retFlag))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//键不存在，首次插入,可以保存进向量数据库</span></span><br><span class="line">            vectorStore.add(list);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//键已存在，跳过或者报错</span></span><br><span class="line">            <span class="comment">//throw new RuntimeException(&quot;---重复操作&quot;);</span></span><br><span class="line">            System.<span class="keyword">out</span>.println(<span class="string">&quot;------向量初始化数据已经加载过，请不要重复操作&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>优点：性能高+线程安全问题OK</p><h4 id="controller-2">controller</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.rag.advisor.RetrievalAugmentationAdvisor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.rag.retrieval.search.VectorStoreDocumentRetriever;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.vectorstore.VectorStore;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-30 12:21</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RagController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource(name = <span class="string">&quot;qwenChatClient&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient chatClient;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> VectorStore vectorStore;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8012/rag4aiops?msg=00000</span></span><br><span class="line"><span class="comment">     * http://localhost:8012/rag4aiops?msg=C2222</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/rag4aiops&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; rag(String msg)</span><br><span class="line">    &#123;</span><br><span class="line">        String systemInfo = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                你是一个运维工程师,按照给出的编码给出对应故障解释,否则回复找不到信息。</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        RetrievalAugmentationAdvisor advisor = RetrievalAugmentationAdvisor.builder()</span><br><span class="line">                .documentRetriever(</span><br><span class="line">                        VectorStoreDocumentRetriever.builder()</span><br><span class="line">                                .vectorStore(vectorStore)</span><br><span class="line">                                .build()</span><br><span class="line">                )</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> chatClient.prompt()</span><br><span class="line">                .system(systemInfo)</span><br><span class="line">                .user(msg)</span><br><span class="line">                .advisors(advisor) <span class="comment">// RAG功能,向量数据库查询</span></span><br><span class="line">                .stream()</span><br><span class="line">                .content();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="14-Tool-Calling工具调用">14.Tool Calling工具调用</h2><h3 id="1-为什么需要工具调用？">1.为什么需要工具调用？</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-382-1024x628.png" alt="img"></p><h3 id="2-工具调用是什么">2.工具调用是什么</h3><h4 id="官网-3">官网</h4><p>SpringAI</p><p><a href="https://docs.spring.io/spring-ai/reference/api/tools.html">https://docs.spring.io/spring-ai/reference/api/tools.html</a></p><p>SpringAI Alibba</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-383.png" alt="img"></p><p><a href="https://java2ai.com/docs/1.0.0.2/tutorials/basics/tool-calling/?spm=5176.29160081.0.0.2856aa5cgvn0gm">https://java2ai.com/docs/1.0.0.2/tutorials/basics/tool-calling/?spm=5176.29160081.0.0.2856aa5cgvn0gm</a></p><p>一句话：LLM的外部utils工具类</p><h4 id="重要提示">重要提示:</h4><ul><li>ToolCalling(也称为FunctionCalling)它允许大模型与一组API或工具进行交互，将 LLM 的智能与外部工具或 API无缝连接，从而增强大模型其功能。</li><li>LLM本身并不执行函数,它只是指示应该调用哪个函数以及如何调用</li></ul><h3 id="3-工具调用能干嘛">3.工具调用能干嘛</h3><ul><li>1.访问实时数据</li><li>2.执行某种工具类/辅助类操作：大语言模型(LLMs)不仅仅是文本生成的能手,它们还能触发并调用第3方函数，比如发邮件/查询微信/调用支付宝/查看顺丰快递单据号等等……</li></ul><h3 id="4-工具调用怎么用">4.工具调用怎么用</h3><p>工作流程</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-384.png" alt="img"></p><h3 id="5-开发步骤">5.开发步骤</h3><h4 id="新建子模块Module-3">新建子模块Module</h4><p>SAA-13ToolCalling</p><h4 id="改POM-6">改POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SpringAIAlibaba-atguiguV1<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SAA-13ToolCalling<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--spring-ai-alibaba dashscope--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-alibaba-starter-dashscope<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--hutool--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-parameters<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="写YML-6">写YML</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="number">8013</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置全局编码格式</span></span><br><span class="line"><span class="attr">server.servlet.encoding.enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.force</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.charset</span>=UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.application.name</span>=SAA-<span class="number">13</span>ToolCalling</span><br><span class="line"></span><br><span class="line"><span class="comment"># ====SpringAIAlibaba Config=============</span></span><br><span class="line"><span class="attr">spring.ai.dashscope.api-key</span>=<span class="variable">$&#123;aliQwen-api&#125;</span></span><br></pre></td></tr></table></figure><h4 id="主启动-5">主启动</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">study</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">SpringApplication</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">autoconfigure</span>.<span class="property">SpringBootApplication</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Saa13ToolCallingApplication</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="title function_">main</span>(<span class="params"><span class="title class_">String</span>[] args</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">SpringApplication</span>.<span class="title function_">run</span>(<span class="title class_">Saa13ToolCallingApplication</span>.<span class="property">class</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-业务类">6.业务类</h3><h4 id="1-先不使用ToolCalling">1.先不使用ToolCalling</h4><p>没有配置类LLMConfig</p><p>controller</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.api.DashScopeApi;</span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-31 20:26</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NoToolCallingController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel chatModel;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/notoolcall/chat&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; chat(<span class="meta">@RequestParam(name = <span class="string">&quot;msg&quot;</span>,defaultValue = <span class="string">&quot;你是谁现在几点&quot;</span>)</span> String msg)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> chatModel.stream(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-385-1024x162.png" alt="img"></p><h4 id="2-投入使用ToolCalling">2.投入使用ToolCalling</h4><h5 id="方式1通过ChatModel实现">方式1通过ChatModel实现</h5><p>没有配置类LLMConfig</p><p>新建Tool工具类，类似Utils工具类</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.tool.<span class="keyword">annotation</span>.Tool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-31 20:39</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DateTimeTools</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1.定义 function call（tool call）</span></span><br><span class="line"><span class="comment">     * 2. returnDirect</span></span><br><span class="line"><span class="comment">     *    true = tool直接返回不走大模型，直接给客户</span></span><br><span class="line"><span class="comment">     *    false = 拿到tool返回的结果，给大模型，最后由大模型回复</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Tool(description = <span class="string">&quot;获取当前时间&quot;</span>, returnDirect = false)</span></span><br><span class="line">    <span class="keyword">public</span> String getCurrentTime()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> LocalDateTime.now().toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>工具调用直接返回</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-386.png" alt="img"></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.study.utils.DateTimeTools;</span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.ChatOptions;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.Prompt;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.model.tool.ToolCallingChatOptions;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.support.ToolCallbacks;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.tool.ToolCallback;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-31 20:40</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ToolCallingController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel chatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/toolcall/chat&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> String chat(<span class="meta">@RequestParam(name = <span class="string">&quot;msg&quot;</span>,defaultValue = <span class="string">&quot;你是谁，现在几点了&quot;</span>)</span> String msg)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 1.工具注册到工具集合里</span></span><br><span class="line">        ToolCallback[] tools = ToolCallbacks.from(new DateTimeTools());</span><br><span class="line">        <span class="comment">// 2.将工具集配置进ChatOptions对象</span></span><br><span class="line">        ChatOptions options = ToolCallingChatOptions.builder().toolCallbacks(tools).build();</span><br><span class="line">        <span class="comment">// 3.构建提示词</span></span><br><span class="line">        Prompt prompt = new Prompt(msg, options);</span><br><span class="line">        <span class="comment">// 4.调用大模型</span></span><br><span class="line">        <span class="keyword">return</span> chatModel.call(prompt).getResult().getOutput().getText();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="http://localhost:8013/toolcall/chat%E5%90%8E%E5%B0%B1%E8%83%BD%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8D%E6%97%B6%E9%97%B4%E4%BA%86">http://localhost:8013/toolcall/chat后就能查看当前时间了</a></p><h5 id="方式2通过ChatClient实现">方式2通过ChatClient实现</h5><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-387.png" alt="img"></p><p>复习一下：它本身不会自动装配，直接定义无法使用，需要ChatModel套层壳</p><p>配置类LLMConfig</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-31 20:47</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SaaLLMConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatClient chatClient(ChatModel chatModel)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ChatClient.builder(chatModel).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Controller</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">study</span>.<span class="property">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.<span class="property">atguigu</span>.<span class="property">study</span>.<span class="property">utils</span>.<span class="property">DateTimeTools</span>;</span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="property">annotation</span>.<span class="property">Resource</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">ai</span>.<span class="property">chat</span>.<span class="property">client</span>.<span class="property">ChatClient</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">ai</span>.<span class="property">chat</span>.<span class="property">model</span>.<span class="property">ChatModel</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">ai</span>.<span class="property">chat</span>.<span class="property">prompt</span>.<span class="property">ChatOptions</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">ai</span>.<span class="property">chat</span>.<span class="property">prompt</span>.<span class="property">Prompt</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">ai</span>.<span class="property">model</span>.<span class="property">tool</span>.<span class="property">ToolCallingChatOptions</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">ai</span>.<span class="property">support</span>.<span class="property">ToolCallbacks</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">ai</span>.<span class="property">tool</span>.<span class="property">ToolCallback</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">web</span>.<span class="property">bind</span>.<span class="property">annotation</span>.<span class="property">GetMapping</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">web</span>.<span class="property">bind</span>.<span class="property">annotation</span>.<span class="property">RequestParam</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">web</span>.<span class="property">bind</span>.<span class="property">annotation</span>.<span class="property">RestController</span>;</span><br><span class="line"><span class="keyword">import</span> reactor.<span class="property">core</span>.<span class="property">publisher</span>.<span class="property">Flux</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-31 20:40</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> <span class="variable">TODO</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ToolCallingController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">ChatModel</span> chatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">ChatClient</span> chatClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">&quot;/toolcall/chat&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">chat</span>(<span class="params"><span class="meta">@RequestParam</span>(name = <span class="string">&quot;msg&quot;</span>,defaultValue = <span class="string">&quot;你是谁现在几点&quot;</span>) <span class="title class_">String</span> msg</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 1.工具注册到工具集合里</span></span><br><span class="line">        <span class="title class_">ToolCallback</span>[] tools = <span class="title class_">ToolCallbacks</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">DateTimeTools</span>());</span><br><span class="line">        <span class="comment">// 2.将工具集配置进ChatOptions对象</span></span><br><span class="line">        <span class="title class_">ChatOptions</span> options = <span class="title class_">ToolCallingChatOptions</span>.<span class="title function_">builder</span>().<span class="title function_">toolCallbacks</span>(tools).<span class="title function_">build</span>();</span><br><span class="line">        <span class="comment">// 3.构建提示词</span></span><br><span class="line">        <span class="title class_">Prompt</span> prompt = <span class="keyword">new</span> <span class="title class_">Prompt</span>(msg, options);</span><br><span class="line">        <span class="comment">// 4.调用大模型</span></span><br><span class="line">        <span class="keyword">return</span> chatModel.<span class="title function_">call</span>(prompt).<span class="title function_">getResult</span>().<span class="title function_">getOutput</span>().<span class="title function_">getText</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">&quot;/toolcall/chat2&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Flux</span>&lt;<span class="title class_">String</span>&gt; <span class="title function_">chat2</span>(<span class="params"><span class="meta">@RequestParam</span>(name = <span class="string">&quot;msg&quot;</span>,defaultValue = <span class="string">&quot;你是谁现在几点&quot;</span>) <span class="title class_">String</span> msg</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> chatClient.<span class="title function_">prompt</span>(msg)</span><br><span class="line">                .<span class="title function_">tools</span>(<span class="keyword">new</span> <span class="title class_">DateTimeTools</span>())</span><br><span class="line">                .<span class="title function_">stream</span>()</span><br><span class="line">                .<span class="title function_">content</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-388-1024x136.png" alt="img"></p><p>关于工具调用直接返回</p><p>ture：大模型直接返回原始未处理的数据</p><p>flase：大模型会再对原始数据处理一次，返回我们熟知的格式</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-389-1024x556.png" alt="img"></p><h4 id="3-小总结">3.小总结</h4><ul><li>新建定义一个Tool工具类</li><li>ChatModel/ChatClient使用</li><li>Tool Calling使用注意事项：ToolCalling使用的前提是大模型支持functioncall才能正常调用。</li></ul><h2 id="15-MCP模型上下文协议-Model-Context-Protocol">15.MCP模型上下文协议(Model Context Protocol)</h2><h3 id="1-为什么会有MCP出现，之前痛点是什么">1.为什么会有MCP出现，之前痛点是什么</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-390.png" alt="img"></p><p>之前每个大模型(如DeepSeek、ChatGPT)需要为每个工具单独开发接口(FunctionCalling)，导致重复劳动</p><p>痛点</p><ul><li>共用</li><li>数量</li></ul><h3 id="2-MCP入门概念">2.MCP入门概念</h3><p>MCP自身协议官网</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-391.png" alt="img"></p><p><a href="https://modelcontextprotocol.io/introduction">https://modelcontextprotocol.io/introduction</a></p><p>SpringAI官网支持MCP</p><p><a href="https://docs.spring.io/spring-ai/reference/api/mcp/mcp-overview.html">https://docs.spring.io/spring-ai/reference/api/mcp/mcp-overview.html</a></p><p>SpringAI Aibaba官网支持MCP</p><p><a href="https://java2ai.com/docs/1.0.0.2/tutorials/basics/model-context-protocol/?spm=5176.29160081.0.0.2856aa5ccBJ7XE">https://java2ai.com/docs/1.0.0.2/tutorials/basics/model-context-protocol/?spm=5176.29160081.0.0.2856aa5ccBJ7XE</a></p><h4 id="MCP是什么">MCP是什么</h4><p>一句话：Java界的SpringCloud Openfeign，只不过Openfeign是用于微服务通讯的，<br>而MCP用于大模型通讯的，但它们都是为了通讯获取某项数据的一种机制</p><h4 id="MCP能干嘛">MCP能干嘛</h4><p>提供了一种标准化的方式来连接 LLMs 需要的上下文，MCP 就类似于一个 Agent 时代的 Type-C协议，希望能将不同来源的数据、工具、服务统一起来供大模型调用</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-392-1024x579.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-393.png" alt="img"></p><p>MCP 厉害的地方在于，不用重复造轮子。</p><p>过去每个软件（比如微信、Excel）都要单独给 AI 做接口，</p><p>现在 MCP 统一了标准，就像所有电器都用 USB-C 充电口，AI 一个接口就能连接所有工具</p><h4 id="MCP怎么玩">MCP怎么玩</h4><p><a href="https://mcp.so/zh">https://mcp.so/zh</a></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-394-1024x496.png" alt="img"></p><h3 id="3-MCP架构知识">3.MCP架构知识</h3><h4 id="MCP遵循客户端-服务器架构包含以下几个核心部分">MCP遵循客户端-服务器架构包含以下几个核心部分</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-395.png" alt="img"></p><ul><li>MCP 主机（MCP Hosts）：发起请求的 AI 应用程序，比如聊天机器人、AI 驱动的 IDE 等</li><li>MCP 客户端（MCP Clients）：在主机程序内部，与 MCP 服务器保持 1:1 的连接。</li><li>MCP 服务器（MCP Servers）：为 MCP 客户端提供上下文、工具和提示信息。</li><li>本地资源（Local Resources）：本地计算机中可供 MCP 服务器安全访问的资源，如文件、数据库。</li><li>远程资源（Remote Resources）：MCP 服务器可以连接到的远程资源，如通过 API 提供的数据</li></ul><h4 id="在MCP通信协议中，一般有两种模式">在MCP通信协议中，一般有两种模式</h4><ul><li>STDIO(标准输入/输出)<ul><li>支持标准输入和输出流进行通信，主要用于本地集成、命令行工具等场景</li></ul></li><li>SSE (Server-Sent Events)<ul><li>支持使用 HTTP POST 请求进行服务器到客户端流式处理，以实现客户端到服务器的通信</li></ul></li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-396.png" alt="img"></p><h3 id="4-小总结（快速分清楚-工具调用、检索增强生成、模型上下文协议）">4.小总结（快速分清楚 工具调用、检索增强生成、模型上下文协议）</h3><p>ToolCalling 工具类，为了让大模型使用Util工具</p><p>RAG 知识库，为了让大模型获取足够的上下文</p><p>MCP 协议，为了让大模型之间的相互调用</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-397.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-398-1024x567.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-399.png" alt="img"></p><h4 id="MCP-VS-ToolCalling">MCP VS ToolCalling</h4><ul><li>之前每个大模型(如DeepSeek、ChatGPT)需要为每个工具单独开发接口(FunctionCalling)，导致重复劳动</li><li>MCP通过统一协议<ul><li>开发者只需写一次MCP服务端，所有兼容MCP协议的模型都能调用，MCP让大模型从&quot;被动应答”变为”主动调用工具”</li><li>我调用一个MCP服务器就等价调用一个带有多个功能的Utils工具类，自己还不用受累携带</li></ul></li></ul><h3 id="5-本地MCP-开发步骤">5.本地MCP-开发步骤</h3><h4 id="1-MCP-Server服务端实现">1.MCP-Server服务端实现</h4><ul><li>新建子模块Module</li></ul><p>SAA-14LocalMcpServer</p><ul><li>改POM</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SpringAIAlibaba-atguiguV1<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SAA-14LocalMcpServer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--注意事项（重要）</span></span><br><span class="line"><span class="comment">            spring-ai-starter-mcp-server-webflux不能和&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;依赖并存，</span></span><br><span class="line"><span class="comment">            否则会使用tomcat启动,而不是netty启动，从而导致mcpserver启动失败，但程序运行是正常的，mcp客户端连接不上。</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--mcp-server-webflux--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-starter-mcp-server-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--hutool--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-parameters<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>写YML</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="number">8014</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置全局编码格式</span></span><br><span class="line"><span class="attr">server.servlet.encoding.enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.force</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.charset</span>=UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.application.name</span>=SAA-<span class="number">14</span>LocalMcpServer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ====mcp-server Config=============</span></span><br><span class="line"><span class="attr">spring.ai.mcp.server.type</span>=async</span><br><span class="line"><span class="attr">spring.ai.mcp.server.name</span>=customer-define-mcp-server</span><br><span class="line"><span class="attr">spring.ai.mcp.server.version</span>=<span class="number">1.0</span>.<span class="number">0</span></span><br></pre></td></tr></table></figure><p>主启动</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">study</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">SpringApplication</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">autoconfigure</span>.<span class="property">SpringBootApplication</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Saa14LocalMcpServerApplication</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="title function_">main</span>(<span class="params"><span class="title class_">String</span>[] args</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">SpringApplication</span>.<span class="title function_">run</span>(<span class="title class_">Saa14LocalMcpServerApplication</span>.<span class="property">class</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="业务类-7">业务类</h5><p>天气预报WeatherService服务类</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">study</span>.<span class="property">service</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">ai</span>.<span class="property">tool</span>.<span class="property">annotation</span>.<span class="property">Tool</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">stereotype</span>.<span class="property">Service</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">Map</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> bs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-31 21:07</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> <span class="variable">TODO</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeatherService</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Tool</span>(description = <span class="string">&quot;根据城市名称获取天气预报&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getWeatherByCity</span>(<span class="params"><span class="title class_">String</span> city</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">Map</span>&lt;<span class="title class_">String</span>, <span class="title class_">String</span>&gt; map = <span class="title class_">Map</span>.<span class="title function_">of</span>(</span><br><span class="line">                <span class="string">&quot;北京&quot;</span>, <span class="string">&quot;11111降雨频繁，其中今天和后天雨势较强，部分地区有暴雨并伴强对流天气，需注意&quot;</span>,</span><br><span class="line">                <span class="string">&quot;上海&quot;</span>, <span class="string">&quot;22222多云,15℃~27℃,南风3级，当前温度27℃。&quot;</span>,</span><br><span class="line">                <span class="string">&quot;深圳&quot;</span>, <span class="string">&quot;333333多云40天，阴16天，雨30天，晴3天&quot;</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> map.<span class="title function_">getOrDefault</span>(city, <span class="string">&quot;抱歉：未查询到对应城市！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ToolCallbackProvider接口配置类</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.study.service.WeatherService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.tool.ToolCallbackProvider;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.tool.method.MethodToolCallbackProvider;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-31 21:08</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">McpServerConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将工具方法暴露给外部 mcp client 调用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> weatherService</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ToolCallbackProvider weatherTools(WeatherService weatherService)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> MethodToolCallbackProvider.builder()</span><br><span class="line">                .toolObjects(weatherService)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>自启动作为服务端等待调用即可</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-400-1024x208.png" alt="img"></p><h4 id="2-MCP-Client客户端实现">2.MCP-Client客户端实现</h4><p>新建子模块Module</p><p>SAA-15LocalMcpClient</p><p>改POM</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SpringAIAlibaba-atguiguV1<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SAA-15LocalMcpClient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--spring-ai-alibaba dashscope--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-alibaba-starter-dashscope<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 2.mcp-clent 依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-starter-mcp-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--hutool--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-parameters<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>写YML</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="number">8015</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置全局编码格式</span></span><br><span class="line"><span class="attr">server.servlet.encoding.enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.force</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.charset</span>=UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.application.name</span>=SAA-<span class="number">15</span>LocalMcpClient</span><br><span class="line"></span><br><span class="line"><span class="comment"># ====SpringAIAlibaba Config=============</span></span><br><span class="line"><span class="attr">spring.ai.dashscope.api-key</span>=<span class="variable">$&#123;aliQwen-api&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ====mcp-client Config=============</span></span><br><span class="line"><span class="attr">spring.ai.mcp.client.type</span>=async</span><br><span class="line"><span class="attr">spring.ai.mcp.client.request-timeout</span>=<span class="number">60</span>s</span><br><span class="line"><span class="attr">spring.ai.mcp.client.toolcallback.enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">spring.ai.mcp.client.sse.connections.mcp-server1.url</span>=http://localhost:<span class="number">8014</span></span><br></pre></td></tr></table></figure><p>主启动</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">study</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">SpringApplication</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">autoconfigure</span>.<span class="property">SpringBootApplication</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Saa15LocalMcpClientApplication</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="title function_">main</span>(<span class="params"><span class="title class_">String</span>[] args</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">SpringApplication</span>.<span class="title function_">run</span>(<span class="title class_">Saa15LocalMcpClientApplication</span>.<span class="property">class</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="业务类-8">业务类</h5><p>LLMConfig并添加tool调用</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.tool.ToolCallbackProvider;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-31 20:47</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SaaLLMConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatClient chatClient(ChatModel chatModel, ToolCallbackProvider tools)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ChatClient.builder(chatModel)</span><br><span class="line">                .defaultToolCallbacks(tools.getToolCallbacks())  <span class="comment">//mcp协议，配置见yml文件</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>controller</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-31 21:14</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">McpClientController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient chatClient;<span class="comment">//使用mcp支持</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel chatModel;<span class="comment">//没有纳入tool支持，普通调用</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// http://localhost:8015/mcpclient/chat?msg=上海</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/mcpclient/chat&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; chat(<span class="meta">@RequestParam(name = <span class="string">&quot;msg&quot;</span>,defaultValue = <span class="string">&quot;北京&quot;</span>)</span> String msg)</span><br><span class="line">    &#123;</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">&quot;使用了mcp&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> chatClient.prompt(msg).stream().content();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(<span class="string">&quot;/mcpclient/chat2&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; chat2(<span class="meta">@RequestParam(name = <span class="string">&quot;msg&quot;</span>,defaultValue = <span class="string">&quot;北京&quot;</span>)</span> String msg)</span><br><span class="line">    &#123;</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">&quot;未使用mcp&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> chatModel.stream(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-MCP-Client-invoke-MCP-Server测试">3.MCP-Client invoke MCP-Server测试</h4><p>使用mcp</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-401.png" alt="img"></p><p>没有mcp支持，已读乱回</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-402-1024x437.png" alt="img"></p><h3 id="6-远程MCP增强案例-对接互联网通用MCP服务（百度地图）">6.远程MCP增强案例-对接互联网通用MCP服务（百度地图）</h3><h4 id="对接互联网通用MCP服务（百度地图）">对接互联网通用MCP服务（百度地图）</h4><p><a href="https://mcp.so/zh/server/baidu-map/baidu-maps">https://mcp.so/zh/server/baidu-map/baidu-maps</a></p><h4 id="1-环境配置">1.环境配置</h4><ul><li>下载最新版的NodeJS</li><li>注册百度地图账号+申请API-key ：速成langchain4j时我们配置过这里省略</li><li>nodejs配置编码-Typescript接入</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-403.png" alt="img"></p><h4 id="2-开发步骤-4">2.开发步骤</h4><p>新建子模块Module</p><p>springAI-16chat-mcpclient-call-baidumcp</p><p>改POM</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zzyy.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SpringAI-zyfanV1<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springAI-16chat-mcpclient-call-baidumcp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 1.大模型依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-starter-model-openai<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 2.mcp-clent 依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-starter-mcp-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--hutool--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-parameters<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>写YML</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="number">6016</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置全局编码格式</span></span><br><span class="line"><span class="attr">server.servlet.encoding.enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.force</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.charset</span>=UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.application.name</span>=springAI-<span class="number">16</span>chat-mcpclient-call-baidumcp</span><br><span class="line"></span><br><span class="line"><span class="comment"># ====LLM Config=============</span></span><br><span class="line"><span class="attr">spring.ai.openai.api-key</span>=<span class="variable">$&#123;aliQwen-api&#125;</span></span><br><span class="line"><span class="attr">spring.ai.openai.base-url</span>=https://dashscope.aliyuncs.com/compatible-mode</span><br><span class="line"><span class="attr">spring.ai.openai.chat.options.model</span>=qwen-plus</span><br><span class="line"></span><br><span class="line"><span class="comment"># ====mcp-client Config=============</span></span><br><span class="line"><span class="attr">spring.ai.mcp.client.toolcallback.enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">spring.ai.mcp.client.stdio.servers-configuration</span>=classpath:/mcp-server.json</span><br></pre></td></tr></table></figure><p>nodejs配置编码-Typescript接入</p><p><a href="https://mcp.so/zh/server/baidu-map/baidu-maps?tab=content#typescript%E6%8E%A5%E5%85%A5">https://mcp.so/zh/server/baidu-map/baidu-maps?tab=content#typescript%E6%8E%A5%E5%85%A5</a></p><p>mcp-server.json</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-404-1024x559.png" alt="img"></p><p>主启动</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-405-1024x392.png" alt="img"></p><h5 id="业务类-9">业务类</h5><p>LLMConfig</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.tool.ToolCallbackProvider;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-31 20:47</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SaaLLMConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatClient chatClient(ChatModel chatModel, ToolCallbackProvider tools)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ChatClient.builder(chatModel)</span><br><span class="line">                <span class="comment">//mcp协议，配置见yml文件，此处只赋能给ChatClient对象</span></span><br><span class="line">                .defaultToolCallbacks(tools.getToolCallbacks())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>controller</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyy.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-07-19 18:55</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">McpClientCallBaiDuMcpController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource</span> </span><br><span class="line">    <span class="keyword">private</span> ChatClient chatClient; <span class="comment">//添加了MCP调用能力</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel chatModel; <span class="comment">//没有添加MCP调用能力</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加了MCP调用能力</span></span><br><span class="line"><span class="comment">     * http://localhost:6016/mcp/chat?msg=查询北京天气</span></span><br><span class="line"><span class="comment">     * http://localhost:6016/mcp/chat?msg=查询61.149.121.66归属地</span></span><br><span class="line"><span class="comment">     * http://localhost:6016/mcp/chat?msg=查询昌平到天安门路线规划</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/mcp/chat&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; chat(String msg)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> chatClient.prompt(msg).stream().content();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 没有添加MCP调用能力</span></span><br><span class="line"><span class="comment">     *http://localhost:6016/mcp/chat2?msg=查询北京天气</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping(<span class="string">&quot;/mcp/chat2&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; chat2(String msg)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> chatModel.stream(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-测试-2">3.测试</h4><p>具备mcp能力的</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-406-1024x400.png" alt="img"></p><p>不具备mcp能力的</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-407-1024x169.png" alt="img"></p><h3 id="7-MCP原理-源码分析">7.MCP原理+源码分析</h3><h4 id="源码获得">源码获得</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-408.png" alt="img"></p><p>下载后的源码</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-409.png" alt="img"></p><p>原理说明</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-410-1024x381.png" alt="img"></p><h2 id="16-SAA生态篇">16.SAA生态篇</h2><h3 id="1-阿里云百炼平台云上RAG知识库-AI智能运维">1.阿里云百炼平台云上RAG知识库(AI智能运维)</h3><h4 id="需求说明">需求说明</h4><p>阿里云上知识库搭建</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-411-1024x413.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-412-1024x401.png" alt="img"></p><h4 id="开发步骤">开发步骤</h4><p>新建子模块Module</p><p>SAA-17BailianRAG</p><p>改POM</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.atguigu.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SpringAIAlibaba-atguiguV1<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SAA-17BailianRAG<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--spring-ai-alibaba dashscope--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-alibaba-starter-dashscope<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--hutool--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-parameters<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>写YML</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="number">8017</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置全局编码格式</span></span><br><span class="line"><span class="attr">server.servlet.encoding.enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.force</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.charset</span>=UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.application.name</span>=SAA-<span class="number">17</span>BailianRAG</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ====SpringAIAlibaba Config=============</span></span><br><span class="line"><span class="attr">spring.ai.dashscope.api-key</span>=<span class="variable">$&#123;aliQwen-api&#125;</span></span><br></pre></td></tr></table></figure><p>主启动</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">study</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">SpringApplication</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">autoconfigure</span>.<span class="property">SpringBootApplication</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Saa17BailianRagApplication</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="title function_">main</span>(<span class="params"><span class="title class_">String</span>[] args</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">SpringApplication</span>.<span class="title function_">run</span>(<span class="title class_">Saa17BailianRagApplication</span>.<span class="property">class</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="业务类-10">业务类</h5><p>DashScopeConfig</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyy.study.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.api.DashScopeApi;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DashScopeConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(<span class="string">&quot;<span class="subst">$&#123;spring.ai.dashscope.api-key&#125;</span>&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> String apiKey;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DashScopeApi dashScopeApi()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> DashScopeApi.builder()</span><br><span class="line">                .apiKey(apiKey)</span><br><span class="line">                .workSpaceId(<span class="string">&quot;llm-3as714s6flm80yc1&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatClient chatClient(ChatModel dashscopeChatModel)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> ChatClient.builder(dashscopeChatModel).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>controller</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyy.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.advisor.DocumentRetrievalAdvisor;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.api.DashScopeApi;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.rag.DashScopeDocumentRetriever;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.rag.DashScopeDocumentRetrieverOptions;</span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.rag.retrieval.search.DocumentRetriever;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-08-01 16:51</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BailianRagController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient chatClient;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DashScopeApi dashScopeApi;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:6018/bailian/rag/chat</span></span><br><span class="line"><span class="comment">     * http://localhost:6018/bailian/rag/chat?msg=A0001</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/bailian/rag/chat&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; chat(<span class="meta">@RequestParam(name = <span class="string">&quot;msg&quot;</span>,defaultValue = <span class="string">&quot;00000错误信息&quot;</span>)</span> String msg)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//1 RetrieverOptions参数配置</span></span><br><span class="line">        DashScopeDocumentRetrieverOptions documentRetrieverOptions = DashScopeDocumentRetrieverOptions.builder()</span><br><span class="line">                .withIndexName(<span class="string">&quot;myerror&quot;</span>) <span class="comment">// 知识库名称</span></span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2 百炼平台RAG知识库构建器</span></span><br><span class="line">        DocumentRetriever retriever = new DashScopeDocumentRetriever(dashScopeApi,documentRetrieverOptions);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> chatClient.prompt()</span><br><span class="line">                .user(msg)</span><br><span class="line">                .advisors(new DocumentRetrievalAdvisor(retriever))</span><br><span class="line">                .stream()</span><br><span class="line">                .content();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-413-1024x179.png" alt="img"></p><h3 id="2-阿里云百炼平台云上RAG知识库-电商智能客服案例">2.阿里云百炼平台云上RAG知识库(电商智能客服案例)</h3><h4 id="需求说明-2">需求说明</h4><p>阿里云上知识库搭建RAG，电商客服统一话术</p><h4 id="开发步骤-2">开发步骤</h4><p>新建子模块Module</p><p>springAI-21chat-CustomerService</p><p>改POM</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zzyy.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SpringAI-zyfanV1<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springAI-21chat-CustomerService<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 2. SAA大模型依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-alibaba-starter-dashscope<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--hutool--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-parameters<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>写YML</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="number">6021</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置全局编码格式</span></span><br><span class="line"><span class="attr">server.servlet.encoding.enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.force</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.charset</span>=UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.application.name</span>=springAI-<span class="number">21</span>chat-CustomerService</span><br><span class="line"></span><br><span class="line"><span class="comment"># ====LLM Config=============</span></span><br><span class="line"><span class="attr">spring.ai.dashscope.api-key</span>=<span class="variable">$&#123;aliQwen-api&#125;</span></span><br></pre></td></tr></table></figure><p>主启动</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">zzyy</span>.<span class="property">study</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">SpringApplication</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">autoconfigure</span>.<span class="property">SpringBootApplication</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringAi21chatCustomerServiceApplication</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="title function_">main</span>(<span class="params"><span class="title class_">String</span>[] args</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">SpringApplication</span>.<span class="title function_">run</span>(<span class="title class_">SpringAi21</span>chatCustomerServiceApplication.<span class="property">class</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="业务类-11">业务类</h5><p>DashSocpeConfig</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyy.study.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.api.DashScopeApi;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DashSocpeConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(<span class="string">&quot;<span class="subst">$&#123;spring.ai.dashscope.api-key&#125;</span>&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> String apiKey;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DashScopeApi dashScopeApi() &#123;</span><br><span class="line">        <span class="keyword">return</span> DashScopeApi.builder()</span><br><span class="line">                .apiKey(apiKey)</span><br><span class="line">                .workSpaceId(<span class="string">&quot;llm-3as714s6flm80yc1&quot;</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatClient chatClient(ChatModel dashscopeChatModel) &#123;</span><br><span class="line">        <span class="keyword">return</span> ChatClient.builder(dashscopeChatModel).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>controller</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyy.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.advisor.DocumentRetrievalAdvisor;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.api.DashScopeApi;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.rag.DashScopeDocumentRetriever;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.rag.DashScopeDocumentRetrieverOptions;</span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.rag.retrieval.search.DocumentRetriever;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-08-01 16:51</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AICustomerServiceController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ChatClient chatClient;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DashScopeApi dashScopeApi;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:6021/customer/service</span></span><br><span class="line"><span class="comment">     * http://localhost:6021/customer/service?msg=A0001</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/customer/service&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; service(<span class="meta">@RequestParam(name = <span class="string">&quot;msg&quot;</span>,defaultValue = <span class="string">&quot;什么时候发货&quot;</span>)</span> String msg)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//1 RetrieverOptions参数配置</span></span><br><span class="line">        DashScopeDocumentRetrieverOptions documentRetrieverOptions = DashScopeDocumentRetrieverOptions.builder()</span><br><span class="line">                .withIndexName(<span class="string">&quot;淘宝电商话术&quot;</span>)<span class="comment">// 百炼平台云知识库名称</span></span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2 百炼平台RAG知识库构建器</span></span><br><span class="line">        DocumentRetriever retriever = new DashScopeDocumentRetriever(dashScopeApi,documentRetrieverOptions);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> chatClient.prompt()</span><br><span class="line">                .system(<span class="string">&quot;你是一个电商智能客服助手，根据用户的问题去知识库查询信息，&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;如果知识库查询不到信息，返回抱歉查询不到任何信息。&quot;</span>)</span><br><span class="line">                .user(msg)</span><br><span class="line">                .advisors(new DocumentRetrievalAdvisor(retriever))</span><br><span class="line">                .stream()</span><br><span class="line">                .content();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-本地微服务调用阿里云百炼平台工作流-AI智能菜单，今天吃什么">3.本地微服务调用阿里云百炼平台工作流(AI智能菜单，今天吃什么)</h3><p>美团，今天吃什么AI智能菜单</p><h4 id="1-不用阿里SAA生态">1.不用阿里SAA生态</h4><p>开发步骤</p><p>新建子模块Module</p><p>SAA-18TodayMenu</p><p>改POM</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zzyy.study<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SpringAI-zyfanV1<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springAI-20chat-TodayMenu<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 2. SAA大模型依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-alibaba-starter-dashscope<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--hutool--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">arg</span>&gt;</span>-parameters<span class="tag">&lt;/<span class="name">arg</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">compilerArgs</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>21<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>21<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>写YML</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="number">8018</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置全局编码格式</span></span><br><span class="line"><span class="attr">server.servlet.encoding.enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.force</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.charset</span>=UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.application.name</span>=SAA-<span class="number">18</span>TodayMenu</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ====SpringAIAlibaba Config=============</span></span><br><span class="line"><span class="attr">spring.ai.dashscope.api-key</span>=<span class="variable">$&#123;aliQwen-api&#125;</span></span><br></pre></td></tr></table></figure><p>主启动</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">atguigu</span>.<span class="property">study</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">SpringApplication</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">autoconfigure</span>.<span class="property">SpringBootApplication</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Saa18TodayMenuApplication</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="title function_">main</span>(<span class="params"><span class="title class_">String</span>[] args</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">SpringApplication</span>.<span class="title function_">run</span>(<span class="title class_">Saa18TodayMenuApplication</span>.<span class="property">class</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="业务类-12">业务类</h5><p>配置类LLMConfig</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.api.DashScopeApi;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DashScopeConfig</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(<span class="string">&quot;<span class="subst">$&#123;spring.ai.dashscope.api-key&#125;</span>&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> String apiKey;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DashScopeApi dashScopeApi() &#123;</span><br><span class="line">        <span class="keyword">return</span> DashScopeApi.builder()</span><br><span class="line">                .apiKey(apiKey)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatClient chatClient(ChatModel dashscopeChatModel) &#123;</span><br><span class="line">        <span class="keyword">return</span> ChatClient.builder(dashscopeChatModel).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>controller</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jakarta.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.SystemMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.messages.UserMessage;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.Prompt;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-09-11 19:00</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MenuController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ChatModel chatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = <span class="string">&quot;/eat&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; eat(<span class="meta">@RequestParam(name = <span class="string">&quot;msg&quot;</span>,defaultValue = <span class="string">&quot;今天吃什么&quot;</span>)</span> String question)</span><br><span class="line">    &#123;</span><br><span class="line">        String info = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                你是一个AI厨师助手,每次随机生成三个家常菜，并且提供这些家常菜的详细做法步骤，以HTML格式返回</span></span><br><span class="line"><span class="string">                字数控制在1500字以内。</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">// 系统消息</span></span><br><span class="line">        SystemMessage systemMessage = new SystemMessage(info);</span><br><span class="line">        <span class="comment">// 用户消息</span></span><br><span class="line">        UserMessage userMessage = new UserMessage(question);</span><br><span class="line"></span><br><span class="line">        Prompt prompt = new Prompt(userMessage, systemMessage);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> chatModel.stream(prompt).map(response -&gt; response.getResults().<span class="keyword">get</span>(<span class="number">0</span>).getOutput().getText());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-414-1024x796.png" alt="img"></p><h4 id="2-使用阿里SAA生态-重点">2.使用阿里SAA生态 -重点</h4><p>工作流配置</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-415-1024x508.png" alt="img"></p><p>写YML</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="number">6020</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置全局编码格式</span></span><br><span class="line"><span class="attr">server.servlet.encoding.enabled</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.force</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">server.servlet.encoding.charset</span>=UTF-<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.application.name</span>=springAI-<span class="number">20</span>chat-TodayMenu</span><br><span class="line"></span><br><span class="line"><span class="comment"># ====LLM Config=============</span></span><br><span class="line"><span class="attr">spring.ai.dashscope.api-key</span>=<span class="variable">$&#123;aliQwen-api&#125;</span></span><br><span class="line"><span class="comment"># SAA PlatForm today&#x27;s menu Agent app-id</span></span><br><span class="line"><span class="attr">spring.ai.dashscope.agent.options.app-id</span>=f0a4613e6bd540c5bcd55e137e3b0e35</span><br></pre></td></tr></table></figure><h5 id="业务类-13">业务类</h5><p>配置类LLMConfig</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyy.study.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.api.DashScopeApi;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.client.ChatClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.model.ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DashScopeConfig</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(<span class="string">&quot;<span class="subst">$&#123;spring.ai.dashscope.api-key&#125;</span>&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> String apiKey;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DashScopeApi dashScopeApi() &#123;</span><br><span class="line">        <span class="keyword">return</span> DashScopeApi.builder()</span><br><span class="line">                .apiKey(apiKey)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ChatClient chatClient(ChatModel dashscopeChatModel) &#123;</span><br><span class="line">        <span class="keyword">return</span> ChatClient.builder(dashscopeChatModel).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>controller</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.zzyy.study.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.agent.DashScopeAgent;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.agent.DashScopeAgentOptions;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.cloud.ai.dashscope.api.DashScopeAgentApi;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.chat.prompt.Prompt;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.<span class="keyword">annotation</span>.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@auther</span> zzyybs@126.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@create</span> 2025-08-13 19:01</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> TODO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MenuCallAgentController</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 百炼平台的appid</span></span><br><span class="line">    <span class="meta">@Value(<span class="string">&quot;<span class="subst">$&#123;spring.ai.dashscope.agent.options.app-id&#125;</span>&quot;</span>)</span></span><br><span class="line">    <span class="keyword">private</span> String APPID;</span><br><span class="line">    <span class="comment">// 百炼云端智能体调用对象</span></span><br><span class="line">       <span class="keyword">private</span> DashScopeAgent agent;</span><br><span class="line">    <span class="comment">//构造方法注入，创建百炼云端智能体对象</span></span><br><span class="line">       <span class="keyword">public</span> MenuCallAgentController(DashScopeAgentApi agentApi)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.agent = new DashScopeAgent(agentApi);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http://localhost:8018/eatAgent</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/eatAgent&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> String eatAgent(<span class="meta">@RequestParam(name = <span class="string">&quot;topic&quot;</span>,defaultValue = <span class="string">&quot;今天中午吃什么&quot;</span>)</span> String topic)</span><br><span class="line">    &#123;</span><br><span class="line">        DashScopeAgentOptions options = DashScopeAgentOptions.builder().withAppId(APPID).build();</span><br><span class="line"></span><br><span class="line">        Prompt prompt = new Prompt(topic, options);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> agent.call(prompt).getResult().getOutput().getText();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-416-1024x643.png" alt="img"></p><h3 id="4-智能体">4.智能体</h3><h4 id="是什么">是什么</h4><p>“智能体”是从对话工具进化为数字助手，能像人类助理一样完成端到端的复杂任务，核心突破在于主动性和环境操作能力</p><p>智能体（Agent）指的是一种应用，<strong>它依靠大模型进行自主决策</strong>，在与用户进行自然语言交互的时候，根据用户问题能够自主感知环境、<strong>做出决策并执行行动的系统</strong>。它不仅仅是被动回答问题，而是像“有自主意识的程序”，能主动完成复杂任务</p><h4 id="举个例子">举个例子</h4><ul><li>普通大模型<ul><li>问题提问调用：你问“上海明天天气如何？”它返回一段文字描述。</li></ul></li><li>智能体<ul><li>你说“如果明天下雨，提醒我带伞，并取消明天的户外会议。”它会查询天气→设定提醒→检查日历→发送会议取消邮件。</li></ul></li></ul><h4 id="能干嘛">能干嘛</h4><p>典型应用场景</p><ul><li>自动化办公：智能体读取邮件、生成报告、安排会议。</li><li>智能家居：根据你的作息自动调节灯光、空调，甚至订购物资。</li><li>复杂问题解决：如“帮我用1万元预算策划一场50人的公司团建”，它会拆解需求、搜索场地、比价、生成方案</li></ul><h4 id="怎么用">怎么用</h4><p>阿里云百炼平台</p><p><a href="https://bailian.console.aliyun.com">https://bailian.console.aliyun.com</a></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-418-1024x462.png" alt="img"></p><h2 id="速通SpringAI-Alibaba完结">速通SpringAI Alibaba完结</h2>]]></content>
    
    
    <summary type="html">速通Spring AI Alibaba 完结</summary>
    
    
    
    <category term="AI" scheme="https://itgeqian.github.io/categories/AI/"/>
    
    
    <category term="Spring AI Alibaba" scheme="https://itgeqian.github.io/tags/Spring-AI-Alibaba/"/>
    
  </entry>
  
  <entry>
    <title>GQ Music项目演示图</title>
    <link href="https://itgeqian.github.io/posts/58.html"/>
    <id>https://itgeqian.github.io/posts/58.html</id>
    <published>2025-09-26T09:09:03.000Z</published>
    <updated>2025-09-26T12:01:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-Minio结构">1.Minio结构</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-200.png" alt="img"></p><h2 id="2-表结构">2.表结构</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-201.png" alt="img"></p><h2 id="3-用户端部分页面截图">3.用户端<strong>部分页面截图</strong></h2><h3 id="1-推荐页面">1.推荐页面</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-202-1.png" alt="img"></p><ul><li>轮播图可以跳转到管理端指定的专辑页面</li><li>歌单推荐和歌曲推荐走的是不同的推荐逻辑</li></ul><h3 id="2-搜索页">2.搜索页</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-203-1.png" alt="img"></p><ul><li>选择音乐时可以按照歌手/专辑/歌曲名进行搜索</li><li>选择用户时按照用户名搜索</li></ul><p>接下来避免看不清我关掉了主题</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-204.png" alt="img"></p><p>点击右箭头可以跳转用户个人详情</p><h3 id="3-个人详情页">3.个人详情页</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-205-1.png" alt="img"></p><p>可以收起统计</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-206.png" alt="img"></p><p>点击粉丝和关注显示自己的粉丝和关注用户，同样点击后跳转到其他用户详情</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-207.png" alt="img"></p><p>若用户开启了私密模式则无法显示其喜欢的歌曲、收藏的歌单、以及创建的歌单</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-208.png" alt="img"></p><h3 id="4-曲库模块（所有歌曲）">4.曲库模块（所有歌曲）</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-209-1.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-210.png" alt="img"></p><p>这里的更多中下拉可以看到更多的操作</p><h3 id="5-歌手模块">5.歌手模块</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-211-1.png" alt="img"></p><p>按分类筛选歌手，点击后可以进入歌手详情页</p><h3 id="6-歌手详情页">6.歌手详情页</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-265-1.png" alt="img"></p><p>歌曲、专辑、详情导航</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-213.png" alt="img"></p><p>详情页</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-216-1.png" alt="img"></p><p>专辑导航显示出所有专辑懒加载展开后显示所有歌曲，也可以点击专辑名跳转到专辑详情页</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-214.png" alt="img"></p><h3 id="7-专辑详情页">7.专辑详情页</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-215-1.png" alt="img"></p><p>专辑信息页</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-217-1.png" alt="img"></p><p>专辑评论区</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-218.png" alt="img"></p><h3 id="8-歌单模块（官方歌单）">8.歌单模块（官方歌单）</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-219-1.png" alt="img"></p><p>点击进入歌单详情页</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-220.png" alt="img"></p><h3 id="9-喜欢模块">9.喜欢模块</h3><p>显示喜欢的歌曲、专辑、歌手</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-221.png" alt="img"></p><h3 id="10-我的歌单-创建我的歌单">10.我的歌单-创建我的歌单</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-222.png" alt="img"></p><p>创建方式</p><p>1.自己在我的歌单页创建</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-223.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-224.png" alt="img"></p><p>评论管理：管理其他用户对你的歌单的评价</p><p>上传封面：就是上传封面</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-225.png" alt="img"></p><p>2.歌曲更多下拉框中添加到中选择</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-226-1.png" alt="img"></p><h3 id="11-最近播放">11.最近播放</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-227.png" alt="img"></p><p>这里的更多多了移除按钮，可以把歌曲移出最近播放，你也可以清除全部记录</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-228.png" alt="img"></p><h3 id="12-个人中心">12.个人中心</h3><p>也就是别人看的个人详情页记录自己的一些数据这里不多做介绍</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-229.png" alt="img"></p><h3 id="13-收藏的歌单">13.收藏的歌单</h3><p>收藏的歌单放在这里，可以滚动</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-230-344x1024.png" alt="img"></p><h3 id="14-个人设置">14.个人设置</h3><p>更新/修改信息</p><p>是否公开主页</p><p>自动播放/恢复进度/音频条开关</p><p>是否开启首页推荐</p><p>快捷键播放</p><p>音频条如下</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-238-1.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-231.png" alt="img"></p><h3 id="15-暗色模式与亮色模式">15.暗色模式与亮色模式</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-232.png" alt="img"></p><h3 id="16-主题功能">16.主题功能</h3><p>官方主题分为静态和动态</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-233.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-234.png" alt="img"></p><p>当然也可以自定义图片上传，自定义不支持视频以防网站压力过大</p><p>模糊度和亮度就不做解释了</p><h3 id="17-意见反馈">17.意见反馈</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-235.png" alt="img"></p><h3 id="18-歌曲播放页面">18.歌曲播放页面</h3><p>随机播放、循环播放、顺序播放</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-236-1.png" alt="img"></p><p>呼吸光效</p><p>歌词</p><p>评论可以上传图片和回复及删除-个人删与管理员删（歌单、专辑的评论也一样）</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-237-1.png" alt="img"></p><h3 id="19-登录、注册、重置密码">19.登录、注册、重置密码</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-239.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-240.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-241.png" alt="img"></p><h2 id="4-管理端部分截图">4.管理端部分截图</h2><p>管理端基于vue-pure-admin</p><h3 id="1-首页">1.首页</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-242.png" alt="img"></p><h3 id="2-用户管理">2.用户管理</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-243.png" alt="img"></p><h3 id="3-歌手管理">3.歌手管理</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-244.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-245-1024x613.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-246-1024x906.png" alt="img"></p><p>上传头像</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-247.png" alt="img"></p><h3 id="4-歌曲管理">4.歌曲管理</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-248-1.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-249.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-250.png" alt="img"></p><p>上传音频时歌词可选传</p><h3 id="5-批量导入歌曲">5.批量导入歌曲</h3><p>支持拖拽</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-251.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-252.png" alt="img"></p><h3 id="6-专辑管理">6.专辑管理</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-253.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-254.png" alt="img"></p><h3 id="7-歌单管理之官方歌单">7.歌单管理之官方歌单</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-255-1.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-256.png" alt="img"></p><p>添加歌曲界面跟用户端我的歌单一样</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-257-1.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-258-1.png" alt="img"></p><h3 id="8-歌单管理之用户歌单">8.歌单管理之用户歌单</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-259.png" alt="img"></p><p>用户歌单只支持读和推荐</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-260-1.png" alt="img"></p><h3 id="9-反馈模块">9.反馈模块</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-261-1.png" alt="img"></p><h3 id="10-轮播图管理">10.轮播图管理</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-262-1.png" alt="img"></p><p>编辑轮播图可以选择绑定专辑</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-263-1.png" alt="img"></p><h3 id="11-主题管理">11.主题管理</h3><p>增删改查</p><p>支持上传图片格式和视频格式</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-264-1.png" alt="img"></p><p>主要大的功能大概就这多，更细小我就不截图了</p>]]></content>
    
    
    <summary type="html">GQ Music项目演示图</summary>
    
    
    
    <category term="项目" scheme="https://itgeqian.github.io/categories/%E9%A1%B9%E7%9B%AE/"/>
    
    
    <category term="项目相关" scheme="https://itgeqian.github.io/tags/%E9%A1%B9%E7%9B%AE%E7%9B%B8%E5%85%B3/"/>
    
  </entry>
  
  <entry>
    <title>leetcode面试经典 150 题（持续更新）</title>
    <link href="https://itgeqian.github.io/posts/59.html"/>
    <id>https://itgeqian.github.io/posts/59.html</id>
    <published>2025-09-25T09:09:03.000Z</published>
    <updated>2025-10-10T12:01:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-合并两个数组（简单）">1.合并两个数组（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-266-1024x711.png" alt="img"></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="symbol">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> merge(<span class="built_in">int</span>[] nums1, <span class="built_in">int</span> m, <span class="built_in">int</span>[] nums2, <span class="built_in">int</span> n) &#123;</span><br><span class="line">         <span class="built_in">int</span> p1 = m - <span class="number">1</span>, p2 = n - <span class="number">1</span>;<span class="comment">// 指向两个数组的最后一个元素</span></span><br><span class="line">         <span class="built_in">int</span> p = m + n - <span class="number">1</span>;<span class="comment">// 指向合并后数组的最后一个元素</span></span><br><span class="line">        <span class="comment">// 从后往前比较，将较大的元素放入合并后的数组中</span></span><br><span class="line">         <span class="keyword">while</span> (p1 &gt;= <span class="number">0</span> &amp;&amp; p2 &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">             nums1[p--] = nums1[p1] &gt; nums2[p2] ? nums1[p1--] : nums2[p2--];</span><br><span class="line">         &#125;</span><br><span class="line">        <span class="comment">//如果num1的数全部遍历完毕了，但len2还没有遍历，所以只要将len2剩余的元素全部复制到len1中，此时len2的长度根据len2中剩下的元素的长度来决定</span></span><br><span class="line">        <span class="comment">//但是如果num2全部遍历完了，那么此时的len2就是为-1了，所以当你在将num2复制到num1时，复制的长度为0，所以不复制任何元素过去</span></span><br><span class="line">         System.<span class="built_in">array</span>copy(nums2, <span class="number">0</span>, nums1, <span class="number">0</span>, p2 + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/chrome-capture-2025-09-28.gif" alt="img"></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="symbol">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> merge(<span class="built_in">int</span>[] nums1, <span class="built_in">int</span> m, <span class="built_in">int</span>[] nums2, <span class="built_in">int</span> n) &#123;</span><br><span class="line">   <span class="comment">// 指向两个数组的最后一个元素</span></span><br><span class="line">        <span class="built_in">int</span> p1 = m<span class="number">-1</span>;</span><br><span class="line">        <span class="built_in">int</span> p2 = n<span class="number">-1</span>;</span><br><span class="line">        <span class="built_in">int</span> p = m+n<span class="number">-1</span>;<span class="comment">// 指向合并后数组的最后一个元素</span></span><br><span class="line">   <span class="comment">// 从后往前比较，将较大的元素放入合并后的数组中</span></span><br><span class="line">        <span class="keyword">while</span>(p2&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">  <span class="comment">// 如果 nums1 还有剩余元素，且当前 nums1 的元素大于等于 nums2 的元素</span></span><br><span class="line">            <span class="keyword">if</span>(p1&gt;=<span class="number">0</span>&amp;&amp;nums1[p1]&gt;nums2[p2])&#123;</span><br><span class="line">               <span class="comment">// 将 nums1 的元素放入合并后的数组中，并向前移动指针</span></span><br><span class="line">                nums1[p--]=nums1[p1--];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//将nums2的元素放入合并后的数组，并向前移动指针</span></span><br><span class="line"> <span class="comment">// 注意这里不需要判断 p2 是否大于等于 0，因为当 nums1 没有剩余元素时，p1 也已经小于 0 了</span></span><br><span class="line">                nums1[p--]= nums2[p2--];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>三个指针：<code>p1=m-1</code> 指向 <code>nums1</code> 有效区末尾，<code>p2=n-1</code> 指向 <code>nums2</code> 末尾，<code>p=m+n-1</code> 指向合并后数组末尾。</li><li>每次比较 <code>nums1[p1]</code> 和 <code>nums2[p2]</code>，把较大的放到 <code>nums1[p]</code>，指针左移。</li><li>相等时两段代码都把 <strong><code>nums2[p2]</code></strong> 放进去（因为用的是 <code>&gt;</code> 而不是 <code>&gt;=</code>）。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-267.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-268.png" alt="img"></p><h2 id="2-移除元素（简单）">2.移除元素（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-269-1024x550.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-270.png" alt="img"></p><p>本题只需要返回k（不包含<em>val的元素个数</em>）</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    public <span class="keyword">int</span> removeElement(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> val) &#123;</span><br><span class="line">        <span class="keyword">if</span>(nums.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="regexp">//</span>遍历数组，如果当前元素不等于val，则将其放到前面去</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>;j &lt; nums.length;j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(nums[j] != val)&#123;</span><br><span class="line">                nums[i++] = nums[j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-删除有序数组中的重复项（简单）">3.删除有序数组中的重复项（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-327-1024x696.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-328-1024x367.png" alt="img"></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    public <span class="keyword">int</span> removeDuplicates(<span class="keyword">int</span>[] nums) &#123;</span><br><span class="line">       <span class="keyword">if</span>(nums.length == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">int</span> i = <span class="number">0</span>;<span class="regexp">//</span>指向下一个不重复的元素的位置</span><br><span class="line">        //遍历数组，如果当前元素不等于前一个元素，则将其放到前面去</span><br><span class="line">       <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>;j &lt; nums.length;j++)&#123;</span><br><span class="line">           <span class="keyword">if</span>(nums[i] != nums[j])&#123;</span><br><span class="line">               i++;</span><br><span class="line">               nums[i] = nums[j];<span class="regexp">//</span>将不重复的元素放到前面去</span><br><span class="line">           &#125;</span><br><span class="line">           </span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> i+<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><code>i</code> 表示数组去重后的最后一个元素下标。</p></li><li><p>因为数组下标是从 0 开始的，所以 <strong>数组的长度应该是下标 + 1</strong>。</p></li><li><p>比如输入</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[1,1,2]</span></span><br></pre></td></tr></table></figure><p>：</p><ul><li>最终数组变成 <code>[1,2,...]</code>；</li><li><code>i = 1</code>，但是长度是 2 → 所以返回 <code>i+1</code>。</li></ul></li></ul><p>👉 这里的返回值是 <strong>长度</strong>，所以必须 <code>i+1</code>。</p><h2 id="4-删除有序数组中的重复项II（中等）">4.删除有序数组中的重复项II（中等）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-329-1024x841.png" alt="img"></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    public <span class="keyword">int</span> removeDuplicates(<span class="keyword">int</span>[] nums) &#123;</span><br><span class="line">        <span class="keyword">int</span> n = nums.length;</span><br><span class="line">       <span class="keyword">if</span>(n &lt;= <span class="number">2</span>) <span class="keyword">return</span> nums.length;</span><br><span class="line">       <span class="keyword">int</span> i =<span class="number">2</span>;<span class="regexp">//</span>指向下一个不重复的元素的位置</span><br><span class="line">        //遍历数组，如果当前元素不等于前一个元素，则将其放到前面去</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = i; j &lt; n; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(nums[j] != nums[i-<span class="number">2</span>])&#123;</span><br><span class="line">                nums[i] = nums[j];</span><br><span class="line">                i++;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>i</code> 表示数组去重后下一个应该放置新元素的位置。</p><p>当循环结束时，<code>i</code> 已经 <strong>指向去重数组末尾的下一个位置</strong>。</p><p>因为 <code>i</code> 本身就是新数组的长度，所以直接返回 <code>i</code>。</p><p>比如输入 <code>[1,1,1,2,2,3]</code>：</p><ul><li>处理完后数组变为 <code>[1,1,2,2,3,...]</code>；</li><li><code>i = 5</code>，去重后的长度就是 5，直接返回 <code>i</code>。</li></ul><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    public <span class="keyword">int</span> removeDuplicates(<span class="keyword">int</span>[] nums) &#123;</span><br><span class="line">        <span class="keyword">int</span> n = nums.length, l = <span class="number">2</span>, r = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (r &lt; n) &#123;</span><br><span class="line">            <span class="keyword">if</span> (nums[r] != nums[l - <span class="number">2</span>]) &#123;</span><br><span class="line">                nums[l] = nums[r];</span><br><span class="line">                l++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            r++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> l;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-最后一个单词的长度-简单">5.最后一个单词的长度(简单)</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-330-1024x797.png" alt="img"></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    public <span class="keyword">int</span> lengthOfLastWord(String s) &#123;</span><br><span class="line">           <span class="keyword">if</span>(s.length()==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">           <span class="regexp">//</span>去掉字符串末尾的空格</span><br><span class="line">           String[] strs = s.<span class="keyword">split</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">           <span class="keyword">int</span> n = strs.length-<span class="number">1</span>;<span class="regexp">//</span>最后一个单词的下标</span><br><span class="line">          //从后往前遍历，找到最后一个单词的长度</span><br><span class="line">           <span class="keyword">for</span>(<span class="keyword">int</span> i=n;i&gt;=<span class="number">0</span>;i--)&#123;</span><br><span class="line">               <span class="regexp">//</span>当遇到非空字符串时，返回长度</span><br><span class="line">               <span class="keyword">if</span>(!strs[i].equals(<span class="string">&quot;&quot;</span>))&#123;</span><br><span class="line">                   <span class="keyword">return</span> strs[i].length();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p>📌 例子 1</p><p>输入：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">s</span> <span class="operator">=</span> <span class="string">&quot;   fly me   to   the moon  &quot;</span></span><br></pre></td></tr></table></figure><ol><li>split 之后</li></ol><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String[] strs <span class="operator">=</span> s.split(<span class="string">&quot; &quot;</span>)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>因为 <code>&quot; &quot;</code> 作为分隔符，连续空格会被切成很多 <code>&quot;&quot;</code>，结果数组是：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[<span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;fly&quot;</span>, <span class="string">&quot;me&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;to&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;the&quot;</span>, <span class="string">&quot;moon&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>]</span></span><br></pre></td></tr></table></figure><ol start="2"><li>从后往前遍历</li></ol><ul><li><code>i = 13</code> → <code>strs[13] = &quot;&quot;</code> → 空字符串，跳过</li><li><code>i = 12</code> → <code>strs[12] = &quot;&quot;</code> → 空字符串，跳过</li><li><code>i = 11</code> → <code>strs[11] = &quot;moon&quot;</code> → <strong>非空字符串！说明我们找到了最后一个单词</strong><br>👉 直接返回 <code>&quot;moon&quot;.length() = 4</code></li></ul><p>所以输出是 <code>4</code>。</p><hr><p>📌 为什么不是“遇到空字符串就说明最后一个单词结束”？</p><p>这里要注意：</p><ul><li><code>split(&quot; &quot;)</code> 会产生很多空字符串 <code>&quot;&quot;</code>，但这些并不是“单词结束”的标志，而只是因为多个空格被切出来的无效元素。</li><li>真正的 <strong>单词</strong> 一定是 <strong>非空字符串</strong>。</li><li>因此要找“最后一个单词”，就要从后往前，遇到第一个 <strong>非空字符串</strong> 才返回长度。</li></ul><hr><p>📌 再看例子 2</p><p>输入：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">s</span> <span class="operator">=</span> <span class="string">&quot;Hello World&quot;</span></span><br></pre></td></tr></table></figure><p>split 后：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[<span class="string">&quot;Hello&quot;</span>, <span class="string">&quot;World&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>从后往前遍历：</p><ul><li><code>i=1</code> → <code>&quot;World&quot;</code>，非空，直接返回 <code>5</code>。</li></ul><hr><p>✅ 总结：<br>你的理解差了一点点：</p><ul><li><strong>空字符串 <code>&quot;&quot;</code> 只是空格切出来的垃圾，不代表单词结束</strong>。</li><li><strong>第一个非空字符串才是最后一个单词</strong>。</li></ul><hr><h2 id="6-最长公共前缀（简单）">6.最长公共前缀（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-331.png" alt="img"></p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">String</span> longestCommonPrefix(<span class="type">String</span>[] strs) &#123;</span><br><span class="line">         <span class="keyword">if</span>(strs.length<span class="operator">==</span><span class="number">0</span>) <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">         <span class="type">String</span> <span class="keyword">prefix</span> <span class="operator">=</span> strs[<span class="number">0</span>];<span class="comment">//初始化最长公共前缀为第一个字符串</span></span><br><span class="line">        <span class="comment">//遍历字符串数组，逐个与当前最长公共前缀进行比较</span></span><br><span class="line">         <span class="keyword">for</span>(int i <span class="operator">=</span> <span class="number">1</span>; i <span class="operator">&lt;</span> strs.length; i<span class="operator">++</span>)&#123;</span><br><span class="line">             <span class="comment">//如果当前字符串不是以最长公共前缀开头，则更新最长公共前缀</span></span><br><span class="line">             <span class="keyword">while</span>(strs[i].indexOf(<span class="keyword">prefix</span>) <span class="operator">!=</span> <span class="number">0</span>)&#123;</span><br><span class="line">                 <span class="comment">//去掉最长公共前缀的最后一个字符，直到当前字符串以更新后的最长公共前缀开头或最长公共前缀为空</span></span><br><span class="line">                 <span class="keyword">prefix</span> <span class="operator">=</span> <span class="keyword">prefix</span>.substring(<span class="number">0</span>, <span class="keyword">prefix</span>.length() <span class="operator">-</span> <span class="number">1</span>);</span><br><span class="line">                 <span class="keyword">if</span>(<span class="keyword">prefix</span>.isEmpty()) <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">prefix</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>核心思路</p><ol><li><p>假设第一个字符串是最长公共前缀 <code>prefix</code>。</p></li><li><p>从第二个字符串开始，逐个和 <code>prefix</code> 对比。</p></li><li><p>如果当前字符串不是以</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">prefix</span></span><br></pre></td></tr></table></figure><p>开头，就不断缩短</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">prefix</span></span><br></pre></td></tr></table></figure><p>（去掉末尾字符），直到：</p><ul><li>当前字符串以 <code>prefix</code> 开头，或者</li><li><code>prefix</code> 为空（说明不存在公共前缀）。</li></ul></li><li><p>最终返回 <code>prefix</code>。</p></li></ol><p>好的，我们一步步讲解这个 <strong>最长公共前缀 (Longest Common Prefix)</strong> 的代码逻辑。</p><hr><p>🔎 流程拆解（以示例 <code>[&quot;flower&quot;, &quot;flow&quot;, &quot;flight&quot;]</code> 为例）</p><p><strong>初始化</strong></p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String prefix <span class="operator">=</span> strs[<span class="number">0</span>]<span class="comment">; // &quot;flower&quot;</span></span><br></pre></td></tr></table></figure><p>假设公共前缀就是第一个字符串 <code>&quot;flower&quot;</code>。</p><hr><p><strong>第 1 轮对比：和 “flow” 比</strong></p><p>检查 <code>&quot;flow&quot;.indexOf(&quot;flower&quot;)</code>：</p><ul><li>返回 <code>-1</code>，说明 <code>&quot;flow&quot;</code> 不是以 <code>&quot;flower&quot;</code> 开头。<br>于是进入 <code>while</code> 循环，逐步缩短 <code>prefix</code>：</li><li><code>&quot;flow&quot;.indexOf(&quot;flowe&quot;)</code> → -1</li><li><code>&quot;flow&quot;.indexOf(&quot;flow&quot;)</code> → 0 ✅</li></ul><p>此时 <code>prefix = &quot;flow&quot;</code>。</p><hr><p><strong>第 2 轮对比：和 “flight” 比</strong></p><p>检查 <code>&quot;flight&quot;.indexOf(&quot;flow&quot;)</code>：</p><ul><li><p>返回 -1，不是以</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;flow&quot;</span></span><br></pre></td></tr></table></figure><p>开头。缩短：</p><ul><li><code>&quot;flight&quot;.indexOf(&quot;flo&quot;)</code> → -1</li><li><code>&quot;flight&quot;.indexOf(&quot;fl&quot;)</code> → 0 ✅</li></ul></li></ul><p>此时 <code>prefix = &quot;fl&quot;</code>。</p><hr><p><strong>结束</strong></p><p>所有字符串对比完毕，<code>prefix = &quot;fl&quot;</code>，返回结果 <code>&quot;fl&quot;</code>。</p><hr><p>📌 示例 2：<code>[&quot;dog&quot;,&quot;racecar&quot;,&quot;car&quot;]</code></p><ul><li><p>初始化 <code>prefix = &quot;dog&quot;</code></p></li><li><p>比较</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;racecar&quot;</span></span><br></pre></td></tr></table></figure><p>：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;racecar&quot;</span>.indexOf(<span class="string">&quot;dog&quot;</span>) <span class="operator">=</span> -<span class="number">1</span></span><br></pre></td></tr></table></figure><p>→ 缩短 prefix：</p><ul><li><code>&quot;do&quot;</code> → -1</li><li><code>&quot;d&quot;</code> → -1</li><li><code>&quot;&quot;</code> → 空，直接返回 <code>&quot;&quot;</code>。</li></ul></li></ul><p>所以结果是 <code>&quot;&quot;</code>。</p><hr><p>✅ 总结</p><p>这个代码的特点：</p><ul><li><strong>逐步收缩法</strong>：每次缩短 <code>prefix</code>，直到满足条件。</li><li><strong>利用 indexOf</strong>：判断字符串是否以 <code>prefix</code> 开头。</li><li><strong>最坏情况</strong>：所有字符串完全相同 → 遍历一次即可；所有字符串完全不同 → 最快返回 <code>&quot;&quot;</code>。</li></ul><hr><h2 id="7-找出字符串中第一个匹配项的下标（简单）">7.找出字符串中第一个匹配项的下标（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-419-1024x569.png" alt="img"></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    public <span class="keyword">int</span> strStr(String haystack, String needle) &#123;</span><br><span class="line">        <span class="regexp">//i</span>f(needle.isEmpty()) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="regexp">//i</span>f(haystack.isEmpty()) <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> haystack.indexOf(needle);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一行搞定</p><p>用一行 <code>haystack.indexOf(needle)</code> 就能解决「找子串第一次出现的位置」的问题，确实比我们自己写双重循环、KMP 算法看起来简单很多。原因在于 <strong><code>indexOf</code> 已经帮我们封装好了整个查找过程</strong>。我来详细讲讲它的原理。</p><hr><ol><li><code>indexOf</code> 的作用</li></ol><p>在 Java 中：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int index <span class="operator">=</span> haystack.indexOf(needle)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>返回 <strong>子串 <code>needle</code> 在 <code>haystack</code> 中第一次出现的下标</strong>。</p><ul><li>如果存在 → 返回第一个匹配的下标。</li><li>如果不存在 → 返回 <code>-1</code>。</li></ul><p>这正好就是 LeetCode 第 28 题要求的功能。</p><hr><ol start="2"><li><code>indexOf</code> 的原理</li></ol><p>不同 JDK 版本底层实现略有差别，但思路大致一样。核心是 <strong>字符串匹配算法</strong>：</p><p>常见的实现方式</p><ol><li>暴力匹配（Brute Force）<ul><li>遍历 <code>haystack</code> 的每个可能起点 <code>i</code>，</li><li>检查从 <code>i</code> 开始的子串是否等于 <code>needle</code>。</li><li>时间复杂度：O(n * m)，其中 n = haystack 长度，m = needle 长度。<br>（在 needle 很短的场景下，这种方法足够快。）</li></ul></li><li>Boyer-Moore / KMP 等优化算法<ul><li>为了减少回溯，<code>indexOf</code> 在一些 JDK 中会用到 <strong>Boyer-Moore</strong> 的 “坏字符规则” 优化。</li><li>这样平均复杂度接近 O(n)。</li></ul></li><li>本地优化（Native Code / Intrinsics）<ul><li>在一些 JVM 实现中，如果 needle 只有一个字符，直接调用更快的 <code>char[]</code> 扫描函数（比如 C 的 <code>memchr</code>）。</li><li>如果 needle 较长，可能结合多种策略。</li></ul></li></ol><hr><ol start="3"><li>为什么一行就能做？</li></ol><p>因为 <code>indexOf</code> <strong>本身就是一个完整的子串查找实现</strong>，它在 JDK 里已经帮我们写好了底层逻辑，并且做了大量优化：</p><ul><li>边界情况（空字符串、needle 长度大于 haystack 等）。</li><li>不同场景下选择最优算法。</li><li>对底层 <code>char[]</code> 做了高效比较。</li></ul><p>所以，我们直接调用 <code>indexOf</code>，等价于自己写完整的查找过程。</p><hr><ol start="4"><li>举个例子走一遍</li></ol><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">haystack</span> <span class="operator">=</span> <span class="string">&quot;sadbutsad&quot;</span><span class="comment">;</span></span><br><span class="line"><span class="attribute">needle</span>   <span class="operator">=</span> <span class="string">&quot;sad&quot;</span><span class="comment">;</span></span><br></pre></td></tr></table></figure><ul><li><code>indexOf</code> 从位置 0 开始比对：<br>haystack[0…2] = “sad”，刚好等于 needle → 返回 0。</li></ul><p>再比如：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">haystack</span> <span class="operator">=</span> <span class="string">&quot;leetcode&quot;</span><span class="comment">;</span></span><br><span class="line"><span class="attribute">needle</span>   <span class="operator">=</span> <span class="string">&quot;leeto&quot;</span><span class="comment">;</span></span><br></pre></td></tr></table></figure><ul><li>从位置 0 开始：haystack[0…4] = “leetc”，不等于 needle。</li><li>继续滑动窗口直到末尾，也没匹配 → 返回 -1。</li></ul><hr><p>✅ 总结：</p><ul><li><code>indexOf</code> 内部帮你实现了 <strong>子串搜索算法</strong>（暴力 / Boyer-Moore / 优化）。</li><li>你一行调用它，就等价于把整个查找逻辑搬过来了。</li><li>所以这道题其实考的不是写 <code>indexOf</code>，而是 <strong>能否自己实现一个类似功能</strong>，比如用暴力或 KMP。</li></ul><hr><p>下面给你一个KMP（Knuth–Morris–Pratt）版本的 <code>strStr</code> 实现（Java），以及要点讲解。</p><hr><p>思路速览</p><ul><li><strong>目标</strong>：在主串 <code>haystack</code> 中找模式串 <code>needle</code> 的第一次出现位置。</li><li><strong>关键</strong>：预处理 <code>needle</code> 得到 <strong>最长相等前后缀表</strong>（也叫 <code>lps</code> 或 <code>next</code> 数组），当失配时，模式串可以按照 <code>lps</code> 跳过一部分，避免主串回退，整体时间复杂度 <strong>O(n + m)</strong>。</li></ul><hr><p>代码（Java）</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="type">int</span> <span class="title">strStr</span><span class="params">(<span class="type">String</span> haystack, <span class="type">String</span> needle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (needle.<span class="built_in">length</span>() == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>;      <span class="comment">// 习题定义：空模式返回 0</span></span><br><span class="line">        <span class="keyword">if</span> (haystack.<span class="built_in">length</span>() &lt; needle.<span class="built_in">length</span>()) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">char</span>[] s = haystack.<span class="built_in">toCharArray</span>();</span><br><span class="line">        <span class="type">char</span>[] p = needle.<span class="built_in">toCharArray</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span>[] lps = <span class="built_in">buildLps</span>(p); <span class="comment">// 构建模式串的最长前后缀数组</span></span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> i = <span class="number">0</span>; <span class="comment">// haystack 指针</span></span><br><span class="line">        <span class="type">int</span> j = <span class="number">0</span>; <span class="comment">// needle   指针</span></span><br><span class="line">        <span class="keyword">while</span> (i &lt; s.length) &#123;</span><br><span class="line">            <span class="keyword">if</span> (s[i] == p[j]) &#123;</span><br><span class="line">                i++;</span><br><span class="line">                j++;</span><br><span class="line">                <span class="keyword">if</span> (j == p.length) &#123;</span><br><span class="line">                    <span class="keyword">return</span> i - j;   <span class="comment">// 找到第一次出现的位置</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (j &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    j = lps[j - <span class="number">1</span>]; <span class="comment">// 利用 lps 回退 needle 的指针</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    i++;            <span class="comment">// j==0，无可回退，只能推进主串</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建 lps（Longest Prefix that is also Suffix）数组</span></span><br><span class="line">    <span class="comment">// lps[k] 表示 p[0..k] 这个前缀的“最长真前缀==后缀”的长度</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span>[] <span class="built_in">buildLps</span>(<span class="type">char</span>[] p) &#123;</span><br><span class="line">        <span class="type">int</span> n = p.length;</span><br><span class="line">        <span class="type">int</span>[] lps = <span class="keyword">new</span> <span class="type">int</span>[n];</span><br><span class="line">        <span class="comment">// len 表示当前前后缀的匹配长度，lps[0] = 0</span></span><br><span class="line">        <span class="type">int</span> len = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">while</span> (len &gt; <span class="number">0</span> &amp;&amp; p[i] != p[len]) &#123;</span><br><span class="line">                len = lps[len - <span class="number">1</span>];  <span class="comment">// 继续回退，寻找更短的可匹配前后缀</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (p[i] == p[len]) &#123;</span><br><span class="line">                len++;</span><br><span class="line">            &#125;</span><br><span class="line">            lps[i] = len;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> lps;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p>关键点解释</p><ol><li><p>lps 数组含义</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lps<span class="selector-attr">[i]</span></span><br></pre></td></tr></table></figure><p>：表示</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">needle</span>[<span class="number">0</span>..i]</span><br></pre></td></tr></table></figure><p>这个子串的最长“真前缀 == 真后缀”的长度。</p><ul><li>例如模式串 <code>&quot;ababaca&quot;</code> 的 <code>lps</code> 为 <code>[0,0,1,2,3,0,1]</code>。</li></ul></li><li><p>匹配过程</p><ul><li>若 <code>s[i] == p[j]</code>：两指针同时右移。若 <code>j</code> 达到 <code>p.length</code>，说明完全匹配，返回起始下标 <code>i - j</code>。</li><li>若不匹配：<ul><li>若 <code>j &gt; 0</code>，利用 <code>lps[j-1]</code> 回退 <code>j</code>，避免回退 <code>i</code>；</li><li>若 <code>j == 0</code>，只能推进 <code>i</code>。</li></ul></li></ul></li><li><p>复杂度</p><ul><li>构建 <code>lps</code>：O(m)</li><li>匹配过程：O(n)</li><li>总计：<strong>O(n + m)</strong>，空间 O(m)。</li></ul></li></ol><hr><p>小例子走一下</p><ul><li><pre><code>haystack = &quot;sadbutsad&quot;<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">, </span><br><span class="line"></span><br></pre></td></tr></table></figure>needle = &quot;sad&quot;<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">  -</span> <span class="code">`needle`</span> 的 <span class="code">`lps = [0,0,0]`</span></span><br><span class="line"><span class="bullet">  -</span> 从 i=0, j=0 开始，连续三次匹配成功，j==3 → 返回 <span class="code">`i-j = 0`</span>。</span><br><span class="line"></span><br><span class="line">------</span><br><span class="line"></span><br><span class="line"><span class="section">## 8.验证回文串（简单）</span></span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-420-1024x791.png</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure></code></pre></li></ul><p>class Solution {<br>public boolean isPalindrome(String s) {<br>// 将字符串转换为小写字母<br>s = s.toLowerCase();<br>// 定义两个指针，分别指向字符串的开头和结尾<br>int left = 0;<br>int right = s.length() - 1;<br>while (left &lt; right) {<br>// 如果左指针指向的字符不是字母或数字，则右移<br>if (!Character.isLetterOrDigit(s.charAt(left))) {<br>left++;<br>} else if (!Character.isLetterOrDigit(s.charAt(right))) {<br>// 如果右指针指向的字符不是字母或数字，则左移<br>right–;<br>} else if (s.charAt(left) != s.charAt(right)) {<br>// 如果左右指针指向的字符不相等，则返回false<br>return false;<br>} else {<br>// 否则，同时左移和右移<br>left++;<br>right–;<br>}<br>}<br>// 如果循环结束都没有返回false，则说明字符串是回文串<br>return true;<br>}<br>}</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">方法2</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>class Solution1 {<br>public boolean isPalindrome(String s) {<br>// 将字符串转换为小写字母<br>s = s.toLowerCase();<br>//定义集合存放字符<br>StringBuilder sb = new StringBuilder();<br>for (int i = 0; i &lt; s.length(); i++) {<br>// 如果字符是字母或数字，则添加到集合中<br>if (Character.isLetterOrDigit(s.charAt(i))) {<br>sb.append(s.charAt(i));<br>}<br>}<br>// 正序遍历和倒序遍历，比较字符是否相同<br>for (int i = 0; i &lt; sb.length(); i++) {<br>if (sb.charAt(i) != sb.charAt(sb.length() - 1 - i)) {<br>return false;<br>}<br>}<br>return true;<br>}<br>}</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">## 9.判断子序列（简单）</span></span><br><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">09</span>/image-<span class="number">421</span>-<span class="number">1024</span>x617.png)</span><br><span class="line"></span><br><span class="line">双指针法</span><br><span class="line"></span><br><span class="line">左指针指向s字符串，右指针指向t字符串</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>class Solution {<br>public boolean isSubsequence(String s, String t) {<br>int left = 0;   // 指针1，遍历 s<br>int right = 0;  // 指针2，遍历 t</p><pre><code>    while (left &lt; s.length() &amp;&amp; right &lt; t.length()) &#123;        if (s.charAt(left) == t.charAt(right)) &#123;            // 当前字符匹配成功，移动 s 的指针            left++;        &#125;        // 不管是否匹配，t 的指针都要往前走        right++;    &#125;    // 如果 s 的所有字符都被匹配完，则说明 s 是 t 的子序列    return left == s.length();&#125;</code></pre><p>}</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">## 10.赎金信（简单）</span></span><br><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">09</span>/image-<span class="number">422</span>-<span class="number">1024</span>x794.png)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>class Solution {<br>public boolean canConstruct(String ransomNote, String magazine) {<br>if (ransomNote.length() &gt; magazine.length()) {<br>return false;<br>}<br>int[] count = new int[26];<br>//统计每个magazine字符出现的次数<br>for (char c : magazine.toCharArray()) {<br>count[c - ‘a’]++;<br>}<br>//遍历ransomNote，如果字符在magazine中出现过则计数减一<br>for (char c : ransomNote.toCharArray()) {<br>if (count[c - ‘a’] == 0) {<br>return false;//如果字符在magazine中未出现过，则返回false;<br>}<br>//如果字符在magazine中出现过，则计数减一<br>count[c - ‘a’]–;<br>}<br>return true;<br>}<br>}</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">## 11.同构字符串（简单）</span></span><br><span class="line"></span><br><span class="line">![img](https:<span class="regexp">//</span>www.legendkiller.xyz<span class="regexp">/wp-content/u</span>ploads<span class="regexp">/2025/</span><span class="number">09</span>/image-<span class="number">423</span>-<span class="number">1024</span>x765.png)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>class Solution {<br>public boolean isIsomorphic(String s, String t) {<br>if (s.length() != t.length()) {<br>return false;<br>}<br>int[] sMap = new int[256];//记录s中每个字符出现的次数<br>int[] tMap = new int[256];//记录t中每个字符出现的次数<br>// 遍历字符串s和t，如果两个字符在各自映射表中出现的次数不同，则返回false;<br>for (int i = 0; i &lt; s.length(); i++) {<br>char sc = s.charAt(i);<br>char tc = t.charAt(i);</p><pre><code>        // 检查s中的字符sc在sMap中的映射值与t中的字符tc在tMap中的映射值是否相等        if (sMap[sc] != tMap[tc]) &#123;            return false;        &#125;        // 更新sMap和tMap，将当前字符的映射值设置为当前索引i+1        sMap[sc] = i + 1;        tMap[tc] = i + 1;            &#125;    return true;&#125;</code></pre><p>}</p><pre><code></code></pre>]]></content>
    
    
    <summary type="html">leetcode面试经典 150 题（持续更新）</summary>
    
    
    
    <category term="算法" scheme="https://itgeqian.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="leetcode" scheme="https://itgeqian.github.io/tags/leetcode/"/>
    
  </entry>
  
  <entry>
    <title>TreeMap的put源码详解</title>
    <link href="https://itgeqian.github.io/posts/57.html"/>
    <id>https://itgeqian.github.io/posts/57.html</id>
    <published>2025-09-19T09:09:03.000Z</published>
    <updated>2025-09-19T12:01:00.000Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>TreeMap中每一个节点的内部属性</span><br><span class="line">K key;<span class="comment">//键</span></span><br><span class="line">V value;<span class="comment">//值</span></span><br><span class="line">Entry&amp;lt;K,V&amp;gt; left;<span class="comment">//左子节点</span></span><br><span class="line">Entry&amp;lt;K,V&amp;gt; right;<span class="comment">//右子节点</span></span><br><span class="line">Entry&amp;lt;K,V&amp;gt; parent;<span class="comment">//父节点</span></span><br><span class="line"><span class="type">boolean</span> color;<span class="comment">//节点的颜色</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>TreeMap类中中要知道的一些成员变量</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TreeMap</span>&amp;lt;K,V&amp;gt;&#123;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//比较器对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Comparator&amp;lt;? <span class="built_in">super</span> K&amp;gt; comparator;</span><br><span class="line"></span><br><span class="line"><span class="comment">//根节点</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Entry&amp;lt;K,V&amp;gt; root;</span><br><span class="line"></span><br><span class="line"><span class="comment">//集合的长度</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line"></span><br><span class="line"><span class="number">3.</span>空参构造</span><br><span class="line"><span class="comment">//空参构造就是没有传递比较器对象</span></span><br><span class="line"> <span class="keyword">public</span> <span class="title function_">TreeMap</span><span class="params">()</span> &#123;</span><br><span class="line">        comparator = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span>带参构造</span><br><span class="line"><span class="comment">//带参构造就是传递了比较器对象。</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">TreeMap</span><span class="params">(Comparator&amp;lt;? <span class="built_in">super</span> K&amp;gt; comparator)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.comparator = comparator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">5.</span>添加元素</span><br><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> put(key, value, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">参数一：键</span><br><span class="line">参数二：值</span><br><span class="line">参数三：当键重复的时候，是否需要覆盖值</span><br><span class="line"><span class="literal">true</span>：覆盖</span><br><span class="line"><span class="literal">false</span>：不覆盖</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> V <span class="title function_">put</span><span class="params">(K key, V value, <span class="type">boolean</span> replaceOld)</span> &#123;</span><br><span class="line"><span class="comment">//获取根节点的地址值，赋值给局部变量t</span></span><br><span class="line">        Entry&amp;lt;K,V&amp;gt; t = root;</span><br><span class="line"><span class="comment">//判断根节点是否为null</span></span><br><span class="line"><span class="comment">//如果为null，表示当前是第一次添加，会把当前要添加的元素，当做根节点</span></span><br><span class="line"><span class="comment">//如果不为null，表示当前不是第一次添加，跳过这个判断继续执行下面的代码</span></span><br><span class="line">        <span class="keyword">if</span> (t == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="comment">//方法的底层，会创建一个Entry对象，把他当做根节点</span></span><br><span class="line">            addEntryToEmptyMap(key, value);</span><br><span class="line"><span class="comment">//表示此时没有覆盖任何的元素</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//表示两个元素的键比较之后的结果</span></span><br><span class="line">        <span class="type">int</span> cmp;</span><br><span class="line"><span class="comment">//表示当前要添加节点的父节点</span></span><br><span class="line">        Entry&amp;lt;K,V&amp;gt; parent;</span><br><span class="line"></span><br><span class="line"><span class="comment">//表示当前的比较规则</span></span><br><span class="line"><span class="comment">//如果我们是采取默认的自然排序，那么此时comparator记录的是null，cpr记录的也是null</span></span><br><span class="line"><span class="comment">//如果我们是采取比较去排序方式，那么此时comparator记录的是就是比较器</span></span><br><span class="line">        Comparator&amp;lt;? <span class="built_in">super</span> K&amp;gt; cpr = comparator;</span><br><span class="line"><span class="comment">//表示判断当前是否有比较器对象</span></span><br><span class="line"><span class="comment">//如果传递了比较器对象，就执行if里面的代码，此时以比较器的规则为准</span></span><br><span class="line"><span class="comment">//如果没有传递比较器对象，就执行else里面的代码，此时以自然排序的规则为准</span></span><br><span class="line">        <span class="keyword">if</span> (cpr != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                parent = t;</span><br><span class="line">                cmp = cpr.compare(key, t.key);</span><br><span class="line">                <span class="keyword">if</span> (cmp &amp;lt; <span class="number">0</span>)</span><br><span class="line">                    t = t.left;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (cmp &amp;gt; <span class="number">0</span>)</span><br><span class="line">                    t = t.right;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> t.value;</span><br><span class="line">                    <span class="keyword">if</span> (replaceOld || oldValue == <span class="literal">null</span>) &#123;</span><br><span class="line">                        t.value = value;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> oldValue;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">while</span> (t != <span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//把键进行强转，强转成Comparable类型的</span></span><br><span class="line"><span class="comment">//要求：键必须要实现Comparable接口，如果没有实现这个接口</span></span><br><span class="line"><span class="comment">//此时在强转的时候，就会报错。</span></span><br><span class="line">            Comparable&amp;lt;? <span class="built_in">super</span> K&amp;gt; k = (Comparable&amp;lt;? <span class="built_in">super</span> K&amp;gt;) key;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line"><span class="comment">//把根节点当做当前节点的父节点</span></span><br><span class="line">                parent = t;</span><br><span class="line"><span class="comment">//调用compareTo方法，比较根节点和当前要添加节点的大小关系</span></span><br><span class="line">                cmp = k.compareTo(t.key);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (cmp &amp;lt; <span class="number">0</span>)</span><br><span class="line"><span class="comment">//如果比较的结果为负数</span></span><br><span class="line"><span class="comment">//那么继续到根节点的左边去找</span></span><br><span class="line">                    t = t.left;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (cmp &amp;gt; <span class="number">0</span>)</span><br><span class="line"><span class="comment">//如果比较的结果为正数</span></span><br><span class="line"><span class="comment">//那么继续到根节点的右边去找</span></span><br><span class="line">                    t = t.right;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//如果比较的结果为0，会覆盖</span></span><br><span class="line">                    <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> t.value;</span><br><span class="line">                    <span class="keyword">if</span> (replaceOld || oldValue == <span class="literal">null</span>) &#123;</span><br><span class="line">                        t.value = value;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> oldValue;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">while</span> (t != <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//就会把当前节点按照指定的规则进行添加</span></span><br><span class="line">        addEntry(key, value, parent, cmp &amp;lt; <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addEntry</span><span class="params">(K key, V value, Entry&amp;lt;K, V&amp;gt; parent, <span class="type">boolean</span> addToLeft)</span> &#123;</span><br><span class="line">        Entry&amp;lt;K,V&amp;gt; e = <span class="keyword">new</span> <span class="title class_">Entry</span>&amp;lt;&amp;gt;(key, value, parent);</span><br><span class="line">        <span class="keyword">if</span> (addToLeft)</span><br><span class="line">            parent.left = e;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            parent.right = e;</span><br><span class="line"><span class="comment">//添加完毕之后，需要按照红黑树的规则进行调整</span></span><br><span class="line">        fixAfterInsertion(e);</span><br><span class="line">        size++;</span><br><span class="line">        modCount++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">fixAfterInsertion</span><span class="params">(Entry&amp;lt;K,V&amp;gt; x)</span> &#123;</span><br><span class="line"><span class="comment">//因为红黑树的节点默认就是红色的</span></span><br><span class="line">        x.color = RED;</span><br><span class="line"></span><br><span class="line"><span class="comment">//按照红黑规则进行调整</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//parentOf:获取x的父节点</span></span><br><span class="line"><span class="comment">//parentOf(parentOf(x)):获取x的爷爷节点</span></span><br><span class="line"><span class="comment">//leftOf:获取左子节点</span></span><br><span class="line">        <span class="keyword">while</span> (x != <span class="literal">null</span> &amp;&amp; x != root &amp;&amp; x.parent.color == RED) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//判断当前节点的父节点是爷爷节点的左子节点还是右子节点</span></span><br><span class="line"><span class="comment">//目的：为了获取当前节点的叔叔节点</span></span><br><span class="line">            <span class="keyword">if</span> (parentOf(x) == leftOf(parentOf(parentOf(x)))) &#123;</span><br><span class="line"><span class="comment">//表示当前节点的父节点是爷爷节点的左子节点</span></span><br><span class="line"><span class="comment">//那么下面就可以用rightOf获取到当前节点的叔叔节点</span></span><br><span class="line">                Entry&amp;lt;K,V&amp;gt; y = rightOf(parentOf(parentOf(x)));</span><br><span class="line">                <span class="keyword">if</span> (colorOf(y) == RED) &#123;</span><br><span class="line"><span class="comment">//叔叔节点为红色的处理方案</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//把父节点设置为黑色</span></span><br><span class="line">                    setColor(parentOf(x), BLACK);</span><br><span class="line"><span class="comment">//把叔叔节点设置为黑色</span></span><br><span class="line">                    setColor(y, BLACK);</span><br><span class="line"><span class="comment">//把爷爷节点设置为红色</span></span><br><span class="line">                    setColor(parentOf(parentOf(x)), RED);</span><br><span class="line"></span><br><span class="line"><span class="comment">//把爷爷节点设置为当前节点</span></span><br><span class="line">                    x = parentOf(parentOf(x));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//叔叔节点为黑色的处理方案</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//表示判断当前节点是否为父节点的右子节点</span></span><br><span class="line">                    <span class="keyword">if</span> (x == rightOf(parentOf(x))) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//表示当前节点是父节点的右子节点</span></span><br><span class="line">                        x = parentOf(x);</span><br><span class="line"><span class="comment">//左旋</span></span><br><span class="line">                        rotateLeft(x);</span><br><span class="line">                    &#125;</span><br><span class="line">                    setColor(parentOf(x), BLACK);</span><br><span class="line">                    setColor(parentOf(parentOf(x)), RED);</span><br><span class="line">                    rotateRight(parentOf(parentOf(x)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//表示当前节点的父节点是爷爷节点的右子节点</span></span><br><span class="line"><span class="comment">//那么下面就可以用leftOf获取到当前节点的叔叔节点</span></span><br><span class="line">                Entry&amp;lt;K,V&amp;gt; y = leftOf(parentOf(parentOf(x)));</span><br><span class="line">                <span class="keyword">if</span> (colorOf(y) == RED) &#123;</span><br><span class="line">                    setColor(parentOf(x), BLACK);</span><br><span class="line">                    setColor(y, BLACK);</span><br><span class="line">                    setColor(parentOf(parentOf(x)), RED);</span><br><span class="line">                    x = parentOf(parentOf(x));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (x == leftOf(parentOf(x))) &#123;</span><br><span class="line">                        x = parentOf(x);</span><br><span class="line">                        rotateRight(x);</span><br><span class="line">                    &#125;</span><br><span class="line">                    setColor(parentOf(x), BLACK);</span><br><span class="line">                    setColor(parentOf(parentOf(x)), RED);</span><br><span class="line">                    rotateLeft(parentOf(parentOf(x)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//把根节点设置为黑色</span></span><br><span class="line">        root.color = BLACK;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>TreeMap</code> 是一种基于红黑树实现的 <code>NavigableMap</code> 接口的 <code>Map</code> 实现类，它保证了键值对的顺序是有序的。<code>TreeMap</code> 中的每个节点是一个 <code>Entry</code>，而它们之间通过红黑树的结构来连接，保证了在插入、删除、查找等操作时的对数时间复杂度。</p><h2 id="1-TreeMap-节点的内部属性">1. <strong><code>TreeMap</code> 节点的内部属性</strong></h2><p>每个节点（<code>Entry</code>）包含以下属性：</p><ul><li><strong><code>K key</code></strong>：节点的键。</li><li><strong><code>V value</code></strong>：节点的值。</li><li><strong><code>Entry&lt;K,V&gt; left</code></strong>：左子节点。</li><li><strong><code>Entry&lt;K,V&gt; right</code></strong>：右子节点。</li><li><strong><code>Entry&lt;K,V&gt; parent</code></strong>：父节点。</li><li><strong><code>boolean color</code></strong>：节点的颜色，红黑树会使用红色和黑色来平衡树的结构。</li></ul><h2 id="2-TreeMap-类中的一些成员变量">2. <strong><code>TreeMap</code> 类中的一些成员变量</strong></h2><ul><li><strong><code>Comparator&lt;? super K&gt; comparator</code></strong>：用于比较键的比较器。默认情况下，<code>TreeMap</code> 会使用自然顺序（即 <code>Comparable</code> 接口），如果传入了自定义比较器，则使用该比较器。</li><li><strong><code>Entry&lt;K,V&gt; root</code></strong>：根节点，用于存储树的最上层节点。</li><li><strong><code>int size</code></strong>：<code>TreeMap</code> 中元素的数量。</li></ul><h2 id="3-构造方法">3. <strong>构造方法</strong></h2><ul><li><strong>空参构造</strong>： <code>public TreeMap() &#123; comparator = null; // 默认使用自然顺序比较键 &#125;</code></li><li><strong>带参构造</strong>： <code>public TreeMap(Comparator&lt;? super K&gt; comparator) &#123; this.comparator = comparator; // 使用自定义的比较器 &#125;</code></li></ul><h2 id="4-添加元素">4. <strong>添加元素</strong></h2><p><code>TreeMap</code> 的 <code>put</code> 方法用来插入元素。我们首先来看 <code>put(K key, V value)</code> 的实现：</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public V <span class="built_in">put</span>(K <span class="built_in">key</span>, V value) &#123;</span><br><span class="line">    <span class="built_in">return</span> <span class="built_in">put</span>(<span class="built_in">key</span>, value, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个方法会调用下面的 <code>put(K key, V value, boolean replaceOld)</code> 方法。第二个参数 <code>replaceOld</code> 表示当键重复时是否覆盖值。</p><h3 id="put-方法的核心部分："><code>put</code> 方法的核心部分：</h3><ol><li><p><strong>首先判断是否是空树</strong>：<br>如果根节点为空（即 <code>root == null</code>），说明这是第一次添加元素，此时直接调用 <code>addEntryToEmptyMap</code> 将新节点添加为根节点。</p></li><li><p>非空树的情况</p><p>：</p><p>如果树不为空，会进入循环判断新节点应该插入的位置。插入的位置由比较器或者自然顺序决定：</p><ul><li>如果使用了比较器，就通过 <code>comparator.compare()</code> 来比较。</li><li>如果没有比较器，则使用键的 <code>compareTo</code> 方法进行比较。</li></ul></li><li><p>键是否已存在</p><p>：</p><ul><li>如果找到相同的键，且 <code>replaceOld</code> 为 <code>true</code>，则覆盖旧的值；否则，保持原值不变。</li></ul></li><li><p><strong>插入新节点</strong>：<br>如果没有找到相同的键，则会调用 <code>addEntry</code> 方法将新节点插入到合适的位置，并调用 <code>fixAfterInsertion</code> 方法来进行红黑树的平衡操作。</p></li></ol><h2 id="5-插入节点方法">5. <strong>插入节点方法</strong></h2><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addEntry</span>(K <span class="built_in">key</span>, V value, Entry&lt;K, V&gt; parent, <span class="type">boolean</span> addToLeft) &#123;</span><br><span class="line">    Entry&lt;K,V&gt; e = <span class="keyword">new </span><span class="class title_">Entry</span>&lt;&gt;(<span class="built_in">key</span>, value, parent);</span><br><span class="line">    <span class="keyword">if</span> (addToLeft) parent.<span class="property">left</span> = e;</span><br><span class="line">    <span class="keyword">else</span> parent.<span class="property">right</span> = e;</span><br><span class="line">    <span class="title function_">fixAfterInsertion</span>(e);</span><br><span class="line">    <span class="built_in">size</span>++;</span><br><span class="line">    modCount++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该方法会创建一个新的 <code>Entry</code> 对象，并将其插入到父节点的左子节点或右子节点。插入后，需要调用 <code>fixAfterInsertion</code> 来确保红黑树的平衡。</p><h2 id="6-红黑树的平衡（fixAfterInsertion）">6. <strong>红黑树的平衡（<code>fixAfterInsertion</code>）</strong></h2><p>在 <code>TreeMap</code> 中，红黑树的平衡操作是通过 <code>fixAfterInsertion</code> 来完成的。此方法确保树的红黑性质在插入节点后得到修复。</p><p>红黑树的修复遵循如下规则：</p><ul><li>节点的颜色初始为红色。</li><li>如果父节点是红色的，则需要进行调整。<ul><li><strong>情况1</strong>：父节点是左子节点，叔叔节点是红色，则将父节点和叔叔节点颜色设置为黑色，祖父节点设置为红色，并将当前节点向上移动。</li><li><strong>情况2</strong>：父节点是左子节点，叔叔节点是黑色，当前节点是右子节点，则需要左旋父节点。</li><li><strong>情况3</strong>：父节点是右子节点，叔叔节点是红色，则处理方式与情况1类似；父节点是右子节点，叔叔节点是黑色，当前节点是左子节点，则需要右旋父节点。</li></ul></li></ul><p>每次修复完成后，根节点的颜色会被设置为黑色。</p><h2 id="7-旋转操作">7. <strong>旋转操作</strong></h2><p>红黑树的旋转操作用于调整树的结构，常见的旋转操作包括左旋和右旋。这些操作有助于保持树的平衡。</p><ul><li><strong>左旋</strong>：如果当前节点是父节点的右子节点且不满足红黑树的性质，就需要进行左旋。</li><li><strong>右旋</strong>：如果当前节点是父节点的左子节点且不满足红黑树的性质，就需要进行右旋。</li></ul><p>这些旋转操作的目的是保持树的平衡，使得树的高度不会过高，从而保证查找、插入和删除操作的时间复杂度为 O(log N)。</p><h2 id="8-课堂思考问题">8.课堂思考问题</h2><h3 id="8-1-TreeMap-添加元素时，键是否需要重写-hashCode-和-equals-方法？">8.1 <strong>TreeMap 添加元素时，键是否需要重写 <code>hashCode</code> 和 <code>equals</code> 方法？</strong></h3><p><strong>答案</strong>：不需要。</p><p><strong>解析</strong>：</p><ul><li><code>TreeMap</code> 是基于红黑树实现的，元素的排序是根据键的比较结果来决定的，不是基于键的哈希值。所以在 <code>TreeMap</code> 中，并不需要重写 <code>hashCode</code> 和 <code>equals</code> 方法。</li><li><code>TreeMap</code> 会通过 <code>Comparator</code>（如果传入了比较器）或者键实现的 <code>Comparable</code> 接口来决定键的顺序，而不是依赖于哈希值。</li><li>这与 <code>HashMap</code> 不同，<code>HashMap</code> 是基于哈希表实现的，依赖于 <code>hashCode</code> 和 <code>equals</code> 方法来定位键的位置。</li></ul><h3 id="8-2-HashMap-是哈希表结构的，JDK-8-开始由数组、链表、红黑树组成的。既然有红黑树，HashMap-的键是否需要实现-Comparable-接口或者传递比较器对象呢？">8.2 <strong>HashMap 是哈希表结构的，JDK 8 开始由数组、链表、红黑树组成的。既然有红黑树，<code>HashMap</code> 的键是否需要实现 <code>Comparable</code> 接口或者传递比较器对象呢？</strong></h3><p><strong>答案</strong>：不需要。</p><p><strong>解析</strong>：</p><ul><li><code>HashMap</code> 内部使用的是哈希值来决定元素的存储位置。哈希值是在 <code>hashCode</code> 方法中计算的，所以不需要使用 <code>Comparable</code> 接口或者传递比较器。</li><li>在 <code>HashMap</code> 中，红黑树的引入是为了优化链表的查找性能。当哈希冲突发生时，如果链表长度超过某个阈值（8），链表就会转换成红黑树。</li><li>红黑树的引入仅仅是为了提高插入和查找的效率，特别是在哈希冲突严重时，转换为红黑树会使得查找的复杂度从 O(n) 降低到 O(log n)。</li><li>由于 <code>HashMap</code> 只关心哈希值和 <code>equals</code> 方法来确定键的位置，所以并不需要 <code>Comparable</code> 接口或比较器对象来进行排序。</li></ul><h3 id="8-3-TreeMap-和-HashMap-谁的效率更高？">8.3 <strong><code>TreeMap</code> 和 <code>HashMap</code> 谁的效率更高？</strong></h3><p><strong>答案</strong>：<code>HashMap</code> 的效率一般更高，但在特定的情况下，<code>TreeMap</code> 可能会更高。</p><p><strong>解析</strong>：</p><ul><li><strong><code>HashMap</code></strong>：基于哈希表实现，平均情况下 <code>put</code>、<code>get</code> 操作的时间复杂度为 O(1)。但在最坏情况下，如果发生严重的哈希冲突（例如所有元素都映射到同一个桶），就会退化成链表，时间复杂度为 O(n)。</li><li><strong><code>TreeMap</code></strong>：基于红黑树实现，所有操作（<code>put</code>、<code>get</code> 等）的时间复杂度都是 O(log n)。即使哈希冲突严重，<code>TreeMap</code> 也能保持稳定的性能。</li></ul><p>在最坏情况下，如果 <code>TreeMap</code> 中的节点构成链表（例如所有元素的比较结果相同），其效率会比 <code>HashMap</code> 更高，但这种情况非常少见。一般情况下，<code>HashMap</code> 的效率更高，特别是在没有严重哈希冲突的情况下。</p><h3 id="8-4-你觉得在-Map-集合中，Java-会提供一个如果键重复了，不会覆盖的-put-方法吗？">8.4 <strong>你觉得在 Map 集合中，Java 会提供一个如果键重复了，不会覆盖的 <code>put</code> 方法吗？</strong></h3><p><strong>答案</strong>：<code>putIfAbsent</code> 本身并不重要，关键是传递了“如果键重复了，是否覆盖”的思想。</p><p><strong>解析</strong>：</p><ul><li><code>putIfAbsent</code> 方法的作用是：如果键不存在，则插入键值对；如果键已存在，则不做任何操作。这可以避免键重复时覆盖值的情况。</li><li>这个问题的背后，实际上是在思考如何控制逻辑中的“覆盖”行为。在实际编程中，我们经常需要根据不同的需求来决定是否允许覆盖现有值，<code>putIfAbsent</code> 提供了一种不覆盖的方案。</li><li>这里提到的“代码中的逻辑都有两面性”，可以理解为在实际开发中，我们常常需要控制一些操作的“行为”，而 <code>boolean</code> 和 <code>int</code> 类型的变量常常用来控制这种行为的不同状态。比如 <code>replaceOld</code> 参数控制了是否替换旧值，而 <code>putIfAbsent</code> 则是控制是否仅在键不存在时插入值。</li></ul><h3 id="8-5-三种双列集合，如何选择？（HashMap，LinkedHashMap，TreeMap）">8.5 <strong>三种双列集合，如何选择？（<code>HashMap</code>，<code>LinkedHashMap</code>，<code>TreeMap</code>）</strong></h3><p><strong>答案</strong>：选择不同的集合取决于你的需求：</p><ul><li><p><code>HashMap</code></p><p>：</p><ul><li><strong>默认选择</strong>：当我们只关心元素的插入和查询效率，并不关心元素的顺序时，<code>HashMap</code> 是最合适的选择。</li><li><strong>效率</strong>：<code>HashMap</code> 的查询和插入操作的时间复杂度是 O(1)，适用于大多数场景。</li></ul></li><li><p><code>LinkedHashMap</code></p><p>：</p><ul><li><strong>当需要保证元素的插入顺序时使用</strong>：<code>LinkedHashMap</code> 保证了插入顺序或访问顺序（通过构造器指定）。在某些场景下，我们需要根据插入顺序或访问顺序来处理元素，<code>LinkedHashMap</code> 便提供了这一功能。</li><li><strong>适用场景</strong>：如缓存实现、LRU（最近最少使用）缓存、处理顺序敏感的数据时。</li></ul></li><li><p><code>TreeMap</code></p><p>：</p><ul><li><strong>当需要保证元素的顺序时使用</strong>：<code>TreeMap</code> 会按照键的自然顺序或通过传入的比较器进行排序。如果需要一个排序的映射，<code>TreeMap</code> 是最好的选择。</li><li><strong>适用场景</strong>：如实现排序后的数据存储，或者需要按照某种规则对元素进行顺序遍历时。</li></ul></li></ul><h4 id="总结：">总结：</h4><ul><li><strong><code>TreeMap</code></strong> 用于需要顺序排序的场景。</li><li><strong><code>LinkedHashMap</code></strong> 用于需要保持元素插入顺序的场景。</li><li><strong><code>HashMap</code></strong> 用于大多数普通的 <code>Map</code> 使用场景，提供了最好的性能（除非有特殊的顺序需求）。</li></ul><p>这就是对课堂思考问题的详细解答，希望对你有帮助！如果有任何问题，随时向我提问！</p><h2 id="9-总结">9.总结</h2><p><code>TreeMap</code> 是通过红黑树来维护元素的有序性，并保证了操作的对数时间复杂度。它提供了一个有序的 <code>Map</code>，并且允许根据自然顺序或者自定义比较器进行排序。插入元素时，红黑树的平衡操作确保了树的高度不会过高，从而保持较高的性能。</p><p>如果你对其中某个部分的实现有疑问，或者希望我更详细地解释某个步骤，随时告诉我！</p>]]></content>
    
    
    <summary type="html">TreeMap的put源码详解</summary>
    
    
    
    <category term="学习笔记" scheme="https://itgeqian.github.io/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="TreeMap" scheme="https://itgeqian.github.io/tags/TreeMap/"/>
    
  </entry>
  
  <entry>
    <title>HashMap源码的put详解</title>
    <link href="https://itgeqian.github.io/posts/56.html"/>
    <id>https://itgeqian.github.io/posts/56.html</id>
    <published>2025-09-19T01:09:03.000Z</published>
    <updated>2025-09-19T09:03:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="HashMap数据结构">HashMap数据结构</h2><p>当链表节点较少时仍然是以链表存在，当链表节点较多时（大于8）会转为红黑树</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-171-1024x498.png" alt="img"></p><p>类中属性</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HashMap</span>&lt;K,V&gt; <span class="keyword">extends</span> AbstractMap&lt;K,V&gt;</span><br><span class="line">    <span class="keyword">implements</span> Map&lt;K,V&gt;, Cloneable, Serializable &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 默认容量16</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="built_in">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">4</span>; </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 最大容量</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="built_in">int</span> MAXIMUM_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">30</span>;    </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">final</span> float loadFactor;<span class="comment">//负载因子，用于扩容</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 默认负载因子0.75</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> float DEFAULT_LOAD_FACTOR = <span class="number">0.75</span>f; </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 链表节点转换红黑树节点的阈值, 9个节点转</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="built_in">int</span> TREEIFY_THRESHOLD = <span class="number">8</span>; </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 红黑树节点转换链表节点的阈值, 6个节点转</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="built_in">int</span> UNTREEIFY_THRESHOLD = <span class="number">6</span>;   </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 转红黑树时, table的最小长度</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="built_in">int</span> MIN_TREEIFY_CAPACITY = <span class="number">64</span>; </span><br><span class="line"> </span><br><span class="line">    transient Node&lt;K,V&gt;[] table;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 链表节点, 继承自Entry</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;K,V&gt; <span class="keyword">implements</span> Map.Entry&lt;K,V&gt; &#123;  </span><br><span class="line">        <span class="keyword">final</span> <span class="built_in">int</span> hash;</span><br><span class="line">        <span class="keyword">final</span> K key;</span><br><span class="line">        V value;</span><br><span class="line">        Node&lt;K,V&gt; <span class="keyword">next</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// ... ...</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 红黑树节点</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TreeNode</span>&lt;K,V&gt; <span class="keyword">extends</span> LinkedHashMap.Entry&lt;K,V&gt; &#123;</span><br><span class="line">        TreeNode&lt;K,V&gt; parent;  <span class="comment">// red-black tree links</span></span><br><span class="line">        TreeNode&lt;K,V&gt; left;</span><br><span class="line">        TreeNode&lt;K,V&gt; right;</span><br><span class="line">        TreeNode&lt;K,V&gt; prev;    <span class="comment">// needed to unlink next upon deletion</span></span><br><span class="line">        <span class="built_in">boolean</span> red;</span><br><span class="line">   </span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-172-1024x568.png" alt="img"></p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>看源码之前需要了解的一些内容</span><br><span class="line"></span><br><span class="line">Node&amp;lt;K,V&amp;gt;[] table   哈希表结构中数组的名字</span><br><span class="line"></span><br><span class="line">DEFAULT_INITIAL_CAPACITY：   数组默认长度<span class="number">16</span></span><br><span class="line"></span><br><span class="line">DEFAULT_LOAD_FACTOR：        默认加载因子<span class="number">0.75</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">HashMap</span>里面每一个对象包含以下内容：</span><br><span class="line"><span class="number">1.1</span> 链表中的键值对对象</span><br><span class="line">    包含：  </span><br><span class="line">    <span class="type">int</span> hash;         <span class="comment">//键的哈希值</span></span><br><span class="line">            <span class="keyword">final</span> K <span class="built_in">key</span>;      <span class="comment">//键</span></span><br><span class="line">            V value;          <span class="comment">//值</span></span><br><span class="line">            Node&amp;lt;K,V&amp;gt; next;   <span class="comment">//下一个节点的地址值</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">1.2</span> 红黑树中的键值对对象</span><br><span class="line">包含：</span><br><span class="line">    <span class="type">int</span> hash;         <span class="comment">//键的哈希值</span></span><br><span class="line">            <span class="keyword">final</span> K <span class="built_in">key</span>;      <span class="comment">//键</span></span><br><span class="line">            V value;          <span class="comment">//值</span></span><br><span class="line">            TreeNode&amp;lt;K,V&amp;gt; parent;  <span class="comment">//父节点的地址值</span></span><br><span class="line">TreeNode&amp;lt;K,V&amp;gt; left;<span class="comment">//左子节点的地址值</span></span><br><span class="line">TreeNode&amp;lt;K,V&amp;gt; right;<span class="comment">//右子节点的地址值</span></span><br><span class="line"><span class="type">boolean</span> <span class="built_in">red</span>;<span class="comment">//节点的颜色</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>添加元素</span><br><span class="line"><span class="built_in">HashMap</span>&amp;lt;<span class="built_in">String</span>,Integer&amp;gt; hm = <span class="keyword">new </span><span class="class title_">HashMap</span>&amp;lt;&amp;gt;();</span><br><span class="line">hm.<span class="property">put</span>(<span class="string">&quot;aaa&quot;</span> , <span class="number">111</span>);</span><br><span class="line">hm.<span class="property">put</span>(<span class="string">&quot;bbb&quot;</span> , <span class="number">222</span>);</span><br><span class="line">hm.<span class="property">put</span>(<span class="string">&quot;ccc&quot;</span> , <span class="number">333</span>);</span><br><span class="line">hm.<span class="property">put</span>(<span class="string">&quot;ddd&quot;</span> , <span class="number">444</span>);</span><br><span class="line">hm.<span class="property">put</span>(<span class="string">&quot;eee&quot;</span> , <span class="number">555</span>);</span><br><span class="line"></span><br><span class="line">添加元素的时候至少考虑三种情况：</span><br><span class="line"><span class="number">2.1</span>数组位置为<span class="literal">null</span></span><br><span class="line"><span class="number">2.2</span>数组位置不为<span class="literal">null</span>，键不重复，挂在下面形成链表或者红黑树</span><br><span class="line"><span class="number">2.3</span>数组位置不为<span class="literal">null</span>，键重复，元素覆盖</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//参数一：键</span></span><br><span class="line"><span class="comment">//参数二：值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//返回值：被覆盖元素的值，如果没有覆盖，返回null</span></span><br><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span>(K <span class="built_in">key</span>, V value) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">putVal</span>(<span class="title function_">hash</span>(<span class="built_in">key</span>), <span class="built_in">key</span>, value, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//利用键计算出对应的哈希值，再把哈希值进行一些额外的处理</span></span><br><span class="line"><span class="comment">//简单理解：返回值就是返回键的哈希值</span></span><br><span class="line"><span class="comment">//整个过程本质上就是三步：</span></span><br><span class="line"><span class="comment">//(1)拿到 key 的 hashCode 值</span></span><br><span class="line"><span class="comment">//(2)将 hashCode 的高位进行 按位与 运算，重新计算 hash 值</span></span><br><span class="line"><span class="comment">//(3)将计算出来的 hash 值与 (table.length - 1) 进行 &amp; 运算</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span>(<span class="built_in">Object</span> <span class="built_in">key</span>) &#123;</span><br><span class="line">    <span class="type">int</span> h;</span><br><span class="line">     <span class="comment">// 1.先拿到key的hashCode值; 2.将hashCode的高16位参与运算</span></span><br><span class="line">    <span class="comment">//高16位与16位0值异或，低16位与高16位异或</span></span><br><span class="line">    <span class="title function_">return</span> (<span class="built_in">key</span> == <span class="literal">null</span>) ? <span class="number">0</span> : (h = <span class="built_in">key</span>.<span class="property">hashCode</span>()) ^ (h &amp;gt;&amp;gt;&amp;gt; <span class="number">16</span>);</span><br><span class="line">    <span class="type">int</span> n = tab.<span class="property">length</span>;</span><br><span class="line">   <span class="comment">// 将(tab.length - 1) 与 hash值进行&amp;运算</span></span><br><span class="line">   <span class="type">int</span> index = (n - <span class="number">1</span>) &amp; hash;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//参数一：键的哈希值</span></span><br><span class="line"><span class="comment">//参数二：键</span></span><br><span class="line"><span class="comment">//参数三：值</span></span><br><span class="line"><span class="comment">//参数四：如果键重复了是否保留</span></span><br><span class="line"><span class="comment">//   true，表示老元素的值保留，不会覆盖</span></span><br><span class="line"><span class="comment">//   false，表示老元素的值不保留，会进行覆盖</span></span><br><span class="line"><span class="keyword">final</span> V <span class="title function_">putVal</span>(<span class="type">int</span> hash, K <span class="built_in">key</span>, V value, <span class="type">boolean</span> onlyIfAbsent,<span class="type">boolean</span> evict) &#123;</span><br><span class="line">    <span class="comment">//定义一个局部变量，用来记录哈希表中数组的地址值。</span></span><br><span class="line">        Node&amp;lt;K,V&amp;gt;[] tab;</span><br><span class="line"></span><br><span class="line"><span class="comment">//临时的第三方变量，用来记录键值对对象的地址值</span></span><br><span class="line">        Node&amp;lt;K,V&amp;gt; p;</span><br><span class="line">        </span><br><span class="line"><span class="comment">//表示当前数组的长度</span></span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line"></span><br><span class="line"><span class="comment">//表示索引</span></span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line"><span class="comment">//把哈希表中数组的地址值，赋值给局部变量tab</span></span><br><span class="line">tab = table;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="literal">null</span> || (n = tab.<span class="property">length</span>) == <span class="number">0</span>)&#123;</span><br><span class="line"><span class="comment">//1.如果当前是第一次添加数据，底层会创建一个默认长度为16，加载因子为0.75的数组</span></span><br><span class="line"><span class="comment">//2.如果不是第一次添加数据，会看数组中的元素是否达到了扩容的条件</span></span><br><span class="line"><span class="comment">//如果没有达到扩容条件，底层不会做任何操作</span></span><br><span class="line"><span class="comment">//如果达到了扩容条件，底层会把数组扩容为原先的两倍，并把数据全部转移到新的哈希表中</span></span><br><span class="line">tab = <span class="title function_">resize</span>();</span><br><span class="line"><span class="comment">//表示把当前数组的长度赋值给n</span></span><br><span class="line">            n = tab.<span class="property">length</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//拿着数组的长度跟键的哈希值进行计算，计算出当前键值对对象，在数组中应存入的位置</span></span><br><span class="line">i = (n - <span class="number">1</span>) &amp; hash;<span class="comment">//index</span></span><br><span class="line"><span class="comment">//获取数组中对应元素的数据</span></span><br><span class="line">p = tab[i];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (p == <span class="literal">null</span>)&#123;</span><br><span class="line"><span class="comment">//底层会创建一个键值对对象，直接放到数组当中</span></span><br><span class="line">            tab[i] = <span class="title function_">newNode</span>(hash, <span class="built_in">key</span>, value, <span class="literal">null</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            Node&amp;lt;K,V&amp;gt; e;</span><br><span class="line">            K k;</span><br><span class="line"></span><br><span class="line"><span class="comment">//等号的左边：数组中键值对的哈希值</span></span><br><span class="line"><span class="comment">//等号的右边：当前要添加键值对的哈希值</span></span><br><span class="line"><span class="comment">//如果键不一样，此时返回false</span></span><br><span class="line"><span class="comment">//如果键一样，返回true</span></span><br><span class="line"><span class="type">boolean</span> b1 = p.<span class="property">hash</span> == hash;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (b1 &amp;&amp; ((k = p.<span class="property">key</span>) == <span class="built_in">key</span> || (<span class="built_in">key</span> != <span class="literal">null</span> &amp;&amp; <span class="built_in">key</span>.<span class="property">equals</span>(k))))&#123;</span><br><span class="line">                e = p;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)&#123;</span><br><span class="line"><span class="comment">//判断数组中获取出来的键值对是不是红黑树中的节点</span></span><br><span class="line"><span class="comment">//如果是，则调用方法putTreeVal，把当前的节点按照红黑树的规则添加到树当中。</span></span><br><span class="line">                e = ((TreeNode&amp;lt;K,V&amp;gt;)p).<span class="property">putTreeVal</span>(<span class="variable">this</span>, tab, hash, <span class="built_in">key</span>, value);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//如果从数组中获取出来的键值对不是红黑树中的节点</span></span><br><span class="line"><span class="comment">//表示此时下面挂的是链表</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                    <span class="keyword">if</span> ((e = p.<span class="property">next</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="comment">//此时就会创建一个新的节点，挂在下面形成链表</span></span><br><span class="line">                        p.<span class="property">next</span> = <span class="title function_">newNode</span>(hash, <span class="built_in">key</span>, value, <span class="literal">null</span>);</span><br><span class="line"><span class="comment">//判断当前链表长度是否超过8，如果超过8，就会调用方法treeifyBin</span></span><br><span class="line"><span class="comment">//treeifyBin方法的底层还会继续判断</span></span><br><span class="line"><span class="comment">//判断数组的长度是否大于等于64</span></span><br><span class="line"><span class="comment">//如果同时满足这两个条件，就会把这个链表转成红黑树</span></span><br><span class="line">                        <span class="keyword">if</span> (binCount &amp;gt;= TREEIFY_THRESHOLD - <span class="number">1</span>)</span><br><span class="line">                            <span class="title function_">treeifyBin</span>(tab, hash);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"><span class="comment">//e：  0x0044  ddd  444</span></span><br><span class="line"><span class="comment">//要添加的元素： 0x0055   ddd   555</span></span><br><span class="line"><span class="comment">//如果哈希值一样，就会调用equals方法比较内部的属性值是否相同</span></span><br><span class="line">                    <span class="keyword">if</span> (e.<span class="property">hash</span> == hash &amp;&amp; ((k = e.<span class="property">key</span>) == <span class="built_in">key</span> || (<span class="built_in">key</span> != <span class="literal">null</span> &amp;&amp; <span class="built_in">key</span>.<span class="property">equals</span>(k))))&#123;</span><br><span class="line"> <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">                    p = e;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果e为null，表示当前不需要覆盖任何元素</span></span><br><span class="line">       <span class="comment">//如果e不为null，表示当前的键是一样的，值会被覆盖</span></span><br><span class="line">      <span class="comment">//e:0x0044  ddd  555</span></span><br><span class="line">     <span class="comment">//要添加的元素： 0x0055   ddd   555</span></span><br><span class="line">            <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">                V oldValue = e.<span class="property">value</span>;</span><br><span class="line">                <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="literal">null</span>)&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//等号的右边：当前要添加的值</span></span><br><span class="line">  <span class="comment">//等号的左边：0x0044的值</span></span><br><span class="line">e.<span class="property">value</span> = value;</span><br><span class="line">&#125;</span><br><span class="line">                <span class="title function_">afterNodeAccess</span>(e);</span><br><span class="line">                <span class="keyword">return</span> oldValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//threshold：记录的就是数组的长度 * 0.75，哈希表的扩容时机  16 * 0.75 = 12</span></span><br><span class="line">        <span class="keyword">if</span> (++<span class="built_in">size</span> &amp;gt; threshold)&#123;</span><br><span class="line"> <span class="title function_">resize</span>();</span><br><span class="line">&#125;</span><br><span class="line">        </span><br><span class="line"><span class="comment">//表示当前没有覆盖任何元素，返回null</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>put方法</p><ul><li>1、首先看table数组，不存在(null或len=0)则初始化(扩容)。存在继续</li><li>2、看索引处，不存在则新增。存在继续</li><li>3、判断索引处的值，相等则记录。不等继续</li><li>4、判断是红黑树的话，走红黑树</li><li>5、判断是链表的话，走链表</li><li>6、判断超阈值，则扩容</li></ul><h2 id="1-数组位置为-null">1. <strong>数组位置为 <code>null</code></strong></h2><ul><li>当我们往 <code>HashMap</code> 中插入一个新的键值对时，首先会计算出键的哈希值，通过 <code>hash()</code> 方法来进行计算。</li><li>然后，<code>putVal()</code> 方法会根据计算得到的哈希值计算出该键值对应该插入数组的位置（用 <code>tab[i]</code> 表示）。如果该位置是 <code>null</code>，说明该位置没有任何元素，那么新的键值对就直接插入到该位置。</li><li><strong>举例</strong>：<br>当调用 <code>put(&quot;aaa&quot;, 111)</code> 时，<code>&quot;aaa&quot;</code> 的哈希值（假设为 <code>0x0011</code>）会计算出来，然后通过 <code>tab[0x0011]</code> 来判断当前位置。如果该位置是 <code>null</code>，就会创建一个新的节点，将 <code>key=&quot;aaa&quot;</code>，<code>value=111</code> 插入到这个位置。</li></ul><h2 id="2-数组位置不为-null，键不重复，挂在下面形成链表或红黑树">2. <strong>数组位置不为 <code>null</code>，键不重复，挂在下面形成链表或红黑树</strong></h2><ul><li>如果数组中某个位置已经有值，即 <code>tab[i]</code> 不为 <code>null</code>，这时会检查该位置的键是否与当前要插入的键相同。如果键不相同，则会将新的键值对挂在该位置的后面，形成一个链表或红黑树。</li><li>链表会在该位置后面依次插入新的节点，而红黑树会在链表长度超过阈值时转换为红黑树结构来提高查找效率。</li><li><strong>举例</strong>：<br>当调用 <code>put(&quot;bbb&quot;, 222)</code> 时，假设 <code>tab[0x0022]</code> 位置已经被 <code>0x0011 aaa 111</code> 占用，<code>&quot;bbb&quot;</code> 的哈希值不同，因此会继续寻找下一个位置，或者在该位置后面形成一个链表，依次挂载 <code>bbb</code> 的键值对。</li></ul><h2 id="3-数组位置不为-null，键重复，元素覆盖">3. <strong>数组位置不为 <code>null</code>，键重复，元素覆盖</strong></h2><ul><li>如果数组中该位置的键值对已经存在，而且该位置的键和当前插入的键相同，<code>HashMap</code> 会直接覆盖原来的值，替换成新的值。</li><li>这时会判断当前数组中该位置的键是否和要插入的键相同。如果相同，则会直接用新的值覆盖原来的值，而不再插入新的节点。</li><li><strong>举例</strong>：<br>当调用 <code>put(&quot;ccc&quot;, 333)</code> 时，假设 <code>tab[0x0033]</code> 位置已经被 <code>0x0033 ccc 333</code> 占用，<code>&quot;ccc&quot;</code> 的哈希值相同，且键相同，因此直接用新的值 <code>333</code> 覆盖旧的值。此时 <code>tab[0x0033]</code> 仍然是 <code>ccc</code>，但是值会变为新的 <code>333</code>。</li></ul><hr><h2 id="总结">总结</h2><p>在 <code>HashMap</code> 的 <code>put</code> 方法中，插入数据时会经历以下几个步骤：</p><ol><li><p><strong>计算哈希值</strong>：使用 <code>hash()</code> 方法计算键的哈希值。</p></li><li><p><strong>检查数组位置</strong>：根据哈希值计算数组的索引 <code>i</code>，检查 <code>tab[i]</code> 位置。</p></li><li><p>插入操作</p><p>：</p><ul><li>如果该位置为空（<code>null</code>），直接插入新的节点。</li><li>如果该位置已有节点，并且键不同，则在链表或红黑树中继续查找插入。</li><li>如果键相同，则替换旧的值。</li></ul></li></ol><p>这种方式保证了 <code>HashMap</code> 的查找效率，同时通过链表和红黑树的机制有效地解决了哈希冲突的问题。</p><p>更多详解参考</p><p><a href="https://blog.csdn.net/mingyuli/article/details/120385136?ops_request_misc=elastic_search_misc&amp;request_id=a7b01b280e4f4bc5544e902aff7c2e15&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-2-120385136-null-null.142%5Ev102%5Epc_search_result_base9&amp;utm_term=hashmap%E6%BA%90%E7%A0%81&amp;spm=1018.2226.3001.4187">Java集合(五): HashMap源码剖析-CSDN博客</a></p>]]></content>
    
    
    <summary type="html">HashMap源码的put详解</summary>
    
    
    
    <category term="学习笔记" scheme="https://itgeqian.github.io/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="HashMap" scheme="https://itgeqian.github.io/tags/HashMap/"/>
    
  </entry>
  
  <entry>
    <title>项目中的VO和DTO</title>
    <link href="https://itgeqian.github.io/posts/55.html"/>
    <id>https://itgeqian.github.io/posts/55.html</id>
    <published>2025-09-12T03:19:03.000Z</published>
    <updated>2025-09-12T06:03:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="概念先行">概念先行</h2><ul><li><strong>DTO（Data Transfer Object）是什么</strong></li><li>面向“数据传输”的中立模型，用来在系统间/层间传递数据（Controller⇄Service、服务A⇄服务B、RPC/消息等）。</li><li>强调输入/输出契约与序列化稳定性，通常不包含展示格式、也不带业务逻辑。</li><li>典型拆分：命令/变更类（Create/Update DTO）、查询类（Query DTO）、对外返回类（Response DTO）。</li><li><strong>VO（View Object）是什么</strong></li><li>面向“展示/视图”的模型，专门为前端页面/客户端界面定制。</li><li>字段可以是组合/计算后的展示字段（如时间字符串、状态文案、头像全路径、是否关注等），为“好看好用”而服务。</li><li>只负责展示，不建议作为内部领域/持久化的输入。</li></ul><h2 id="什么时候用-DTO，什么时候用-VO">什么时候用 DTO，什么时候用 VO</h2><ul><li>入参（从客户端到后端）优先用 <strong>DTO</strong></li><li>如创建/修改/查询条件：<code>UserCreateDTO</code>、<code>UserUpdateDTO</code>、<code>UserQueryDTO</code></li><li>可携带校验注解（非空、格式、范围），清晰表述“接收什么数据”</li><li>出参（从后端到客户端）优先用 <strong>VO</strong></li><li>如详情/列表项/分页结果：<code>UserDetailVO</code>、<code>UserListItemVO</code>、<code>UserProfileVO</code></li><li>可包含展示友好字段（格式化时间、枚举文案、组合字段）</li></ul><p>简言之：输入→DTO，输出→VO。DTO更“中立契约”，VO更“贴近 UI”。</p><h2 id="在你的项目里如何落地">在你的项目里如何落地</h2><ul><li>现在已有：</li><li><code>UserInfo</code> 是 PO（持久层实体，不建议直接暴露给前端）</li><li><code>UserInfoQuery</code> 是查询模型（本质更像 Query DTO）</li><li><code>ResponseVO</code>、<code>PaginationResultVO</code> 是“响应包装/分页结果 VO”</li><li>建议补齐：</li><li>新增入参 DTO：<code>UserInfoAddDTO</code>、<code>UserInfoUpdateDTO</code>、<code>UserInfoQueryDTO</code>（或沿用 <code>UserInfoQuery</code>）</li><li>新增出参 VO：<code>UserInfoDetailVO</code>、<code>UserInfoListItemVO</code></li><li>映射关系：<ul><li>Controller 接 DTO → Service → 转 PO 落库</li><li>Service 查到 PO → 转 VO 返回前端</li></ul></li><li>转换工具：用 <code>MapStruct</code>（推荐，编译期生成）或现有 <code>CopyTools</code></li></ul><h2 id="命名与分层建议">命名与分层建议</h2><ul><li>命名</li><li>入参：<code>XxxCreateDTO</code>、<code>XxxUpdateDTO</code>、<code>XxxQueryDTO</code></li><li>出参：<code>XxxDetailVO</code>、<code>XxxListItemVO</code></li><li>包结构：<code>controller/dto</code>、<code>controller/vo</code> 或 <code>interfaces/dto</code>、<code>interfaces/vo</code></li><li>分层</li><li>Controller：仅收发 DTO/VO，不碰 PO</li><li>Service：面向 PO、领域对象，边界使用 DTO/VO</li><li>Mapper：只认 PO 与查询条件模型</li></ul><h2 id="常见误区">常见误区</h2><ul><li>用 PO 直接当入参/出参（易暴露内部字段，如 <code>password</code>；耦合数据库变更）</li><li>用 VO 做入参（VO关注展示，往往包含只读字段，作为入参易混乱）</li><li>让 VO/DTO 混用或下沉到 Mapper 层（破坏分层职责）</li><li>出参未做格式化（让前端处理后端细节，如时间格式/枚举文案）</li></ul><h2 id="一个小决策清单（不纠结版）">一个小决策清单（不纠结版）</h2><ul><li>这是“请求体/查询条件/命令”吗？→ 用 <strong>DTO</strong></li><li>这是“返回给页面/APP的展示数据”吗？→ 用 <strong>VO</strong></li><li>需格式化/组合字段、转文案吗？→ <strong>VO</strong></li><li>需做字段合法性校验（后端接收时）吗？→ <strong>DTO</strong></li></ul><h1 id="GQ-Video中的VO、DTO、Query">GQ Video中的VO、DTO、Query</h1><h2 id="简明区分与用法">简明区分与用法</h2><ul><li><p>VO（View Object）</p></li><li><p>定义：面向“返回给前端视图”的对象。</p></li><li><p>用法：Controller 返回时用 VO 封装结果，屏蔽内部实现与表结构。</p></li><li><p>在本项目中：</p><ul><li>统一响应外壳：<code>com.easylive.entity.vo.ResponseVO</code></li><li>分页结果：<code>com.easylive.entity.vo.PaginationResultVO</code></li><li>部分业务返回也会自定义 VO（例如组合多个来源的展示数据）。</li></ul></li><li><p>DTO（Data Transfer Object）</p></li><li><p>定义：服务/层间传输的数据对象，承载业务语义，避免直接暴露数据库实体。</p></li><li><p>用法：Service 层之间、缓存、搜索引擎、消息传递等使用；也可作为接口响应体（当含业务含义时）。</p></li><li><p>在本项目中（位置：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com<span class="selector-class">.easylive</span><span class="selector-class">.entity</span>.dto</span><br></pre></td></tr></table></figure><p>）：</p><ul><li><code>TokenUserInfoDto</code>：登录后放入 Redis/Cookie 的用户会话数据</li><li><code>UserCountInfoDto</code>：用户粉丝数、消息数等聚合结果</li><li><code>VideoInfoEsDto</code>、<code>VideoPlayInfoDto</code> 等：用于搜索/播放等跨层传输的结构</li></ul></li><li><p>Query（查询参数对象）</p></li><li><p>定义：封装“列表/分页/条件查询”的输入参数。</p></li><li><p>用法：Controller 组装 Query → 传 Service/Mapper 执行分页、排序、筛选；Query 通常继承/组合分页基础类。</p></li><li><p>在本项目中（位置：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com<span class="selector-class">.easylive</span><span class="selector-class">.entity</span>.query</span><br></pre></td></tr></table></figure><p>）：</p><ul><li><code>BaseParam</code>、<code>SimplePage</code>：分页与通用查询基类</li><li><code>VideoInfoPostQuery</code>、<code>UserInfoQuery</code> 等：带 <code>orderBy</code>、<code>pageNo/pageSize</code>、筛选字段</li></ul></li></ul><h2 id="项目中的典型调用链">项目中的典型调用链</h2><ul><li>Controller 入参（原生参数/表单） → 组装 Query 或直接传简单参数</li><li>Service 处理：</li><li>读写 DB：可能将 DO 转成 DTO 返回</li><li>组装统计结果：返回 DTO/VO</li><li>Controller 出参：最终用 <code>ResponseVO</code> 包装，返回给前端</li></ul><h2 id="关键代码示例（均来自当前代码库）">关键代码示例（均来自当前代码库）</h2><ul><li>Controller 返回 VO（统一响应）</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 所有接口返回统一的 ResponseVO 结构</span></span><br><span class="line"><span class="meta">@RequestMapping(<span class="string">&quot;/checkCode&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> ResponseVO&lt;?&gt; checkCode() &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> getSuccessResponseVO(result); <span class="comment">// 外层是 ResponseVO</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>使用 DTO 作为业务数据载体（登录态/统计）</li></ul><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import com.easylive.entity.dto.TokenUserInfoD<span class="keyword">to</span>;</span><br><span class="line">import com.easylive.entity.dto.UserCountInfoD<span class="keyword">to</span>;</span><br><span class="line">public ResponseVO<span class="variable">&lt;?&gt;</span> autoLogin(HttpServletResponse response) &#123;</span><br><span class="line">  TokenUserInfoD<span class="keyword">to</span> tokenUserInfoD<span class="keyword">to</span> = getTokenUserInfoD<span class="keyword">to</span>();</span><br><span class="line">  ...</span><br><span class="line">  return getSuccessResponseVO(tokenUserInfoD<span class="keyword">to</span>); // 返回 DTO</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>使用 Query 进行分页/筛选查询</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/loadVideoList&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="title class_">ResponseVO</span>&lt;?&gt; <span class="title function_">loadVideoList</span>(<span class="params"><span class="title class_">Integer</span> status, <span class="title class_">Integer</span> pageNo, <span class="title class_">String</span> videoNameFuzzy</span>) &#123;</span><br><span class="line">  <span class="title class_">VideoInfoPostQuery</span> videoInfoQuery = <span class="keyword">new</span> <span class="title class_">VideoInfoPostQuery</span>();</span><br><span class="line">  videoInfoQuery.<span class="title function_">setPageNo</span>(pageNo == <span class="literal">null</span> ? <span class="number">1</span> : pageNo);</span><br><span class="line">  videoInfoQuery.<span class="title function_">setPageSize</span>(<span class="number">10</span>);</span><br><span class="line">  videoInfoQuery.<span class="title function_">setStatus</span>(status);</span><br><span class="line">  videoInfoQuery.<span class="title function_">setVideoNameFuzzy</span>(videoNameFuzzy);</span><br><span class="line">  videoInfoQuery.<span class="title function_">setOrderBy</span>(<span class="string">&quot;create_time desc&quot;</span>);</span><br><span class="line">  videoInfoQuery.<span class="title function_">setQueryCountInfo</span>(<span class="literal">true</span>);</span><br><span class="line">  <span class="title class_">PaginationResultVO</span>&lt;?&gt; resultVO = videoInfoPostService.<span class="title function_">findListByPage</span>(videoInfoQuery);</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">getSuccessResponseVO</span>(resultVO); <span class="comment">// 外层 VO 包装分页 VO</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="设计原则与最佳实践">设计原则与最佳实践</h2><ul><li>VO</li><li>只面向“输出”。避免把 DO（数据库实体）直接返回前端。</li><li>统一外层结构（本项目用 <code>ResponseVO</code>），便于前端处理统一的 code/msg/data。</li><li>DTO</li><li>描述业务意义的数据载体。可跨层使用（Service ↔ 缓存/搜索/消息），避免 Controller 直接拼装复杂结构。</li><li>可承载多个来源的聚合信息，减少 Controller 逻辑。</li><li>Query</li><li>只用于“输入的查询条件”，不承载业务结果。</li><li>与分页基类解耦（<code>SimplePage</code> + <code>BaseParam</code>），避免每个 Query 重复分页字段。</li><li>命名上建议遵循 <code>[业务对象]Query</code>，字段尽量贴近筛选条件名称（如 <code>xxxFuzzy</code>、<code>statusList</code>、<code>orderBy</code>）。</li></ul><h2 id="快速判断口诀">快速判断口诀</h2><ul><li>我这是“返回给前端”的结构吗？是 → VO（外层统一用 <code>ResponseVO</code>）</li><li>我是在层与层之间传递业务数据？是 → DTO</li><li>我是“分页/筛选/排序”的输入条件？是 → Query</li></ul><h2 id="模版示例">模版示例</h2><p>下面给你一套可直接套用的模板示例（Query/DTO/VO/Controller/Service），你复制到对应包里改类名和字段即可。</p><h3 id="1-Query-模板（用于分页筛选）">1) Query 模板（用于分页筛选）</h3><p>建议放在 <code>com.easylive.entity.query</code> 下，命名 <code>FooQuery.java</code>。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">query</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FooQuery</span> <span class="keyword">extends</span> <span class="title class_ inherited__">BaseParam</span> &#123;</span><br><span class="line">    <span class="comment">// 精确匹配字段</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> fooId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 模糊查询字段</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> fooNameFuzzy;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 其他筛选条件</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> status;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 排序：例如 &quot;create_time desc&quot;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> orderBy;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getFooId</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> fooId; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setFooId</span>(<span class="params"><span class="title class_">String</span> fooId</span>) &#123; <span class="variable language_">this</span>.<span class="property">fooId</span> = fooId; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getFooNameFuzzy</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> fooNameFuzzy; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setFooNameFuzzy</span>(<span class="params"><span class="title class_">String</span> fooNameFuzzy</span>) &#123; <span class="variable language_">this</span>.<span class="property">fooNameFuzzy</span> = fooNameFuzzy; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getStatus</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> status; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setStatus</span>(<span class="params"><span class="title class_">Integer</span> status</span>) &#123; <span class="variable language_">this</span>.<span class="property">status</span> = status; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getOrderBy</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> orderBy; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setOrderBy</span>(<span class="params"><span class="title class_">String</span> orderBy</span>) &#123; <span class="variable language_">this</span>.<span class="property">orderBy</span> = orderBy; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用法要点：</p><ul><li>分页字段继承自 <code>BaseParam</code>（已有 <code>pageNo/pageSize/queryCountInfo</code> 等）。</li><li>模糊查询后缀建议用 <code>Fuzzy</code>。</li><li>排序字段统一用 <code>orderBy</code>。</li></ul><h3 id="2-DTO-模板（跨层传输-业务语义）">2) DTO 模板（跨层传输/业务语义）</h3><p>建议放在 <code>com.easylive.entity.dto</code> 下，命名 <code>FooDto.java</code>。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">dto</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">Serializable</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">List</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 承载业务语义的数据结构，用于 Service/缓存/消息/搜索之间传输。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FooDto</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> fooId;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> fooName;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> status;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Long</span> createTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 业务聚合：例如统计信息、扩展字段</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> relatedCount;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">List</span>&lt;<span class="title class_">String</span>&gt; tags;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getFooId</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> fooId; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setFooId</span>(<span class="params"><span class="title class_">String</span> fooId</span>) &#123; <span class="variable language_">this</span>.<span class="property">fooId</span> = fooId; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getFooName</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> fooName; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setFooName</span>(<span class="params"><span class="title class_">String</span> fooName</span>) &#123; <span class="variable language_">this</span>.<span class="property">fooName</span> = fooName; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getStatus</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> status; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setStatus</span>(<span class="params"><span class="title class_">Integer</span> status</span>) &#123; <span class="variable language_">this</span>.<span class="property">status</span> = status; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Long</span> <span class="title function_">getCreateTime</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> createTime; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setCreateTime</span>(<span class="params"><span class="title class_">Long</span> createTime</span>) &#123; <span class="variable language_">this</span>.<span class="property">createTime</span> = createTime; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Integer</span> <span class="title function_">getRelatedCount</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> relatedCount; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setRelatedCount</span>(<span class="params"><span class="title class_">Integer</span> relatedCount</span>) &#123; <span class="variable language_">this</span>.<span class="property">relatedCount</span> = relatedCount; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">List</span>&lt;<span class="title class_">String</span>&gt; <span class="title function_">getTags</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> tags; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setTags</span>(<span class="params"><span class="title class_">List</span>&lt;<span class="title class_">String</span>&gt; tags</span>) &#123; <span class="variable language_">this</span>.<span class="property">tags</span> = tags; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用法要点：</p><ul><li>不直接暴露数据库实体（DO/PO），DTO 聚合业务需要返回的数据即可。</li><li>可以包含多个来源数据的组合（统计/扩展）。</li></ul><h3 id="3-VO-模板（面向前端返回）">3) VO 模板（面向前端返回）</h3><p>建议放在 <code>com.easylive.entity.vo</code> 下，命名 <code>FooVO.java</code>（可选）。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">easylive</span>.<span class="property">entity</span>.<span class="property">vo</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">Serializable</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 面向前端的展示对象。必要时和 DTO 区分，保证展示字段与命名更友好。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FooVO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> id;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> name;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> statusText; <span class="comment">// 例如把状态码转换为中文</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getId</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> id; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setId</span>(<span class="params"><span class="title class_">String</span> id</span>) &#123; <span class="variable language_">this</span>.<span class="property">id</span> = id; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getName</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> name; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setName</span>(<span class="params"><span class="title class_">String</span> name</span>) &#123; <span class="variable language_">this</span>.<span class="property">name</span> = name; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">String</span> <span class="title function_">getStatusText</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> statusText; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setStatusText</span>(<span class="params"><span class="title class_">String</span> statusText</span>) &#123; <span class="variable language_">this</span>.<span class="property">statusText</span> = statusText; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用法要点：</p><ul><li>如果直接返回 DTO 也能满足需求，可不额外建 VO。</li><li>需要展示友好/脱敏/字段名重命名时，用 VO。</li></ul><h3 id="4-Service-模板（Query-入参，返回-DTO-分页）">4) Service 模板（Query 入参，返回 DTO/分页）</h3><p>接口（<code>com.easylive.service.FooService</code>）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.dto.FooDto;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.query.FooQuery;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.vo.PaginationResultVO;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FooService</span> &#123;</span><br><span class="line">    PaginationResultVO&lt;FooDto&gt; <span class="title function_">findListByPage</span><span class="params">(FooQuery query)</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;FooDto&gt; <span class="title function_">findListByParam</span><span class="params">(FooQuery query)</span>;</span><br><span class="line"></span><br><span class="line">    FooDto <span class="title function_">getById</span><span class="params">(String fooId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实现（<code>com.easylive.service.impl.FooServiceImpl</code>）里：</p><ul><li>使用 <code>FooQuery</code> 传分页/筛选条件；</li><li>读取数据库实体后转为 <code>FooDto</code>；</li><li>分页返回 <code>PaginationResultVO&lt;FooDto&gt;</code>。</li></ul><h3 id="5-Controller-模板（入参→Query，出参→ResponseVO）">5) Controller 模板（入参→Query，出参→ResponseVO）</h3><p>放在 <code>com.easylive.controller</code> 下，命名 <code>FooController.java</code>。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.easylive.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.easylive.<span class="keyword">annotation</span>.GlobalInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.dto.FooDto;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.query.FooQuery;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.vo.PaginationResultVO;</span><br><span class="line"><span class="keyword">import</span> com.easylive.entity.vo.ResponseVO;</span><br><span class="line"><span class="keyword">import</span> com.easylive.service.FooService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.<span class="keyword">annotation</span>.RestController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.<span class="keyword">annotation</span>.Resource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController(<span class="string">&quot;fooController&quot;</span>)</span></span><br><span class="line"><span class="meta">@RequestMapping(<span class="string">&quot;/foo&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FooController</span> <span class="title">extends</span> <span class="title">ABaseController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> FooService fooService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(<span class="string">&quot;/list&quot;</span>)</span></span><br><span class="line">    <span class="meta">@GlobalInterceptor</span></span><br><span class="line">    <span class="keyword">public</span> ResponseVO&lt;?&gt; list(Integer pageNo, Integer pageSize, String fooNameFuzzy, Integer status) &#123;</span><br><span class="line">        FooQuery query = new FooQuery();</span><br><span class="line">        query.setPageNo(pageNo == <span class="literal">null</span> ? <span class="number">1</span> : pageNo);</span><br><span class="line">        query.setPageSize(pageSize == <span class="literal">null</span> ? <span class="number">10</span> : pageSize);</span><br><span class="line">        query.setFooNameFuzzy(fooNameFuzzy);</span><br><span class="line">        query.setStatus(status);</span><br><span class="line">        query.setOrderBy(<span class="string">&quot;create_time desc&quot;</span>);</span><br><span class="line">        query.setQueryCountInfo(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        PaginationResultVO&lt;FooDto&gt; page = fooService.findListByPage(query);</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(page);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(<span class="string">&quot;/detail&quot;</span>)</span></span><br><span class="line">    <span class="meta">@GlobalInterceptor</span></span><br><span class="line">    <span class="keyword">public</span> ResponseVO&lt;?&gt; detail(String fooId) &#123;</span><br><span class="line">        FooDto dto = fooService.getById(fooId);</span><br><span class="line">        <span class="keyword">return</span> getSuccessResponseVO(dto);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>说明：</p><ul><li>入参转为 <code>FooQuery</code>，避免在 Controller 里写分页/筛选细节。</li><li>出参统一用 <code>ResponseVO</code> 包装；数据体是 <code>DTO</code> 或 <code>PaginationResultVO&lt;DTO&gt;</code>。</li><li>如需对前端展示再加工，新增 <code>FooVO</code> 并在 Controller 中把 <code>DTO → VO</code>。</li></ul><h3 id="6-快速落地步骤">6) 快速落地步骤</h3><ol><li>新建 <code>FooQuery</code>、<code>FooDto</code>、（可选）<code>FooVO</code>。</li><li>Service：定义 <code>findListByPage/findListByParam/getById</code>，实现里把 DO 转 DTO。</li><li>Controller：接 Query 入参、调用 Service、返回 <code>ResponseVO</code>。</li><li>前端：接收 <code>ResponseVO</code> 的 <code>data</code> 字段即可。</li></ol>]]></content>
    
    
    <summary type="html">GQ Video项目中的VO和DTO设计思路</summary>
    
    
    
    <category term="项目" scheme="https://itgeqian.github.io/categories/%E9%A1%B9%E7%9B%AE/"/>
    
    
    <category term="项目相关" scheme="https://itgeqian.github.io/tags/%E9%A1%B9%E7%9B%AE%E7%9B%B8%E5%85%B3/"/>
    
  </entry>
  
  <entry>
    <title>代码生成器详解</title>
    <link href="https://itgeqian.github.io/posts/54.html"/>
    <id>https://itgeqian.github.io/posts/54.html</id>
    <published>2025-09-10T03:19:03.000Z</published>
    <updated>2025-09-10T23:03:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>我在数据库easylive加入了一张表</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_info` (</span><br><span class="line">  `user_id` <span class="type">varchar</span>(<span class="number">12</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;用户ID&#x27;</span>,</span><br><span class="line">  `email` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;邮箱&#x27;</span>,</span><br><span class="line">  `nick_name` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;昵称&#x27;</span>,</span><br><span class="line">  `avatar` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;用户头像&#x27;</span>,</span><br><span class="line">  `<span class="keyword">password</span>` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;密码&#x27;</span>,</span><br><span class="line">  `status` tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;状态&#x27;</span>,</span><br><span class="line">  `create_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  `last_login_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;最后登录时间&#x27;</span>,</span><br><span class="line">  `integral` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="string">&#x27;0&#x27;</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;积分&#x27;</span>,</span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (`user_id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `idx_key_email` (`email`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE=InnoDB <span class="keyword">DEFAULT</span> CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC <span class="keyword">COMMENT</span>=<span class="string">&#x27;用户信息&#x27;</span>;</span><br></pre></td></tr></table></figure><p>生成后的代码就是easylive中的代码</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-141-592x1024.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-142.png" alt="img"></p><p>接下来我将逐一讲解easyjava代码生成器生成的那些代码</p><h2 id="1-PO实体类-UserInfo">1. PO实体类-<code>UserInfo</code></h2><h3 id="UserInfo-实体类（PO）是什么">UserInfo 实体类（PO）是什么</h3><ul><li><strong>定位</strong>：<code>PO（Persistence Object）</code>，用于和数据库表 <code>user_info</code> 一一映射，承载单行数据。</li><li><strong>作用场景</strong>：Mapper 层返回、Service/Controller 在入参与出参中传递、序列化到 JSON 返回给前端。</li></ul><h3 id="字段与表结构的对应关系与意义">字段与表结构的对应关系与意义</h3><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_"><span class="keyword">class</span> <span class="title">UserInfo</span> <span class="keyword"><span class="keyword">implements</span> <span class="type">Serializable</span></span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户ID</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">String</span> userId;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 邮箱</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">String</span> email;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 昵称</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">String</span> nickName;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户头像</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">String</span> avatar;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 密码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">String</span> password;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Integer status;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 积分</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Integer integral;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建时间</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@JsonFormat</span>(pattern = <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>, timezone = <span class="string">&quot;GMT+8&quot;</span>)</span><br><span class="line"><span class="meta">@DateTimeFormat</span>(pattern = <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)</span><br><span class="line"><span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 最后登录时间</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@JsonFormat</span>(pattern = <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>, timezone = <span class="string">&quot;GMT+8&quot;</span>)</span><br><span class="line"><span class="meta">@DateTimeFormat</span>(pattern = <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)</span><br><span class="line"><span class="keyword">private</span> Date lastLoginTime;</span><br></pre></td></tr></table></figure><ul><li><strong>userId（varchar(12) 主键）</strong>：业务主键，字符串存储更灵活（可自定义/跨库唯一）。</li><li><strong>email（varchar(50)，唯一索引）</strong>：登录/联系账号，DB 层唯一约束（在 XML/数据库侧体现，实体不直接承载约束注解）。</li><li><strong>nickName（varchar(20)）</strong>：昵称。</li><li><strong>avatar（varchar(50)）</strong>：头像 URL/路径。</li><li><strong>password（varchar(32)）</strong>：密码摘要（应为加密后的摘要值，非明文）。</li><li><strong>status（tinyint(1)）</strong>：状态位（如 0/1），用 <code>Integer</code> 以便表示空值。</li><li><strong>createTime、lastLoginTime（datetime）</strong>：创建/最后登录时间。</li><li><strong>integral（int(11) 默认0）</strong>：积分，业务计数。</li></ul><h3 id="时间字段的序列化与绑定">时间字段的序列化与绑定</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@JsonFormat</span>(pattern = <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>, timezone = <span class="string">&quot;GMT+8&quot;</span>)</span><br><span class="line"><span class="variable">@DateTimeFormat</span>(pattern = <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)</span><br><span class="line">private Date createTime;</span><br></pre></td></tr></table></figure><ul><li><strong>@JsonFormat</strong>：控制 JSON 输出格式与时区（出参序列化）。</li><li><strong>@DateTimeFormat</strong>：控制接口入参（表单/查询参数）向 <code>Date</code> 的解析（入参绑定）。</li><li>模式固定使用 <code>yyyy-MM-dd HH:mm:ss</code>，与前端/DB 时间展示保持一致。</li></ul><h3 id="Getter-Setter-与可空性">Getter/Setter 与可空性</h3><ul><li>生成了完整 Getter/Setter，便于 MyBatis 反射映射与 Spring 绑定。</li><li>字段多为可空（与 DDL 默认 NULL 对齐），业务层应做非空与范围校验。</li></ul><h3 id="可序列化与跨层传输">可序列化与跨层传输</h3><ul><li><code>implements Serializable</code>：便于放入 Session/缓存、消息队列传输或远程调用返回。</li></ul><h3 id="toString-用于调试与日志">toString 用于调试与日志</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="built_in">public</span> String toString ()&#123;</span><br><span class="line">    <span class="keyword">return</span> &quot;用户ID:&quot;+(userId == <span class="keyword">null</span> ? &quot;空&quot; : userId)+&quot;，邮箱:&quot;+(email == <span class="keyword">null</span> ? &quot;空&quot; : email)+&quot;，昵称:&quot;+(nickName == <span class="keyword">null</span> ? &quot;空&quot; : nickName)+&quot;，用户头像:&quot;+(avatar == <span class="keyword">null</span> ? &quot;空&quot; : avatar)+&quot;，密码:&quot;+(<span class="keyword">password</span> == <span class="keyword">null</span> ? &quot;空&quot; : <span class="keyword">password</span>)+&quot;，状态:&quot;+(status == <span class="keyword">null</span> ? &quot;空&quot; : status)+&quot;，创建时间:&quot;+(createTime == <span class="keyword">null</span> ? &quot;空&quot; : DateUtil.format(createTime, DateTimePatternEnum.YYYY_MM_DD_HH_MM_SS.getPattern()))+&quot;，最后登录时间:&quot;+(lastLoginTime == <span class="keyword">null</span> ? &quot;空&quot; : DateUtil.format(lastLoginTime, DateTimePatternEnum.YYYY_MM_DD_HH_MM_SS.getPattern()))+&quot;，积分:&quot;+(integral == <span class="keyword">null</span> ? &quot;空&quot; : integral);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>使用 <code>DateUtil.format</code> 与 <code>DateTimePatternEnum</code> 统一日期格式，避免 <code>null</code> 导致异常。</li><li>注意：这里直接输出了 <code>password</code>，生产日志中建议避免打印敏感字段。</li></ul><h3 id="与查询对象的分工">与查询对象的分工</h3><ul><li><code>UserInfo</code> 表示“一行数据”的实体。</li><li><code>UserInfoQuery</code> 表示“查询条件与分页”的模型（含模糊匹配、时间区间），两者职责分离，便于复用。</li></ul><h2 id="2-Query（查询对象）-UserInfoQuery-BaseParam-SimplePage">2.Query（查询对象）-UserInfoQuery/BaseParam/SimplePage</h2><h3 id="UserInfoQuery（查询对象）是什么">UserInfoQuery（查询对象）是什么</h3><ul><li><strong>定位</strong>：承载“查询条件与分页信息”的对象，服务于列表/检索接口。</li><li><strong>继承关系</strong>：继承 <code>BaseParam</code>，天然包含分页与排序能力。</li></ul><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户信息参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">UserInfoQuery</span> <span class="keyword">extends</span> <span class="title">BaseParam</span> </span>&#123;</span><br></pre></td></tr></table></figure><h3 id="字段设计与意义">字段设计与意义</h3><ul><li><strong>精确匹配字段</strong>：<code>userId</code>、<code>email</code>、<code>nickName</code>、<code>avatar</code>、<code>password</code>、<code>status</code>、<code>integral</code> 等，对应实体主字段；当这些字段非空时，通常在 XML 中以 <code>=</code> 精确匹配。</li><li><strong>模糊匹配字段</strong>：为每个字符串型字段提供 <code>xxxFuzzy</code>（如 <code>emailFuzzy</code>、<code>nickNameFuzzy</code>），用于 <code>LIKE '%xxx%'</code>。</li><li><strong>时间区间查询</strong>：</li><li><code>createTimeStart</code>、<code>createTimeEnd</code> 用于创建时间闭区间；</li><li><code>lastLoginTimeStart</code>、<code>lastLoginTimeEnd</code> 用于最后登录时间闭区间；</li><li>这些字段在 XML 中通常以 <code>&gt;=</code>、<code>&lt;=</code> 条件组合出现。</li></ul><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建时间</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> createTime;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> createTimeStart;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> createTimeEnd;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 最后登录时间</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> lastLoginTime;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> lastLoginTimeStart;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> lastLoginTimeEnd;</span><br></pre></td></tr></table></figure><ul><li><strong>为何用 String 承载时间</strong>：便于前端传参与多格式兼容，XML 内部再按固定格式解析或直接作为字符串条件拼接（以项目约定为准）。</li></ul><h3 id="BaseParam（分页与排序基类）">BaseParam（分页与排序基类）</h3><ul><li><strong>字段</strong>：</li><li><code>pageNo</code>：当前页码（1 开始）</li><li><code>pageSize</code>：每页大小</li><li><code>orderBy</code>：排序子句（如 <code>&quot;create_time desc&quot;</code>）</li><li><code>simplePage</code>：计算好偏移量的分页对象</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseParam</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">SimplePage</span> simplePage;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> pageNo;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> pageSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> orderBy;</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">SimplePage</span> <span class="title function_">getSimplePage</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> simplePage;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li><strong>使用建议</strong>：</li><li><code>orderBy</code> 应在服务层做白名单校验，避免 SQL 注入。</li><li>控制层把 <code>pageNo/pageSize/orderBy</code> 组装进 <code>BaseParam</code>，再交由服务/Mapper 使用。</li></ul><h3 id="SimplePage（分页核心计算）">SimplePage（分页核心计算）</h3><ul><li><strong>职责</strong>：依据总数 <code>countTotal</code>、页码 <code>pageNo</code>、每页大小 <code>pageSize</code>，计算 <code>start</code>（offset）、<code>end</code>（limit size）、<code>pageTotal</code>。</li><li><strong>默认与收敛</strong>：</li><li>当 <code>pageSize &lt;= 0</code> 时，默认使用 <code>PageSize.SIZE20</code>；</li><li>将 <code>pageNo</code> 收敛到 [1, pageTotal]；</li><li>计算公式：<code>start = (pageNo - 1) * pageSize</code>，<code>end = pageSize</code>。</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> void action() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.pageSize &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.pageSize = PageSize.SIZE20.getSize();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.countTotal &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.pageTotal = <span class="keyword">this</span>.countTotal % <span class="keyword">this</span>.pageSize == <span class="number">0</span> ? <span class="keyword">this</span>.countTotal / <span class="keyword">this</span>.pageSize</span><br><span class="line">                : <span class="keyword">this</span>.countTotal / <span class="keyword">this</span>.pageSize + <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pageTotal = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pageNo &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">        pageNo = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pageNo &gt; pageTotal) &#123;</span><br><span class="line">        pageNo = pageTotal;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.start = (pageNo - <span class="number">1</span>) * pageSize;</span><br><span class="line">    <span class="keyword">this</span>.end = <span class="keyword">this</span>.pageSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>典型用法</strong>：<ol><li>先查总数 <code>countTotal</code>；2) 用 <code>new SimplePage(pageNo, countTotal, pageSize)</code> 计算；3) 在列表查询中 <code>LIMIT start, end</code>。</li></ol></li><li><strong>示例</strong>：总数 105、<code>pageSize=20</code>、<code>pageNo=3</code> → <code>pageTotal=6</code>、<code>start=40</code>、<code>end=20</code>。</li></ul><h3 id="查询对象的一般使用流">查询对象的一般使用流</h3><ol><li>控制层接收 <code>UserInfoQuery</code>（包含页码、大小、排序与筛选条件）。</li><li>服务层补全或校验条件（如 <code>orderBy</code> 白名单、时间格式）。</li><li>Mapper XML 读取 <code>query</code> 中的非空字段，动态拼接 <code>WHERE</code> 与 <code>ORDER BY</code>，并使用 <code>simplePage.start/end</code> 分页。</li></ol><h2 id="3-UserInfoMapper-与-XML">3. UserInfoMapper 与 XML</h2><h3 id="UserInfoMapper（接口）与-UserInfoMapper-xml（SQL）是什么">UserInfoMapper（接口）与 UserInfoMapper.xml（SQL）是什么</h3><ul><li><strong>定位</strong>：<code>UserInfoMapper&lt;T,P&gt;</code> 继承通用 <code>BaseMapper&lt;T,P&gt;</code>，定义了按业务键的定制 CRUD；<code>UserInfoMapper.xml</code> 以 MyBatis 动态 SQL 实现这些方法。</li><li><strong>泛型</strong>：<code>T</code> 为实体（这里用 <code>UserInfo</code>），<code>P</code> 为查询对象（这里用 <code>UserInfoQuery</code>）。</li></ul><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户信息 数据库操作接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="symbol">UserInfoMapper</span>&lt;<span class="symbol">T</span>,<span class="symbol">P</span>&gt; <span class="symbol">extends</span> <span class="symbol">BaseMapper</span>&lt;<span class="symbol">T</span>,<span class="symbol">P</span>&gt; &#123;</span><br></pre></td></tr></table></figure><h3 id="字段映射与通用列">字段映射与通用列</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--实体映射--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;base_result_map&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.easylive.entity.po.UserInfo&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;user_id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;userId&quot;</span>  /&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 通用查询结果列--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;base_column_list&quot;</span>&gt;</span></span><br><span class="line">   u.user_id,u.email,u.nick_name,u.avatar,u.password,</span><br><span class="line">   u.status,u.create_time,u.last_login_time,u.integral</span><br><span class="line"><span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>将表字段与实体属性一一对应，用于 <code>select</code> 结果映射。</li></ul><h3 id="条件构造（精确、模糊、时间区间）">条件构造（精确、模糊、时间区间）</h3><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;base_condition_filed&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.userId != null and query.userId!=&#x27;&#x27;&quot;</span>&gt;</span> and u.user_id = #</span><span class="template-variable">&#123;query.userId&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  ...</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.createTime != null and query.createTime!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    &lt;![CDATA[ and  u.create_time=str_to_date(#</span><span class="template-variable">&#123;query.createTime&#125;</span><span class="language-xml">, &#x27;%Y-%m-%d&#x27;) ]]&gt;</span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;query_condition&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"> <span class="tag">&lt;<span class="name">where</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;base_condition_filed&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.emailFuzzy!= null  and query.emailFuzzy!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">     and u.email like concat(&#x27;%&#x27;, #</span><span class="template-variable">&#123;query.emailFuzzy&#125;</span><span class="language-xml">, &#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">   ...</span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.createTimeEnd!= null and query.createTimeEnd!=&#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">     &lt;![CDATA[ and  u.create_time&lt; date_sub(str_to_date(#</span><span class="template-variable">&#123;query.createTimeEnd&#125;</span><span class="language-xml">,&#x27;%Y-%m-%d&#x27;),interval -1 day) ]]&gt;</span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"> <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span></span><br></pre></td></tr></table></figure><ul><li>精确匹配：直接 <code>=</code>。</li><li>模糊匹配：<code>like concat('%', #&#123;...&#125;, '%')</code>。</li><li>时间点与区间：将字符串转日期比较；区间上界使用 <code>&lt; date_sub(..., interval -1 day)</code> 实现含当日的闭区间。</li></ul><h3 id="列表与计数（分页与排序）">列表与计数（分页与排序）</h3><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectList&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;base_result_map&quot;</span> &gt;</span></span></span><br><span class="line"><span class="language-xml">  SELECT <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;base_column_list&quot;</span> /&gt;</span> FROM user_info u <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;query_condition&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.orderBy!=null&quot;</span>&gt;</span> order by $</span><span class="template-variable">&#123;query.orderBy&#125;</span><span class="language-xml"> <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;query.simplePage!=null&quot;</span>&gt;</span> limit #</span><span class="template-variable">&#123;query.simplePage.start&#125;</span><span class="language-xml">,#</span><span class="template-variable">&#123;query.simplePage.end&#125;</span><span class="language-xml"> <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br></pre></td></tr></table></figure><ul><li><code>order by $&#123;query.orderBy&#125;</code> 使用占位符拼接，务必业务侧做白名单校验。</li><li>分页基于 <code>SimplePage.start/end</code>。</li></ul><h3 id="插入与插入或更新">插入与插入或更新</h3><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;insert id<span class="operator">=</span><span class="string">&quot;insert&quot;</span> parameterType<span class="operator">=</span><span class="string">&quot;com.easylive.entity.po.UserInfo&quot;</span>&gt;</span><br><span class="line">  INSERT INTO user_info</span><br><span class="line">  &lt;trim prefix<span class="operator">=</span><span class="string">&quot;(&quot;</span> suffix<span class="operator">=</span><span class="string">&quot;)&quot;</span> suffixOverrides<span class="operator">=</span><span class="string">&quot;,&quot;</span>&gt; ... &lt;/trim&gt;</span><br><span class="line">  &lt;trim prefix<span class="operator">=</span><span class="string">&quot;values (&quot;</span> suffix<span class="operator">=</span><span class="string">&quot;)&quot;</span> suffixOverrides<span class="operator">=</span><span class="string">&quot;,&quot;</span>&gt; ... &lt;/trim&gt;</span><br><span class="line">&lt;/insert&gt;</span><br></pre></td></tr></table></figure><ul><li>仅插入非空字段，减少默认值冲突。</li></ul><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">insert</span> id=<span class="string">&quot;insertOrUpdate&quot;</span> ...&gt;</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> user_info (...) <span class="keyword">values</span> (...)</span><br><span class="line">  <span class="keyword">on</span> DUPLICATE <span class="keyword">key</span> <span class="keyword">update</span> </span><br><span class="line">  &lt;<span class="built_in">trim</span> ...&gt; 仅对非空字段进行更新 &lt;/<span class="built_in">trim</span>&gt;</span><br><span class="line">&lt;/<span class="keyword">insert</span>&gt;</span><br></pre></td></tr></table></figure><ul><li>基于唯一键（如主键或唯一索引 <code>email</code>）实现 UPSERT，且只更新传入非空字段。</li></ul><h3 id="批量插入与批量-UPSERT">批量插入与批量 UPSERT</h3><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">insert</span> id=<span class="string">&quot;insertBatch&quot;</span>&gt; ... &lt;foreach <span class="keyword">collection</span>=<span class="string">&quot;list&quot;</span> item=<span class="string">&quot;item&quot;</span> separator=<span class="string">&quot;,&quot;</span>&gt; (...) &lt;/foreach&gt; &lt;/<span class="keyword">insert</span>&gt;</span><br><span class="line">&lt;<span class="keyword">insert</span> id=<span class="string">&quot;insertOrUpdateBatch&quot;</span>&gt; ... <span class="keyword">on</span> DUPLICATE <span class="keyword">key</span> <span class="keyword">update</span> ... &lt;/<span class="keyword">insert</span>&gt;</span><br></pre></td></tr></table></figure><ul><li>适用于导入或同步场景，UPSERT 会覆盖冲突行的字段值。</li></ul><h3 id="条件更新与删除">条件更新与删除</h3><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">update</span> id=<span class="string">&quot;updateByParam&quot;</span> parameterType=<span class="string">&quot;com.easylive.entity.query.UserInfoQuery&quot;</span>&gt;</span><br><span class="line">  <span class="keyword">UPDATE</span> user_info u</span><br><span class="line">  &lt;<span class="keyword">set</span>&gt; 仅对 bean 非空字段赋值 &lt;/<span class="keyword">set</span>&gt;</span><br><span class="line">  &lt;<span class="keyword">include</span> refid=<span class="string">&quot;query_condition&quot;</span> /&gt;</span><br><span class="line">&lt;/<span class="keyword">update</span>&gt;</span><br></pre></td></tr></table></figure><ul><li><code>bean</code> 是要赋值的新内容，<code>query</code> 是过滤条件。删除同理用 <code>&lt;delete&gt;</code>。</li></ul><h3 id="按业务键的定制方法">按业务键的定制方法</h3><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">update</span> id=<span class="string">&quot;updateByUserId&quot;</span>&gt; ... <span class="keyword">where</span> user_id=#&#123;userId&#125; &lt;/<span class="keyword">update</span>&gt;</span><br><span class="line">&lt;<span class="keyword">delete</span> id=<span class="string">&quot;deleteByUserId&quot;</span>&gt; <span class="keyword">delete</span> <span class="keyword">from</span> user_info <span class="keyword">where</span> user_id=#&#123;userId&#125; &lt;/<span class="keyword">delete</span>&gt;</span><br><span class="line">&lt;<span class="keyword">select</span> id=<span class="string">&quot;selectByUserId&quot;</span>&gt; <span class="keyword">select</span> ... <span class="keyword">where</span> user_id=#&#123;userId&#125; &lt;/<span class="keyword">select</span>&gt;</span><br><span class="line">&lt;<span class="keyword">update</span> id=<span class="string">&quot;updateByEmail&quot;</span>&gt; ... <span class="keyword">where</span> email=#&#123;email&#125; &lt;/<span class="keyword">update</span>&gt;</span><br><span class="line">&lt;<span class="keyword">delete</span> id=<span class="string">&quot;deleteByEmail&quot;</span>&gt; <span class="keyword">delete</span> <span class="keyword">from</span> user_info <span class="keyword">where</span> email=#&#123;email&#125; &lt;/<span class="keyword">delete</span>&gt;</span><br><span class="line">&lt;<span class="keyword">select</span> id=<span class="string">&quot;selectByEmail&quot;</span>&gt; <span class="keyword">select</span> ... <span class="keyword">where</span> email=#&#123;email&#125; &lt;/<span class="keyword">select</span>&gt;</span><br></pre></td></tr></table></figure><ul><li>与接口 <code>UserInfoMapper</code> 上的方法一一对应。</li></ul><p>本栏要点：接口声明与 XML 动态 SQL 对应一致；<code>query_condition</code> 统一管理条件；分页与排序通过 <code>BaseParam/SimplePage</code> 注入；提供按主键与唯一键的便捷 CRUD；批量与 UPSERT 支持高效导入与覆盖。</p><h2 id="4讲解基础-Mapper（BaseMapper、BaseMapperTableSplit）">4讲解基础 Mapper（BaseMapper、BaseMapperTableSplit）</h2><h3 id="BaseMapper-是什么（通用-Mapper-接口）">BaseMapper 是什么（通用 Mapper 接口）</h3><ul><li><strong>定位</strong>：为所有实体提供统一的 CRUD 接口定义，减少每张表重复代码。</li><li><strong>泛型</strong>：<code>T</code> 为实体类型（如 <code>UserInfo</code>），<code>P</code> 为查询对象（如 <code>UserInfoQuery</code>）。</li><li><strong>参数命名规范</strong>：通过 <code>@Param(&quot;bean&quot;)</code>、<code>@Param(&quot;query&quot;)</code> 约定 MyBatis XML 中的取值路径。</li></ul><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="symbol">BaseMapper</span>&lt;<span class="symbol">T</span>, <span class="symbol">P</span>&gt; &#123;</span><br><span class="line">   <span class="comment">/** selectList:(根据参数查询集合) */</span></span><br><span class="line">   List&lt;T&gt; selectList(@Param(<span class="string">&quot;query&quot;</span>) P p);</span><br></pre></td></tr></table></figure><ul><li><strong>核心方法说明</strong>：</li><li><code>selectList(P query)</code>：按条件返回列表，通常配合分页。</li><li><code>selectCount(P query)</code>：统计总数，用于分页总页数计算。</li><li><code>insert(T bean)</code>：插入（一般为“非空字段插入”动态 SQL）。</li><li><code>insertOrUpdate(T bean)</code>：存在则更新，不存在则插入（依赖唯一约束）。</li><li><code>insertBatch(List&lt;T&gt;)</code>：批量插入。</li><li><code>insertOrUpdateBatch(List&lt;T&gt;)</code>：批量 UPSERT。</li><li><code>updateByParam(T bean, P query)</code>：将符合条件的记录更新为 <code>bean</code> 非空字段值。</li><li><code>deleteByParam(P query)</code>：按条件删除。</li><li><strong>设计优点</strong>：统一方法命名与参数规范，所有具体表的 Mapper 都能直接复用；XML 可以共用一套动态 SQL 模版思想（或由代码生成器生成）。</li></ul><h3 id="BaseMapperTableSplit-是什么（分表场景的通用-Mapper）">BaseMapperTableSplit 是什么（分表场景的通用 Mapper）</h3><ul><li><strong>定位</strong>：与 <code>BaseMapper</code> 功能相同，但多了 <code>tableName</code> 作为显式入参，支持运行时动态指定物理表名（如 <code>user_info_2025</code>）。</li><li><strong>泛型</strong>：同 <code>BaseMapper</code>。</li><li><strong>参数命名规范</strong>：增加 <code>@Param(&quot;tableName&quot;) String tableName</code>。</li></ul><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_"><span class="keyword">interface</span> <span class="title">BaseMapperTableSplit</span>&lt;<span class="title">T</span>, <span class="title">P</span>&gt; </span>&#123;</span><br><span class="line">   <span class="comment">/** selectList:(根据参数查询集合) */</span></span><br><span class="line">   List&lt;T&gt; selectList(<span class="meta">@Param</span>(<span class="string">&quot;tableName&quot;</span>)<span class="keyword">String</span> tableName,<span class="meta">@Param</span>(<span class="string">&quot;query&quot;</span>) P p);</span><br></pre></td></tr></table></figure><ul><li><strong>核心方法说明</strong>：与 <code>BaseMapper</code> 一一对应，只是多了 <code>tableName</code>。</li><li>例如 <code>selectList(tableName, query)</code>、<code>insert(tableName, bean)</code>、<code>updateByParam(tableName, bean, query)</code> 等。</li><li><strong>XML 使用特征</strong>：</li><li>SQL 中表名位置写成 <code>$&#123;tableName&#125;</code>（字符串替换），因此必须在服务层严格校验 <code>tableName</code> 白名单，避免 SQL 注入。</li><li>其它参数可继续使用 <code>#&#123;&#125;</code> 安全占位符。</li></ul><h3 id="两者如何协同代码生成">两者如何协同代码生成</h3><ul><li>常规表：生成 <code>XXXMapper extends BaseMapper&lt;PO, Query&gt;</code> 与对应 XML。</li><li>分表表：生成 <code>XXXMapper extends BaseMapperTableSplit&lt;PO, Query&gt;</code> 与对应 XML，在运行期传入路由后的真实表名。</li><li>本栏要点：<code>BaseMapper</code> 抽象通用 CRUD；<code>BaseMapperTableSplit</code> 在此基础上引入 <code>tableName</code> 以支持分表路由；参数命名统一，便于 XML 取值与代码生成器批量套用。</li></ul><h2 id="5-Service层">5.Service层</h2><h3 id="UserInfoService（接口）是什么">UserInfoService（接口）是什么</h3><ul><li><strong>定位</strong>：定义面向业务的用户信息服务能力，对外屏蔽底层 Mapper 细节。</li><li><strong>方法分组</strong>：</li><li>查询：<code>findListByParam</code>、<code>findCountByParam</code>、<code>findListByPage</code></li><li>新增：<code>add</code>、<code>addBatch</code>、<code>addOrUpdateBatch</code></li><li>条件更新/删除：<code>updateByParam</code>、<code>deleteByParam</code></li><li>业务键便捷方法：<code>get/update/deleteByUserId</code> 与 <code>get/update/deleteByEmail</code></li></ul><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户信息 业务接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="symbol">UserInfoService</span> &#123;</span><br></pre></td></tr></table></figure><h3 id="UserInfoServiceImpl（实现）做了什么">UserInfoServiceImpl（实现）做了什么</h3><ul><li><strong>依赖注入</strong>：<code>@Resource UserInfoMapper&lt;UserInfo, UserInfoQuery&gt;</code>，调用底层通用 CRUD。</li><li><strong>分页编排</strong>：</li><li>先 <code>selectCount</code> 得到总数；</li><li>计算 <code>pageSize</code>（默认 <code>PageSize.SIZE15</code>）；</li><li>构建 <code>SimplePage</code> 写回到 <code>param</code>；</li><li>再按条件查列表，封装 <code>PaginationResultVO</code> 返回。</li></ul><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> PaginationResultVO&lt;UserInfo&gt; findListByPage(UserInfoQuery param) &#123;</span><br><span class="line">    <span class="built_in">int</span> <span class="keyword">count</span> = <span class="keyword">this</span>.findCountByParam(param);</span><br><span class="line">    <span class="built_in">int</span> pageSize = param.getPageSize() == <span class="literal">null</span> ? PageSize.SIZE15.getSize() : param.getPageSize();</span><br><span class="line"></span><br><span class="line">    SimplePage page = <span class="keyword">new</span> SimplePage(param.getPageNo(), <span class="keyword">count</span>, pageSize);</span><br><span class="line">    param.setSimplePage(page);</span><br><span class="line">    List&lt;UserInfo&gt; list = <span class="keyword">this</span>.findListByParam(param);</span><br><span class="line">    PaginationResultVO&lt;UserInfo&gt; result = <span class="keyword">new</span> PaginationResultVO(<span class="keyword">count</span>, page.getPageSize(), page.getPageNo(), page.getPageTotal(), list);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>批量空集合短路</strong>：<code>addBatch</code>、<code>addOrUpdateBatch</code> 在空集合时直接返回 0，避免落库。</li><li><strong>安全校验</strong>：在 <code>updateByParam</code>、<code>deleteByParam</code> 前调用 <code>StringTools.checkParam(param)</code>，通常用于避免无条件更新/删除。</li><li><strong>便捷方法</strong>：按 <code>userId</code>、<code>email</code> 查询/更新/删除，与 <code>UserInfoMapper.xml</code> 的定制 SQL 一一对应。</li><li>本栏要点：Service 层对分页做编排、对危险操作做前置校验、对外提供语义化方法，并把通用 Mapper 能力转化为业务友好的接口。</li></ul><h2 id="6-Controller层">6.Controller层</h2><h3 id="UserInfoController（接口设计与入参出参）">UserInfoController（接口设计与入参出参）</h3><ul><li><strong>类与路由</strong></li><li><code>@RestController(&quot;userInfoController&quot;)</code> + <code>@RequestMapping(&quot;/userInfo&quot;)</code>，所有接口前缀为 <code>/userInfo</code>。</li><li>继承 <code>ABaseController</code>，统一使用 <code>getSuccessResponseVO</code> 返回标准响应。</li></ul><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span>(<span class="string">&quot;userInfoController&quot;</span>)</span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;/userInfo&quot;</span>)</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">UserInfoController</span> <span class="keyword">extends</span> <span class="title">ABaseController</span></span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">UserInfoService</span> userInfoService;</span><br></pre></td></tr></table></figure><ul><li><strong>分页查询</strong></li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(<span class="string">&quot;/loadDataList&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> ResponseVO loadDataList(UserInfoQuery query)&#123;</span><br><span class="line">    <span class="keyword">return</span> getSuccessResponseVO(userInfoService.findListByPage(query));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>入参为 <code>UserInfoQuery</code>（表单/查询参数绑定），出参为 <code>ResponseVO&lt;PaginationResultVO&lt;UserInfo&gt;&gt;</code>。</li><li><strong>新增/批量</strong></li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(<span class="string">&quot;/add&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> ResponseVO add(UserInfo bean) &#123;</span><br><span class="line">    userInfoService.add(bean);</span><br><span class="line">    <span class="keyword">return</span> getSuccessResponseVO(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@RequestMapping(<span class="string">&quot;/addBatch&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> ResponseVO addBatch(<span class="meta">@RequestBody</span> List&lt;UserInfo&gt; listBean) &#123;</span><br><span class="line">    userInfoService.addBatch(listBean);</span><br><span class="line">    <span class="keyword">return</span> getSuccessResponseVO(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>单条新增走表单绑定；批量新增用 <code>@RequestBody</code> 接收 JSON 数组。</li><li><strong>批量新增/修改（UPSERT）</strong></li></ul><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@RequestMapping</span>(<span class="string">&quot;/addOrUpdateBatch&quot;</span>)</span><br><span class="line">public ResponseVO <span class="built_in">addOrUpdateBatch</span>(<span class="variable">@RequestBody</span> List&lt;UserInfo&gt; listBean) &#123;</span><br><span class="line">    <span class="selector-tag">userInfoService</span><span class="selector-class">.addBatch</span>(listBean);</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">getSuccessResponseVO</span>(null);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>注意：这里调用了 <code>addBatch</code>，按语义应调用 <code>addOrUpdateBatch</code>（可能是小疏漏）。</li><li><strong>按业务键的便捷接口</strong></li><li><code>get/update/deleteUserInfoByUserId</code></li><li><code>get/update/deleteUserInfoByEmail</code></li><li>更新接口入参 <code>UserInfo bean</code> 只需传需要变更的非空字段；查询/删除通过简单字符串参数接收。</li></ul><h3 id="ABaseController（统一响应包装）">ABaseController（统一响应包装）</h3><ul><li>提供成功、业务异常、服务端异常的快捷封装；状态字段使用 <code>status/code/info/data</code> 四元组。</li></ul><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">protected &lt;T&gt; ResponseVO getSuccessResponseVO(T t) &#123;</span><br><span class="line">    ResponseVO&lt;T&gt; responseVO <span class="operator">=</span> new ResponseVO&lt;&gt;()<span class="comment">;</span></span><br><span class="line">    responseVO.setStatus(STATUC_SUCCESS)<span class="comment">;</span></span><br><span class="line">    responseVO.setCode(ResponseCodeEnum.CODE_200.getCode())<span class="comment">;</span></span><br><span class="line">    responseVO.setInfo(ResponseCodeEnum.CODE_200.getMsg())<span class="comment">;</span></span><br><span class="line">    responseVO.setData(t)<span class="comment">;</span></span><br><span class="line">    return responseVO<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="AGlobalExceptionHandlerController（全局异常处理）">AGlobalExceptionHandlerController（全局异常处理）</h3><ul><li>统一捕获异常并转为标准响应，且记录错误日志。</li><li>404 → <code>CODE_404</code></li><li>业务异常 → <code>CODE_600</code> 或自定义</li><li>参数绑定/类型错误 → <code>CODE_600</code></li><li>唯一键冲突 → <code>CODE_601</code></li><li>其它 → <code>CODE_500</code></li></ul><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AGlobalExceptionHandlerController</span> <span class="keyword">extends</span> <span class="title">ABaseController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(AGlobalExceptionHandlerController.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(value = Exception.class)</span><br><span class="line">    <span class="function">Object <span class="title">handleException</span><span class="params">(Exception e, HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        logger.<span class="keyword">error</span>(<span class="string">&quot;请求错误，请求地址&#123;&#125;,错误信息:&quot;</span>, request.getRequestURL(), e);</span><br><span class="line">        ResponseVO ajaxResponse = <span class="keyword">new</span> ResponseVO();</span><br><span class="line">        <span class="comment">//404</span></span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> NoHandlerFoundException) &#123;</span><br><span class="line">            ajaxResponse.setCode(ResponseCodeEnum.CODE_404.getCode());</span><br><span class="line">            ajaxResponse.setInfo(ResponseCodeEnum.CODE_404.getMsg());</span><br><span class="line">            ajaxResponse.setStatus(STATUC_ERROR);</span><br><span class="line">        &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(e <span class="keyword">instanceof</span> BusinessException)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//业务错误</span></span><br><span class="line">            BusinessException biz = (BusinessException) e;</span><br><span class="line">            ajaxResponse.setCode(biz.getCode() == <span class="keyword">null</span> ? ResponseCodeEnum.CODE_600.getCode() : biz.getCode());</span><br><span class="line">            ajaxResponse.setInfo(biz.getMessage());</span><br><span class="line">            ajaxResponse.setStatus(STATUC_ERROR);</span><br><span class="line">        &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(e <span class="keyword">instanceof</span> BindException|| e <span class="keyword">instanceof</span> MethodArgumentTypeMismatchException)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//参数类型错误</span></span><br><span class="line">            ajaxResponse.setCode(ResponseCodeEnum.CODE_600.getCode());</span><br><span class="line">            ajaxResponse.setInfo(ResponseCodeEnum.CODE_600.getMsg());</span><br><span class="line">            ajaxResponse.setStatus(STATUC_ERROR);</span><br><span class="line">        &#125; <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(e <span class="keyword">instanceof</span> DuplicateKeyException)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//主键冲突</span></span><br><span class="line">            ajaxResponse.setCode(ResponseCodeEnum.CODE_601.getCode());</span><br><span class="line">            ajaxResponse.setInfo(ResponseCodeEnum.CODE_601.getMsg());</span><br><span class="line">            ajaxResponse.setStatus(STATUC_ERROR);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ajaxResponse.setCode(ResponseCodeEnum.CODE_500.getCode());</span><br><span class="line">            ajaxResponse.setInfo(ResponseCodeEnum.CODE_500.getMsg());</span><br><span class="line">            ajaxResponse.setStatus(STATUC_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ajaxResponse;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="标准响应模型">标准响应模型</h3><ul><li><p><code>ResponseVO&lt;T&gt;</code>：<code>status</code>（success/error）、<code>code</code>、<code>info</code>、<code>data</code>。</p></li><li><p><code>PaginationResultVO&lt;T&gt;</code>：<code>totalCount</code>、<code>pageSize</code>、<code>pageNo</code>、<code>pageTotal</code>、<code>list</code>；分页列表时作为 <code>data</code> 返回。</p></li><li><p>本栏覆盖了 <code>UserInfoController</code> 的路由与参数绑定方式、标准响应封装以及全局异常到响应码的映射；并指出了 <code>addOrUpdateBatch</code> 可能的调用方法疏漏。</p></li></ul><h2 id="7-通用响应模型与枚举">7.通用响应模型与枚举</h2><h3 id="通用响应模型与枚举">通用响应模型与枚举</h3><ul><li><strong>ResponseVO（统一响应包装）</strong></li><li>字段：<code>status</code>（success/error）、<code>code</code>、<code>info</code>、<code>data</code>。</li><li>用法：控制器通过 <code>ABaseController#getSuccessResponseVO</code> 快速返回成功结果；异常统一在全局异常处理器中包装为错误结果。</li></ul><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> ResponseVO&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> String <span class="keyword">status</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">Integer</span> code;</span><br><span class="line">    <span class="keyword">private</span> String info;</span><br><span class="line">    <span class="keyword">private</span> T <span class="keyword">data</span>;</span><br></pre></td></tr></table></figure><ul><li><strong>PaginationResultVO（分页结果体）</strong></li><li>字段：<code>totalCount</code>、<code>pageSize</code>、<code>pageNo</code>、<code>pageTotal</code>、<code>list</code>。</li><li>用法：Service 计算分页信息后，构造该对象作为 <code>ResponseVO.data</code> 返回。</li></ul><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> PaginationResultVO&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">Integer</span> totalCount;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">Integer</span> pageSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">Integer</span> pageNo;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">Integer</span> pageTotal;</span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; list = new ArrayList&lt;T&gt;();</span><br></pre></td></tr></table></figure><ul><li><strong>ResponseCodeEnum（响应码与默认提示）</strong></li><li>约定：<code>200</code> 成功；<code>404</code> 路由不存在；<code>600</code> 参数错误（含绑定错误）；<code>601</code> 唯一键冲突；<code>500</code> 服务器错误。</li><li>被 <code>ABaseController</code>、全局异常处理器引用，保障全链路返回码一致。</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">public</span> enum ResponseCodeEnum &#123;</span><br><span class="line">    <span class="attribute">CODE_200</span>(<span class="number">200</span>, <span class="string">&quot;请求成功&quot;</span>),</span><br><span class="line">    <span class="attribute">CODE_404</span>(<span class="number">404</span>, <span class="string">&quot;请求地址不存在&quot;</span>),</span><br><span class="line">    <span class="attribute">CODE_600</span>(<span class="number">600</span>, <span class="string">&quot;请求参数错误&quot;</span>),</span><br><span class="line">    <span class="attribute">CODE_601</span>(<span class="number">601</span>, <span class="string">&quot;信息已经存在&quot;</span>),</span><br><span class="line">    <span class="attribute">CODE_500</span>(<span class="number">500</span>, <span class="string">&quot;服务器返回错误，请联系管理员&quot;</span>);</span><br></pre></td></tr></table></figure><ul><li><strong>PageSize（分页枚举）</strong></li><li>提供常用页大小：15、20、30、40、50。</li><li>在 Service 中作为默认 <code>pageSize</code> 兜底，统一前后端分页体验。</li></ul><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">public enum PageSize &#123;</span><br><span class="line">    <span class="built_in">SIZE15</span>(<span class="number">15</span>), <span class="built_in">SIZE20</span>(<span class="number">20</span>), <span class="built_in">SIZE30</span>(<span class="number">30</span>), <span class="built_in">SIZE40</span>(<span class="number">40</span>), <span class="built_in">SIZE50</span>(<span class="number">50</span>);</span><br></pre></td></tr></table></figure><h2 id="8-工具类与基础枚举">8.工具类与基础枚举</h2><h3 id="工具与基础">工具与基础</h3><ul><li><strong>DateTimePatternEnum（日期格式枚举）</strong></li><li>统一日期格式常量：<code>yyyy-MM-dd HH:mm:ss</code>、<code>yyyy-MM-dd</code>，用于序列化、日志与工具类。</li></ul><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">DateTimePatternEnum</span> &#123;</span><br><span class="line">    <span class="built_in">YYYY_MM_DD_HH_MM_SS</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>), <span class="built_in">YYYY_MM_DD</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br></pre></td></tr></table></figure><ul><li><strong>DateUtil（线程安全的日期工具）</strong></li><li>基于 <code>ThreadLocal&lt;SimpleDateFormat&gt;</code> 缓存，避免多线程下 <code>SimpleDateFormat</code> 非线程安全问题。</li><li><code>format(Date, pattern)</code>、<code>parse(String, pattern)</code> 两个核心方法，配合 <code>DateTimePatternEnum</code> 统一格式。</li><li><code>parse</code> 失败时返回 <code>new Date()</code>（注意：生产可考虑抛异常或返回 <code>null</code>）。</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="title class_">Map</span>&lt;<span class="title class_">String</span>, <span class="title class_">ThreadLocal</span>&lt;<span class="title class_">SimpleDateFormat</span>&gt;&gt; sdfMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;<span class="title class_">String</span>, <span class="title class_">ThreadLocal</span>&lt;<span class="title class_">SimpleDateFormat</span>&gt;&gt;();</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title class_">String</span> <span class="title function_">format</span>(<span class="params"><span class="title class_">Date</span> date, <span class="title class_">String</span> pattern</span>) &#123; <span class="keyword">return</span> <span class="title function_">getSdf</span>(pattern).<span class="title function_">format</span>(date); &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title class_">Date</span> <span class="title function_">parse</span>(<span class="params"><span class="title class_">String</span> dateStr, <span class="title class_">String</span> pattern</span>) &#123; ... &#125;</span><br></pre></td></tr></table></figure><ul><li><strong>StringTools（字符串与参数校验）</strong></li><li><code>checkParam(Object param)</code>：反射遍历 <code>getXxx()</code>，确保至少有一个非空条件；否则抛出 <code>BusinessException</code>。用于防止无条件更新/删除。</li><li><code>upperCaseFirstLetter(String)</code>：首字母大写（避开第二个字母大写的缩写场景）。</li><li><code>isEmpty(String)</code>：对 <code>null</code>、空串、“null”、“\u0000”、全空白等判空。</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="title function_">checkParam</span>(<span class="params"><span class="title class_">Object</span> param</span>) &#123;</span><br><span class="line">    <span class="title class_">Field</span>[] fields = param.<span class="title function_">getClass</span>().<span class="title function_">getDeclaredFields</span>();</span><br><span class="line">    <span class="built_in">boolean</span> notEmpty = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="title class_">Field</span> field : fields) &#123;</span><br><span class="line">        <span class="title class_">String</span> methodName = <span class="string">&quot;get&quot;</span> + <span class="title class_">StringTools</span>.<span class="title function_">upperCaseFirstLetter</span>(field.<span class="title function_">getName</span>());</span><br><span class="line">        <span class="title class_">Method</span> method = param.<span class="title function_">getClass</span>().<span class="title function_">getMethod</span>(methodName);</span><br><span class="line">        <span class="title class_">Object</span> <span class="built_in">object</span> = method.<span class="title function_">invoke</span>(param);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">object</span> != <span class="literal">null</span> &amp;&amp; <span class="built_in">object</span> <span class="keyword">instanceof</span> java.<span class="property">lang</span>.<span class="property">String</span> &amp;&amp; !<span class="title class_">StringTools</span>.<span class="title function_">isEmpty</span>(<span class="built_in">object</span>.<span class="title function_">toString</span>())</span><br><span class="line">                || <span class="built_in">object</span> != <span class="literal">null</span> &amp;&amp; !(<span class="built_in">object</span> <span class="keyword">instanceof</span> java.<span class="property">lang</span>.<span class="property">String</span>)) &#123;</span><br><span class="line">            notEmpty = <span class="literal">true</span>; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!notEmpty) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;多参数更新，删除，必须有非空条件&quot;</span>); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>BusinessException（业务异常）</strong></li><li>继承 <code>RuntimeException</code>，支持三种构造：纯消息、码+消息、<code>ResponseCodeEnum</code>。</li><li>重写 <code>fillInStackTrace</code> 返回自身，避免填充堆栈，减小开销（用于可预期的业务异常）。</li><li>被全局异常处理器捕获并映射成标准响应。</li></ul><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">BusinessException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">ResponseCodeEnum</span> codeEnum;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> code;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> message;</span><br></pre></td></tr></table></figure><ul><li>已讲解日期格式与工具类在实体/日志/SQL条件中的统一作用，参数校验如何保护危险操作，以及业务异常如何转化为一致的错误响应。</li></ul><h2 id="9-基础控制器与全局异常">9.基础控制器与全局异常</h2><ul><li><strong>ABaseController（统一响应帮助类）</strong></li><li>提供三个便捷方法：成功返回、业务异常返回、服务器异常返回；内部使用 <code>ResponseCodeEnum</code> 约束 <code>code</code> 与默认 <code>info</code>。</li></ul><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">protected &lt;T&gt; ResponseVO getSuccessResponseVO(T t) &#123;</span><br><span class="line">    ResponseVO&lt;T&gt; responseVO <span class="operator">=</span> new ResponseVO&lt;&gt;()<span class="comment">;</span></span><br><span class="line">    responseVO.setStatus(STATUC_SUCCESS)<span class="comment">;</span></span><br><span class="line">    responseVO.setCode(ResponseCodeEnum.CODE_200.getCode())<span class="comment">;</span></span><br><span class="line">    responseVO.setInfo(ResponseCodeEnum.CODE_200.getMsg())<span class="comment">;</span></span><br><span class="line">    responseVO.setData(t)<span class="comment">;</span></span><br><span class="line">    return responseVO<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>控制器继承它之后，能统一出参格式，避免每个接口手写状态码与提示语。</li><li><strong>AGlobalExceptionHandlerController（全局异常处理器）</strong></li><li>通过 <code>@RestControllerAdvice</code> + <code>@ExceptionHandler(Exception.class)</code> 捕获所有未处理异常，日志记录后，转为标准响应返回。</li><li>规则映射：<ul><li><code>NoHandlerFoundException</code> → 404</li><li><code>BusinessException</code> → 取其自带 <code>code/message</code>，默认 600</li><li><code>BindException</code>、<code>MethodArgumentTypeMismatchException</code> → 600（参数错误）</li><li><code>DuplicateKeyException</code> → 601（唯一键冲突）</li><li>其它异常 → 500（服务器错误）</li></ul></li></ul><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">AGlobalExceptionHandlerController</span> <span class="keyword">extends</span> <span class="title">ABaseController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> static <span class="keyword">final</span> <span class="type">Logger</span> logger = <span class="type">LoggerFactory</span>.getLogger(<span class="type">AGlobalExceptionHandlerController</span>.<span class="keyword">class</span>);</span><br></pre></td></tr></table></figure><ul><li><strong>全链路关系</strong></li><li>控制器 → 使用 <code>ABaseController</code> 统一成功返回。</li><li>业务异常 → 抛出 <code>BusinessException</code>，被全局异常处理器捕获并转成标准错误响应。</li><li>其它异常 → 同样被全局捕获，避免堆栈外泄，保证前端拿到结构化错误。</li></ul><h2 id="10-补充的工具类（常用）">10.补充的工具类（常用）</h2><h3 id="JsonUtils（对象-数组-JSON-转换）">JsonUtils（对象/数组 JSON 转换）</h3><ul><li><strong>定位</strong>：基于 Fastjson 的轻量封装，提供对象、数组与字符串之间的便捷转换。</li><li><strong>方法清单</strong>：</li><li><code>convertObj2Json(Object obj)</code> → 序列化对象为 JSON 字符串。</li><li><code>convertJson2Obj(String json, Class&lt;T&gt; classz)</code> → 反序列化 JSON 为对象。</li><li><code>convertJsonArray2List(String json, Class&lt;T&gt; classz)</code> → 反序列化 JSON 数组为 <code>List&lt;T&gt;</code>。</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JsonUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="title class_">String</span> <span class="title function_">convertObj2Json</span>(<span class="params"><span class="title class_">Object</span> obj</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">JSON</span>.<span class="title function_">toJSONString</span>(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">convertJson2Obj</span>(<span class="params"><span class="title class_">String</span> json, <span class="title class_">Class</span>&lt;T&gt; classz</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">JSON</span><span class="built_in">Object</span>.<span class="title function_">parseObject</span>(json, classz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="title class_">List</span>&lt;T&gt; <span class="title function_">convertJsonArray2List</span>(<span class="params"><span class="title class_">String</span> json, <span class="title class_">Class</span>&lt;T&gt; classz</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">JSON</span><span class="built_in">Array</span>.<span class="title function_">parseArray</span>(json, classz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>使用建议与注意点</strong>：</li><li>建议配合统一的 VO/DTO 使用，避免直接序列化带有敏感字段的实体（如 <code>password</code>）。</li><li>对时间字段，尽量在序列化前规范格式（如 <code>@JsonFormat</code> 或统一 <code>DateUtil</code>）。</li><li>Fastjson 在高版本 JDK 与安全配置下需留意依赖版本与白名单配置；如对安全合规更敏感，可考虑 Jackson。</li></ul><h3 id="RedisConfig（序列化策略与容器）">RedisConfig（序列化策略与容器）</h3><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> RedisConfig&lt;V&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(RedisConfig.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">@Bean</span>(<span class="string">&quot;redisTemplate&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, V&gt; redisTemplate(RedisConnectionFactory factory) &#123;</span><br><span class="line">        RedisTemplate&lt;String, V&gt; <span class="keyword">template</span> = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">        <span class="keyword">template</span>.setConnectionFactory(factory);</span><br><span class="line">        <span class="comment">// 设置key的序列化方式</span></span><br><span class="line">        <span class="keyword">template</span>.setKeySerializer(RedisSerializer.<span class="built_in">string</span>());</span><br><span class="line">        <span class="comment">// 设置value的序列化方式</span></span><br><span class="line">        <span class="keyword">template</span>.setValueSerializer(RedisSerializer.json());</span><br><span class="line">        <span class="comment">// 设置hash的key的序列化方式</span></span><br><span class="line">        <span class="keyword">template</span>.setHashKeySerializer(RedisSerializer.<span class="built_in">string</span>());</span><br><span class="line">        <span class="comment">// 设置hash的value的序列化方式</span></span><br><span class="line">        <span class="keyword">template</span>.setHashValueSerializer(RedisSerializer.json());</span><br><span class="line">        <span class="keyword">template</span>.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">template</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisMessageListenerContainer container(RedisConnectionFactory connectionFactory) &#123;</span><br><span class="line">        RedisMessageListenerContainer container = <span class="keyword">new</span> RedisMessageListenerContainer();</span><br><span class="line">        container.setConnectionFactory(connectionFactory);</span><br><span class="line">        <span class="keyword">return</span> container;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><strong>作用</strong>：集中配置 <code>RedisTemplate</code> 的序列化方式，并注册消息监听容器。</p></li><li><p><strong>核心 Bean</strong>：</p></li><li><pre><code>RedisTemplate&lt;String, V&gt; redisTemplate<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  ：</span><br><span class="line"></span><br><span class="line">  - `KeySerializer`：`RedisSerializer.string()`，人类可读的字符串键。</span><br><span class="line">  - `ValueSerializer`：`RedisSerializer.json()`，值使用 JSON 序列化，便于跨语言/调试。</span><br><span class="line">  - `HashKeySerializer`/`HashValueSerializer`：分别使用 String/JSON，保持一致性。</span><br><span class="line">  - 依赖 `RedisConnectionFactory`，由 Spring Boot 自动配置（Lettuce/Jedis）。</span><br><span class="line"></span><br><span class="line">- `RedisMessageListenerContainer`：用于基于 Redis Pub/Sub 的消息监听（后续可注册 `MessageListener` 监听频道）。</span><br><span class="line"></span><br><span class="line">- **使用建议**：</span><br><span class="line"></span><br><span class="line">- 泛型 `V` 建议为稳定的 DTO/VO，避免直接缓存持久化实体（字段变化会导致反序列化失败）。</span><br><span class="line"></span><br><span class="line">- 若值类型多样，可基于 `RedisTemplate&lt;String, Object&gt;` 配合 Jackson 多态序列化，或自定义多个 `RedisTemplate`。</span><br><span class="line"></span><br><span class="line">- 生产建议启用键前缀、超时策略与序列化白名单，确保缓存空间与安全。</span><br><span class="line"></span><br><span class="line">### RedisUtils（KV、过期、列表、ZSet、计数）</span><br><span class="line"></span><br></pre></td></tr></table></figure></code></pre></li></ul><p>@Component(“redisUtils”)<br>public class RedisUtils<V> {</p><pre><code>@Resourceprivate RedisTemplate&lt;String, V&gt; redisTemplate;private static final Logger logger = LoggerFactory.getLogger(RedisUtils.class);/** * 删除缓存 * * @param key 可以传一个值 或多个 */public void delete(String... key) &#123;    if (key != null &amp;&amp; key.length &gt; 0) &#123;        if (key.length == 1) &#123;            redisTemplate.delete(key[0]);        &#125; else &#123;            redisTemplate.delete((Collection&lt;String&gt;) CollectionUtils.arrayToList(key));        &#125;    &#125;&#125;public V get(String key) &#123;    return key == null ? null : redisTemplate.opsForValue().get(key);&#125;/** * 普通缓存放入 * * @param key   键 * @param value 值 * @return true成功 false失败 */public boolean set(String key, V value) &#123;    try &#123;        redisTemplate.opsForValue().set(key, value);        return true;    &#125; catch (Exception e) &#123;        logger.error(&quot;设置redisKey:&#123;&#125;,value:&#123;&#125;失败&quot;, key, value);        return false;    &#125;&#125;public boolean keyExists(String key) &#123;    return redisTemplate.hasKey(key);&#125;/** * 普通缓存放入并设置时间 * * @param key   键 * @param value 值 * @param time  时间(秒) time要大于0 如果time小于等于0 将设置无限期 * @return true成功 false 失败 */public boolean setex(String key, V value, long time) &#123;    try &#123;        if (time &gt; 0) &#123;            redisTemplate.opsForValue().set(key, value, time, TimeUnit.MILLISECONDS);        &#125; else &#123;            set(key, value);        &#125;        return true;    &#125; catch (Exception e) &#123;        logger.error(&quot;设置redisKey:&#123;&#125;,value:&#123;&#125;失败&quot;, key, value);        return false;    &#125;&#125;public boolean expire(String key, long time) &#123;    try &#123;        if (time &gt; 0) &#123;            redisTemplate.expire(key, time, TimeUnit.MILLISECONDS);        &#125;        return true;    &#125; catch (Exception e) &#123;        e.printStackTrace();        return false;    &#125;&#125;public List&lt;V&gt; getQueueList(String key) &#123;    return redisTemplate.opsForList().range(key, 0, -1);&#125;public boolean lpush(String key, V value, Long time) &#123;    try &#123;        redisTemplate.opsForList().leftPush(key, value);        if (time != null &amp;&amp; time &gt; 0) &#123;            expire(key, time);        &#125;        return true;    &#125; catch (Exception e) &#123;        e.printStackTrace();        return false;    &#125;&#125;public long remove(String key, Object value) &#123;    try &#123;        Long remove = redisTemplate.opsForList().remove(key, 1, value);        return remove;    &#125; catch (Exception e) &#123;        e.printStackTrace();        return 0;    &#125;&#125;public boolean lpushAll(String key, List&lt;V&gt; values, long time) &#123;    try &#123;        redisTemplate.opsForList().leftPushAll(key, values);        if (time &gt; 0) &#123;            expire(key, time);        &#125;        return true;    &#125; catch (Exception e) &#123;        e.printStackTrace();        return false;    &#125;&#125;public V rpop(String key) &#123;    try &#123;        return redisTemplate.opsForList().rightPop(key);    &#125; catch (Exception e) &#123;        e.printStackTrace();        return null;    &#125;&#125;public Long increment(String key) &#123;    Long count = redisTemplate.opsForValue().increment(key, 1);    return count;&#125;public Long incrementex(String key, long milliseconds) &#123;    Long count = redisTemplate.opsForValue().increment(key, 1);    if (count == 1) &#123;        //设置过期时间1天        expire(key, milliseconds);    &#125;    return count;&#125;public Long decrement(String key) &#123;    Long count = redisTemplate.opsForValue().increment(key, -1);    if (count &lt;= 0) &#123;        redisTemplate.delete(key);    &#125;    logger.info(&quot;key:&#123;&#125;,减少数量&#123;&#125;&quot;, key, count);    return count;&#125;public Set&lt;String&gt; getByKeyPrefix(String keyPrifix) &#123;    Set&lt;String&gt; keyList = redisTemplate.keys(keyPrifix + &quot;*&quot;);    return keyList;&#125;public Map&lt;String, V&gt; getBatch(String keyPrifix) &#123;    Set&lt;String&gt; keySet = redisTemplate.keys(keyPrifix + &quot;*&quot;);    List&lt;String&gt; keyList = new ArrayList&lt;&gt;(keySet);    List&lt;V&gt; keyValueList = redisTemplate.opsForValue().multiGet(keyList);    Map&lt;String, V&gt; resultMap = keyList.stream().collect(Collectors.toMap(key -&gt; key, value -&gt; keyValueList.get(keyList.indexOf(value))));    return resultMap;&#125;public void zaddCount(String key, V v) &#123;    redisTemplate.opsForZSet().incrementScore(key, v, 1);&#125;public List&lt;V&gt; getZSetList(String key, Integer count) &#123;    Set&lt;V&gt; topElements = redisTemplate.opsForZSet().reverseRange(key, 0, count);    List&lt;V&gt; list = new ArrayList&lt;&gt;(topElements);    return list;&#125;</code></pre><p>}</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**定位**</span>：在 <span class="code">`RedisTemplate&lt;String, V&gt;`</span> 基础上的便捷封装，覆盖常见 KV、TTL、List、ZSet 与计数场景。</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**KV 与过期**</span></span><br><span class="line"><span class="bullet">-</span> <span class="code">`set(key, value)`</span>：写入值，异常时记录错误日志并返回 false。</span><br><span class="line"><span class="bullet">-</span> <span class="code">`get(key)`</span>：读取值。</span><br><span class="line"><span class="bullet">-</span> <span class="code">`setex(key, value, time)`</span>：写入并设置过期（单位为毫秒；命名与 Redis 原生命令秒级语义不同，注意区分）。</span><br><span class="line"><span class="bullet">-</span> <span class="code">`expire(key, time)`</span>：设置过期（毫秒）。</span><br><span class="line"><span class="bullet">-</span> <span class="code">`delete(String... key)`</span>：删除一个或多个 key。</span><br><span class="line"><span class="bullet">-</span> <span class="code">`keyExists(key)`</span>：判定 key 是否存在。</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**计数器**</span></span><br><span class="line"><span class="bullet">-</span> <span class="code">`increment(key)`</span>：自增 1。</span><br><span class="line"><span class="bullet">-</span> <span class="code">`incrementex(key, milliseconds)`</span>：自增并在首次创建时设置过期。</span><br><span class="line"><span class="bullet">-</span> <span class="code">`decrement(key)`</span>：自减 1，当计数 ≤ 0 时删除键（常用于并发配额/库存计数）。</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**List 队列**</span></span><br><span class="line"><span class="bullet">-</span> <span class="code">`lpush(key, value, time)`</span>：左入队，支持可选过期。</span><br><span class="line"><span class="bullet">-</span> <span class="code">`lpushAll(key, values, time)`</span>：批量左入队并可设置过期。</span><br><span class="line"><span class="bullet">-</span> <span class="code">`rpop(key)`</span>：右出队（消费端）。</span><br><span class="line"><span class="bullet">-</span> <span class="code">`getQueueList(key)`</span>：获取整个列表（调试/观测）。</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**ZSet 排序集合**</span></span><br><span class="line"><span class="bullet">-</span> <span class="code">`zaddCount(key, v)`</span>：对成员 <span class="code">`v`</span> 的分值自增 1（用于热榜计数）。</span><br><span class="line"><span class="bullet">-</span> <span class="code">`getZSetList(key, count)`</span>：按分值从高到低取前 N 个。</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**批量与扫描**</span></span><br><span class="line"><span class="bullet">-</span> <span class="code">`getByKeyPrefix(prefix)`</span>：按前缀扫描 key（注意生产环境下 <span class="code">`keys`</span> 命令为 O(N)，需谨慎）。</span><br><span class="line"><span class="bullet">-</span> <span class="code">`getBatch(prefix)`</span>：批量拉取前缀匹配的 KV 并组装为 <span class="code">`Map`</span>。</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**注意点与建议**</span></span><br><span class="line"><span class="bullet">-</span> 统一采用 JSON 序列化的 <span class="code">`RedisTemplate`</span>，<span class="code">`V`</span> 的类型要稳定，避免字段变更导致反序列化失败。</span><br><span class="line"><span class="bullet">-</span> TTL 单位为毫秒；如需秒级与 Redis 术语一致，可封一层秒级 API。</span><br><span class="line"><span class="bullet">-</span> 高并发计数可考虑使用 <span class="code">`INCRBY`</span>、Lua 脚本或 Redisson 原子计数器来控制原子性与过期策略。</span><br><span class="line"><span class="bullet">-</span> 批量 keys/scan 建议在后台任务或管理端使用，线上请求路径避免阻塞。</span><br><span class="line"></span><br><span class="line"><span class="section">### CopyTools（对象/列表属性复制）</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>public class CopyTools {<br>public static &lt;T, S&gt; List<T> copyList(List<S> sList, Class<T> classz) {<br>List<T> list = new ArrayList<T>();<br>for (S s : sList) {<br>T t = null;<br>try {<br>t = classz.newInstance();<br>} catch (Exception e) {<br>e.printStackTrace();<br>}<br>BeanUtils.copyProperties(s, t);<br>list.add(t);<br>}<br>return list;<br>}</p><pre><code>public static &lt;T, S&gt; T copy(S s, Class&lt;T&gt; classz) &#123;    T t = null;    try &#123;        t = classz.newInstance();    &#125; catch (Exception e) &#123;        e.printStackTrace();    &#125;    BeanUtils.copyProperties(s, t);    return t;&#125;public static &lt;T, S&gt; void copyProperties(S s, T t) &#123;    BeanUtils.copyProperties(s, t);&#125;</code></pre><p>}</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- **定位**：对 `BeanUtils.copyProperties` 的轻量封装，简化对象间属性拷贝与列表转换。</span><br><span class="line">- **核心方法**：</span><br><span class="line">- `copyList(List&lt;S&gt; sList, Class&lt;T&gt; classz)`：将 `List&lt;S&gt;` 转为 `List&lt;T&gt;`，逐个 `newInstance` 并拷贝。</span><br><span class="line">- `copy(S s, Class&lt;T&gt; classz)`：将 `S` 转为 `T`。</span><br><span class="line">- `copyProperties(S s, T t)`：直接把 `s` 的同名属性拷贝到 `t`。</span><br><span class="line">- **使用建议**：</span><br><span class="line">- 适合 Controller/Service 层把 `PO` 转 `VO`、`DTO`，或将第三方对象映射为内部对象。</span><br><span class="line">- 目标类需有无参构造方法；缺失会导致 `newInstance()` 异常。</span><br><span class="line">- 仅按同名属性拷贝，复杂场景（嵌套对象、类型不一致、集合映射）建议用 MapStruct 这类编译期生成工具，性能更优且类型安全。</span><br><span class="line"></span><br><span class="line">### DateUtil 扩展（日期计算与最近 N 日列表）</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>public class DateUtil {</p><pre><code>private static final Object lockObj = new Object();private static Map&lt;String, ThreadLocal&lt;SimpleDateFormat&gt;&gt; sdfMap = new HashMap&lt;String, ThreadLocal&lt;SimpleDateFormat&gt;&gt;();private static SimpleDateFormat getSdf(final String pattern) &#123;    ThreadLocal&lt;SimpleDateFormat&gt; tl = sdfMap.get(pattern);    if (tl == null) &#123;        synchronized (lockObj) &#123;            tl = sdfMap.get(pattern);            if (tl == null) &#123;                tl = new ThreadLocal&lt;SimpleDateFormat&gt;() &#123;                    @Override                    protected SimpleDateFormat initialValue() &#123;                        return new SimpleDateFormat(pattern);                    &#125;                &#125;;                sdfMap.put(pattern, tl);            &#125;        &#125;    &#125;    return tl.get();&#125;public static String format(Date date, String pattern) &#123;    return getSdf(pattern).format(date);&#125;public static Date parse(String dateStr, String pattern) &#123;    try &#123;        return getSdf(pattern).parse(dateStr);    &#125; catch (ParseException e) &#123;        e.printStackTrace();    &#125;    return new Date();&#125;public static String getBeforeDayDate(Integer day) &#123;    Calendar calendar = Calendar.getInstance();    calendar.add(Calendar.DAY_OF_YEAR, -day);    return format(calendar.getTime(), DateTimePatternEnum.YYYY_MM_DD.getPattern());&#125;public static Date getDayAgo(Integer day) &#123;    Calendar calendar = Calendar.getInstance();    calendar.add(Calendar.DAY_OF_YEAR, -day);    return calendar.getTime();&#125;public static List&lt;String&gt; getBeforeDates(Integer beforeDays) &#123;    LocalDate endDate = LocalDate.now();    List&lt;String&gt; dateList = new ArrayList&lt;&gt;();    DateTimeFormatter formatter = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd&quot;);    for (int i = beforeDays; i &gt; 0; i--) &#123;        dateList.add(endDate.minusDays(i).format(formatter));    &#125;    return dateList;&#125;</code></pre><p>}</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**相较基础版的增强**</span></span><br><span class="line"><span class="bullet">-</span> 保留线程安全的 <span class="code">`format/parse`</span>（<span class="code">`ThreadLocal&lt;SimpleDateFormat&gt;`</span>）。</span><br><span class="line"><span class="bullet">-</span> 新增日期偏移与序列生成能力，服务于统计报表、看板、Top-N 趋势等场景。</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**新增方法**</span></span><br><span class="line"><span class="bullet">-</span> <span class="code">`getBeforeDayDate(Integer day)`</span>：返回 N 天前的日期字符串（<span class="code">`yyyy-MM-dd`</span>）。常用于构造查询的开始日期。</span><br><span class="line"><span class="bullet">-</span> <span class="code">`getDayAgo(Integer day)`</span>：返回 N 天前的 <span class="code">`Date`</span> 对象，便于与数据库时间字段直接比较。</span><br><span class="line"><span class="bullet">-</span> <span class="code">`getBeforeDates(Integer beforeDays)`</span>：生成最近 N 天的日期字符串列表（按升序：从 N 天前到昨天），常配合统计曲线补零使用。</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**使用建议**</span></span><br><span class="line"><span class="bullet">-</span> 若需要包含“今天”，可自行追加 <span class="code">`LocalDate.now()`</span> 格式化值。</span><br><span class="line"><span class="bullet">-</span> 跨时区场景建议统一在服务端固定时区或使用 <span class="code">`ZonedDateTime`</span>。</span><br><span class="line"><span class="bullet">-</span> 大批量日期序列生成建议在服务层缓存，避免每次重复计算。</span><br><span class="line"></span><br><span class="line"><span class="section">### FFmpegUtils（缩略图、转码、切片、时长）</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>@Component<br>public class FFmpegUtils {</p><pre><code>@Resourceprivate AppConfig appConfig;/** * 生成图片缩略图 * * @param filePath * @return */public void createImageThumbnail(String filePath) &#123;    final String CMD_CREATE_IMAGE_THUMBNAIL = &quot;ffmpeg -i \&quot;%s\&quot; -vf scale=200:-1 \&quot;%s\&quot;&quot;;    String cmd = String.format(CMD_CREATE_IMAGE_THUMBNAIL, filePath, filePath + Constants.IMAGE_THUMBNAIL_SUFFIX);    ProcessUtils.executeCommand(cmd, appConfig.getShowFFmpegLog());&#125;/** * 获取视频编码 * * @param videoFilePath * @return */public String getVideoCodec(String videoFilePath) &#123;    final String CMD_GET_CODE = &quot;ffprobe -v error -select_streams v:0 -show_entries stream=codec_name \&quot;%s\&quot;&quot;;    String cmd = String.format(CMD_GET_CODE, videoFilePath);    String result = ProcessUtils.executeCommand(cmd, appConfig.getShowFFmpegLog());    result = result.replace(&quot;\n&quot;, &quot;&quot;);    result = result.substring(result.indexOf(&quot;=&quot;) + 1);    String codec = result.substring(0, result.indexOf(&quot;[&quot;));    return codec;&#125;public void convertHevc2Mp4(String newFileName, String videoFilePath) &#123;    String CMD_HEVC_264 = &quot;ffmpeg -i %s -c:v libx264 -crf 20 %s&quot;;    String cmd = String.format(CMD_HEVC_264, newFileName, videoFilePath);    ProcessUtils.executeCommand(cmd, appConfig.getShowFFmpegLog());&#125;public void convertVideo2Ts(File tsFolder, String videoFilePath) &#123;    final String CMD_TRANSFER_2TS = &quot;ffmpeg -y -i \&quot;%s\&quot;  -vcodec copy -acodec copy -bsf:v h264_mp4toannexb \&quot;%s\&quot;&quot;;    final String CMD_CUT_TS = &quot;ffmpeg -i \&quot;%s\&quot; -c copy -map 0 -f segment -segment_list \&quot;%s\&quot; -segment_time 10 %s/%%4d.ts&quot;;    String tsPath = tsFolder + &quot;/&quot; + Constants.TS_NAME;    //生成.ts    String cmd = String.format(CMD_TRANSFER_2TS, videoFilePath, tsPath);    ProcessUtils.executeCommand(cmd, appConfig.getShowFFmpegLog());    //生成索引文件.m3u8 和切片.ts    cmd = String.format(CMD_CUT_TS, tsPath, tsFolder.getPath() + &quot;/&quot; + Constants.M3U8_NAME, tsFolder.getPath());    ProcessUtils.executeCommand(cmd, appConfig.getShowFFmpegLog());    //删除index.ts    new File(tsPath).delete();&#125;public Integer getVideoInfoDuration(String completeVideo) &#123;    final String CMD_GET_CODE = &quot;ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 \&quot;%s\&quot;&quot;;    String cmd = String.format(CMD_GET_CODE, completeVideo);    String result = ProcessUtils.executeCommand(cmd, appConfig.getShowFFmpegLog());    if (StringTools.isEmpty(result)) &#123;        return 0;    &#125;    result = result.replace(&quot;\n&quot;, &quot;&quot;);    return new BigDecimal(result).intValue();&#125;</code></pre><p>}</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**定位**</span>：封装常用的 FFmpeg/FFprobe 命令，结合 <span class="code">`ProcessUtils`</span> 执行系统命令完成多媒体处理。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**依赖**</span>：<span class="code">`AppConfig`</span>（是否打印日志等开关）、<span class="code">`Constants`</span>（文件名常量）、<span class="code">`ProcessUtils`</span>（跨平台命令执行）、<span class="code">`StringTools`</span>。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**核心方法**</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> createImageThumbnail(String filePath)</span><br><span class="line"></span><br><span class="line">  ：生成图片缩略图</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> 命令：<span class="code">`ffmpeg -i &quot;源&quot; -vf scale=200:-1 &quot;源+缩略图后缀&quot;`</span></span><br><span class="line"><span class="bullet">  -</span> 等比缩放到宽 200 像素，高自适应。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> getVideoCodec(String videoFilePath)</span><br><span class="line"></span><br><span class="line">  ：读取视频编码</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> 命令：<span class="code">`ffprobe ... -show_entries stream=codec_name`</span></span><br><span class="line"><span class="bullet">  -</span> 解析输出得到 <span class="code">`codec`</span>（如 h264、hevc）。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> convertHevc2Mp4(String newFileName, String videoFilePath)</span><br><span class="line"></span><br><span class="line">  ：视频转码</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> 命令：<span class="code">`ffmpeg -i 源 -c:v libx264 -crf 20 目标`</span></span><br><span class="line"><span class="bullet">  -</span> 将 HEVC 转成 H.264，<span class="code">`crf=20`</span> 表示质量与大小的权衡，可按需求调整。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> convertVideo2Ts(File tsFolder, String videoFilePath)</span><br><span class="line"></span><br><span class="line">  ：生成 HLS 切片</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> 先转中间 <span class="code">`index.ts`</span>，再用 <span class="code">`-f segment -segment_list index.m3u8 -segment_time 10 %04d.ts`</span> 切片，最后删除中间文件。</span><br><span class="line"><span class="bullet">  -</span> 生成 <span class="code">`.m3u8`</span> 与多个 <span class="code">`.ts`</span> 切片，可用于点播/预览。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> getVideoInfoDuration(String completeVideo)</span><br><span class="line"></span><br><span class="line">  ：获取视频时长（秒）</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> 命令：<span class="code">`ffprobe ... -show_entries format=duration`</span></span><br><span class="line"><span class="bullet">  -</span> 取返回秒数字符串转整型。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**使用建议**</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 确保部署机有 <span class="code">`ffmpeg`</span>/<span class="code">`ffprobe`</span> 可执行程序，并在 PATH 中。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 大文件处理建议配合异步任务与进度上报，避免阻塞请求线程。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 对输入/输出路径做合法性检查，避免空格或特殊字符导致命令失败。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 转码参数（如 <span class="code">`crf`</span>、码率、分辨率）根据业务带宽成本与画质要求调优。</span><br><span class="line"></span><br><span class="line"><span class="section">### ProcessUtils（跨平台命令执行、输出收集、钩子）</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>public class ProcessUtils {<br>private static final Logger logger = LoggerFactory.getLogger(ProcessUtils.class);</p><pre><code>private static final String osName = System.getProperty(&quot;os.name&quot;).toLowerCase();public static String executeCommand(String cmd, Boolean showLog) throws BusinessException &#123;    if (StringTools.isEmpty(cmd)) &#123;        return null;    &#125;    Runtime runtime = Runtime.getRuntime();    Process process = null;    try &#123;        //判断操作系统        if (osName.contains(&quot;win&quot;)) &#123;            process = Runtime.getRuntime().exec(cmd);        &#125; else &#123;            process = Runtime.getRuntime().exec(new String[]&#123;&quot;/bin/sh&quot;, &quot;-c&quot;, cmd&#125;);        &#125;        // 执行ffmpeg指令        // 取出输出流和错误流的信息        // 注意：必须要取出ffmpeg在执行命令过程中产生的输出信息，如果不取的话当输出流信息填满jvm存储输出留信息的缓冲区时，线程就回阻塞住        PrintStream errorStream = new PrintStream(process.getErrorStream());        PrintStream inputStream = new PrintStream(process.getInputStream());        errorStream.start();        inputStream.start();        // 等待ffmpeg命令执行完        process.waitFor();        // 获取执行结果字符串        String result = errorStream.stringBuffer.append(inputStream.stringBuffer + &quot;\n&quot;).toString();        // 输出执行的命令信息        if (showLog) &#123;            logger.info(&quot;执行命令&#123;&#125;结果&#123;&#125;&quot;, cmd, result);        &#125;        return result;    &#125; catch (Exception e) &#123;        logger.error(&quot;执行命令失败cmd&#123;&#125;失败:&#123;&#125; &quot;, cmd, e.getMessage());        throw new BusinessException(&quot;视频转换失败&quot;);    &#125; finally &#123;        if (null != process) &#123;            ProcessKiller ffmpegKiller = new ProcessKiller(process);            runtime.addShutdownHook(ffmpegKiller);        &#125;    &#125;&#125;/** * 在程序退出前结束已有的FFmpeg进程 */private static class ProcessKiller extends Thread &#123;    private Process process;    public ProcessKiller(Process process) &#123;        this.process = process;    &#125;    @Override    public void run() &#123;        this.process.destroy();    &#125;&#125;/** * 用于取出ffmpeg线程执行过程中产生的各种输出和错误流的信息 */static class PrintStream extends Thread &#123;    InputStream inputStream = null;    BufferedReader bufferedReader = null;    StringBuffer stringBuffer = new StringBuffer();    public PrintStream(InputStream inputStream) &#123;        this.inputStream = inputStream;    &#125;    @Override    public void run() &#123;        try &#123;            if (null == inputStream) &#123;                return;            &#125;            bufferedReader = new BufferedReader(new InputStreamReader(inputStream));            String line = null;            while ((line = bufferedReader.readLine()) != null) &#123;                stringBuffer.append(line);            &#125;        &#125; catch (Exception e) &#123;            logger.error(&quot;读取输入流出错了！错误信息：&quot; + e.getMessage());        &#125; finally &#123;            try &#123;                if (null != bufferedReader) &#123;                    bufferedReader.close();                &#125;                if (null != inputStream) &#123;                    inputStream.close();                &#125;            &#125; catch (IOException e) &#123;                logger.error(&quot;调用PrintStream读取输出流后，关闭流时出错！&quot;);            &#125;        &#125;    &#125;&#125;</code></pre><p>}</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**定位**</span>：跨平台执行外部命令（Windows/类 Unix），并安全收集标准输出与错误输出，结合 <span class="code">`BusinessException`</span> 做统一错误抛出。</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**跨平台执行**</span></span><br><span class="line"><span class="bullet">-</span> Windows：<span class="code">`Runtime.exec(cmd)`</span></span><br><span class="line"><span class="bullet">-</span> Linux/macOS：<span class="code">`Runtime.exec(new String[]&#123;&quot;/bin/sh&quot;,&quot;-c&quot;,cmd&#125;)`</span></span><br><span class="line"><span class="bullet">-</span> 通过 <span class="code">`os.name`</span> 判断系统类型。</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**输出收集防阻塞**</span></span><br><span class="line"><span class="bullet">-</span> 同时启动两个内部线程 <span class="code">`PrintStream`</span> 读取 <span class="code">`process.getErrorStream()`</span> 与 <span class="code">`process.getInputStream()`</span>，避免缓冲区塞满导致子进程阻塞。</span><br><span class="line"><span class="bullet">-</span> <span class="code">`waitFor()`</span> 等待命令执行结束，再拼接两路输出为结果字符串返回（按 <span class="code">`showLog`</span> 决定是否日志输出）。</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**失败处理与退出钩子**</span></span><br><span class="line"><span class="bullet">-</span> 出错时记录错误日志并抛出 <span class="code">`BusinessException(&quot;视频转换失败&quot;)`</span>。</span><br><span class="line"><span class="bullet">-</span> <span class="code">`finally`</span> 中注册 <span class="code">`ProcessKiller`</span> 作为 JVM 退出钩子，确保进程随应用退出而销毁，避免僵尸进程。</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**使用建议**</span></span><br><span class="line"><span class="bullet">-</span> 传入的 <span class="code">`cmd`</span> 要对输入文件路径做转义（包含空格/特殊字符时需加引号）。</span><br><span class="line"><span class="bullet">-</span> 长时间运行的命令建议在业务层设置超时策略或异步化处理。</span><br><span class="line"><span class="bullet">-</span> 返回结果可依据需要进一步解析（例如筛选 ffmpeg 的进度行）。</span><br><span class="line"></span><br><span class="line"><span class="section">### GatewayExceptionHandler（WebFlux 网关统一异常）</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>@Slf4j<br>@Order(-1)<br>@Component<br>public class GatewayExceptionHandler implements WebExceptionHandler {</p><pre><code>protected static final String STATUC_ERROR = &quot;error&quot;;@Overridepublic Mono&lt;Void&gt; handle(ServerWebExchange exchange, Throwable throwable) &#123;    log.error(&quot;网关请求错误url:&#123;&#125;,错误信息&quot;, exchange.getRequest().getPath(), throwable);    ResponseVO responseVO = getResponse(exchange, throwable);    ServerHttpResponse response = exchange.getResponse();    response.getHeaders().setContentType(MediaType.APPLICATION_JSON);    DataBuffer dataBuffer = response.bufferFactory().wrap(JsonUtils.convertObj2Json(responseVO).getBytes(StandardCharsets.UTF_8));    return response.writeWith(Mono.just(dataBuffer));&#125;private ResponseVO getResponse(ServerWebExchange exchange, Throwable throwable) &#123;    ResponseVO responseVO = new ResponseVO();    responseVO.setStatus(STATUC_ERROR);    if (throwable instanceof ResponseStatusException) &#123;        ResponseStatusException responseStatusException = (ResponseStatusException) throwable;        //404        if (HttpStatus.NOT_FOUND == responseStatusException.getStatus()) &#123;            responseVO.setCode(ResponseCodeEnum.CODE_404.getCode());            responseVO.setInfo(ResponseCodeEnum.CODE_404.getMsg());            return responseVO;        &#125; else if (HttpStatus.SERVICE_UNAVAILABLE == responseStatusException.getStatus()) &#123;            //503            responseVO.setCode(ResponseCodeEnum.CODE_503.getCode());            responseVO.setInfo(ResponseCodeEnum.CODE_503.getMsg());            return responseVO;        &#125; else &#123;            responseVO.setCode(responseStatusException.getStatus().value());            responseVO.setInfo(ResponseCodeEnum.CODE_500.getMsg());            return responseVO;        &#125;        //业务异常    &#125; else if (throwable instanceof BusinessException) &#123;        BusinessException exception = (BusinessException) throwable;        responseVO.setCode(exception.getCode());        responseVO.setInfo(exception.getMessage());        return responseVO;    &#125;    responseVO.setCode(ResponseCodeEnum.CODE_500.getCode());    responseVO.setInfo(ResponseCodeEnum.CODE_500.getMsg());    return responseVO;&#125;</code></pre><p>}</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="title">- **定位**:</span> 在 Spring Cloud Gateway（WebFlux）链路中统一拦截异常，转为标准 `ResponseVO` JSON 响应，保证微服务前置网关的响应一致性。</span><br><span class="line"></span><br><span class="line">- **关键点**：</span><br><span class="line"></span><br><span class="line">- `WebExceptionHandler` 接口；`@Order(-<span class="number">1</span>)` 提高优先级，`@Component` 自动装配。</span><br><span class="line"></span><br><span class="line">- 在 `handle` 中构造 `ResponseVO`，设置响应头为 `application/json`，使用 `JsonUtils` 写出。</span><br><span class="line"></span><br><span class="line">- **异常映射策略**：</span><br><span class="line"></span><br><span class="line">- ```</span><br><span class="line">  ResponseStatusException</span><br></pre></td></tr></table></figure><p>:</p><ul><li><p><code>HttpStatus.NOT_FOUND</code> → <code>CODE_404</code></p></li><li><p><code>HttpStatus.SERVICE_UNAVAILABLE</code> → <code>CODE_503</code>（注意：需要在 <code>ResponseCodeEnum</code> 中有 503 对应项；若当前没有，请补充枚举）</p></li><li><p>其它 → 使用状态码本身，<code>info</code> 统一为 500 的提示（“服务器返回错误，请联系管理员”）</p></li><li><pre><code>BusinessException<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  :</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> 取异常内的 <span class="code">`code`</span> 与 <span class="code">`message`</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 其它异常:</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> 统一映射为 <span class="code">`CODE_500`</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**响应写出**</span>：</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="code">`response.getHeaders().setContentType(MediaType.APPLICATION_JSON)`</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="code">`response.writeWith(Mono.just(buffer))`</span> 输出 <span class="code">`JsonUtils.convertObj2Json(responseVO)`</span> 的字节。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**使用建议**</span>：</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 建议复用与业务服务端一致的 <span class="code">`ResponseVO`</span>、<span class="code">`ResponseCodeEnum`</span>，避免前端解析差异。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 统一在网关侧记录 <span class="code">`url + throwable`</span>，便于链路定位。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 对大多数路由异常（如没有匹配路由、服务不可用）直接在此处转化，避免透传到前端非结构化错误。</span><br><span class="line"></span><br><span class="line"><span class="section">### 注解：GlobalInterceptor（全局拦截开关）</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**定位**</span>：用于在切面层实现“是否需要登录”等通用拦截逻辑的开关注解。可标注在 Controller 类或方法上。</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**注解定义**</span>：</span><br><span class="line"></span><br></pre></td></tr></table></figure></code></pre></li></ul><p>@Target({ElementType.METHOD, ElementType.TYPE})<br>@Retention(RetentionPolicy.RUNTIME)<br>public @interface GlobalInterceptor {<br>boolean checkLogin() default false;<br>}</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**典型用法**</span>：</span><br><span class="line"><span class="bullet">-</span> 在控制器方法上标注 <span class="code">`@GlobalInterceptor(checkLogin = true)`</span>，由全局切面 <span class="code">`GlobalOperationAspect`</span> 在方法执行前校验登录态（如校验 token、会话、权限）。</span><br><span class="line"><span class="bullet">-</span> 标注在类上可作为默认策略；方法上再次标注可覆盖类级默认。</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**实现思路（切面侧）**</span>：</span><br><span class="line"><span class="bullet">-</span> 切点：匹配带有 <span class="code">`@GlobalInterceptor`</span> 的类/方法。</span><br><span class="line"><span class="bullet">-</span> 前置逻辑：若 <span class="code">`checkLogin = true`</span>，则读取上下文（Header/Cookie/ThreadLocal）校验；失败抛 <span class="code">`BusinessException(CODE_600/未登录)`</span>。</span><br><span class="line"><span class="bullet">-</span> 统一异常：由全局异常处理器或网关异常处理器转成标准响应。</span><br><span class="line"></span><br><span class="line"><span class="section">### 注解：RecordUserMessage（行为转消息记录）</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**定位**</span>：把用户行为（点赞、评论、回复等）在切面层转化为站内消息，通知被影响的用户。</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**注解定义**</span>：</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>@Target({ElementType.METHOD, ElementType.TYPE})<br>@Retention(RetentionPolicy.RUNTIME)<br>public @interface RecordUserMessage {<br>MessageTypeEnum messageType();<br>}</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**典型用法**</span>：</span><br><span class="line"><span class="bullet">-</span> 在“点赞接口”、“评论接口”等方法上标注 <span class="code">`@RecordUserMessage(messageType = MessageTypeEnum.LIKE)`</span>；</span><br><span class="line"><span class="bullet">-</span> 切面在方法成功后采集关键信息（操作者、目标对象、被通知人），写入消息表或投递消息队列。</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**实现思路（切面侧）**</span>：</span><br><span class="line"><span class="bullet">-</span> 切点：匹配带 <span class="code">`@RecordUserMessage`</span> 的方法；</span><br><span class="line"><span class="bullet">-</span> 环绕/后置通知：在方法执行成功后，构建消息体（类型、业务ID、触发人、接收人、时间）；</span><br><span class="line"><span class="bullet">-</span> 持久化/投递：保存到 <span class="code">`user_message`</span> 表，或发送 MQ（Kafka/RabbitMQ）供异步消费；</span><br><span class="line"><span class="bullet">-</span> 幂等：基于业务键（行为人+目标+类型）做幂等去重，避免重复消息；</span><br><span class="line"><span class="bullet">-</span> 性能：高频行为建议异步化，避免阻塞主流程。</span><br><span class="line"></span><br><span class="line"><span class="section">### 11.全栏收尾总结（EasyJava 生成文件详解 + 补充工具）</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**实体与查询建模**</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="code">`UserInfo`</span>（PO）：严格映射 <span class="code">`user_info`</span> 字段，时间字段用 <span class="code">`@JsonFormat/@DateTimeFormat`</span> 统一格式，<span class="code">`toString`</span> 使用 <span class="code">`DateUtil`</span> 与 <span class="code">`DateTimePatternEnum`</span>。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="code">`UserInfoQuery`</span>：承载检索条件，提供精确/模糊字段与时间区间；继承 <span class="code">`BaseParam`</span> 获得分页与排序。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="code">`BaseParam`</span>/<span class="code">`SimplePage`</span>：分页核心（计算 <span class="code">`start/end/pageTotal`</span>），<span class="code">`orderBy`</span> 统一排序入参。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**数据访问层（Mapper 与 XML）**</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="code">`BaseMapper`</span>：通用 CRUD/批量/按条件更新删除；<span class="code">`BaseMapperTableSplit`</span>：增加 <span class="code">`tableName`</span> 支持分表。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="code">```</span></span><br><span class="line"><span class="code">  UserInfoMapper</span></span><br></pre></td></tr></table></figure><p>+</p>  <figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UserInfoMapper.<span class="built_in">xml</span></span><br></pre></td></tr></table></figure><p>：</p><ul><li><p><code>resultMap</code>、通用列片段、条件片段（精确/模糊/时间区间）。</p></li><li><p>列表/计数分页与排序；插入/批量/UPSERT；按业务键（<code>userId/email</code>）便捷 CRUD。</p></li><li><p>时间区间闭区间处理、<code>orderBy</code> 需白名单防注入。</p></li><li><p><strong>服务与控制层</strong></p></li><li><p><code>UserInfoService/Impl</code>：分页编排（先计数再查列表）、空集合短路、<code>StringTools.checkParam</code> 防“无条件更新/删除”。</p></li><li><p><code>UserInfoController</code>：路由分组 <code>/userInfo</code>；新增、批量、UPSERT（指出了一个调用 <code>addBatch</code> 的小疏漏应为 <code>addOrUpdateBatch</code>）；</p></li><li><p><code>ABaseController</code>：<code>getSuccessResponseVO/getBusinessErrorResponseVO/getServerErrorResponseVO</code> 标准响应封装。</p></li><li><p><code>AGlobalExceptionHandlerController</code>：统一异常到 <code>ResponseVO</code>（404/600/601/500 等）。</p></li><li><p><strong>通用响应与枚举</strong></p></li><li><p><code>ResponseVO&lt;T&gt;</code>：<code>status/code/info/data</code> 四元组。</p></li><li><p><code>PaginationResultVO&lt;T&gt;</code>：<code>totalCount/pageSize/pageNo/pageTotal/list</code>。</p></li><li><p><code>ResponseCodeEnum</code>：<code>200/404/600/601/500</code>（网关需要时补充 <code>503</code>）。</p></li><li><p><code>PageSize</code>：常用页大小枚举（15/20/30/40/50）。</p></li><li><p><strong>工具与基础</strong></p></li><li><p>日期与字符串</p><ul><li><code>DateTimePatternEnum</code>：统一日期格式。</li><li><code>DateUtil</code>：线程安全 <code>format/parse</code>；扩展版支持获取 N 天前日期、日期序列。</li><li><code>StringTools</code>：<code>checkParam</code> 反射校验条件非空；<code>isEmpty/upperCaseFirstLetter</code>。</li></ul></li><li><p>业务异常</p><ul><li><code>BusinessException</code>：支持码+消息/枚举构造，重写 <code>fillInStackTrace</code> 免堆栈提升性能；全局异常器统一转换。</li></ul></li><li><p>JSON</p><ul><li><code>JsonUtils</code>（Fastjson）：对象/数组与 JSON 互转；敏感字段与时间格式需注意。</li></ul></li><li><p>Redis</p><ul><li><code>RedisConfig</code>：统一 <code>RedisTemplate</code> 序列化（String/JSON）、监听容器。</li><li><code>RedisUtils</code>：KV/TTL、列表队列、ZSet 热榜、计数器与首创建过期、前缀批量拉取。</li></ul></li><li><p>多媒体与进程</p><ul><li><code>FFmpegUtils</code>：缩略图、编码识别、转码（x264 CRF）、HLS 切片、时长读取。</li><li><code>ProcessUtils</code>：跨平台执行命令、双流读取防阻塞、JVM 退出钩子、统一异常。</li></ul></li><li><p>网关</p><ul><li><code>GatewayExceptionHandler</code>：WebFlux 网关统一异常到 <code>ResponseVO</code>（404/503/500/业务码），JSON 输出。</li></ul></li><li><p>注解与切面语义</p><ul><li><code>GlobalInterceptor</code>：控制器/方法级登录校验开关，交由切面实现。</li><li><code>RecordUserMessage</code>：行为转站内消息，切面在方法成功后落库/投递，建议做幂等与异步化。</li></ul></li><li><p><strong>整体价值与落地建议</strong></p></li><li><p>生成器输出构成“从表到接口”的最小闭环：PO/Query → Mapper/XML → Service → Controller → 统一响应/异常。</p></li><li><p>静态规范（时间格式、分页、响应码）+ 动态校验（参数非空、排序白名单）保持接口一致性与安全性。</p></li><li><p>对高频与重计算场景提供 Redis 与工具类支撑；对多媒体场景提供 FFmpeg 封装与进程安全执行。</p></li><li><p>建议清单：</p><ul><li>Controller 中 <code>addOrUpdateBatch</code> 调用修正为 Service 的同名方法。</li><li><code>orderBy</code> 做白名单校验；<code>ResponseCodeEnum</code> 补充 <code>503</code>（若使用网关映射）。</li><li>Fastjson/Jackson 统一策略与版本安全；<code>JsonUtils</code> 保护敏感字段。</li><li><code>RedisUtils</code> 的 <code>keys</code>/前缀操作仅用于运维/后台任务，在线路由避免使用。</li></ul></li></ul>]]></content>
    
    
    <summary type="html">代码生成器详解，通过深入分析代码生成器的内部机制，能够更好地利用这一工具提高开发效率。</summary>
    
    
    
    <category term="项目" scheme="https://itgeqian.github.io/categories/%E9%A1%B9%E7%9B%AE/"/>
    
    
    <category term="项目相关" scheme="https://itgeqian.github.io/tags/%E9%A1%B9%E7%9B%AE%E7%9B%B8%E5%85%B3/"/>
    
  </entry>
  
  <entry>
    <title>AIGC之Comfyui</title>
    <link href="https://itgeqian.github.io/posts/53.html"/>
    <id>https://itgeqian.github.io/posts/53.html</id>
    <published>2025-09-06T03:19:03.000Z</published>
    <updated>2025-09-05T23:03:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-目标"><strong>1.目标</strong></h2><p>今天开始我们来学习AIGC中文生图相关功能及技术，在今天的学习内容中主要包含了以下内容：</p><ul><li>Comfyui的认识与安装</li><li>Comfyui的API使用</li><li>Comfyui常用的文生图功能</li><li>Comfyui常用的图生图功能</li><li>Comfyui常用的图片处理功能</li><li>使用Comfyui开发星图AI软件</li></ul><p>总学习目标：</p><ul><li>通过对AIGC中文生图的技术及知识的学习和掌握，能够应对或满足互联网（自媒体素材）、媒体与广告、娱乐、金融、教育等行业类似业务需求的开发</li></ul><p>阶段学习目标：</p><ul><li>能够熟知StableDIffusion、Comfyui等技术或工具的原理</li><li>能够使用Comfyui绘制文生图流程</li><li>能够使用Retrofit封装三方API</li><li>能够使用Comfyui进行图片精修</li><li>能够熟练使用Comfyui的API</li><li>能够熟练使用Ollama的API</li><li>能够使用API开发出AI绘图工具星图</li><li>能够理解和应用分布式锁和分布式信号量</li><li>能够设计和开发复式记账法功能</li><li>能够理解和运用数据流分析法</li><li>能够设计和开发双端通信功能</li><li>能够熟练应用Websocket实现点对点、广播推送</li><li></li></ul><h2 id="2-Comfyui-入门">2.<strong>Comfyui 入门</strong></h2><h3 id="1-Comfyui介绍">1.Comfyui介绍</h3><p>Comfyui：最强大的、模块化的Stable Diffusion的客户端。<a href="https://github.com/comfyanonymous/ComfyUI">https://github.com/comfyanonymous/ComfyUI</a></p><p>主要特点有：</p><ul><li>通过流程图的方式，来完成Stable Diffusion的出图功能，过程中不需要写代码；</li><li>完全支持SD1.x、SD2.x、SDXL、SD3.x、Stable Video Diffusion、Stable Audio</li><li>异步排队系统</li><li>支持cpu运行、或者在1GB的GPU上运行</li><li>支持Lora、ControlNet、T2I-Adapter、UnClip等功能</li><li>支持将工作流保存为json或图片</li><li>支持windows、linux、mac多平台</li></ul><h3 id="2-安装Comfyui">2.安装Comfyui</h3><p>黑马课程中的Comfyui版本过老，我们在Windows中安装别人整合好的Comfyui整合包，直接模型+插件都有</p><p>下载整合包 <a href="https://www.2020web.cn/894.html">2025年9月秋叶大佬最新Comfyui整合包：ComfyUI-aki-V1.7-史诗级更新 - ComfyUI资源网</a></p><p>环境配置：<a href="https://www.2020web.cn/1733.html">Comfyui 从0到1环境配置指南（全教程） - ComfyUI资源网</a></p><p>Comfyui目录结构</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-110-915x1024.png" alt="img"></p><h3 id="3-Comfyui入门案例">3.Comfyui入门案例</h3><p>入门案例我们单独开一篇文章讲解</p><h2 id="3-封装Comfyui客户端">3.<strong>封装Comfyui客户端</strong></h2><p>为便于在我们程序中通过API来与Comfyui进行通信，我们可以先学习封装相关API，但值得注意的是：这里除封装上一节的API之外，还会封装通过Websocket取监听Comfyui的消息。</p><h3 id="1-创建项目">1.创建项目</h3><p>创建一个SpringBoot工程，名称叫star-graph，设置项目JDK为17版本，并按照以下配置进行初始化项目。</p><h4 id="设置项目Pom依赖">设置项目Pom依赖</h4><p>项目基于SpringBoot3.2版本进行构建，并引入了Redis、Mysql、Hutool、WebSocket等依赖（部分依赖作用后续会讲解）。把一下内容覆盖新建项目的pom.xml内容，然后刷新maven依赖。</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.itcast<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>star-graph<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>17<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">mybatis_plus.version</span>&gt;</span>3.5.7<span class="tag">&lt;/<span class="name">mybatis_plus.version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.fastjson2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.31<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>annotationProcessor<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.33<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$</span><span class="template-variable">&#123;mybatis_plus.version&#125;</span><span class="language-xml"><span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-validation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.retrofit2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>retrofit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.retrofit2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>converter-jackson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logging-interceptor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.30.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>star-graph-demo<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h4 id="配置项目Yml文件">配置项目Yml文件</h4><p>由于项目依赖了Mysql和Redis，因此还需要再application.yml文件中配置相关的属性信息。</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">spring:</span></span><br><span class="line">  <span class="params">datasource:</span></span><br><span class="line">    <span class="params">driver-class-name:</span> com.mysql.cj.jdbc.Driver</span><br><span class="line">    <span class="params">url:</span> jdbc:mysql:<span class="operator">//</span><span class="number">192.168</span>.<span class="number">100.129</span>:<span class="number">3306</span><span class="operator">/</span>star_graph<span class="operator">?</span>useUnicode<span class="operator">=</span><span class="literal">true</span>&amp;characterEncoding<span class="operator">=</span>utf-<span class="number">8</span>&amp;useSSL<span class="operator">=</span><span class="literal">false</span>&amp;serverTimezone<span class="operator">=</span>UTC&amp;allowPublicKeyRetrieval<span class="operator">=</span><span class="literal">true</span></span><br><span class="line">    <span class="params">username:</span> root</span><br><span class="line">    <span class="params">password:</span> <span class="number">87</span>sdhf298TYUUIz2<span class="operator">!</span></span><br><span class="line">  <span class="params">data:</span></span><br><span class="line">    <span class="params">redis:</span></span><br><span class="line">      <span class="params">host:</span> <span class="number">192.168</span>.<span class="number">100.129</span></span><br><span class="line">      <span class="params">port:</span> <span class="number">6379</span></span><br><span class="line"></span><br><span class="line"><span class="params">mybatis-plus:</span></span><br><span class="line">  <span class="params">configuration:</span></span><br><span class="line">    <span class="params">log-impl:</span> org.apache.ibatis.logging.stdout.StdOutImpl</span><br><span class="line">  <span class="params">global-config:</span></span><br><span class="line">    <span class="params">db-config:</span></span><br><span class="line">      <span class="params">table-prefix:</span> sg_</span><br><span class="line"></span><br><span class="line"><span class="params">logging:</span></span><br><span class="line">  <span class="params">level:</span></span><br><span class="line">    <span class="params">root:</span> info</span><br></pre></td></tr></table></figure><h4 id="创建启动类并启动测试">创建启动类并启动测试</h4><p>最后新建一个启动类，并运行该启动类，如果启动过程未出现错误，则项目创建成功。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package cn.<span class="property">itcast</span>.<span class="property">star</span>.<span class="property">graph</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">SpringApplication</span>;</span><br><span class="line"><span class="keyword">import</span> org.<span class="property">springframework</span>.<span class="property">boot</span>.<span class="property">autoconfigure</span>.<span class="property">SpringBootApplication</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StarGraphApp</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="title function_">main</span>(<span class="params"><span class="title class_">String</span>[] args</span>) &#123;</span><br><span class="line">        <span class="title class_">SpringApplication</span>.<span class="title function_">run</span>(<span class="title class_">StarGraphApp</span>.<span class="property">class</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-Retrofit客户端">2.Retrofit客户端</h3><p>创建好项目之后，接下来我们就要通过程序去访问Comfyui的接口，那么通过之前我们的学习，要在程序中去访问接口，势必要用到Http客户端（完全使用Java代码来实现了Http或者Https协议的三方库），而在Java开源领域有三大Http客户端可供我们选用：</p><ul><li>OkHttp——Square公司——性能最好</li><li>HttpUrlConnection——JDK——性能最差</li><li>HttpClient——Apache</li></ul><p>而在企业开发中，开发者不会直接使用这些Http客户端，而是选用这些客户端的封装框架，目前比较好用的封装框架有：</p><ul><li>Retrofit——封装OkHttp</li><li>Huttol——封装HttpUrlConnection</li><li>RestTemplate封装了三个客户端</li></ul><p>虽然上述3个框架都大大的封装和简化了Http客户端的使用API，但是在此还是要重点介绍一下Retrofit。</p><h4 id="Retrofit介绍">Retrofit介绍</h4><p>官网：<a href="https://square.github.io/retrofit/">https://square.github.io/retrofit/</a></p><p>Retrofit基于OkHttp开发的、类型安全的Android或Java Http框架。再此我们选用Retrofit框架的重点理由是它基于OkHttp封装，性能好，同时它融入了流行的声明式（PS:只需要定义，不需要实现）开发思想，便于我们开发和学习。</p><h4 id="Retrofit入门">Retrofit入门</h4><p>在Retrofit中要实现一个Http请求总体来说共有以下2个步骤：</p><ul><li>1、声明API</li><li>2、生效API</li></ul><h5 id="声明API">声明API</h5><p>我们可以先创建一个接口类:cn.itcast.star.graph.comfyui.client.api.ComfyuiApi，并按如下代码进行编写：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.star.graph.comfyui.client.api;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> retrofit2.Call;</span><br><span class="line"><span class="keyword">import</span> retrofit2.http.GET;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ComfyuiApi</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取系统信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GET(&quot;/system_stats&quot;)</span></span><br><span class="line">    Call&lt;HashMap&gt; <span class="title function_">getSystemStats</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用Retrofit来声明API，其实就是声明接口方法，比如上述类中定义了一个方法getSystemStats：</p><ul><li><p>方法名可以任意取，但建议与http接口名称一致</p></li><li><p>方法通过@GET注解声明当前请求方式是GET并且请求的地址为/system_stats，即获取Comfyui的系统信息接口</p></li><li><p>方法返回结果为Call</p><p>对象</p><ul><li>Call是固定的返回对象</li><li>HashMap则是接口返回的数据自动转成Map集合存储</li></ul></li></ul><h5 id="生效API">生效API</h5><p>上面声明类要生效，我们还需要配置生效，可创建一个配置类：cn.itcast.star.graph.comfyui.client.config.ComfyuiConfig</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.star.graph.comfyui.client.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.itcast.star.graph.comfyui.client.api.ComfyuiApi;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> retrofit2.Retrofit;</span><br><span class="line"><span class="keyword">import</span> retrofit2.converter.jackson.JacksonConverterFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ComfyuiConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ComfyuiApi <span class="title function_">comfyuiApi</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//设置请求的地址</span></span><br><span class="line">        <span class="type">Retrofit</span> <span class="variable">retrofit</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Retrofit</span>.Builder()</span><br><span class="line">         .baseUrl(<span class="string">&quot;http://192.168.100.129:8188&quot;</span>)</span><br><span class="line">         .addConverterFactory(JacksonConverterFactory.create())<span class="comment">//告诉Retrofit框架使用Jackson</span></span><br><span class="line">         .build();</span><br><span class="line">        <span class="type">ComfyuiApi</span> <span class="variable">comfyuiApi</span> <span class="operator">=</span> retrofit.create(ComfyuiApi.class);</span><br><span class="line">        <span class="keyword">return</span> comfyuiApi;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在类中：</p><ul><li>首先通过Retrofit.Builder构建一个Retrofit客户端<ul><li>通过baseUrl指定请求的服务器地址</li><li>通过addConverterFactory指定请求数据的转换器</li></ul></li><li>最后调用 retrofit.create方法创建ComfyuiApi接口的实现</li></ul><p>通过上述代码，在Spring IOC中就是声明好了一个可以远程调用获取Comfyui服务器状态的Bean.</p><h5 id="测试API">测试API</h5><p>在测试包下创建类：cn.itcast.star.graph.ComfyuiApiTest</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.star.graph;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.itcast.star.graph.comfyui.client.api.ComfyuiApi;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ComfyuiApiTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   ComfyuiApi comfyuiApi;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       System.out.println(comfyuiApi.getSystemStats().execute().body());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在类中，直接注入ComfyuiApi，并调用getSystemStats()，即可发起请求并打印出结果：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240817165626054-1024x236.png" alt="img"></p><h5 id="开启日志">开启日志</h5><p>Retrofit还提供了打印日志的功能，方便我们进行BUG的排错。Retrofit日志功能默认是关闭的，可以通过以下代码进行开启：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> ComfyuiApi <span class="title function_">comfyuiApi</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">HttpLoggingInterceptor</span> <span class="variable">loggingInterceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpLoggingInterceptor</span>();</span><br><span class="line">    loggingInterceptor.setLevel(HttpLoggingInterceptor.Level.BODY);</span><br><span class="line"></span><br><span class="line">    <span class="type">OkHttpClient</span> <span class="variable">okHttpClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>.Builder()</span><br><span class="line">        .addInterceptor(loggingInterceptor)</span><br><span class="line">        .retryOnConnectionFailure(<span class="literal">true</span>)</span><br><span class="line">        .connectTimeout(<span class="number">30</span>, TimeUnit.SECONDS)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">    <span class="type">Retrofit</span> <span class="variable">retrofit</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Retrofit</span>.Builder()</span><br><span class="line">        .baseUrl(<span class="string">&quot;http://192.168.100.129:8188&quot;</span>)</span><br><span class="line">        .client(okHttpClient)</span><br><span class="line">        .addConverterFactory(JacksonConverterFactory.create())</span><br><span class="line">        .build();</span><br><span class="line">    <span class="type">ComfyuiApi</span> <span class="variable">comfyuiApi</span> <span class="operator">=</span> retrofit.create(ComfyuiApi.class);</span><br><span class="line">    <span class="keyword">return</span> comfyuiApi;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们之前提供过Retrofit框架底层是通过OkHttp实现，Retrofit的日志功能也是交由底层OkHttp实现：</p><ul><li>由于要重新设置OkHttp，因此代码中自行构建了OkHttpClient</li><li>给OkHttpClient增加了日志拦截器HttpLoggingInterceptor，并设置拦截器的日志级别为BODY<ul><li>NONE：不输出</li><li>BASIC：输出基本摘要</li><li>HEADERS：输出头信息</li><li>BODY：输出body数据</li></ul></li><li>最后第14行通过client方法，重新设定Retrofit底层使用的OkHttp客户端</li></ul><p>按上述代码进行修改后，重新运行ComfyuiApiTest类，即可在控制台看见相关的日志输出：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240817172756855-1024x330.png" alt="img"></p><h3 id="3-导入Comfyui封装的代码">3.导入Comfyui封装的代码</h3><p>通过Retrofit入门学习，可以看出使用Retrofit来定义一个API接口非常简单；那么对于Comfyui的其它接口，同学们也可以自行定义实现，或者直接导入资料文件下《Comfyui—API封装代码》文件夹下的代码，直接复制到cn.itcast.star.graph.comfyui.client包下，复制后的项目目录结构为：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240817174610834.png" alt="img"></p><p>然后我们打开Comfyui的代码，查看已经定义好的：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">package</span> <span class="selector-tag">cn</span><span class="selector-class">.itcast</span><span class="selector-class">.star</span><span class="selector-class">.graph</span><span class="selector-class">.comfyui</span><span class="selector-class">.client</span><span class="selector-class">.api</span>;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">cn</span><span class="selector-class">.itcast</span><span class="selector-class">.star</span><span class="selector-class">.graph</span><span class="selector-class">.comfyui</span><span class="selector-class">.client</span><span class="selector-class">.pojo</span><span class="selector-class">.DeleteQueueBody</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">cn</span><span class="selector-class">.itcast</span><span class="selector-class">.star</span><span class="selector-class">.graph</span><span class="selector-class">.comfyui</span><span class="selector-class">.client</span><span class="selector-class">.pojo</span><span class="selector-class">.QueueTask</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">cn</span><span class="selector-class">.itcast</span><span class="selector-class">.star</span><span class="selector-class">.graph</span><span class="selector-class">.comfyui</span><span class="selector-class">.client</span><span class="selector-class">.pojo</span><span class="selector-class">.QueueTaskCount</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">okhttp3</span><span class="selector-class">.MultipartBody</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">okhttp3</span><span class="selector-class">.RequestBody</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">okhttp3</span><span class="selector-class">.ResponseBody</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">retrofit2</span><span class="selector-class">.Call</span>;</span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">retrofit2</span><span class="selector-class">.http</span>.*;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">import</span> <span class="selector-tag">java</span><span class="selector-class">.util</span><span class="selector-class">.HashMap</span>;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">interface</span> <span class="selector-tag">ComfyuiApi</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取历史任务</span></span><br><span class="line"><span class="comment">     * @param maxItems  获取的条数</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="variable">@GET</span>(<span class="string">&quot;/history&quot;</span>)</span><br><span class="line">    Call&lt;HashMap&gt; <span class="built_in">getHistoryTasks</span>(<span class="variable">@Query</span>(<span class="string">&quot;max_items&quot;</span>) int maxItems);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取预览的图片信息</span></span><br><span class="line"><span class="comment">     * @param filename  文件名</span></span><br><span class="line"><span class="comment">     * @param type      文件类型，input/output</span></span><br><span class="line"><span class="comment">     * @param subfolder 字文件夹名</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="variable">@GET</span>(<span class="string">&quot;/view&quot;</span>)</span><br><span class="line">    Call&lt;ResponseBody&gt; <span class="built_in">getView</span>(<span class="variable">@Query</span>(<span class="string">&quot;filename&quot;</span>) String filename, <span class="variable">@Query</span>(<span class="string">&quot;type&quot;</span>) String type, <span class="variable">@Query</span>(<span class="string">&quot;subfolder&quot;</span>) String subfolder);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取系统信息</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="variable">@GET</span>(<span class="string">&quot;/system_stats&quot;</span>)</span><br><span class="line">    Call&lt;HashMap&gt; <span class="built_in">getSystemStats</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取某个节点配置</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="variable">@GET</span>(<span class="string">&quot;/object_info/&#123;nodeName&#125;&quot;</span>)</span><br><span class="line">    Call&lt;HashMap&gt; <span class="built_in">getNodeInfo</span>(<span class="variable">@Path</span>(<span class="string">&quot;nodeName&quot;</span>) String nodeName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 取消当前的任务</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="variable">@GET</span>(<span class="string">&quot;/interrupt&quot;</span>)</span><br><span class="line">    Call&lt;HashMap&gt; <span class="built_in">interruptTask</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取队列中的任务信息</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="variable">@GET</span>(<span class="string">&quot;/queue&quot;</span>)</span><br><span class="line">    Call&lt;HashMap&gt; <span class="built_in">getQueueTasks</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取队列中的任务信息</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="variable">@POST</span>(<span class="string">&quot;/queue&quot;</span>)</span><br><span class="line">    Call&lt;HashMap&gt; <span class="built_in">deleteQueueTasks</span>(<span class="variable">@Body</span> DeleteQueueBody body);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取队列中任务数量</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="variable">@GET</span>(<span class="string">&quot;/prompt&quot;</span>)</span><br><span class="line">    Call&lt;QueueTaskCount&gt; <span class="built_in">getQueueTaskCount</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加流程任务</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="variable">@POST</span>(<span class="string">&quot;/prompt&quot;</span>)</span><br><span class="line">    Call&lt;HashMap&gt; <span class="built_in">addQueueTask</span>(<span class="variable">@Body</span> ComfyuiRequestDto body);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 上传图片</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="variable">@Multipart</span></span><br><span class="line">    <span class="variable">@POST</span>(<span class="string">&quot;/upload/image&quot;</span>)</span><br><span class="line">    Call&lt;HashMap&gt; <span class="built_in">uploadImage</span>(<span class="variable">@Part</span> MultipartBody.Part image);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 上传图片</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="variable">@Multipart</span></span><br><span class="line">    <span class="variable">@POST</span>(<span class="string">&quot;/upload/mask&quot;</span>)</span><br><span class="line">    Call&lt;HashMap&gt; <span class="built_in">uploadMask</span>(<span class="variable">@Part</span> MultipartBody.Part image,<span class="variable">@Part</span>(<span class="string">&quot;type&quot;</span>) RequestBody type,<span class="variable">@Part</span>(<span class="string">&quot;subfolder&quot;</span>) RequestBody subfolder,<span class="variable">@Part</span>(<span class="string">&quot;original_ref&quot;</span>) RequestBody originalRef);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取某个历史任务</span></span><br><span class="line"><span class="comment">     * @param promptId  任务ID</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="variable">@GET</span>(<span class="string">&quot;/history/&#123;promptId&#125;&quot;</span>)</span><br><span class="line">    Call&lt;HashMap&gt; <span class="built_in">getHistoryTask</span>(<span class="variable">@Path</span>(<span class="string">&quot;promptId&quot;</span>) String promptId);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在代码中声明了Comfyui的全部API，且声明时还使用到一些新注解，可解释为：</p><ul><li>@Query：用来声明http查询部分的参数，与@RequestParam类似</li><li>@Body：用于声明请求体对象，与@RequestBody类似</li><li>@Multipart：用于说明当前请求以表单形式发起，常常用于带有文件的接口<ul><li>如果是文件字段需要使用 MultipartBody.Part</li><li>如果是非文件字段需要使用 RequestBody</li></ul></li><li>@Part：用于说明一个表单字段</li><li>@Path：用于说明请求路径参数，与@PathVariable类似</li></ul><h2 id="4-封装Comfyui的事件客户端">4.封装Comfyui的事件客户端</h2><p>Comfyui除了提供API接口之外，还提供了Webcoket服务，通过Webcoket可以接受Comfyui在生图过程中的系列事件，而这些事件常常是业务开发过程中需要用到的，比如图片生产进度事件，应用后端需要监听Comfyui获取进度消息，然后再把消息推送给应用前端，这样应用前端即可同步显示进度。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240818110431105-1024x576.png" alt="img"></p><p>在上图中，应用后端即是WS客户端也是服务端：</p><ul><li>应用后端是WebSocket的客户端，用于接受Comfyui广播的消息</li><li>应用后端也是WebSocket的服务端，用于给应用前端推送消息</li></ul><p><strong>在这里我们先关注应用后端作为Comfyui客户端的情况，如果监听和接收Comfyui的消息。而要实现这一功能，我们可以参考以下步骤进行实现：</strong></p><ul><li>继承实现TextWebSocketHandler类，当收到消息时，调用该类。</li><li>提供一个WebSocketConnectionManager连接管理器，并启动。</li></ul><h3 id="1-实现消息处理类">1.实现消息处理类</h3><p>创建类cn.itcast.star.graph.comfyui.client.handler.ComfyuiMessageHandler，并参考以下代码进行实现：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.itcast.star.graph.comfyui.client.handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.<span class="type">TextMessage</span>;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.<span class="type">WebSocketSession</span>;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.handler.<span class="type">TextWebSocketHandler</span>;</span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ComfyuiMessageHandler</span> <span class="keyword">extends</span> <span class="title">TextWebSocketHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public void afterConnectionEstablished(<span class="type">WebSocketSession</span> session) <span class="keyword">throws</span> <span class="type">Exception</span> &#123;</span><br><span class="line">        <span class="type">System</span>.out.println(<span class="string">&quot;=============连接成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void handleTextMessage(<span class="type">WebSocketSession</span> session, <span class="type">TextMessage</span> message) <span class="keyword">throws</span> <span class="type">Exception</span> &#123;</span><br><span class="line">        <span class="type">System</span>.out.println(<span class="string">&quot;=============收到消息:&quot;</span>+message.getPayload());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码说明：</p><ul><li>TextWebSocketHandler类是Spring提供的一个文本消息处理类，它实现了WebSocketHandler接口</li><li>当连接成功服务器之后会调用afterConnectionEstablished方法</li><li>当接收到服务器推送的消息之后，会调用handleTextMessage方法</li></ul><h3 id="2-实现连接管理器">2.实现连接管理器</h3><p>连接管理器是一个Bean，我们可以直接在cn.itcast.star.graph.comfyui.client.config.ComfyuiConfig配置类中进行补充：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> ComfyuiMessageHandler <span class="title function_">comfyuiMessageHandler</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ComfyuiMessageHandler</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> WebSocketConnectionManager <span class="title function_">webSocketConnectionManager</span><span class="params">(ComfyuiMessageHandler comfyuiMessageHandler)</span> &#123;</span><br><span class="line">    <span class="type">WebSocketClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StandardWebSocketClient</span>();</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;ws://192.168.100.129:8188/ws?clientId=star-graph&quot;</span>;</span><br><span class="line">    <span class="type">WebSocketConnectionManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebSocketConnectionManager</span>(client,comfyuiMessageHandler,url);</span><br><span class="line">    manager.start();</span><br><span class="line">    <span class="keyword">return</span> manager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码说明：</p><ul><li>首先把消息处理ComfyuiMessageHandler类注册成Bean</li><li>接着注册连接管理器Bean<ul><li>由于第10行要用到WebSocketClient、url，因此第8、9行先进行了定义</li><li>第10行直接通过new构造一个连接管理器</li><li>第11行通过start方法立即提供连接管理器（即立即去连接Url地址指定的服务器）</li></ul></li></ul><h4 id="测试事件客户端">测试事件客户端</h4><p>上述两步代码实现完整之后，则我们的应该后端就能去监听和接收Comfyui的消息了，我们直接启动服务，然后在控制台能看见打印的如下信息，则成功。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240818115228076.png" alt="img"></p><h4 id="Comfyui推送消息内容及格式">Comfyui推送消息内容及格式</h4><p>Comfyui通过websocket推送的消息类型及格式如下，再次可以先了解一些，便于后续我们查询和使用。</p><p>status:队列状态变更消息</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;status&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;exec_info&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;queue_remaining&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>progress：生图处理步骤</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;progress&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span> <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="number">20</span><span class="punctuation">,</span> <span class="attr">&quot;prompt_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;594ac476-e599-47c1-a99f-bf8a384cfcdb&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;node&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>executing：某个节点开始执行</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;executing&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;node&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>executed：生图结果</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;executed&quot;</span>, <span class="string">&quot;data&quot;</span>: &#123;<span class="string">&quot;node&quot;</span>: <span class="string">&quot;9&quot;</span>, <span class="string">&quot;output&quot;</span>: &#123;<span class="string">&quot;images&quot;</span>: [&#123;<span class="string">&quot;filename&quot;</span>: <span class="string">&quot;ComfyUI_00239_.png&quot;</span>, <span class="string">&quot;subfolder&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;output&quot;</span>&#125;, &#123;<span class="string">&quot;filename&quot;</span>: <span class="string">&quot;ComfyUI_00240_.png&quot;</span>, <span class="string">&quot;subfolder&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;output&quot;</span>&#125;]&#125;, <span class="string">&quot;prompt_id&quot;</span>: <span class="string">&quot;c4fba48d-1605-4e94-aabd-a37211204c2f&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p>execution_start：任务开始执行事件</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">xxxxxxxxxx</span> &#123;<span class="string">&quot;type&quot;</span><span class="operator">:</span> <span class="string">&quot;execution_start&quot;</span>, <span class="string">&quot;data&quot;</span><span class="operator">:</span> &#123;<span class="string">&quot;prompt_id&quot;</span><span class="operator">:</span> <span class="string">&quot;c25e865d-2307-4482-ac2d-fef2c2993688&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p>execution_error：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;execution_error&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;node_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;node_type&quot;</span><span class="punctuation">:</span><span class="string">&quot;&quot;</span><span class="punctuation">,</span><span class="attr">&quot;exception_message&quot;</span><span class="punctuation">:</span><span class="string">&quot;异常信息&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>execution_success：执行成功消息</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;execution_success&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;prompt_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;594ac476-e599-47c1-a99f-bf8a384cfcdb&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="number">1723966039722</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="总结">总结</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-111-1024x755.png" alt="img"></p><h2 id="Comfyui完结">Comfyui完结</h2>]]></content>
    
    
    <summary type="html">AIGC之Comfyui</summary>
    
    
    
    <category term="AI" scheme="https://itgeqian.github.io/categories/AI/"/>
    
    
    <category term="AIGC 绘图" scheme="https://itgeqian.github.io/tags/AIGC-%E7%BB%98%E5%9B%BE/"/>
    
    <category term="Comfyui" scheme="https://itgeqian.github.io/tags/Comfyui/"/>
    
  </entry>
  
  <entry>
    <title>AIGC 绘图的前置知识（Stable Diffusion）</title>
    <link href="https://itgeqian.github.io/posts/52.html"/>
    <id>https://itgeqian.github.io/posts/52.html</id>
    <published>2025-09-05T03:19:03.000Z</published>
    <updated>2025-09-04T22:03:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-前沿">1.<strong>前沿</strong></h2><p>随着AI技术的迅猛崛起，AIGC（Artificial Intelligence Generated Content，人工智能生成内容）已成为推动内容创作领域变革的强大动力，它能够智能生成涵盖文本、图像、音频、视频在内的多样化内容，深刻影响着众多行业的变革。比如：</p><ol><li><strong>媒体与广告</strong>：在媒体领域，AIGC可以自动化地生成新闻报道、广告文案、社交媒体内容等，提高内容生成的效率和品质。在广告领域，AIGC可以根据不同的受众和广告策略，自动化地生成各种形式的广告内容，从而更好地吸引目标受众的注意力。</li><li><strong>设计与艺术</strong>：AIGC技术在图像和艺术作品的生成方面也展现出巨大潜力。通过深度学习算法，AIGC能够根据用户输入的关键词和样式指南，自动生成具有艺术美感的图像和创意作品。这种自动化生成技术不仅提高了设计师和艺术家的生产力，还为他们带来了更多的创作灵感。</li><li><strong>娱乐产业</strong>：在娱乐领域，AIGC可以自动化地生成电影、游戏、音乐等作品的故事情节、角色设定、画面等，极大地缩短了创作周期和成本。例如，在游戏开发中，AIGC可以辅助设计师快速生成游戏场景、角色模型等，提高游戏开发效率。</li><li><strong>教育领域</strong>：在教育领域，AIGC可以自动化地生成各种教学资料、试题等，帮助教师更好地备课和评估学生。此外，AIGC还可以为学生提供个性化的学习内容和推荐，提升学习效果。</li><li><strong>金融与保险</strong>：在金融和保险领域，AIGC可以应用于风险评估、欺诈检测、投资决策等方面。通过分析大量数据，AIGC能够提供更准确的风险评估和投资建议，帮助金融机构更好地管理风险和提高业务效率。</li><li><strong>医疗保健</strong>：在医疗保健领域，AIGC可以用于疾病预测、诊断、治疗和药物研发等方面。通过训练已知的临床数据，AIGC可以预测疾病的发生和进展情况，为医生提供辅助诊断方案。同时，AIGC还可以帮助制药公司更快、更便宜、更准确地开发新药物。</li><li><strong>自动驾驶</strong>：在自动驾驶领域，AIGC技术也发挥着重要作用。它可以帮助自动驾驶汽车和无人机等设备更准确地感知周围环境、做出更好的决策和行动。</li><li><strong>其他领域</strong>：此外，AIGC还可以应用于电商、社交等多个领域。在电商领域，AIGC可以用于制定精准的产品推荐策略、基于大数据深度学习的广告推荐等；在社交领域，AIGC可以用于聊天机器人、语音识别、内容审核等方面。</li></ol><p><strong>因此，掌握AIGC文生图开发技术，不仅是适应时代发展趋势的必然选择，更是提升自身竞争力、实现职业发展的关键一步。通过本章的学习，学员将能够站在技术前沿，引领未来内容创作的潮流，为企业与社会创造更大的价值。</strong></p><h2 id="2-Stable-Diffusion入门">2.<strong>Stable Diffusion入门</strong></h2><h3 id="1-Diffusion-Model-扩展模型">1.Diffusion Model 扩展模型</h3><p>回顾在第一天学习过程中，我们了解到，当下市场常见的大模型分类有：</p><ul><li>大语言模型：用于文生文，典型的使用场景是：对话聊天—仅文字对话Qwen、ChatGLM3、Baichuan、Mistral、LLaMA3、YI、InternLM2、DeepSeek、Gemma、Grok 等等</li><li>文本嵌入模型：用于内容的向量化，典型的使用场景是：模型微调text2vec、openai-text embedding、m3e、bge、nomic-embed-text、snowflake-arctic-embed</li><li>重排模型：用于向量化数据的优化增强，典型的使用场景是：模型微调bce-reranker-base_v1、bge-reranker-large、bge-reranker-v2-gemma、bge-reranker-v2-m3</li><li>多模态模型：用于上传文本或图片等信息，然后生成文本或图片，典型的使用场景是：对话聊天—拍照批改作业Qwen-VL 、Qwen-Audio、YI-VL、DeepSeek-VL、Llava、MiniCPM-V、InternVL</li><li>语音识别语音播报：用于文生音频、音频转文字等，典型的使用场景是：语音合成Whisper 、VoiceCraft、StyleTTS 2 、Parler-TTS、XTTS、Genny</li><li>扩散模型：用于文生图、文生视频，典型的使用场景是：文生图AnimateDiff、StabilityAI系列扩散模型</li></ul><p>而接下来我们将学习如果利用大模型进行图片的创作，这就要用到<strong>扩散模型</strong>的相关知识，因此先来看看什么是扩散模型。</p><p>谈及扩散模型，需要先理解扩散这一核心概念，<strong>扩散这个词源自物理学中的现象，指物质由高浓度区域向低浓度区域移动的过程，是一个自然趋向于平衡状态的过程。</strong></p><p>而在人工智能（AI）领域，“扩散”并不指物质在空间中的移动，而是指数据样本点的分布向标准正态分布不断靠拢的过程。这个解释从专业的角度非常难以理解，因此我们在此只需要把<strong>人工智能的扩散理解成是高浓度的马赛克（也称为噪声）向低浓度区域移动的过程</strong>。</p><p><strong>扩散模型（Diffusion Models）就是基于扩散思想的深度学习生成模型，它们在多个领域，尤其是图像生成任务中展现出了强大的能力。</strong></p><p>在前些年，生成式图片领域使用的技术主要是GAN【全称是生成对抗网络（Generative Adversarial Network）】，是一种由Ian Goodfellow等人在2014年提出的机器学习模型。直到 2020 年，提出的 DDPM【去噪扩散概率模型（Denoising Diffusion Probabilistic Model）】模型向世界展示了扩散模型的能力，在图像合成方面击败了 GAN，所以后续很多图像生成领域开始转向 DDPM 领域扩散模型的研究。就当下市面上生成式图模型OpenAI 的 DALL·E 2 和 Google 的 Imagen，都是基于扩散模型来完成的。</p><p><strong>扩散模型也细分文前向扩散和反向扩散，通过模拟一个前向扩散过程将图片数据逐渐转换为噪声，并随后通过一个反向扩散过程将噪声逐渐还原为原始图片数据。</strong></p><p><strong>前向扩散</strong>：图片转为马赛克—用于扩散模型的训练</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-95-1024x334.png" alt="img"></p><p><strong>反向扩散</strong>：马赛克转为图像—用于图像的生成</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-96-1024x332.png" alt="img"></p><h3 id="2-Stable-Diffusion-稳定扩散模型">2.Stable Diffusion 稳定扩散模型</h3><p>Stable Diffusion（全称稳定扩散模型，简称SD）是一种先进的深度学习模型，也是主流的用于高质量图像生成的模型，根据文本描述生成图像（text-to-image）。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-97-1024x544.png" alt="img"></p><p>stable Diffusion的代码和模型也是开源免费使用，可以在大多数配置了至少8GB VRAM的普通GPU的消费级硬件上运行，甚至在CPU上运行，这标志着Stable Diffusion和以往只能通过云服务访问的专有文本到图像模型(如DALL-E和Midjourney)完全不同。</p><p>Stable Diffusion也被称为稳定扩散模型，相比扩散模型的区别主要表现为：</p><ul><li><strong>开源免费</strong></li><li><strong>高质量输出</strong>：通过引入稳定性指数，显著提高了模型的稳定性，使得生成的图像质量更加一致，更符合输入需求；</li><li><strong>高效率输出</strong>：通过优化模型结构和算法，提高了计算效率（可以使用常规显卡运算），能够在较短时间内生成高质量的图像；</li></ul><h3 id="3-Stable-Diffusion-基本结构与原理">3.Stable Diffusion 基本结构与原理</h3><p>虽然Stable Diffusion作为扩散模型的变体模型，但在实现图片生成的思想上依然和扩散模型一致，且通过反向扩散过程的思想来完成图片生成。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-98-1024x332.png" alt="img"></p><p><strong>在Stable Diffusion的核心思想中，首先生成一张噪声图(最左边—马赛克图)，然后按照用户输入的提示词，去除噪声图中的部分信息，就生成一张跟文本信息匹配的图片。整个生图流程如下：</strong></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-99-1024x387.png" alt="img"></p><p>Stable Diffusion首先要解决的问题就是：<strong>如何把提示词转换成能够计算机理解的信息？</strong></p><p>要解决问题的方案我们需要先掌握基本的Stable Diffusion流程，后续再进行该问题的详解。在Stable Diffusion中提供了一个文本编码器（Text Encoder），可以把输入的提示词转化成计算机大模型能理解和识别的数字（专业称为语义向量）。有了这个语义向量，就可以使用图片生成器（Image Generator）生成目标图像，这里生成目标图像就使用到了反向扩散模型的思路，但是注意这里生成的图像并不是最终的图片，而是一个低像素的图片，因此Stable Diffusion最终还需要通过一个图片解码器（Image Decoder）把生成的图片转成我们最终的图片。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-100-1024x513.png" alt="img"></p><p>从上图还不难发现，Stable Diffusion是在潜在空间中（Latent Space，也称潜空间）中生成的，而我们最终需要一张可以看得见图片，我们都知道在计算机中，所见到的图片是有像素组成的，因此称这张图片为像素空间（Pixel Space）的图片。而潜在空间中的图片不能直接在像素空间中使用，因此Stable Diffusion提供了图片解码器（Image Decoder）可以把潜在空间中的图片转为像素空间中的图片。</p><blockquote><p>潜在空间（Latent Space）: 一种比像素空间更小空间，在Stable Diffusion中，潜在空间比像素空间小48倍，这样设计可以减少计算机算力，并提高生成速度。</p></blockquote><p>综上所述，Stable Diffusion由3部分组成：</p><ul><li>输入编码器（Input Encoder）：把用户输入的内容转换提示词为语义向量（很长的一串数字）；</li><li>图片生成器（Image Generator）：结合语义向量，生成潜在空间图片；</li><li>图片解码器（Image Decoder）：转换潜在空间的图片为像素空间中的图片；</li></ul><h3 id="4-Stable-Diffusion-深度原理">4.Stable Diffusion 深度原理</h3><p>在SD相关软件或开发过程中，需要经常用到涉及底层的基本概念，因此我们还需要进一步对其底层进行分析和了解，便于后面的学习。</p><p>在这里我们进一步放大SD内部结构，可以发现更多的内容细节暴露出来，其中包括：</p><ul><li>①、SD模型只支持英文输入，因此用户输入的中文，需要先转出英文；（后续解释为什么只能是英文？）</li><li>②、输入编码器（Input Encoder）在内部时通过一个叫ClipText的组件把用户输入的文本内容转成语义向量的；</li><li>③、图片生成器（Image Generator）在内部时通过UNet+Scheduler来进行图片生成的，同时生成的过程是反向扩散的实现过程；<ul><li>④、而在图片生成过程主要依据Denoise这个过程来重复迭代生成图片；</li></ul></li><li>⑤、图片解码器（Image Decoder）在内部会通过VAE解码器把生成的潜空间图片，放大成像素空间的大小需求；</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-101-1024x435.png" alt="img"></p><p>要充分理解上述的5个关键步骤，这里必须先理解什么是Clip、UNet和VAE。</p><h4 id="Clip是什么？">Clip是什么？</h4><blockquote><p>开源地址：<a href="https://github.com/mlfoundations/open_clip">https://github.com/mlfoundations/open_clip</a></p></blockquote><p>CLIP（Contrastive Language–Image Pre-training）对比语言预训练模型，由 OpenAI在2021年 提出，它能够理解并处理图像和文本，通过对它们进行对比学习（contrastive learning）来<strong>建立图像和文本之间的关联</strong>。<strong>简单来说Clip模型能把用户输入的文字需求，正确的理解成生成图片的需求</strong>。</p><p>CLIP的不仅训练数据多，大约有4亿多个（文本和图像），而且训练出的模型执行效率高，高出同类型模型的4到10倍，可以简单理解Clip目前是顶尖的文本与图像关联的模型。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240719114730992-1024x665.png" alt="img"></p><p>Clip架构中主要有两大核心部分组成：</p><ul><li>文本编码器（Text Encoder）：把文本编码成向量；长度不超过77，如果超过会自动截断；</li><li>图片编码器（Image Encoder）：把图片编码成向量；尽量是正方形；</li></ul><p>这两大核心在Clip模型训练的过程中，在3个关键步骤中有被使用到：</p><ul><li>1、对比训练：将一批配对好的图像和**（英文）**文本数据集（最开始数据集大小是32768对），分别通过文本和图片编码器分别生成对应的向量，再通过算法（余弦相似度、对称交叉熵损失等）来计算出文本和图片关联度最大的向量数据。</li><li>2、依据标注文本创建数据集分类器：使用文本编码器对大量图像及相关的**（英文）**文本描述生成向量，以此来训练出一个分类器，使得模型能够依据图像的特征来预测其所属的分类。</li><li>3、使用零样本预测：输入一张没有在训练数据集中的图片，通过图片编辑器转成向量，然后利用第2步的分类器，对向量进行分类处理，通过得到的分类，我们即可知悉图片中的信息是什么。这意味着即使模型在训练过程中没有见过这些新图像，通过使用零样本预测Clip模型也可知悉图片中的内容。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240729103952843-1024x382.png" alt="img"></p><p>通过上述了解的内容，可以了解到Clip的训练过程中使用的文本都是英文的，因此就解释了为什么SD需要把中文转出英文后处理。</p><h4 id="UNet是什么？">UNet是什么？</h4><p><strong>UNet是一种用于图像分割的卷积神经网络架构</strong>。可以把输入的‌图片分割成具有一定语义含义的区域块，识别出每个区域块语义类别，最终得到与原图像等大小具有逐像素语义标注的分割图像。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-102-1024x517.png" alt="img"></p><p>随着UNet的发展，人们很快就发现UNet架构的设计非常巧妙，不仅能用于图片分割，还能用于提升图片的细节和质量。</p><p>UNet的结构主要包括编码器和解码器两部分，提升图片质量主要通过这两部分来完成：</p><ul><li>编码器：主要用来提取出图片中的特征信息，并逐渐降低图像的空间维度，这个过程也称下采样过程。比如一张224x224的图像，首先下采样变为112x112，然后变为56x56，28x28，最后图像大小缩至14x14。每次下采样尺寸的缩小都是为了捕获图像的细节特征，同时减少计算量。</li><li>解码器：主要用把低维度空间的图片还原成原来尺寸，并在过程中融合图片的细节，这个过程也称为上采样过程。上采样和下采样相反，首先通过14x14生成28x28的尺寸，然后再把生成的图片与之前下采样过程中的28x28图片进行融合，接着再用融合的图片生成56x56的图片，再融合，以此类推，直到复原原有尺寸为止。在这个过程中上采样生成的图片与下采样生成的图片融合，被称为跳跃连接（Skip Connection），它能在融合过程<strong>不仅保留了图像的全局信息，也精确地恢复了局部细节</strong>。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240720151405415-1024x576.png" alt="img"></p><p>UNet框架最开始由Olaf Ronneberger等人在2015年提出，‌主要用于解决医学图像分割的问题。但随着AI技术的发展，UNet能提高图片质量的特性很快就被应用于Stable Diffusion框架，用UNet来提升一张质量不高（带有很多噪声）的图片，并重复数十次这个过程，最终得到一张高质量的结果。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240720155857377-1024x444.png" alt="img"></p><p>除此之外<strong>U-Net在Stable Diffusion中的应用还表现在：</strong></p><ul><li><strong>细节的捕捉与增强</strong>：Stable Diffusion利用U-Net的跳跃连接来维持和增强图像的细节。这些连接允许在生成过程中直接使用来自编码器的高分辨率特征，从而在解码器阶段细化图像的细节。</li><li><strong>多尺度特征融合</strong>：通过U-Net的编码器-解码器结构，Stable Diffusion能够融合不同尺度的特征，这对于生成与文本描述相匹配的复杂图像至关重要。这种结构使模型能够在保持全局一致性的同时，精确控制图像的局部细节。</li><li><strong>迭代细化</strong>：Stable Diffusion在图像生成过程中采用迭代细化的策略，每一步都利用U-Net架构对图像进行进一步的优化和细化。这种方式使得最终生成的图像不仅细节丰富，而且与输入的文本描述高度一致。</li></ul><h4 id="VAE是什么？">VAE是什么？</h4><p>AE（auto-encoders）自编码器，是一种数据维度压缩算法，能够把高维度的数据通过AE编码（Encoder）将数据压缩成低维空间，比如把3维空间的数据压缩成2为空间的数据。维度下降之后，数据量更小，进行数据计算更加的高效。计算完成之后还可以通过AE解码（Decoder）将低维度数据提升为高维数据。</p><p>而VAE（Variational AutoEncoder 变分自编码器）和AE类似，但比AE的更加的先进和复杂。在Stable Diffusion中对于输入的图片，会先用VAE编码器（VAE Encoder）把像素空间中的图片，压缩为潜空间数据，比如下图中通过VAE编码器把512x512的图片压缩后变成了64x64的大小，最后再通过VAE解码器（VAE Decoder）把潜空间中的图片返回成像素空间的大小。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240721165502121-1024x244.png" alt="img"></p><p>小知识点：</p><ul><li>在SD中，像素空间中的图片，每个像素点使用RGB3通道（可简单理解成3个数字）来存储其值，因此512x512大小的图片，在SD中存储的大小为512x512x3</li><li>在SD中，潜空间图片，每个像素点使用RGBA4通道（可以简单理解成4个数字）来存储其值，因此64x64大小的图片，在SD潜空间中实际大小为64x64x4</li><li>综合上述两点，通过VAE压缩图片后，计算的数据降低了48（512x512x3/64x64x4=48）倍。</li></ul><h3 id="深度剖析原理">深度剖析原理</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240719111241996.png" alt="img"></p><p>了解完Clip和UNet之后，我们再来理解Stable Diffusion的底层原理：</p><ul><li>①、由于SD的输入编码器（InputEncoder）中使用的是OpenAI的Clip模型来理解用户输入的文本，而Clip模型的底层是使用<strong>英文</strong>进行训练的，所以Clip模型只接收英文文本，即<strong>Stable Diffusion只接收英文输入</strong>。如果我们想输入中文，那么可以先通过翻译软件进行翻译成英文之后，再输入到SD中。</li><li>②、输入编码器（InputEncoder）在接收到用户输入的文本之后，会通过ClipText来理解用户输入的信息，并把理解的信息转换为大小为77 x 768的向量。<ul><li>Clip模型限制了最多可以输入77个token，可以简单理解成77个单词。Clip模型训练时会把大图片切成16x16大小的小图片，然后在提取小图片中的RGB3个颜色通道的数据，并最终把小图片表示成一个16x16x3=768的向量。同时Clip为了让文本Token能更好的与图片信息关联，因此也把token的向量长度设计为768。</li></ul></li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240721150125202.png" alt="img"></p><ul><li><ul><li>综上所述，ClipText会把用户输入的文本为77x768大小的向量。</li><li>Clip除了文本（Text）编码器，还有图像（Image）编码器，因此Stable Diffusion除了用文本来创建图之外，还可以使用图片生图片。</li></ul></li><li>③、图片生成器（Image Generator）在内部会首先会在潜空间中生成一张随机的图片，这个图片用的4x64x64大小的向量表示，然后接下来就使用UNet来提升这张随机图片的质量，而这个提升图片质量的过程可能需要数十步，因此就引入了Scheduler调度器，来循环提高质量的这个过程，直到设定步数执行完成，则得到一张按文本生成好的潜空间图片。</li><li>⑤、通过上述对于VAE的了解，我们应该知悉Stable Diffusion为了降低图像生成的数据量，提升图片生成的效率，而选择在潜空间来生成。那个在这个方式下，生成的图片不满足像素空间的大小要求，因此就借助VAE来进行图片的压缩或放大。</li></ul><h4 id="Denoise去噪流程">Denoise去噪流程</h4><p>通过上述的了解，不难发现Stable Diffusion在图片生成器中最关键步骤就是Denoise去噪，因此接下来再来了解Denoise去噪的内部流程。</p><p>首选在Denoise中有一个核心组件叫Noise Predictor（噪声预测器），Denoise就是通过这个组件来完成降噪的。</p><ul><li><p>①、噪声预测器会依据用户输入的<strong>正向词</strong>和上一步噪声图（A）,预测出在噪声图（A）中不需要的噪声图（B）;</p></li><li><p>此步注意点：</p><ul><li>正向词，就是用户输入的文本信息，描述了图片中应该包含哪些内容</li><li>噪声预测器在预测图片时需要确定噪声强度，这个值是依据依据外部输入的Step(步骤)参数，去噪声计划中获取噪声强度<ul><li>噪声强度：指噪声的数量，越强表示噪声的数量越多。在Stable Diffusion中每次Denoise的噪声强度都不同；</li><li>Step（步骤）：就是表示当前是第几次Denoise的数字，主要的作用是通过步骤去噪声计划中获取对应的噪声强度；</li><li>噪声计划：在生图之前，Stable Diffusion在每次Denoise中设定的噪声强度计划，即为噪声计划，这个计划可以通过不同的算法来设定；</li></ul></li></ul></li><li><p>②、噪声预测器会依据用户输入的</p><p>负向词</p><p>，预测出在结果中不能有的噪声图（C）;此步注意点：</p><ul><li>负向词，也是用户输入的文本信息，描述了图片中不能包含的内容</li></ul></li><li><p>③、噪声预测器会把预测的不需要的噪声图（B）减去预测的不能有的噪声图（C）,得到不需要的差异噪声图（D）;</p></li><li><p>④、噪声预测器接着会把不需要的差异噪声图（D）乘以一个放大系数CFG，以放大差异噪声图的细节。然后再把放大的噪声图与预测不能有的噪声图（C）进行相加，就得到了最终不需要的噪声图（E）;CFG： （Classifier Free Guidance）称为无分类引导法，是一种用来让最终生成图像更符合提示词的方法。</p></li><li><p>⑤、最后使用输入的噪声图（A）减去不需要的噪声图（E），即得到一个更高质量的噪声图（F）;</p></li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240722111404770-1024x535.png" alt="img"></p><p>通过上述了解之后，我们应该能发现Stable Diffusion生图过程复杂，但幸好这个实现过程只需要我们了解即可，我们重点关注这个过程中涉及的相关术语和参数，比如这小节提到的Step步骤和CFG参数，对其掌握，有助于快速去设置参数，生成高质量的图片。</p><ul><li>Step步骤，值越大生成的图片越细节，但是消耗的计算资源越多；</li><li>CFG，当CFG的值增加时，模型会更多地依赖于条件信息（如文本提示），这通常会导致生成的图像更加紧密地匹配给定的文本描述，从而元素更丰富，风格更一致。然而，过高的CFG值也可能导致图像过度依赖于条件信息，从而失去一些自然性和多样性；</li></ul><h2 id="2-Stable-Diffusion-客户端">2.Stable Diffusion 客户端</h2><p>Stable Diffusion主流的客户端有2款，Stable Diffusion WebUI和Comfyui，这两款客户端的功能类似，但是操作方式有所不同。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/screenshot-1024x800.png" alt="img"></p><p><strong>Comfyui</strong></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/comfyui_screenshot-1024x388.png" alt="img"></p><p>这两个客户端都可以在低配置的CPU上运行，但是由于Comfyui的配置方式更加简洁，且配置可以重用等特性，我们直接选择使用Comfyui作为我们学习的客户端。</p>]]></content>
    
    
    <summary type="html">AIGC 绘图的前置知识（Stable Diffusion）</summary>
    
    
    
    <category term="AI" scheme="https://itgeqian.github.io/categories/AI/"/>
    
    
    <category term="AIGC 绘图" scheme="https://itgeqian.github.io/tags/AIGC-%E7%BB%98%E5%9B%BE/"/>
    
  </entry>
  
  <entry>
    <title>CentOS7部署最新的ollama的问题解决</title>
    <link href="https://itgeqian.github.io/posts/51.html"/>
    <id>https://itgeqian.github.io/posts/51.html</id>
    <published>2025-09-04T03:19:03.000Z</published>
    <updated>2025-09-04T07:03:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-解决GLIBC-2-27报错问题">1.解决GLIBC_2.27报错问题</h2><p>在ollama官网上，找到了linux上安装ollama的命令后，复制到自己的虚拟机中，下载完ollama，运行 <code>ollama serve</code>，提示以下报错：</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ollama: /lib64/libm.<span class="keyword">so</span>.6: <span class="keyword">version</span> `GLIBC_2.27&#x27; not found (required <span class="keyword">by</span> ollama)</span><br><span class="line">ollama: /lib64/libstdc++.<span class="keyword">so</span>.6: <span class="keyword">version</span> `GLIBCXX_3.4.25&#x27; not found (required <span class="keyword">by</span> ollama)</span><br><span class="line">ollama: /lib64/libstdc++.<span class="keyword">so</span>.6: <span class="keyword">version</span> `GLIBCXX_3.4.20&#x27; not found (required <span class="keyword">by</span> ollama)</span><br><span class="line">ollama: /lib64/libstdc++.<span class="keyword">so</span>.6: <span class="keyword">version</span> `CXXABI_1.3.9&#x27; not found (required <span class="keyword">by</span> ollama)</span><br><span class="line">ollama: /lib64/libstdc++.<span class="keyword">so</span>.6: <span class="keyword">version</span> `CXXABI_1.3.11&#x27; not found (required <span class="keyword">by</span> ollama)</span><br><span class="line">ollama: /lib64/libstdc++.<span class="keyword">so</span>.6: <span class="keyword">version</span> `GLIBCXX_3.4.21&#x27; not found (required <span class="keyword">by</span> ollama)</span><br><span class="line">ollama: /lib64/libstdc++.<span class="keyword">so</span>.6: <span class="keyword">version</span> `GLIBCXX_3.4.22&#x27; not found (required <span class="keyword">by</span> ollama)</span><br></pre></td></tr></table></figure><p>查看系统内安装的glibc版本 然后再根据分析可得知 需要GLIBC_2.27支持，可是目前系统内却没有那么高的版本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> strings /lib64/libc.so.6 |grep GLIBC_</span><br><span class="line"></span><br><span class="line"><span class="comment">## 我的输出如下：</span></span><br><span class="line">GLIBC 2.10</span><br><span class="line">GLIBC 2.11</span><br><span class="line">GLIBC 2.12</span><br><span class="line">GLIBC 2.13</span><br><span class="line">GLIBC 2.14</span><br><span class="line">GLIBC 2.15</span><br><span class="line">GLIBC 2.16</span><br><span class="line">GLIBC 2.17</span><br><span class="line">GLIBC PRIVATE</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">## 没有需要的 GLIBC 2.27 版本缺失</span></span><br></pre></td></tr></table></figure><h3 id="1-安装-GLIBC-2-28">1.安装 GLIBC_2.28</h3><p>执行以下命令，安装需要的GLIBC版本</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="string">//ftp.gnu.org/gnu/glibc/glibc-2.28.tar.gz</span></span><br><span class="line">注：没有 wget的话，使用  yum install wget 安装</span><br><span class="line"></span><br><span class="line">tar xf glibc-2.28.tar.gz </span><br><span class="line"><span class="keyword">cd</span> glibc-2.28/ &amp;&amp; mkdir build  &amp;&amp; <span class="keyword">cd</span> build</span><br><span class="line"><span class="string">../configure</span> <span class="params">--prefix=/usr</span> <span class="params">--disable-profile</span> <span class="params">--enable-add-ons</span> <span class="params">--with-headers=/usr/include</span> <span class="params">--with-binutils=/usr/bin</span></span><br></pre></td></tr></table></figure><p>运行到第四条命令时，报了这个错误</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">configure: error: </span><br><span class="line"><span class="comment">*** These critical programs are missing or too old: compiler</span></span><br><span class="line"><span class="comment">*** Check the INSTALL file for required versions.</span></span><br></pre></td></tr></table></figure><h3 id="2-升级-gcc-和-make">2.升级 <code>gcc</code> 和 <code>make</code></h3><p>上面的报错是 gcc 和 make版本低导致的，升级以下</p><p>gcc升级</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 升级GCC</span></span><br><span class="line">yum install -y centos-release-scl</span><br><span class="line">yum install -y devtoolset-8-gcc*</span><br><span class="line"><span class="built_in">mv</span> /usr/bin/gcc /usr/bin/gcc-4.8.5</span><br><span class="line"><span class="built_in">ln</span> -s /opt/rh/devtoolset-8/root/bin/gcc /usr/bin/gcc</span><br><span class="line"><span class="built_in">mv</span> /usr/bin/g++ /usr/bin/g++-4.8.5</span><br><span class="line"><span class="built_in">ln</span> -s /opt/rh/devtoolset-8/root/bin/g++ /usr/bin/g++</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级 make(默认为3 升级为4)</span></span><br><span class="line">wget http://ftp.gnu.org/gnu/make/make-4.3.tar.gz</span><br><span class="line">tar -xzvf make-4.3.tar.gz &amp;&amp; <span class="built_in">cd</span> make-4.3/</span><br><span class="line">./configure  --prefix=/usr/local/make</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"><span class="built_in">cd</span> /usr/bin/ &amp;&amp; <span class="built_in">mv</span> make make.bak</span><br><span class="line"><span class="built_in">ln</span> -sv /usr/local/make/bin/make /usr/bin/make</span><br></pre></td></tr></table></figure><h3 id="3-解决-yum-install-y-devtoolset-8-gcc-报错">3.解决 <code>yum install -y devtoolset-8-gcc*</code> 报错</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份原始的源文件</span></span><br><span class="line"><span class="built_in">cd</span> /etc/yum.repos.d/</span><br><span class="line"><span class="built_in">mv</span> CentOS<span class="literal">-Base</span>.repo CentOS<span class="literal">-Base</span>.repo.blk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载阿里云的源文件</span></span><br><span class="line"><span class="built_in">wget</span> <span class="literal">-O</span> CentOS<span class="literal">-Base</span>.repo http://mirrors.aliyun.com/repo/Centos<span class="literal">-7</span>.repo</span><br><span class="line">注：如果没有<span class="built_in">wget</span>命令，请先下载<span class="built_in">wget</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理缓存</span></span><br><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure><h3 id="4-解决yum-makecache-报错">4.解决<code>yum makecache</code> 报错</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-51.png" alt="img"></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份以下两个文件</span></span><br><span class="line">cd /etc/yum.repos.d/</span><br><span class="line">cp CentOS-SCLo-scl.repo CentOS-SCLo-scl.repo.blk</span><br><span class="line">cp CentOS-SCLo-scl-rh.repo CentOS-SCLo-scl-rh.repo.blk</span><br><span class="line">vim CentOS-SCLo-scl.repo </span><br><span class="line">将此文件内容全部替换为以下内容：</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS-SCLo-sclo.repo</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please see http://wiki.centos.org/SpecialInterestGroup/SCLo for more</span></span><br><span class="line"><span class="comment"># information</span></span><br><span class="line"> </span><br><span class="line">[centos-sclo-sclo]</span><br><span class="line"><span class="attribute">name</span>=CentOS-7 - SCLo sclo</span><br><span class="line"><span class="attribute">baseurl</span>=https://mirrors.aliyun.com/centos/7/sclo/x86_64/sclo/</span><br><span class="line"><span class="attribute">gpgcheck</span>=0</span><br><span class="line"><span class="attribute">enabled</span>=1</span><br><span class="line"><span class="attribute">gpgkey</span>=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo</span><br><span class="line"> </span><br><span class="line">[centos-sclo-sclo-testing]</span><br><span class="line"><span class="attribute">name</span>=CentOS-7 - SCLo sclo Testing</span><br><span class="line"><span class="attribute">baseurl</span>=http://buildlogs.centos.org/centos/7/sclo/$basearch/sclo/</span><br><span class="line"><span class="attribute">gpgcheck</span>=0</span><br><span class="line"><span class="attribute">enabled</span>=0</span><br><span class="line"><span class="attribute">gpgkey</span>=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo</span><br><span class="line"> </span><br><span class="line">[centos-sclo-sclo-source]</span><br><span class="line"><span class="attribute">name</span>=CentOS-7 - SCLo sclo Sources</span><br><span class="line"><span class="attribute">baseurl</span>=http://vault.centos.org/centos/7/sclo/Source/sclo/</span><br><span class="line"><span class="attribute">gpgcheck</span>=1</span><br><span class="line"><span class="attribute">enabled</span>=0</span><br><span class="line"><span class="attribute">gpgkey</span>=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo</span><br><span class="line"> </span><br><span class="line">[centos-sclo-sclo-debuginfo]</span><br><span class="line"><span class="attribute">name</span>=CentOS-7 - SCLo sclo Debuginfo</span><br><span class="line"><span class="attribute">baseurl</span>=http://debuginfo.centos.org/centos/7/sclo/$basearch/</span><br><span class="line"><span class="attribute">gpgcheck</span>=1</span><br><span class="line"><span class="attribute">enabled</span>=0</span><br><span class="line"><span class="attribute">gpgkey</span>=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo</span><br><span class="line">vim CentOS-SCLo-scl-rh.repo</span><br><span class="line">将此文件内容全部替换为以下内容：</span><br><span class="line"></span><br><span class="line"><span class="comment"># CentOS-SCLo-rh.repo</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please see http://wiki.centos.org/SpecialInterestGroup/SCLo for more</span></span><br><span class="line"><span class="comment"># information</span></span><br><span class="line"> </span><br><span class="line">[centos-sclo-rh]</span><br><span class="line"><span class="attribute">name</span>=CentOS-7 - SCLo rh</span><br><span class="line"><span class="attribute">baseurl</span>=https://mirrors.aliyun.com/centos/7/sclo/x86_64/rh/</span><br><span class="line"><span class="attribute">gpgcheck</span>=0</span><br><span class="line"><span class="attribute">enabled</span>=1</span><br><span class="line"><span class="attribute">gpgkey</span>=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo</span><br><span class="line"> </span><br><span class="line">[centos-sclo-rh-testing]</span><br><span class="line"><span class="attribute">name</span>=CentOS-7 - SCLo rh Testing</span><br><span class="line"><span class="attribute">baseurl</span>=http://buildlogs.centos.org/centos/7/sclo/$basearch/rh/</span><br><span class="line"><span class="attribute">gpgcheck</span>=0</span><br><span class="line"><span class="attribute">enabled</span>=0</span><br><span class="line"><span class="attribute">gpgkey</span>=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo</span><br><span class="line"> </span><br><span class="line">[centos-sclo-rh-source]</span><br><span class="line"><span class="attribute">name</span>=CentOS-7 - SCLo rh Sources</span><br><span class="line"><span class="attribute">baseurl</span>=http://vault.centos.org/centos/7/sclo/Source/rh/</span><br><span class="line"><span class="attribute">gpgcheck</span>=1</span><br><span class="line"><span class="attribute">enabled</span>=0</span><br><span class="line"><span class="attribute">gpgkey</span>=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo</span><br><span class="line"> </span><br><span class="line">[centos-sclo-rh-debuginfo]</span><br><span class="line"><span class="attribute">name</span>=CentOS-7 - SCLo rh Debuginfo</span><br><span class="line"><span class="attribute">baseurl</span>=http://debuginfo.centos.org/centos/7/sclo/$basearch/</span><br><span class="line"><span class="attribute">gpgcheck</span>=1</span><br><span class="line"><span class="attribute">enabled</span>=0</span><br><span class="line"><span class="attribute">gpgkey</span>=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo</span><br><span class="line"> </span><br></pre></td></tr></table></figure><h3 id="重新-yum-makecache">重新 <code>yum makecache</code></h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-52-1024x238.png" alt="img"></p><h3 id="5-继续升级-gcc-和-make">5.继续升级 <code>gcc</code> 和 <code>make</code></h3><p>按顺序继续执行序号2中升级make命令，从<code>yum install -y devtoolset-8-gcc*</code> 开始</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-54-1024x244.png" alt="img"></p><p>gcc执行成功！！</p><h3 id="6-继续升级-make">6.继续升级 <code>make</code></h3><p>按顺序执行序号2中的命令，从 <code>wget http://ftp.gnu.org/gnu/make/make-4.3.tar.gz</code> 开始</p><h3 id="7-重新执行以下命令">7.重新执行以下命令</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> <span class="string">/root/glibc-2.27/build</span></span><br><span class="line"><span class="string">../configure</span> <span class="params">--prefix=/usr</span> <span class="params">--disable-profile</span> <span class="params">--enable-add-ons</span> <span class="params">--with-headers=/usr/include</span> <span class="params">--with-binutils=/usr/bin</span></span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-55-1024x268.png" alt="img"></p><p>执行成功！！</p><h3 id="8-继续更新">8.继续更新</h3><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">make</span> &amp;&amp; <span class="built_in">make</span> install</span><br><span class="line">注：过程较长，耐心等待</span><br></pre></td></tr></table></figure><p>完成后再执行</p><p>ollama -v</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ollama</span>: /lib64/libstdc++.so.<span class="number">6</span>: version `GLIBCXX_3.<span class="number">4</span>.<span class="number">25</span>&#x27; not found (required by ollama)</span><br><span class="line"><span class="attribute">ollama</span>: /lib64/libstdc++.so.<span class="number">6</span>: version `GLIBCXX_3.<span class="number">4</span>.<span class="number">20</span>&#x27; not found (required by ollama)</span><br><span class="line"><span class="attribute">ollama</span>: /lib64/libstdc++.so.<span class="number">6</span>: version `CXXABI_1.<span class="number">3</span>.<span class="number">9</span>&#x27; not found (required by ollama)</span><br><span class="line"><span class="attribute">ollama</span>: /lib64/libstdc++.so.<span class="number">6</span>: version `CXXABI_1.<span class="number">3</span>.<span class="number">11</span>&#x27; not found (required by ollama)</span><br><span class="line"><span class="attribute">ollama</span>: /lib64/libstdc++.so.<span class="number">6</span>: version `GLIBCXX_3.<span class="number">4</span>.<span class="number">21</span>&#x27; not found (required by ollama)</span><br><span class="line"><span class="attribute">ollama</span>: /lib64/libstdc++.so.<span class="number">6</span>: version `GLIBCXX_3.<span class="number">4</span>.<span class="number">22</span>&#x27; not found (required by ollama)</span><br></pre></td></tr></table></figure><p>GLIBC_2.27报错解决了</p><h2 id="2-CentOS-7-下-Ollama-启动时报-GLIBCXX-CXXABI-版本不匹配的完整解决方案">2.CentOS 7 下 Ollama 启动时报 <code>GLIBCXX</code> / <code>CXXABI</code> 版本不匹配的完整解决方案</h2><h3 id="1-问题背景"><strong>1. 问题背景</strong></h3><p>在 CentOS 7 上运行 <code>ollama -v</code> 报错：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ollama</span>: /lib64/libstdc++.so.<span class="number">6</span>: version `GLIBCXX_3.<span class="number">4</span>.<span class="number">25</span>&#x27; not found (required by ollama)</span><br><span class="line"><span class="attribute">ollama</span>: /lib64/libstdc++.so.<span class="number">6</span>: version `GLIBCXX_3.<span class="number">4</span>.<span class="number">20</span>&#x27; not found (required by ollama)</span><br><span class="line"><span class="attribute">ollama</span>: /lib64/libstdc++.so.<span class="number">6</span>: version `CXXABI_1.<span class="number">3</span>.<span class="number">9</span>&#x27; not found (required by ollama)</span><br><span class="line"><span class="attribute">ollama</span>: /lib64/libstdc++.so.<span class="number">6</span>: version `CXXABI_1.<span class="number">3</span>.<span class="number">11</span>&#x27; not found (required by ollama)</span><br><span class="line"><span class="attribute">ollama</span>: /lib64/libstdc++.so.<span class="number">6</span>: version `GLIBCXX_3.<span class="number">4</span>.<span class="number">21</span>&#x27; not found (required by ollama)</span><br><span class="line"><span class="attribute">ollama</span>: /lib64/libstdc++.so.<span class="number">6</span>: version `GLIBCXX_3.<span class="number">4</span>.<span class="number">22</span>&#x27; not found (required by ollama)</span><br></pre></td></tr></table></figure><p><strong>原因</strong>： CentOS 7 自带 GCC 4.8.5，对应的 <code>libstdc++.so.6</code> 太老（只支持到 <code>GLIBCXX_3.4.19</code>），而 Ollama 是用 GCC 9+ 编译的，依赖更高版本的 C++ ABI。</p><h3 id="2-解决思路"><strong>2. 解决思路</strong></h3><p>升级系统自带 GCC 风险大（可能导致系统组件不可用），所以我们采用<strong>旁路方案</strong>：</p><ol><li>安装一个独立的新版 <code>libstdc++.so.6</code>（不替换系统的旧版本，避免破坏系统）。</li><li>启动 Ollama 时，通过 <code>LD_LIBRARY_PATH</code> 优先加载新版本的库。</li><li>编写一键启动脚本，后续使用更方便。</li></ol><h3 id="3-具体解决步骤"><strong>3. 具体解决步骤</strong></h3><h4 id="3-1-安装-Miniconda">3.1 安装 Miniconda</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSLo <span class="regexp">/tmp/mi</span>niconda.sh https:<span class="regexp">//</span>repo.anaconda.com<span class="regexp">/miniconda/</span>Miniconda3-latest-Linux-x86_64.sh</span><br><span class="line">bash <span class="regexp">/tmp/mi</span>niconda.sh -b -p <span class="regexp">/opt/mi</span>niconda</span><br></pre></td></tr></table></figure><h4 id="3-2-创建一个只包含新-libstdc-的环境">3.2 创建一个只包含新 <code>libstdc++</code> 的环境</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/opt/mi</span>niconda<span class="regexp">/bin/</span>conda create -y -n libstdcpp -c conda-forge libstdcxx-ng=<span class="number">12</span></span><br></pre></td></tr></table></figure><p>这个环境会生成 <code>/opt/miniconda/envs/libstdcpp/lib/libstdc++.so.6.0.30</code>，支持到：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">strings</span> /opt/miniconda/envs/libstdcpp/lib/libstdc++.so.<span class="number">6</span> | grep GLIBCXX_3.<span class="number">4</span>.<span class="number">25</span></span><br><span class="line"><span class="comment"># 输出:</span></span><br><span class="line"><span class="comment"># GLIBCXX_3.4.25</span></span><br><span class="line"><span class="comment"># CXXABI_1.3.11</span></span><br></pre></td></tr></table></figure><hr><h4 id="3-3-测试-Ollama-是否能用新库运行">3.3 测试 Ollama 是否能用新库运行</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> <span class="attribute">LD_LIBRARY_PATH</span>=/opt/miniconda/envs/libstdcpp/lib:$LD_LIBRARY_PATH</span><br><span class="line">ollama -v</span><br></pre></td></tr></table></figure><p>如果输出版本信息（或只是连接警告），说明库已正确加载。</p><h4 id="3-4-编写一键启动脚本">3.4 编写一键启动脚本</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /usr/local/bin/ollama-start &gt;/dev/null &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#!/usr/bin/env bash</span></span><br><span class="line"><span class="comment"># 使用 Miniconda 提供的新版 libstdc++</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/opt/miniconda/envs/libstdcpp/lib:<span class="variable">$&#123;LD_LIBRARY_PATH&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 ollama 服务是否已运行</span></span><br><span class="line"><span class="keyword">if</span> pgrep -x <span class="string">&quot;ollama&quot;</span> &gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✅ Ollama 服务已在运行&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;🚀 启动 Ollama 服务...&quot;</span></span><br><span class="line">    <span class="built_in">nohup</span> ollama serve &gt; /var/log/ollama.log 2&gt;&amp;1 &amp;</span><br><span class="line">    <span class="built_in">sleep</span> 2</span><br><span class="line">    <span class="keyword">if</span> pgrep -x <span class="string">&quot;ollama&quot;</span> &gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;✅ Ollama 服务启动成功&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;❌ 启动失败，请查看 /var/log/ollama.log&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果传了参数，就直接调用 ollama</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -gt 0 ]; <span class="keyword">then</span></span><br><span class="line">    ollama <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;提示：你可以用 &#x27;ollama-start run &lt;模型&gt;&#x27; 来直接运行模型&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> +x /usr/local/bin/ollama-start</span><br></pre></td></tr></table></figure><h3 id="4-使用方法"><strong>4. 使用方法</strong></h3><h4 id="启动服务">启动服务</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ollama-<span class="literal">start</span></span><br></pre></td></tr></table></figure><h4 id="启动服务并直接运行命令">启动服务并直接运行命令</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ollama-<span class="literal">start</span> -v</span><br><span class="line">ollama-<span class="literal">start</span> list</span><br><span class="line">ollama-<span class="literal">start</span> run llama3.<span class="number">2</span></span><br></pre></td></tr></table></figure><h4 id="查看日志">查看日志</h4><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -f /<span class="keyword">var</span>/<span class="built_in">log</span>/ollama.<span class="built_in">log</span></span><br></pre></td></tr></table></figure><h3 id="5-方案优势"><strong>5. 方案优势</strong></h3><ul><li><strong>无风险</strong>：不替换系统的 <code>libstdc++.so.6</code>，不破坏现有程序。</li><li><strong>可移植</strong>：所有新库都放在 <code>/opt/miniconda/envs/libstdcpp/lib</code>，删除该环境即可回退。</li><li><strong>方便使用</strong>：一键启动脚本简化操作，后续升级 Ollama 或库版本也方便。</li></ul><h3 id="6-总结"><strong>6. 总结</strong></h3><p>通过 Miniconda 独立安装 <code>libstdc++</code> 新版本，并用 <code>LD_LIBRARY_PATH</code> 控制加载顺序，可以在 CentOS 7 这种老系统上无痛运行需要高版本 <code>GLIBCXX</code> 的程序（如 Ollama、某些现代编译的 C++ 应用）。</p><p>这样既保持了系统稳定，又解决了依赖版本问题，非常适合在生产环境或不方便升级操作系统的场景使用。</p><h2 id="3-测试">3.测试</h2><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ollama-start</span></span><br><span class="line">🚀 启动 Ollama 服务...</span><br><span class="line">✅ Ollama 服务启动成功</span><br><span class="line">提示：你可以用 <span class="string">&#x27;ollama-start run &lt;模型&gt;&#x27;</span> 来直接运行模型</span><br><span class="line">[root@localhost ~]<span class="comment"># ollama-start -v</span></span><br><span class="line">✅ Ollama 服务已在运行</span><br><span class="line">ollama version <span class="keyword">is</span> <span class="number">0.11</span><span class="number">.10</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ollama-start list</span></span><br><span class="line">✅ Ollama 服务已在运行</span><br><span class="line">NAME          ID              SIZE      MODIFIED      </span><br><span class="line">qwen2:<span class="number">0.5</span>b    <span class="number">6</span>f48b936a09f    <span class="number">352</span> MB    <span class="number">14</span> months ago    </span><br><span class="line">[root@localhost ~]<span class="comment"># ollama-start run qwen2:0.5b </span></span><br><span class="line">✅ Ollama 服务已在运行</span><br><span class="line">&gt;&gt;&gt; 你好你是谁</span><br><span class="line">我是一个AI模型，没有实体身份。我是由阿里云研发的。如果你有其他问题需要帮助，请随时告诉我！</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; /bye</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">CentOS7部署最新的ollama的问题解决-解决GLIBC_2.27报错问题</summary>
    
    
    
    <category term="AI" scheme="https://itgeqian.github.io/categories/AI/"/>
    
    
    <category term="报错解决" scheme="https://itgeqian.github.io/tags/%E6%8A%A5%E9%94%99%E8%A7%A3%E5%86%B3/"/>
    
  </entry>
  
  <entry>
    <title>力扣sql-top50 系列</title>
    <link href="https://itgeqian.github.io/posts/49.html"/>
    <id>https://itgeqian.github.io/posts/49.html</id>
    <published>2025-09-03T06:19:03.000Z</published>
    <updated>2025-09-25T05:23:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-可回收且低脂的产品（简单）">1.可回收且低脂的产品（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-31.png" alt="img"></p><p>编写解决方案找出既是低脂又是可回收的产品编号。</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> product_id</span><br><span class="line"><span class="keyword">FROM</span> Products</span><br><span class="line"><span class="keyword">WHERE</span> low_fats=<span class="string">&#x27;Y&#x27;</span> <span class="keyword">AND</span> recyclable=<span class="string">&#x27;Y&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="2-寻找用户推荐人（简单）">2.寻找用户推荐人（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-32.png" alt="img"></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="type">name</span> </span><br><span class="line"><span class="keyword">from</span> Customer</span><br><span class="line"><span class="keyword">where</span> referee_id!=<span class="number">2</span> <span class="keyword">or</span> referee_id <span class="keyword">IS</span> <span class="keyword">NULL</span></span><br></pre></td></tr></table></figure><p>注意：</p><p>在 SQL 中，<code>NULL</code> 表示未知值，<strong>不能直接用 <code>=</code> 或 <code>!=</code> 来比较</strong>。<br>正确的写法是：</p><ul><li>判断为空：<code>referee_id IS NULL</code></li><li>判断不为空：<code>referee_id IS NOT NULL</code></li></ul><p>所以 <code>referee_id = null</code> 永远返回 <code>false</code></p><h2 id="3-大的国家（简单）">3.大的国家（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-33.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-34.png" alt="img"></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="type">name</span>,population,area  </span><br><span class="line"><span class="keyword">from</span> World</span><br><span class="line"><span class="keyword">where</span>  area&gt;=<span class="number">3000000</span> <span class="keyword">or</span> population&gt;=<span class="number">25000000</span></span><br></pre></td></tr></table></figure><h2 id="4-文章浏览（简单）">4.文章浏览（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-35-510x1024.png" alt="img"></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> author_id <span class="keyword">as</span> id</span><br><span class="line"><span class="keyword">from</span> Views</span><br><span class="line"><span class="keyword">where</span> author_id = viewer_id <span class="keyword">order</span> <span class="keyword">by</span>  author_id <span class="keyword">asc</span></span><br></pre></td></tr></table></figure><h2 id="5-无效的推文（简单）">5.无效的推文（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-36.png" alt="img"></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span>  tweet_id </span><br><span class="line"><span class="keyword">from</span> Tweets</span><br><span class="line"><span class="keyword">where</span>  <span class="built_in">length</span>(content) &gt;<span class="number">15</span></span><br></pre></td></tr></table></figure><p>注意：<strong><code>content.size</code> 在 SQL 里根本不存在。</strong><br>SQL 没有 <code>size</code> 这种方法，字符串长度是要用 <strong><code>LENGTH()</code></strong> 或者 <strong><code>CHAR_LENGTH()</code></strong>（不同数据库有差别）。</p><h2 id="6-使用唯一标识码替换员工ID（简单）">6.使用唯一标识码替换员工ID（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-38.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-37.png" alt="img"></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> EmployeeUNI.unique_id ,Employees.name </span><br><span class="line"><span class="keyword">from</span> Employees</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> EmployeeUNI <span class="keyword">on</span> Employees.id = EmployeeUNI.id</span><br></pre></td></tr></table></figure><h2 id="7-产品销售分析-I（简单）">7.产品销售分析 I（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-39.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-40.png" alt="img"></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> p.product_name,s.year,s.price </span><br><span class="line"><span class="keyword">from</span> Sales s </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> Product p <span class="keyword">on</span> s.product_id = p.product_id</span><br></pre></td></tr></table></figure><h2 id="8-进店却未进行过交易的顾客（简单）">8.进店却未进行过交易的顾客（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-41-1024x797.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-42-1024x952.png" alt="img"></p><p>思路分析</p><ol><li><p>表结构</p><ul><li><code>Visits</code> 表：顾客到访记录，每条记录包含 <code>visit_id</code> 和 <code>customer_id</code>。</li><li><code>Transactions</code> 表：交易记录，每条记录包含 <code>transaction_id</code>、<code>visit_id</code>、<code>amount</code>。</li></ul><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">visit_id</span></span><br></pre></td></tr></table></figure><p>是两张表的连接键。</p></li><li><p>目标</p><ul><li>找出所有在 <code>Visits</code> 中存在但在 <code>Transactions</code> 中没有对应交易的 <code>visit_id</code>；</li><li>按照 <code>customer_id</code> 统计这些没有交易的 <code>visit_id</code> 的次数。</li></ul></li><li><p>实现方法</p><p>使用</p><p>左连接 + 筛选空交易记录</p><p>：</p><ul><li><code>LEFT JOIN</code>：保证 <code>Visits</code> 表中的所有记录都出现；</li><li><code>WHERE t.transaction_id IS NULL</code>：只保留没有对应交易的 visit；</li><li><code>GROUP BY customer_id</code>：统计每个顾客的无交易次数。</li></ul></li></ol><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> v.customer_id , <span class="built_in">COUNT</span>(*) <span class="keyword">AS</span> count_no_trans</span><br><span class="line"><span class="keyword">from</span> Visits v </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> Transactions t <span class="keyword">on</span> v.visit_id = t.visit_id</span><br><span class="line"><span class="keyword">where</span> t.transaction_id <span class="keyword">is</span> <span class="literal">null</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> v.customer_id</span><br></pre></td></tr></table></figure><h2 id="9-上升的温度（简单）">9.上升的温度（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-61-564x1024.png" alt="img"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> cur.id</span><br><span class="line"><span class="keyword">from</span> Weather cur</span><br><span class="line"><span class="keyword">join</span> Weather pre <span class="keyword">on</span> cur.recordDate  <span class="operator">=</span> DATE_ADD(pre.recordDate, <span class="type">INTERVAL</span> <span class="number">1</span> <span class="keyword">DAY</span>)</span><br><span class="line"><span class="keyword">where</span> cur.temperature <span class="operator">&gt;</span> pre.temperature</span><br></pre></td></tr></table></figure><p>或者</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> cur.id</span><br><span class="line"><span class="keyword">FROM</span> Weather cur</span><br><span class="line"><span class="keyword">JOIN</span> Weather pre</span><br><span class="line">  <span class="keyword">ON</span> DATEDIFF(cur.recordDate, pre.recordDate) = <span class="number">1</span></span><br><span class="line"><span class="keyword">WHERE</span> cur.temperature &gt; pre.temperature;</span><br></pre></td></tr></table></figure><p>DATEDIFF()是MySQL 中的一个日期时间函数,用于计算两个日期之间的天数差。</p><h2 id="10-每台机器的进程平均运行时间（简单）">10.每台机器的进程平均运行时间（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-62-1024x763.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-63.png" alt="img"></p><p>自连接</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#计算每台机器各自完成一个进程任务的平均耗时。</span><br><span class="line">#完成一个进程任务的时间指进程的&#x27;end&#x27; 时间戳 减去 &#x27;start&#x27; 时间戳。平均耗时通过计算每台机器上所有进程任务的总耗费时间除以机器上的总进程数量获得。</span><br><span class="line">#分组，start一组，end一组</span><br><span class="line"><span class="keyword">select</span> s.machine_id , <span class="built_in">round</span>(<span class="built_in">Avg</span>(<span class="built_in">e</span>.timestamp - s.timestamp ),<span class="number">3</span>)<span class="keyword">as</span> processing_time</span><br><span class="line"><span class="keyword">from</span> Activity s</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> Activity <span class="built_in">e</span> </span><br><span class="line"><span class="keyword">on</span> s.machine_id  = <span class="built_in">e</span>.machine_id</span><br><span class="line"><span class="keyword">and</span> s.process_id = <span class="built_in">e</span>.process_id</span><br><span class="line"><span class="keyword">and</span> s.activity_type = <span class="string">&#x27;start&#x27;</span></span><br><span class="line"><span class="keyword">and</span> <span class="built_in">e</span>.activity_type = <span class="string">&#x27;end&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> s.machine_id</span><br></pre></td></tr></table></figure><h2 id="11员工奖金（简单）">11员工奖金（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-103.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-104.png" alt="img"></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#编写解决方案，报告每个奖金 少于 1000 的员工的姓名和奖金数额。以 任意顺序 返回结果表。</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">e</span>.name, b.bonus </span><br><span class="line"><span class="keyword">from</span> Employee <span class="built_in">e</span></span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> Bonus b <span class="keyword">on</span> <span class="built_in">e</span>.empId = b.empId</span><br><span class="line"><span class="keyword">where</span> bonus &lt; <span class="number">1000</span> <span class="keyword">or</span> bonus <span class="keyword">is</span> <span class="literal">null</span></span><br></pre></td></tr></table></figure><h2 id="12学生们参加各科测试的次数（简单）">12学生们参加各科测试的次数（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-105.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-106.png" alt="img"></p><p>题意</p><ul><li><strong>Students</strong> 表：学生信息</li><li><strong>Subjects</strong> 表：所有科目信息</li><li><strong>Examinations</strong> 表：学生参加考试的记录（一个学生参加某科目一次考试就是一条记录，可以重复）</li></ul><p>题目要求：<br>查询出 <strong>每个学生参加每一门科目测试的次数</strong>，即 <strong>学生 × 科目</strong> 的所有组合（即使没参加过，也要显示，次数为 0）。<br>按 <code>student_id</code> 和 <code>subject_name</code> 排序。</p><p>解题思路</p><ol><li><p>学生 × 科目 的所有组合</p><p>：</p><ul><li>这需要 <strong>笛卡尔积</strong>（cross join）。</li><li>SQL 里可以用 <code>JOIN</code> 或 <code>CROSS JOIN</code>，即让每个学生和每个科目配对。</li></ul></li><li><p>统计考试次数</p><p>：</p><ul><li>将 <code>Examinations</code> 表按 <code>student_id + subject_name</code> 分组统计 <code>COUNT(*)</code>。</li><li>然后和上一步的学生-科目对比结果进行 <code>LEFT JOIN</code>，没有考试记录的地方用 <code>0</code>。</li></ul></li><li><p>排序</p><p>：</p><ul><li>按 <code>student_id, subject_name</code> 升序。</li></ul></li></ol><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#查询出每个学生参加每一门科目测试的次数，结果按 student_id 和 subject_name 排序。</span><br><span class="line">select <span class="keyword">St</span>.student_id, <span class="keyword">St</span>.student_name,<span class="keyword">Su</span>.subject_name,<span class="keyword">Count</span>(<span class="keyword">e</span>.subject_name) <span class="keyword">as</span> attended_exams</span><br><span class="line">from Students <span class="keyword">St</span></span><br><span class="line"><span class="keyword">Cross</span> join Subjects <span class="keyword">Su</span></span><br><span class="line">Left join Examinations <span class="keyword">e</span> </span><br><span class="line"><span class="keyword">on</span> <span class="keyword">St</span>.student_id = <span class="keyword">e</span>.student_id and <span class="keyword">Su</span>.subject_name = <span class="keyword">e</span>.subject_name</span><br><span class="line">group <span class="keyword">by</span> <span class="keyword">St</span>.student_id, <span class="keyword">St</span>.student_name,<span class="keyword">Su</span>.subject_name</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">St</span>.student_id,<span class="keyword">Su</span>.subject_name;</span><br></pre></td></tr></table></figure><ul><li><code>CROSS JOIN</code> 保证了每个学生和每个科目都会配对，即使没考过。</li><li><code>LEFT JOIN</code> 保证了没有考试记录的组合也会出现。</li><li><code>COUNT(e.subject_name)</code> 遇到没有匹配时（NULL）会自动统计为 0。</li><li><code>GROUP BY</code> 必须包括 <code>student_id, student_name, subject_name</code>。</li><li>最后 <code>ORDER BY</code> 确保输出顺序。</li></ul><h2 id="13-有趣的电影（简单）">13.有趣的电影（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-107-869x1024.png" alt="img"></p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#编写解决方案，找出所有影片描述为 非 boring (不无聊) 的并且 id 为奇数 的影片。返回结果按 rating 降序排列。</span></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> cinema c</span><br><span class="line"><span class="keyword">where</span> description != <span class="string">&#x27;boring&#x27;</span> and <span class="keyword">mod</span>(id,<span class="number">2</span>) = <span class="number">1</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> rating  <span class="keyword">desc</span></span><br></pre></td></tr></table></figure><h2 id="14-平均售价（简单）">14.平均售价（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-108-1024x919.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-109.png" alt="img"></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#编写解决方案以查找每种产品的平均售价。average_price 应该 四舍五入到小数点后两位。如果产品没有任何售出，则假设其平均售价为 0。</span><br><span class="line"><span class="keyword">select</span>  p.product_id, <span class="built_in">ROUND</span>(</span><br><span class="line">    COALESCE( <span class="built_in">SUM</span>(u.units * p.price) / <span class="built_in">NULLIF</span>(<span class="built_in">SUM</span>(u.units), <span class="number">0</span>), <span class="number">0</span> ), <span class="number">2</span>) <span class="keyword">as</span>  average_price #产品没有售出时，默认为<span class="number">0</span></span><br><span class="line"><span class="keyword">from</span> Prices p </span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> UnitsSold u <span class="keyword">on</span> p.product_id = u.product_id </span><br><span class="line"><span class="keyword">and</span> u.purchase_date <span class="keyword">between</span> p.start_date <span class="keyword">and</span> p.end_date   </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span>  p.product_id</span><br></pre></td></tr></table></figure><p>COALESCE是SQL标准中的关键字，主要用于处理字段空值，确保运算正常进行。其核心功能是为表达式提供默认值，当表达式结果为NULL时返回指定的默认值</p><h2 id="15项目员工I（简单）">15项目员工I（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-114.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-115-1024x942.png" alt="img"></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#查询每一个项目中员工的 平均 工作年限，精确到小数点后两位。以 任意 顺序返回结果表。</span><br><span class="line"><span class="keyword">select</span> p.project_id , <span class="built_in">Round</span>(<span class="built_in">Avg</span>(<span class="built_in">e</span>.experience_years),<span class="number">2</span>) <span class="keyword">as</span> average_years</span><br><span class="line"><span class="keyword">from</span> Project p</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> Employee <span class="built_in">e</span></span><br><span class="line"><span class="keyword">on</span> p. employee_id = <span class="built_in">e</span>. employee_id</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> project_id </span><br></pre></td></tr></table></figure><h2 id="16-各赛事的用户注册率（简单）">16.各赛事的用户注册率（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-116.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-117-1000x1024.png" alt="img"></p><figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">#</span>统计出各赛事的用户注册百分率，保留两位小数。</span><br><span class="line"><span class="punctuation">#</span>返回的结果表按 percentage 的 降序 排序，若相同则按 contest_id 的 升序 排序。</span><br><span class="line"><span class="punctuation">#</span><span class="params">(<span class="variable">x</span><span class="operator">/</span><span class="variable">y</span>）<span class="operator">*</span>100</span></span><br><span class="line"><span class="params">#<span class="variable">x</span>:统计<span class="variable">Register</span> 表下<span class="variable">contest_id</span>中的数据数量 <span class="keyword">count</span><span class="params">(<span class="variable">user_id</span>)</span>   并分组<span class="variable">group</span> <span class="variable">by</span> <span class="variable">contest_id</span></span></span><br><span class="line"><span class="params">#<span class="variable">y</span> <span class="operator">=</span> 总人数 <span class="variable">select</span> <span class="variable">count</span> <span class="params">(<span class="operator">*</span>)</span> <span class="variable">from</span> <span class="variable">u</span></span></span><br><span class="line"><span class="params"><span class="variable">select</span> <span class="variable">r</span>.<span class="variable">contest_id</span>,</span></span><br><span class="line"><span class="params"><span class="keyword">Round</span><span class="params">(<span class="keyword">count</span><span class="params">(<span class="variable">r</span>.<span class="variable">user_id</span>)</span> <span class="operator">/</span> <span class="params">(<span class="variable">select</span> <span class="keyword">count</span><span class="params">(<span class="operator">*</span>)</span><span class="variable">from</span> <span class="variable">Users</span>)</span><span class="operator">*</span>100,2)</span> <span class="variable">as</span> <span class="variable">percentage</span></span></span><br><span class="line"><span class="params"><span class="variable">from</span> <span class="variable">Register</span> <span class="variable">r</span></span></span><br><span class="line"><span class="params"><span class="variable">group</span> <span class="variable">by</span> <span class="variable">r</span>.<span class="variable">contest_id</span></span></span><br><span class="line"><span class="params"><span class="variable">order</span> <span class="variable">by</span> <span class="variable">percentage</span> <span class="variable">desc</span>, <span class="variable">r</span>.<span class="variable">contest_id</span> <span class="variable">asc</span></span></span><br></pre></td></tr></table></figure><h2 id="17-查询结果的质量占比（简单）">17.查询结果的质量占比（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-118.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-119.png" alt="img"></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#找出每次的 query_name 、 quality 和 poor_query_percentage。</span><br><span class="line">#quality 和 poor_query_percentage 都应 四舍五入到小数点后两位 。</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">query_name, </span><br><span class="line"><span class="built_in">round</span>(<span class="built_in">Avg</span>(rating / <span class="built_in">position</span>),<span class="number">2</span>) <span class="keyword">as</span> quality, </span><br><span class="line"><span class="built_in">round</span>(<span class="number">100</span> * <span class="built_in">Avg</span>(rating &lt; <span class="number">3</span>),<span class="number">2</span>) <span class="keyword">as</span> poor_query_percentage</span><br><span class="line"><span class="keyword">from</span> Queries </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> query_name</span><br></pre></td></tr></table></figure><h2 id="18至少有5名直接下属的经理（中等）">18至少有5名直接下属的经理（中等）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-120-684x1024.png" alt="img"></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#找出至少有五个直接下属的经理。</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">e</span>.name</span><br><span class="line"><span class="keyword">from</span> Employee <span class="built_in">e</span></span><br><span class="line"> <span class="keyword">join</span> (</span><br><span class="line">    <span class="keyword">select</span> managerId,<span class="built_in">count</span>(*) <span class="keyword">as</span> num</span><br><span class="line">    <span class="keyword">from</span> Employee </span><br><span class="line">    <span class="keyword">where</span> managerId <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> managerId </span><br><span class="line">)c </span><br><span class="line"><span class="keyword">on</span> c.managerId = <span class="built_in">e</span>.id</span><br><span class="line"><span class="keyword">where</span> c.num&gt;=<span class="number">5</span></span><br></pre></td></tr></table></figure><p>方法2</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="type">name</span></span><br><span class="line"><span class="keyword">FROM</span> Employee</span><br><span class="line"><span class="keyword">WHERE</span> id <span class="keyword">IN</span> (</span><br><span class="line">  <span class="keyword">SELECT</span> managerId</span><br><span class="line">  <span class="keyword">FROM</span> Employee</span><br><span class="line">  <span class="keyword">WHERE</span> managerId <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">  <span class="keyword">GROUP</span> <span class="keyword">BY</span> managerId</span><br><span class="line">  <span class="keyword">HAVING</span> COUNT(*) &gt;= <span class="number">5</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><h2 id="19-每位教师所教师的科目种类的数量（简单）">19.每位教师所教师的科目种类的数量（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-124.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-125.png" alt="img"></p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#查询每位老师在大学里教授的科目种类的数量。</span></span><br><span class="line"><span class="keyword">select</span> teacher_id,  <span class="keyword">count</span>(distinct subject_id) <span class="keyword">as</span> cnt</span><br><span class="line"><span class="keyword">from</span> Teacher</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> teacher_id </span><br></pre></td></tr></table></figure><h2 id="20-查询近30天活跃用户数（简单）">20.查询近30天活跃用户数（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-126-1024x681.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-127.png" alt="img"></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#编写解决方案，统计截至 2019-07-27（包含2019-07-27），近 30 天的每日活跃用户数（当天只要有一条活动记录，即为活跃用户）。</span><br><span class="line"><span class="keyword">select</span> activity_date <span class="keyword">as</span> day,<span class="built_in">count</span>(<span class="keyword">distinct</span> user_id)<span class="keyword">as</span> active_users</span><br><span class="line"><span class="keyword">from</span>  Activity </span><br><span class="line"><span class="keyword">where</span> datediff(<span class="string">&quot;2019-07-27&quot;</span>,activity_date) <span class="keyword">between</span> <span class="number">0</span> <span class="keyword">AND</span> <span class="number">29</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> activity_date</span><br></pre></td></tr></table></figure><p>时间差函数TIMESTAMPDIFF、DATEDIFF的用法</p><p>我们在写sql语句，尤其是存储过程中，会频繁用到对于日期、时间的比较和判断，那么对于这两个时间差比较函数用法做一个举例介绍。</p><p>datediff函数，返回值是相差的天数，不能定位到小时、分钟和秒。</p><ul><li>相差2天 select datediff(‘2018-03-22 09:00:00’, ‘2018-03-20 07:00:00’);</li></ul><p>TIMESTAMPDIFF函数，有参数设置，可以精确到天（DAY）、小时（HOUR），分钟（MINUTE）和秒（SECOND），使用起来比datediff函数更加灵活。对于比较的两个时间，时间小的放在前面，时间大的放在后面。</p><ul><li>相差1天 select TIMESTAMPDIFF(DAY, ‘2018-03-20 23:59:00‘, ‘2015-03-22 00:00:00‘);</li><li>相差49小时 select TIMESTAMPDIFF(HOUR, ‘2018-03-20 09:00:00’, ‘2018-03-22 10:00:00’);</li><li>相差2940分钟 select TIMESTAMPDIFF(MINUTE, ‘2018-03-20 09:00:00’, ‘2018-03-22 10:00:00’);</li><li>相差176400秒 select TIMESTAMPDIFF(SECOND, ‘2018-03-20 09:00:00’, ‘2018-03-22 10:00:00’);</li></ul><h2 id="21-销售分析III（简单）">21.销售分析III（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-128-1024x938.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-129.png" alt="img"></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#编写解决方案，报告 2019年春季 才售出的产品。即 仅 在 2019-01-01 （含）至 2019-03-31 （含）之间出售的商品。</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> s.product_id,p.product_name</span><br><span class="line"><span class="keyword">from</span> Sales s</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> Product p <span class="keyword">on</span> s.product_id = p.product_id</span><br><span class="line"><span class="keyword">where</span> s.product_id <span class="keyword">not</span> <span class="keyword">in</span> (</span><br><span class="line">    <span class="keyword">select</span> product_id</span><br><span class="line">    <span class="keyword">from</span> Sales s</span><br><span class="line">    <span class="keyword">where</span> s.sale_date <span class="keyword">not</span> <span class="keyword">between</span> <span class="string">&#x27;2019-01-01&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;2019-03-31&#x27;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>条件聚合</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">SELECT</span> p.product_id, p.product_name</span><br><span class="line"><span class="attribute">FROM</span> Product p</span><br><span class="line"><span class="attribute">JOIN</span> Sales s <span class="literal">ON</span> s.product_id = p.product_id</span><br><span class="line"><span class="attribute">GROUP</span> BY p.product_id, p.product_name</span><br><span class="line"><span class="attribute">HAVING</span></span><br><span class="line">    <span class="attribute">SUM</span>(s.sale_date BETWEEN &#x27;<span class="number">2019</span>-<span class="number">01</span>-<span class="number">01</span>&#x27; AND &#x27;<span class="number">2019</span>-<span class="number">03</span>-<span class="number">31</span>&#x27;) &gt; <span class="number">0</span>   -- 区间内至少有一笔</span><br><span class="line"><span class="attribute">AND</span> SUM(s.sale_date &lt; &#x27;<span class="number">2019</span>-<span class="number">01</span>-<span class="number">01</span>&#x27; OR s.sale_date &gt; &#x27;<span class="number">2019</span>-<span class="number">03</span>-<span class="number">31</span>&#x27;) = <span class="number">0</span>;  -- 区间外 <span class="number">0</span> 笔</span><br></pre></td></tr></table></figure><ul><li>在 MySQL 中，布尔表达式可当 0/1 使用，<code>SUM(布尔)</code> 就是计数。</li><li>这写法通常很快，因为只扫一遍 <code>Sales</code> 并分组。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-130-1024x459.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-131-1024x566.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-132-1024x495.png" alt="img"></p><h2 id="22-超过5名学生的课（简单）">22.超过5名学生的课（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-133-425x1024.png" alt="img"></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#查询 至少有 <span class="number">5</span> 个学生 的所有班级。</span><br><span class="line">select <span class="keyword">class</span></span><br><span class="line"><span class="symbol">from</span> <span class="symbol">Courses</span></span><br><span class="line"><span class="symbol">group</span> <span class="symbol">by</span> <span class="symbol">class</span></span><br><span class="line"><span class="symbol">having</span> <span class="symbol">count</span>(<span class="symbol">student</span>) &gt;=<span class="symbol">5</span></span><br></pre></td></tr></table></figure><h2 id="23-求关注者的数量（简单）">23.求关注者的数量（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-134-573x1024.png" alt="img"></p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#编写解决方案，对于每一个用户，返回该用户的关注者数量。</span></span><br><span class="line"><span class="keyword">select</span> user_id,<span class="keyword">count</span>(follower_id ) <span class="keyword">as</span> followers_count</span><br><span class="line"><span class="keyword">from</span> Followers</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> user_id</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> user_id</span><br></pre></td></tr></table></figure><h2 id="24-确认率（中等）">24.确认率（中等）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-135-1024x909.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-136-899x1024.png" alt="img"></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#用户的 确认率 是 <span class="string">&#x27;confirmed&#x27;</span> 消息的数量除以请求的确认消息的总数。没有请求任何确认消息的用户的确认率为 <span class="number">0</span> 。确认率四舍五入到 小数点后两位 。</span><br><span class="line">#编写一个<span class="keyword">SQL</span>查询来查找每个用户的 确认率 。</span><br><span class="line"><span class="meta">#confirmed 为该用户确认的消息占发送总消息的比例</span></span><br><span class="line"><span class="keyword">select</span> s.user_id,Round(IFNULL(AVG(c.action =<span class="string">&#x27;confirmed&#x27;</span>),<span class="number">0</span>),<span class="number">2</span>)<span class="keyword">as</span> confirmation_rate</span><br><span class="line"><span class="keyword">from</span>  Signups s</span><br><span class="line"><span class="keyword">left join</span> Confirmations c</span><br><span class="line"><span class="keyword">on</span>  c.user_id = s.user_id</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> s.user_id</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-137-1024x679.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-138-1024x667.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-139-1024x557.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-140-1024x833.png" alt="img"></p><h2 id="25-每月交易I（中等）">25.每月交易I（中等）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-144-1024x708.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-143-1024x823.png" alt="img"></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#编写一个 <span class="keyword">sql</span> 查询来查找每个月和每个国家/地区的事务数及其总金额、已批准的事务数及其总金额。</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  DATE_FORMAT(trans_date, <span class="string">&#x27;%Y-%m&#x27;</span>) <span class="keyword">AS</span> month,</span><br><span class="line">  country,</span><br><span class="line">  COUNT(*)                                  <span class="keyword">AS</span> trans_count,</span><br><span class="line">  SUM(state = <span class="string">&#x27;approved&#x27;</span>)                   <span class="keyword">AS</span> approved_count,</span><br><span class="line">  SUM(amount)                               <span class="keyword">AS</span> trans_total_amount,</span><br><span class="line">  SUM(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> state = <span class="string">&#x27;approved&#x27;</span></span><br><span class="line">           <span class="keyword">THEN</span> amount <span class="keyword">ELSE</span> <span class="number">0</span> <span class="keyword">END</span>)          <span class="keyword">AS</span> approved_total_amount</span><br><span class="line"><span class="keyword">FROM</span> Transactions</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> DATE_FORMAT(trans_date, <span class="string">&#x27;%Y-%m&#x27;</span>), country</span><br></pre></td></tr></table></figure><p>用一次分组统计把所有指标都算出来。关键点：</p><ul><li>用 <code>DATE_FORMAT(trans_date, '%Y-%m')</code> 取“年-月”作为分组的 <strong>month</strong>。</li><li>事务总数：<code>COUNT(*)</code></li><li>批准的事务数：<code>SUM(state='approved')</code>（在 MySQL 中布尔表达式为真记作 1）</li><li>事务总金额：<code>SUM(amount)</code></li><li>批准的事务总金额：<code>SUM(CASE WHEN state='approved' THEN amount ELSE 0 END)</code></li></ul><h2 id="26-即时食物配送II（中等）">26.即时食物配送II（中等）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-146.png" alt="img"></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#如果顾客期望的配送日期和下单日期相同，则该订单称为 「即时订单」，否则称为「计划订单」。</span></span><br><span class="line"><span class="meta">#「首次订单」是顾客最早创建的订单。我们保证一个顾客只会有一个「首次订单」。</span></span><br><span class="line"><span class="meta">#编写解决方案以获取即时订单在所有用户的首次订单中的比例。保留两位小数。</span></span><br><span class="line"><span class="function"><span class="keyword">select</span> <span class="title">Round</span>(<span class="params"><span class="number">100</span>*AVG(d.order_date = d.customer_pref_delivery_date</span>),2) <span class="keyword">as</span> immediate_percentage</span></span><br><span class="line"><span class="function"><span class="keyword">from</span> Delivery d</span></span><br><span class="line"><span class="function"><span class="title">join</span> (<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">select</span>  customer_id,MIN( order_date </span>) <span class="keyword">as</span> first_order_date</span></span><br><span class="line"><span class="function">    <span class="keyword">from</span> Delivery</span></span><br><span class="line"><span class="function">    <span class="keyword">group</span> <span class="keyword">by</span> customer_id</span></span><br><span class="line"><span class="function">)f</span></span><br><span class="line"><span class="function"><span class="keyword">on</span> d.customer_id</span> = f.customer_id</span><br><span class="line"><span class="keyword">and</span> d.order_date = f.first_order_date</span><br></pre></td></tr></table></figure><h2 id="27-只出现一次的最大数字（简单）">27.只出现一次的最大数字（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-152-482x1024.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-153.png" alt="img"></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#找出最大的 单一数字 。如果不存在 单一数字 ，则返回 <span class="keyword">null</span> 。</span><br><span class="line"><span class="keyword">select</span> Max(num) <span class="keyword">as</span> num</span><br><span class="line"><span class="keyword">from</span> MyNumbers</span><br><span class="line"><span class="keyword">where</span> num <span class="keyword">not</span> <span class="keyword">in</span>( <span class="keyword">select</span> num <span class="keyword">from</span> MyNumbers <span class="keyword">group</span> <span class="keyword">by</span> num <span class="keyword">having</span> count(num) &gt; <span class="number">1</span>)</span><br></pre></td></tr></table></figure><h2 id="28-游戏玩法分析IV（中等）">28.游戏玩法分析IV（中等）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-154-1024x753.png" alt="img"></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">Write</span> your MySQL query <span class="keyword">statement</span> below</span><br><span class="line">#编写解决方案，报告在首次登录的第二天再次登录的玩家的 比率，四舍五入到小数点后两位。换句话说，你需要计算从首次登录后的第二天登录的玩家数量，并将其除以总玩家数。</span><br><span class="line"><span class="meta">#1.查玩家总数 </span></span><br><span class="line"><span class="meta">#select  count( distinct player_id) from Activity</span></span><br><span class="line"><span class="meta">#2.查询第二天登录的玩家数量</span></span><br><span class="line"><span class="meta">#2.1先查每个玩家的首次登录日期</span></span><br><span class="line">#(<span class="keyword">select</span> player_id,Min(event_date) <span class="keyword">as</span> first_login_date</span><br><span class="line"><span class="meta">#from Activity</span></span><br><span class="line"><span class="meta">#group by player_id ) as F1</span></span><br><span class="line"><span class="meta">#2.2找出第二天登录的玩家数量：首次登录+1</span></span><br><span class="line"><span class="meta">#inner join Activity as A</span></span><br><span class="line"><span class="meta">#on F1.player_id = A.player_id</span></span><br><span class="line"><span class="meta">#and A.event_date = DATE_ADD(F1.first_login_date，INTERVAL 1 DAY)</span></span><br><span class="line"></span><br><span class="line"> #整合这几步最终的<span class="keyword">sql</span>为</span><br><span class="line"> <span class="keyword">select</span></span><br><span class="line">  Round(</span><br><span class="line">     <span class="comment">-- 分子: COUNT 出 JOIN 成功的玩家数</span></span><br><span class="line">     Count(F1.player_id) /</span><br><span class="line">     <span class="comment">-- 分母: 子查询计算总玩家数</span></span><br><span class="line">     (<span class="keyword">select</span>  count( <span class="keyword">distinct</span> player_id) <span class="keyword">from</span> Activity)</span><br><span class="line">     <span class="comment">--保留两位数字</span></span><br><span class="line">     ,<span class="number">2</span></span><br><span class="line"> ) <span class="keyword">as</span> fraction</span><br><span class="line"> <span class="keyword">from</span> </span><br><span class="line"> (#<span class="number">2.1</span>先查每个玩家的首次登录日期</span><br><span class="line">   (<span class="keyword">select</span> player_id,Min(event_date) <span class="keyword">as</span> first_login_date</span><br><span class="line">      <span class="keyword">from</span> Activity</span><br><span class="line">     <span class="keyword">group</span> <span class="keyword">by</span> player_id ) </span><br><span class="line"> )<span class="keyword">as</span> F1</span><br><span class="line"><span class="meta">#2.2找出第二天登录的玩家数量：首次登录+1</span></span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> Activity <span class="keyword">as</span> A</span><br><span class="line"><span class="keyword">on</span> F1.player_id = A.player_id</span><br><span class="line"> <span class="keyword">and</span> A.event_date = DATE_ADD(F1.first_login_date,<span class="type">INTERVAL</span> <span class="number">1</span> DAY)</span><br></pre></td></tr></table></figure><p>下面这样写也是一样的</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- players whose first day +1 also login</span></span><br><span class="line"><span class="keyword">SELECT</span> ROUND(</span><br><span class="line">         IFNULL(</span><br><span class="line">           (</span><br><span class="line">             <span class="keyword">SELECT</span> COUNT(<span class="keyword">DISTINCT</span> a.player_id)</span><br><span class="line">             <span class="keyword">FROM</span> (</span><br><span class="line">               <span class="keyword">SELECT</span> player_id, MIN(event_date) <span class="keyword">AS</span> first_login</span><br><span class="line">               <span class="keyword">FROM</span> Activity</span><br><span class="line">               <span class="keyword">GROUP</span> <span class="keyword">BY</span> player_id</span><br><span class="line">             ) f</span><br><span class="line">             <span class="keyword">JOIN</span> Activity a</span><br><span class="line">               <span class="keyword">ON</span> a.player_id = f.player_id</span><br><span class="line">              <span class="keyword">AND</span> a.event_date = DATE_ADD(f.first_login, <span class="type">INTERVAL</span> <span class="number">1</span> DAY)</span><br><span class="line">           ) / (<span class="keyword">SELECT</span> COUNT(<span class="keyword">DISTINCT</span> player_id) <span class="keyword">FROM</span> Activity)</span><br><span class="line">         , <span class="number">0</span>)</span><br><span class="line">       , <span class="number">2</span>) <span class="keyword">AS</span> fraction;</span><br></pre></td></tr></table></figure><h2 id="29-每位经理的下属员工数量（简单）">29.每位经理的下属员工数量（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-155-1024x443.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-156-1005x1024.png" alt="img"></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#编写一个解决方案来返回需要听取汇报的所有经理的 ID、名称、直接向该经理汇报的员工人数，以及这些员工的平均年龄，其中该平均年龄需要四舍五入到最接近的整数。</span><br><span class="line">#返回的结果集需要按照 employee_id 进行排序。</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">e</span>. employee_id,<span class="built_in">e</span>.name, </span><br><span class="line"><span class="built_in">Count</span>(r.reports_to)<span class="keyword">as</span> reports_count, </span><br><span class="line"><span class="built_in">Round</span>(<span class="built_in">AVG</span>(r.age),<span class="number">0</span>)<span class="keyword">as</span> average_age </span><br><span class="line"><span class="keyword">from</span> Employees <span class="built_in">e</span></span><br><span class="line"><span class="keyword">inner</span> <span class="keyword">join</span> Employees r</span><br><span class="line"><span class="keyword">on</span> <span class="built_in">e</span>.employee_id = r.reports_to</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> r.reports_to</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> employee_id</span><br></pre></td></tr></table></figure><h2 id="30-买下所有产品的客户（中等）">30.买下所有产品的客户（中等）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-157.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-158.png" alt="img"></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#编写解决方案，报告 Customer 表中购买了 Product 表中所有产品的客户的 id。</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> customer_id </span><br><span class="line"><span class="keyword">from</span> Customer c</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span>  customer_id</span><br><span class="line">#按 customer_id 查时：Customer 表中出现的product_key = Product 表中出现的product_key </span><br><span class="line"><span class="keyword">having</span> <span class="built_in">count</span>(<span class="keyword">distinct</span> c.product_key) = (<span class="keyword">select</span> <span class="built_in">count</span>(product_key)<span class="keyword">as</span> cnt <span class="keyword">from</span> Product)</span><br></pre></td></tr></table></figure><h2 id="31-员工的直属部门-简单">31.员工的直属部门(简单)</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-159.png" alt="img"></p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#一个员工可以属于多个部门。当一个员工加入超过一个部门的时候，他需要决定哪个部门是他的直属部门。请注意，当员工只加入一个部门的时候，那这个部门将默认为他的直属部门，虽然表记录的值为&#x27;N&#x27;.</span></span><br><span class="line"><span class="meta">#请编写解决方案，查出员工所属的直属部门。</span></span><br><span class="line"><span class="meta">#若员工在多个部门，则取 primary_flag = &#x27;Y&#x27; 的那条；</span></span><br><span class="line"><span class="meta">#若员工只在一个部门（即 count(*)=1），就取那一条（不管 flag 是什么）。</span></span><br><span class="line"><span class="keyword">select</span>  employee_id,department_id</span><br><span class="line"><span class="keyword">from</span> Employee e</span><br><span class="line"><span class="keyword">where</span> e.primary_flag = <span class="string">&#x27;Y&#x27;</span></span><br><span class="line">or employee_id <span class="keyword">in</span>(</span><br><span class="line">    <span class="keyword">select</span> employee_id</span><br><span class="line">    <span class="keyword">from</span> Employee</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> employee_id</span><br><span class="line">    having <span class="keyword">count</span>(*) = <span class="number">1</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> employee_id,department_id</span><br></pre></td></tr></table></figure><p>解释：</p><ul><li>子查询找出“只有一个部门”的员工 <code>employee_id</code>；</li><li>外层选出两类行：<code>primary_flag='Y'</code> 的行，以及只有一个部门的那位员工的那一行。</li></ul><p>写法二：窗口函数（MySQL 8+）</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> t <span class="keyword">AS</span> (</span><br><span class="line">  <span class="keyword">SELECT</span></span><br><span class="line">    employee_id,</span><br><span class="line">    department_id,</span><br><span class="line">    primary_flag,</span><br><span class="line">    COUNT(*) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> employee_id) <span class="keyword">AS</span> cnt</span><br><span class="line">  <span class="keyword">FROM</span> Employee</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> employee_id, department_id</span><br><span class="line"><span class="keyword">FROM</span> t</span><br><span class="line"><span class="keyword">WHERE</span> primary_flag = <span class="string">&#x27;Y&#x27;</span> <span class="keyword">OR</span> cnt = <span class="number">1</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> employee_id, department_id;</span><br></pre></td></tr></table></figure><p>这条 SQL 用了 <strong>窗口函数 + 公共表表达式（CTE）</strong>，把题目的两条规则一次性“写进行里”，再在外层做一次非常简单的筛选。逐句看——</p><ol><li>CTE <code>t</code> 在干什么？</li></ol><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> t <span class="keyword">AS</span> (</span><br><span class="line">  <span class="keyword">SELECT</span></span><br><span class="line">    employee_id,</span><br><span class="line">    department_id,</span><br><span class="line">    primary_flag,</span><br><span class="line">    COUNT(*) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> employee_id) <span class="keyword">AS</span> cnt</span><br><span class="line">  <span class="keyword">FROM</span> Employee</span><br><span class="line">)</span><br></pre></td></tr></table></figure><ul><li><p><code>WITH t AS (...)</code> 定义了一个临时结果集 t，可以把它当成一张临时表使用。</p></li><li><p>里面最关键的是这句窗口函数：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COUNT(*) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> employee_id) <span class="keyword">AS</span> cnt</span><br></pre></td></tr></table></figure><p>含义：</p><p>对同一个 <code>employee_id</code> 的所有行分组（但不折叠行），统计该员工出现了多少行</p><p>。</p><p>也就是给每一行都“贴一个标签”——</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">cnt</span></span><br></pre></td></tr></table></figure><p>= 这个员工一共属于多少个部门。 和</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GROUP</span> <span class="title">BY</span></span><br></pre></td></tr></table></figure><p>的区别：</p><ul><li><code>GROUP BY employee_id</code> 会把同一个员工的多行聚成一行，行粒度改变了，后面想拿 <code>department_id</code> 会变得困难。</li><li><strong>窗口函数不会合并行</strong>，只是在“每一行上”附带一个“分组统计值”，保留了明细粒度，后续可以自由筛哪一行。</li></ul></li><li><p>外层查询如何筛选？</p></li></ul><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> employee_id, department_id</span><br><span class="line"><span class="keyword">FROM</span> t</span><br><span class="line"><span class="keyword">WHERE</span> primary_flag = <span class="string">&#x27;Y&#x27;</span> <span class="keyword">OR</span> cnt = <span class="number">1</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> employee_id, department_id;</span><br></pre></td></tr></table></figure><ul><li><code>cnt = 1</code>：该员工 <strong>只在一个部门</strong>，就取这唯一的一行（不管 <code>primary_flag</code> 记录的是 <code>Y</code> 还是 <code>N</code>）。</li><li><code>primary_flag = 'Y'</code>：该员工 <strong>在多个部门</strong> 时，只取标了主部门的那一行。</li></ul><p>因此，这个 <code>WHERE</code> 同时覆盖了两类情况，满足题意：</p><ol><li>只有一个部门 → <code>cnt = 1</code>，取它。</li><li>多个部门 → 用 <code>primary_flag = 'Y'</code> 选出主部门。</li></ol><p><code>ORDER BY</code> 只是为了输出稳定，可有可无。</p><ol start="3"><li>用示例走一遍（题目样例）</li></ol><p>原表（简化）：</p><table><thead><tr><th>employee_id</th><th>department_id</th><th>primary_flag</th></tr></thead><tbody><tr><td>1</td><td>1</td><td>N</td></tr><tr><td>1</td><td>2</td><td>Y</td></tr><tr><td>2</td><td>1</td><td>Y</td></tr><tr><td>2</td><td>3</td><td>N</td></tr><tr><td>3</td><td>1</td><td>Y</td></tr><tr><td>4</td><td>2</td><td>N</td></tr><tr><td>4</td><td>3</td><td>Y</td></tr></tbody></table><p>CTE <code>t</code> 里多了 <code>cnt</code>：</p><table><thead><tr><th>employee_id</th><th>department_id</th><th>primary_flag</th><th>cnt</th></tr></thead><tbody><tr><td>1</td><td>1</td><td>N</td><td>2</td></tr><tr><td>1</td><td>2</td><td>Y</td><td>2</td></tr><tr><td>2</td><td>1</td><td>Y</td><td>2</td></tr><tr><td>2</td><td>3</td><td>N</td><td>2</td></tr><tr><td>3</td><td>1</td><td>Y</td><td>1</td></tr><tr><td>4</td><td>2</td><td>N</td><td>2</td></tr><tr><td>4</td><td>3</td><td>Y</td><td>2</td></tr></tbody></table><p>外层 <code>WHERE primary_flag='Y' OR cnt=1</code> 保留的行：</p><ul><li>emp=1：两行里只有 <code>Y</code> 的那行保留 → (1, 2)</li><li>emp=2：保留 <code>Y</code> 的那行 → (2, 1)</li><li>emp=3：<code>cnt=1</code>，唯一一行保留 → (3, 1)</li><li>emp=4：保留 <code>Y</code> 的那行 → (4, 3)</li></ul><p>结果：<strong>每个员工一行，就是他的主部门</strong>。</p><ol start="4"><li>为什么不用 <code>GROUP BY</code>？</li></ol><p>如果你 <code>GROUP BY employee_id</code>，就只剩一行，<code>department_id</code> 该取谁？<br>除非你再写一轮子查询/关联去“把那一行拉回来”。窗口函数保留了明细粒度，所以外层筛选非常干净。</p><ol start="5"><li>边界 / 数据质量说明</li></ol><ul><li>题目保证：员工加入多个部门时会<strong>唯一</strong>选一个主部门（<code>Y</code>），所以不会出现多个 <code>Y</code>。<br>如果担心数据异常（比如既无 <code>Y</code> 又多部门），可以用更稳妥的写法：</li></ul><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> t <span class="keyword">AS</span> (</span><br><span class="line">  <span class="keyword">SELECT</span></span><br><span class="line">    employee_id, department_id, primary_flag,</span><br><span class="line">    ROW_NUMBER() <span class="keyword">OVER</span> (</span><br><span class="line">      <span class="keyword">PARTITION</span> <span class="keyword">BY</span> employee_id</span><br><span class="line">      <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">CASE</span> <span class="keyword">WHEN</span> primary_flag=<span class="string">&#x27;Y&#x27;</span> <span class="keyword">THEN</span> <span class="number">0</span> <span class="keyword">ELSE</span> <span class="number">1</span> <span class="keyword">END</span></span><br><span class="line">    ) <span class="keyword">AS</span> rn</span><br><span class="line">  <span class="keyword">FROM</span> Employee</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> employee_id, department_id</span><br><span class="line"><span class="keyword">FROM</span> t</span><br><span class="line"><span class="keyword">WHERE</span> rn = <span class="number">1</span>;</span><br></pre></td></tr></table></figure><ul><li>更“容错”。</li></ul><p>一句话概括这条 SQL 的巧妙点：<br><strong>用窗口函数把“每个员工的部门数量”写到每一行上，再用一条简单的 <code>WHERE</code> 同时处理两种规则，既简洁又高效。</strong></p><h2 id="32-判断三角形（简单）">32.判断三角形（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-160.png" alt="img"></p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#对每三个线段报告它们是否可以形成一个三角形。</span></span><br><span class="line"><span class="comment">#两边之和大于第三边</span></span><br><span class="line"><span class="comment">#两边之差的绝对值小于第三边</span></span><br><span class="line">select</span><br><span class="line"> <span class="built_in">t1</span>.*,</span><br><span class="line"> if(((<span class="built_in">t1</span>.x+<span class="built_in">t1</span>.y)&gt;<span class="built_in">t1</span>.z <span class="keyword">and </span>(<span class="built_in">t1</span>.y+<span class="built_in">t1</span>.z)&gt;<span class="built_in">t1</span>.x <span class="keyword">and </span>(<span class="built_in">t1</span>.x+<span class="built_in">t1</span>.z)&gt;<span class="built_in">t1</span>.y),<span class="string">&#x27;Yes&#x27;</span>,<span class="string">&#x27;No&#x27;</span>)as triangle </span><br><span class="line">from Triangle <span class="built_in">t1</span></span><br></pre></td></tr></table></figure><p>法二</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">t1.*,</span><br><span class="line"><span class="keyword">case</span> <span class="keyword">when</span> x+y+z&gt;<span class="number">2</span>*<span class="built_in">greatest</span>(x,y,z) <span class="keyword">then</span> <span class="string">&#x27;Yes&#x27;</span></span><br><span class="line"><span class="keyword">else</span> <span class="string">&#x27;No&#x27;</span></span><br><span class="line"><span class="keyword">end</span> <span class="keyword">as</span> triangle</span><br><span class="line"><span class="keyword">from</span> triangle</span><br></pre></td></tr></table></figure><p><code>GREATEST()</code> 是 <strong>MySQL 的一个内置函数</strong>，用来返回一组数值（或字符串）中的最大值。</p><p>语法</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">GREATEST</span>(<span class="params">expr1, expr2, expr3, ...</span>)</span></span><br></pre></td></tr></table></figure><ul><li><code>expr1, expr2, expr3...</code>：可以是多个参数（数字或字符串）。</li><li>返回结果是这些参数里 <strong>最大的那个</strong>。</li></ul><p>示例</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">SELECT</span> GREATEST(<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>);   -- 结果 <span class="number">30</span></span><br><span class="line"><span class="attribute">SELECT</span> GREATEST(<span class="number">5</span>, -<span class="number">1</span>, <span class="number">100</span>, <span class="number">42</span>); -- 结果 <span class="number">100</span></span><br></pre></td></tr></table></figure><p>如果是字符串：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> GREATEST(<span class="string">&#x27;apple&#x27;</span>, <span class="string">&#x27;banana&#x27;</span>, <span class="string">&#x27;pear&#x27;</span>); <span class="comment">-- 结果 pear（按字典序）</span></span><br></pre></td></tr></table></figure><p>回到你的 SQL</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> t1.*,</span><br><span class="line">       <span class="keyword">CASE</span> </span><br><span class="line">         <span class="keyword">WHEN</span> x+y+z &gt; <span class="number">2</span>*<span class="built_in">GREATEST</span>(x,y,z) <span class="keyword">THEN</span> <span class="string">&#x27;Yes&#x27;</span></span><br><span class="line">         <span class="keyword">ELSE</span> <span class="string">&#x27;No&#x27;</span></span><br><span class="line">       <span class="keyword">END</span> <span class="keyword">AS</span> triangle</span><br><span class="line"><span class="keyword">FROM</span> triangle;</span><br></pre></td></tr></table></figure><p>含义：</p><ul><li><code>GREATEST(x,y,z)</code> 找到三条边里最长的那条边。</li><li>如果 <code>x+y+z &gt; 2*最长边</code>，就说明三边能构成三角形 → 输出 <code>'Yes'</code>。</li><li>否则 → 输出 <code>'No'</code>。</li></ul><p>这是利用“三角形两边之和大于第三边”的判定条件。</p><h2 id="33-连续出现的数字（中等）">33.连续出现的数字（中等）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-161-392x1024.png" alt="img"></p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#找出所有至少连续出现三次的数字。</span></span><br><span class="line"><span class="comment">#返回的结果表中的数据可以按 任意顺序 排列。</span></span><br><span class="line">select distinct l1.num <span class="keyword">as</span> ConsecutiveNums</span><br><span class="line"><span class="keyword">from</span> Logs l1</span><br><span class="line">join Logs l2 <span class="keyword">on</span> l1.<span class="built_in">id</span> = l2.<span class="built_in">id</span> - <span class="number">1</span></span><br><span class="line">join logs l3 <span class="keyword">on</span> l2.<span class="built_in">id</span> = l3.<span class="built_in">id</span> - <span class="number">1</span></span><br><span class="line"><span class="keyword">where</span> l1.num = l2.num</span><br><span class="line">      <span class="keyword">and</span> l2.num = l3.num</span><br></pre></td></tr></table></figure><p>解释：</p><ul><li><code>l1.id, l2.id, l3.id</code> 分别是连续的三行（<code>id, id+1, id+2</code>）。</li><li>如果这三行的 <code>num</code> 都相同，就说明 <code>num</code> 连续出现了至少三次。</li><li><code>DISTINCT</code> 去重，避免重复结果。</li></ul><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#找出所有至少连续出现三次的数字。</span><br><span class="line">#返回的结果表中的数据可以按 任意顺序 排列。</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> num <span class="keyword">as</span> ConsecutiveNums</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> num,</span><br><span class="line">    lead(num,<span class="number">1</span>)<span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> id)<span class="keyword">as</span> next1,</span><br><span class="line">    lead(num,<span class="number">2</span>)<span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> id)<span class="keyword">as</span> next2</span><br><span class="line">    <span class="keyword">from</span> Logs</span><br><span class="line">)t</span><br><span class="line"><span class="keyword">where</span> num = next1 <span class="keyword">and</span> num = next2</span><br></pre></td></tr></table></figure><p>解释：</p><ul><li><code>LEAD(num, k)</code> 可以取到后面第 <code>k</code> 行的值。</li><li>检查当前行的 <code>num</code> 与后两行是否相等。</li><li>相等就说明 <code>num</code> 连续至少三次。</li></ul><h2 id="34-修复表中的名字（简单）">34.修复表中的名字（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-162.png" alt="img"></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># UPPER(str) 将字符串中所有字符转为大写</span><br><span class="line"># LOWER(str) 将字符串中所有字符转为小写</span><br><span class="line"><span class="keyword">select</span> user_id ,Concat(UPPER(left(<span class="type">name</span>,<span class="number">1</span>)),LOWER(RIGHT(<span class="type">name</span>,LENGTH(<span class="type">name</span>)<span class="number">-1</span>)))<span class="keyword">as</span> <span class="type">name</span></span><br><span class="line"><span class="keyword">from</span> Users</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> user_id</span><br><span class="line"># 一、计算字段</span><br><span class="line"></span><br><span class="line"># 其实本题主要考察的就是计算字段的使用。</span><br><span class="line"># 二、知识点</span><br><span class="line"># <span class="number">2.1</span> CONCAT() 函数</span><br><span class="line"></span><br><span class="line"># CONCAT 可以将多个字符串拼接在一起。</span><br><span class="line"># <span class="number">2.2</span> LEFT(str, length) 函数</span><br><span class="line"></span><br><span class="line"># 从左开始截取字符串，length 是截取的长度。</span><br><span class="line"># <span class="number">2.3</span> UPPER(str) 与 LOWER(str)</span><br><span class="line"></span><br><span class="line"># UPPER(str) 将字符串中所有字符转为大写</span><br><span class="line"></span><br><span class="line"># LOWER(str) 将字符串中所有字符转为小写</span><br><span class="line"># <span class="number">2.4</span> SUBSTRING(str, <span class="keyword">begin</span>, <span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line"># 截取字符串，<span class="keyword">end</span> 不写默认为空。</span><br><span class="line"></span><br><span class="line"># SUBSTRING(<span class="type">name</span>, <span class="number">2</span>) 从第二个截取到末尾，注意并不是下标，就是第二个。</span><br><span class="line"></span><br><span class="line"># CONCAT 用来拼接字符串 ● LEFT 从左边截取字符 ● RIGHT 从右边截取字符 ● UPPER 变为大写 ● LOWER 变为小写 ● LENGTH 获取字符串长度</span><br></pre></td></tr></table></figure><h2 id="35-患某种疾病的患者（简单）">35.患某种疾病的患者（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-163-1024x1011.png" alt="img"></p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#查询患有 I 类糖尿病的患者 ID （patient_id）、患者姓名（patient_name）以及其患有的所有疾病代码（conditions）。I 类糖尿病的代码总是包含前缀 DIAB1 。</span></span><br><span class="line"><span class="keyword">select</span> *</span><br><span class="line"><span class="keyword">from</span> Patients</span><br><span class="line"><span class="keyword">where</span> conditions <span class="keyword">like</span> <span class="string">&#x27;DIAB1%&#x27;</span> </span><br><span class="line">   or conditions <span class="keyword">like</span> <span class="string">&#x27;% DIAB1%&#x27;</span>;</span><br></pre></td></tr></table></figure><h2 id="36-删除重复的电子邮箱（简单）">36.删除重复的电子邮箱（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-164-1024x681.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-165.png" alt="img"></p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#编写解决方案 删除 所有重复的电子邮件，只保留一个具有最小 id 的唯一电子邮件。</span></span><br><span class="line"><span class="comment">#（对于 SQL 用户，请注意你应该编写一个 DELETE 语句而不是 SELECT 语句。）</span></span><br><span class="line"><span class="comment">#运行脚本后，显示的答案是 Person 表。驱动程序将首先编译并运行您的代码片段，然后再显示 Person 表。Person 表的最终顺序 无关紧要 。</span></span><br><span class="line"><span class="symbol">DELETE</span> <span class="built_in">p1</span> from Person <span class="built_in">p1</span>,</span><br><span class="line"><span class="symbol">Person</span> <span class="built_in">p2</span></span><br><span class="line"><span class="symbol">where</span> <span class="built_in">p1</span>.Email = <span class="built_in">p2</span>.Email <span class="keyword">and</span> <span class="built_in">p1</span>.id &gt; <span class="built_in">p2</span>.id</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-166-1024x607.png" alt="img"></p><h2 id="37-指定日期的产品价格（中等）">37.指定日期的产品价格（中等）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-167.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-168.png" alt="img"></p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#一开始，所有产品价格都为 10。</span></span><br><span class="line"><span class="comment">#编写一个解决方案，找出在 2019-08-16 所有产品的价格。</span></span><br><span class="line"><span class="comment">#如果在 2019-08-16没数据，找表中在 2019-08-16以内中最接近在 2019-08-16的数据，否则置默认值10</span></span><br><span class="line"><span class="symbol">select</span></span><br><span class="line">    <span class="built_in">p1</span>.product_id,</span><br><span class="line">    coalesce(<span class="built_in">p2</span>.new_price,<span class="number">10</span>)   as price</span><br><span class="line"><span class="symbol">from</span>(select distinct product_id from Products)<span class="built_in">p1</span></span><br><span class="line"><span class="symbol">left</span> join Products <span class="built_in">p2</span></span><br><span class="line"><span class="symbol">on</span> <span class="built_in">p1</span>.product_id = <span class="built_in">p2</span>.product_id</span><br><span class="line"><span class="keyword">and</span> <span class="built_in">p2</span>.change_date &lt;= <span class="string">&#x27;2019-08-16&#x27;</span></span><br><span class="line"><span class="comment">#保证p2是最接近2019-08-16的数据</span></span><br><span class="line"><span class="keyword">and</span> not exists(</span><br><span class="line">    select <span class="number">1</span> from Products <span class="built_in">p3</span></span><br><span class="line">    where <span class="built_in">p3</span>.product_id = <span class="built_in">p2</span>.product_id</span><br><span class="line">    <span class="keyword">and</span> <span class="built_in">p3</span>.change_date &lt;= <span class="string">&#x27;2019-08-16&#x27;</span></span><br><span class="line">    <span class="keyword">and</span> <span class="built_in">p3</span>.change_date &gt; <span class="built_in">p2</span>.change_date</span><br><span class="line">)</span><br><span class="line"><span class="symbol">order</span> by <span class="built_in">p1</span>.product_id</span><br></pre></td></tr></table></figure><p><strong>要点</strong></p><ul><li><code>NOT EXISTS</code> 这段用于“每个 product_id 选出 &lt;= 目标日的最后一条”。</li><li>同样用 <code>COALESCE(...,10)</code> 兜底默认价。</li></ul><p><code>COALESCE</code>的用法参考文档：</p><p><a href="https://www.jb51.net/database/3496524u1.htm">MySQL中空值处理COALESCE函数及COALESCE函数使用_Mysql_脚本之家</a></p><p>另一种解法（MySQL 8+，窗口函数）</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> last_change <span class="keyword">AS</span> (</span><br><span class="line">  <span class="keyword">SELECT</span></span><br><span class="line">    product_id,</span><br><span class="line">    new_price,</span><br><span class="line">    ROW_NUMBER() <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> product_id</span><br><span class="line">                       <span class="keyword">ORDER</span> <span class="keyword">BY</span> change_date <span class="keyword">DESC</span>) <span class="keyword">AS</span> rn</span><br><span class="line">  <span class="keyword">FROM</span> Products</span><br><span class="line">  <span class="keyword">WHERE</span> change_date &lt;= <span class="string">&#x27;2019-08-16&#x27;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">  p.product_id,</span><br><span class="line">  COALESCE(lc.new_price, <span class="number">10</span>) <span class="keyword">AS</span> price     <span class="comment">-- 没有记录则用默认价 10</span></span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> product_id <span class="keyword">FROM</span> Products) <span class="keyword">AS</span> p</span><br><span class="line"><span class="keyword">LEFT JOIN</span> last_change lc</span><br><span class="line">  <span class="keyword">ON</span> lc.product_id = p.product_id <span class="keyword">AND</span> lc.rn = <span class="number">1</span>   <span class="comment">-- 取每个产品“最近一次”的那条</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> p.product_id;</span><br></pre></td></tr></table></figure><p><strong>说明</strong></p><ul><li><code>ROW_NUMBER() … PARTITION BY product_id ORDER BY change_date DESC</code>：对每个产品按时间倒序编号，<code>rn=1</code> 就是“该日期之前最近的一次变价”。</li><li><code>WHERE change_date &lt;= '2019-08-16'</code>：只看目标日之前（含当天）的记录。</li><li><code>COALESCE(..., 10)</code>：如果某产品在目标日前没有任何记录，返回默认价 10。</li><li>外层用 <code>Products</code> 的去重 <code>product_id</code> 保证输出覆盖所有出现过的产品。</li></ul><h2 id="38-最后一个能进入巴士的人（中等）">38.最后一个能进入巴士的人（中等）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-169-1024x695.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-170.png" alt="img"></p><p>写法一：自连接</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#编写解决方案找出 最后一个 上巴士且不超过重量限制的乘客，并报告 person_name 。</span></span><br><span class="line"><span class="meta">#题目测试用例确保顺位第一的人可以上巴士且不会超重。</span></span><br><span class="line"><span class="keyword">select</span> person_name </span><br><span class="line"><span class="keyword">from</span> Queue q1</span><br><span class="line"><span class="meta">#找最接近1000的上一次数据，最后要小于1000</span></span><br><span class="line"><span class="keyword">where</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">sum</span>(weight)</span><br><span class="line">    <span class="keyword">from</span> Queue</span><br><span class="line">    <span class="keyword">where</span> turn&lt;=q1.turn</span><br><span class="line">)&lt;=<span class="number">1000</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> turn <span class="keyword">desc</span> limit <span class="number">1</span></span><br></pre></td></tr></table></figure><p>写法二：窗口函数+where in</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> person_name </span><br><span class="line"><span class="keyword">from</span> Queue </span><br><span class="line">#取最后一位</span><br><span class="line"><span class="keyword">where</span> turn <span class="keyword">in</span>(</span><br><span class="line">    <span class="keyword">select</span> <span class="built_in">max</span>(turn)</span><br><span class="line">    <span class="keyword">from</span> (</span><br><span class="line">      <span class="keyword">select</span> turn,person_id,person_name,weight,<span class="built_in">sum</span>(weight) <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> turn) <span class="keyword">as</span> total_weight</span><br><span class="line">      <span class="keyword">from</span> Queue</span><br><span class="line">    ) <span class="keyword">as</span> a</span><br><span class="line">    <span class="keyword">where</span> a.total_weight&lt;=<span class="number">1000</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id="39-按分类统计薪水（中等）">39.按分类统计薪水（中等）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-173.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-174.png" alt="img"></p><p>select 类别+union+sum(case when)</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#查询每个工资类别的银行账户数量。</span><br><span class="line">#结果表 必须 包含所有三个类别。 如果某个类别中没有帐户，则报告 0 。</span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;Low Salary&#x27;</span> <span class="keyword">as</span> category,</span><br><span class="line">    <span class="built_in">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> income&lt;<span class="number">20000</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> accounts_count</span><br><span class="line"><span class="keyword">from</span> accounts</span><br><span class="line"><span class="keyword">union</span> </span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;High Salary&#x27;</span> <span class="keyword">as</span> category,</span><br><span class="line">    <span class="built_in">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> income&gt;<span class="number">50000</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> accounts_count</span><br><span class="line"><span class="keyword">from</span> accounts</span><br><span class="line"><span class="keyword">union</span> </span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;Average Salary&#x27;</span> <span class="keyword">as</span> category,</span><br><span class="line">    <span class="built_in">sum</span>(<span class="keyword">case</span> <span class="keyword">when</span> income&gt;=<span class="number">20000</span> <span class="keyword">and</span> income&lt;=<span class="number">50000</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> accounts_count</span><br><span class="line"><span class="keyword">from</span> accounts</span><br></pre></td></tr></table></figure><p>select目标字段+where过滤条件+union去重合并表</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">&#x27;Low Salary&#x27;</span> <span class="keyword">as</span> category,</span><br><span class="line">    <span class="built_in">count</span>(*) <span class="keyword">as</span> accounts_count</span><br><span class="line"><span class="keyword">from</span> accounts</span><br><span class="line"><span class="keyword">where</span> income&lt;<span class="number">20000</span></span><br><span class="line"><span class="keyword">union</span> </span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;Average Salary&#x27;</span> <span class="keyword">as</span> category,</span><br><span class="line">    <span class="built_in">count</span>(*) <span class="keyword">as</span> accounts_count</span><br><span class="line"><span class="keyword">from</span> accounts</span><br><span class="line"><span class="keyword">where</span> income&lt;=<span class="number">50000</span> <span class="keyword">and</span> income&gt;=<span class="number">20000</span></span><br><span class="line"><span class="keyword">union</span></span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;High Salary&#x27;</span> <span class="keyword">as</span> category,</span><br><span class="line">    <span class="built_in">count</span>(*) <span class="keyword">as</span> accounts_count</span><br><span class="line"><span class="keyword">from</span> accounts</span><br><span class="line"><span class="keyword">where</span> income&gt;<span class="number">50000</span></span><br></pre></td></tr></table></figure><p>ifnull输出0值+union all临时表+left join</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># Write your MySQL query statement below</span><br><span class="line"><span class="keyword">select</span> a.category,</span><br><span class="line">    <span class="built_in">ifnull</span>(<span class="built_in">count</span>(account_id),<span class="number">0</span>) <span class="keyword">as</span> accounts_count</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> <span class="string">&#x27;Low Salary&#x27;</span> <span class="keyword">as</span> category</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span> <span class="keyword">select</span> <span class="string">&#x27;Average Salary&#x27;</span></span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span> <span class="keyword">select</span> <span class="string">&#x27;High Salary&#x27;</span></span><br><span class="line">) <span class="keyword">as</span> a <span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">(<span class="keyword">select</span> </span><br><span class="line">    account_id,</span><br><span class="line">    <span class="keyword">case</span> </span><br><span class="line">        <span class="keyword">when</span> income&lt;<span class="number">20000</span> <span class="keyword">then</span> <span class="string">&#x27;Low Salary&#x27;</span></span><br><span class="line">        <span class="keyword">when</span> income&lt;=<span class="number">50000</span> <span class="keyword">then</span> <span class="string">&#x27;Average Salary&#x27;</span></span><br><span class="line">        <span class="keyword">else</span> <span class="string">&#x27;High Salary&#x27;</span></span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">as</span> category</span><br><span class="line"><span class="keyword">from</span> accounts ) <span class="keyword">as</span> b <span class="keyword">on</span> a.category=b.category</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> a.category</span><br></pre></td></tr></table></figure><h2 id="40-上级经理已离职的公司员工（简单）">40.上级经理已离职的公司员工（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-175-1024x646.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-176-1024x812.png" alt="img"></p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#查找这些员工的id，他们的薪水严格少于$30000 并且他们的上级经理已离职。当一个经理离开公司时，他们的信息需要从员工表中删除掉，但是表中的员工的manager_id  这一列还是设置的离职经理的id 。</span></span><br><span class="line"><span class="meta">#返回的结果按照employee_id 从小到大排序。</span></span><br><span class="line"><span class="keyword">select</span> employee_id</span><br><span class="line"><span class="keyword">from</span> Employees</span><br><span class="line"><span class="keyword">where</span> salary&lt;<span class="number">30000</span> and manager_id not <span class="keyword">in</span>(</span><br><span class="line">    <span class="keyword">select</span> distinct employee_id</span><br><span class="line">    <span class="keyword">from</span> Employees</span><br><span class="line">)</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> employee_id <span class="keyword">asc</span></span><br></pre></td></tr></table></figure><p>写法2</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.employee_id</span><br><span class="line"><span class="keyword">from</span> employees a</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> employees b</span><br><span class="line"><span class="keyword">on</span> a.manager_id=b.employee_id</span><br><span class="line"><span class="keyword">where</span> b.employee_id <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">and</span> a.manager_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">and</span> a.salary&lt;<span class="number">30000</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> a.employee_id</span><br></pre></td></tr></table></figure><h2 id="41-换座位（中等）">41.换座位（中等）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-177.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-178.png" alt="img"></p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#编写解决方案来交换每两个连续的学生的座位号。如果学生的数量是奇数，则最后一个学生的id不交换。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#按 id 升序 返回结果表。</span></span><br><span class="line">select </span><br><span class="line">case</span><br><span class="line">    when <span class="built_in">id</span>%<span class="number">2</span> = <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">id</span>&lt;(select max(<span class="built_in">id</span>) <span class="keyword">from</span> Seat)<span class="keyword">then</span> <span class="built_in">id</span>+<span class="number">1</span></span><br><span class="line">    when <span class="built_in">id</span>%<span class="number">2</span> = <span class="number">0</span> <span class="keyword">then</span> <span class="built_in">id</span><span class="number">-1</span></span><br><span class="line">    <span class="keyword">else</span> <span class="built_in">id</span></span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">as</span> <span class="built_in">id</span>,</span><br><span class="line">    student</span><br><span class="line"><span class="keyword">from</span> Seat</span><br><span class="line">order <span class="keyword">by</span> <span class="built_in">id</span></span><br></pre></td></tr></table></figure><ul><li><code>id % 2 = 1</code>：说明是奇数编号 → 一般换到后面一个座位 (<code>id+1</code>)。</li><li><code>id &lt; (SELECT MAX(id) FROM Seat)</code>：保证不是最后一个人，否则不要动。</li><li><code>id % 2 = 0</code>：说明是偶数编号 → 换到前一个座位 (<code>id-1</code>)。</li><li><code>ELSE id</code>：处理最后一个奇数 id 的情况，保持不变。</li><li>最后 <code>ORDER BY id</code>，按照交换后的顺序输出结果。</li></ul><h2 id="42-电影评分（中等）">42.电影评分（中等）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-179.png" alt="img"></p><p>请你编写一个解决方案：</p><ul><li>查找评论电影数量最多的用户名。如果出现平局，返回字典序较小的用户名。</li><li>查找在 <code>February 2020</code> <strong>平均评分最高</strong> 的电影名称。如果出现平局，返回字典序较小的电影名称。</li></ul><p><strong>字典序</strong> ，即按字母在字典中出现顺序对字符串排序，字典序较小则意味着排序靠前。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-180-875x1024.png" alt="img"></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">Write</span> your MySQL query <span class="keyword">statement</span> below</span><br><span class="line">#查找评论电影数量最多的用户名(<span class="keyword">desc</span>)。如果出现平局，返回字典序较小的用户名。(<span class="keyword">asc</span>)</span><br><span class="line">#查找在 February <span class="number">2020</span> 平均评分最高 的电影名称。如果出现平局，返回字典序较小的电影名称。</span><br><span class="line">#字典序 ，即按字母在字典中出现顺序对字符串排序，字典序较小则意味着排序靠前。</span><br><span class="line"><span class="meta">#1.先查评论电影数量最多的用户名(desc)。</span></span><br><span class="line">(<span class="keyword">select</span> u.name <span class="keyword">as</span> results </span><br><span class="line"><span class="keyword">from</span> Users u</span><br><span class="line"><span class="keyword">left join</span> MovieRating mr </span><br><span class="line"><span class="keyword">on</span> u.user_id  = mr.user_id</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> u.user_id </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> count(*)<span class="keyword">desc</span>,<span class="type">name</span> <span class="keyword">asc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">1</span>)</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="meta">#2.再查在 February 2020 平均评分最高 的电影名称</span></span><br><span class="line">(<span class="keyword">select</span> title <span class="keyword">as</span> results</span><br><span class="line"><span class="keyword">from</span> Movies m</span><br><span class="line"><span class="keyword">left join</span> MovieRating mr <span class="keyword">on</span> m.movie_id = mr.movie_id <span class="keyword">and</span> year(mr.created_at) = <span class="number">2020</span> <span class="keyword">and</span> month(mr.created_at)=<span class="number">2</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> mr.movie_id</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> Avg(mr.rating)<span class="keyword">desc</span>,title <span class="keyword">asc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">1</span>)</span><br></pre></td></tr></table></figure><h2 id="43-餐馆营业额变化增长（中等）">43.餐馆营业额变化增长（中等）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-181-1024x679.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-182-1024x833.png" alt="img"></p><p>窗口函数</p><p>语法：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[你要的操作] <span class="keyword">OVER</span> ( <span class="keyword">PARTITION</span> <span class="keyword">BY</span>  &lt;用于分组的列名&gt;</span><br><span class="line">                    <span class="keyword">ORDER</span> <span class="keyword">BY</span> &lt;按序叠加的列名&gt; </span><br><span class="line">                    <span class="keyword">ROWS</span>|RANGE &lt;窗口滑动的数据范围&gt; )</span><br></pre></td></tr></table></figure><p>&lt;窗口滑动的数据范围&gt; 用来限定 [你要的操作] 所运用的数据的范围，具体有如下这些：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">当前 - <span class="keyword">current</span> <span class="keyword">row</span></span><br><span class="line">之前的 - <span class="keyword">preceding</span></span><br><span class="line">之后的 - <span class="keyword">following</span></span><br><span class="line">无界限 - <span class="keyword">unbounded</span></span><br><span class="line">表示从前面的起点 - <span class="keyword">unbounded</span> <span class="keyword">preceding</span></span><br><span class="line">表示到后面的终点 - <span class="keyword">unbounded</span> <span class="keyword">following</span></span><br></pre></td></tr></table></figure><p>举例</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">取当前行和前五行：<span class="keyword">ROWS</span> <span class="keyword">between</span> <span class="number">5</span> preceding <span class="keyword">and</span> <span class="keyword">current</span> <span class="type">row</span> <span class="comment">--共6行</span></span><br><span class="line">取当前行和后五行：<span class="keyword">ROWS</span> <span class="keyword">between</span> <span class="keyword">current</span> <span class="type">row</span> <span class="keyword">and</span> <span class="number">5</span> following <span class="comment">--共6行</span></span><br><span class="line">取前五行和后五行：<span class="keyword">ROWS</span> <span class="keyword">between</span> <span class="number">5</span> preceding <span class="keyword">and</span> <span class="number">5</span> following <span class="comment">--共11行</span></span><br><span class="line">取当前行和前六行：<span class="keyword">ROWS</span> <span class="number">6</span> preceding（等价于between...and <span class="keyword">current</span> <span class="type">row</span>） <span class="comment">--共7行</span></span><br><span class="line">这一天和前面<span class="number">6</span>天：<span class="keyword">RANGE</span> <span class="keyword">between</span> <span class="type">interval</span> <span class="number">6</span> <span class="keyword">day</span> preceding <span class="keyword">and</span> <span class="keyword">current</span> <span class="type">row</span> <span class="comment">--共7天</span></span><br><span class="line">这一天和前面<span class="number">6</span>天：<span class="keyword">RANGE</span> <span class="type">interval</span> <span class="number">6</span> <span class="keyword">day</span> preceding（等价于between...and <span class="keyword">current</span> <span class="type">row</span>） <span class="comment">--共7天</span></span><br><span class="line">字段值落在当前值<span class="number">-100</span>到<span class="operator">+</span><span class="number">200</span>的区间：<span class="keyword">RANGE</span> <span class="keyword">between</span> <span class="number">100</span> preceding <span class="keyword">and</span> <span class="number">200</span> following  <span class="comment">--共301个数值</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> visited_on,</span><br><span class="line">sum_amount <span class="keyword">as</span> amount,  </span><br><span class="line">Round(sum_amount <span class="operator">/</span><span class="number">7</span>,<span class="number">2</span>) <span class="keyword">as</span> average_amount </span><br><span class="line"><span class="keyword">from</span>(</span><br><span class="line">    <span class="keyword">select</span> visited_on,<span class="built_in">Sum</span>(amount)<span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> visited_on <span class="keyword">range</span> <span class="type">interval</span> <span class="number">6</span> <span class="keyword">day</span> preceding) <span class="keyword">as</span> sum_amount</span><br><span class="line">    <span class="keyword">from</span> Customer</span><br><span class="line">)t</span><br><span class="line"><span class="keyword">where</span> datediff(visited_on,(<span class="keyword">select</span> <span class="built_in">min</span>(visited_on)<span class="keyword">from</span> Customer))<span class="operator">&gt;=</span><span class="number">6</span></span><br></pre></td></tr></table></figure><p>这里分为三层逻辑：</p><ol><li><strong>子查询部分 (<code>select visited_on, Sum(amount) over(...)</code>)</strong><br>使用窗口函数 <code>Sum(amount) over(...)</code>，计算<strong>当前日期往前 6 天（含当日）共 7 天</strong>的消费总额。</li><li><strong>外层包裹的查询 (<code>from (...) t</code>)</strong><br>直接把 <code>sum_amount</code> 带出来，并且结合 <code>visited_on</code>。</li><li>最外层查询<ul><li>用 <code>distinct visited_on</code>，保证每一天只返回一条结果；</li><li>计算 7 天平均值：<code>Round(sum_amount /7, 2)</code>；</li><li>用 <code>where</code> 筛选掉前 6 天（因为不足 7 天没法算完整窗口）。</li></ul></li></ol><p>(1) <code>Sum(amount) over(order by visited_on range interval 6 day preceding)</code></p><ul><li><p>这是一个</p><p>窗口函数</p><p>，窗口范围是：</p><ul><li>从当前行的 <code>visited_on</code> 往前推 6 天；</li><li>一直到当前 <code>visited_on</code> 这一天；</li><li>相当于一个滚动 7 天窗口。</li></ul></li><li><p>例如：</p><ul><li>当前行日期是 <code>2019-01-07</code>，窗口范围是 <code>2019-01-01 ~ 2019-01-07</code>；</li><li>当前行日期是 <code>2019-01-08</code>，窗口范围是 <code>2019-01-02 ~ 2019-01-08</code>。</li></ul></li></ul><p>这一步就实现了「累计近 7 天的总消费额」。</p><p>(2) <code>datediff(visited_on,(select min(visited_on) from Customer)) &gt;= 6</code></p><ul><li><code>datediff</code> 计算「当前行日期 - 最早日期」的天数；</li><li><code>&gt;= 6</code> 意味着：至少是第 7 天以后，才能算出完整 7 天的窗口。</li></ul><p>例如：</p><ul><li>最早日期是 <code>2019-01-01</code>；</li><li>那么 <code>2019-01-01 ~ 2019-01-06</code> 都不足 7 天，不会输出；</li><li>从 <code>2019-01-07</code> 开始，才能得到第一个合法窗口。</li></ul><p>(3) <code>Round(sum_amount /7, 2)</code></p><ul><li>把总额除以 7，得到平均消费额；</li><li><code>Round(..., 2)</code> 保留两位小数。</li></ul><p>(4) <code>distinct visited_on</code></p><ul><li>每个 <code>visited_on</code> 可能有多个顾客记录（因为表里每个顾客每天一条记录），会导致窗口计算出来的 <code>sum_amount</code> 在当天有重复；</li><li>加上 <code>distinct</code> 确保一个日期只保留一条结果。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-185.png" alt="img"></p><p><a href="https://blog.csdn.net/hello_boyu/article/details/137920001">MySQL中Interval关键字的使用，看这一篇就够啦_mysql interval-CSDN博客</a></p><p>自连接</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">SELECT</span><br><span class="line"><span class="selector-tag">a</span><span class="selector-class">.visited_on</span>,</span><br><span class="line"><span class="built_in">sum</span>( <span class="selector-tag">b</span><span class="selector-class">.amount</span> ) AS amount,</span><br><span class="line"><span class="built_in">round</span>(<span class="built_in">sum</span>( <span class="selector-tag">b</span><span class="selector-class">.amount</span> ) / <span class="number">7</span>, <span class="number">2</span> ) AS average_amount </span><br><span class="line">FROM</span><br><span class="line">( SELECT DISTINCT visited_on FROM customer ) <span class="selector-tag">a</span> JOIN customer <span class="selector-tag">b</span> </span><br><span class="line"> ON <span class="built_in">datediff</span>( <span class="selector-tag">a</span><span class="selector-class">.visited_on</span>, <span class="selector-tag">b</span><span class="selector-class">.visited_on</span> ) BETWEEN <span class="number">0</span> AND <span class="number">6</span> </span><br><span class="line">WHERE</span><br><span class="line"><span class="selector-tag">a</span><span class="selector-class">.visited_on</span> &gt;= (SELECT <span class="built_in">min</span>( visited_on ) FROM customer ) + <span class="number">6</span> </span><br><span class="line">GROUP BY</span><br><span class="line"><span class="selector-tag">a</span><span class="selector-class">.visited_on</span></span><br><span class="line">ORDER BY</span><br><span class="line">  <span class="selector-tag">a</span>.visited_on</span><br></pre></td></tr></table></figure><h2 id="44-按日期分组销售产品（简单）">44.按日期分组销售产品（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-183.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-186-1024x717.png" alt="img"></p><p><em>GROUP_CONCAT</em>() 是MySQL 中的一个聚合函数，用于将分组后的多行数据合并成一个字符串。</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#编写解决方案找出每个日期、销售的不同产品的数量及其名称。</span><br><span class="line">#每个日期的销售产品名称应按词典序排列。</span><br><span class="line">#返回按 sell_date 排序的结果表。</span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    sell_date,</span><br><span class="line">    <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span>(product)) <span class="keyword">AS</span> num_sold, </span><br><span class="line">    GROUP_CONCAT(<span class="keyword">DISTINCT</span> product <span class="keyword">ORDER</span> <span class="keyword">BY</span> product SEPARATOR <span class="string">&#x27;,&#x27;</span>) <span class="keyword">AS</span> products</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">    Activities</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">    sell_date</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> </span><br><span class="line">    sell_date <span class="keyword">ASC</span></span><br></pre></td></tr></table></figure><h2 id="45-列出指定时间段内所有的下单产品（简单）">45.列出指定时间段内所有的下单产品（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-187.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-188.png" alt="img"></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#要求获取在 2020 年 2 月份下单的数量不少于 100 的产品的名字和数目。</span><br><span class="line"><span class="keyword">select</span> p.product_name,<span class="built_in">sum</span>(o.unit)<span class="keyword">as</span> unit</span><br><span class="line"><span class="keyword">from</span> Products p</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> Orders o <span class="keyword">on</span> p.product_id = o.product_id</span><br><span class="line"><span class="keyword">where</span> o.order_date <span class="keyword">like</span> <span class="string">&#x27;2020-02%&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> p.product_id</span><br><span class="line"><span class="keyword">having</span> unit&gt;=<span class="number">100</span></span><br></pre></td></tr></table></figure><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> p.product_name,o.unit</span><br><span class="line"><span class="keyword">from</span> products <span class="keyword">AS</span> p</span><br><span class="line">JOI<span class="meta">N</span>(</span><br><span class="line">    <span class="keyword">select</span> product_id,<span class="meta">sum</span>(unit) <span class="keyword">AS</span> unit</span><br><span class="line">    <span class="keyword">from</span> orders</span><br><span class="line">    <span class="keyword">where</span> <span class="meta">year</span>(order_date) = 2020 <span class="keyword">and</span> <span class="meta">month</span>(order_date) = 2</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> product_id</span><br><span class="line">    <span class="keyword">having</span> <span class="meta">sum</span>(unit) &gt;=100</span><br><span class="line">) </span><br><span class="line"><span class="keyword">AS</span> o </span><br><span class="line"><span class="keyword">ON</span> p.product_id = o.product_id;</span><br></pre></td></tr></table></figure><h2 id="46-查找拥有有效邮箱的用户（简单）">46.查找拥有有效邮箱的用户（简单）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-189-1024x664.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-190.png" alt="img"></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#编写一个解决方案，以查找具有有效电子邮件的用户。</span><br><span class="line"><span class="keyword">select</span> user_id,name,mail</span><br><span class="line"><span class="keyword">from</span> Users</span><br><span class="line"><span class="keyword">where</span> <span class="built_in">regexp_like</span>(mail,<span class="string">&#x27;^[a-zA-Z][a-zA-Z0-9._-]*@leetcode\\.com$&#x27;</span>,<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> users <span class="keyword">where</span> mail <span class="keyword">collate</span> utf8_bin REGEXP <span class="string">&#x27;^[a-zA-Z][a-zA-Z0-9\_\.\-]*@leetcode\\.com$&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="47-好友申请II：谁有最多的好友（中等）">47.好友申请II：谁有最多的好友（中等）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-191.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-192.png" alt="img"></p><ul><li><p>找出拥有最多好友的用户及其好友数。</p></li><li><p>即统计每个id在request_id 和accepter_id中出现的次数和。</p></li><li><p>每个人都可能发送好友请求，接收好友请求。好友数是统计每个id在接收好友请求和发送好友请求时所有的用户数。</p></li></ul><p>union all不去重合并两张表，group by分组+order by排序+limit限制+子查询外count(*)行数</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#编写解决方案，找出拥有最多的好友的人和他拥有的好友数目。</span><br><span class="line"><span class="keyword">select</span> a.id <span class="keyword">as</span> id, <span class="built_in">count</span>(*) <span class="keyword">as</span> num </span><br><span class="line">#统计统计每个id在request_id 和accepter_id中出现的次数和。</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> requester_id id </span><br><span class="line">    <span class="keyword">from</span> RequestAccepted</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> accepter_id ids </span><br><span class="line">    <span class="keyword">from</span> RequestAccepted</span><br><span class="line">) <span class="keyword">as</span> a</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> id </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> num <span class="keyword">desc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><p>子查询内先求好友数，然后union，最后再sum求和</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    ids <span class="keyword">as</span> id,<span class="built_in">sum</span>(nums) <span class="keyword">as</span> num</span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span> </span><br><span class="line">        requester_id <span class="keyword">as</span> ids,</span><br><span class="line">        <span class="built_in">count</span>(*) <span class="keyword">as</span> nums</span><br><span class="line">    <span class="keyword">from</span> RequestAccepted</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> ids</span><br><span class="line">    <span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line">    <span class="keyword">select</span> </span><br><span class="line">        accepter_id <span class="keyword">as</span> ids,</span><br><span class="line">        <span class="built_in">count</span>(*) <span class="keyword">as</span> nums</span><br><span class="line">    <span class="keyword">from</span> RequestAccepted</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> ids</span><br><span class="line">) <span class="keyword">as</span> a</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> id</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> num <span class="keyword">desc</span></span><br><span class="line"><span class="keyword">limit</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><h2 id="48-第二高的薪水（中等）">48.第二高的薪水（中等）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-193-1024x431.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-194.png" alt="img"></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#查询并返回 Employee 表中第二高的 不同 薪水 。如果不存在第二高的薪水，查询应该返回 <span class="keyword">null</span>(Pandas 则返回 <span class="keyword">None</span>) 。</span><br><span class="line"><span class="keyword">select</span> ifnull</span><br><span class="line">(</span><br><span class="line">  (<span class="keyword">select</span> <span class="keyword">distinct</span> salary</span><br><span class="line">  <span class="keyword">from</span> Employee </span><br><span class="line">  <span class="keyword">order</span> <span class="keyword">by</span> Salary <span class="keyword">Desc</span></span><br><span class="line">  <span class="keyword">limit</span> <span class="number">1</span>,<span class="number">1</span>),<span class="keyword">null</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">as</span> SecondHighestSalary</span><br></pre></td></tr></table></figure><p>自连接做法</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(E2.salary) <span class="keyword">as</span> SecondHighestSalary </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">Employee <span class="keyword">as</span> E1 <span class="keyword">left</span> <span class="keyword">join</span> Employee <span class="keyword">as</span> E2</span><br><span class="line"><span class="keyword">on</span> E1.salary &gt; E2.salary</span><br></pre></td></tr></table></figure><ul><li>将表自连接的时候设置了 E1.salary &gt; E2.salary，在这种情况下，每行E1里面的工资都比E2的工资高，对应着的就是第一＞第二、第二＞第三、第三＞第四……，只要取E2里面的工资最大值，这个值肯定就是第二高的工资</li><li>类似去最大 取最大</li></ul><p>去最大 取最大</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">max</span>(salary) <span class="keyword">as</span> SecondHighestSalary </span><br><span class="line"><span class="keyword">from</span> Employee</span><br><span class="line"><span class="keyword">where</span> salary &lt; (<span class="keyword">select</span> <span class="built_in">max</span>(salary) <span class="keyword">from</span> Employee);</span><br></pre></td></tr></table></figure><ul><li>子查询查出最大 where排除最大</li><li>max()重新提取最大 null值有max不用考虑</li></ul><h2 id="49-2016年的投资（中等）">49.2016年的投资（中等）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-196-1024x672.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-195.png" alt="img"></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#编写解决方案报告 <span class="number">2016</span> 年 (tiv_2016) 所有满足下述条件的投保人的投保金额之和：</span><br><span class="line">#他在 <span class="number">2015</span> 年的投保额 (tiv_2015) 至少跟一个其他投保人在 <span class="number">2015</span> 年的投保额相同。</span><br><span class="line">#他所在的城市必须与其他投保人都不同（也就是说 (lat, lon) 不能跟其他任何一个投保人完全相同）。</span><br><span class="line"><span class="meta">#tiv_2016 四舍五入的 两位小数 。</span></span><br><span class="line"><span class="keyword">select</span> round(sum(tiv_2016), <span class="number">2</span>) tiv_2016</span><br><span class="line"> <span class="keyword">from</span> insurance</span><br><span class="line">  <span class="keyword">where</span> tiv_2015 <span class="keyword">in</span> </span><br><span class="line">(</span><br><span class="line"><span class="keyword">select</span> tiv_2015 <span class="keyword">from</span> insurance <span class="keyword">group</span> <span class="keyword">by</span> tiv_2015 <span class="keyword">having</span> count(*) &gt; <span class="number">1</span></span><br><span class="line">) <span class="keyword">and</span> concat(lat, lon) <span class="keyword">in</span></span><br><span class="line"> (</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">concat(lat, lon)</span><br><span class="line"><span class="keyword">from</span> insurance <span class="keyword">group</span> <span class="keyword">by</span> lat, lon <span class="keyword">having</span> count(*) = <span class="number">1</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-197-1024x696.png" alt="img"></p><h2 id="50-部门工资前三高的所有员工（困难）">50.部门工资前三高的所有员工（困难）</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-198-1024x833.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-199-426x1024.png" alt="img"></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#公司的主管们感兴趣的是公司每个部门中谁赚的钱最多。一个部门的 高收入者 是指一个员工的工资在该部门的 不同 工资中 排名前三 。</span><br><span class="line"></span><br><span class="line">#编写解决方案，找出每个部门中 收入高的员工 。</span><br><span class="line"><span class="keyword">select</span> d.name <span class="keyword">as</span> Department,e1.name <span class="keyword">as</span> Employee,e1.salary <span class="keyword">as</span> Salary</span><br><span class="line"><span class="keyword">from</span> Employee e1</span><br><span class="line"><span class="keyword">left join</span> Department d <span class="keyword">on</span> </span><br><span class="line">e1.departmentId = d.id   </span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">(   #查询工资中 排名前三</span><br><span class="line">    <span class="keyword">select</span> count(<span class="keyword">distinct</span> e2.salary)</span><br><span class="line">    <span class="keyword">from</span> Employee e2</span><br><span class="line">    <span class="keyword">where</span> e2.salary&gt;e1.salary <span class="keyword">and</span> e1.departmentId = e2.departmentId</span><br><span class="line">)&lt;<span class="number">3</span></span><br></pre></td></tr></table></figure><p>窗口函数</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">解题思路:先对Employee表进行部门分组工资排名，再关联Department表查询部门名称，再使用WHERE筛选出排名小于等于3的数据（也就是每个部门排名前3的工资）。</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">B.Name <span class="keyword">AS</span> Department,</span><br><span class="line">A.Name <span class="keyword">AS</span> Employee,</span><br><span class="line">A.Salary</span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">SELECT</span> DENSE_RANK() <span class="keyword">OVER</span> (<span class="keyword">partition</span> <span class="keyword">by</span> DepartmentId <span class="keyword">order</span> <span class="keyword">by</span> Salary <span class="keyword">desc</span>) <span class="keyword">AS</span> ranking,DepartmentId,<span class="type">Name</span>,Salary</span><br><span class="line">      <span class="keyword">FROM</span> Employee) <span class="keyword">AS</span> A</span><br><span class="line"><span class="keyword">JOIN</span> Department <span class="keyword">AS</span> B <span class="keyword">ON</span> A.DepartmentId=B.id</span><br><span class="line"><span class="keyword">WHERE</span> A.ranking&lt;=<span class="number">3</span></span><br></pre></td></tr></table></figure><h1 id="高频SQL-50-完结-用时22天">高频SQL 50 完结-用时22天</h1>]]></content>
    
    
    <summary type="html">leetcode高频sql top50</summary>
    
    
    
    <category term="算法" scheme="https://itgeqian.github.io/categories/%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="leetcode" scheme="https://itgeqian.github.io/tags/leetcode/"/>
    
  </entry>
  
  <entry>
    <title>AIGC应用与智能体开发之大模型私有部署</title>
    <link href="https://itgeqian.github.io/posts/50.html"/>
    <id>https://itgeqian.github.io/posts/50.html</id>
    <published>2025-09-03T03:19:03.000Z</published>
    <updated>2025-09-04T07:03:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="一-大模型私有部署">一.大模型私有部署</h1><h2 id="1-学习目标与AIGC相关概念">1.学习目标与AIGC相关概念</h2><p>今天的学习内容中主要包含了以下内容：</p><ul><li>了解人工智能</li><li>Ollama的介绍与使用</li><li>快速构建企业聊天机器人</li><li>快速构建企业知识库</li><li>快速构建企业Codepilot</li><li>如何制作一个私有化的大模型并部署</li><li>作业练习（基于Ollama快速构建OpenWebUI）</li></ul><p>总学习目标：</p><ul><li>通过对大模型私有化部署的学习，能够在未来的AI项目中熟练搭建或应用AI大模型的开发、测试、生产等环境。以及快速为企业内部搭建私有化的知识库。</li></ul><p>阶段学习目标：</p><ul><li>能够使用Ollama私有化部署本地大模型</li><li>能够熟练使用Ollama的客户端命令</li><li>能够熟悉Ollama提供的API接口</li><li>能够使用Ollama快速搭建ChatBot</li><li>能够使用Ollama快速搭建知识库应用</li><li>能够使用Ollama快速搭建Codepilot应用</li></ul><h3 id="1-学习路线">1.学习路线</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/AIGC%E5%BA%94%E7%94%A8%E4%B8%8E%E6%99%BA%E8%83%BD%E4%BD%93%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF-386x1024.png" alt="img"></p><h3 id="2-业务架构">2.业务架构</h3><p>JavaAIGC 应用与智能体开发课程以小案例驱动学习相关技术知识，因此本课程中的案例业务不是一个大而完整的长业务，而是独立的、在企业中常用的小业务，这样设计我们便于快速学习与理解相关AI知识。</p><p>课程中的业务案例一共分为四个部分：</p><ul><li>日常工具业务：综合了日常企业中常用的AI工具集，提供ChatBot机器人聊天、基于知识库的聊天、以及Codepilot智能代码生成等工具的业务案例功能</li><li>星语智能客服：在传统客服中，加入AI功能，支持机器人客服、可以有效的降低客服成本，并增加行业对话话术模型、增强工具等功，提高服务服务质量</li><li>星图AI业务：通过AI技术，让文字生成对应的文档素材图片，降低用户查找素材成本，还可提供图片修复、放大等第门槛的图片编辑功能</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240929181103184-1024x585.png" alt="img"></p><h3 id="3-技术架构">3.技术架构</h3><p>课程中用到的技术可以分为8层：</p><ul><li>应用层（APP Layer）: 直接使用成熟的开源工具LobeChat，MaxKB，Continue等来快速搭建用户可视化操作界面</li><li>界面层（UI Layer）：项目中所有前端界面都采用Vue3相关技术栈进行开发</li><li>负载层（LB Layer）：负载通过Nginx来实现反向代理和负载均衡</li><li>服务层（Service Layer）：通过Spring Boot来快速构建项目，然后通过SpringAI / LangChain4j来实现相关AI功能的的开发</li><li>工具层（Tool Layer）：AI软件开发过程中会用到很对外置工具，用来对AI内容进行前后置处理，比如通过TIke、PdfBox来ELT清洗文档数据，然后传入AI对话</li><li>数据层（Data Layer）：课程中使用Redis和ES、Mysql来存储或缓存关系数据，而使用Milvus来存储AI向量相关的内容</li><li>运维层（DevOps Layer）：课程中全面使用Docker来构建开发环境</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240618102154610-1024x739.png" alt="img"></p><h2 id="2-导入虚拟机">2.导入虚拟机</h2><p>在当前linux系统中包含的开发环境有：</p><ul><li>Mysql：开发环境的数据库</li><li>Redis：开发环境的redis</li><li>Docker：开发环境的部署工具</li><li>nginx ：代理服务</li></ul><h3 id="挂载虚拟机">挂载虚拟机</h3><p>解压《JavaAIGC虚拟机.zip》文件，解压后，进入解压的虚拟机镜像文件夹，双击<strong>AIGC.vmx</strong>即可挂载到你的虚拟机中（需提前安装虚拟机）。</p><h3 id="设置虚拟网络">设置虚拟网络</h3><p><strong>因为此虚拟机已设置静态的ip地址，目前网段就是192.168.100.0</strong>，所以为了减少环境网络的配置，可以手动设置虚拟机中NAT网卡的网段</p><p>设置步骤：</p><p>①：找到虚拟机的编辑按钮，打开<code>虚拟网络编辑器</code></p><p>②：选中NAT模式的网卡，在下面的子网IP的输入框中<strong>手动</strong>设置为：<code>192.168.100.0</code>,确定保存即可</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-43-1024x458.png" alt="img"></p><p>③：右键虚拟机–&gt;设置–&gt;网络适配器–&gt;自定义：选择<strong>NAT网卡</strong>连接模式</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-45-1024x595.png" alt="img"></p><p>④：启动服务器（网络设置完成后再启动服务器）</p><h3 id="FinalShell客户端链接">FinalShell客户端链接</h3><p><strong>此虚拟机的静态ip为：192.168.100.129</strong>，防火墙已关闭，可以直接使用客户端链接</p><p>以FinalSehll工具为例：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20230818102808038.png" alt="img"></p><p>注意：此虚拟机的用户名：root，密码：itcast</p><h3 id="内置环境说明">内置环境说明</h3><p>在虚拟机中/root目录中内置了两套环境：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240907145210063.png" alt="img"></p><ul><li>data是数据库、代码仓库等重要数据，千万勿删！！</li><li>demo是整体项目演示的环境，方便大家快速启动查看项目效果，可选择删除。</li><li>dev是开环境的环境，本课程学习过程需要用到的环境，千万勿删！！</li><li>docker是后续学习过程中用到的系列镜像文件，千万勿删！！</li><li>ollama是后续学习本地大模型的存储文件，千万勿删！！</li><li>resource是后续用到的系列软件资源，千万勿删！！</li></ul><h2 id="3-私有大模型">3.私有大模型</h2><h3 id="为什么要有私有大模型？">为什么要有私有大模型？</h3><p><strong>企业数据隐私与安全的问题</strong>，在许多行业，如金融、医疗、政府等，数据隐私和安全是至关重要的。使用公共大模型可能涉及敏感数据的泄露风险，因为公共模型在训练过程中可能接触到了来自不同来源的敏感数据。因此就有了私有大模型的市场需求，私有大模型允许企业或机构在自己的数据上训练模型，而且训练的结果只供内部或合作伙伴使用，从而确保了数据隐私和安全。</p><h3 id="私有大模型解决方案">私有大模型解决方案</h3><p>随着AI的发展，越来越多的开发者投入到大模型开发中，他们期望能自身笔记本上运行大模型，以便开发。越来越多的企业积极改造自身产品，融入AI技术，他们期望能私有化大模型以保证数据安全。这些诉求直接推动社区出现了两个这方面的产品Ollama和LMstudio。</p><p>这两个产品各有优势：</p><table><thead><tr><th></th><th>Ollama</th><th>LM Studio</th></tr></thead><tbody><tr><td><strong>产品定位</strong></td><td><strong>开源</strong>的大型语言模型本地运行框架</td><td><strong>闭源</strong>的本地大型语言模型工作站，集模型训练、部署、调试于一体</td></tr><tr><td><strong>技术特点</strong></td><td>- 高度智能化，自主学习和适应能力强 - 便捷性高，操作简单易懂 - 安全性强，数据传输和存储严格保护</td><td>- 高性能，采用先进计算架构和算法优化 - 可定制化，支持用户定制模型结构和训练策略 - 易用性，友好的用户界面和丰富的文档支持</td></tr><tr><td><strong>功能</strong></td><td>- 提供预训练模型访问和微调功能 - 支持多种模型架构和定制模型 - 用户友好界面，简化模型实验和部署过程</td><td>- 丰富的训练数据和算法库 - 可视化训练监控界面 - 强大的调试工具，支持模型性能优化</td></tr><tr><td><strong>应用场景</strong></td><td>- 学术研究 - 开发者原型设计和实验 - 创意写作、文本生成等</td><td>- 智能客服 - 自然语言处理（如文本分类、情感分析、机器翻译） - 学术研究</td></tr><tr><td><strong>用户友好性</strong></td><td>- 界面化操作，适合不同水平的用户 - 支持多种设备和平台</td><td>- 友好的用户界面，适合初学者和非技术人员 - 提供全面的工具组合，易于上手</td></tr><tr><td><strong>定制性</strong></td><td>- 提供一定程度的定制选项，但可能有限制</td><td>- 高度可定制化，满足用户个性化需求</td></tr><tr><td><strong>资源要求</strong></td><td>- 需要一定的内存或显存资源来运行大型模型 - 支持跨平台（macOS、Linux，Windows预览版）</td><td>- 构建和训练复杂模型可能需要大量计算资源和专业技能</td></tr><tr><td><strong>成本</strong></td><td>- 成本可能根据使用量和资源需求变化 - 开源项目，可能涉及较少的直接成本</td><td>- 闭源产品，成本可能包括软件许可和可能的云服务费用</td></tr><tr><td><strong>社区生态</strong></td><td>- 社区生态活跃，开发者主流本地运行时 - 快速适配新发布的模型</td><td>- 未知（未提及具体社区生态活跃度）</td></tr></tbody></table><p>Ollama 作为一个开源的轻量级工具，适合熟悉命令行界面的开发人员和高级用户进行模型实验和微调。它提供了广泛的预训练模型和灵活的定制选项，同时保持了高度的便捷性和安全性。最重要它是开源的，同时还提供API，对于开发有先天优势，因此在企业中备受欢迎和使用，因此本课程也才主要学习Ollama技术。</p><h2 id="4-Ollama-入门">4.Ollama 入门</h2><p>Ollama：是一款旨在简化大型语言模型本地部署和运行过程的开源软件。</p><p>网址：<a href="https://ollama.com/">https://ollama.com/</a></p><p>Ollama提供了一个轻量级、易于扩展的框架，让开发者能够在本地机器上轻松构建和管理LLMs（大型语言模型）。通过Ollama，开发者可以访问和运行一系列预构建的模型，或者导入和定制自己的模型，无需关注复杂的底层实现细节。</p><p>Ollama的主要功能包括快速部署和运行各种大语言模型，如Llama 2、Code Llama等。它还支持从GGUF、PyTorch或Safetensors格式导入自定义模型，并提供了丰富的API和CLI命令行工具，方便开发者进行高级定制和应用开发。</p><p><strong>特点：</strong></p><ul><li><strong>一站式管理</strong>：Ollama将模型权重、配置和数据捆绑到一个包中，定义成Modelfile，从而优化了设置和配置细节，包括GPU使用情况。这种封装方式使得用户无需关注底层实现细节，即可快速部署和运行复杂的大语言模型。</li><li><strong>热加载模型文件</strong>：支持热加载模型文件，无需重新启动即可切换不同的模型，这不仅提高了灵活性，还显著增强了用户体验。</li><li><strong>丰富的模型库</strong>：提供多种预构建的模型，如Llama 2、Llama 3、通义千问等，方便用户快速在本地运行大型语言模型。</li><li><strong>多平台支持</strong>：支持多种操作系统，包括Mac、Windows和Linux，确保了广泛的可用性和灵活性。</li><li><strong>无复杂依赖</strong>：通过优化推理代码并减少不必要的依赖，Ollama能够在各种硬件上高效运行，包括纯CPU推理和Apple Silicon架构。</li><li><strong>资源占用少</strong>：Ollama的代码简洁明了，运行时占用资源少，使其能够在本地高效运行，不需要大量的计算资源。</li></ul><h3 id="1-下载与安装">1.下载与安装</h3><h4 id="手动安装">手动安装</h4><blockquote><p>Ollama共支持三种平台：</p><ul><li>window：<a href="https://ollama.com/download/OllamaSetup.exe">https://ollama.com/download/OllamaSetup.exe</a></li><li>mac：<a href="https://ollama.com/download/Ollama-darwin.zip">https://ollama.com/download/Ollama-darwin.zip</a></li><li>linux：<a href="https://ollama.com/download/ollama-linux-amd64">https://ollama.com/download/ollama-linux-amd64</a></li></ul></blockquote><p>window和mac版本直接下载安装或解压即可使用。这里由于Ollama需要安装在linux中，因此在这里主要学习如何在Linux上安装：</p><blockquote><p>Step 1. 安装</p></blockquote><p>在虚拟机/root/resource目录中已经下载好Linux版本所需的ollama-linux-amd64.tgz文件，则执行下面命令开始安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -C /usr -xzf ollama-linux-amd64.tgz</span><br></pre></td></tr></table></figure><p>操作成功之后，可以通过查看版本指令来验证是否安装成功</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon resource]<span class="comment"># ollama -v</span></span><br><span class="line">Warning: could<span class="built_in"> not </span>connect to a running Ollama<span class="built_in"> instance</span></span><br><span class="line"><span class="built_in"></span>Warning: client version is 0.3.9</span><br></pre></td></tr></table></figure><blockquote><p>Step 2. 添加开启自启服务</p></blockquote><p>创建服务文件/etc/systemd/system/ollama.service，并写入文件内容：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Ollama Service</span><br><span class="line"><span class="attr">After</span>=network-<span class="literal">on</span>line.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/ollama serve</span><br><span class="line"><span class="attr">User</span>=root</span><br><span class="line"><span class="attr">Group</span>=root</span><br><span class="line"><span class="attr">Restart</span>=always</span><br><span class="line"><span class="attr">RestartSec</span>=<span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=default.target</span><br></pre></td></tr></table></figure><p>生效服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> ollama</span><br></pre></td></tr></table></figure><p>启动服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl start ollama</span><br></pre></td></tr></table></figure><h4 id="一键安装">一键安装</h4><p>Ollama在Linux上也提供了简便的安装命令，但是过程中需要下载400M左右的数据，但在工作中一般采用下面命令进行安装：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://ollama.<span class="keyword">com</span>/install.<span class="keyword">sh</span> | <span class="keyword">sh</span></span><br></pre></td></tr></table></figure><h4 id="centos7如何安装最新版本Ollama？">centos7如何安装最新版本Ollama？</h4><p>解决centos7 安装ollama 运行 ollama -v 报错解决 详情参考这篇文章完美解决！</p><p><a href="https://cloud.tencent.com/developer/article/2530945">centos7 安装ollama 运行 ollama -v 报错解决-腾讯云开发者社区-腾讯云</a></p><h3 id="2-运行通义千问大模型">2.运行通义千问大模型</h3><p>在终端输入一下命令即可运行通义千问大模型： ollama run qwen2:0.5b</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon resource]# ollama run qwen2:<span class="number">0.5</span>b</span><br><span class="line">pulling manifest </span><br><span class="line"><span class="function"><span class="title">pulling</span></span> <span class="number">8</span>de95da68dc4... <span class="number">100</span>% ▕█████████████████████████████████████████████████████████████████████████████████▏ <span class="number">352</span> MB                         </span><br><span class="line"><span class="function"><span class="title">pulling</span></span> <span class="number">62</span>fbfd9ed093... <span class="number">100</span>% ▕█████████████████████████████████████████████████████████████████████████████████▏  <span class="number">182</span> B                         </span><br><span class="line"><span class="function"><span class="title">pulling</span></span> c156170b718e... <span class="number">100</span>% ▕█████████████████████████████████████████████████████████████████████████████████▏  <span class="number">11</span> KB                         </span><br><span class="line"><span class="function"><span class="title">pulling</span></span> f02dd72bb242... <span class="number">100</span>% ▕█████████████████████████████████████████████████████████████████████████████████▏   <span class="number">59</span> B                         </span><br><span class="line"><span class="function"><span class="title">pulling</span></span> <span class="number">2184</span>ab82477b... <span class="number">100</span>% ▕█████████████████████████████████████████████████████████████████████████████████▏  <span class="number">488</span> B                         </span><br><span class="line">verifying sha256 digest </span><br><span class="line">writing manifest </span><br><span class="line">removing any unused layers </span><br><span class="line">success </span><br><span class="line">&gt;&gt;&gt; 您好</span><br><span class="line">你好！有什么可以帮助你的？</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; 你是什么大模型</span><br><span class="line">我是来自于阿里云的预训练模型，我叫通义千问。我可以回答您关于计算机科学、机器学习等领域的各种问题，也可以进行自然语言处理、聊天机器人、智能问答等任务。我的设计目的是让计算机能够像人类一样思考和解决问题。</span><br></pre></td></tr></table></figure><p>为运行一个本地大模型的命令，这个命令的格式为：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ollama <span class="built_in">run</span> 模型名称:模型规模</span><br></pre></td></tr></table></figure><h4 id="修改模型路径">修改模型路径</h4><p>直接运行上述小节命令，会下载300多M的数据，比较慢，而在虚拟机中已经提前下载好了相关模型（包括后续用到的模型），存储在/root/ollama目录中，因此这里我们需要修改ollama的模型路径，ollama软件在各个操作系统上的默认存储路径是：</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">macOS:</span> <span class="symbol">~/.ollama/models</span> </span><br><span class="line"><span class="params">Linux:</span> <span class="symbol">~/.ollama/models</span> </span><br><span class="line"><span class="params">Windows:</span> ~<span class="operator">/</span>.ollama<span class="operator">/</span>models</span><br></pre></td></tr></table></figure><p>要修改其默认存储路径，需要通过设置系统环境变量来实现，即在/etc/profile文件中最后增加一下环境变量：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> <span class="attribute">OLLAMA_MODELS</span>=/root/ollama</span><br></pre></td></tr></table></figure><p>然后执行一下命令，生效环境变量：</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@bogon</span> ollama]<span class="comment"># source /etc/profile</span></span><br><span class="line">[root<span class="variable">@bogon</span> ollama]<span class="comment"># echo $OLLAMA_MODELS</span></span><br><span class="line"><span class="regexp">/root/ollama</span></span><br><span class="line">[root<span class="variable">@bogon</span> ollama]<span class="comment"># </span></span><br></pre></td></tr></table></figure><p>然后重新ollama服务，则会跳过下载，直接进入大模型，对话完成后可以通过/bye指令终止对话：</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@bogon</span> ollama]<span class="meta"># systemctl stop ollama</span></span><br><span class="line">[root<span class="symbol">@bogon</span> ollama]<span class="meta"># ollama serve &amp;</span></span><br><span class="line">[root<span class="symbol">@bogon</span> ~]<span class="meta">#  ollama run qwen2:0.5b</span></span><br><span class="line">&gt;&gt;&gt; 您好</span><br><span class="line">很高兴为您服务！有什么问题或需要帮助的吗？</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; /bye</span><br><span class="line">[root<span class="symbol">@bogon</span> ~]<span class="meta"># </span></span><br></pre></td></tr></table></figure><p><strong>让重启也支持模型路径：</strong></p><blockquote><p>上述方式修改后，通过ollama命令是生效的，但是重启电脑则不生效，要解决这个问题，则还需要进行如下配置：</p></blockquote><p>修改服务文件/etc/systemd/system/ollama.service内容为一下：：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Ollama Service</span><br><span class="line"><span class="attr">After</span>=network-<span class="literal">on</span>line.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/ollama serve</span><br><span class="line"><span class="attr">User</span>=root</span><br><span class="line"><span class="attr">Group</span>=root</span><br><span class="line"><span class="attr">Restart</span>=always</span><br><span class="line"><span class="attr">RestartSec</span>=<span class="number">3</span></span><br><span class="line"><span class="attr">Environment</span>=<span class="string">&quot;OLLAMA_MODELS=/root/ollama&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=default.target</span><br></pre></td></tr></table></figure><p>生效修改的配置：</p><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">system</span>ctl daemon-reload</span><br><span class="line"><span class="params">system</span>ctl restart ollama</span><br></pre></td></tr></table></figure><h3 id="3-对话指令详解">3.对话指令详解</h3><p>在Ollama终端中提供了一系列指令，可以用来调整和控制对话模型：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-46-1024x696.png" alt="img"></p><h4 id="指令">/? 指令</h4><blockquote><p>/? 指令主要是列出支持的指令列表</p></blockquote><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]#  ollama <span class="keyword">run</span> qwen2:0.5b</span><br><span class="line">&gt;&gt;&gt; /?</span><br><span class="line">Available Commands:</span><br><span class="line">  /<span class="keyword">set</span>            <span class="keyword">Set</span> session variables</span><br><span class="line">  /show           Show model information</span><br><span class="line">  /load &lt;model&gt;   Load a session or model</span><br><span class="line">  /<span class="keyword">save</span> &lt;model&gt;   <span class="keyword">Save</span> your current session</span><br><span class="line">  /<span class="keyword">clear</span>          <span class="keyword">Clear</span> session context</span><br><span class="line">  /bye            <span class="keyword">Exit</span></span><br><span class="line">  /?, /<span class="keyword">help</span>       <span class="keyword">Help</span> <span class="keyword">for</span> a command</span><br><span class="line">  /? shortcuts    <span class="keyword">Help</span> <span class="keyword">for</span> keyboard shortcuts</span><br><span class="line"></span><br><span class="line"><span class="keyword">Use</span> <span class="string">&quot;&quot;</span>&quot; to begin a multi-<span class="keyword">line</span> message.</span><br></pre></td></tr></table></figure><h4 id="bye-指令">/bye 指令</h4><blockquote><p>退出当前控制台对话</p></blockquote><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@bogon</span> ~]<span class="meta">#  ollama run qwen2:0.5b</span></span><br><span class="line">&gt;&gt;&gt; 您好</span><br><span class="line">你好！有什么可以帮助您的吗？</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; /bye</span><br><span class="line">[root<span class="symbol">@bogon</span> ~]<span class="meta"># </span></span><br></pre></td></tr></table></figure><h4 id="show-指令">/show 指令</h4><blockquote><p>用于查看当前模型详细信息</p></blockquote><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]<span class="comment">#  ollama run qwen2:0.5b</span></span><br><span class="line">&gt;&gt;&gt; /<span class="literal">show</span></span><br><span class="line">Available Commands:</span><br><span class="line">  /<span class="literal">show</span> info         查看模型的基本信息</span><br><span class="line">  /<span class="literal">show</span> <span class="literal">license</span>      查看模型的许可信息</span><br><span class="line">  /<span class="literal">show</span> modelfile    查看模型的制作源文件Modelfile</span><br><span class="line">  /<span class="literal">show</span> parameters   查看模型的内置参数信息</span><br><span class="line">  /<span class="literal">show</span> <span class="params">system</span>       查看模型的内置Sytem信息</span><br><span class="line">  /<span class="literal">show</span> template     查看模型的提示词模版</span><br></pre></td></tr></table></figure><blockquote><p>/show info 查看模型的基本信息</p></blockquote><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; /show info</span><br><span class="line"><span class="keyword">Model</span> details:</span><br><span class="line">Family              qwen2       模型名称</span><br><span class="line"><span class="keyword">Parameter</span> Size      <span class="comment">494.03M</span>     模型大小</span><br><span class="line">Quantization <span class="comment">Level  Q4_0</span>        模型量化级别</span><br></pre></td></tr></table></figure><blockquote><p>/show license 查看模型的许可信息—开源软件的许可协议</p></blockquote><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; /show license</span><br><span class="line"></span><br><span class="line">                                 Apache License</span><br><span class="line">                           Version <span class="number">2.0</span>, January <span class="number">2004</span></span><br><span class="line">                        http:<span class="comment">//www.apache.org/licenses/</span></span><br><span class="line"></span><br><span class="line">   TERMS <span class="literal">AND</span> CONDITIONS FOR USE, REPRODUCTION, <span class="literal">AND</span> DISTRIBUTION</span><br><span class="line">   <span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span><span class="params">...</span></span><br></pre></td></tr></table></figure><blockquote><p>/show modelfile 查看模型的制作源文件Modelfile</p><p>modelfile ：文件是用来制作私有模型的脚步文件，后续课程学习</p></blockquote><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">&gt;&gt;&gt; /show modelfile</span></span><br><span class="line"><span class="language-xml"># Modelfile generated by &quot;ollama show&quot;</span></span><br><span class="line"><span class="language-xml"># To build a new Modelfile based on this, replace FROM with:</span></span><br><span class="line"><span class="language-xml"># FROM qwen2:0.5b</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">FROM /root/ollama/blobs/sha256-8de95da68dc485c0889c205384c24642f83ca18d089559c977ffc6a3972a71a8</span></span><br><span class="line"><span class="language-xml">TEMPLATE &quot;</span><span class="template-variable">&#123;&#123; <span class="name"><span class="built_in">if</span></span> .System &#125;&#125;</span><span class="language-xml">&lt;|im_start|&gt;system</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">.System</span> &#125;&#125;</span><span class="language-xml">&lt;|im_end|&gt;</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">end</span> &#125;&#125;</span><span class="template-variable">&#123;&#123; <span class="name"><span class="built_in">if</span></span> .Prompt &#125;&#125;</span><span class="language-xml">&lt;|im_start|&gt;user</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">.Prompt</span> &#125;&#125;</span><span class="language-xml">&lt;|im_end|&gt;</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">end</span> &#125;&#125;</span><span class="language-xml">&lt;|im_start|&gt;assistant</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">.Response</span> &#125;&#125;</span><span class="language-xml">&lt;|im_end|&gt;</span></span><br><span class="line"><span class="language-xml">&quot;</span></span><br><span class="line"><span class="language-xml">PARAMETER stop &lt;|im_start|&gt;</span></span><br><span class="line"><span class="language-xml">PARAMETER stop &lt;|im_end|&gt;</span></span><br><span class="line"><span class="language-xml">LICENSE &quot;&quot;&quot;</span></span><br><span class="line"><span class="language-xml">......................................................................</span></span><br></pre></td></tr></table></figure><blockquote><p>/show parameters 查看模型的内置参数信息</p></blockquote><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; /show <span class="keyword">parameters</span></span><br><span class="line">Model <span class="comment">defined parameters:</span></span><br><span class="line">stop                           <span class="comment">&quot;&lt;|im_start|&gt;&quot;</span></span><br><span class="line">stop                           <span class="comment">&quot;&lt;|im_end|&gt;&quot;</span></span><br></pre></td></tr></table></figure><blockquote><p>/show system 查看模型的内置system信息—system常常用来定一些对话角色扮演</p></blockquote><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; /show <span class="keyword">system</span></span><br><span class="line"><span class="keyword">No</span> <span class="keyword">system</span> message was specified <span class="keyword">for</span> this <span class="keyword">model</span>.</span><br></pre></td></tr></table></figure><blockquote><p>/show template 查看模型的提示词模版</p><p>template：是最终传入大模型的字符串模版，模版中的内容由上层应用动态传入</p></blockquote><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">&gt;&gt;&gt; /show template</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name"><span class="built_in">if</span></span> .System &#125;&#125;</span><span class="language-xml">&lt;|im_start|&gt;system</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">.System</span> &#125;&#125;</span><span class="language-xml">&lt;|im_end|&gt;</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">end</span> &#125;&#125;</span><span class="template-variable">&#123;&#123; <span class="name"><span class="built_in">if</span></span> .Prompt &#125;&#125;</span><span class="language-xml">&lt;|im_start|&gt;user</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">.Prompt</span> &#125;&#125;</span><span class="language-xml">&lt;|im_end|&gt;</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">end</span> &#125;&#125;</span><span class="language-xml">&lt;|im_start|&gt;assistant</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">.Response</span> &#125;&#125;</span><span class="language-xml">&lt;|im_end|&gt;</span></span><br></pre></td></tr></table></figure><h4 id="shortcuts-指令">/? shortcuts 指令</h4><blockquote><p>查看在控制台中可用的快捷键</p></blockquote><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; /? <span class="selector-tag">shortcuts</span></span><br><span class="line"><span class="selector-tag">Available</span> <span class="selector-tag">keyboard</span> <span class="selector-tag">shortcuts</span>:</span><br><span class="line">  <span class="selector-tag">Ctrl</span> + <span class="selector-tag">a</span>            移动到行头</span><br><span class="line">  <span class="selector-tag">Ctrl</span> + <span class="selector-tag">e</span>            移动到行尾</span><br><span class="line">   <span class="selector-tag">Alt</span> + <span class="selector-tag">b</span>            移动到单词左边</span><br><span class="line">   <span class="selector-tag">Alt</span> + <span class="selector-tag">f</span>            移动到单词右边</span><br><span class="line">  <span class="selector-tag">Ctrl</span> + <span class="selector-tag">k</span>            删除游标后面的内容</span><br><span class="line">  <span class="selector-tag">Ctrl</span> + <span class="selector-tag">u</span>            删除游标前面的内容</span><br><span class="line">  <span class="selector-tag">Ctrl</span> + <span class="selector-tag">w</span>            删除游标前面的单词</span><br><span class="line"></span><br><span class="line">  <span class="selector-tag">Ctrl</span> + <span class="selector-tag">l</span>            清屏</span><br><span class="line">  <span class="selector-tag">Ctrl</span> + <span class="selector-tag">c</span>            停止推理输出</span><br><span class="line">  <span class="selector-tag">Ctrl</span> + <span class="selector-tag">d</span>            退出对话（只有在没有输入时才生效）</span><br></pre></td></tr></table></figure><h4 id="“”-指令">“”&quot; 指令</h4><blockquote><p>“”&quot; 用于输入内容有换行时使用，如何多行输入结束也使用 “”&quot;</p></blockquote><figure class="highlight python-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python"><span class="string">&quot;&quot;&quot;</span></span></span><br><span class="line"><span class="meta prompt_">...</span> <span class="language-python"><span class="string">您好</span></span></span><br><span class="line"><span class="meta prompt_">...</span> <span class="language-python"><span class="string">你是什么模型？</span></span></span><br><span class="line"><span class="meta prompt_">...</span> <span class="language-python"><span class="string">&quot;&quot;&quot;</span> </span></span><br><span class="line">我是一个计算机程序，可以回答您的问题、提供信息和执行任务。请问您有什么问题或者指令想要我帮助您？</span><br></pre></td></tr></table></figure><h4 id="set-指令">/set 指令</h4><blockquote><p>set指令主要用来设置当前对话模型的系列参数</p></blockquote><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; /<span class="built_in">set</span></span><br><span class="line">Available Commands:</span><br><span class="line">  /<span class="built_in">set</span> parameter <span class="built_in">..</span>.     设置对话参数</span><br><span class="line">  /<span class="built_in">set</span><span class="built_in"> system </span>&lt;string&gt;   设置系统角色</span><br><span class="line">  /<span class="built_in">set</span> template &lt;string&gt; 设置推理模版</span><br><span class="line">  /<span class="built_in">set</span> history           开启对话历史</span><br><span class="line">  /<span class="built_in">set</span> nohistory         关闭对话历史</span><br><span class="line">  /<span class="built_in">set</span> wordwrap          开启自动换行</span><br><span class="line">  /<span class="built_in">set</span> nowordwrap        关闭自动换行</span><br><span class="line">  /<span class="built_in">set</span> format json       输出JSON格式</span><br><span class="line">  /<span class="built_in">set</span> noformat          关闭格式输出</span><br><span class="line">  /<span class="built_in">set</span> verbose           开启对话统计日志</span><br><span class="line">  /<span class="built_in">set</span> quiet             关闭对话统计日志</span><br></pre></td></tr></table></figure><blockquote><p>/set parameter … 设置对话参数</p></blockquote><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; /<span class="built_in">set</span> parameter</span><br><span class="line">Available Parameters:</span><br><span class="line">  /<span class="built_in">set</span> parameter seed &lt;int&gt;             Random number seed</span><br><span class="line">  /<span class="built_in">set</span> parameter num_predict &lt;int&gt;      Max number of tokens <span class="keyword">to</span> predict</span><br><span class="line">  /<span class="built_in">set</span> parameter top_k &lt;int&gt;            Pick <span class="keyword">from</span> top k num of tokens</span><br><span class="line">  /<span class="built_in">set</span> parameter top_p &lt;float&gt;          Pick token based on sum of probabilities</span><br><span class="line">  /<span class="built_in">set</span> parameter num_ctx &lt;int&gt;          <span class="built_in">Set</span> the context size</span><br><span class="line">  /<span class="built_in">set</span> parameter temperature &lt;float&gt;    <span class="built_in">Set</span> creativity level</span><br><span class="line">  /<span class="built_in">set</span> parameter repeat_penalty &lt;float&gt; How strongly <span class="keyword">to</span> penalize repetitions</span><br><span class="line">  /<span class="built_in">set</span> parameter repeat_last_n &lt;int&gt;    <span class="built_in">Set</span> how far back <span class="keyword">to</span> look <span class="keyword">for</span> repetitions</span><br><span class="line">  /<span class="built_in">set</span> parameter num_gpu &lt;int&gt;          The number of layers <span class="keyword">to</span> send <span class="keyword">to</span> the GPU</span><br><span class="line">  /<span class="built_in">set</span> parameter stop &lt;string&gt; &lt;string&gt; <span class="built_in">..</span>.   <span class="built_in">Set</span> the stop parameters</span><br></pre></td></tr></table></figure><table><thead><tr><th>Parameter</th><th>Description</th><th>Value Type</th><th>Example Usage</th></tr></thead><tbody><tr><td>num_ctx</td><td>设置上下文token大小. (默认: 2048)</td><td>int</td><td>num_ctx 4096</td></tr><tr><td>repeat_last_n</td><td>设置模型要回顾的距离以防止重复. (默认: 64, 0 = 禁用, -1 = num_ctx)</td><td>int</td><td>repeat_last_n 64</td></tr><tr><td>repeat_penalty</td><td>设置惩罚重复的强度。较高的值（例如，1.5)将更强烈地惩罚重复，而较低值（例如，0.9)会更加宽容。（默认值：1.1）</td><td>float</td><td>repeat_penalty 1.1</td></tr><tr><td>temperature</td><td><strong>模型的温度。提高温度将使模型的答案更有创造性。（默认值：0.8）</strong></td><td>float</td><td>temperature 0.7</td></tr><tr><td>seed</td><td>设置用于生成的随机数种子。将其设置为特定的数字将使模型为相同的提示生成相同的文本。（默认值：0）</td><td>int</td><td>seed 42</td></tr><tr><td>stop</td><td>设置停止词。当遇到这种词时，LLM将停止生成文本并返回</td><td>string</td><td>stop “AI assistant:”</td></tr><tr><td>num_predict</td><td>生成文本时要预测的最大标记数。（默认值：128，-1 =无限生成，-2 =填充上下文）</td><td>int</td><td>num_predict 42</td></tr><tr><td>top_k</td><td><strong>减少产生无意义的可能性。较高的值（例如100）将给出更多样化的答案，而较低的值（例如10）将更加保守。（默认值：40）</strong></td><td>int</td><td>top_k 40</td></tr><tr><td>top_p</td><td>与Top-K合作。较高的值（例如，0.95）将导致更多样化的文本，而较低的值（例如，0.5)将产生更集中和保守的文本。（默认值：0.9）</td><td>float</td><td>top_p 0.9</td></tr><tr><td>num_gpu</td><td>设置缓存到GPU显存中的模型层数</td><td>int</td><td>自动计算</td></tr></tbody></table><p><strong>JSON格式输出</strong></p><figure class="highlight python-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">/<span class="built_in">set</span> <span class="built_in">format</span> json</span></span><br><span class="line">Set format to &#x27;json&#x27; mode.</span><br><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">您好</span></span><br><span class="line">&#123;&quot;response&quot;:&quot;你好，欢迎光临，请问有什么我可以帮助您的吗？&quot;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">/<span class="built_in">set</span> noformat</span></span><br><span class="line">Disabled format.</span><br><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">您好</span></span><br><span class="line">Hello! How can I assist you?</span><br></pre></td></tr></table></figure><p><strong>输出对话统计日志</strong></p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; /set <span class="built_in">verbose</span></span><br><span class="line">Set &#x27;<span class="built_in">verbose</span>&#x27; mode.</span><br><span class="line">&gt;&gt;&gt; 您好</span><br><span class="line">您好！我需要您的信息，以便回答您的问题。请问您能告诉我更多关于这个主题的信息吗？</span><br><span class="line"></span><br><span class="line">total duration:       <span class="number">1.</span>642906162s          总耗时</span><br><span class="line"><span class="built_in">load</span> duration:        <span class="number">3.</span>401367ms            加载模型数据耗时</span><br><span class="line"><span class="built_in">prompt</span> <span class="built_in">eval</span> count:    <span class="number">11</span> token(s)           提示词token消耗数量</span><br><span class="line"><span class="built_in">prompt</span> <span class="built_in">eval</span> duration: <span class="number">196.</span>52ms              提示词处理耗时</span><br><span class="line"><span class="built_in">prompt</span> <span class="built_in">eval</span> rate:     <span class="number">55.97</span> <span class="built_in">tokens</span>/s        提示词处理速率</span><br><span class="line"><span class="built_in">eval</span> count:           <span class="number">24</span> token(s)           响应token消耗数量</span><br><span class="line"><span class="built_in">eval</span> duration:        <span class="number">1.</span>304188s             响应处理耗时</span><br><span class="line"><span class="built_in">eval</span> rate:            <span class="number">18.40</span> <span class="built_in">tokens</span>/s        响应处理速率</span><br></pre></td></tr></table></figure><h4 id="clear-指令">/clear 指令</h4><p>在命令行终端中对话是自带上下文记忆功能，如果要清除上下文功能，则使用/clear指令清楚上下文内容，例如：</p><p>前2个问题都关联的，在输入/clear则把前2个问题的内容给清理掉了，第3次提问时则找不到开始的上下文了。</p><figure class="highlight python-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">请帮我出<span class="number">1</span>道java <span class="built_in">list</span>的单选题 </span></span><br><span class="line">以下是一些关于Java List的单选题：</span><br><span class="line"></span><br><span class="line">1. 在Java中，List是哪一种数据结构？</span><br><span class="line">2. Java中的顺序存储方式（例如：使用数组）主要用来做什么？</span><br><span class="line">3. 一个列表对象可以包含哪些类型的元素？</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">再出<span class="number">1</span>道</span></span><br><span class="line">以下是一些关于Java List的单选题：</span><br><span class="line"></span><br><span class="line">4. 在Java中，List接口用于创建和操作集合。</span><br><span class="line">5. Java中的顺序存储方式（如：使用数组）的主要优势有哪些？</span><br><span class="line">6. 一个列表对象可以包含哪些类型？</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">/clear</span></span><br><span class="line">Cleared session context</span><br><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">在出<span class="number">1</span>道</span></span><br><span class="line">很抱歉，我无法理解您的问题。您能否提供更多的背景信息或者问题描述，以便我能更好地帮助您？</span><br></pre></td></tr></table></figure><h4 id="load-指令">/load 指令</h4><blockquote><p>load可以在对话过程中随时切换大模型</p></blockquote><figure class="highlight python-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">你是什么大模型</span></span><br><span class="line">我是一个基于开放AI平台的模型，拥有一个强大的数学推理能力，并且在各种自然语言处理任务上都表现优秀。我可以回答您提出的问题，也可以提供与主题相关的信息和建议。如果您有任何问题或需要帮助，</span><br><span class="line">请随时告诉我！</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">/load deepseek-coder</span></span><br><span class="line">Loading model &#x27;deepseek-coder&#x27;</span><br><span class="line"><span class="meta prompt_">&gt;&gt;&gt;</span> <span class="language-python">你是什么大模型</span></span><br><span class="line">我是由中国的深度求索（DeepSeek）公司开发的编程智能助手，名为 Deepseek Coder。我主要用于解答和协助计算机科学相关的问题、问题解决方案等任务。我的设计目标是提供最全面准确的高质量服务来帮</span><br><span class="line">助用户理解复杂的新技术或概念并迅速找到它们在实际应用中的实现方法或者原理所在的地方。</span><br></pre></td></tr></table></figure><h4 id="save-指令">/save 指令</h4><blockquote><p>可以把当前对话模型存储成一个新的模型</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; /save <span class="built_in">test</span></span><br><span class="line">Created new model <span class="string">&#x27;test&#x27;</span></span><br></pre></td></tr></table></figure><p>保存的模型存储在ollama的model文件中，进入下面路径即可看见模型文件test：</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@bogon</span> library]<span class="comment"># pwd</span></span><br><span class="line"><span class="regexp">/root/ollama</span><span class="regexp">/manifests/registry</span>.ollama.ai/library</span><br><span class="line">[root<span class="variable">@bogon</span> library]<span class="comment"># ls</span></span><br><span class="line">deepseek-coder  qwen2  test</span><br></pre></td></tr></table></figure><h3 id="4-客户端命令详解">4.客户端命令详解</h3><p>Ollama客户端还提供了系列命令，来管理本地大模型，接下来就先了解一下相关命令：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/g6-1024x963.png" alt="img"></p><h4 id="run-命令">run 命令</h4><blockquote><p>run命令主要用于运行一个大模型，命令格式是：</p></blockquote><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ollama <span class="built_in">run</span> MODEL[:Version] [PROMPT] [flags]</span><br><span class="line">比如，运行通义千问命令：</span><br><span class="line">ollama <span class="built_in">run</span> qwen2:0.5b</span><br></pre></td></tr></table></figure><blockquote><p>[:Version] 可以理解成版本，而版本信息常常以大模型规模来命名，可以不写，不写则模式成latest</p></blockquote><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ollama <span class="built_in">run</span> qwen2</span><br><span class="line">等同</span><br><span class="line">ollama <span class="built_in">run</span> qwen2:latest</span><br></pre></td></tr></table></figure><blockquote><p>[PROMPT] 参数是用户输入的提示词，如果带有此参数则，run命令会执行了输入提示词之后即退出终端，即只对话一次。</p></blockquote><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@bogon</span> ~]<span class="meta">#  ollama run qwen2:0.5b 您好</span></span><br><span class="line">您好！有什么问题我可以帮助您？</span><br><span class="line"></span><br><span class="line">[root<span class="symbol">@bogon</span> ~]<span class="meta"># </span></span><br></pre></td></tr></table></figure><blockquote><p>[flags] 指定运行时的参数</p></blockquote><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Flags:</span><br><span class="line">      <span class="comment">--format string      指定运行的模型输出格式 (比如. json)</span></span><br><span class="line">      <span class="comment">--insecure           使用非安全模，比如在下载模型时会忽略https的安全证书</span></span><br><span class="line">      <span class="comment">--keepalive string   指定模型在内存中的存活时间</span></span><br><span class="line">      <span class="comment">--nowordwrap         关闭单词自动换行功能</span></span><br><span class="line">      <span class="comment">--verbose            开启统计日志信息</span></span><br></pre></td></tr></table></figure><p>例如，在启动时增加 --verbose参数，则在对话时，自动增加统计token信息：</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]<span class="comment"># ollama run qwen2:0.5b --verbose</span></span><br><span class="line"><span class="operator">&gt;</span><span class="operator">&gt;</span><span class="operator">&gt;</span> 您好</span><br><span class="line">欢迎光临，我可以为您提供帮助。有什么问题或需要帮助的地方？</span><br><span class="line"></span><br><span class="line">total <span class="params">duration:</span>       <span class="number">1.229917477</span>s</span><br><span class="line">load <span class="params">duration:</span>        <span class="number">3.027073</span>ms</span><br><span class="line">prompt eval <span class="params">count:</span>    <span class="number">10</span> token(s)</span><br><span class="line">prompt eval <span class="params">duration:</span> <span class="number">167.181</span>ms</span><br><span class="line">prompt eval <span class="params">rate:</span>     <span class="number">59.82</span> tokens<span class="symbol">/s</span></span><br><span class="line">eval <span class="params">count:</span>           <span class="number">16</span> token(s)</span><br><span class="line">eval <span class="params">duration:</span>        <span class="number">928.995</span>ms</span><br><span class="line">eval <span class="params">rate:</span>            <span class="number">17.22</span> tokens<span class="symbol">/s</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="show-命令">show 命令</h4><blockquote><p>不用运行大模型，查看模型的信息，与之前所学的/show功能类似。</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@bogon</span> <span class="operator">~</span>]# ollama <span class="keyword">show</span> <span class="operator">-</span>h</span><br><span class="line"><span class="keyword">Show</span> information <span class="keyword">for</span> a model</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  ollama <span class="keyword">show</span> MODEL [flags]</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">  <span class="operator">-</span>h, <span class="comment">--help         查看使用帮助</span></span><br><span class="line">      <span class="comment">--license      查看模型的许可信息</span></span><br><span class="line">      <span class="comment">--modelfile    查看模型的制作源文件Modelfile</span></span><br><span class="line">      <span class="comment">--parameters   查看模型的内置参数信息</span></span><br><span class="line">      <span class="comment">--system       查看模型的内置Sytem信息</span></span><br><span class="line">      <span class="comment">--template     查看模型的提示词模版</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>例如，查看提示词模版：</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">[root@bogon ~]# ollama show qwen2 --template</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name"><span class="built_in">if</span></span> .System &#125;&#125;</span><span class="language-xml">&lt;|im_start|&gt;system</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">.System</span> &#125;&#125;</span><span class="language-xml">&lt;|im_end|&gt;</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">end</span> &#125;&#125;</span><span class="template-variable">&#123;&#123; <span class="name"><span class="built_in">if</span></span> .Prompt &#125;&#125;</span><span class="language-xml">&lt;|im_start|&gt;user</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">.Prompt</span> &#125;&#125;</span><span class="language-xml">&lt;|im_end|&gt;</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">end</span> &#125;&#125;</span><span class="language-xml">&lt;|im_start|&gt;assistant</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">.Response</span> &#125;&#125;</span><span class="language-xml">&lt;|im_end|&gt;</span></span><br></pre></td></tr></table></figure><h4 id="pull-命令">pull 命令</h4><p>查询模型名称的网站：<a href="https://ollama.com/">https://ollama.com/</a></p><blockquote><p>从远程下载一个模型，命令格式是：</p></blockquote><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ollama pull MODEL<span class="selector-attr">[:Version]</span> <span class="selector-attr">[flags]</span></span><br></pre></td></tr></table></figure><blockquote><p>[:Version] 可以理解成版本，但在这里理解成大模型规模，可以不写，不写则模式成latest</p></blockquote><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ollama</span> pull qwen2</span><br><span class="line">等同</span><br><span class="line">ollama pull qwen2:latest</span><br></pre></td></tr></table></figure><blockquote><p>[flags] 参数，目前只有一个–insecure参数，用于来指定非安全模式下载数据</p></blockquote><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ollama pull qwen2 <span class="comment">--insecure</span></span><br></pre></td></tr></table></figure><h4 id="list-ls-命令">list/ls 命令</h4><blockquote><p>查看本地下载的大模型列表，也可以使用简写ls</p></blockquote><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]<span class="comment"># ollama list</span></span><br><span class="line">NAME                    ID              SIZE    MODIFIED       </span><br><span class="line">qwen2:latest            e0d4e1163c58    4.4 GB <span class="number"> 10 </span>minutes ago  </span><br><span class="line">deepseek-coder:latest   3ddd2d3fc8d2   <span class="number"> 776 </span>MB <span class="number"> 3 </span>hours ago     </span><br><span class="line">qwen2:0.5b              6f48b936a09f   <span class="number"> 352 </span>MB <span class="number"> 8 </span>hours ago     </span><br><span class="line">[root@bogon ~]<span class="comment"># ollama ls</span></span><br><span class="line">NAME                    ID              SIZE    MODIFIED       </span><br><span class="line">qwen2:latest            e0d4e1163c58    4.4 GB <span class="number"> 10 </span>minutes ago  </span><br><span class="line">deepseek-coder:latest   3ddd2d3fc8d2   <span class="number"> 776 </span>MB <span class="number"> 3 </span>hours ago     </span><br><span class="line">qwen2:0.5b              6f48b936a09f   <span class="number"> 352 </span>MB <span class="number"> 8 </span>hours ago   </span><br></pre></td></tr></table></figure><p><strong>列表字段说明：</strong></p><ul><li>NAME：名称</li><li>ID：大模型唯一ID</li><li>SIZE：大模型大小</li><li>MODIFIED：本地存活时间</li></ul><p><strong>注意：在ollama的其它命令中，不能像docker一下使用ID或ID缩写，这里只能使用大模型全名称。</strong></p><h4 id="ps-命令">ps 命令</h4><blockquote><p>查看当前运行的大模型列表，PS命令没其它参数</p></blockquote><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@bogon</span> ~]<span class="meta"># ollama ps</span></span><br><span class="line">NAME                    ID              SIZE    PROCESSOR       <span class="keyword">UNTIL</span>                   </span><br><span class="line">deepseek-coder:latest   <span class="number">3</span>ddd2d3fc8d2    <span class="number">1.3</span> GB  <span class="number">100</span>% CPU        About a minute from now </span><br></pre></td></tr></table></figure><p><strong>列表字段说明：</strong></p><ul><li>NAME：大模型名称</li><li>ID：唯一ID</li><li>SIZE：模型大小</li><li>PROCESSOR：资源占用</li><li>UNTIL：运行存活时长</li></ul><h4 id="rm-命令">rm 命令</h4><blockquote><p>删除本地大模型，RM命令没其它参数</p></blockquote><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@localhost</span> <span class="keyword">system</span>]<span class="comment"># ollama ls</span></span><br><span class="line">NAME                    ID              SIZE    MODIFIED     </span><br><span class="line">qwen2:latest            e0d4e1163c58    <span class="number">4.4</span> GB  <span class="number">16</span> hours ago    </span><br><span class="line">deepseek-coder:latest   3ddd2d3fc8d2    <span class="number">776</span> MB  <span class="number">19</span> hours ago    </span><br><span class="line">qwen2:<span class="number">0</span>.5b              6f48b936a09f    <span class="number">352</span> MB  <span class="number">24</span> hours ago    </span><br><span class="line">[root<span class="variable">@localhost</span> <span class="keyword">system</span>]<span class="comment"># ollama rm qwen2:0.5b</span></span><br><span class="line">deleted <span class="string">&#x27;qwen2:0.5b&#x27;</span></span><br><span class="line">[root<span class="variable">@localhost</span> <span class="keyword">system</span>]<span class="comment"># ollama ls</span></span><br><span class="line">NAME                    ID              SIZE    MODIFIED     </span><br><span class="line">qwen2:latest            e0d4e1163c58    <span class="number">4.4</span> GB  <span class="number">16</span> hours ago    </span><br><span class="line">deepseek-coder:latest   3ddd2d3fc8d2    <span class="number">776</span> MB  <span class="number">19</span> hours ago    </span><br><span class="line">[root<span class="variable">@localhost</span> <span class="keyword">system</span>]<span class="comment"># </span></span><br></pre></td></tr></table></figure><h3 id="5-API-详解">5.API 详解</h3><h4 id="开通远程访问">开通远程访问</h4><p>为了在本机（开发环境）中能访问虚拟机中的Ollama API，我们需要先开通Ollama的远程访问权限：</p><p><strong>Step 1：增加环境变量</strong></p><p>在/etc/profile中增加一下环境变量：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> <span class="attribute">OLLAMA_HOST</span>=0.0.0.0:11434</span><br><span class="line"><span class="built_in">export</span> <span class="attribute">OLLAMA_ORIGINS</span>=*</span><br></pre></td></tr></table></figure><p>然后通过一下命令，生效环境变量：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure><p><strong>Step 2：增加服务变量</strong></p><p>修改服务文件/etc/systemd/system/ollama.service内容为一下：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Ollama Service</span><br><span class="line"><span class="attr">After</span>=network-<span class="literal">on</span>line.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/ollama serve</span><br><span class="line"><span class="attr">User</span>=root</span><br><span class="line"><span class="attr">Group</span>=root</span><br><span class="line"><span class="attr">Restart</span>=always</span><br><span class="line"><span class="attr">RestartSec</span>=<span class="number">3</span></span><br><span class="line"><span class="attr">Environment</span>=<span class="string">&quot;OLLAMA_MODELS=/root/ollama&quot;</span></span><br><span class="line"><span class="attr">Environment</span>=<span class="string">&quot;OLLAMA_HOST=0.0.0.0:11434&quot;</span></span><br><span class="line"><span class="attr">Environment</span>=<span class="string">&quot;OLLAMA_ORIGINS=*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=default.target</span><br></pre></td></tr></table></figure><p>生效修改的配置：</p><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">system</span>ctl daemon-reload</span><br><span class="line"><span class="params">system</span>ctl restart ollama</span><br></pre></td></tr></table></figure><p><strong>Step 3：开通防火墙</strong></p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> <span class="literal">--</span><span class="comment">zone=public</span> <span class="literal">--</span><span class="comment">add</span><span class="literal">-</span><span class="comment">port=11434/tcp</span> <span class="literal">--</span><span class="comment">permanent</span></span><br><span class="line"><span class="comment">firewall</span><span class="literal">-</span><span class="comment">cmd</span> <span class="literal">--</span><span class="comment">reload</span></span><br></pre></td></tr></table></figure><p>也可以关闭防火墙：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld</span><br></pre></td></tr></table></figure><h4 id="导入Apifox文档">导入Apifox文档</h4><p>为了方便后续使用程序接入Ollama中的大模型，在此可以先通过Apifox进行Api的快速体验与学习。在资料文件夹中《Ollama.apifox.json》文件提供了供Apifox软件导入的json内容，再此我们先导入到Apifox软件中，快速体验一下API相关功能。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-64-1024x526.png" alt="img"></p><h4 id="配置环境地址">配置环境地址</h4><p>Oallma支持的API可以在资料文件夹中通过《Ollama API文档.html》了解详解，双击打开查看：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240620174314154-1024x518.png" alt="img"></p><p>通过网页可以了解到Ollama支持7个API （这里只列举了常用的），接下来我们重点先了解对话和向量化接口，因为这两个接口是最重要的，其它接口则留给大家课后自行尝试，但是在正式体验之前，需要先配置一下环境地址。</p><p><strong>配置测试环境地址：</strong></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240620211302491-1024x576.png" alt="img"></p><h4 id="聊天对话接口说明">聊天对话接口说明</h4><p>聊天对话接口，是实现类似ChatGPT、文心、通义千问等网页对话功能的关键接口，请求的地址与参数如下：</p><p>POST /api/chat</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;model&quot;</span>: <span class="string">&quot;qwen2.5:0.5b&quot;</span>,</span><br><span class="line">  <span class="string">&quot;messages&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;role&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">      <span class="string">&quot;content&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">      <span class="string">&quot;images&quot;</span>: <span class="string">&quot;string&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;format&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">  <span class="string">&quot;stream&quot;</span>: true,</span><br><span class="line">  <span class="string">&quot;keep_alive&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">   <span class="string">&quot;tools&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;function&quot;</span>,</span><br><span class="line">      <span class="string">&quot;function&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;get_current_weather&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Get the current weather for a location&quot;</span>,</span><br><span class="line">        <span class="string">&quot;parameters&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">          <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;location&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">              <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The location to get the weather for, e.g. San Francisco, CA&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;format&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">              <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The format to return the weather in, e.g. &#x27;celsius&#x27; or &#x27;fahrenheit&#x27;&quot;</span>,</span><br><span class="line">              <span class="string">&quot;enum&quot;</span>: [<span class="string">&quot;celsius&quot;</span>, <span class="string">&quot;fahrenheit&quot;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;required&quot;</span>: [<span class="string">&quot;location&quot;</span>, <span class="string">&quot;format&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;options&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;seed&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;top_k&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;top_p&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;repeat_last_n&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;temperature&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;repeat_penalty&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;stop&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;string&quot;</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="请求参数">请求参数</h5><table><thead><tr><th>名称</th><th>位置</th><th>类型</th><th>必选</th><th>中文名</th><th>说明</th></tr></thead><tbody><tr><td>body</td><td>body</td><td>object</td><td>否</td><td></td><td>none</td></tr><tr><td>model</td><td>body</td><td>string</td><td>是</td><td>模型名称</td><td>none</td></tr><tr><td>messages</td><td>body</td><td>[object]</td><td>是</td><td>聊天消息</td><td>none</td></tr><tr><td>role</td><td>body</td><td>string</td><td>是</td><td>角色</td><td>system、user或assistant</td></tr><tr><td>content</td><td>body</td><td>string</td><td>是</td><td>内容</td><td>none</td></tr><tr><td>images</td><td>body</td><td>string</td><td>否</td><td>图像</td><td>none</td></tr><tr><td>format</td><td>body</td><td>string</td><td>否</td><td>响应格式</td><td>none</td></tr><tr><td>stream</td><td>body</td><td>boolean</td><td>否</td><td>是否流式生成</td><td>none</td></tr><tr><td>keep_alive</td><td>body</td><td>string</td><td>否</td><td>模型内存保持时间</td><td>5m</td></tr><tr><td>tools</td><td>body</td><td>[object]</td><td>否</td><td>工具</td><td></td></tr><tr><td>options</td><td>body</td><td>object</td><td>否</td><td>配置参数</td><td>none</td></tr><tr><td>seed</td><td>body</td><td>integer</td><td>否</td><td>生成种子</td><td>none</td></tr><tr><td>top_k</td><td>body</td><td>integer</td><td>否</td><td>多样度</td><td>越高越多样，默认40</td></tr><tr><td>top_p</td><td>body</td><td>number</td><td>否</td><td>保守度</td><td>越低越保守，默认0.9</td></tr><tr><td>repeat_last_n</td><td>body</td><td>integer</td><td>否</td><td>防重复回顾距离</td><td>默认: 64, 0 = 禁用, -1 = num_ctx</td></tr><tr><td>temperature</td><td>body</td><td>number</td><td>否</td><td>温度值</td><td>越高创造性越强，默认0.8</td></tr><tr><td>repeat_penalty</td><td>body</td><td>number</td><td>否</td><td>重复惩罚强度</td><td>越高惩罚越强，默认1.1</td></tr><tr><td>stop</td><td>body</td><td>[string]</td><td>是</td><td>停止词</td><td>none</td></tr></tbody></table><h5 id="返回示例">返回示例</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;model&quot;</span><span class="punctuation">:</span> <span class="string">&quot;llama3.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;created_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2024-09-07T09:00:57.035084368Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;assistant&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tool_calls&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;function&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;get_current_weather&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;arguments&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;celsius&quot;</span><span class="punctuation">,</span></span><br><span class="line">                        <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Paris&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;done_reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stop&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;done&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;total_duration&quot;</span><span class="punctuation">:</span> <span class="number">14452649821</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;load_duration&quot;</span><span class="punctuation">:</span> <span class="number">21370256</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;prompt_eval_count&quot;</span><span class="punctuation">:</span> <span class="number">213</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;prompt_eval_duration&quot;</span><span class="punctuation">:</span> <span class="number">11306354000</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;eval_count&quot;</span><span class="punctuation">:</span> <span class="number">25</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;eval_duration&quot;</span><span class="punctuation">:</span> <span class="number">3082983000</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h5 id="返回结果">返回结果</h5><table><thead><tr><th>状态码</th><th>状态码含义</th><th>说明</th><th>数据模型</th></tr></thead><tbody><tr><td>200</td><td>OK</td><td>成功</td><td>Inline</td></tr></tbody></table><p>返回数据结构</p><p>状态码 <strong>200</strong> 时才返回以下信息。</p><table><thead><tr><th>名称</th><th>类型</th><th>必选</th><th>约束</th><th>中文名</th><th>说明</th></tr></thead><tbody><tr><td>model</td><td>string</td><td>true</td><td>none</td><td>模型</td><td>none</td></tr><tr><td>created_at</td><td>string</td><td>true</td><td>none</td><td>响应时间</td><td>none</td></tr><tr><td>message</td><td>object</td><td>true</td><td>none</td><td>响应内容</td><td>none</td></tr><tr><td>role</td><td>string</td><td>true</td><td>none</td><td>角色</td><td>none</td></tr><tr><td>content</td><td>string</td><td>true</td><td>none</td><td>内容</td><td>none</td></tr><tr><td>tool_calls</td><td>[object]</td><td>false</td><td>none</td><td>调用的工具集</td><td></td></tr><tr><td>done</td><td>boolean</td><td>false</td><td>none</td><td></td><td>none</td></tr><tr><td>total_duration</td><td>integer</td><td>false</td><td>none</td><td>总耗时</td><td>none</td></tr><tr><td>load_duration</td><td>integer</td><td>false</td><td>none</td><td>模型加载耗时</td><td>none</td></tr><tr><td>prompt_eval_count</td><td>integer</td><td>false</td><td>none</td><td>提示词token消耗数</td><td>none</td></tr><tr><td>prompt_eval_duration</td><td>integer</td><td>false</td><td>none</td><td>提示词耗时</td><td>none</td></tr><tr><td>eval_count</td><td>integer</td><td>false</td><td>none</td><td>响应token消耗数</td><td>none</td></tr><tr><td>eval_duration</td><td>integer</td><td>false</td><td>none</td><td>响应耗时</td><td>none</td></tr></tbody></table><h5 id="对话操作演示">对话操作演示</h5><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240620212328483-1024x576.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-65-1024x958.png" alt="img"></p><h5 id="视觉对话演示">视觉对话演示</h5><p>随着技术与算力的进步，大模型也逐渐分化成多种类型，而在这些种类中比较常见的有：</p><ul><li>大语言模型：用于文生文，典型的使用场景是：对话聊天—仅文字对话Qwen、ChatGLM3、Baichuan、Mistral、LLaMA3、YI、InternLM2、DeepSeek、Gemma、Grok 等等</li><li>文本嵌入模型：用于内容的向量化，典型的使用场景是：模型微调text2vec、openai-text embedding、m3e、bge、nomic-embed-text、snowflake-arctic-embed</li><li>重排模型：用于向量化数据的优化增强，典型的使用场景是：模型微调bce-reranker-base_v1、bge-reranker-large、bge-reranker-v2-gemma、bge-reranker-v2-m3</li><li>多模态模型：用于上传文本或图片等信息，然后生成文本或图片，典型的使用场景是：对话聊天—拍照批改作业Qwen-VL 、Qwen-Audio、YI-VL、DeepSeek-VL、Llava、MiniCPM-V、InternVL</li><li>语音识别语音播报：用于文生音频、音频转文字等，典型的使用场景是：语音合成Whisper 、VoiceCraft、StyleTTS 2 、Parler-TTS、XTTS、Genny</li><li>扩散模型：用于文生图、文生视频，典型的使用场景是：文生图AnimateDiff、StabilityAI系列扩散模型</li></ul><p>在这些模型中，Ollama目前仅支持大语言模型、文本嵌入模型、多模态模型，文本嵌入模型在后面的会学习，再此可以先来体验一下多模态模型：</p><p><strong>Step 1：私有化多模态大模型</strong></p><p>LLaVA（ Large Language and Vision Assistant）是一个开源的多模态大模型，它可以同时处理文本、图像和其他类型的数据，实现跨模态的理解和生成。</p><p>网址:<a href="https://github.com/haotian-liu/LLaVA.git">https://github.com/haotian-liu/LLaVA.git</a></p><p><strong>Step 2：准备图片素材</strong></p><p>然后通过程序把图片数据转出Base64字符串：</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span>(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line"><span class="type">byte</span>[] bytes = FileUtil.<span class="property">readBytes</span>(<span class="keyword">new </span><span class="class title_">File</span>(<span class="string">&quot;assets\Snipaste_2024-06-22_16-01-31.png&quot;</span>));</span><br><span class="line"><span class="built_in">String</span> <span class="built_in">str</span> = Base64.<span class="property">encode</span>(bytes);</span><br><span class="line">System.<span class="property">out</span>.<span class="property">println</span>(<span class="built_in">str</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>生成的Base64也可以在【资料/多模态测试图片Base64字符串.txt 】中找到。</p><p><strong>Step 3：调用多模态接口</strong></p><p>在Ollama中可以通过内容生成接口和聊天对话接口来支持多模态，在此以聊天对话接口为例：</p><ul><li>图片信息通过images字段传入，且可传入多张</li><li>识别的结果为引文，需要自行翻译</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240622163209620-1024x576.png" alt="img"></p><h4 id="向量化接口说明">向量化接口说明</h4><p>向量化接口常用来进行模型的微调（训练），请求的地址与参数如下：</p><blockquote><p>POST /api/embeddings</p></blockquote><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;model&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">  <span class="string">&quot;prompt&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">  <span class="string">&quot;keep_alive&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">  <span class="string">&quot;options&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;seed&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;top_k&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;top_p&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;repeat_last_n&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;temperature&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;repeat_penalty&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;stop&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;string&quot;</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="请求参数-2">请求参数</h5><table><thead><tr><th>名称</th><th>位置</th><th>类型</th><th>必选</th><th>中文名</th><th>说明</th></tr></thead><tbody><tr><td>body</td><td>body</td><td>object</td><td>否</td><td></td><td>none</td></tr><tr><td>model</td><td>body</td><td>string</td><td>是</td><td>模型名称</td><td>none</td></tr><tr><td>prompt</td><td>body</td><td>string</td><td>是</td><td>要向量化的文本</td><td>none</td></tr><tr><td>keep_alive</td><td>body</td><td>string</td><td>否</td><td>模型内存保持时间</td><td>5m</td></tr><tr><td>options</td><td>body</td><td>object</td><td>否</td><td>配置参数</td><td>none</td></tr><tr><td>seed</td><td>body</td><td>integer</td><td>否</td><td>生成种子</td><td>none</td></tr><tr><td>top_k</td><td>body</td><td>integer</td><td>否</td><td>多样度</td><td>越高越多样，默认40</td></tr><tr><td>top_p</td><td>body</td><td>number</td><td>否</td><td>保守度</td><td>越低越保守，默认0.9</td></tr><tr><td>repeat_last_n</td><td>body</td><td>integer</td><td>否</td><td>防重复回顾距离</td><td>默认: 64, 0 = 禁用, -1 = num_ctx</td></tr><tr><td>temperature</td><td>body</td><td>number</td><td>否</td><td>温度值</td><td>越高创造性越强，默认0.8</td></tr><tr><td>repeat_penalty</td><td>body</td><td>number</td><td>否</td><td>重复惩罚强度</td><td>越高惩罚越强，默认1.1</td></tr><tr><td>stop</td><td>body</td><td>[string]</td><td>是</td><td>停止词</td><td>none</td></tr></tbody></table><h5 id="返回示例-2">返回示例</h5><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;embedding&quot;</span>: [</span><br><span class="line">    <span class="number">0</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="返回结果-2">返回结果</h5><table><thead><tr><th>状态码</th><th>状态码含义</th><th>说明</th><th>数据模型</th></tr></thead><tbody><tr><td>200</td><td>OK</td><td>成功</td><td>Inline</td></tr></tbody></table><h5 id="返回数据结构">返回数据结构</h5><p>状态码 <strong>200</strong></p><table><thead><tr><th>名称</th><th>类型</th><th>必选</th><th>约束</th><th>中文名</th><th>说明</th></tr></thead><tbody><tr><td>embedding</td><td>[number]</td><td>true</td><td>none</td><td>向量化数组</td><td>none</td></tr></tbody></table><h5 id="操作演示">操作演示</h5><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240620215522035-1024x576.png" alt="img"></p><h2 id="5-LobeChat与Ollama快速搭建ChatBot">5.<strong>LobeChat与Ollama快速搭建ChatBot</strong></h2><p>企业为避免《三星被曝因ChatGPT泄露芯片机密！韩媒：数据「原封不动」传美国》类似的情况发生，可以采取部署企业私有大模型的方案来解决此问题，这就引出了接下要学习的知识：搭建企业私有ChatBot。要完成这个知识需要先学习一个LebeChat的软件，我们接下来看一下：</p><h3 id="1-LobeChat是什么">1.LobeChat是什么</h3><p>LobeChat是一个基于现代化设计的开源 ChatGPT/LLMs 聊天应用与开发框架，可以用于快速搭建ChatBot应用。</p><p>LobeChat功能特点包含：</p><ul><li>一键免费拥有你自己的 ChatGPT/Gemini/Claude/Ollama 应用</li><li>支持视觉模型</li><li>支持语音TTS</li><li>支持本地大模型</li><li>支持多平台AI接入</li><li>支持插件扩展</li><li>支持智能体市场</li><li>支持包含中文、英文等多国语言</li><li>支持渐进式，移动设备自动适配</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/306135690-9f155dff-4737-429f-9cad-a70a1a860c5f-1024x385.png" alt="img"></p><h3 id="2-安装LobeChat">2.安装LobeChat</h3><p>拉取镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull lobehub/lobe-chat:latest</span><br></pre></td></tr></table></figure><p>启动容器</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">docker</span> run -d <span class="punctuation">\</span></span><br><span class="line"><span class="punctuation"></span>  --name lobe-chat <span class="punctuation">\</span></span><br><span class="line"><span class="punctuation"></span>  -p <span class="number">3210</span>:<span class="number">3210</span> <span class="punctuation">\</span></span><br><span class="line"><span class="punctuation"></span>  --restart=always <span class="punctuation">\</span></span><br><span class="line"><span class="punctuation"></span>  lobehub/lobe-chat:latest</span><br></pre></td></tr></table></figure><p><strong>访问LobeChat</strong></p><p>在浏览器中直接输入虚拟机的地址+3210端口，即可打开一下界面，则表示安装成功。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-66-1024x510.png" alt="img"></p><h3 id="3-LobeChat集成Ollama">3.LobeChat集成Ollama</h3><p>LobeChat对话聊天实际是调用的第三方AI平台，并且支持非常丰富的平台</p><p>除此之外，LobeChat也支持与本地私有部署的大模型就行对话，而这种组合使用场景非常适合数据敏感的企业。</p><p>要在LobeChat中使用Ollama中的大模型，也非常便捷，可以按照以下步骤进行操作：</p><p><strong>Step 1：运行本地大模型</strong></p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ollama <span class="built_in">run</span> qwen2 <span class="comment">--keepalive 1h</span></span><br></pre></td></tr></table></figure><p>命令说明：</p><ul><li>命令运行的是通义大模型</li><li>通过<code>--keepalive</code>参数设置大模型被加载到内存中的存活时长为1小时</li></ul><p><strong>Step 2：配置Ollama信息</strong></p><p>进入对话聊天界面，并点击1位置的设置按钮，则弹出下图中间区域的对话框，然后点击2位置的【语言模型】菜单，然后在对话框右侧中关闭OpenAI的开关，并打开Ollama的开关，然后按图填写信息：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240621155728868-1024x576.png" alt="img"></p><p><strong>Step 3：开始对话</strong></p><p>配置完成之后，返回对话界面，在1号位置选择通义大模型，然后即可开始对话聊天。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240621162513019-1024x576.png" alt="img"></p><h3 id="4-体验LobeChat助手">4.体验LobeChat助手</h3><p>在对话模型中，我们可以借助智能助手来高效完成一些特点场景的需求，比如：通过对话让AI把Java类转为Mysql的创表SQL语句。要实现这个需求，可以在LobeChat中按照以下步骤进行操作：</p><h4 id="安装助手">安装助手</h4><p>进入【助手市场】，在首页找到【Java Class 转 MySQL】助手，然后点击则会看见右侧出来助手详情，点击【添加助手并会话】按钮，即可立即使用助手。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240621190844623-1024x576.png" alt="img"></p><h4 id="体验助手">体验助手</h4><p>添加的助手自动会保存在左侧的列表中，点击添加的助手即可在中间的对话框中进行聊天。</p><p>对话模型即可返回对应的sql语句：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240621193935813-1024x522.png" alt="img"></p><h4 id="助手实现原理">助手实现原理</h4><p>在类似ChatGPT、通义千问、星火等对话类大模型中，消息常常被分为3种类型：</p><ul><li>用户消息（User）：即用户输入的信息，也常被称为提示词；（如下图1）</li><li>AI消息（Assistant）：即AI推理输出的信息；（如下图1）</li><li>系统消息（System）：一般用来约定对话功能范围、格式、语气语境等的文本即为系统消息。（如下图2）</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240621200152523-1024x326.png" alt="img"></p><p>系统消息一般是不会直接显示在对话内容区域中的，但是为了体验的良好，系统消息会转换成【招呼语】发送到对话框中：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240621204432119-1024x218.png" alt="img"></p><p>类似ChatGPT、通义千问、星火等对话类大模型中的助手，其实底层就是通过约定对话内容、格式等信息来进行实现的，最后通过系统消息来传输这部分约定的信息。</p><p>上述这些消息虽然不全在对话框中显示，但是都会体现在请求接口中，比如直接通过Ollama Chat进行对话：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240621212252254-1024x576.png" alt="img"></p><p>如果增加上system消息之后，可见AI回复的内容就按照约定的格式或范围进行输出了，进而证明了助手的实现原理即通过约定系统消息来进行实现。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-20240621213601959-1024x576.png" alt="img"></p><h2 id="6-MaxDB与Ollama快速搭建知识库">6.<strong>MaxDB与Ollama快速搭建知识库</strong></h2><p>在企业中，搭建后私有的ChatBot后，可以快速解决数据泄露的问题，但同时也会提出：如果把企业内部数据融入到私有大模型中？的问题。因为把企业内部数据融入到大模型中之后，可以让大模型的识别当前企业的信息，更准备、高效的帮助企业内部员工解决日常工作问题。</p><p>而当下要解决这个问题，企业中常用的方案是：基于大模型搭建私有的知识库。要完成这个知识需要先学习一个MaxKB的软件，我们接下来看一下：</p><h3 id="1-MaxDB是什么">1.MaxDB是什么</h3><p>MaxKB 是一款基于 LLM 大语言模型的知识库问答系统。MaxKB = Max Knowledge Base，旨在成为企业的最强大脑。</p><p>网址：<a href="https://github.com/1Panel-dev/MaxKB">https://github.com/1Panel-dev/MaxKB</a></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-68.png" alt="img"></p><p>MaxKB的功能特点包含：</p><ul><li><strong>开箱即用</strong>：支持直接上传文档、自动爬取在线文档，支持文本自动拆分、向量化、RAG（检索增强生成），智能问答交互体验好；</li><li><strong>无缝嵌入</strong>：支持零编码快速嵌入到第三方业务系统；</li><li><strong>多模型支持</strong>：支持对接主流的大模型，包括 Ollama 本地私有大模型（如 Meta Llama 3、qwen 等）、通义千问、OpenAI、Azure OpenAI、Kimi、智谱 AI、讯飞星火和百度千帆大模型等。</li></ul><h3 id="2-安装MaxKB">2.安装MaxKB</h3><p>MaxKB提供了docker安装镜像，相关镜像已下载到01相关软件资源/docker镜像/maxkb.zip，可以上传到/root/docker/目录，然后通过以下操作进行安装：</p><p><strong>Step 1: 拉取镜像</strong></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拉取最新镜像</span></span><br><span class="line"><span class="attribute">docker</span> pull <span class="number">1</span>panel/maxkb:latest</span><br></pre></td></tr></table></figure><p><strong>Step 2：运行容器</strong></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动容器</span></span><br><span class="line"><span class="attribute">docker</span> run -d --name maxkb <span class="punctuation">\</span></span><br><span class="line"><span class="punctuation"></span>  -p <span class="number">8080</span>:<span class="number">8080</span> <span class="punctuation">\</span></span><br><span class="line"><span class="punctuation"></span>  --restart=always <span class="punctuation">\</span></span><br><span class="line"><span class="punctuation"></span>  <span class="number">1</span>panel/maxkb:latest</span><br></pre></td></tr></table></figure><p>指令说明：</p><ul><li>-p 默认映射端口为 <code>3211</code>, 请确保未被占用或手动更改端口映射</li><li>-v 映射本地/root/data/maxkb到容器中/var/lib/postgresql/data目录，这样可以持久化容器数据到宿主机</li></ul><p><strong>Step 3：访问MaxKB</strong></p><p>在浏览器中直接输入虚拟机的地址+3211端口，即可打开一下界面，则表示安装成功。</p><blockquote><p>用户名: admin</p><p>密码: MaxKB@123…</p><p>改个密码</p></blockquote><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-69-1024x391.png" alt="img"></p><h3 id="3-MaxKB集成Ollama">3.MaxKB集成Ollama</h3><p>MaxKB作为知识库，需要用到大模型对知识库中的文档资料进行分析，而MaxKB支持的大模型也非常丰富，包括：</p><ul><li>Azure OpenAI</li><li>千帆大模型</li><li>Ollama</li><li>OpenAI</li><li>Kimi</li><li>通义千问</li><li>讯飞星火</li><li>智谱AI</li><li>DeepSeek</li><li>Gemini</li></ul><p>在这些大模型中，除Ollama之外，都是远程调用的三方API，收费的且数据不安全，因此在这里还是主要学习：MaxKB如何与Ollama集成。</p><p>在MaxKB中集成Ollama，操作也较为简单，按照以下配置操作即可：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-70-1024x435.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-71.png" alt="img"></p><p>参数说明：</p><ul><li>模型名称：可任意输入一个名称，便于后期知识库使用模型时的选择</li><li>模型类型：目前仅支持大语言模型</li><li>基础模型：即要使用的大模型名称，这个名称，必须和ollama list列表中的名称一致注：如果下拉选项中没有大模型名称，可以直接输入大模型名称，然后回车</li><li>API域名：填写访问Ollama的地址，<a href="http://192.168.100.129:11434">http://192.168.100.129:11434</a></li><li>API KEY：授权码，这里没有，则填写任意值</li></ul><h3 id="4-新建白板应用">4.新建白板应用</h3><p>配置完成大模型之后，即可在MaxKB【应用】中使用相关大模型，因此接下来可以先创建一个白板应用，来测试一下大模型是否连通，具体操作可参考一下步骤。</p><h4 id="进入创建应用界面">进入创建应用界面</h4><p>进入【应用】页面中，并点击【创建应用】按钮。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-72-1024x216.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-73-1024x488.png" alt="img"></p><h3 id="5-文本知识库-应用">5.文本知识库&amp;应用</h3><h4 id="为什么要用知识库？">为什么要用知识库？</h4><p>我们直接与大模型对话，询问一些与自己公司相关的问题，往往大模型因为训练数据中不存在公司的详细信息，因此都不能准确的回答</p><h4 id="进入创建知识库">进入创建知识库</h4><p>点击【知识库】菜单，然后点击【创建知识库】进入创建页面。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-74-1024x257.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-75.png" alt="img"></p><h4 id="命中测试">命中测试</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-76-1024x534.png" alt="img"></p><h4 id="新增周杰伦应用">新增周杰伦应用</h4><p>上一步只是测试把我们问题与知识片段进行关联，接下来还需要把这些内容都告诉大模型，这样便能提供大模型的回答准确性。而这个过程还是通过应用来操作，因此可新建一个叫周杰伦的应用：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-77.png" alt="img"></p><h4 id="使用应用测试">使用应用测试</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-78-1024x735.png" alt="img"></p><h3 id="6-QA知识库-应用">6.QA知识库&amp;应用</h3><p>MaxKB除了支持文本文件上传之外，还支持QA问答对的文档导入，这种方式对导入数据格式是有要求的，相对效果也文本文档略好，因此接下来也演示一下这种方式。</p><h4 id="1-准备数据">1.准备数据</h4><p>在这里小节，我们准备搭建一个面试题知识库，用到的面试题放在【资料\知识库\<a href="http://xn--Redis-0b8j69i263edkya.md">Redis训练数据.md</a>】文件中，可以看的这个训练数据是一个markdown文件，而MaxKB训练数据要求的格式为Excel文档：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-79-1024x163.png" alt="img"></p><p>因此这里可以写一个类，通过EasyExcel来把训练数据转出需要的格式：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.32<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>easyexcel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ETLData</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">void</span> <span class="title function_">main</span>(<span class="title class_">String</span>[] args) throws <span class="title class_">FileNotFoundException</span>, <span class="title class_">InterruptedException</span> &#123;</span><br><span class="line">        <span class="title class_">List</span>&lt;<span class="title class_">String</span>&gt; lines = <span class="title class_">FileUtil</span>.<span class="title function_">readUtf8Lines</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;资料\\知识库\\1.md&quot;</span>));</span><br><span class="line">        <span class="title class_">StringJoiner</span> temp = <span class="keyword">new</span> <span class="title class_">StringJoiner</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        <span class="title class_">StringBuffer</span> tempCont = <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        <span class="title class_">String</span> tempTile = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="title class_">List</span>&lt;<span class="title class_">TData</span>&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="title class_">String</span> line : lines) &#123;</span><br><span class="line">            line =  line.<span class="title function_">trim</span>();</span><br><span class="line">            <span class="keyword">if</span>(line.<span class="title function_">startsWith</span>(<span class="string">&quot;##&quot;</span>))&#123;</span><br><span class="line">                <span class="keyword">if</span>(tempTile!=<span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">                    temp.<span class="title function_">add</span>(tempCont.<span class="title function_">toString</span>()).<span class="title function_">add</span>(tempTile);</span><br><span class="line">                    list.<span class="title function_">add</span>(<span class="keyword">new</span> <span class="title class_">TData</span>(tempTile,tempCont.<span class="title function_">toString</span>()));</span><br><span class="line">                &#125;</span><br><span class="line">                tempTile = line;</span><br><span class="line">                tempCont = <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span>(line!=<span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">                tempCont.<span class="title function_">append</span>(line);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(tempTile!=<span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">            temp.<span class="title function_">add</span>(tempCont.<span class="title function_">toString</span>()).<span class="title function_">add</span>(tempTile);</span><br><span class="line">            list.<span class="title function_">add</span>(<span class="keyword">new</span> <span class="title class_">TData</span>(tempTile,tempCont.<span class="title function_">toString</span>()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title class_">EasyExcel</span>.<span class="title function_">write</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;C:\\Users\\luoxu\\Desktop\\1.xlsx&quot;</span>)), <span class="title class_">TData</span>.<span class="property">class</span>)</span><br><span class="line">                .<span class="title function_">sheet</span>(<span class="string">&quot;Redis面试题&quot;</span>)</span><br><span class="line">                .<span class="title function_">doWrite</span>(list);</span><br><span class="line">        <span class="title class_">Thread</span>.<span class="title function_">sleep</span>(<span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TData</span> &#123;</span><br><span class="line">        <span class="meta">@ExcelProperty</span>(value = <span class="string">&quot;分段标题（选填）&quot;</span>)</span><br><span class="line">        <span class="title class_">String</span> category;</span><br><span class="line">        <span class="meta">@ExcelProperty</span>(value = <span class="string">&quot;分段内容（必填，问题答案，最长不超过4096个字符）&quot;</span>)</span><br><span class="line">        <span class="title class_">String</span> content;</span><br><span class="line">        <span class="meta">@ExcelProperty</span>(value = <span class="string">&quot;问题（选填，单元格内一行一个）&quot;</span>)</span><br><span class="line">        <span class="title class_">String</span> title;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title class_">TData</span>(<span class="title class_">String</span> title,<span class="title class_">String</span> content)&#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">title</span> = title;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">content</span> = content;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">category</span> = title;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-80-1024x389.png" alt="img"></p><h4 id="2-创建Redis知识库">2.创建Redis知识库</h4><p>创建一个新的知识库，然后参考下图填写信息和选择训练数据。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-81-1024x578.png" alt="img"></p><h4 id="3-创建Redis面试应用">3.创建Redis面试应用</h4><p>创建一个新的应用，并按照下图进行填写，并点击【创建】按钮创建应用。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-82-1024x574.png" alt="img"></p><h4 id="5-使用Redis面试应用">5.使用Redis面试应用</h4><p>我们先用白板应用对话，然后对比Redis面试对话，好体验出效果。首选看看白板对话：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-83-1024x746.png" alt="img"></p><p>再看看引入知识库的Redis面试应用效果：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-84-1024x288.png" alt="img"></p><p>对比两种效果，可以发现，接入知识库的效果，非常专业和精确。</p><h3 id="7-通过API调用MaxKB">7.通过API调用MaxKB</h3><h4 id="导入API">导入API</h4><p>MaxKB创建好应用之后，也可以通过API接口，让其它应用程序来访问。目前MaxKB提供了3个API接口</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-87-1024x394.png" alt="img"></p><p>这三个接口也在资料文件夹下提供了Apifox的json文件MaxKB.apifox.json。为方便测试，可以先导入到Apifox中</p><h4 id="获取应用信息">获取应用信息</h4><p>导入成功之后，会看见三个接口，这三个接口是存在调用前后关系的，如：</p><ul><li>首选需要调用【获取应用信息】，获得【应用id】</li><li>然后调用【创建一个会话】接口，获得【会话id】：这个接口会用到【应用id】</li><li>最后调用【应用对话接口】，即可正常对话：这个接口会用到【应用id】和【会话id】</li></ul><p>因此这里可以先调用【获取应用接口】：</p><p><strong>Step 1：拷贝API Key</strong></p><p>在应用信息中，点击【API Key】按钮弹出API Key窗口</p><p>第一次进入，可以点击【创建】按钮，创建一个key，然后点击复制按钮：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-86-1024x893.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-88.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-89.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-90.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-91-1024x481.png" alt="img"></p><h2 id="7-Continue与Ollama快速集成">7.Continue与Ollama快速集成</h2><p>在前面的学习的LobeChat可以让企业快速搭建私有对话模型解决数据泄密等安全问题，MaxKB可以把企业内部信息融入到大模型中，解决私有域数据不能被访问的问题。而接下来学习的Continue，则是面向企业内部程序员的，用于帮助程序员开始生成代码、代码排错的，与通义灵码类似，但相比通义灵码，企业结合Continue+Ollama可以更好的避免内部价值代码的安全，不被传输到外网。</p><h3 id="1-Continue是什么">1.Continue是什么</h3><p>Continue：领先的开源AI代码助手。可以通过Continue连接大模型，在IDE中完成自动代码提示与聊天。</p><p>Continue的功能特点包含：</p><ul><li>支持丰富的大模型</li><li>支持丰富上下文内容</li><li>支持丰富的扩展</li></ul><h3 id="2-安装Continue">2.安装Continue</h3><p>Continue在IDEA中是一个插件，进入插件市场搜索并安装，最后点击【ok】按钮即可。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-92-1024x767.png" alt="img"></p><h3 id="3-Continue集成Ollama">3.Continue集成Ollama</h3><h4 id="配置config-ymal">配置config.ymal</h4><p>修改配置文件内容为一下内容，然后重启IDEA。</p><p>重启IDEA之后，即可在Continue中使用正常与大模型对话：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-94.png" alt="img"></p><p>测试通过这里回答很傻逼的原因是用的模型太低级，主要是 1.5B 模型能力问题，换 7B/聊天模型就可以了</p><h3 id="4-使用Continue自动代码提示">4.使用Continue自动代码提示</h3><blockquote><blockquote><blockquote><p>注意：使用私有的Continue时，为避免与通义灵码等插件的功能冲突，需要先卸载通义灵码。</p></blockquote></blockquote></blockquote><p>Continue提供了通过Tab键进行代码生成提示的功能，但是默认此功能是关闭的，因此要使用则需要在Setting中开启相关功能。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-93-1024x754.png" alt="img"></p><h2 id="大模型私有部署篇完结">大模型私有部署篇完结</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-112-1024x694.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/09/image-113-1024x517.png" alt="img"></p>]]></content>
    
    
    <summary type="html">AIGC应用与智能体开发之大模型私有部署（Ollama,LobeChat，MaxDB，Continue）</summary>
    
    
    
    <category term="AI" scheme="https://itgeqian.github.io/categories/AI/"/>
    
    
    <category term="AIGC" scheme="https://itgeqian.github.io/tags/AIGC/"/>
    
    <category term="大模型私有部署" scheme="https://itgeqian.github.io/tags/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E7%A7%81%E6%9C%89%E9%83%A8%E7%BD%B2/"/>
    
  </entry>
  
</feed>
