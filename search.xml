<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>GQ Video项目部署</title>
      <link href="/posts/2.html"/>
      <url>/posts/2.html</url>
      
        <content type="html"><![CDATA[<table><thead><tr><th>服务名称</th><th>英文名</th><th>端口号</th><th>版本号</th><th>服务类别</th></tr></thead><tbody><tr><td>数据库</td><td>mysql</td><td>3306</td><td>v8.26</td><td>环境依赖</td></tr><tr><td>搜索引擎</td><td>es</td><td>9201</td><td>3.1.9</td><td>环境依赖</td></tr><tr><td>缓存</td><td>Redis</td><td>6379</td><td>v8</td><td>环境依赖</td></tr><tr><td>消息队列</td><td>RocketMQ</td><td></td><td>2.3.0</td><td>环境依赖</td></tr><tr><td>注册中心</td><td>nacos</td><td>8848</td><td>v2.2.0</td><td>环境依赖</td></tr><tr><td>网关服务</td><td>easylive-cloud-gateway</td><td>7071</td><td>java8</td><td>项目</td></tr><tr><td>分布式事务</td><td>Seata</td><td>7091</td><td>2021.0.5.0</td><td>环境依赖</td></tr><tr><td>对象存储</td><td>Minio</td><td>9000</td><td>2024-09-13T20-26-02Z</td><td>环境依赖</td></tr><tr><td>管理端服务</td><td>easylive-cloud-admin</td><td>7070</td><td>java8</td><td>项目</td></tr><tr><td>用户端服务</td><td>easylive-cloud-web</td><td>7072</td><td>java8</td><td>项目</td></tr><tr><td>交互服务</td><td>easylive-cloud-interact</td><td>7073</td><td>java8</td><td>项目</td></tr><tr><td>资源服务</td><td>easylive-cloud-resource</td><td>7074</td><td>java8</td><td>项目</td></tr><tr><td></td><td></td><td></td><td></td><td></td></tr></tbody></table><h1 id="微服务项目部署指导">微服务项目部署指导</h1><p><em>Exported on 2025/10/6 at GMT+8 0:12:27 from Cursor (1.4.2)</em></p><hr><p><strong>User</strong></p><p>整个项目已经完结，请你仔细查看一下项目的结构，我现在想要把这个微服务项目部署到一个我已经准备好的4核4g的服务器上该如何部署，是选择用宝塔面板还是用docker compose部署呢，请你指引着我一步步完成部署@c:\Users\wanglei\Desktop\<a href="http://xn--i0yq5pe7ol9g.md">项目部署.md</a></p><hr><p><strong>Cursor</strong></p><p>我先快速查看各微服务的配置文件端口与外部依赖（Nacos、Redis、RocketMQ、Minio 等）的指向，确保 docker-compose 方案能一次性把依赖与服务都编排好。随后我会给出一步步部署清单与可直接使用的 compose 文件与构建命令。</p><p>我将先创建一个部署任务清单，随后直接给出推荐方案（Docker Compose）与可运行的命令、配置与文件模板。接下来我会把全部步骤一次性写全，便于你按部就班执行。</p><p>我先并行打开各微服务的配置文件，确认注册中心、配置名与端口设置，以便给出可直接可用的 docker-compose 参数和环境变量。接着我会确定采用 Docker Compose 的总体策略并开始给出脚本。</p><p>我已确认各服务的 <code>bootstrap.yml</code> 通过 Nacos 加载共享配置且默认指向 127.0.0.1:8848，容器化时需用环境变量覆盖为 nacos:8848。现在我先确定采用 Docker Compose 方案，并开始给出安装与编排文件。接下来把“安装 Docker/Compose”设为进行中。</p><p>我将并行打开各服务的 dev 配置文件，确认数据库、存储和消息队列的连接信息，以便在 docker-compose 中正确注入环境变量。</p><p>我将把“安装 Docker/Compose”完成并开始“创建目录结构与 .env 机密变量”，随后给出<code>.env</code>和<code>docker-compose.yml</code>模板与执行命令。接着我会继续推进依赖与应用编排等步骤，并同步勾选对应待办。</p><p>我已经确定采用 Docker Compose 部署，并开始输出目录结构、<code>.env</code> 与依赖编排模板，随后给出后端镜像构建与应用编排、前端与 Nginx 配置。接着我会把“创建目录结构与 .env”标记完成，并开启“依赖服务编排”和“应用编排”。</p><p>我已确认采用 Docker Compose 并核对了各微服务的 Nacos 配置与端口。现在我会直接给出一步步部署清单、必要命令与可用模板（.env、docker-compose、Dockerfile、Nginx），你可以按顺序执行。随后我会把清单项勾选完成。### 结论与建议</p><ul><li>建议使用 Docker Compose 部署。原因：<ul><li>多个基础依赖（MySQL/Redis/Nacos/RocketMQ/Minio/ES/Seata）与 5 个 SpringBoot 微服务需要统一编排、网络与持久化，更易复现与维护。</li><li>日志、重启策略、资源限制、备份与迁移都更容易标准化。</li></ul></li><li>4 核 4G 机器资源偏紧。建议先上线核心链路（MySQL、Redis、Nacos、Minio、网关与核心三服务），RocketMQ/ES/Seata如非强依赖可延后启用，或按需独立机器。</li></ul><h3 id="端口规划（来自你的部署文档）">端口规划（来自你的部署文档）</h3><ul><li>数据库 MySQL: 3306</li><li>Nacos: 8848</li><li>网关 <code>easylive-cloud-gateway</code>: 7071</li><li>管理端 <code>easylive-cloud-admin</code>: 7070</li><li>用户端 <code>easylive-cloud-web</code>: 7072</li><li>交互 <code>easylive-cloud-interact</code>: 7073</li><li>资源 <code>easylive-cloud-resource</code>: 7074</li><li>Redis: 6379</li><li>Minio: 9000(服务) + 9001(控制台)</li><li>RocketMQ/ES/Seata：按需启用（建议后置）</li></ul><p>下面步骤直接可执行，按顺序来。</p><h3 id="1-安装-Docker-Compose（以-Ubuntu-20-04-22-04-为例）">1) 安装 Docker &amp; Compose（以 Ubuntu 20.04/22.04 为例）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1) 基础依赖</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get update -y</span><br><span class="line"><span class="built_in">sudo</span> apt-get install -y ca-certificates curl gnupg lsb-release</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) Docker 仓库</span></span><br><span class="line"><span class="built_in">sudo</span> install -m 0755 -d /etc/apt/keyrings</span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg \</span><br><span class="line"> | <span class="built_in">sudo</span> gpg --dearmor -o /etc/apt/keyrings/docker.gpg</span><br><span class="line"><span class="built_in">echo</span> \</span><br><span class="line">  <span class="string">&quot;deb [arch=<span class="subst">$(dpkg --print-architecture)</span> signed-by=/etc/apt/keyrings/docker.gpg] \</span></span><br><span class="line"><span class="string">  https://download.docker.com/linux/ubuntu <span class="subst">$(lsb_release -cs)</span> stable&quot;</span> \</span><br><span class="line"> | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line"><span class="built_in">sudo</span> apt-get update -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3) 安装</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4) 免 sudo（重新登录生效）</span></span><br><span class="line"><span class="built_in">sudo</span> usermod -aG docker <span class="variable">$USER</span></span><br></pre></td></tr></table></figure><h3 id="2-目录结构与时区">2) 目录结构与时区</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /opt/easylive/&#123;mysql/data,mysql/init,redis,data,nacos,data,minio/data,nginx/conf.d,frontend/&#123;web,admin&#125;,logs&#125;</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /opt/easylive/&#123;gateway,admin,web,interact,resource&#125;/config</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /opt/easylive/&#123;rocketmq/&#123;namesrv,broker&#125;,es/data,seata&#125;</span><br><span class="line"><span class="built_in">sudo</span> timedatectl set-timezone Asia/Shanghai</span><br></pre></td></tr></table></figure><h3 id="3-env（放到-opt-easylive-env）">3) .env（放到 /opt/easylive/.env）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">TZ=Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="comment"># MySQL</span></span><br><span class="line">MYSQL_ROOT_PASSWORD=YourStrongRootPass!</span><br><span class="line">MYSQL_DATABASE=easylive</span><br><span class="line"></span><br><span class="line"><span class="comment"># Nacos</span></span><br><span class="line">NACOS_VERSION=v2.2.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># Minio</span></span><br><span class="line">MINIO_ROOT_USER=admin</span><br><span class="line">MINIO_ROOT_PASSWORD=YourStrongMinioPass!</span><br><span class="line"></span><br><span class="line"><span class="comment"># Java 内存建议（4G 机器尽量克制）</span></span><br><span class="line">JAVA_XMS=256m</span><br><span class="line">JAVA_XMX=512m</span><br></pre></td></tr></table></figure><h3 id="4-docker-compose-yml（放到-opt-easylive-docker-compose-yml）">4) docker-compose.yml（放到 /opt/easylive/docker-compose.yml）</h3><p>为节省内存，RocketMQ/ES/Seata 先注释，核心链路先跑通。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.9&quot;</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">easylive</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">easylive-net:</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">mysql-data:</span></span><br><span class="line">  <span class="attr">redis-data:</span></span><br><span class="line">  <span class="attr">nacos-data:</span></span><br><span class="line">  <span class="attr">minio-data:</span></span><br><span class="line">  <span class="attr">es-data:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--default-authentication-plugin=mysql_native_password</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--character-set-server=utf8mb4</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--collation-server=utf8mb4_unicode_ci</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_ROOT_PASSWORD=$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_DATABASE=$&#123;MYSQL_DATABASE&#125;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3306:3306&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql-data:/var/lib/mysql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./mysql/init:/docker-entrypoint-initdb.d</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD-SHELL&quot;</span>,<span class="string">&quot;mysqladmin ping -uroot -p$&#123;MYSQL_ROOT_PASSWORD&#125; | grep &#x27;mysqld is alive&#x27;&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:6.2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">command:</span> [ <span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;--appendonly&quot;</span>, <span class="string">&quot;yes&quot;</span> ]</span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-data:/data</span></span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">nacos:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nacos/nacos-server:$&#123;NACOS_VERSION&#125;</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MODE=standalone</span></span><br><span class="line">      <span class="comment"># 使用 MySQL 做持久化（推荐）</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PLATFORM=mysql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_SERVICE_HOST=mysql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_SERVICE_DB_NAME=nacos_config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_SERVICE_PORT=3306</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_SERVICE_USER=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_SERVICE_PASSWORD=$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="comment"># JVM 缩小</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JVM_XMS=256m</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JVM_XMX=512m</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JVM_XMN=256m</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="attr">mysql:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">service_healthy</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8848:8848&quot;</span></span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">minio:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">minio/minio:RELEASE.2024-09-13T20-26-02Z</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">minio</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MINIO_ROOT_USER=$&#123;MINIO_ROOT_USER&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MINIO_ROOT_PASSWORD=$&#123;MINIO_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">server</span> <span class="string">/data</span> <span class="string">--console-address</span> <span class="string">&quot;:9001&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">minio-data:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9000:9000&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9001:9001&quot;</span></span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 如无强依赖，先不启动下列服务，稳定后再启用</span></span><br><span class="line">  <span class="comment"># rocketmq-namesrv:</span></span><br><span class="line">  <span class="comment">#   image: apache/rocketmq:5.2.0</span></span><br><span class="line">  <span class="comment">#   container_name: rmq-namesrv</span></span><br><span class="line">  <span class="comment">#   ports: [&quot;9876:9876&quot;]</span></span><br><span class="line">  <span class="comment">#   environment:</span></span><br><span class="line">  <span class="comment">#     - TZ=$&#123;TZ&#125;</span></span><br><span class="line">  <span class="comment">#     - JAVA_OPT_EXT=-Xms256m -Xmx512m</span></span><br><span class="line">  <span class="comment">#   networks: [easylive-net]</span></span><br><span class="line">  <span class="comment">#   restart: always</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># rocketmq-broker:</span></span><br><span class="line">  <span class="comment">#   image: apache/rocketmq:5.2.0</span></span><br><span class="line">  <span class="comment">#   container_name: rmq-broker</span></span><br><span class="line">  <span class="comment">#   environment:</span></span><br><span class="line">  <span class="comment">#     - NAMESRV_ADDR=rmq-namesrv:9876</span></span><br><span class="line">  <span class="comment">#     - TZ=$&#123;TZ&#125;</span></span><br><span class="line">  <span class="comment">#     - JAVA_OPT_EXT=-Xms256m -Xmx512m</span></span><br><span class="line">  <span class="comment">#   depends_on: [rocketmq-namesrv]</span></span><br><span class="line">  <span class="comment">#   ports: [&quot;10911:10911&quot;,&quot;10909:10909&quot;,&quot;10912:10912&quot;]</span></span><br><span class="line">  <span class="comment">#   networks: [easylive-net]</span></span><br><span class="line">  <span class="comment">#   restart: always</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># es:</span></span><br><span class="line">  <span class="comment">#   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.22</span></span><br><span class="line">  <span class="comment">#   container_name: es</span></span><br><span class="line">  <span class="comment">#   environment:</span></span><br><span class="line">  <span class="comment">#     - discovery.type=single-node</span></span><br><span class="line">  <span class="comment">#     - xpack.security.enabled=false</span></span><br><span class="line">  <span class="comment">#     - ES_JAVA_OPTS=-Xms512m -Xmx512m</span></span><br><span class="line">  <span class="comment">#     - TZ=$&#123;TZ&#125;</span></span><br><span class="line">  <span class="comment">#   ulimits:</span></span><br><span class="line">  <span class="comment">#     memlock:</span></span><br><span class="line">  <span class="comment">#       soft: -1</span></span><br><span class="line">  <span class="comment">#       hard: -1</span></span><br><span class="line">  <span class="comment">#   ports:</span></span><br><span class="line">  <span class="comment">#     - &quot;9201:9200&quot;</span></span><br><span class="line">  <span class="comment">#   volumes:</span></span><br><span class="line">  <span class="comment">#     - es-data:/usr/share/elasticsearch/data</span></span><br><span class="line">  <span class="comment">#   networks: [easylive-net]</span></span><br><span class="line">  <span class="comment">#   restart: always</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># seata:</span></span><br><span class="line">  <span class="comment">#   image: seataio/seata-server:1.6.1</span></span><br><span class="line">  <span class="comment">#   container_name: seata</span></span><br><span class="line">  <span class="comment">#   environment:</span></span><br><span class="line">  <span class="comment">#     - SEATA_PORT=7091</span></span><br><span class="line">  <span class="comment">#     - TZ=$&#123;TZ&#125;</span></span><br><span class="line">  <span class="comment">#   ports: [&quot;7091:7091&quot;]</span></span><br><span class="line">  <span class="comment">#   networks: [easylive-net]</span></span><br><span class="line">  <span class="comment">#   restart: always</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ------------------ 应用服务 ------------------</span></span><br><span class="line">  <span class="attr">gateway:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">easylive-cloud-gateway:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">gateway</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVER_PORT=7071</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=dev</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848</span></span><br><span class="line">    <span class="attr">depends_on:</span> [<span class="string">nacos</span>]</span><br><span class="line">    <span class="attr">ports:</span> [<span class="string">&quot;7071:7071&quot;</span>]</span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">admin:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">easylive-cloud-admin:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVER_PORT=7070</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=dev</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="comment"># 覆盖数据库与 Redis（如 Nacos 未配置完整）</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/easylive?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_USERNAME=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PASSWORD=$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_HOST=redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_PORT=6379</span></span><br><span class="line">    <span class="attr">depends_on:</span> [<span class="string">mysql</span>, <span class="string">redis</span>, <span class="string">nacos</span>]</span><br><span class="line">    <span class="attr">ports:</span> [<span class="string">&quot;7070:7070&quot;</span>]</span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">easylive-cloud-web:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVER_PORT=7072</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=dev</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/easylive?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_USERNAME=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PASSWORD=$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_HOST=redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_PORT=6379</span></span><br><span class="line">    <span class="attr">depends_on:</span> [<span class="string">mysql</span>, <span class="string">redis</span>, <span class="string">nacos</span>]</span><br><span class="line">    <span class="attr">ports:</span> [<span class="string">&quot;7072:7072&quot;</span>]</span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">interact:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">easylive-cloud-interact:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">interact</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVER_PORT=7073</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=dev</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/easylive?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_USERNAME=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PASSWORD=$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_HOST=redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_PORT=6379</span></span><br><span class="line">    <span class="attr">depends_on:</span> [<span class="string">mysql</span>, <span class="string">redis</span>, <span class="string">nacos</span>]</span><br><span class="line">    <span class="attr">ports:</span> [<span class="string">&quot;7073:7073&quot;</span>]</span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">resource:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">easylive-cloud-resource:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">resource</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVER_PORT=7074</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=dev</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/easylive?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_USERNAME=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PASSWORD=$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_HOST=redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_PORT=6379</span></span><br><span class="line">      <span class="comment"># 如资源服务用到 Minio，请在 Nacos 配置或此处补充访问参数</span></span><br><span class="line">      <span class="comment"># - MINIO_ENDPOINT=http://minio:9000</span></span><br><span class="line">      <span class="comment"># - MINIO_ACCESS_KEY=$&#123;MINIO_ROOT_USER&#125;</span></span><br><span class="line">      <span class="comment"># - MINIO_SECRET_KEY=$&#123;MINIO_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="comment"># - MINIO_BUCKET=your-bucket</span></span><br><span class="line">    <span class="attr">depends_on:</span> [<span class="string">mysql</span>, <span class="string">redis</span>, <span class="string">nacos</span>, <span class="string">minio</span>]</span><br><span class="line">    <span class="attr">ports:</span> [<span class="string">&quot;7074:7074&quot;</span>]</span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.25</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">depends_on:</span> [<span class="string">gateway</span>]</span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx/conf.d:/etc/nginx/conf.d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./frontend/web:/usr/share/nginx/html</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./frontend/admin:/usr/share/nginx/html/admin</span></span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br></pre></td></tr></table></figure><h3 id="5-后端服务镜像构建">5) 后端服务镜像构建</h3><p>建议每个服务放一个最简 Dockerfile（以 <code>easylive-cloud-gateway</code> 为例）：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 放在 easylive-server/easylive-cloud/easylive-cloud-gateway/Dockerfile</span></span><br><span class="line"><span class="keyword">FROM</span> eclipse-temurin:<span class="number">8</span>-jre</span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> target/*.jar app.jar</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">7071</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>,<span class="string">&quot;-Xms<span class="variable">$&#123;JAVA_XMS:-256m&#125;</span>&quot;</span>,<span class="string">&quot;-Xmx<span class="variable">$&#123;JAVA_XMX:-512m&#125;</span>&quot;</span>,<span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;/app/app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>构建步骤（在你的仓库根目录执行；其他四个服务同理更换路径与镜像名/端口）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打包全部（跳过测试）</span></span><br><span class="line"><span class="built_in">cd</span> /path/to/easylive-springcloud/easylive-server</span><br><span class="line">./mvnw -v || mvn -v</span><br><span class="line">mvn -DskipTests clean package</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建镜像（五个服务）</span></span><br><span class="line">docker build -t easylive-cloud-gateway:latest \</span><br><span class="line">  easylive-cloud/easylive-cloud-gateway</span><br><span class="line"></span><br><span class="line">docker build -t easylive-cloud-admin:latest \</span><br><span class="line">  easylive-cloud/easylive-cloud-admin</span><br><span class="line"></span><br><span class="line">docker build -t easylive-cloud-web:latest \</span><br><span class="line">  easylive-cloud/easylive-cloud-web</span><br><span class="line"></span><br><span class="line">docker build -t easylive-cloud-interact:latest \</span><br><span class="line">  easylive-cloud/easylive-cloud-interact</span><br><span class="line"></span><br><span class="line">docker build -t easylive-cloud-resource:latest \</span><br><span class="line">  easylive-cloud/easylive-cloud-resource</span><br></pre></td></tr></table></figure><p>注意：</p><ul><li>端口通过 <code>SERVER_PORT</code> 覆盖为 7071/7070/7072/7073/7074，跟你的表一致。</li><li>Nacos 地址在容器间为 <code>nacos:8848</code>（已在 compose 中用环境变量覆盖）。</li><li>数据库/Redis 在容器间为 <code>mysql:3306</code>、<code>redis:6379</code>。</li></ul><h3 id="6-Nginx-反代与前端">6) Nginx 反代与前端</h3><p><code>/opt/easylive/nginx/conf.d/easylive.conf</code>：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">server_name</span> _;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 用户端 Web 静态</span></span><br><span class="line">  <span class="attribute">root</span> /usr/share/nginx/html;</span><br><span class="line">  <span class="attribute">index</span> index.html;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 管理端静态（访问 /admin/）</span></span><br><span class="line">  <span class="section">location</span> /admin/ &#123;</span><br><span class="line">    <span class="attribute">alias</span> /usr/share/nginx/html/admin/;</span><br><span class="line">    <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /admin/index.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 反向代理到网关（和 gateway 的路由保持一致）</span></span><br><span class="line">  <span class="section">location</span> /web/       &#123; <span class="attribute">proxy_pass</span> http://gateway:7071/web/; &#125;</span><br><span class="line">  <span class="section">location</span> /interact/  &#123; <span class="attribute">proxy_pass</span> http://gateway:7071/interact/; &#125;</span><br><span class="line">  <span class="section">location</span> /user/      &#123; <span class="attribute">proxy_pass</span> http://gateway:7071/user/; &#125;</span><br><span class="line">  <span class="section">location</span> /file/      &#123; <span class="attribute">proxy_pass</span> http://gateway:7071/file/; &#125;</span><br><span class="line">  <span class="section">location</span> /adminapi/  &#123; <span class="attribute">proxy_pass</span> http://gateway:7071/admin/; &#125; <span class="comment"># 避免静态路径冲突，给管理端 API 换前缀</span></span><br><span class="line"></span><br><span class="line">  <span class="attribute">proxy_set_header</span> Host              <span class="variable">$host</span>;</span><br><span class="line">  <span class="attribute">proxy_set_header</span> X-Real-IP         <span class="variable">$remote_addr</span>;</span><br><span class="line">  <span class="attribute">proxy_set_header</span> X-Forwarded-For   <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">  <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>构建前端并拷贝静态资源：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用户端</span></span><br><span class="line"><span class="built_in">cd</span> /path/to/easylive-springcloud/easylive-front/easylive-front-web</span><br><span class="line">npm ci || npm install</span><br><span class="line">npm run build</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> -r dist/* /opt/easylive/frontend/web/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 管理端</span></span><br><span class="line"><span class="built_in">cd</span> /path/to/easylive-springcloud/easylive-front/easylive-front-admin</span><br><span class="line">npm ci || npm install</span><br><span class="line">npm run build</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /opt/easylive/frontend/admin</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">cp</span> -r dist/* /opt/easylive/frontend/admin/</span><br></pre></td></tr></table></figure><p>如前端请求网关的基地址可配置，建议改为相对路径并按上面 Nginx 反代规则访问。</p><h3 id="7-Minio-初始化（可选）">7) Minio 初始化（可选）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run --<span class="built_in">rm</span> --network easylive_easylive-net -it \</span><br><span class="line">  minio/mc sh -c <span class="string">&quot;</span></span><br><span class="line"><span class="string">mc alias set minio http://minio:9000 <span class="variable">$&#123;MINIO_ROOT_USER&#125;</span> <span class="variable">$&#123;MINIO_ROOT_PASSWORD&#125;</span> &amp;&amp; \</span></span><br><span class="line"><span class="string">mc mb -p minio/easylive &amp;&amp; \</span></span><br><span class="line"><span class="string">mc anonymous set download minio/easylive&quot;</span></span><br></pre></td></tr></table></figure><h3 id="8-Nacos-配置">8) Nacos 配置</h3><ul><li>访问 <code>http://服务器IP:8848/nacos</code>，默认无鉴权或按镜像默认设置。</li><li>为每个服务新增配置：<ul><li><code>easylive-cloud-admin-dev.yml</code></li><li><code>easylive-cloud-web-dev.yml</code></li><li><code>easylive-cloud-interact-dev.yml</code></li><li><code>easylive-cloud-resource-dev.yml</code></li><li>内容至少包含数据库与 Redis 连接（参考你仓库中 dev yml，将 host 从 127.0.0.1 改为 <code>mysql</code>、<code>redis</code>）：</li></ul></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://mysql:3306/easylive?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure><ul><li>资源服务若使用 Minio，请在对应 yml 增加 Minio 配置项（按你项目属性命名），指向 <code>http://minio:9000</code>。</li></ul><h3 id="9-启动与验证">9) 启动与验证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt/easylive</span><br><span class="line">docker compose pull   <span class="comment"># 第一次可忽略</span></span><br><span class="line">docker compose up -d  <span class="comment"># 启动</span></span><br><span class="line">docker compose ps     <span class="comment"># 查看状态</span></span><br><span class="line">docker logs -f gateway</span><br><span class="line">docker logs -f admin</span><br><span class="line">docker logs -f web</span><br><span class="line">docker logs -f interact</span><br><span class="line">docker logs -f resource</span><br></pre></td></tr></table></figure><ul><li>浏览器访问：<ul><li>Nacos: <code>http://服务器IP:8848/nacos</code></li><li>Minio: <code>http://服务器IP:9001</code></li><li>前端: <code>http://服务器IP/</code>（用户端）与 <code>http://服务器IP/admin/</code>（管理端）</li></ul></li><li>后端连通性：网关 <code>http://服务器IP:7071</code> 下的 <code>/web/**</code>、<code>/interact/**</code>、<code>/user/**</code>、<code>/file/**</code>、<code>/admin/**</code>。</li></ul><h3 id="10-域名与-HTTPS（可选快速）">10) 域名与 HTTPS（可选快速）</h3><ul><li>用 Nginx + Certbot：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install -y certbot python3-certbot-nginx</span><br><span class="line"><span class="built_in">sudo</span> certbot --nginx -d your.domain.com -m your@email \</span><br><span class="line">  --agree-tos --no-eff-email --redirect</span><br></pre></td></tr></table></figure><ul><li>或用 Caddy（更简单，自动签发）：将 Nginx 换成 <code>caddy:2</code>，用 Caddyfile 一行反代网关和静态。</li></ul><h3 id="11-常见资源与优化建议">11) 常见资源与优化建议</h3><ul><li>4G 机器内存紧张：先不上 RocketMQ/ES/Seata，JVM 堆保持 <code>-Xms256m -Xmx512m</code>；Nacos JVM 也已收敛。</li><li>MySQL/ES/Minio 数据请使用卷持久化（compose 已配置）。</li><li>日志落盘到容器 stdout，建议再配 ELK/Vector 后续接入。</li></ul><p>你现在可以按以上顺序执行；如果遇到端口/内存/配置问题，发我报错我继续帮你排查。</p><ul><li>我已经完成部署方案选择与全部步骤指引，包含 <code>.env</code>、<code>docker-compose.yml</code>、后端 Dockerfile、Nginx 反代与初始化要点。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 1) 基础依赖</span><br><span class="line">sudo apt-get update -y</span><br><span class="line">sudo apt-get install -y ca-certificates curl gnupg lsb-release</span><br><span class="line"></span><br><span class="line"># 2) Docker 仓库</span><br><span class="line">sudo install -m 0755 -d /etc/apt/keyrings</span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg \</span><br><span class="line"> | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg</span><br><span class="line">echo \</span><br><span class="line">  &quot;deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \</span><br><span class="line">  https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable&quot; \</span><br><span class="line"> | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line">sudo apt-get update -y</span><br><span class="line"></span><br><span class="line"># 3) 安装</span><br><span class="line">sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br><span class="line"></span><br><span class="line"># 4) 免 sudo（重新登录生效）</span><br><span class="line">sudo usermod -aG docker $USER</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /opt/easylive/&#123;mysql/data,mysql/init,redis,data,nacos,data,minio/data,nginx/conf.d,frontend/&#123;web,admin&#125;,logs&#125;</span><br><span class="line">sudo mkdir -p /opt/easylive/&#123;gateway,admin,web,interact,resource&#125;/config</span><br><span class="line">sudo mkdir -p /opt/easylive/&#123;rocketmq/&#123;namesrv,broker&#125;,es/data,seata&#125;</span><br><span class="line">sudo timedatectl set-timezone Asia/Shanghai</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">TZ=Asia/Shanghai</span><br><span class="line"></span><br><span class="line"># MySQL</span><br><span class="line">MYSQL_ROOT_PASSWORD=YourStrongRootPass!</span><br><span class="line">MYSQL_DATABASE=easylive</span><br><span class="line"></span><br><span class="line"># Nacos</span><br><span class="line">NACOS_VERSION=v2.2.0</span><br><span class="line"></span><br><span class="line"># Minio</span><br><span class="line">MINIO_ROOT_USER=admin</span><br><span class="line">MINIO_ROOT_PASSWORD=YourStrongMinioPass!</span><br><span class="line"></span><br><span class="line"># Java 内存建议（4G 机器尽量克制）</span><br><span class="line">JAVA_XMS=256m</span><br><span class="line">JAVA_XMX=512m</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.9&quot;</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">easylive</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">easylive-net:</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">mysql-data:</span></span><br><span class="line">  <span class="attr">redis-data:</span></span><br><span class="line">  <span class="attr">nacos-data:</span></span><br><span class="line">  <span class="attr">minio-data:</span></span><br><span class="line">  <span class="attr">es-data:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--default-authentication-plugin=mysql_native_password</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--character-set-server=utf8mb4</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--collation-server=utf8mb4_unicode_ci</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_ROOT_PASSWORD=$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_DATABASE=$&#123;MYSQL_DATABASE&#125;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3306:3306&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql-data:/var/lib/mysql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./mysql/init:/docker-entrypoint-initdb.d</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD-SHELL&quot;</span>,<span class="string">&quot;mysqladmin ping -uroot -p$&#123;MYSQL_ROOT_PASSWORD&#125; | grep &#x27;mysqld is alive&#x27;&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">5s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:6.2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">command:</span> [ <span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;--appendonly&quot;</span>, <span class="string">&quot;yes&quot;</span> ]</span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-data:/data</span></span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">nacos:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nacos/nacos-server:$&#123;NACOS_VERSION&#125;</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MODE=standalone</span></span><br><span class="line">      <span class="comment"># 使用 MySQL 做持久化（推荐）</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PLATFORM=mysql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_SERVICE_HOST=mysql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_SERVICE_DB_NAME=nacos_config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_SERVICE_PORT=3306</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_SERVICE_USER=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_SERVICE_PASSWORD=$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="comment"># JVM 缩小</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JVM_XMS=256m</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JVM_XMX=512m</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JVM_XMN=256m</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="attr">mysql:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">service_healthy</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8848:8848&quot;</span></span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">minio:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">minio/minio:RELEASE.2024-09-13T20-26-02Z</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">minio</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MINIO_ROOT_USER=$&#123;MINIO_ROOT_USER&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MINIO_ROOT_PASSWORD=$&#123;MINIO_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">server</span> <span class="string">/data</span> <span class="string">--console-address</span> <span class="string">&quot;:9001&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">minio-data:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9000:9000&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9001:9001&quot;</span></span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 如无强依赖，先不启动下列服务，稳定后再启用</span></span><br><span class="line">  <span class="comment"># rocketmq-namesrv:</span></span><br><span class="line">  <span class="comment">#   image: apache/rocketmq:5.2.0</span></span><br><span class="line">  <span class="comment">#   container_name: rmq-namesrv</span></span><br><span class="line">  <span class="comment">#   ports: [&quot;9876:9876&quot;]</span></span><br><span class="line">  <span class="comment">#   environment:</span></span><br><span class="line">  <span class="comment">#     - TZ=$&#123;TZ&#125;</span></span><br><span class="line">  <span class="comment">#     - JAVA_OPT_EXT=-Xms256m -Xmx512m</span></span><br><span class="line">  <span class="comment">#   networks: [easylive-net]</span></span><br><span class="line">  <span class="comment">#   restart: always</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># rocketmq-broker:</span></span><br><span class="line">  <span class="comment">#   image: apache/rocketmq:5.2.0</span></span><br><span class="line">  <span class="comment">#   container_name: rmq-broker</span></span><br><span class="line">  <span class="comment">#   environment:</span></span><br><span class="line">  <span class="comment">#     - NAMESRV_ADDR=rmq-namesrv:9876</span></span><br><span class="line">  <span class="comment">#     - TZ=$&#123;TZ&#125;</span></span><br><span class="line">  <span class="comment">#     - JAVA_OPT_EXT=-Xms256m -Xmx512m</span></span><br><span class="line">  <span class="comment">#   depends_on: [rocketmq-namesrv]</span></span><br><span class="line">  <span class="comment">#   ports: [&quot;10911:10911&quot;,&quot;10909:10909&quot;,&quot;10912:10912&quot;]</span></span><br><span class="line">  <span class="comment">#   networks: [easylive-net]</span></span><br><span class="line">  <span class="comment">#   restart: always</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># es:</span></span><br><span class="line">  <span class="comment">#   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.22</span></span><br><span class="line">  <span class="comment">#   container_name: es</span></span><br><span class="line">  <span class="comment">#   environment:</span></span><br><span class="line">  <span class="comment">#     - discovery.type=single-node</span></span><br><span class="line">  <span class="comment">#     - xpack.security.enabled=false</span></span><br><span class="line">  <span class="comment">#     - ES_JAVA_OPTS=-Xms512m -Xmx512m</span></span><br><span class="line">  <span class="comment">#     - TZ=$&#123;TZ&#125;</span></span><br><span class="line">  <span class="comment">#   ulimits:</span></span><br><span class="line">  <span class="comment">#     memlock:</span></span><br><span class="line">  <span class="comment">#       soft: -1</span></span><br><span class="line">  <span class="comment">#       hard: -1</span></span><br><span class="line">  <span class="comment">#   ports:</span></span><br><span class="line">  <span class="comment">#     - &quot;9201:9200&quot;</span></span><br><span class="line">  <span class="comment">#   volumes:</span></span><br><span class="line">  <span class="comment">#     - es-data:/usr/share/elasticsearch/data</span></span><br><span class="line">  <span class="comment">#   networks: [easylive-net]</span></span><br><span class="line">  <span class="comment">#   restart: always</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># seata:</span></span><br><span class="line">  <span class="comment">#   image: seataio/seata-server:1.6.1</span></span><br><span class="line">  <span class="comment">#   container_name: seata</span></span><br><span class="line">  <span class="comment">#   environment:</span></span><br><span class="line">  <span class="comment">#     - SEATA_PORT=7091</span></span><br><span class="line">  <span class="comment">#     - TZ=$&#123;TZ&#125;</span></span><br><span class="line">  <span class="comment">#   ports: [&quot;7091:7091&quot;]</span></span><br><span class="line">  <span class="comment">#   networks: [easylive-net]</span></span><br><span class="line">  <span class="comment">#   restart: always</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ------------------ 应用服务 ------------------</span></span><br><span class="line">  <span class="attr">gateway:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">easylive-cloud-gateway:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">gateway</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVER_PORT=7071</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=dev</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848</span></span><br><span class="line">    <span class="attr">depends_on:</span> [<span class="string">nacos</span>]</span><br><span class="line">    <span class="attr">ports:</span> [<span class="string">&quot;7071:7071&quot;</span>]</span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">admin:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">easylive-cloud-admin:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVER_PORT=7070</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=dev</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="comment"># 覆盖数据库与 Redis（如 Nacos 未配置完整）</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/easylive?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_USERNAME=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PASSWORD=$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_HOST=redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_PORT=6379</span></span><br><span class="line">    <span class="attr">depends_on:</span> [<span class="string">mysql</span>, <span class="string">redis</span>, <span class="string">nacos</span>]</span><br><span class="line">    <span class="attr">ports:</span> [<span class="string">&quot;7070:7070&quot;</span>]</span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">easylive-cloud-web:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVER_PORT=7072</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=dev</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/easylive?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_USERNAME=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PASSWORD=$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_HOST=redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_PORT=6379</span></span><br><span class="line">    <span class="attr">depends_on:</span> [<span class="string">mysql</span>, <span class="string">redis</span>, <span class="string">nacos</span>]</span><br><span class="line">    <span class="attr">ports:</span> [<span class="string">&quot;7072:7072&quot;</span>]</span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">interact:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">easylive-cloud-interact:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">interact</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVER_PORT=7073</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=dev</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/easylive?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_USERNAME=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PASSWORD=$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_HOST=redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_PORT=6379</span></span><br><span class="line">    <span class="attr">depends_on:</span> [<span class="string">mysql</span>, <span class="string">redis</span>, <span class="string">nacos</span>]</span><br><span class="line">    <span class="attr">ports:</span> [<span class="string">&quot;7073:7073&quot;</span>]</span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">resource:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">easylive-cloud-resource:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">resource</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=$&#123;TZ&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVER_PORT=7074</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_PROFILES_ACTIVE=dev</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/easylive?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_USERNAME=root</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_DATASOURCE_PASSWORD=$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_HOST=redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPRING_REDIS_PORT=6379</span></span><br><span class="line">      <span class="comment"># 如资源服务用到 Minio，请在 Nacos 配置或此处补充访问参数</span></span><br><span class="line">      <span class="comment"># - MINIO_ENDPOINT=http://minio:9000</span></span><br><span class="line">      <span class="comment"># - MINIO_ACCESS_KEY=$&#123;MINIO_ROOT_USER&#125;</span></span><br><span class="line">      <span class="comment"># - MINIO_SECRET_KEY=$&#123;MINIO_ROOT_PASSWORD&#125;</span></span><br><span class="line">      <span class="comment"># - MINIO_BUCKET=your-bucket</span></span><br><span class="line">    <span class="attr">depends_on:</span> [<span class="string">mysql</span>, <span class="string">redis</span>, <span class="string">nacos</span>, <span class="string">minio</span>]</span><br><span class="line">    <span class="attr">ports:</span> [<span class="string">&quot;7074:7074&quot;</span>]</span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.25</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">depends_on:</span> [<span class="string">gateway</span>]</span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx/conf.d:/etc/nginx/conf.d</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./frontend/web:/usr/share/nginx/html</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./frontend/admin:/usr/share/nginx/html/admin</span></span><br><span class="line">    <span class="attr">networks:</span> [<span class="string">easylive-net</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br></pre></td></tr></table></figure><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 放在 easylive-server/easylive-cloud/easylive-cloud-gateway/Dockerfile</span></span><br><span class="line"><span class="keyword">FROM</span> eclipse-temurin:<span class="number">8</span>-jre</span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> target/*.jar app.jar</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">7071</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;java&quot;</span>,<span class="string">&quot;-Xms<span class="variable">$&#123;JAVA_XMS:-256m&#125;</span>&quot;</span>,<span class="string">&quot;-Xmx<span class="variable">$&#123;JAVA_XMX:-512m&#125;</span>&quot;</span>,<span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;/app/app.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 打包全部（跳过测试）</span><br><span class="line">cd /path/to/easylive-springcloud/easylive-server</span><br><span class="line">./mvnw -v || mvn -v</span><br><span class="line">mvn -DskipTests clean package</span><br><span class="line"></span><br><span class="line"># 构建镜像（五个服务）</span><br><span class="line">docker build -t easylive-cloud-gateway:latest \</span><br><span class="line">  easylive-cloud/easylive-cloud-gateway</span><br><span class="line"></span><br><span class="line">docker build -t easylive-cloud-admin:latest \</span><br><span class="line">  easylive-cloud/easylive-cloud-admin</span><br><span class="line"></span><br><span class="line">docker build -t easylive-cloud-web:latest \</span><br><span class="line">  easylive-cloud/easylive-cloud-web</span><br><span class="line"></span><br><span class="line">docker build -t easylive-cloud-interact:latest \</span><br><span class="line">  easylive-cloud/easylive-cloud-interact</span><br><span class="line"></span><br><span class="line">docker build -t easylive-cloud-resource:latest \</span><br><span class="line">  easylive-cloud/easylive-cloud-resource</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen 80;</span><br><span class="line">  server_name _;</span><br><span class="line"></span><br><span class="line">  # 用户端 Web 静态</span><br><span class="line">  root /usr/share/nginx/html;</span><br><span class="line">  index index.html;</span><br><span class="line"></span><br><span class="line">  # 管理端静态（访问 /admin/）</span><br><span class="line">  location /admin/ &#123;</span><br><span class="line">    alias /usr/share/nginx/html/admin/;</span><br><span class="line">    try_files $uri $uri/ /admin/index.html;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  # 反向代理到网关（和 gateway 的路由保持一致）</span><br><span class="line">  location /web/       &#123; proxy_pass http://gateway:7071/web/; &#125;</span><br><span class="line">  location /interact/  &#123; proxy_pass http://gateway:7071/interact/; &#125;</span><br><span class="line">  location /user/      &#123; proxy_pass http://gateway:7071/user/; &#125;</span><br><span class="line">  location /file/      &#123; proxy_pass http://gateway:7071/file/; &#125;</span><br><span class="line">  location /adminapi/  &#123; proxy_pass http://gateway:7071/admin/; &#125; # 避免静态路径冲突，给管理端 API 换前缀</span><br><span class="line"></span><br><span class="line">  proxy_set_header Host              $host;</span><br><span class="line">  proxy_set_header X-Real-IP         $remote_addr;</span><br><span class="line">  proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;</span><br><span class="line">  proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 用户端</span><br><span class="line">cd /path/to/easylive-springcloud/easylive-front/easylive-front-web</span><br><span class="line">npm ci || npm install</span><br><span class="line">npm run build</span><br><span class="line">sudo cp -r dist/* /opt/easylive/frontend/web/</span><br><span class="line"></span><br><span class="line"># 管理端</span><br><span class="line">cd /path/to/easylive-springcloud/easylive-front/easylive-front-admin</span><br><span class="line">npm ci || npm install</span><br><span class="line">npm run build</span><br><span class="line">sudo mkdir -p /opt/easylive/frontend/admin</span><br><span class="line">sudo cp -r dist/* /opt/easylive/frontend/admin/</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm --network easylive_easylive-net -it \</span><br><span class="line">  minio/mc sh -c &quot;</span><br><span class="line">mc alias set minio http://minio:9000 $&#123;MINIO_ROOT_USER&#125; $&#123;MINIO_ROOT_PASSWORD&#125; &amp;&amp; \</span><br><span class="line">mc mb -p minio/easylive &amp;&amp; \</span><br><span class="line">mc anonymous set download minio/easylive&quot;</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://mysql:3306/easylive?serverTimezone=GMT%2B8&amp;useUnicode=true&amp;characterEncoding=utf8&amp;autoReconnect=true&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">$&#123;MYSQL_ROOT_PASSWORD&#125;</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/easylive</span><br><span class="line">docker compose pull   # 第一次可忽略</span><br><span class="line">docker compose up -d  # 启动</span><br><span class="line">docker compose ps     # 查看状态</span><br><span class="line">docker logs -f gateway</span><br><span class="line">docker logs -f admin</span><br><span class="line">docker logs -f web</span><br><span class="line">docker logs -f interact</span><br><span class="line">docker logs -f resource</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -y certbot python3-certbot-nginx</span><br><span class="line">sudo certbot --nginx -d your.domain.com -m your@email \</span><br><span class="line">  --agree-tos --no-eff-email --redirect</span><br></pre></td></tr></table></figure><hr><p><strong>User</strong></p><p>4核8g的服务器是否够用能把所有的环境都配上呢，保险起见我是不是应该换个4核8g的服务器</p><hr><p><strong>Cursor</strong></p><p>结论先说：</p><ul><li>4核8G基本能把全套（MySQL/Redis/Nacos/Minio/ES/RocketMQ/Seata + 5个Java服务 + 网关）跑起来，但比较“紧”，需要严格限内存与低负载场景，属于可用但不太宽裕。</li><li>若计划“全部组件长期开启 + 有一定并发”，建议至少换到4核8G；若要更稳，优先把 ES 或 RocketMQ 单独拆机，或直接上更高规格（如8核16G）。</li></ul><p>快速内存预算（保守建议，单位≈GiB）：</p><ul><li>Nacos: 0.5</li><li>MySQL: 0.5–1.0（取决于 innodb_buffer_pool_size）</li><li>Redis: 0.1–0.3</li><li>Minio: 0.3–0.5</li><li>RocketMQ: 0.8–1.2（namesrv 0.3–0.5，broker 0.5–0.7）</li><li>Elasticsearch: 1.0–2.0（堆1–2G，且需 vm.max_map_count）</li><li>Seata: 0.3–0.5</li><li>5个SpringBoot服务: 1.3–2.5（每个 256–512M）</li><li>合计：约 5.3–8.5G（随设置和负载浮动）<br>=&gt; 4核8G在“全部开启”时边缘可用，需非常克制的JVM与DB配置。</li></ul><p>给你两种选择：</p><ul><li>想省事稳一点：换成4核8G（或更高），然后严格控内存即可全开；更理想是把 ES 或 RocketMQ 独立出去。</li><li>先不换服务器：保留4核4G/8G，只启核心链路（MySQL/Redis/Nacos/Minio/网关+业务服务），把 ES/RocketMQ/Seata 暂时关闭或托管到云上，等业务量起来再扩。</li></ul><p>若坚持在4核8G全开运行，务必：</p><ul><li>JVM：所有Java进程统一 -Xms256m -Xmx512m（Nacos、各微服务、Seata、RocketMQ），ES 堆设 1G 起步。</li><li>MySQL：innodb_buffer_pool_size 512M 起；慢慢再调大。</li><li>开启2–4G swap 兜底（仅兜底，不可依赖）。</li><li>用 docker-compose 限制每个容器内存并监控 docker stats。</li><li>优先上线无强依赖的路径；ES/RocketMQ 负载上来后优先拆分或升配。</li></ul><p>简短建议：</p><ul><li>如果你希望“一台机全家桶 + 可留有余量”，我建议换到4核8G（更稳）或把 ES/RocketMQ 外置/托管。</li><li>如果是演示/低QPS场景，4核8G可行；4核4G就建议按我给的最小化编排先跑核心链路。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 项目相关 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 项目部署 </tag>
            
            <tag> GQ Video </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaWeb+AI（实战篇  tlias教务系统）</title>
      <link href="/posts/11.html"/>
      <url>/posts/11.html</url>
      
        <content type="html"><![CDATA[<h1 id="4-项目实战-tlias教务系统">4.项目实战 <code>tlias</code>教务系统</h1><p><strong>在整个实战篇中，我们需要完成如下功能：</strong></p><ul><li>部门管理：查询、新增、修改、删除</li><li>员工管理：<ul><li>查询、新增、修改、删除</li><li>文件上传</li></ul></li><li>报表统计</li><li>登录认证</li><li>日志管理</li><li>班级管理（自己实战内容）</li><li>学员管理（自己实战内容）</li></ul><h1 id="–部门管理模块">–部门管理模块</h1><h2 id="1-部门管理">1.部门管理</h2><h3 id="1-1基础知识">1.1基础知识</h3><h4 id="1-1-1前后端分离开发">1.1.1前后端分离开发</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-247-1024x454.png" alt="img"></p><p>我们将原先的工程分为前端工程和后端工程这2个工程，然后前端工程交给专业的前端人员开发，后端工程交给专业的后端人员开发。</p><p>前端页面需要数据，可以通过发送异步请求，从后台工程获取。但是，我们前后台是分开来开发的，那么前端人员怎么知道后台返回数据的格式呢？后端人员开发，怎么知道前端人员需要的数据格式呢？</p><p>所以针对这个问题，我们前后台统一制定一套规范！我们前后台开发人员都需要遵循这套规范开发，这就是我们的<strong>接口****文档</strong>。</p><p>那么接口文档的内容怎么来的呢？是我们后台开发者根据产品经理提供的产品原型和需求文档所撰写出来的</p><p>那么基于前后台分离开发的模式下，我们后台开发者开发一个功能的具体流程如何呢？如下图所示：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-276-1024x113.png" alt="img"></p><ol><li>需求分析：首先我们需要阅读需求文档，分析需求，理解需求。</li><li>接口定义：查询接口文档中关于需求的接口的定义，包括地址，参数，响应数据类型等等</li><li>前后台并行开发：各自按照接口文档进行开发，实现需求</li><li>测试：前后台开发完了，各自按照接口文档进行测试</li><li>前后段联调测试：前段工程请求后端工程，测试功能</li></ol><h4 id="1-1-2Restful风格">1.1.2Restful风格</h4><p>而在前后端进行交互的时候，我们需要基于当前主流的REST风格的API接口进行交互。</p><p><strong>什么是REST风格呢?</strong></p><ul><li>REST（Representational State Transfer），表述性状态转换，它是一种软件架构风格。</li></ul><p><strong>传统URL风格如下：</strong></p><ul><li><a href="http://localhost:8080/user/getById?id=1">http://localhost:8080/user/getById?id=1</a> GET：查询id为1的用户</li><li><a href="http://localhost:8080/user/saveUser">http://localhost:8080/user/saveUser</a> POST：新增用户</li><li><a href="http://localhost:8080/user/updateUser">http://localhost:8080/user/updateUser</a> POST：修改用户</li><li><a href="http://localhost:8080/user/deleteUser?id=1">http://localhost:8080/user/deleteUser?id=1</a> GET：删除id为1的用户</li></ul><p>我们看到，原始的传统URL呢，定义比较复杂，而且将资源的访问行为对外暴露出来了。而且，对于开发人员来说，每一个开发人员都有自己的命名习惯，就拿根据id查询用户信息来说的，不同的开发人员定义的路径可能是这样的：<code>getById</code>，<code>selectById</code>，<code>queryById</code>，<code>loadById</code>… 。 每一个人都有自己的命名习惯，如果都按照各自的习惯来，一个项目组，几十号或上百号人，那最终开发出来的项目，将会变得难以维护，没有一个统一的标准。</p><p><strong>基于REST风格URL如下：</strong></p><ul><li><a href="http://localhost:8080/users/1">http://localhost:8080/users/1</a> GET：查询id为1的用户</li><li><a href="http://localhost:8080/users">http://localhost:8080/users</a> POST：新增用户</li><li><a href="http://localhost:8080/users">http://localhost:8080/users</a> PUT：修改用户</li><li><a href="http://localhost:8080/users/1">http://localhost:8080/users/1</a> DELETE：删除id为1的用户</li></ul><p>其中总结起来，就一句话：<strong>通过URL定位要操作的资源，通过HTTP动词(请求方式)来描述具体的操作。</strong></p><p>在REST风格的URL中，通过四种请求方式，来操作数据的增删改查。</p><ul><li>GET ： 查询</li><li>POST ：新增</li><li>PUT ： 修改</li><li>DELETE ：删除</li></ul><p>注：</p><ul><li>REST是风格，是约定方式，约定不是规定，可以打破</li><li>描述模块的功能通常使用复数，也就是加s的格式来描述，表示此类资源，而非单个资源。如：users、emps、books…</li></ul><h4 id="1-1-3Apifox的使用">1.1.3Apifox的使用</h4><ul><li>前后端都在并行开发，后端开发完对应的接口之后，如何对接口进行请求测试呢？</li><li>前后端都在并行开发，前端开发过程中，如何获取到数据，测试页面的渲染展示呢？</li></ul><p>那这里我们就可以借助一些接口测试工具，比如项：Postman、Apipost、Apifox等。</p><p>详细使用可以在b站官方账号自行学习</p><h3 id="1-2工程搭建">1.2工程搭建</h3><p><strong>1).</strong> <strong>创建SpringBoot工程，并引入<strong><strong>web开发起步依赖、mybatis、mysql驱动、lombok</strong></strong>。</strong></p><p><em><strong>*2). 创建数据库及对应的表结构，并在application.yml中配置数据库的基本信息。*</strong></em></p><p>创建<code>tlias</code>数据库，并准备<code>dept</code>部门表。</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dept (</span><br><span class="line">  id <span class="type">int</span> unsigned <span class="keyword">PRIMARY KEY</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">&#x27;ID, 主键&#x27;</span>,</span><br><span class="line">  <span class="type">name</span> <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">UNIQUE</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;部门名称&#x27;</span>,</span><br><span class="line">  create_time datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">  update_time datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> <span class="keyword">COMMENT</span> <span class="string">&#x27;修改时间&#x27;</span></span><br><span class="line">) <span class="keyword">COMMENT</span> <span class="string">&#x27;部门表&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> dept <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">&#x27;学工部&#x27;</span>,<span class="string">&#x27;2023-09-25 09:47:40&#x27;</span>,<span class="string">&#x27;2024-07-25 09:47:40&#x27;</span>),</span><br><span class="line">                      (<span class="number">2</span>,<span class="string">&#x27;教研部&#x27;</span>,<span class="string">&#x27;2023-09-25 09:47:40&#x27;</span>,<span class="string">&#x27;2024-08-09 15:17:04&#x27;</span>),</span><br><span class="line">                      (<span class="number">3</span>,<span class="string">&#x27;咨询部&#x27;</span>,<span class="string">&#x27;2023-09-25 09:47:40&#x27;</span>,<span class="string">&#x27;2024-07-30 21:26:24&#x27;</span>),</span><br><span class="line">                      (<span class="number">4</span>,<span class="string">&#x27;就业部&#x27;</span>,<span class="string">&#x27;2023-09-25 09:47:40&#x27;</span>,<span class="string">&#x27;2024-07-25 09:47:40&#x27;</span>),</span><br><span class="line">                      (<span class="number">5</span>,<span class="string">&#x27;人事部&#x27;</span>,<span class="string">&#x27;2023-09-25 09:47:40&#x27;</span>,<span class="string">&#x27;2024-07-25 09:47:40&#x27;</span>),</span><br><span class="line">                      (<span class="number">6</span>,<span class="string">&#x27;行政部&#x27;</span>,<span class="string">&#x27;2023-11-30 20:56:37&#x27;</span>,<span class="string">&#x27;2024-07-30 20:56:37&#x27;</span>);</span><br></pre></td></tr></table></figure><p>在 <code>application.yml</code> 配置文件中配置数据库的连接信息。</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">spring:</span></span><br><span class="line">  <span class="params">application:</span></span><br><span class="line">    <span class="params">name:</span> tlias-web-management</span><br><span class="line">  <span class="comment">#mysql连接配置</span></span><br><span class="line">  <span class="params">datasource:</span></span><br><span class="line">    <span class="params">driver-class-name:</span> com.mysql.cj.jdbc.Driver</span><br><span class="line">    <span class="params">url:</span> jdbc:mysql:<span class="operator">//</span>localhost:<span class="number">3306</span><span class="symbol">/tlias</span></span><br><span class="line">    <span class="params">username:</span> root</span><br><span class="line">    <span class="params">password:</span> <span class="number">1234</span></span><br><span class="line"><span class="params">mybatis:</span></span><br><span class="line">  <span class="params">configuration:</span></span><br><span class="line">    <span class="params">log-impl:</span> org.apache.ibatis.logging.stdout.StdOutImpl</span><br></pre></td></tr></table></figure><p><strong>3). 准备基础包结构，并引入实体类Dept及统一的响应结果封装类Result</strong></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-248.png" alt="img"></p><p>实体类Dept</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_"><span class="keyword">class</span> <span class="title">Dept</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> name;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updateTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>统一响应结果Result</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">itheima</span>.<span class="property">pojo</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.<span class="property">Data</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">Serializable</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 后端统一返回结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Result</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> code; <span class="comment">//编码：1成功，0为失败</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> msg; <span class="comment">//错误信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Object</span> data; <span class="comment">//数据</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="title class_">Result</span> <span class="title function_">success</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">Result</span> result = <span class="keyword">new</span> <span class="title class_">Result</span>();</span><br><span class="line">        result.<span class="property">code</span> = <span class="number">1</span>;</span><br><span class="line">        result.<span class="property">msg</span> = <span class="string">&quot;success&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="title class_">Result</span> <span class="title function_">success</span>(<span class="params"><span class="title class_">Object</span> <span class="built_in">object</span></span>) &#123;</span><br><span class="line">        <span class="title class_">Result</span> result = <span class="keyword">new</span> <span class="title class_">Result</span>();</span><br><span class="line">        result.<span class="property">data</span> = <span class="built_in">object</span>;</span><br><span class="line">        result.<span class="property">code</span> = <span class="number">1</span>;</span><br><span class="line">        result.<span class="property">msg</span> = <span class="string">&quot;success&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="title class_">Result</span> <span class="title function_">error</span>(<span class="params"><span class="title class_">String</span> msg</span>) &#123;</span><br><span class="line">        <span class="title class_">Result</span> result = <span class="keyword">new</span> <span class="title class_">Result</span>();</span><br><span class="line">        result.<span class="property">msg</span> = msg;</span><br><span class="line">        result.<span class="property">code</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>基础代码结构<ul><li>DeptMapper</li><li>DeptService</li><li>DeptServiceImpl</li><li>DeptController</li></ul></li></ul><h2 id="2-查询部门">2.查询部门</h2><h3 id="2-1基本实现">2.1基本实现</h3><h4 id="2-1-1需求">2.1.1需求</h4><p>查询所有的部门数据，查询出来展示在部门管理的页面中。页面原型效果如下：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-277-1024x472.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-285.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-286.png" alt="img"></p><h4 id="2-1-2实现思路">2.1.2实现思路</h4><ul><li>Controller层，负责接收前端发起的请求，并调用service查询部门数据，然后响应结果。</li><li>Service层，负责调用Mapper接口方法，查询所有部门数据。</li><li>Mapper层，执行查询所有部门数据的操作。</li></ul><h4 id="2-1-3代码实现">2.1.3代码实现</h4><p><strong>1). Controller层</strong></p><p>在 <code>DeptController</code> 中，增加 <code>list</code> 方法，代码如下：</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** * 部门管理控制器 */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_"><span class="keyword">class</span> <span class="title">DeptController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DeptService deptService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**     * 查询部门列表     */</span><span class="meta">@RequestMapping</span>(<span class="string">&quot;/depts&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> Result list()&#123;</span><br><span class="line">        List&lt;Dept&gt; deptList = deptService.findAll();</span><br><span class="line">        <span class="keyword">return</span> Result.success(deptList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2). Service层</strong></p><p>在 <code>DeptService</code> 中，增加 <code>findAll</code>方法，代码如下：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">DeptService</span> &#123;</span><br><span class="line">    <span class="comment">/**     * 查询所有部门     */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Dept&gt; <span class="title">findAll</span>()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 <code>DeptServiceImpl</code> 中，增加 <code>findAll</code>方法，代码如下：</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_"><span class="keyword">class</span> <span class="title">DeptServiceImpl</span> <span class="keyword"><span class="keyword">implements</span> <span class="type">DeptService</span></span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DeptMapper deptMapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Dept&gt; findAll() &#123;</span><br><span class="line">        <span class="keyword">return</span> deptMapper.findAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>3). Mapper层</strong></p><p>在 <code>DeptMapper</code> 中，增加 <code>findAll</code>方法，代码如下：</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_"><span class="keyword">interface</span> <span class="title">DeptMapper</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**     * 查询所有部门     */</span></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">&quot;select * from dept&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> List&lt;Dept&gt; findAll();</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-1-4接口测试">2.1.4接口测试</h4><p>打开Apifox进行测试</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-278-1024x647.png" alt="img"></p><p>我们发现，已经查询出了所有的部门数据，并且响应回来的就是json格式的数据，与接口文档一致。 那接下来，我们再来测试一下，这个查询操作，我们使用post、put、delete方式来请求，是否可以获取到数据。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-279-1024x633.png" alt="img"></p><p>经过测试，我们发现，现在我们其实是可以通过任何方式的请求来访问查询部门的这个接口的。 而在接口文档中，明确要求该接口的请求方式为GET，那么如何限制请求方式呢？</p><p>方式一：在controller方法的@RequestMapping注解中通过method属性来限定。</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@RestController</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">DeptController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">@Autowired</span></span><br><span class="line">    private DeptService deptService;</span><br><span class="line"></span><br><span class="line">    <span class="regexp">/**     </span></span><br><span class="line"><span class="regexp">     * 查询部门列表     </span></span><br><span class="line"><span class="regexp">     */</span></span><br><span class="line"><span class="variable">@RequestMapping</span>(value = <span class="string">&quot;/depts&quot;</span>, <span class="function"><span class="keyword">method</span> = <span class="title">RequestMethod</span>.<span class="title">GET</span>)</span></span><br><span class="line"><span class="function">    <span class="title">public</span> <span class="title">Result</span> <span class="title">list</span></span>()&#123;</span><br><span class="line">        List&lt;Dept&gt; deptList = deptService.findAll();</span><br><span class="line">        <span class="keyword">return</span> Result.success(deptList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>方式二：在controller方法上使用，@RequestMapping的衍生注解 @GetMapping。 该注解就是标识当前方法，必须以GET方式请求。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DeptService deptService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询部门列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/depts&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Result list()&#123;</span><br><span class="line">        List&lt;Dept&gt; deptList = deptService.findAll();</span><br><span class="line">        <span class="keyword">return</span> Result.success(deptList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>推荐使用第二种方式</p><ul><li>GET方式：@GetMapping</li><li>POST方式：@PostMapping</li><li>PUT方式：@PutMapping</li><li>DELETE方式：@DeleteMapping</li></ul><h4 id="2-1-5数据封装">2.1.5数据封装</h4><p>在测试中，我们发现部门的数据中，id、name两个属性是有值的，但是createTime、updateTime两个字段值并未成功封装，而数据库中是有对应的字段值的，这是为什么呢？</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-280-1024x242.png" alt="img"></p><p>原因如下：</p><ul><li>实体类属性名和数据库表查询返回的字段名一致，mybatis会自动封装。</li><li>如果实体类属性名和数据库表查询返回的字段名不一致，不能自动封装。</li></ul><p>解决方案：</p><ul><li>手动结果映射</li><li>起别名</li><li>开启驼峰命名</li></ul><p><strong>1).</strong> <strong>手动结果映射</strong></p><p>在DeptMapper接口方法上，通过 @Results及@Result 进行手动结果映射。</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Results</span>(&#123;<span class="variable">@Result</span>(column = <span class="string">&quot;create_time&quot;</span>, property = <span class="string">&quot;createTime&quot;</span>),</span><br><span class="line">          <span class="variable">@Result</span>(column = <span class="string">&quot;update_time&quot;</span>, property = <span class="string">&quot;updateTime&quot;</span>)&#125;)</span><br><span class="line"><span class="variable">@Select</span>(<span class="string">&quot;select id, name, create_time, update_time from dept&quot;</span>)</span><br><span class="line">public List&lt;Dept&gt; <span class="built_in">findAll</span>();</span><br></pre></td></tr></table></figure><p><strong>2). 起别名</strong></p><p>在SQL语句中，对不一样的列名起别名，别名和实体类属性名一样。</p><p><strong>3). 开启驼峰命名</strong>**(推荐)**</p><p>如果字段名与属性名符合驼峰命名规则，mybatis会自动通过驼峰命名规则映射。驼峰命名规则： abc_xyz =&gt; abcXyz</p><ul><li>表中字段名：abc_xyz</li><li>类中属性名：abcXyz</li></ul><p>在application.yml中做如下配置，开启开关。</p><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mybatis:</span><br><span class="line">  <span class="keyword">configuration</span>:</span><br><span class="line">    <span class="keyword">map</span>-underscore-<span class="keyword">to</span>-camel-<span class="keyword">case</span>: <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="2-2了解前后端联调时的请求访问过程（反向代理）">2.2了解前后端联调时的请求访问过程（反向代理）</h3><p>前端工程请求服务器的地址为 <code>http://localhost:90/api/depts</code>，是如何访问到后端的tomcat服务器的？</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-281.png" alt="img"></p><p>其实这里，是通过前端服务Nginx中提供的反向代理功能实现的。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-283.png" alt="img"></p><p>1). 浏览器发起请求，请求的是localhost:90 ，那其实请求的是nginx服务器。</p><p>2). 在nginx服务器中呢，并没有对请求直接进行处理，而是将请求转发给了后端的tomcat服务器，最终由tomcat服务器来处理该请求。</p><p>这个过程就是通过nginx的反向代理实现的。</p><p><strong>问：那为什么浏览器不直接请求后端的tomcat服务器，而是直接请求nginx服务器呢，主要有以下几点原因：</strong></p><p>1). 安全：由于后端的tomcat服务器一般都会搭建集群，会有很多的服务器，把所有的tomcat暴露给前端，让前端直接请求tomcat，对于后端服务器是比较危险的。</p><p>2). 灵活：基于nginx的反向代理实现，更加灵活，后端想增加、减少服务器，对于前端来说是无感知的，只需要在nginx中配置即可。</p><p>3). 负载均衡：基于nginx的反向代理，可以很方便的实现后端tomcat的负载均衡操作。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-328-1024x251.png" alt="img"></p><p>具体的请求访问流程如下：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-284-1024x321.png" alt="img"></p><ol><li>location：用于定义匹配特定uri请求的规则。</li><li>^~ /api/：表示精确匹配，即只匹配以/api/开头的路径。</li><li>rewrite：该指令用于重写匹配到的uri路径。</li><li>proxy_pass：该指令用于代理转发，它将匹配到的请求转发给位于后端的指令服务器。</li></ol><h2 id="3-删除部门">3.删除部门</h2><h3 id="3-1基本实现">3.1基本实现</h3><h4 id="3-1-1需求">3.1.1需求</h4><p>删除部门数据。在点击 “删除” 按钮，会根据ID删除部门数据。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-287-1024x419.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-289-707x1024.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-290.png" alt="img"></p><h4 id="3-1-2实现思路">3.1.2实现思路</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-291-1024x263.png" alt="img"></p><h4 id="3-1-3简单参数接收">3.1.3简单参数接收</h4><p>在controller中，需要接收前端传递的请求参数。 那接下来，就先来看看在服务器端的Controller程序中，如何获取这类简单参数。 具体的方案有如下三种：</p><p><strong>方案一：通过原始的 <code>HttpServletRequest</code> 对象获取请求参数</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 根据ID删除部门 - 简单参数接收: 方式一 (HttpServletRequest)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">@DeleteMapping(&quot;/depts&quot;)</span><br><span class="line"><span class="built_in">public</span> Result <span class="keyword">delete</span>(HttpServletRequest request)&#123;</span><br><span class="line">    String idStr = request.getParameter(&quot;id&quot;);</span><br><span class="line">    <span class="type">int</span> id = <span class="type">Integer</span>.parseInt(idStr);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">System</span>.<span class="keyword">out</span>.println(&quot;根据ID删除部门: &quot; + id);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这种方案实现较为繁琐，而且还需要进行手动类型转换。<strong>【项目开发很少用】</strong></p><p><strong>方案二：通过Spring提供的 <code>@RequestParam</code> 注解，将请求参数绑定给方法形参</strong></p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@DeleteMapping</span>(<span class="string">&quot;/depts&quot;</span>)</span><br><span class="line">public Result <span class="built_in">delete</span>(<span class="variable">@RequestParam</span>(<span class="string">&quot;id&quot;</span>) Integer deptId)&#123;</span><br><span class="line">    <span class="selector-tag">System</span><span class="selector-class">.out</span><span class="selector-class">.println</span>(<span class="string">&quot;根据ID删除部门: &quot;</span> + deptId);</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">Result</span><span class="selector-class">.success</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@RequestParam</code> 注解的value属性，需要与前端传递的参数名保持一致 。</p><p>@RequestParam注解required属性默认为true，代表该参数必须传递，如果不传递将报错。 如果参数可选，可以将属性设置为false。</p><p><strong>方案三：如果请求参数名与形参变量名相同，直接定义方法形参即可接收。（省略@RequestParam）</strong></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DeleteMapping(<span class="string">&quot;/depts&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> Result delete(Integer id)&#123;</span><br><span class="line">    System.<span class="keyword">out</span>.println(<span class="string">&quot;根据ID删除部门: &quot;</span> + deptId);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对于以上的这三种方案，<strong>推荐第三种方案</strong>。</p><h4 id="3-1-4代码实现">3.1.4代码实现</h4><p><strong>1). Controller层</strong></p><p>在 <code>DeptMapper</code> 中，增加 <code>delete</code> 方法，代码实现如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 根据<span class="built_in">id</span>删除部门 - delete http://localhost:8080/depts?<span class="built_in">id</span>=1</span><br><span class="line"> */</span><br><span class="line">@DeleteMapping(<span class="string">&quot;/depts&quot;</span>)</span><br><span class="line">public Result delete(Integer <span class="built_in">id</span>)&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;根据id删除部门, id=&quot;</span> + <span class="built_in">id</span>);</span><br><span class="line">    deptService.deleteById(<span class="built_in">id</span>);</span><br><span class="line">    <span class="built_in">return</span> Result.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2). Service层</strong></p><p>在 <code>DeptService</code> 中，增加 <code>deleteById</code> 方法，代码实现如下：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** * 根据id删除部门 */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">deleteById</span><span class="params">(Integer id)</span></span>;</span><br></pre></td></tr></table></figure><p>在 <code>DeptServiceImpl</code> 中，增加 <code>deleteById</code> 方法，代码实现如下：</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> deleteById(Integer <span class="built_in">id</span>) &#123;</span><br><span class="line">    deptMapper.deleteById(<span class="built_in">id</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>3). Mapper层</strong></p><p>在 <code>DeptMapper</code> 中，增加 <code>deleteById</code> 方法，代码实现如下：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** * 根据id删除部门 */</span></span><br><span class="line"><span class="variable">@Delete</span>(<span class="string">&quot;delete from dept where id = #&#123;id&#125;&quot;</span>)</span><br><span class="line">void <span class="built_in">deleteById</span>(Integer id);</span><br></pre></td></tr></table></figure><p>对于 DML 语句来说，执行完毕，也是有返回值的，返回值代表的是增删改操作，影响的记录数，所以可以将执行 DML 语句的方法返回值设置为 Integer。 但是一般开发时，是不需要这个返回值的，所以也可以设置为void。</p><h2 id="4-新增部门">4.新增部门</h2><h3 id="4-1基本实现">4.1基本实现</h3><h4 id="4-1-1需求">4.1.1需求</h4><p>点击 “新增部门” 的按钮之后，弹出新增部门表单，填写部门名称之后，点击确定之后，保存部门数据。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-292-1024x404.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-293-1024x602.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-295-1024x533.png" alt="img"></p><h4 id="4-1-2实现思路">4.1.2实现思路</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-294-1024x266.png" alt="img"></p><h4 id="4-1-3json参数接收">4.1.3json参数接收</h4><p>在controller中，需要接收前端传递的请求参数。 那接下来，我们就先来看看在服务器端的Controller程序中，如何获取json格式的参数。</p><ul><li>JSON格式的参数，通常会使用一个实体对象进行接收 。</li><li>规则：JSON数据的键名与方法形参对象的属性名相同，并需要使用<code>@RequestBody</code>注解标识。</li></ul><p>前端传递的请求参数格式为json，内容如下：<code>&#123;&quot;name&quot;:&quot;研发部&quot;&#125;</code>。这里，我们可以通过一个对象来接收，只需要保证对象中有name属性即可。</p><h4 id="4-1-4代码实现">4.1.4代码实现</h4><p><strong>1). Controller层</strong></p><p>在<code>DeptController</code>中增加方法save，具体代码如下：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** * 新增部门 - POST http://localhost:8080/depts   请求参数：&#123;&quot;name&quot;:&quot;研发部&quot;&#125; */</span></span><br><span class="line"><span class="variable">@PostMapping</span>(<span class="string">&quot;/depts&quot;</span>)</span><br><span class="line">public Result <span class="built_in">save</span>(<span class="variable">@RequestBody</span> Dept dept)&#123;</span><br><span class="line">    <span class="selector-tag">System</span><span class="selector-class">.out</span><span class="selector-class">.println</span>(<span class="string">&quot;新增部门, dept=&quot;</span> + dept);</span><br><span class="line">    <span class="selector-tag">deptService</span><span class="selector-class">.save</span>(dept);</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">Result</span><span class="selector-class">.success</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2). Service层</strong></p><p>在<code>DeptService</code>中增加接口方法save，具体代码如下：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** * 新增部门 */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">save</span><span class="params">(Dept dept)</span></span>;</span><br></pre></td></tr></table></figure><p>在<code>DeptServiceImpl</code>中增加save方法，完成添加部门的操作，具体代码如下：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public void <span class="built_in">save</span>(Dept dept) &#123;</span><br><span class="line">    <span class="comment">//补全基础属性</span></span><br><span class="line">    dept<span class="selector-class">.setCreateTime</span>(LocalDateTime.now());</span><br><span class="line">    dept<span class="selector-class">.setUpdateTime</span>(LocalDateTime.now());</span><br><span class="line">    <span class="comment">//保存部门</span></span><br><span class="line">    deptMapper<span class="selector-class">.insert</span>(dept);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>3). Mapper层</strong></p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** * 保存部门 */</span></span><br><span class="line">@Insert(<span class="string">&quot;insert into dept(name,create_time,update_time) values(<span class="subst">#&#123;name&#125;</span>,<span class="subst">#&#123;createTime&#125;</span>,<span class="subst">#&#123;updateTime&#125;</span>)&quot;</span>)</span><br><span class="line"><span class="literal">void</span> insert(Dept dept);</span><br></pre></td></tr></table></figure><p>如果在mapper接口中，需要传递多个参数，可以把多个参数封装到一个对象中。 在SQL语句中获取参数的时候，<code>#&#123;...&#125;</code> 里面写的是<strong>对象的属性名</strong>【注意是属性名，不是表的字段名】。</p><h2 id="5-修改部门">5.修改部门</h2><p>对于任何业务的修改功能来说，一般都会分为两步进行：查询回显、修改数据。</p><h3 id="5-1查询回显">5.1查询回显</h3><h4 id="5-1-1需求">5.1.1需求</h4><p>当我们点击 “编辑” 的时候，需要根据ID查询部门数据，然后用于页面回显展示。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-324-1024x220.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-296-1024x556.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-297-1024x811.png" alt="img"></p><h4 id="5-1-2实现思路">5.1.2实现思路</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-326-1024x259.png" alt="img"></p><h4 id="5-1-3路径参数接收">5.1.3路径参数接收</h4><p><code>/depts/1</code>，<code>/depts/2</code> 这种在url中传递的参数，我们称之为<strong>路径参数</strong>。 那么如何接收这样的路径参数呢 ？</p><p>路径参数：通过请求URL直接传递参数，使用{…}来标识该路径参数，需要使用 **<code>@PathVariable</code>**获取路径参数。如下所示：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-325-1024x210.png" alt="img"></p><p>如果路径参数名与controller方法形参名称一致，<code>@PathVariable</code>注解的value属性是可以省略的</p><h4 id="5-1-4代码实现">5.1.4代码实现</h4><p><strong>1). Controller层</strong></p><p>在 <code>DeptController</code> 中增加 <code>getById</code>方法，具体代码如下：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** * 根据ID查询 - GET http://localhost:8080/depts/1 */</span></span><br><span class="line"><span class="meta">@GetMapping(<span class="string">&quot;/depts/&#123;id&#125;&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> Result getById(<span class="meta">@PathVariable</span> Integer id)&#123;</span><br><span class="line">    System.<span class="keyword">out</span>.println(<span class="string">&quot;根据ID查询, id=&quot;</span> + id);</span><br><span class="line">    Dept dept = deptService.getById(id);</span><br><span class="line">    <span class="keyword">return</span> Result.success(dept);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2). Service层</strong></p><p>在 <code>DeptService</code> 中增加 <code>getById</code>方法，具体代码如下：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** * 根据id查询部门 */</span></span><br><span class="line">Dept <span class="built_in">getById</span>(Integer id);</span><br></pre></td></tr></table></figure><p>在 <code>DeptServiceImpl</code> 中增加 <code>getById</code>方法，具体代码如下：</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function">Dept <span class="title">getById</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">return</span> deptMapper.<span class="title">getById</span><span class="params">(id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>3). Mapper层</strong></p><p>在 <code>DeptMapper</code> 中增加 <code>getById</code> 方法，具体代码如下：</p><p>/** * 根据ID查询部门数据 */ @Select(“select id, name, create_time, update_time from dept where id = #{id}”) Dept getById(Integer id);</p><h3 id="5-2修改数据">5.2修改数据</h3><h4 id="5-2-1需求">5.2.1需求</h4><p>查询回显回来之后，就可以对部门的信息进行修改了，修改完毕之后，点击确定，此时，就需要根据ID修改部门的数据。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-298-1024x597.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-299-1024x654.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-300-1024x537.png" alt="img"></p><h4 id="5-2-2实现思路">5.2.2实现思路</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-301-1024x269.png" alt="img"></p><p>通过接口文档，我们可以看到前端传递的请求参数是json格式的请求参数，在Controller的方法中，我们可以通过 <code>@RequestBody</code> 注解来接收，并将其封装到一个对象中。</p><h4 id="5-2-3代码实现">5.2.3代码实现</h4><ol><li></li></ol><p><strong>1). Controller层</strong></p><p>在 <code>DeptController</code> 中增加 <code>update</code> 方法，具体代码如下：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** * 修改部门 - PUT http://localhost:8080/depts  请求参数：&#123;&quot;id&quot;:1,&quot;name&quot;:&quot;研发部&quot;&#125; */</span></span><br><span class="line"><span class="variable">@PutMapping</span>(<span class="string">&quot;/depts&quot;</span>)</span><br><span class="line">public Result <span class="built_in">update</span>(<span class="variable">@RequestBody</span> Dept dept)&#123;</span><br><span class="line">    <span class="selector-tag">System</span><span class="selector-class">.out</span><span class="selector-class">.println</span>(<span class="string">&quot;修改部门, dept=&quot;</span> + dept);</span><br><span class="line">    <span class="selector-tag">deptService</span><span class="selector-class">.update</span>(dept);</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">Result</span><span class="selector-class">.success</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2). Service层</strong></p><p>在 <code>DeptService</code> 中增加 <code>update</code> 方法。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** * 修改部门 */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">(Dept dept)</span></span>;</span><br></pre></td></tr></table></figure><p>在 <code>DeptServiceImpl</code> 中增加 <code>update</code> 方法。 由于是修改操作，每一次修改数据，都需要更新updateTime。所以，具体代码如下：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public void <span class="built_in">update</span>(Dept dept) &#123;</span><br><span class="line">    <span class="comment">//补全基础属性</span></span><br><span class="line">    dept<span class="selector-class">.setUpdateTime</span>(LocalDateTime.now());</span><br><span class="line">    <span class="comment">//保存部门</span></span><br><span class="line">    deptMapper<span class="selector-class">.update</span>(dept);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>3). Mapper层</strong></p><p>在 <code>DeptMapper</code> 中增加 <code>update</code> 方法，具体代码如下：</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** * 更新部门 */</span></span><br><span class="line">@Update(<span class="string">&quot;update dept set name = <span class="subst">#&#123;name&#125;</span>,update_time = <span class="subst">#&#123;updateTime&#125;</span> where id = <span class="subst">#&#123;id&#125;</span>&quot;</span>)</span><br><span class="line"><span class="literal">void</span> update(Dept dept);</span><br></pre></td></tr></table></figure><h3 id="5-3-RequestMapping">5.3@RequestMapping</h3><p>到此，关于基本的部门的增删改查功能，已经实现了。 我们会发现，我们在 <code>DeptController</code> 中所定义的方法，所有的请求路径，都是 <code>/depts</code> 开头的，只要操作的是部门数据，请求路径都是 <code>/depts</code> 开头。</p><p>那么这个时候，我们其实是可以把这个公共的路径 <code>/depts</code> 抽取到类上的，那在各个方法上，就可以省略了这个 <code>/depts</code> 路径。 代码如下：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-327-1024x579.png" alt="img"></p><p>一个完整的请求路径，应该是类上的 @RequestMapping 的value属性 + 方法上的 @RequestMapping的value属性。</p><h2 id="6-日志技术（Logback）">6.日志技术（Logback）</h2><h3 id="6-1日志框架">6.1日志框架</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-302-1024x296.png" alt="img"></p><ul><li><strong>JUL</strong>**：**这是JavaSE平台提供的官方日志框架，也被称为JUL。配置相对简单，但不够灵活，性能较差。</li><li><strong>Log4j</strong>**：**一个流行的日志框架，提供了灵活的配置选项，支持多种输出目标。</li><li>**Logback：**基于Log4j升级而来，提供了更多的功能和配置选项，性能由于Log4j。</li><li><strong>Slf4j</strong>**：**（Simple Logging Facade for Java）简单日志门面，提供了一套日志操作的标准接口及抽象类，允许应用程序使用不同的底层日志框架。</li></ul><h3 id="6-2Logback入门">6.2Logback入门</h3><p><strong>1). 准备工作：引入logback的依赖（springboot中无需引入，在springboot中已经传递了此依赖）</strong></p><p><strong>2). 引入配置文件 <code>logback.xml</code> （直接AI生成）</strong></p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!-- 控制台输出 --&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="comment">&lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度  %msg：日志消息，%n是换行符 --&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d</span><span class="template-variable">&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;</span><span class="language-xml"> [%thread] %-5level %logger</span><span class="template-variable">&#123;50&#125;</span><span class="language-xml">-%msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!-- 日志输出级别 --&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;ALL&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p><strong>3). 记录日志：定义日志记录对象Logger，记录日志</strong></p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//定义日志记录对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(LogTest.<span class="keyword">class</span>);</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> testLog()&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;开始计算...&quot;</span>);</span><br><span class="line">        <span class="built_in">int</span> <span class="keyword">sum</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">int</span>[] nums = &#123;<span class="number">1</span>, <span class="number">5</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">34</span>, <span class="number">2</span>, <span class="number">23</span>&#125;;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">            <span class="keyword">sum</span> += nums[i];</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;计算结果为: &quot;</span>+<span class="keyword">sum</span>);log.debug(<span class="string">&quot;结束计算...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行单元测试，可以在控制台中看到输出的日志，如下所示：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-303-1024x540.png" alt="img"></p><p>我们可以看到在输出的日志信息中，不仅输出了日志的信息，还包括：日志的输出时间、线程名、具体在那个类中输出的。</p><h3 id="6-3Logback配置文件">6.3Logback配置文件</h3><p>Logback日志框架的配置文件叫 <code>logback.xml</code> 。</p><p>该配置文件是对Logback日志框架输出的日志进行控制的，可以来配置输出的格式、位置及日志开关等。</p><p>常用的两种输出日志的位置：控制台、系统文件。</p><p><strong>1). 如果需要输出日志到控制台。添加如下配置：</strong></p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!-- 控制台输出 --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="comment">&lt;!--格式化输出：%d 表示日期，%thread 表示线程名，%-5level表示级别从左显示5个字符宽度，%msg表示日志消息，%n表示换行符 --&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d</span><span class="template-variable">&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;</span><span class="language-xml"> [%thread] %-5level %logger</span><span class="template-variable">&#123;50&#125;</span><span class="language-xml">-%msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p><strong>2). 如果需要输出日志到文件。添加如下配置：</strong></p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!-- 按照每天生成日志文件 --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;FILE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="comment">&lt;!-- 日志文件输出的文件名, %i表示序号 --&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">FileNamePattern</span>&gt;</span>D:/tlias-%d</span><span class="template-variable">&#123;yyyy-MM-dd&#125;</span><span class="language-xml">-%i.log<span class="tag">&lt;/<span class="name">FileNamePattern</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="comment">&lt;!-- 最多保留的历史日志文件数量 --&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">MaxHistory</span>&gt;</span>30<span class="tag">&lt;/<span class="name">MaxHistory</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="comment">&lt;!-- 最大文件大小，超过这个大小会触发滚动到新文件，默认为 10MB --&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>10MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="comment">&lt;!--格式化输出：%d 表示日期，%thread 表示线程名，%-5level表示级别从左显示5个字符宽度，%msg表示日志消息，%n表示换行符 --&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d</span><span class="template-variable">&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;</span><span class="language-xml"> [%thread] %-5level %logger</span><span class="template-variable">&#123;50&#125;</span><span class="language-xml">-%msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p><strong>3). 日志开关配置 （开启日志（ALL），取消日志（OFF））</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 日志输出级别 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;ALL&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--输出到控制台--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--输出到文件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="6-4日志级别">6.4日志级别</h3><p>常见的日志级别如下（优先级由低到高）：</p><table><thead><tr><th>日志级别</th><th>说明</th><th>记录方式</th></tr></thead><tbody><tr><td>trace</td><td>追踪，记录程序运行轨迹 【使用很少】</td><td>log.trace(“…”)</td></tr><tr><td>debug</td><td>调试，记录程序调试过程中的信息，实际应用中一般将其视为最低级别 【使用较多】</td><td>log.debug(“…”)</td></tr><tr><td>info</td><td>记录一般信息，描述程序运行的关键事件，如：网络连接、io操作 【使用较多】</td><td><a href="http://log.info">log.info</a>(“…”)</td></tr><tr><td>warn</td><td>警告信息，记录潜在有害的情况 【使用较多】</td><td>log.warn(“…”)</td></tr><tr><td>error</td><td>错误信息 【使用较多】</td><td>log.error(“…”)</td></tr></tbody></table><p>可以在配置文件<code>logback.xml</code>中，灵活的控制输出那些类型的日志。（大于等于配置的日志级别的日志才会输出）</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 日志输出级别 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;info&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--输出到控制台--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--输出到文件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="6-5案例日志记录">6.5案例日志记录</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 部门管理控制器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Slf4j</span><br><span class="line">@RequestMapping(&quot;/depts&quot;)</span><br><span class="line">@RestController</span><br><span class="line"><span class="built_in">public</span> <span class="keyword">class</span> DeptController &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private DeptService deptService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询部门列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    //@RequestMapping(<span class="keyword">value</span> = &quot;/depts&quot;, <span class="keyword">method</span> = RequestMethod.<span class="keyword">GET</span>)</span><br><span class="line">    @GetMapping</span><br><span class="line">    <span class="built_in">public</span> Result list()&#123;</span><br><span class="line">        //<span class="keyword">System</span>.<span class="keyword">out</span>.println(&quot;查询部门列表&quot;);</span><br><span class="line">        <span class="keyword">log</span>.<span class="keyword">info</span>(&quot;查询部门列表&quot;);</span><br><span class="line">        List&lt;Dept&gt; deptList = deptService.findAll();</span><br><span class="line">        <span class="keyword">return</span> Result.success(deptList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id删除部门 - delete http://localhost:8080/depts?id=1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @DeleteMapping</span><br><span class="line">    <span class="built_in">public</span> Result <span class="keyword">delete</span>(<span class="type">Integer</span> id)&#123;</span><br><span class="line">        //<span class="keyword">System</span>.<span class="keyword">out</span>.println(&quot;根据id删除部门, id=&quot; + id);</span><br><span class="line">        <span class="keyword">log</span>.<span class="keyword">info</span>(&quot;根据id删除部门, id: &#123;&#125;&quot; , id);</span><br><span class="line">        deptService.deleteById(id);</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增部门 - POST http://localhost:8080/depts   请求参数：&#123;&quot;name&quot;:&quot;研发部&quot;&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @PostMapping</span><br><span class="line">    <span class="built_in">public</span> Result save(@RequestBody Dept dept)&#123;</span><br><span class="line">        //<span class="keyword">System</span>.<span class="keyword">out</span>.println(&quot;新增部门, dept=&quot; + dept);</span><br><span class="line">        <span class="keyword">log</span>.<span class="keyword">info</span>(&quot;新增部门, dept: &#123;&#125;&quot; , dept);</span><br><span class="line">        deptService.save(dept);</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据ID查询 - GET http://localhost:8080/depts/1</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @GetMapping(&quot;/&#123;id&#125;&quot;)</span><br><span class="line">    <span class="built_in">public</span> Result getById(@PathVariable <span class="type">Integer</span> id)&#123;</span><br><span class="line">        //<span class="keyword">System</span>.<span class="keyword">out</span>.println(&quot;根据ID查询, id=&quot; + id);</span><br><span class="line">        <span class="keyword">log</span>.<span class="keyword">info</span>(&quot;根据ID查询, id: &#123;&#125;&quot; , id);</span><br><span class="line">        Dept dept = deptService.getById(id);</span><br><span class="line">        <span class="keyword">return</span> Result.success(dept);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改部门 - PUT http://localhost:8080/depts  请求参数：&#123;&quot;id&quot;:1,&quot;name&quot;:&quot;研发部&quot;&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    @PutMapping</span><br><span class="line">    <span class="built_in">public</span> Result <span class="keyword">update</span>(@RequestBody Dept dept)&#123;</span><br><span class="line">        //<span class="keyword">System</span>.<span class="keyword">out</span>.println(&quot;修改部门, dept=&quot; + dept);</span><br><span class="line">        <span class="keyword">log</span>.<span class="keyword">info</span>(&quot;修改部门, dept: &#123;&#125;&quot; , dept);</span><br><span class="line">        deptService.<span class="keyword">update</span>(dept);</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>lombok中提供的@Slf4j注解，可以简化定义日志记录器这步操作。添加了该注解，就相当于在类中定义了日志记录器，就下面这句代码：</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private static Logger <span class="keyword">log</span> = LoggerFactory. getLogger(Xxx. <span class="class"><span class="keyword">class</span>)</span>;</span><br></pre></td></tr></table></figure><p>注意：请指定稳定的lombok，因为最近jdk可能会出现兼容问题，通过指定版本 1.18.30防止报错</p><h1 id="–员工管理模块">–员工管理模块</h1><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-304.png" alt="img"></p><p>从页面原型中，我们可以看到，在查询员工信息的时候，除了要展示 姓名、性别、头像、职位、入职日期、最后操作时间这些员工信息外，还要展示出所属部门，那此时就需要从两张表中查询数据，一张是部门表，一张是员工表，此时就会涉及到多表操作。（具体见mysql内容，这里不花时间阐述）</p><h2 id="1-员工列表查询">1.员工列表查询</h2><p>那接下来，我们要来完成的是员工列表的查询功能实现。 具体的需求如下：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-329-1024x565.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-309-1024x721.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-310-1024x1007.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-311-1024x878.png" alt="img"></p><p>在查询员工列表数据时，既需要查询 员工的基本信息，还需要查询员工所属的部门名称，所以这里，会涉及到多表查询的操作。</p><p>而且，在查询员工列表数据时，既要考虑搜索栏中的查询条件，还要考虑对查询的结果进行分页处理。</p><p>那么接下来，我们在实现这个功能时，将会分为三个部分来逐一实现：</p><ul><li>准备工作</li><li>分页查询</li><li>条件分页查询</li></ul><h3 id="1-1准备工作">1.1准备工作</h3><p>需求：查询所有员工信息，并查询出部门名称。（涉及到的表：emp、dept）</p><h4 id="1-1-1基础代码准备">1.1.1基础代码准备</h4><p><strong>1). 创建员工管理相关表结构</strong></p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">-</span><span class="punctuation">-</span> 员工表</span><br><span class="line">create table emp<span class="punctuation">(</span></span><br><span class="line">    id int unsigned primary key auto_increment comment &#x27;ID,主键&#x27;<span class="punctuation">,</span></span><br><span class="line">    username varchar<span class="punctuation">(</span><span class="number">20</span><span class="punctuation">)</span> not <span class="literal">null</span> unique comment &#x27;用户名&#x27;<span class="punctuation">,</span></span><br><span class="line">    password varchar<span class="punctuation">(</span><span class="number">50</span><span class="punctuation">)</span> default &#x27;<span class="number">123456</span>&#x27; comment &#x27;密码&#x27;<span class="punctuation">,</span></span><br><span class="line">    name varchar<span class="punctuation">(</span><span class="number">10</span><span class="punctuation">)</span> not <span class="literal">null</span> comment &#x27;姓名&#x27;<span class="punctuation">,</span></span><br><span class="line">    gender tinyint unsigned not <span class="literal">null</span> comment &#x27;性别, 1:男, 2:女&#x27;<span class="punctuation">,</span></span><br><span class="line">    phone char<span class="punctuation">(</span><span class="number">11</span><span class="punctuation">)</span> not <span class="literal">null</span> unique comment &#x27;手机号&#x27;<span class="punctuation">,</span></span><br><span class="line">    job tinyint unsigned comment &#x27;职位, 1 班主任, 2 讲师 , 3 学工主管, 4 教研主管, 5 咨询师&#x27;<span class="punctuation">,</span></span><br><span class="line">    salary int unsigned comment &#x27;薪资&#x27;<span class="punctuation">,</span></span><br><span class="line">    image varchar<span class="punctuation">(</span><span class="number">300</span><span class="punctuation">)</span> comment &#x27;头像&#x27;<span class="punctuation">,</span></span><br><span class="line">    entry_date date comment &#x27;入职日期&#x27;<span class="punctuation">,</span></span><br><span class="line">    dept_id int unsigned comment &#x27;部门ID&#x27;<span class="punctuation">,</span></span><br><span class="line">    create_time datetime comment &#x27;创建时间&#x27;<span class="punctuation">,</span></span><br><span class="line">    update_time datetime comment &#x27;修改时间&#x27;</span><br><span class="line"><span class="punctuation">)</span> comment &#x27;员工表&#x27;<span class="punctuation">;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">INSERT INTO emp VALUES </span><br><span class="line">    <span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span>&#x27;shinaian&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;施耐庵&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909000</span>1&#x27;<span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span><span class="number">15000</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2000-01-01</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-11-16</span> 16:11:26&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span>&#x27;songjiang&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;宋江&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909000</span>2&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">8600</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2015-01-01</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:37&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">3</span><span class="punctuation">,</span>&#x27;lujunyi&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;卢俊义&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909000</span>3&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">8900</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2008-05-01</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:39&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">4</span><span class="punctuation">,</span>&#x27;wuyong&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;吴用&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909000</span>4&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">9200</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2007-01-01</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:41&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">5</span><span class="punctuation">,</span>&#x27;gongsunsheng&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;公孙胜&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909000</span>5&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">9500</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2012-12-05</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:43&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">6</span><span class="punctuation">,</span>&#x27;huosanniang&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;扈三娘&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">1330909000</span>6&#x27;<span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">6500</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2013-09-05</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:45&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">7</span><span class="punctuation">,</span>&#x27;chaijin&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;柴进&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909000</span>7&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">4700</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2005-08-01</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:47&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">8</span><span class="punctuation">,</span>&#x27;likui&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;李逵&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909000</span>8&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">4800</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2014-11-09</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:49&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">9</span><span class="punctuation">,</span>&#x27;wusong&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;武松&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909000</span>9&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">4900</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2011-03-11</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:51&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">10</span><span class="punctuation">,</span>&#x27;linchong&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;林冲&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909001</span>0&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">5000</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2013-09-05</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:53&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">11</span><span class="punctuation">,</span>&#x27;huyanzhuo&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;呼延灼&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909001</span>1&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">9700</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2007-02-01</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:55&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">12</span><span class="punctuation">,</span>&#x27;xiaoliguang&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;小李广&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909001</span>2&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">10000</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2008-08-18</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:57&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">13</span><span class="punctuation">,</span>&#x27;yangzhi&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;杨志&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909001</span>3&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">5300</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2012-11-01</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:59&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">14</span><span class="punctuation">,</span>&#x27;shijin&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;史进&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909001</span>4&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">10600</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2002-08-01</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:36:01&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">15</span><span class="punctuation">,</span>&#x27;sunerniang&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;孙二娘&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">1330909001</span>5&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">10900</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2011-05-01</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:36:03&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">16</span><span class="punctuation">,</span>&#x27;luzhishen&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;鲁智深&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909001</span>6&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">9600</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2010-01-01</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:36:05&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">17</span><span class="punctuation">,</span>&#x27;liying&#x27;<span class="punctuation">,</span>&#x27;<span class="number">12345678</span>&#x27;<span class="punctuation">,</span>&#x27;李应&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909001</span>7&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">5800</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2015-03-21</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:36:07&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">18</span><span class="punctuation">,</span>&#x27;shiqian&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;时迁&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909001</span>8&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">10200</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2015-01-01</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:36:09&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">19</span><span class="punctuation">,</span>&#x27;gudasao&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;顾大嫂&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">1330909001</span>9&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">10500</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2008-01-01</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:36:11&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">20</span><span class="punctuation">,</span>&#x27;ruanxiaoer&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;阮小二&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909002</span>0&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">10800</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2018-01-01</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:36:13&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">21</span><span class="punctuation">,</span>&#x27;ruanxiaowu&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;阮小五&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909002</span>1&#x27;<span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">5200</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2015-01-01</span>&#x27;<span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:36:15&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">22</span><span class="punctuation">,</span>&#x27;ruanxiaoqi&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;阮小七&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909002</span>2&#x27;<span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">5500</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2016-01-01</span>&#x27;<span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:36:17&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">23</span><span class="punctuation">,</span>&#x27;ruanji&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;阮籍&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909002</span>3&#x27;<span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">5800</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2012-01-01</span>&#x27;<span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:36:19&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">24</span><span class="punctuation">,</span>&#x27;tongwei&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;童威&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909002</span>4&#x27;<span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">5000</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2006-01-01</span>&#x27;<span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:36:21&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">25</span><span class="punctuation">,</span>&#x27;tongmeng&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;童猛&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909002</span>5&#x27;<span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">4800</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2002-01-01</span>&#x27;<span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:36:23&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">26</span><span class="punctuation">,</span>&#x27;yanshun&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;燕顺&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909002</span>6&#x27;<span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">5400</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2011-01-01</span>&#x27;<span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-11-08</span> 22:12:46&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">27</span><span class="punctuation">,</span>&#x27;lijun&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;李俊&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909002</span>7&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">6600</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2004-01-01</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-11-16</span> 17:56:59&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">28</span><span class="punctuation">,</span>&#x27;lizhong&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;李忠&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909002</span>8&#x27;<span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span><span class="number">5000</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2007-01-01</span>&#x27;<span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-11-17</span> 16:34:22&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">30</span><span class="punctuation">,</span>&#x27;liyun&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;李云&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909003</span>0&#x27;<span class="punctuation">,</span><span class="literal">NULL</span><span class="punctuation">,</span><span class="literal">NULL</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2020-03-01</span>&#x27;<span class="punctuation">,</span><span class="literal">NULL</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:35:33&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 16:36:31&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">36</span><span class="punctuation">,</span>&#x27;linghuchong&#x27;<span class="punctuation">,</span>&#x27;<span class="number">123456</span>&#x27;<span class="punctuation">,</span>&#x27;令狐冲&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1880909121</span>2&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">6800</span><span class="punctuation">,</span>&#x27;https://web-framework.oss-cn-hangzhou.aliyuncs.com/<span class="number">2023</span>/1.jpg&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-10-19</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">2023-10-20</span> 20:44:54&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2023-11-09</span> 09:41:04&#x27;<span class="punctuation">)</span><span class="punctuation">;</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="punctuation">-</span><span class="punctuation">-</span> 员工工作经历信息</span><br><span class="line">create table emp_expr<span class="punctuation">(</span></span><br><span class="line">    id int unsigned primary key auto_increment comment &#x27;ID, 主键&#x27;<span class="punctuation">,</span></span><br><span class="line">    emp_id int unsigned comment &#x27;员工ID&#x27;<span class="punctuation">,</span></span><br><span class="line">    begin date comment &#x27;开始时间&#x27;<span class="punctuation">,</span></span><br><span class="line">    end  date comment &#x27;结束时间&#x27;<span class="punctuation">,</span></span><br><span class="line">    company varchar<span class="punctuation">(</span><span class="number">50</span><span class="punctuation">)</span> comment &#x27;公司名称&#x27;<span class="punctuation">,</span></span><br><span class="line">    job varchar<span class="punctuation">(</span><span class="number">50</span><span class="punctuation">)</span> comment &#x27;职位&#x27;</span><br><span class="line"><span class="punctuation">)</span>comment &#x27;工作经历&#x27;<span class="punctuation">;</span></span><br></pre></td></tr></table></figure><p><strong>2). 准备emp表对应的实体类Emp、EmpExpr</strong></p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">package com.itheima.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.<span class="built_in">Data</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDate;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.<span class="built_in">List</span>;</span><br><span class="line"></span><br><span class="line">@<span class="built_in">Data</span></span><br><span class="line"><span class="keyword">public</span> class Emp &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">Integer</span> id; <span class="comment">//ID,主键</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> username; <span class="comment">//用户名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> password; <span class="comment">//密码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> name; <span class="comment">//姓名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">Integer</span> gender; <span class="comment">//性别, 1:男, 2:女</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> phone; <span class="comment">//手机号</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">Integer</span> job; <span class="comment">//职位, 1:班主任,2:讲师,3:学工主管,4:教研主管,5:咨询师</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">Integer</span> salary; <span class="comment">//薪资</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> image; <span class="comment">//头像</span></span><br><span class="line">    <span class="keyword">private</span> LocalDate entryDate; <span class="comment">//入职日期</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">Integer</span> deptId; <span class="comment">//关联的部门ID</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime; <span class="comment">//创建时间</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updateTime; <span class="comment">//修改时间</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装部门名称数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> deptName; <span class="comment">//部门名称</span></span><br><span class="line">&#125;</span><br><span class="line">package com.itheima.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.<span class="built_in">Data</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 工作经历</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@<span class="built_in">Data</span></span><br><span class="line"><span class="keyword">public</span> class EmpExpr &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">Integer</span> id; <span class="comment">//ID</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">Integer</span> empId; <span class="comment">//员工ID</span></span><br><span class="line">    <span class="keyword">private</span> LocalDate begin; <span class="comment">//开始时间</span></span><br><span class="line">    <span class="keyword">private</span> LocalDate end; <span class="comment">//结束时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> company; <span class="comment">//公司名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> job; <span class="comment">//职位</span></span><br><span class="line">&#125;</span><br><span class="line">package com.itheima.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.<span class="built_in">Data</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 工作经历</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@<span class="built_in">Data</span></span><br><span class="line"><span class="keyword">public</span> class EmpExpr &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">Integer</span> id; <span class="comment">//ID</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">Integer</span> empId; <span class="comment">//员工ID</span></span><br><span class="line">    <span class="keyword">private</span> LocalDate begin; <span class="comment">//开始时间</span></span><br><span class="line">    <span class="keyword">private</span> LocalDate end; <span class="comment">//结束时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> company; <span class="comment">//公司名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> job; <span class="comment">//职位</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>3). 准备Emp员工管理的基础结构，包括****Controller、Service、Mapper</strong></p><p>EmpMapper：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.pojo.Emp;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EmpMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>EmpService:</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title class_"><span class="keyword">interface</span> <span class="title">EmpService</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>EmpServiceImpl:</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.mapper.EmpMapper;</span><br><span class="line"><span class="keyword">import</span> com.itheima.service.EmpService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** * 员工管理 */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_"><span class="keyword">class</span> <span class="title">EmpServiceImpl</span> <span class="keyword"><span class="keyword">implements</span> <span class="type">EmpService</span></span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmpMapper empMapper;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>EmpController:</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.service.EmpService;</span><br><span class="line"><span class="keyword">import</span> lombok.<span class="keyword">extern</span>.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** * 员工管理 */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_"><span class="keyword">class</span> <span class="title">EmpController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmpService empService;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-1-2SQL-Mapper接口">1.1.2SQL&amp;Mapper接口</h4><p><strong>1). 对应的SQL语句</strong></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 查询所有的员工信息，如果员工关联了部门，也要查询出部门名称</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">e</span>.*, d.name <span class="keyword">as</span> dept_name <span class="keyword">from</span> emp <span class="built_in">e</span> <span class="keyword">left</span> <span class="keyword">join</span> dept d <span class="keyword">on</span> <span class="built_in">e</span>.dept_id = d.id;</span><br></pre></td></tr></table></figure><p><strong>2). Mapper接口方法定义</strong></p><p>那接下来，我们就定义一个员工管理的mapper接口 <code>EmpMapper</code> 并在其中完成员工信息的查询。 具体代码如下：</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_"><span class="keyword">interface</span> <span class="title">EmpMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询所有的员工及其对应的部门名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Select</span>(<span class="string">&quot;select e.*, d.name as deptName from emp e left join dept d on e.dept_id = d.id&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> List&lt;Emp&gt; list();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意，上述SQL语句中，给 部门名称起了别名 <code>deptName</code> ，是因为在接口文档中，要求部门名称给前端返回的数据中，就必须叫 <code>deptName</code>。 而这里我们需要将查询返回的每一条记录都封装到Emp对象中，那么就必须保证查询返回的字段名与属性名是一一对应的。</p><p>此时，我们就需要在Emp中定义一个属性 <code>deptName</code> 用来封装部门名称。 具体如下：</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">Data</span></span><br><span class="line"><span class="keyword">public</span> class Emp &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">Integer</span> id; <span class="comment">//ID,主键</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> username; <span class="comment">//用户名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> password; <span class="comment">//密码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> name; <span class="comment">//姓名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">Integer</span> gender; <span class="comment">//性别, 1:男, 2:女</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> phone; <span class="comment">//手机号</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">Integer</span> job; <span class="comment">//职位, 1:班主任,2:讲师,3:学工主管,4:教研主管,5:咨询师</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">Integer</span> salary; <span class="comment">//薪资</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> image; <span class="comment">//头像</span></span><br><span class="line">    <span class="keyword">private</span> LocalDate entryDate; <span class="comment">//入职日期</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">Integer</span> deptId; <span class="comment">//关联的部门ID</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime; <span class="comment">//创建时间</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updateTime; <span class="comment">//修改时间</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装部门名称数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> deptName; <span class="comment">//部门名称</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码编写完毕后，我们可以编写一个单元测试，对上述的程序进行测试：</p><h3 id="1-2分页查询">1.2分页查询</h3><p>每次只展示一页的数据，比如：一页展示10条数据，如果还想看其他的数据，可以通过点击页码进行查询。</p><p>而在员工管理的需求中，就要求我们进行分页查询，展示出对应的数据。 具体的页面原型如下：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-338-1024x432.png" alt="img"></p><p>要想从数据库中进行分页查询，我们要使用<code>LIMIT</code>关键字，格式为：limit 开始索引 每页显示的条数。</p><p>查询第1,2,3页数据的SQL语句是：</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp  <span class="keyword">limit</span> <span class="number">0</span>,<span class="number">10</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp  <span class="keyword">limit</span> <span class="number">10</span>,<span class="number">10</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp  <span class="keyword">limit</span> <span class="number">20</span>,<span class="number">10</span>;</span><br></pre></td></tr></table></figure><p>观察以上SQL语句，发现： 开始索引一直在改变 ， 每页显示条数是固定的</p><p><strong>开始索引的计算公式： <code>开始索引 = (当前页码 - 1) \* 每页显示条数</code></strong></p><p>我们继续基于页面原型，继续分析，得出以下结论：</p><ol><li>前端在请求服务端时，传递的参数<ol><li>当前页码 page</li><li>每页显示条数 pageSize</li></ol></li><li>后端需要响应什么数据给前端<ol><li>所查询到的数据列表（存储到List 集合中）</li><li>总记录数</li></ol></li></ol><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-312-1024x407.png" alt="img"></p><p>后台给前端返回的数据包含：List集合(数据列表)、total(总记录数)</p><p>而这两部分我们通常封装到PageResult对象中，并将该对象转换为json格式的数据响应回给浏览器。</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Data</span></span><br><span class="line"><span class="variable">@NoArgsConstructor</span></span><br><span class="line"><span class="variable">@AllArgsConstructor</span></span><br><span class="line">public class PageResult &#123;</span><br><span class="line">        <span class="selector-tag">private</span> <span class="selector-tag">Long</span> <span class="selector-tag">total</span>; <span class="comment">//总记录数</span></span><br><span class="line">        <span class="selector-tag">private</span> <span class="selector-tag">List</span> <span class="selector-tag">rows</span>; <span class="comment">//当前页数据列表</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>大家会发现：分页查询功能编写起来比较繁琐。 而分页查询的功能是非常常见的，分页查询的思路、步骤是比较固定的。 在Mapper接口中定义两个方法执行两条不同的SQL语句：</p><ol><li>查询总记录数</li><li>指定页码的数据列表</li></ol><p>在Service当中，调用Mapper接口的两个方法，分别获取：总记录数、查询结果列表，然后在将获取的数据结果封装到PageBean对象中。</p><p>如果在未来开发其他项目，只要涉及到分页查询功能(例：订单、用户、支付、商品)，都必须按照以上操作完成功能开发</p><p>结论：原始方式的分页查询，存在着&quot;步骤固定&quot;、&quot;代码频繁&quot;的问题</p><p>解决方案：可以使用一些现成的分页插件完成。对于Mybatis来讲现在最主流的就是PageHelper。</p><h3 id="1-3PageHelper分页插件">1.3PageHelper分页插件</h3><h4 id="1-3-1介绍">1.3.1介绍</h4><p><strong>PageHelper是第三方提供的Mybatis框架中的一款功能强大、方便易用的分页插件，支持任何形式的单标、多表的分页查询。</strong></p><p>官网：<a href="https://pagehelper.github.io/">https://pagehelper.github.io/</a></p><p>那接下来，我们可以对比一下，使用PageHelper分页插件进行分页 与 原始方式进行分页代码实现的上的差别。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-313-1024x466.png" alt="img"></p><ul><li>Mapper接口层：<ul><li>原始的分页查询功能中，我们需要在Mapper接口中定义两条SQL语句。</li><li>PageHelper实现分页查询之后，只需要编写一条SQL语句，而且不需要考虑分页操作，就是一条正常的查询语句。</li></ul></li><li>Service层：<ul><li>需要根据页码、每页展示记录数，手动的计算起始索引。</li><li>无需手动计算起始索引，直接告诉PageHelper需要查询那一页的数据，每页展示多少条记录即可。</li></ul></li></ul><h4 id="1-3-2代码实现">1.3.2代码实现</h4><p>当使用了PageHelper分页插件进行分页，就无需再Mapper中进行手动分页了。 在Mapper中我们只需要进行正常的列表查询即可。在Service层中，调用Mapper的方法之前设置分页参数，在调用Mapper方法执行查询之后，解析分页结果，并将结果封装到PageResult对象中返回。</p><p>1). 在pom.xml引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--分页插件PageHelper--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2). EmpMapper</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询所有的员工及其对应的部门名称</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Select(<span class="string">&quot;select e.*, d.name deptName from emp as e left join dept as d on e.dept_id = d.id&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Emp&gt; <span class="title">list</span>()</span>;</span><br></pre></td></tr></table></figure><p>3). EmpServiceImpl</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">PageResult</span> page(<span class="type">Integer</span> page, <span class="type">Integer</span> pageSize) &#123;</span><br><span class="line">    <span class="comment">//1. 设置分页参数</span></span><br><span class="line">    <span class="type">PageHelper</span>.startPage(page,pageSize);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 执行查询</span></span><br><span class="line">    <span class="type">List</span>&lt;<span class="type">Emp</span>&gt; empList <span class="operator">=</span> empMapper.list();</span><br><span class="line">    <span class="type">Page</span>&lt;<span class="type">Emp</span>&gt; p <span class="operator">=</span> (<span class="type">Page</span>&lt;<span class="type">Emp</span>&gt;) empList;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 封装结果</span></span><br><span class="line">    <span class="keyword">return</span> new <span class="type">PageResult</span>(p.getTotal(), p.getResult());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-3-3pageHelper的实现机制">1.3.3pageHelper的实现机制</h4><p>我们打开Idea的控制台，可以看到在进行分页查询时，输出的SQL语句。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-334-1024x214.png" alt="img"></p><p>我们看到执行了两条SQL语句，而这两条SQL语句，其实是从我们在Mapper接口中定义的SQL演变而来的。</p><ul><li>第一条SQL语句，用来查询总记录数。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-336-1024x78.png" alt="img"></p><p>其实就是将我们编写的SQL语句进行的改造增强，将查询返回的字段列表替换成了 <code>count(0)</code> 来统计总记录数。</p><ul><li>第二条SQL语句，用来进行分页查询，查询指定页码对应 的数据列表。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-337-1024x86.png" alt="img"></p><p>其实就是将我们编写的SQL语句进行的改造增强，在SQL语句之后拼接上了limit进行分页查询，而由于测试时查询的是第一页，起始索引是0，所以简写为limit ？。</p><p>而PageHelper在进行分页查询时，会执行上述两条SQL语句，并将查询到的总记录数，与数据列表封装到了 <code>Page&lt;Emp&gt;</code> 对象中，我们再获取查询结果时，只需要调用Page对象的方法就可以获取。</p><p><strong>注意：</strong></p><ul><li>PageHelper实现分页查询时，SQL语句的结尾一定一定一定不要加分号(;).，容易出现拼接问题</li><li>PageHelper只会对紧跟在其后的第一条SQL语句进行分页处理。</li></ul><h3 id="1-4条件分页查询">1.4条件分页查询</h3><p>完了分页查询后，下面我们需要在分页查询的基础上，添加条件。</p><h4 id="1-4-1需求">1.4.1需求</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-317-1024x567.png" alt="img"></p><p>通过员工管理的页面原型我们可以看到，员工列表页面的查询，不仅仅需要考虑分页，还需要考虑查询条件。 分页查询我们已经实现了，接下来，我们需要考虑在分页查询的基础上，再加上查询条件。</p><p>我们看到页面原型及需求中描述，搜索栏的搜索条件有三个，分别是：</p><ul><li>姓名：模糊匹配</li><li>性别：精确匹配</li><li>入职日期：范围匹配</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-318-1024x729.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-319-1024x904.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-320.png" alt="img"></p><h4 id="1-4-2实现思路">1.4.2实现思路</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-321-1024x286.png" alt="img"></p><h4 id="1-4-3代码实现">1.4.3代码实现</h4><p>在原有分页查询的代码基础上进行改造。</p><p><strong>1). 在EmpController方法中通过多个方法形参，依次接收这几个参数</strong></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(<span class="string">&quot;/emps&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmpController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmpService empService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> Result page(<span class="meta">@RequestParam(defaultValue = <span class="string">&quot;1&quot;</span>)</span> Integer page,</span><br><span class="line">                       <span class="meta">@RequestParam(defaultValue = <span class="string">&quot;10&quot;</span>)</span> Integer pageSize,</span><br><span class="line">                       String name, Integer gender,</span><br><span class="line">                       <span class="meta">@DateTimeFormat(pattern = <span class="string">&quot;yyyy-MM-dd&quot;</span>)</span> LocalDate begin,</span><br><span class="line">                       <span class="meta">@DateTimeFormat(pattern = <span class="string">&quot;yyyy-MM-dd&quot;</span>)</span> LocalDate end) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;查询请求参数： &#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;, &#123;&#125;&quot;</span>, page, pageSize, name, gender, begin, end);</span><br><span class="line">        PageResult pageResult = empService.page(page, pageSize);</span><br><span class="line">        <span class="keyword">return</span> Result.success(pageResult);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2). 修改EmpService及EmpServiceImpl中的代码逻辑</strong></p><p>EmpService：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">public</span> interface EmpService &#123;</span><br><span class="line">    <span class="comment">/**    </span></span><br><span class="line"><span class="comment">   * 分页查询    </span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">PageResult page(<span class="type">Integer</span> page, <span class="type">Integer</span> pageSize, String <span class="type">name</span>, <span class="type">Integer</span> gender, LocalDate <span class="keyword">begin</span>, LocalDate <span class="keyword">end</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>EmpServiceImpl:</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment">* 员工管理 </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_"><span class="keyword">class</span> <span class="title">EmpServiceImpl</span> <span class="keyword"><span class="keyword">implements</span> <span class="type">EmpService</span></span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmpMapper empMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PageResult page(Integer page, Integer pageSize, <span class="keyword">String</span> name, Integer gender, LocalDate begin, LocalDate end) &#123;</span><br><span class="line">        <span class="comment">//1. 设置PageHelper分页参数</span></span><br><span class="line">        PageHelper.startPage(page, pageSize);</span><br><span class="line">        <span class="comment">//2. 执行查询</span></span><br><span class="line">        List&lt;Emp&gt; empList = empMapper.list(name, gender, begin, end);</span><br><span class="line">        <span class="comment">//3. 封装分页结果</span></span><br><span class="line">        Page&lt;Emp&gt; p = (Page&lt;Emp&gt;) empList;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span><span class="type"></span> PageResult(p.getTotal(), p.getResult());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>3). 调整EmpMapper接口方法</strong></p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Mapper</span><br><span class="line"><span class="keyword">public</span> interface EmpMapper &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**     </span></span><br><span class="line"><span class="comment">    * 查询所有的员工及其对应的部门名称    </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Emp&gt; <span class="title">list</span><span class="params">(<span class="type">String</span> name, Integer gender, LocalDate begin, LocalDate end)</span></span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于SQL语句比较复杂，建议将SQL语句配置在XML映射文件中。</p><p><strong>4). 新增Mapper映射文件</strong>**<code>EmpMapper.xml</code>**</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!--定义Mapper映射文件的约束和基本结构--&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span></span><br><span class="line"><span class="meta"><span class="language-xml">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span></span><br><span class="line"><span class="meta"><span class="language-xml">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.itheima.mapper.EmpMapper&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;list&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.itheima.pojo.Emp&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        select e.*, d.name deptName from emp as e left join dept as d on e.dept_id = d.id</span></span><br><span class="line"><span class="language-xml">        where e.name like concat(&#x27;%&#x27;,#</span><span class="template-variable">&#123;name&#125;</span><span class="language-xml">,&#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">          and e.gender = #</span><span class="template-variable">&#123;gender&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">          and e.entry_date between #</span><span class="template-variable">&#123;begin&#125;</span><span class="language-xml"> and #</span><span class="template-variable">&#123;end&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h4 id="1-4-4程序优化1（请求参数封装实体类简化代码）">1.4.4程序优化1（请求参数封装实体类简化代码）</h4><p>在上述分页条件查询中，请求参数比较多，有6个，如下所示：</p><ul><li>请求参数：/emps?name=张&amp;gender=1&amp;begin=2007-09-01&amp;end=2022-09-01&amp;page=1&amp;pageSize=10</li></ul><p>那我们在controller层方法中，接收请求参数的时候，直接在controller方法中声明这样6个参数即可，这样做，功能可以实现，但是不方便维护和管理。</p><p>优化思路：定义一个实体类，来封装这几个请求参数。 <strong>【需要保证，前端传递的请求参数和实体类的属性名是一样的】</strong></p><p><strong>1). 定义实体类：EmpQueryParam</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.format.annotation.DateTimeFormat;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmpQueryParam</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">page</span> <span class="operator">=</span> <span class="number">1</span>; <span class="comment">//页码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">pageSize</span> <span class="operator">=</span> <span class="number">10</span>; <span class="comment">//每页展示记录数</span></span><br><span class="line">    <span class="keyword">private</span> String name; <span class="comment">//姓名</span></span><br><span class="line">    <span class="keyword">private</span> Integer gender; <span class="comment">//性别</span></span><br><span class="line">    <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDate begin; <span class="comment">//入职开始时间</span></span><br><span class="line">    <span class="meta">@DateTimeFormat(pattern = &quot;yyyy-MM-dd&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDate end; <span class="comment">//入职结束时间</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2). EmpController接收请求参数</strong></p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span></span><br><span class="line"><span class="keyword">public</span> <span class="function">Result <span class="title">page</span><span class="params">(EmpQueryParam empQueryParam)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;查询请求参数： &#123;&#125;&quot;</span>, empQueryParam);</span><br><span class="line">    PageResult pageResult = empService.page(empQueryParam);</span><br><span class="line">    <span class="function"><span class="keyword">return</span> Result.<span class="title">success</span><span class="params">(pageResult)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>3). 修改EmpService接口方法</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">public</span> interface EmpService &#123;</span><br><span class="line">    <span class="comment">/**     * 分页查询     */</span></span><br><span class="line">//PageResult page(<span class="type">Integer</span> page, <span class="type">Integer</span> pageSize, String <span class="type">name</span>, <span class="type">Integer</span> gender, LocalDate <span class="keyword">begin</span>, LocalDate <span class="keyword">end</span>);</span><br><span class="line">    PageResult page(EmpQueryParam empQueryParam);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>4). 修改EmpServiceImpl中的page方法</strong></p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">@</span>Service</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> EmpServiceImpl implements EmpService &#123;</span><br><span class="line"></span><br><span class="line">    <span class="operator">@</span>Autowired</span><br><span class="line">    <span class="keyword">private</span> EmpMapper empMapper;</span><br><span class="line"></span><br><span class="line">    <span class="operator">/*@</span>Override</span><br><span class="line">    <span class="keyword">public</span> PageResult page(Integer page, Integer pageSize, String name, Integer gender, LocalDate <span class="keyword">begin</span>, LocalDate <span class="keyword">end</span>) &#123;</span><br><span class="line">        <span class="comment">//1. 设置PageHelper分页参数</span></span><br><span class="line">        PageHelper.startPage(page, pageSize);</span><br><span class="line">        <span class="comment">//2. 执行查询</span></span><br><span class="line">        List<span class="operator">&lt;</span>Emp<span class="operator">&gt;</span> empList <span class="operator">=</span> empMapper.list(name, gender, <span class="keyword">begin</span>, <span class="keyword">end</span>);</span><br><span class="line">        <span class="comment">//3. 封装分页结果</span></span><br><span class="line">        Page<span class="operator">&lt;</span>Emp<span class="operator">&gt;</span> p <span class="operator">=</span> (Page<span class="operator">&lt;</span>Emp<span class="operator">&gt;</span>) empList;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PageResult(p.getTotal(), p.getResult());</span><br><span class="line">    &#125;<span class="operator">*/</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> PageResult page(EmpQueryParam empQueryParam) &#123;</span><br><span class="line">        <span class="comment">//1. 设置PageHelper分页参数</span></span><br><span class="line">        PageHelper.startPage(empQueryParam.getPage(), empQueryParam.getPageSize());</span><br><span class="line">        <span class="comment">//2. 执行查询</span></span><br><span class="line">        List<span class="operator">&lt;</span>Emp<span class="operator">&gt;</span> empList <span class="operator">=</span> empMapper.list(empQueryParam);</span><br><span class="line">        <span class="comment">//3. 封装分页结果</span></span><br><span class="line">        Page<span class="operator">&lt;</span>Emp<span class="operator">&gt;</span> p <span class="operator">=</span> (Page<span class="operator">&lt;</span>Emp<span class="operator">&gt;</span>)empList;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PageResult(p.getTotal(), p.getResult());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>5). 修改EmpMapper接口方法</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Mapper</span><br><span class="line"><span class="built_in">public</span> interface EmpMapper &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**     * 查询所有的员工及其对应的部门名称     */</span></span><br><span class="line">//    @<span class="keyword">Select</span>(&quot;select e.*, d.name as deptName from emp e left join dept d on e.dept_id = d.id&quot;)</span><br><span class="line">//    <span class="built_in">public</span> List&lt;Emp&gt; list(String <span class="type">name</span>, <span class="type">Integer</span> gender, LocalDate <span class="keyword">begin</span>, LocalDate <span class="keyword">end</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**     * 根据查询条件查询员工     */</span></span><br><span class="line">List&lt;Emp&gt; list(EmpQueryParam empQueryParam);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>EmpMapper.xml 中的配置无需修改。</p><p>但当我们在测试的时候，页码输入负数，查询是有问题的，查不到对应的数据了。</p><p>那其实在PageHelper中，我们可以通过合理化参数配置，来解决这个问题。直接在application.yml中，引入如下配置即可：</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">pagehelper:</span></span><br><span class="line">  <span class="params">reasonable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="params">helper-dialect:</span> mysql</span><br></pre></td></tr></table></figure><p>reasonable：分页合理化参数，默认值为false。当该参数设置为true时，pageNum&lt;=0时会查询第一页，pageNum&gt;pages（超过总数时），会查询最后一页。默认false 时，直接根据参数进行查询。</p><h4 id="1-4-5程序优化2（动态SQL改造）">1.4.5程序优化2（动态SQL改造）</h4><p>当前，我们在查询的时候，Mapper映射配置文件中的SQL语句中，查询条件是写死的。 而我们在员工管理中，根据条件查询员工信息时，查询条件是可选的，可以输入也可以不输入。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-322-1024x94.png" alt="img"></p><ul><li>如果只输入 <strong>姓名</strong> 这个查询条件，则SQL语句中只根据name字段查询，SQL如下：</li></ul><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">e</span>.*, d.name deptName <span class="keyword">from</span> emp <span class="keyword">as</span> <span class="built_in">e</span> <span class="keyword">left</span> <span class="keyword">join</span> dept <span class="keyword">as</span> d <span class="keyword">on</span> <span class="built_in">e</span>.dept_id = d.id <span class="keyword">where</span> <span class="built_in">e</span>.name <span class="keyword">like</span> concat(<span class="string">&#x27;%&#x27;</span>,#&#123;name&#125;,<span class="string">&#x27;%&#x27;</span>)；</span><br></pre></td></tr></table></figure><ul><li>如果只输入 <strong>性别</strong> 这个查询条件，则SQL语句中只根据gender字段查询，SQL如下：</li></ul><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">e</span>.*, d.name deptName <span class="keyword">from</span> emp <span class="keyword">as</span> <span class="built_in">e</span> <span class="keyword">left</span> <span class="keyword">join</span> dept <span class="keyword">as</span> d <span class="keyword">on</span> <span class="built_in">e</span>.dept_id = d.id <span class="keyword">where</span> <span class="built_in">e</span>.gender = #&#123;gender&#125;；</span><br></pre></td></tr></table></figure><ul><li>如果输入 <strong>姓名</strong> 和 <strong>性别</strong> 这两个查询条件，则SQL语句中要根据name、gender两个字段查询，SQL如下：</li></ul><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">e</span>.*, d.name deptName <span class="keyword">from</span> emp <span class="keyword">as</span> <span class="built_in">e</span> <span class="keyword">left</span> <span class="keyword">join</span> dept <span class="keyword">as</span> d <span class="keyword">on</span> <span class="built_in">e</span>.dept_id = d.id</span><br><span class="line"><span class="keyword">where</span> <span class="built_in">e</span>.name <span class="keyword">like</span> concat(<span class="string">&#x27;%&#x27;</span>,#&#123;name&#125;,<span class="string">&#x27;%&#x27;</span>) <span class="keyword">and</span> <span class="built_in">e</span>.gender = #&#123;gender&#125;；</span><br></pre></td></tr></table></figure><p>我们看到，这个SQL语句不应该是写死的，而应该根据用户输入的条件的变化而变化。 那这里呢，就要通过Mybatis中的<strong>动态SQL</strong>来实现。</p><p><strong>所谓动态SQL，指的就是随着用户的输入或外部的条件的变化而变化的SQL语句。</strong></p><p>具体的代码实现如下：</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!--定义Mapper映射文件的约束和基本结构--&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span></span><br><span class="line"><span class="meta"><span class="language-xml">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span></span><br><span class="line"><span class="meta"><span class="language-xml">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.itheima.mapper.EmpMapper&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;list&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.itheima.pojo.Emp&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        select e.*, d.name deptName from emp as e left join dept as d on e.dept_id = d.id</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">where</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;name != null and name != &#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                e.name like concat(&#x27;%&#x27;,#</span><span class="template-variable">&#123;name&#125;</span><span class="language-xml">,&#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;gender != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                and e.gender = #</span><span class="template-variable">&#123;gender&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;begin != null and end != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                and e.entry_date between #</span><span class="template-variable">&#123;begin&#125;</span><span class="language-xml"> and #</span><span class="template-variable">&#123;end&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>在这里呢，我们用到了两个动态SQL的标签：<code>&lt;if&gt;``&lt;where&gt;</code>。 这两个标签的具体作用如下：</p><p><code>&lt;if&gt;</code>：判断条件是否成立，如果条件为true，则拼接SQL。</p><p><code>&lt;where&gt;</code>：根据查询条件，来生成where关键字，并会自动去除条件前面多余的and或or。</p><p>当我们输入不同的搜索条件时，会动态的根据查询条件，动态拼接SQL语句。</p><h2 id="2-新增员工">2.新增员工</h2><h3 id="2-1需求">2.1需求</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-323.png" alt="img"></p><p>在新增员工的时候，在表单中，我们既要录入员工的基本信息，又要录入员工的工作经历信息。 员工基本信息，对应的表结构是 emp表，员工工作经历信息，对应的表结构是 emp_expr 表，所以这里我们要操作两张表，往两张表中保存数据。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-330-1024x854.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-331-1024x695.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-332-1024x506.png" alt="img"></p><h3 id="2-2实现思路">2.2实现思路</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-333-1024x263.png" alt="img"></p><ul><li>接口文档规定：<ul><li>请求路径：/emps</li><li>请求方式：POST</li><li>请求参数：Json格式数据</li><li>响应数据：Json格式数据</li></ul></li><li>**问题1：**如何限定请求方式是POST？ <strong><code>@PostMapping</code></strong></li><li><strong>问题2：<strong>怎么在controller中接收json格式的请求参数？</strong><code>@RequestBody</code></strong></li></ul><h3 id="2-3功能开发">2.3功能开发</h3><h4 id="2-3-1准备工作">2.3.1准备工作</h4><p>准备<code>EmpExprMapper</code>接口及映射配置文件<code>EmpExprMapper.xml</code>，并准备实体类接收前端传递的json格式的请求参数。</p><p>1). EmpExprMapper接口</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_"><span class="keyword">interface</span> <span class="title">EmpExprMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2). EmpExprMapper.xml 配置文件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.itheima.mapper.EmpExprMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><p>3). 需要在 <code>Emp</code> 员工实体类中增加属性 <code>exprList</code> 来封装工作经历数据。 最终完整代码如下：</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">Data</span></span><br><span class="line"><span class="keyword">public</span> class Emp &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">Integer</span> id; <span class="comment">//ID,主键</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> username; <span class="comment">//用户名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> password; <span class="comment">//密码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> name; <span class="comment">//姓名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">Integer</span> gender; <span class="comment">//性别, 1:男, 2:女</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> phone; <span class="comment">//手机号</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">Integer</span> job; <span class="comment">//职位, 1:班主任,2:讲师,3:学工主管,4:教研主管,5:咨询师</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">Integer</span> salary; <span class="comment">//薪资</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> image; <span class="comment">//头像</span></span><br><span class="line">    <span class="keyword">private</span> LocalDate entryDate; <span class="comment">//入职日期</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">Integer</span> deptId; <span class="comment">//关联的部门ID</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime; <span class="comment">//创建时间</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updateTime; <span class="comment">//修改时间</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装部门名称数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">String</span> deptName; <span class="comment">//部门名称</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装员工工作经历信息    private List&lt;EmpExpr&gt; exprList;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-3-2保存员工基本信息">2.3.2保存员工基本信息</h4><p>1). EmpController</p><p>在 <code>EmpController</code> 中增加save方法。</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加员工</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@PostMapping</span></span><br><span class="line">public Result <span class="built_in">save</span>(<span class="variable">@RequestBody</span> Emp emp)&#123;</span><br><span class="line">    <span class="selector-tag">log</span><span class="selector-class">.info</span>(<span class="string">&quot;请求参数emp: &#123;&#125;&quot;</span>, emp);</span><br><span class="line">    <span class="selector-tag">empService</span><span class="selector-class">.save</span>(emp);</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">Result</span><span class="selector-class">.success</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2). EmpService &amp; EmpServiceImpl</p><p>在 <code>EmpService</code> 中增加 save 方法</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 添加员工</span></span><br><span class="line"><span class="comment">* @param emp</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">save</span><span class="params">(Emp emp)</span></span>;</span><br></pre></td></tr></table></figure><p>在 <code>EmpServiceImpl</code> 中增加save方法 , 实现接口中的save方法</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@Override</span></span><br><span class="line">public void save(Emp emp) &#123;</span><br><span class="line">    <span class="comment">//1.补全基础属性</span></span><br><span class="line">    emp<span class="selector-class">.setCreateTime</span>(LocalDateTime.now());</span><br><span class="line">    emp<span class="selector-class">.setUpdateTime</span>(LocalDateTime.now());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//2.保存员工基本信息</span></span><br><span class="line">    empMapper<span class="selector-class">.insert</span>(emp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 保存员工的工作经历信息 - 批量 (稍后完成)</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3). EmpMapper</p><p>在 <code>EmpMapper</code> 中增加insert方法，新增员工的基本信息。</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 新增员工数据</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">@Options(useGeneratedKeys = <span class="literal">true</span>, keyProperty = <span class="string">&quot;id&quot;</span>)</span><br><span class="line">@Insert(<span class="string">&quot;insert into emp(username, name, gender, phone, job, salary, image, entry_date, dept_id, create_time, update_time) &quot;</span> +</span><br><span class="line">        <span class="string">&quot;values (<span class="subst">#&#123;username&#125;</span>,<span class="subst">#&#123;name&#125;</span>,<span class="subst">#&#123;gender&#125;</span>,<span class="subst">#&#123;phone&#125;</span>,<span class="subst">#&#123;job&#125;</span>,<span class="subst">#&#123;salary&#125;</span>,<span class="subst">#&#123;image&#125;</span>,<span class="subst">#&#123;entryDate&#125;</span>,<span class="subst">#&#123;deptId&#125;</span>,<span class="subst">#&#123;createTime&#125;</span>,<span class="subst">#&#123;updateTime&#125;</span>)&quot;</span>)</span><br><span class="line"><span class="literal">void</span> insert(Emp emp);</span><br></pre></td></tr></table></figure><p><strong>主键返回：</strong><code>@Options(useGeneratedKeys = true, keyProperty = &quot;id&quot;)</code></p><p>由于稍后，我们在保存工作经历信息的时候，需要记录是哪位员工的工作经历。 所以，保存完员工信息之后，是需要获取到员工的ID的，那这里就需要<strong>通过Mybatis中提供的主键返回功能来获取</strong>。</p><h4 id="2-3-3批量保存工作经历">2.3.3批量保存工作经历</h4><h5 id="1-分析">1.分析</h5><p>一个员工，是可以有多段工作经历的，所以在页面上将来用户录入员工信息时，可以自己根据需要添加多段工作经历。页面原型展示如下：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-344.png" alt="img"></p><p>那如果员工只有一段工作经历，我们就需要往工作经历表中保存一条记录。 执行的SQL如下：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-374-1024x85.png" alt="img"></p><p>如果员工有两段工作经历，我们就需要往工作经历表中保存两条记录。执行的SQL如下：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-375-1024x106.png" alt="img"></p><p>如果员工有三段工作经历，我们就需要往工作经历表中保存三条记录。执行的SQL如下：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-376-1024x119.png" alt="img"></p><p>所以，这里最终我们需要执行的是批量插入数据的insert语句。</p><h5 id="2-代码实现">2.代码实现</h5><p>1). EmpServiceImpl</p><p>完善save方法中保存员工信息的逻辑。完整逻辑如下：</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public <span class="keyword">void</span> save(Emp emp) &#123;</span><br><span class="line">    <span class="comment">//1.补全基础属性</span></span><br><span class="line">    emp.setCreateTime(LocalDateTime.<span class="built_in">now</span>());</span><br><span class="line">    emp.setUpdateTime(LocalDateTime.<span class="built_in">now</span>());</span><br><span class="line">    <span class="comment">//2.保存员工基本信息</span></span><br><span class="line">    empMapper.<span class="built_in">insert</span>(emp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 保存员工的工作经历信息 - 批量</span></span><br><span class="line">    Integer empId = emp.getId();</span><br><span class="line">    List&lt;EmpExpr&gt; exprList = emp.getExprList();</span><br><span class="line">    <span class="keyword">if</span>(!CollectionUtils.<span class="built_in">isEmpty</span>(exprList))&#123;</span><br><span class="line">        exprList.forEach(empExpr -&gt; empExpr.setEmpId(empId));</span><br><span class="line">        empExprMapper.insertBatch(exprList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2). EmpExprMapper</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Mapper</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="symbol">EmpExprMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 批量插入员工工作经历信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> insertBatch(List&lt;EmpExpr&gt; exprList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3). EmpExprMapper.xml</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span></span><br><span class="line"><span class="meta"><span class="language-xml">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span></span><br><span class="line"><span class="meta"><span class="language-xml">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.itheima.mapper.EmpExprMapper&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!--批量插入员工工作经历信息--&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insertBatch&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        insert into emp_expr (emp_id, begin, end, company, job) values</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;exprList&quot;</span> <span class="attr">item</span>=<span class="string">&quot;expr&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            (#</span><span class="template-variable">&#123;expr.empId&#125;</span><span class="language-xml">, #</span><span class="template-variable">&#123;expr.begin&#125;</span><span class="language-xml">, #</span><span class="template-variable">&#123;expr.end&#125;</span><span class="language-xml">, #</span><span class="template-variable">&#123;expr.company&#125;</span><span class="language-xml">, #</span><span class="template-variable">&#123;expr.job&#125;</span><span class="language-xml">)</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span></span><br></pre></td></tr></table></figure><blockquote><p>这里用到Mybatis中的动态SQL里提供的 <code>&lt;foreach&gt;</code> 标签，改标签的作用，是用来遍历循环，常见的属性说明：</p><ol><li>collection：集合名称</li><li>item：集合遍历出来的元素/项</li><li>separator：每一次遍历使用的分隔符</li><li>open：遍历开始前拼接的片段</li><li>close：遍历结束后拼接的片段</li></ol><p>上述的属性，是可选的，并不是所有的都是必须的。 可以自己根据实际需求，来指定对应的属性。</p></blockquote><p>Apifox请求完毕后，可以打开idea的控制台看到控制台输出的日志：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-377-1024x246.png" alt="img"></p><h2 id="3-事务管理">3.事务管理</h2><h3 id="3-1问题分析">3.1问题分析</h3><p>目前我们实现的新增员工功能中，操作了两次数据库，执行了两次 insert 操作。</p><ul><li>第一次：保存员工的基本信息到 <code>emp</code> 表中。</li><li>第二次：保存员工的工作经历信息到 <code>emp_expr</code> 表中。</li></ul><p>如果说，保存员工的基本信息成功了，而保存员工的工作经历信息出错了，会发生什么现象呢？那接下来，我们来做一个测试 。 我们可以在代码中，人为在保存员工的service层的save方法中，构造一个错误：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-345-1024x508.png" alt="img"></p><p>那接下来，我们就重启服务，打开浏览器，来做一个测试：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-378-1024x496.png" alt="img"></p><p>点击 “保存” 之后，提示 “系统接口异常”。我们可以打开IDEA控制台看一下，报出的错误信息。 我们看到，保存了员工的基本信息之后，系统出现了异常。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-379-1024x392.png" alt="img"></p><p>我们再打开数据库，看看表结构中的数据是否正常。</p><p>1). <code>emp</code> 员工表中是有 <code>shaseng</code> 这条数据的。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-381-1024x464.png" alt="img"></p><p>2). <code>emp_expr</code> 表中没有该员工的工作经历信息。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-380-1024x159.png" alt="img"></p><p>最终，我们看到，程序出现了异常 ，员工表 <code>emp</code> 数据保存成功了, 但是 <code>emp_expr</code> 员工工作经历信息表，数据保存失败了。 那是否允许这种情况发生呢？</p><ul><li>不允许</li><li>因为这属于一个业务操作，如果保存员工信息成功了，保存工作经历信息失败了，就会造成数据库数据的不完整、不一致。</li></ul><p>那如何解决这个问题呢？ 这需要通过数据库中的<strong>事务</strong>来解决这个问题。</p><h3 id="3-2介绍">3.2介绍</h3><p><strong>概念：</strong> 事务是一组操作的集合，它是一个不可分割的工作单位。事务会把所有的操作作为一个整体一起向系统提交或撤销操作请求，即这些操作 <strong>要么同时成功，要么同时失败</strong>。</p><p>就拿添加员工的这个业务为例，在这个业务操作中，包含了两个操作，那这两个操作是一个不可分割的工作单位。</p><p>这两个操作，要么同时失败，要么同时成功。</p><p>默认MySQL的事务是自动提交的，也就是说，当执行一条DML语句，MySQL会立即隐式的提交事务。</p><h3 id="3-3操作">3.3操作</h3><p>事务控制主要三步操作：开启事务、提交事务/回滚事务。</p><ul><li>需要在这组操作执行之前，先开启事务 ( <code>start transaction; / begin;</code>)。</li><li>所有操作如果全部都执行成功，则提交事务 ( <code>commit;</code> )。</li><li>如果这组操作中，有任何一个操作执行失败，都应该回滚事务 ( <code>rollback</code> )。</li></ul><p>那接下来，我们就可以将添加员工的业务操作，进行事务管理。 具体的SQL如下：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 开启事务</span></span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span>; / <span class="keyword">begin</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 1. 保存员工基本信息</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> emp <span class="keyword">values</span> (<span class="number">39</span>, <span class="string">&#x27;Tom&#x27;</span>, <span class="string">&#x27;123456&#x27;</span>, <span class="string">&#x27;汤姆&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;13300001111&#x27;</span>, <span class="number">1</span>, <span class="number">4000</span>, <span class="string">&#x27;1.jpg&#x27;</span>, <span class="string">&#x27;2023-11-01&#x27;</span>, <span class="number">1</span>, now(), now());</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 保存员工的工作经历信息</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> emp_expr(emp_id, <span class="keyword">begin</span>, <span class="keyword">end</span>, company, job) <span class="keyword">values</span> (<span class="number">39</span>,<span class="string">&#x27;2019-01-01&#x27;</span>, <span class="string">&#x27;2020-01-01&#x27;</span>, <span class="string">&#x27;百度&#x27;</span>, <span class="string">&#x27;开发&#x27;</span>),                                                                                                       (<span class="number">39</span>,<span class="string">&#x27;2020-01-10&#x27;</span>, <span class="string">&#x27;2022-02-01&#x27;</span>, <span class="string">&#x27;阿里&#x27;</span>, <span class="string">&#x27;架构&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 提交事务(全部成功)</span></span><br><span class="line"><span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 回滚事务(有一个失败)</span></span><br><span class="line"><span class="keyword">rollback</span>;</span><br></pre></td></tr></table></figure><p>事务管理的场景，是非常多的，比如：</p><ul><li>银行转账</li><li>下单扣减库存</li></ul><h3 id="3-4Spring事务管理（-Transactional）">3.4Spring事务管理（@Transactional）</h3><h4 id="3-4-1分析">3.4.1分析</h4><p>在上述实现的新增员工的功能中，一旦在保存员工基本信息后出现异常。 我们就会发现，员工信息保存成功，但是工作经历信息保存失败，造成了数据的不完整不一致。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-382-1024x465.png" alt="img"></p><p>产生原因：</p><ul><li>先执行新增员工的操作，这步执行完毕，就已经往员工表 <code>emp</code> 插入了数据。</li><li>执行 1/0 操作，抛出异常</li><li>抛出异常之前，下面所有的代码都不会执行了，批量保存工作经历信息，这个操作也不会执行 。</li></ul><p>此时就出现问题了，员工基本信息保存了，员工的工作经历信息未保存，业务操作前后数据不一致。</p><p>而要想保证操作前后，数据的一致性，就需要让新增员工中涉及到的两个业务操作，要么全部成功，要么全部失败 。 那我们如何，让这两个操作要么全部成功，要么全部失败呢 ？</p><p>那就可以通过事务来实现，因为一个事务中的多个业务操作，要么全部成功，要么全部失败。</p><p>此时，我们就需要在新增员工功能中添加事务。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-383.png" alt="img"></p><p>在方法运行之前，开启事务，如果方法成功执行，就提交事务，如果方法执行的过程当中出现异常了，就回滚事务。</p><p>**思考：**开发中所有的业务操作，一旦我们要进行控制事务，是不是都是这样的套路？</p><p>**答案：**是的。</p><p>所以在spring框架当中就已经把事务控制的代码都已经封装好了，并不需要我们手动实现。我们使用了spring框架，我们只需要通过一个简单的注解@Transactional就搞定了。</p><h4 id="3-4-2Transactional注解">3.4.2Transactional注解</h4><p><strong>注解：</strong>@Transactional</p><p>**作用：**就是在当前这个方法执行开始之前来开启事务，方法执行完毕之后提交事务。如果在这个方法执行的过程当中出现了异常，就会进行事务的回滚操作。</p><p>**位置：**业务层的方法上、类上、接口上</p><p>接口上：接口下所有的实现类当中所有的方法都交给spring 进行事务管理</p><p>方法上：当前方法交给spring进行事务管理</p><p>类上：当前类中所有的方法都交由spring进行事务管理</p><p>接下来，我们就可以在业务方法save上加上 <code>@Transactional</code> 来控制事务 。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(Emp emp)</span> &#123;</span><br><span class="line">    <span class="comment">//1.补全基础属性</span></span><br><span class="line">    emp.setCreateTime(LocalDateTime.now());</span><br><span class="line">    emp.setUpdateTime(LocalDateTime.now());</span><br><span class="line">    <span class="comment">//2.保存员工基本信息</span></span><br><span class="line">    empMapper.insert(emp);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 保存员工的工作经历信息 - 批量</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">empId</span> <span class="operator">=</span> emp.getId();</span><br><span class="line">    List&lt;EmpExpr&gt; exprList = emp.getExprList();</span><br><span class="line">    <span class="keyword">if</span>(!CollectionUtils.isEmpty(exprList))&#123;</span><br><span class="line">        exprList.forEach(empExpr -&gt; empExpr.setEmpId(empId));</span><br><span class="line">        empExprMapper.insertBatch(exprList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>@Transactional注解：我们一般会在业务层当中来控制事务，因为在业务层当中，一个业务功能可能会包含多个数据访问的操作。在业务层来控制事务，我们就可以将多个数据访问操作控制在一个事务范围内。</p><p>说明：可以在<code>application.yml</code>配置文件中开启事务管理日志，这样就可以在控制看到和事务相关的日志信息了</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#spring事务管理日志</span></span><br><span class="line"><span class="attribute">logging</span><span class="punctuation">: </span></span><br><span class="line">  <span class="attribute">level</span><span class="punctuation">: </span></span><br><span class="line">    <span class="attribute">org.springframework.jdbc.support.JdbcTransactionManager</span><span class="punctuation">:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure><h4 id="3-4-3Transactional的两个重要属性及相关知识点">3.4.3Transactional的两个重要属性及相关知识点</h4><p>一个知识点：Spring的@Transactional会通过set autocommit=0在连接开始时关闭自动提交来禁用MySQL的默认自动提交(autocommit)模式。</p><p>这里主要介绍@Transactional注解当中的两个常见的属性：</p><ul><li>异常回滚的属性：<code>rollbackFor</code></li><li>事务传播行为：<code>propagation</code></li></ul><p>1.<code>rollbackFor</code></p><p>我们在之前编写的业务方法上添加了@Transactional注解，来实现事务管理。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(Emp emp)</span> &#123;</span><br><span class="line">    <span class="comment">//1.补全基础属性</span></span><br><span class="line">    emp.setCreateTime(LocalDateTime.now());</span><br><span class="line">    emp.setUpdateTime(LocalDateTime.now());</span><br><span class="line">    <span class="comment">//2.保存员工基本信息</span></span><br><span class="line">    empMapper.insert(emp);</span><br><span class="line">        </span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//3. 保存员工的工作经历信息 - 批量</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">empId</span> <span class="operator">=</span> emp.getId();</span><br><span class="line">    List&lt;EmpExpr&gt; exprList = emp.getExprList();</span><br><span class="line">    <span class="keyword">if</span>(!CollectionUtils.isEmpty(exprList))&#123;</span><br><span class="line">        exprList.forEach(empExpr -&gt; empExpr.setEmpId(empId));</span><br><span class="line">        empExprMapper.insertBatch(exprList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上业务功能save方法在运行时，会引发除0的算术运算异常(运行时异常)，出现异常之后，由于我们在方法上加了<code>@Transactional</code>注解进行事务管理，所以发生异常会执行rollback回滚操作，从而保证事务操作前后数据是一致的。</p><p>下面我们在做一个测试，我们修改业务功能代码，在模拟异常的位置上直接抛出Exception异常（编译时异常）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(Emp emp)</span> &#123;</span><br><span class="line">    <span class="comment">//1.补全基础属性</span></span><br><span class="line">    emp.setCreateTime(LocalDateTime.now());</span><br><span class="line">    emp.setUpdateTime(LocalDateTime.now());</span><br><span class="line">    <span class="comment">//2.保存员工基本信息</span></span><br><span class="line">    empMapper.insert(emp);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//模拟：异常发生</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;出现异常了~~~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//3. 保存员工的工作经历信息 - 批量</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">empId</span> <span class="operator">=</span> emp.getId();</span><br><span class="line">    List&lt;EmpExpr&gt; exprList = emp.getExprList();</span><br><span class="line">    <span class="keyword">if</span>(!CollectionUtils.isEmpty(exprList))&#123;</span><br><span class="line">        exprList.forEach(empExpr -&gt; empExpr.setEmpId(empId));</span><br><span class="line">        empExprMapper.insertBatch(exprList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>说明：在service中向上抛出一个Exception编译时异常之后，由于是controller调用service，所以在controller中要有异常处理代码，此时我们选择在controller中继续把异常向上抛。</p></blockquote><p>重新启动服务后，打开Apifox进行测试，请求添加员工的接口：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-389-1024x497.png" alt="img"></p><p>通过Apifox返回的结果，我们看到抛出异常了。然后我们在回到IDEA的控制台来看一下。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-388-1024x435.png" alt="img"></p><p>我们看到数据库的事务居然提交了，并没有进行回滚。</p><p>通过以上测试可以得出一个结论：<strong>默认情况下，只有出现RuntimeException(运行时异常)才会回滚事务。</strong></p><p>假如我们想让所有的异常都回滚，需要来配置@Transactional注解当中的rollbackFor属性，通过rollbackFor这个属性可以指定出现何种异常类型回滚事务。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(Emp emp)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//1.补全基础属性</span></span><br><span class="line">    emp.setCreateTime(LocalDateTime.now());</span><br><span class="line">    emp.setUpdateTime(LocalDateTime.now());</span><br><span class="line">    <span class="comment">//2.保存员工基本信息</span></span><br><span class="line">    empMapper.insert(emp);</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//int i = 1/0;</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;出异常啦....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//3. 保存员工的工作经历信息 - 批量</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">empId</span> <span class="operator">=</span> emp.getId();</span><br><span class="line">    List&lt;EmpExpr&gt; exprList = emp.getExprList();</span><br><span class="line">    <span class="keyword">if</span>(!CollectionUtils.isEmpty(exprList))&#123;</span><br><span class="line">        exprList.forEach(empExpr -&gt; empExpr.setEmpId(empId));</span><br><span class="line">        empExprMapper.insertBatch(exprList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来我们重新启动服务，测试新增员工的操作：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-386-1024x498.png" alt="img"></p><p>控制台日志，可以看到因为出现了异常又进行了事务回滚。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-387-1024x406.png" alt="img"></p><p><strong>结论：</strong></p><ul><li>在Spring的事务管理中，默认只有运行时异常 RuntimeException才会回滚。</li><li>如果还需要回滚指定类型的异常，可以通过rollbackFor属性来指定。</li></ul><p>2.propagation</p><p>propagation，这个属性是用来配置事务的传播行为的。</p><p>什么是事务的传播行为呢？</p><ul><li>就是当一个事务方法被另一个事务方法调用时，这个事务方法应该如何进行事务控制。</li></ul><p>例如：两个事务方法，一个A方法，一个B方法。在这两个方法上都添加了@Transactional注解，就代表这两个方法都具有事务，而在A方法当中又去调用了B方法。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-464-1024x204.png" alt="img"></p><p>所谓事务的传播行为，指的就是在A方法运行的时候，首先会开启一个事务，在A方法当中又调用了B方法， B方法自身也具有事务，那么B方法在运行的时候，到底是加入到A方法的事务当中来，还是B方法在运行的时候新建一个事务？这个就涉及到了事务的传播行为。</p><p>我们要想控制事务的传播行为，在@Transactional注解的后面指定一个属性propagation，通过 propagation 属性来指定传播行为。接下来我们就来介绍一下常见的事务传播行为。</p><table><thead><tr><th>属性值</th><th>含义</th></tr></thead><tbody><tr><td>REQUIRED</td><td>【默认值】需要事务，有则加入，无则创建新事务</td></tr><tr><td>REQUIRES_NEW</td><td>需要新事务，无论有无，总是创建新事务</td></tr><tr><td>SUPPORTS</td><td>支持事务，有则加入，无则在无事务状态中运行</td></tr><tr><td>NOT_SUPPORTED</td><td>不支持事务，在无事务状态下运行,如果当前存在已有事务,则挂起当前事务</td></tr><tr><td>MANDATORY</td><td>必须有事务，否则抛异常</td></tr><tr><td>NEVER</td><td>必须没事务，否则抛异常</td></tr><tr><td>…</td><td></td></tr></tbody></table><p>接下来我们就通过一个案例来演示下事务传播行为propagation属性的使用。</p><p>**需求：**在新增员工信息时，无论是成功还是失败，都要记录操作日志。</p><p><strong>步骤：</strong></p><ol><li>准备日志表 emp_log、实体类EmpLog、Mapper接口EmpLogMapper</li><li>在新增员工时记录日志</li></ol><p><strong>准备工作：</strong></p><p>1). 创建数据库表 <code>emp_log</code> 日志表</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建员工日志表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> emp_log(</span><br><span class="line">    id <span class="type">int</span> unsigned <span class="keyword">primary key</span> auto_increment <span class="keyword">comment</span> <span class="string">&#x27;ID, 主键&#x27;</span>,</span><br><span class="line">    operate_time datetime <span class="keyword">comment</span> <span class="string">&#x27;操作时间&#x27;</span>,</span><br><span class="line">    <span class="keyword">info</span> <span class="type">varchar</span>(<span class="number">2000</span>) <span class="keyword">comment</span> <span class="string">&#x27;日志信息&#x27;</span></span><br><span class="line">) <span class="keyword">comment</span> <span class="string">&#x27;员工日志表&#x27;</span>;</span><br></pre></td></tr></table></figure><p>2). 引入资料中提供的实体类：EmpLog</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Data</span></span><br><span class="line"><span class="variable">@NoArgsConstructor</span></span><br><span class="line"><span class="variable">@AllArgsConstructor</span></span><br><span class="line">public class EmpLog &#123;</span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">Integer</span> <span class="selector-tag">id</span>; <span class="comment">//ID</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">LocalDateTime</span> <span class="selector-tag">operateTime</span>; <span class="comment">//操作时间</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">String</span> <span class="selector-tag">info</span>; <span class="comment">//详细信息</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3). 引入资料中提供的Mapper接口：EmpLogMapper</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EmpLogMapper</span> &#123;</span><br><span class="line">        <span class="comment">//插入日志</span></span><br><span class="line">    <span class="meta">@Insert(&quot;insert into emp_log (operate_time, info) values (#&#123;operateTime&#125;, #&#123;info&#125;)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insert</span><span class="params">(EmpLog empLog)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4). 引入资料中提供的业务接口：EmpLogService</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="symbol">EmpLogService</span> &#123;</span><br><span class="line">        <span class="comment">//记录新增员工日志</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> insertLog(EmpLog empLog);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>5). 引入资料中提供的业务实现类：EmpLogServiceImpl</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Service</span></span><br><span class="line">public class EmpLogServiceImpl implements EmpLogService &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">@Autowired</span></span><br><span class="line">    private EmpLogMapper empLogMapper;</span><br><span class="line"></span><br><span class="line">    <span class="variable">@Transactional</span></span><br><span class="line">    <span class="variable">@Override</span></span><br><span class="line">    public void <span class="built_in">insertLog</span>(EmpLog empLog) &#123;</span><br><span class="line">        <span class="selector-tag">empLogMapper</span><span class="selector-class">.insert</span>(empLog);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>代码实现:</strong></p><p>业务实现类：EmpServiceImpl</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> EmpMapper empMapper;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> EmpExprMapper empExprMapper;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> EmpLogService empLogService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = &#123;Exception.class&#125;)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(Emp emp)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//1.补全基础属性</span></span><br><span class="line">        emp.setCreateTime(LocalDateTime.now());</span><br><span class="line">        emp.setUpdateTime(LocalDateTime.now());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.保存员工基本信息</span></span><br><span class="line">        empMapper.insert(emp);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 保存员工的工作经历信息 - 批量</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">empId</span> <span class="operator">=</span> emp.getId();</span><br><span class="line">        List&lt;EmpExpr&gt; exprList = emp.getExprList();</span><br><span class="line">        <span class="keyword">if</span>(!CollectionUtils.isEmpty(exprList))&#123;</span><br><span class="line">            exprList.forEach(empExpr -&gt; empExpr.setEmpId(empId));</span><br><span class="line">            empExprMapper.insertBatch(exprList);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//记录操作日志</span></span><br><span class="line">        <span class="type">EmpLog</span> <span class="variable">empLog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EmpLog</span>(<span class="literal">null</span>, LocalDateTime.now(), emp.toString());</span><br><span class="line">        empLogService.insertLog(empLog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>测试:</strong></p><p>重新启动SpringBoot服务，测试新增员工操作 。我们可以看到控制台中输出的日志：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-390-1024x424.png" alt="img"></p><p>从日志中我们可以看到：</p><ul><li>执行了插入员工数据的操作</li><li>执行了插入日志操作</li><li>程序发生Exception异常</li><li>执行事务回滚（保存员工数据、插入操作日志 因为在一个事务范围内，两个操作都会被回滚）</li></ul><p>然后在 <code>emp_log</code> 表中没有记录日志数据 。</p><p><strong>原因分析:</strong></p><p>接下来我们就需要来分析一下具体是什么原因导致的日志没有成功的记录。</p><ul><li>在执行 <code>save</code> 方法时开启了一个事务</li><li>当执行 <code>empLogService.insertLog</code> 操作时，<code>insertLog</code>设置的事务传播行是默认值REQUIRED，表示有事务就加入，没有则新建事务</li><li>此时：<code>save</code> 和 <code>insertLog</code> 操作使用了同一个事务，同一个事务中的多个操作，要么同时成功，要么同时失败，所以当异常发生时进行事务回滚，就会回滚 <code>save</code> 和 <code>insertLog</code> 操作</li></ul><p><strong>解决方案：</strong></p><p>在<code>EmpLogServiceImpl</code>类中insertLog方法上，添加 <code>@Transactional(propagation = Propagation.REQUIRES_NEW)</code></p><p>Propagation.REQUIRES_NEW ：不论是否有事务，都创建新事务 ，运行在一个独立的事务中。</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Service</span></span><br><span class="line">public class EmpLogServiceImpl implements EmpLogService &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">@Autowired</span></span><br><span class="line">    private EmpLogMapper empLogMapper;</span><br><span class="line"></span><br><span class="line">    <span class="variable">@Transactional</span>(propagation = Propagation.REQUIRES_NEW)</span><br><span class="line">    <span class="variable">@Override</span></span><br><span class="line">    public void <span class="built_in">insertLog</span>(EmpLog empLog) &#123;</span><br><span class="line">        <span class="selector-tag">empLogMapper</span><span class="selector-class">.insert</span>(empLog);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重启SpringBoot服务，再次测试 新增员工的操作 ，会看到具体的日志如下：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-391-1024x651.png" alt="img"></p><p>那此时，<code>EmpServiceImpl</code> 中的 <code>save</code> 方法运行时，会开启一个事务。 当调用 <code>empLogService.insertLog(empLog)</code> 时，也会创建一个新的事务，那此时，当 <code>insertLog</code> 方法运行完毕之后，事务就已经提交了。 即使外部的事务出现异常，内部已经提交的事务，也不会回滚了，因为是两个独立的事务。</p><p>到此事务传播行为已演示完成，事务的传播行为我们只需要掌握两个：REQUIRED、REQUIRES_NEW。</p><ul><li>**REQUIRED：**大部分情况下都是用该传播行为即可。</li><li>**REQUIRES_NEW：**当我们不希望事务之间相互影响时，可以使用该传播行为。比如：下订单前需要记录日志，不论订单保存成功与否，都需要保证日志记录能够记录成功。</li></ul><h4 id="3-4-4事务四大特性">3.4.4事务四大特性</h4><p>事务有哪些特性？</p><ul><li>原子性（Atomicity）：事务是不可分割的最小单元，要么全部成功，要么全部失败。</li><li>一致性（Consistency）：事务完成时，必须使所有的数据都保持一致状态。</li><li>隔离性（Isolation）：数据库系统提供的隔离机制，保证事务在不受外部并发操作影响的独立环境下运行。</li><li>持久性（Durability）：事务一旦提交或回滚，它对数据库中的数据的改变就是永久的。</li></ul><p>事务的四大特性简称为：ACID</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-392-1024x311.png" alt="img"></p><p><strong>持久性（Durability）</strong>：一个事务一旦被提交或回滚，它对数据库的改变将是永久性的，哪怕数据库发生异常，重启之后数据亦然存在。</p><p><strong>原子性（Atomicity）</strong> ：原子性是指事务包装的一组sql是一个不可分割的工作单元，事务中的操作要么全部成功，要么全部失败。</p><p><strong>一致性（Consistency）</strong>：一个事务完成之后数据都必须处于一致性状态。</p><p>如果事务成功的完成，那么数据库的所有变化将生效。</p><p>如果事务执行出现错误，那么数据库的所有变化将会被回滚(撤销)，返回到原始状态。</p><p><strong>隔离性（Isolation）</strong>：多个用户并发的访问数据库时，一个用户的事务不能被其他用户的事务干扰，多个并发的事务之间要相互隔离。</p><p>一个事务的成功或者失败对于其他的事务是没有影响。</p><h2 id="4-文件上传">4.文件上传</h2><h3 id="4-1简介">4.1简介</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-394-1024x502.png" alt="img"></p><p>文件上传，是指将本地图片、视频、音频等文件上传到服务器，供其他用户浏览或下载的过程。</p><p>文件上传在项目中应用非常广泛，我们经常发微博、发微信朋友圈都用到了文件上传功能。</p><p>上传文件的原始form表单，要求表单必须具备以下三点（上传文件页面三要素）：</p><ul><li>表单必须有file域，用于选择要上传的文件</li><li>表单提交方式必须为POST：通常上传的文件会比较大，所以需要使用 POST 提交方式</li><li>表单的编码类型enctype必须要设置为：multipart/form-data：普通默认的编码格式是不适合传输大型的二进制数据的，所以在文件上传时，表单的编码格式必须设置为multipart/form-data</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.<span class="keyword">File</span>;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@RestController</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> UploadController &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**     * 上传文件 - 参数名file     */</span>@PostMapping(<span class="string">&quot;/upload&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> Result upload(String username, Integer age , MultipartFile <span class="keyword">file</span>) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;上传文件：&#123;&#125;, &#123;&#125;, &#123;&#125;&quot;</span>, username, age, <span class="keyword">file</span>);</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">file</span>.isEmpty())&#123;</span><br><span class="line">            <span class="keyword">file</span>.transferTo(<span class="keyword">new</span> <span class="keyword">File</span>(<span class="string">&quot;D:\\images\\&quot;</span> + <span class="keyword">file</span>.getOriginalFilename()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在定义的方法中接收提交过来的数据 （方法中的形参名和请求参数的名字保持一致）</p><ul><li>用户名：<code>String name</code></li><li>年龄： <code>Integer age</code></li><li>文件： <code>MultipartFile file</code></li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-395-1024x510.png" alt="img"></p><p>Spring中提供了一个API：MultipartFile，使用这个API就可以来接收到上传的文件</p><p><strong>问题1：如果表单项的名字和方法中形参名不一致，该怎么办？</strong></p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">upload</span><span class="params">(<span class="type">String</span> username, </span></span></span><br><span class="line"><span class="params"><span class="function">                        Integer age,  </span></span></span><br><span class="line"><span class="params"><span class="function">                        MultipartFile image)</span> <span class="comment">//image形参名和请求参数名file不一致</span></span></span><br></pre></td></tr></table></figure><p><strong>解决：使用@RequestParam注解进行参数绑定</strong></p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">Result</span> <span class="selector-tag">upload</span>(String username,</span><br><span class="line">                     Integer age, </span><br><span class="line">                     <span class="variable">@RequestParam</span>(<span class="string">&quot;file&quot;</span>) MultipartFile image)</span><br></pre></td></tr></table></figure><h3 id="4-2本地存储">4.2本地存储</h3><p>上面我们已经完成了文件上传最基本的功能实现，已经可以在服务端接收到上传的文件，并将文件保存在本地服务器的磁盘目录中了。 但是我们测试的时候发现，如果上传的文件名相同，后面上传的会覆盖前面上传的文件，那接下来，我们就要来优化这一块的功能。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.pojo.Result;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">UPLOAD_DIR</span> <span class="operator">=</span> <span class="string">&quot;D:/images/&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 上传文件 - 参数名file</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">upload</span><span class="params">(String username, Integer age,MultipartFile file)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;上传文件：&#123;&#125;, &#123;&#125;, &#123;&#125;&quot;</span>, username, age, file);</span><br><span class="line">        <span class="keyword">if</span> (!file.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// 生成唯一文件名</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">originalFilename</span> <span class="operator">=</span> file.getOriginalFilename();</span><br><span class="line">            <span class="type">String</span> <span class="variable">extName</span> <span class="operator">=</span> originalFilename.substring(originalFilename.lastIndexOf(<span class="string">&quot;.&quot;</span>));<span class="comment">//获取后缀名</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">uniqueFileName</span> <span class="operator">=</span> UUID.randomUUID().toString().replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>) + extName;</span><br><span class="line">            <span class="comment">// 拼接完整的文件路径</span></span><br><span class="line">            <span class="type">File</span> <span class="variable">targetFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(UPLOAD_DIR + uniqueFileName);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果目标目录不存在，则创建它</span></span><br><span class="line">            <span class="keyword">if</span> (!targetFile.getParentFile().exists()) &#123;</span><br><span class="line">                targetFile.getParentFile().mkdirs();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 保存文件</span></span><br><span class="line">            file.transferTo(targetFile);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>MultipartFile 常见方法：</strong></p><ul><li><code>String getOriginalFilename();</code> //获取原始文件名</li><li><code>void transferTo(File dest);</code> //将接收的文件转存到磁盘文件中</li><li><code>long getSize();</code> //获取文件的大小，单位：字节</li><li><code>byte[] getBytes();</code> //获取文件内容的字节数组</li><li><code>InputStream getInputStream();</code> //获取接收到的文件内容的输入流</li></ul><p>利用 <code>Apifox</code> 测试，注意：请求参数名和controller方法形参名保持一致。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-396-1024x582.png" alt="img"></p><p>通过 <code>Apifox</code> 测试，我们发现文件上传是没有问题的。</p><p>在解决了文件名唯一性的问题后，我们再次上传一个较大的文件(超出1M)时发现，后端程序报错：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-397-1024x183.png" alt="img"></p><p>报错原因呢，是因为：在SpringBoot中，文件上传时默认单个文件最大大小为1M</p><p>那么如果需要上传大文件，可以在 <code>application.properties</code> 进行如下配置：</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">spring</span>：</span><br><span class="line">  servlet:</span><br><span class="line">    multipart:</span><br><span class="line">      <span class="keyword">max</span>-<span class="keyword">file</span>-<span class="keyword">size</span>: <span class="number">10</span>MB</span><br><span class="line">      <span class="keyword">max</span>-request-<span class="keyword">size</span>: <span class="number">100</span>MB</span><br></pre></td></tr></table></figure><p>但如果直接存储在服务器的磁盘目录中，存在以下缺点：</p><ul><li>不安全：磁盘如果损坏，所有的文件就会丢失</li><li>容量有限：如果存储大量的图片，磁盘空间有限(磁盘不可能无限制扩容)</li><li>无法直接访问</li></ul><h3 id="3-3阿里云OSS（对象存储）">3.3阿里云OSS（对象存储）</h3><h4 id="3-3-1介绍">3.3.1介绍</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-346-1024x135.png" alt="img"></p><p>**Bucket：**存储空间是用户用于存储对象（Object，就是文件）的容器，所有的对象都必须隶属于某个存储空间。</p><p>借助AI帮我生成了一个工具类如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.ClientException;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.OSS;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.OSSClientBuilder;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.OSSException;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.common.auth.CredentialsProviderFactory;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.common.auth.EnvironmentVariableCredentialsProvider;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.model.OSSObject;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.model.ObjectListing;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.model.OSSObjectSummary;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.model.PutObjectRequest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OssJavaSdkQuickStart</span> &#123;</span><br><span class="line">    <span class="comment">/** 生成一个唯一的 Bucket 名称 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">generateUniqueBucketName</span><span class="params">(String prefix)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取当前时间戳</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">timestamp</span> <span class="operator">=</span> String.valueOf(System.currentTimeMillis());</span><br><span class="line">        <span class="comment">// 生成一个 0 到 9999 之间的随机数</span></span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="type">int</span> <span class="variable">randomNum</span> <span class="operator">=</span> random.nextInt(<span class="number">10000</span>); <span class="comment">// 生成一个 0 到 9999 之间的随机数</span></span><br><span class="line">        <span class="comment">// 连接以形成一个唯一的 Bucket 名称</span></span><br><span class="line">        <span class="keyword">return</span> prefix + <span class="string">&quot;-&quot;</span> + timestamp + <span class="string">&quot;-&quot;</span> + randomNum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> com.aliyuncs.exceptions.ClientException &#123;</span><br><span class="line">        <span class="comment">// 设置 OSS Endpoint 和 Bucket 名称</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">endpoint</span> <span class="operator">=</span> <span class="string">&quot;https://oss-cn-beijing.aliyuncs.com&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">bucketName</span> <span class="operator">=</span> <span class="string">&quot;java-geqian&quot;</span>;</span><br><span class="line">        <span class="comment">// 替换为您的 Bucket 区域</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">region</span> <span class="operator">=</span> <span class="string">&quot;cn-beijing&quot;</span>;</span><br><span class="line">        <span class="comment">// 本地文件路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">localFilePath</span> <span class="operator">=</span> <span class="string">&quot;D:/编程/001.png&quot;</span>;</span><br><span class="line">        <span class="comment">// 文件上传后的路径和名称</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">objectName</span> <span class="operator">=</span> <span class="string">&quot;exampledir/001.png&quot;</span>;</span><br><span class="line">        <span class="comment">// 创建 OSSClient 实例</span></span><br><span class="line">        <span class="type">EnvironmentVariableCredentialsProvider</span> <span class="variable">credentialsProvider</span> <span class="operator">=</span></span><br><span class="line">                CredentialsProviderFactory.newEnvironmentVariableCredentialsProvider();</span><br><span class="line">        <span class="type">OSS</span> <span class="variable">ossClient</span> <span class="operator">=</span> OSSClientBuilder.create()</span><br><span class="line">                .endpoint(endpoint)</span><br><span class="line">                .credentialsProvider(credentialsProvider)</span><br><span class="line">                .region(region)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 创建存储空间（Bucket）</span></span><br><span class="line">            ossClient.createBucket(bucketName);</span><br><span class="line">            System.out.println(<span class="string">&quot;1. Bucket &quot;</span> + bucketName + <span class="string">&quot; 创建成功。&quot;</span>);</span><br><span class="line">            <span class="comment">// 2. 上传文件</span></span><br><span class="line">            <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(localFilePath);</span><br><span class="line">            <span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">                <span class="type">PutObjectRequest</span> <span class="variable">putObjectRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PutObjectRequest</span>(bucketName, objectName, file);</span><br><span class="line">                ossClient.putObject(putObjectRequest);</span><br><span class="line">                System.out.println(<span class="string">&quot;2. 文件 &quot;</span> + objectName + <span class="string">&quot; 上传成功。&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;文件 &quot;</span> + localFilePath + <span class="string">&quot; 不存在！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 3. 下载文件</span></span><br><span class="line">            <span class="type">OSSObject</span> <span class="variable">ossObject</span> <span class="operator">=</span> ossClient.getObject(bucketName, objectName);</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">contentStream</span> <span class="operator">=</span> ossObject.getObjectContent();</span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(contentStream));</span><br><span class="line">            String line;</span><br><span class="line">            System.out.println(<span class="string">&quot;3. 下载的文件内容：&quot;</span>);</span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                System.out.println(line);</span><br><span class="line">            &#125;</span><br><span class="line">            contentStream.close();</span><br><span class="line">            <span class="comment">// 4. 列出文件</span></span><br><span class="line">            System.out.println(<span class="string">&quot;4. 列出 Bucket 中的文件：&quot;</span>);</span><br><span class="line">            <span class="type">ObjectListing</span> <span class="variable">objectListing</span> <span class="operator">=</span> ossClient.listObjects(bucketName);</span><br><span class="line">            <span class="keyword">for</span> (OSSObjectSummary objectSummary : objectListing.getObjectSummaries()) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot; - &quot;</span> + objectSummary.getKey() + <span class="string">&quot; (大小 = &quot;</span> + objectSummary.getSize() + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 5. 删除文件</span></span><br><span class="line"><span class="comment">//            ossClient.deleteObject(bucketName, objectName);</span></span><br><span class="line"><span class="comment">//            System.out.println(&quot;5. 文件 &quot; + objectName + &quot; 删除成功。&quot;);</span></span><br><span class="line">            <span class="comment">// 6. 删除存储空间（Bucket）</span></span><br><span class="line"><span class="comment">//            ossClient.deleteBucket(bucketName);</span></span><br><span class="line"><span class="comment">//            System.out.println(&quot;6. Bucket &quot; + bucketName + &quot; 删除成功。&quot;);</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (OSSException oe) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Caught an OSSException, which means your request made it to OSS, &quot;</span></span><br><span class="line">                    + <span class="string">&quot;but was rejected with an error response for some reason.&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Error Message:&quot;</span> + oe.getErrorMessage());</span><br><span class="line">            System.out.println(<span class="string">&quot;Error Code:&quot;</span> + oe.getErrorCode());</span><br><span class="line">            System.out.println(<span class="string">&quot;Request ID:&quot;</span> + oe.getRequestId());</span><br><span class="line">            System.out.println(<span class="string">&quot;Host ID:&quot;</span> + oe.getHostId());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClientException | IOException ce) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Caught an ClientException, which means the client encountered &quot;</span></span><br><span class="line">                    + <span class="string">&quot;a serious internal problem while trying to communicate with OSS, &quot;</span></span><br><span class="line">                    + <span class="string">&quot;such as not being able to access the network.&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Error Message:&quot;</span> + ce.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ossClient != <span class="literal">null</span>) &#123;</span><br><span class="line">                ossClient.shutdown();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-3-2集成OSS">3.3.2集成OSS</h4><p>阿里云oss对象存储服务的准备工作以及入门程序我们都已经完成了，接下来我们就需要在案例当中集成oss对象存储服务，来存储和管理案例中上传的图片。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-398-1024x289.png" alt="img"></p><blockquote><p>在新增员工的时候，上传员工的图像，而之所以需要上传员工的图像，是因为将来我们需要在系统页面当中访问并展示员工的图像。而要想完成这个操作，需要做两件事：</p><ol><li>需要上传员工的图像，并把图像保存起来（存储到阿里云OSS）</li><li>访问员工图像（通过图像在阿里云OSS的存储地址访问图像）<ol><li>OSS中的每一个文件都会分配一个访问的url，通过这个url就可以访问到存储在阿里云上的图片。所以需要把url返回给前端，这样前端就可以通过url获取到图像。</li></ol></li></ol></blockquote><p>我们参照接口文档来开发文件上传功能：</p><p><strong>基本信息</strong></p><ul><li>请求路径：/upload 请求方式：POST 接口描述：上传图片接口</li></ul><p><strong>请求参数</strong></p><ul><li>参数格式：multipart/form-data</li><li>参数说明：</li></ul><table><thead><tr><th>参数名称</th><th>参数类型</th><th>是否必须</th><th>示例</th><th>备注</th></tr></thead><tbody><tr><td>image</td><td>file</td><td>是</td><td></td><td></td></tr></tbody></table><h4 id="3-3-3具体实现">3.3.3具体实现</h4><p><strong>1). 引入阿里云OSS上传文件工具类（由官方的示例代码改造而来）</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.*;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.common.auth.CredentialsProviderFactory;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.common.auth.EnvironmentVariableCredentialsProvider;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.common.comm.SignVersion;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDate;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AliyunOSSOperator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">endpoint</span> <span class="operator">=</span> <span class="string">&quot;https://oss-cn-beijing.aliyuncs.com&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">bucketName</span> <span class="operator">=</span> <span class="string">&quot;java-ai&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">region</span> <span class="operator">=</span> <span class="string">&quot;cn-beijing&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">upload</span><span class="params">(<span class="type">byte</span>[] content, String originalFilename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 从环境变量中获取访问凭证。运行本代码示例之前，请确保已设置环境变量OSS_ACCESS_KEY_ID和OSS_ACCESS_KEY_SECRET。</span></span><br><span class="line">        <span class="type">EnvironmentVariableCredentialsProvider</span> <span class="variable">credentialsProvider</span> <span class="operator">=</span> CredentialsProviderFactory.newEnvironmentVariableCredentialsProvider();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 填写Object完整路径，例如202406/1.png。Object完整路径中不能包含Bucket名称。</span></span><br><span class="line">        <span class="comment">//获取当前系统日期的字符串,格式为 yyyy/MM</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">dir</span> <span class="operator">=</span> LocalDate.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy/MM&quot;</span>));</span><br><span class="line">        <span class="comment">//生成一个新的不重复的文件名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">newFileName</span> <span class="operator">=</span> UUID.randomUUID() + originalFilename.substring(originalFilename.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">objectName</span> <span class="operator">=</span> dir + <span class="string">&quot;/&quot;</span> + newFileName;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建OSSClient实例。</span></span><br><span class="line">        <span class="type">ClientBuilderConfiguration</span> <span class="variable">clientBuilderConfiguration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientBuilderConfiguration</span>();</span><br><span class="line">        clientBuilderConfiguration.setSignatureVersion(SignVersion.V4);</span><br><span class="line">        <span class="type">OSS</span> <span class="variable">ossClient</span> <span class="operator">=</span> OSSClientBuilder.create()</span><br><span class="line">                .endpoint(endpoint)</span><br><span class="line">                .credentialsProvider(credentialsProvider)</span><br><span class="line">                .clientConfiguration(clientBuilderConfiguration)</span><br><span class="line">                .region(region)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ossClient.putObject(bucketName, objectName, <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(content));</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            ossClient.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> endpoint.split(<span class="string">&quot;//&quot;</span>)[<span class="number">0</span>] + <span class="string">&quot;//&quot;</span> + bucketName + <span class="string">&quot;.&quot;</span> + endpoint.split(<span class="string">&quot;//&quot;</span>)[<span class="number">1</span>] + <span class="string">&quot;/&quot;</span> + objectName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2). 修改UploadController代码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.pojo.Result;</span><br><span class="line"><span class="keyword">import</span> com.itheima.utils.AliyunOSSOperator;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AliyunOSSOperator aliyunOSSOperator;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/upload&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">upload</span><span class="params">(MultipartFile file)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        log.info(<span class="string">&quot;上传文件：&#123;&#125;&quot;</span>, file);</span><br><span class="line">        <span class="keyword">if</span> (!file.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// 生成唯一文件名</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">originalFilename</span> <span class="operator">=</span> file.getOriginalFilename();</span><br><span class="line">            <span class="type">String</span> <span class="variable">extName</span> <span class="operator">=</span> originalFilename.substring(originalFilename.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">            <span class="type">String</span> <span class="variable">uniqueFileName</span> <span class="operator">=</span> UUID.randomUUID().toString().replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>) + extName;</span><br><span class="line">            <span class="comment">// 上传文件</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> aliyunOSSOperator.upload(file.getBytes(), uniqueFileName);</span><br><span class="line">            <span class="keyword">return</span> Result.success(url);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Result.error(<span class="string">&quot;上传失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用 Apifox 测试：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-400-1024x516.png" alt="img"></p><p>接口测试通过之后，我们就可以进行前后端联调了。</p><h4 id="3-3-4功能优化">3.3.4功能优化</h4><p>在刚才我们制作的AliyunOSS操作的工具类中，我们直接将 endpoint、bucketName参数直接在java文件中写死了。如下所示：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-404.png" alt="img"></p><p>如果后续，项目要部署到测试环境、上生产环境，我们需要来修改这两个参数。 而如果开发一个大型项目，所有用到的技术涉及到的这些个参数全部写死在java代码中，是非常不便于维护和管理的。</p><p>那么对于这些容易变动的参数，我们可以<strong>将其配置在配置文件中</strong>，然后通过 <code>@Value</code> 注解来注解外部配置的属性。如下所示：</p><p>方式一：@Value注入（缺点：如果配置项多，注入繁琐，不便于维护管理和复用。）</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-403-1024x478.png" alt="img"></p><p>方式二：自动注入  在Spring中给我们提供了一种简化方式，可以直接将配置文件中配置项的值自动的注入到对象的属性中。</p><p>Spring提供的简化方式套路：</p><p>1). 需要创建一个实现类，且实体类中的属性名和配置文件当中key的名字必须要一致</p><p>比如：配置文件当中叫endpoint，实体类当中的属性也得叫endpoint，另外实体类当中的属性还需要提供 getter / setter方法</p><p>2). 需要将实体类交给Spring的IOC容器管理，成为IOC容器当中的bean对象</p><p>3). 在实体类上添加<code>**@ConfigurationProperties**</code>注解，并通过perfect属性来指定配置参数项的前缀</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-402-1024x218.png" alt="img"></p><p><strong>具体实现步骤:</strong></p><p>1). 定义实体类AliyunOSSProperties ，并交给IOC容器管理</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">&quot;aliyun.oss&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="title class_"><span class="keyword">class</span> <span class="title">AliyunOSSProperties</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> endpoint;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> bucketName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> region;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2). 修改AliyunOSSOperator</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.*;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.common.auth.CredentialsProviderFactory;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.common.auth.EnvironmentVariableCredentialsProvider;</span><br><span class="line"><span class="keyword">import</span> com.aliyun.oss.common.comm.SignVersion;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDate;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AliyunOSSOperator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//方式一: 通过@Value注解一个属性一个属性的注入</span></span><br><span class="line">    <span class="comment">//@Value(&quot;$&#123;aliyun.oss.endpoint&#125;&quot;)</span></span><br><span class="line">    <span class="comment">//private String endpoint;</span></span><br><span class="line">    <span class="comment">//@Value(&quot;$&#123;aliyun.oss.bucketName&#125;&quot;)</span></span><br><span class="line">    <span class="comment">//private String bucketName;</span></span><br><span class="line">    <span class="comment">//@Value(&quot;$&#123;aliyun.oss.region&#125;&quot;)</span></span><br><span class="line">    <span class="comment">//private String region;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span>    <span class="keyword">private</span> AliyunOSSProperties aliyunOSSProperties;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">upload</span><span class="params">(<span class="type">byte</span>[] content, String originalFilename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">endpoint</span> <span class="operator">=</span> aliyunOSSProperties.getEndpoint();       </span><br><span class="line">        <span class="type">String</span> <span class="variable">bucketName</span> <span class="operator">=</span> aliyunOSSProperties.getBucketName();     </span><br><span class="line">        <span class="type">String</span> <span class="variable">region</span> <span class="operator">=</span> aliyunOSSProperties.getRegion();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从环境变量中获取访问凭证。运行本代码示例之前，请确保已设置环境变量OSS_ACCESS_KEY_ID和OSS_ACCESS_KEY_SECRET。</span></span><br><span class="line">        <span class="type">EnvironmentVariableCredentialsProvider</span> <span class="variable">credentialsProvider</span> <span class="operator">=</span> CredentialsProviderFactory.newEnvironmentVariableCredentialsProvider();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 填写Object完整路径，例如2024/06/1.png。Object完整路径中不能包含Bucket名称。</span></span><br><span class="line">        <span class="comment">//获取当前系统日期的字符串,格式为 yyyy/MM</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">dir</span> <span class="operator">=</span> LocalDate.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy/MM&quot;</span>));</span><br><span class="line">        <span class="comment">//生成一个新的不重复的文件名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">newFileName</span> <span class="operator">=</span> UUID.randomUUID() + originalFilename.substring(originalFilename.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">objectName</span> <span class="operator">=</span> dir + <span class="string">&quot;/&quot;</span> + newFileName;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建OSSClient实例。</span></span><br><span class="line">        <span class="type">ClientBuilderConfiguration</span> <span class="variable">clientBuilderConfiguration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientBuilderConfiguration</span>();</span><br><span class="line">        clientBuilderConfiguration.setSignatureVersion(SignVersion.V4);</span><br><span class="line">        <span class="type">OSS</span> <span class="variable">ossClient</span> <span class="operator">=</span> OSSClientBuilder.create()</span><br><span class="line">                .endpoint(endpoint)</span><br><span class="line">                .credentialsProvider(credentialsProvider)</span><br><span class="line">                .clientConfiguration(clientBuilderConfiguration)</span><br><span class="line">                .region(region)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ossClient.putObject(bucketName, objectName, <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(content));</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            ossClient.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> endpoint.split(<span class="string">&quot;//&quot;</span>)[<span class="number">0</span>] + <span class="string">&quot;//&quot;</span> + bucketName + <span class="string">&quot;.&quot;</span> + endpoint.split(<span class="string">&quot;//&quot;</span>)[<span class="number">1</span>] + <span class="string">&quot;/&quot;</span> + objectName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-3-5-ConfigurationProperties详解">3.3.5@ConfigurationProperties详解</h4><p><code>@ConfigurationProperties</code>是 Spring Boot 框架中用于将配置文件（如<code>application.yml</code>或<code>application.properties</code>）中的属性批量绑定到Java对象的注解。</p><p>1.解耦配置与代码</p><ul><li>敏感信息隔离：将数据库密码、API 密钥等从代码中剥离，存储于配置文件。</li><li>环境差异化：通过 application-dev.yml、application-prod.yml 实现多环境配置切换。</li></ul><p>2.提升可维护性</p><ul><li>集中管理：所有相关配置属性聚合在一个类中，便于查找和修改。</li><li>IDE 支持：字段自动补全、类型检查和配置提示（如 IntelliJ IDEA 的 “Spring Boot” 插件）。</li></ul><p>3.验证与约束<br>结合 @Validated 和 JSR-303 注解（如 @NotBlank、@Min），实现配置合法性校验。</p><p>与其他注解的对比</p><table><thead><tr><th>注解</th><th>特点</th><th>适用场景</th></tr></thead><tbody><tr><td><code>@Value</code></td><td>直接注入单个属性值，适合简单场景</td><td>少量分散配置</td></tr><tr><td><code>@ConfigurationProperties</code></td><td>批量绑定属性到对象，支持复杂结构和类型安全</td><td>结构化、模块化配置</td></tr><tr><td><code>@PropertySource</code></td><td>指定自定义配置文件路径</td><td>非默认配置文件加载</td></tr></tbody></table><h2 id="5-删除员工">5.删除员工</h2><h3 id="5-1需求">5.1需求</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-348-1024x291.png" alt="img"></p><p>当我们勾选列表前面的复选框，然后点击 “批量删除” 按钮，就可以将这一批次的员工信息删除掉了。也可以只勾选一个复选框，仅删除一个员工信息。</p><p>问题：我们需要开发两个功能接口吗？一个删除单个员工，一个删除多个员工</p><p>答案：不需要。 只需要开发一个功能接口即可（删除多个员工包含只删除一个员工）</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-349-1024x544.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-350-1024x526.png" alt="img"></p><h3 id="5-2实现思路">5.2实现思路</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-351-1024x258.png" alt="img"></p><h3 id="5-3功能开发">5.3功能开发</h3><h4 id="5-3-1Controller接收参数">5.3.1Controller接收参数</h4><p>在 <code>EmpController</code> 中增加如下方法 <code>delete</code> ，来执行批量删除员工的操作。</p><p><strong>方式一：在Controller方法中通过数组来接收</strong></p><p>多个参数，默认可以将其封装到一个数组中，需要保证前端传递的参数名 与 方法形参名称保持一致。</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 批量删除员工</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">@DeleteMapping</span><br><span class="line"><span class="built_in">public</span> Result <span class="keyword">delete</span>(<span class="type">Integer</span>[] ids)&#123;</span><br><span class="line">    <span class="keyword">log</span>.<span class="keyword">info</span>(&quot;批量删除部门: ids=&#123;&#125; &quot;, Arrays.asList(ids));</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>方式二：在Controller方法中通过集合来接收</strong></p><p>也可以将其封装到一个List<Integer> 集合中，如果要将其封装到一个集合中，需要在集合前面加上 <code>@RequestParam</code> 注解。</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 批量删除员工</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="variable">@DeleteMapping</span></span><br><span class="line">public Result <span class="built_in">delete</span>(<span class="variable">@RequestParam</span> List&lt;Integer&gt; ids)&#123;</span><br><span class="line">    <span class="selector-tag">log</span><span class="selector-class">.info</span>(<span class="string">&quot;批量删除部门: ids=&#123;&#125; &quot;</span>, ids);</span><br><span class="line">    <span class="selector-tag">empService</span><span class="selector-class">.deleteByIds</span>(ids);</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">Result</span><span class="selector-class">.success</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>两种方式，选择其中一种就可以，我们一般推荐选择集合，因为基于集合操作其中的元素会更加方便。</p><h4 id="5-3-2Service">5.3.2Service</h4><p>1). 在接口中 <code>EmpService</code> 中定义接口方法 <code>deleteByIds</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 批量删除员工</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">deleteByIds</span><span class="params">(List&lt;Integer&gt; ids)</span></span>;</span><br></pre></td></tr></table></figure><p>2). 在实现类 <code>EmpServiceImpl</code> 中实现接口方法 <code>deleteByIds</code></p><p>在删除员工信息时，既需要删除 emp 表中的员工基本信息，还需要删除 emp_expr 表中员工的工作经历信息</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Transactional</span></span><br><span class="line"><span class="variable">@Override</span></span><br><span class="line">public void <span class="built_in">deleteByIds</span>(List&lt;Integer&gt; ids) &#123;</span><br><span class="line">    <span class="comment">//1. 根据ID批量删除员工基本信息</span></span><br><span class="line">    <span class="selector-tag">empMapper</span><span class="selector-class">.deleteByIds</span>(ids);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 根据员工的ID批量删除员工的工作经历信息</span></span><br><span class="line">    <span class="selector-tag">empExprMapper</span><span class="selector-class">.deleteByEmpIds</span>(ids);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于删除员工信息，既要删除员工基本信息，又要删除工作经历信息，操作多次数据库的删除，所以需要进行事务控制。</p><h4 id="5-3-3Mapper">5.3.3Mapper</h4><p>1). 在 <code>EmpMapper</code> 接口中增加 <code>deleteByIds</code> 方法实现批量删除员工基本信息</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 批量删除员工信息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">deleteByIds</span><span class="params">(List&lt;Integer&gt; ids)</span></span>;</span><br></pre></td></tr></table></figure><p>2). 在 <code>EmpMapper.xml</code> 配置文件中, 配置对应的SQL语句</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!--批量删除员工信息--&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteByIds&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    delete from emp where id in</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;ids&quot;</span> <span class="attr">item</span>=<span class="string">&quot;id&quot;</span> <span class="attr">open</span>=<span class="string">&quot;(&quot;</span> <span class="attr">close</span>=<span class="string">&quot;)&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            #</span><span class="template-variable">&#123;id&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>3). 在 <code>EmpExprMapper</code> 接口中增加 <code>deleteByEmpIds</code> 方法实现根据员工ID批量删除员工的工作经历信息</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 根据员工的ID批量删除工作经历信息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">deleteByEmpIds</span><span class="params">(List&lt;Integer&gt; empIds)</span></span>;</span><br></pre></td></tr></table></figure><p>4). 在 <code>EmpExprMapper.xml</code> 配置文件中, 配置对应的SQL语句</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!--根据员工的ID批量删除工作经历信息--&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteByEmpIds&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    delete from emp_expr where emp_id in</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;empIds&quot;</span> <span class="attr">item</span>=<span class="string">&quot;empId&quot;</span> <span class="attr">open</span>=<span class="string">&quot;(&quot;</span> <span class="attr">close</span>=<span class="string">&quot;)&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            #</span><span class="template-variable">&#123;empId&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h2 id="6-修改员工">6.修改员工</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-352-1024x587.png" alt="img"></p><p>在进行修改员工信息的时候，我们首先先要根据员工的ID查询员工的详细信息用于页面回显展示，然后用户修改员工数据之后，点击保存按钮，就可以将修改的数据提交到服务端，保存到数据库。 具体操作为：</p><ol><li>根据ID查询员工信息</li><li>保存修改的员工信息</li></ol><h3 id="6-1查询回显">6.1查询回显</h3><h4 id="6-1-1需求">6.1.1需求</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-353-1024x542.png" alt="img"></p><p><strong>2.4.3 响应数据</strong></p><p>参数格式：application/json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>备注</th></tr></thead><tbody><tr><td>code</td><td>number</td><td>必须</td><td>响应码, 1 成功 , 0 失败</td></tr><tr><td>msg</td><td>string</td><td>非必须</td><td>提示信息</td></tr><tr><td>data</td><td>object</td><td>必须</td><td>返回的数据</td></tr><tr><td>|- id</td><td>number</td><td>非必须</td><td>id</td></tr><tr><td>|- username</td><td>string</td><td>非必须</td><td>用户名</td></tr><tr><td>|- name</td><td>string</td><td>非必须</td><td>姓名</td></tr><tr><td>|- password</td><td>string</td><td>非必须</td><td>密码</td></tr><tr><td>|- entryDate</td><td>string</td><td>非必须</td><td>入职日期</td></tr><tr><td>|- gender</td><td>number</td><td>非必须</td><td>性别 , 1 男 ; 2 女</td></tr><tr><td>|- image</td><td>string</td><td>非必须</td><td>图像</td></tr><tr><td>|- job</td><td>number</td><td>非必须</td><td>职位, 说明: 1 班主任,2 讲师, 3 学工主管, 4 教研主管, 5 咨询师</td></tr><tr><td>|- salary</td><td>number</td><td>非必须</td><td>薪资</td></tr><tr><td>|- deptId</td><td>number</td><td>非必须</td><td>部门id</td></tr><tr><td>|- createTime</td><td>string</td><td>非必须</td><td>创建时间</td></tr><tr><td>|- updateTime</td><td>string</td><td>非必须</td><td>更新时间</td></tr><tr><td>|- exprList</td><td>object[]</td><td>非必须</td><td>工作经历列表</td></tr><tr><td>|- id</td><td>number</td><td>非必须</td><td>ID</td></tr><tr><td>|- company</td><td>string</td><td>非必须</td><td>所在公司</td></tr><tr><td>|- job</td><td>string</td><td>非必须</td><td>职位</td></tr><tr><td>|- begin</td><td>string</td><td>非必须</td><td>开始时间</td></tr><tr><td>|- end</td><td>string</td><td>非必须</td><td>结束时间</td></tr><tr><td>|- empId</td><td>number</td><td>非必须</td><td>员工ID</td></tr></tbody></table><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-356-1024x890.png" alt="img"></p><h4 id="6-1-2实现思路">6.1.2实现思路</h4><p>在查询回显时，既需要查询出员工的基本信息，又需要查询出该员工的工作经历信息。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-405.png" alt="img"></p><p>我们可以先通过一条SQL语句，查询出指定员工的基本信息，及其员工的工作经历信息。SQL如下：</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">e</span>.*,</span><br><span class="line">       ee.id ee_id,</span><br><span class="line">       ee.<span class="keyword">begin</span> ee_begin,</span><br><span class="line">       ee.<span class="keyword">end</span> ee_end,</span><br><span class="line">       ee.company ee_company,</span><br><span class="line">       ee.job ee_job</span><br><span class="line"><span class="keyword">from</span> emp <span class="built_in">e</span> <span class="keyword">left</span> <span class="keyword">join</span> emp_expr ee <span class="keyword">on</span> <span class="built_in">e</span>.id = ee.emp_id <span class="keyword">where</span> <span class="built_in">e</span>.id = <span class="number">39</span>;</span><br></pre></td></tr></table></figure><p>具体的实现思路如下：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-406-1024x254.png" alt="img"></p><h4 id="6-1-3代码实现">6.1.3代码实现</h4><p>1). <code>EmpController</code> 添加 <code>getInfo</code> 用来根据ID查询员工数据，用于页面回显</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询回显</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">getInfo</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;根据id查询员工的详细信息&quot;</span>);</span><br><span class="line">    <span class="type">Emp</span> <span class="variable">emp</span>  <span class="operator">=</span> empService.getInfo(id);</span><br><span class="line">    <span class="keyword">return</span> Result.success(emp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2). <code>EmpService</code> 接口中增加 <code>getInfo</code> 方法</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据ID查询员工的详细信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Emp <span class="built_in">getInfo</span>(Integer id);</span><br></pre></td></tr></table></figure><p>3). <code>EmpServiceImpl</code> 实现类中实现 <code>getInfo</code> 方法</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function">Emp <span class="title">getInfo</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">return</span> empMapper.<span class="title">getById</span><span class="params">(id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4). <code>EmpMapper</code> 接口中增加 <code>getById</code> 方法</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据ID查询员工详细信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Emp <span class="built_in">getById</span>(Integer id);</span><br></pre></td></tr></table></figure><p>5). <code>EmpMapper.xml</code> 配置文件中定义对应的SQL</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!--自定义结果集ResultMap--&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;empResultMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.itheima.pojo.Emp&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;username&quot;</span> <span class="attr">property</span>=<span class="string">&quot;username&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;password&quot;</span> <span class="attr">property</span>=<span class="string">&quot;password&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;name&quot;</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;gender&quot;</span> <span class="attr">property</span>=<span class="string">&quot;gender&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;phone&quot;</span> <span class="attr">property</span>=<span class="string">&quot;phone&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;job&quot;</span> <span class="attr">property</span>=<span class="string">&quot;job&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;salary&quot;</span> <span class="attr">property</span>=<span class="string">&quot;salary&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;image&quot;</span> <span class="attr">property</span>=<span class="string">&quot;image&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;entry_date&quot;</span> <span class="attr">property</span>=<span class="string">&quot;entryDate&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;dept_id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;deptId&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;create_time&quot;</span> <span class="attr">property</span>=<span class="string">&quot;createTime&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;update_time&quot;</span> <span class="attr">property</span>=<span class="string">&quot;updateTime&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!--封装exprList--&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;exprList&quot;</span> <span class="attr">ofType</span>=<span class="string">&quot;com.itheima.pojo.EmpExpr&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;ee_id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;ee_company&quot;</span> <span class="attr">property</span>=<span class="string">&quot;company&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;ee_job&quot;</span> <span class="attr">property</span>=<span class="string">&quot;job&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;ee_begin&quot;</span> <span class="attr">property</span>=<span class="string">&quot;begin&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;ee_end&quot;</span> <span class="attr">property</span>=<span class="string">&quot;end&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;ee_empid&quot;</span> <span class="attr">property</span>=<span class="string">&quot;empId&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="comment">&lt;!--根据ID查询员工的详细信息--&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getById&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;empResultMap&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    select e.*,</span></span><br><span class="line"><span class="language-xml">        ee.id ee_id,</span></span><br><span class="line"><span class="language-xml">        ee.emp_id ee_empid,</span></span><br><span class="line"><span class="language-xml">        ee.begin ee_begin,</span></span><br><span class="line"><span class="language-xml">        ee.end ee_end,</span></span><br><span class="line"><span class="language-xml">        ee.company ee_company,</span></span><br><span class="line"><span class="language-xml">        ee.job ee_job</span></span><br><span class="line"><span class="language-xml">    from emp e left join emp_expr ee on e.id = ee.emp_id</span></span><br><span class="line"><span class="language-xml">    where e.id = #</span><span class="template-variable">&#123;id&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>在这种一对多的查询中，我们要想成功的封装的结果，需要手动的基于 <code>&lt;resultMap&gt;</code> 来进行封装结果。</p><p>Mybatis中封装查询结果，什么时候用 resultType，什么时候用resultMap ？</p><ul><li>如果查询返回的字段名与实体的属性名可以直接对应上，用resultType 。</li><li>如果查询返回的字段名与实体的属性名对应不上，或实体属性比较复杂，可以通过resultMap手动封装</li></ul><h3 id="6-2修改员工">6.2修改员工</h3><h4 id="6-2-1需求">6.2.1需求</h4><p>查询回显之后，就可以在页面上修改员工的信息了。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-407-1024x501.png" alt="img"></p><ul><li>当用户修改完数据之后，点击保存按钮，就需要将数据提交到服务端，然后服务端需要将修改后的数据更新到数据库中 。</li><li>而此次更新的时候，既需要更新员工的基本信息； 又需要更新员工的工作经历信息 。</li></ul><p>基本信息</p><blockquote><p>请求路径：/emps</p><p>请求方式：PUT</p><p>接口描述：该接口用于修改员工的数据信息</p></blockquote><p>请求参数</p><p>参数格式：application/json</p><p>参数说明：</p><table><thead><tr><th>名称</th><th>类型</th><th>是否必须</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>number</td><td>必须</td><td>id</td></tr><tr><td>username</td><td>string</td><td>必须</td><td>用户名</td></tr><tr><td>name</td><td>string</td><td>必须</td><td>姓名</td></tr><tr><td>gender</td><td>number</td><td>必须</td><td>性别, 说明: 1 男, 2 女</td></tr><tr><td>image</td><td>string</td><td>非必须</td><td>图像</td></tr><tr><td>deptId</td><td>number</td><td>非必须</td><td>部门id</td></tr><tr><td>entryDate</td><td>string</td><td>非必须</td><td>入职日期</td></tr><tr><td>job</td><td>number</td><td>非必须</td><td>职位, 说明: 1 班主任,2 讲师, 3 学工主管, 4 教研主管, 5 咨询师</td></tr><tr><td>salary</td><td>number</td><td>非必须</td><td>薪资</td></tr><tr><td>exprList</td><td>object[]</td><td>非必须</td><td>工作经历列表</td></tr><tr><td>|- id</td><td>number</td><td>非必须</td><td>ID</td></tr><tr><td>|- company</td><td>string</td><td>非必须</td><td>所在公司</td></tr><tr><td>|- job</td><td>string</td><td>非必须</td><td>职位</td></tr><tr><td>|- begin</td><td>string</td><td>非必须</td><td>开始时间</td></tr><tr><td>|- end</td><td>string</td><td>非必须</td><td>结束时间</td></tr><tr><td>|- empId</td><td>number</td><td>非必须</td><td>员工ID</td></tr></tbody></table><p>请求数据样例：</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;id&quot;</span>: <span class="number">2</span>,</span><br><span class="line"><span class="string">&quot;username&quot;</span>: <span class="string">&quot;zhangwuji&quot;</span>,</span><br><span class="line"><span class="string">&quot;password&quot;</span>: <span class="string">&quot;123456&quot;</span>,</span><br><span class="line"><span class="string">&quot;name&quot;</span>: <span class="string">&quot;张无忌&quot;</span>,</span><br><span class="line"><span class="string">&quot;gender&quot;</span>: <span class="number">1</span>,</span><br><span class="line"><span class="string">&quot;image&quot;</span>: <span class="string">&quot;https://web-framework.oss-cn-hangzhou.aliyuncs.com/2022-09-02-00-27-53B.jpg&quot;</span>,</span><br><span class="line"><span class="string">&quot;job&quot;</span>: <span class="number">2</span>,</span><br><span class="line"><span class="string">&quot;salary&quot;</span>: <span class="number">8000</span>,</span><br><span class="line"><span class="string">&quot;entryDate&quot;</span>: <span class="string">&quot;2015-01-01&quot;</span>,</span><br><span class="line"><span class="string">&quot;deptId&quot;</span>: <span class="number">2</span>,</span><br><span class="line"><span class="string">&quot;createTime&quot;</span>: <span class="string">&quot;2022-09-01T23:06:30&quot;</span>,</span><br><span class="line"><span class="string">&quot;updateTime&quot;</span>: <span class="string">&quot;2022-09-02T00:29:04&quot;</span>,</span><br><span class="line"><span class="string">&quot;exprList&quot;</span>: [</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line"><span class="string">&quot;begin&quot;</span>: <span class="string">&quot;2012-07-01&quot;</span>,</span><br><span class="line"><span class="string">&quot;end&quot;</span>: <span class="string">&quot;2015-06-20&quot;</span></span><br><span class="line"><span class="string">&quot;company&quot;</span>: <span class="string">&quot;中软国际股份有限公司&quot;</span></span><br><span class="line"><span class="string">&quot;job&quot;</span>: <span class="string">&quot;java开发&quot;</span>,</span><br><span class="line"><span class="string">&quot;empId&quot;</span>: <span class="number">2</span></span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;id&quot;</span>: <span class="number">2</span>,</span><br><span class="line"><span class="string">&quot;begin&quot;</span>: <span class="string">&quot;2015-07-01&quot;</span>,</span><br><span class="line"><span class="string">&quot;end&quot;</span>: <span class="string">&quot;2019-03-03&quot;</span></span><br><span class="line"><span class="string">&quot;company&quot;</span>: <span class="string">&quot;百度科技股份有限公司&quot;</span></span><br><span class="line"><span class="string">&quot;job&quot;</span>: <span class="string">&quot;java开发&quot;</span>,</span><br><span class="line"><span class="string">&quot;empId&quot;</span>: <span class="number">2</span></span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;id&quot;</span>: <span class="number">3</span>,</span><br><span class="line"><span class="string">&quot;begin&quot;</span>: <span class="string">&quot;2019-3-15&quot;</span>,</span><br><span class="line"><span class="string">&quot;end&quot;</span>: <span class="string">&quot;2023-03-01&quot;</span></span><br><span class="line"><span class="string">&quot;company&quot;</span>: <span class="string">&quot;阿里巴巴科技股份有限公司&quot;</span></span><br><span class="line"><span class="string">&quot;job&quot;</span>: <span class="string">&quot;架构师&quot;</span>,</span><br><span class="line"><span class="string">&quot;empId&quot;</span>: <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-2-2实现思路">6.2.2实现思路</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-357-1024x269.png" alt="img"></p><h4 id="6-2-3代码实现">6.2.3代码实现</h4><p>1). <code>EmpController</code> 增加 <code>update</code> 方法接收请求参数，响应数据</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 更新员工信息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="variable">@PutMapping</span></span><br><span class="line">public Result <span class="built_in">update</span>(<span class="variable">@RequestBody</span> Emp emp)&#123;</span><br><span class="line">    <span class="selector-tag">log</span><span class="selector-class">.info</span>(<span class="string">&quot;修改员工信息, &#123;&#125;&quot;</span>, emp);</span><br><span class="line">    <span class="selector-tag">empService</span><span class="selector-class">.update</span>(emp);</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">Result</span><span class="selector-class">.success</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2). <code>EmpService</code> 接口增加 <code>update</code> 方法</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 更新员工信息</span></span><br><span class="line"><span class="comment">* @param emp</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">(Emp emp)</span></span>;</span><br></pre></td></tr></table></figure><p>3). <code>EmpServiceImpl</code>实现类实现 <code>update</code> 方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Emp emp)</span> &#123;</span><br><span class="line">    <span class="comment">//1. 根据ID更新员工基本信息</span></span><br><span class="line">    emp.setUpdateTime(LocalDateTime.now());</span><br><span class="line">    empMapper.updateById(emp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 根据员工ID删除员工的工作经历信息 【删除老的】</span></span><br><span class="line">    empExprMapper.deleteByEmpIds(Arrays.asList(emp.getId()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 新增员工的工作经历数据 【新增新的】</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">empId</span> <span class="operator">=</span> emp.getId();</span><br><span class="line">    List&lt;EmpExpr&gt; exprList = emp.getExprList();</span><br><span class="line">    <span class="keyword">if</span>(!CollectionUtils.isEmpty(exprList))&#123;</span><br><span class="line">        exprList.forEach(empExpr -&gt; empExpr.setEmpId(empId));</span><br><span class="line">        empExprMapper.insertBatch(exprList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4). <code>EmpMapper</code> 接口中增加 <code>updateById</code> 方法</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 更新员工基本信息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">updateById</span><span class="params">(Emp emp)</span></span>;</span><br></pre></td></tr></table></figure><p>5). <code>EmpMapper.xml</code> 配置文件中定义对应的SQL语句，基于动态SQL更新员工信息</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!--根据ID更新员工信息--&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateById&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    update emp</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">set</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;username != null and username != &#x27;&#x27;&quot;</span>&gt;</span>username = #</span><span class="template-variable">&#123;username&#125;</span><span class="language-xml">,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;password != null and password != &#x27;&#x27;&quot;</span>&gt;</span>password = #</span><span class="template-variable">&#123;password&#125;</span><span class="language-xml">,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;name != null and name != &#x27;&#x27;&quot;</span>&gt;</span>name = #</span><span class="template-variable">&#123;name&#125;</span><span class="language-xml">,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;gender != null&quot;</span>&gt;</span>gender = #</span><span class="template-variable">&#123;gender&#125;</span><span class="language-xml">,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;phone != null and phone != &#x27;&#x27;&quot;</span>&gt;</span>phone = #</span><span class="template-variable">&#123;phone&#125;</span><span class="language-xml">,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;job != null&quot;</span>&gt;</span>job = #</span><span class="template-variable">&#123;job&#125;</span><span class="language-xml">,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;salary != null&quot;</span>&gt;</span>salary = #</span><span class="template-variable">&#123;salary&#125;</span><span class="language-xml">,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;image != null and image != &#x27;&#x27;&quot;</span>&gt;</span>image = #</span><span class="template-variable">&#123;image&#125;</span><span class="language-xml">,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;entryDate != null&quot;</span>&gt;</span>entry_date = #</span><span class="template-variable">&#123;entryDate&#125;</span><span class="language-xml">,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;deptId != null&quot;</span>&gt;</span>dept_id = #</span><span class="template-variable">&#123;deptId&#125;</span><span class="language-xml">,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;updateTime != null&quot;</span>&gt;</span>update_time = #</span><span class="template-variable">&#123;updateTime&#125;</span><span class="language-xml">,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    where id = #</span><span class="template-variable">&#123;id&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h2 id="7-异常处理">7.异常处理</h2><h3 id="7-1介绍">7.1介绍</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-358.png" alt="img"></p><p>当我们没有做任何的异常处理时，我们三层架构处理异常的方案：</p><ul><li>Mapper接口在操作数据库的时候出错了，此时异常会往上抛(谁调用Mapper就抛给谁)，会抛给service。</li><li>service 中也存在异常了，会抛给controller。</li><li>而在controller当中，我们也没有做任何的异常处理，所以最终异常会再往上抛。最终抛给框架之后，框架就会返回一个JSON格式的数据，里面封装的就是错误的信息，但是框架返回的JSON格式的数据并不符合我们的开发规范。</li></ul><h3 id="7-2解决方案">7.2解决方案</h3><p>那么在三层构架项目中，出现了异常，该如何处理?</p><ul><li><strong>方案一：在所有Controller的所有方法中进行try…catch处理</strong></li></ul><p>缺点：代码臃肿（不推荐）</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-369.png" alt="img"></p><ul><li>**方案二：**<strong>全局异常处理器</strong></li></ul><p>好处：简单、优雅（推荐）</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-370.png" alt="img"></p><ol><li>全局异常处理器</li></ol><p>我们该怎么样定义全局异常处理器？</p><ul><li>定义全局异常处理器非常简单，就是定义一个类，在类上加上一个注解@RestControllerAdvice，加上这个注解就代表我们定义了一个全局异常处理器。</li><li>在全局异常处理器当中，需要定义一个方法来捕获异常，在这个方法上需要加上注解@ExceptionHandler。通过@ExceptionHandler注解当中的value属性来指定我们要捕获的是哪一类型的异常。</li></ul><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalExceptionHandler</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//处理异常</span></span><br><span class="line">    <span class="meta">@ExceptionHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">Result <span class="title">ex</span><span class="params">(Exception e)</span></span>&#123;<span class="comment">//方法形参中指定能够处理的异常类型</span></span><br><span class="line">        e.printStackTrace();<span class="comment">//打印堆栈中的异常信息</span></span><br><span class="line">        <span class="comment">//捕获到异常之后，响应一个标准的Result</span></span><br><span class="line">        <span class="function"><span class="keyword">return</span> Result.<span class="title">error</span><span class="params">(<span class="string">&quot;对不起,操作失败,请联系管理员&quot;</span>)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>@RestControllerAdvice = @ControllerAdvice + @ResponseBody</p><p>处理异常的方法返回值会转换为json后再响应给前端</p><p>重新启动SpringBoot服务，打开浏览器，再来测试一下 修改员工 这个操作，我们依然设置已存在的 <code>13309090027</code>这个手机号：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-373-1024x502.png" alt="img"></p><p>此时，我们可以看到，出现异常之后，异常已经被全局异常处理器捕获了。然后返回的错误信息，被前端程序正常解析，然后提示出了对应的错误提示信息。</p><p>以上就是全局异常处理器的使用，主要涉及到两个注解：</p><ul><li>@RestControllerAdvice //表示当前类为全局异常处理器</li><li>@ExceptionHandler //指定可以捕获哪种类型的异常进行处理</li></ul><h2 id="8-员工信息统计">8.员工信息统计</h2><h3 id="8-1介绍">8.1介绍</h3><p>对于这些图形报表的开发，其实呢，都是基于现成的一些图形报表的组件开发的，比如：Echarts、HighCharts等。</p><p>而报表的制作，主要是前端人员开发，引入对应的组件（比如：ECharts）即可。 服务端开发人员仅为其提供数据即可。</p><p>官网：<a href="https://echarts.apache.org/zh/index.html">https://echarts.apache.org/zh/index.html</a></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-371-1024x502.png" alt="img"></p><h3 id="8-2职位统计">8.2职位统计</h3><h4 id="8-2-1需求">8.2.1需求</h4><p>对于这类的图形报表，服务端要做的，就是为其提供数据即可。 我们可以通过官方的示例，看到提供的数据其实就是X轴展示的信息，和对应的数据。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-372-1024x464.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-359-1024x733.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-360-1024x292.png" alt="img"></p><h4 id="8-2-2代码实现">8.2.2代码实现</h4><p><strong>1). 定义****封装结果对象JobOption</strong></p><p>在 <code>com.itheima.pojo</code> 包中定义实体类 <code>JobOption</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JobOption</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> List jobList;</span><br><span class="line">    <span class="keyword">private</span> List dataList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>1). 定义ReportController，并添加方法。</strong></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RequestMapping(<span class="string">&quot;/report&quot;</span>)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReportController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ReportService reportService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 统计各个职位的员工人数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/empJobData&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Result getEmpJobData()&#123;</span><br><span class="line">        log.info(<span class="string">&quot;统计各个职位的员工人数&quot;</span>);</span><br><span class="line">        JobOption jobOption = reportService.getEmpJobData();</span><br><span class="line">        <span class="keyword">return</span> Result.success(jobOption);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2). 定义ReportService接口，并添加接口方法。</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ReportService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 统计各个职位的员工人数</span></span><br><span class="line"><span class="comment">     * @return</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">JobOption <span class="title">getEmpJobData</span>()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>3). 定义ReportServiceImpl实现类，并实现方法</strong></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReportServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ReportService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">EmpMapper</span> empMapper;</span><br><span class="line">        </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">JobOption</span> <span class="title function_">getEmpJobData</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">List</span>&lt;<span class="title class_">Map</span>&lt;<span class="title class_">String</span>,<span class="title class_">Object</span>&gt;&gt; list = empMapper.<span class="title function_">countEmpJobData</span>();</span><br><span class="line">        <span class="title class_">List</span>&lt;<span class="title class_">Object</span>&gt; jobList = list.<span class="title function_">stream</span>().<span class="title function_">map</span>(dataMap -&gt; dataMap.<span class="title function_">get</span>(<span class="string">&quot;pos&quot;</span>)).<span class="title function_">toList</span>();</span><br><span class="line">        <span class="title class_">List</span>&lt;<span class="title class_">Object</span>&gt; dataList = list.<span class="title function_">stream</span>().<span class="title function_">map</span>(dataMap -&gt; dataMap.<span class="title function_">get</span>(<span class="string">&quot;total&quot;</span>)).<span class="title function_">toList</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JobOption</span>(jobList, dataList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>4). 定义EmpMapper 接口</strong></p><p>统计的是员工的信息，所以需要操作的是员工表。 所以代码我们就写在 <code>EmpMapper</code> 接口中即可。</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 统计各个职位的员工人数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@MapKey(<span class="string">&quot;pos&quot;</span>)</span><br><span class="line">List&lt;<span class="built_in">Map</span>&lt;<span class="built_in">String</span>,<span class="built_in">Object</span>&gt;&gt; countEmpJobData();</span><br></pre></td></tr></table></figure><p>如果查询的记录往Map中封装，可以通过@MapKey注解指定返回的map中的唯一标识是那个字段。【也可以不指定】</p><p><strong>5). 定义EmpMapper.xml</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;!<span class="comment">-- 统计各个职位的员工人数 --&gt;</span></span><br><span class="line">&lt;<span class="keyword">select</span> id=&quot;countEmpJobData&quot; resultType=&quot;java.util.Map&quot;&gt;</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">    (<span class="keyword">case</span> job <span class="keyword">when</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">&#x27;班主任&#x27;</span> </span><br><span class="line">                     <span class="keyword">when</span> <span class="number">2</span> <span class="keyword">then</span> <span class="string">&#x27;讲师&#x27;</span> </span><br><span class="line">                     <span class="keyword">when</span> <span class="number">3</span> <span class="keyword">then</span> <span class="string">&#x27;学工主管&#x27;</span> </span><br><span class="line">                     <span class="keyword">when</span> <span class="number">4</span> <span class="keyword">then</span> <span class="string">&#x27;教研主管&#x27;</span> </span><br><span class="line">                     <span class="keyword">when</span> <span class="number">5</span> <span class="keyword">then</span> <span class="string">&#x27;咨询师&#x27;</span> </span><br><span class="line">                     <span class="keyword">else</span> <span class="string">&#x27;其他&#x27;</span> <span class="keyword">end</span>)  pos,</span><br><span class="line">    count(*) total</span><br><span class="line">    <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> job</span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span> total</span><br><span class="line">&lt;/<span class="keyword">select</span>&gt;</span><br></pre></td></tr></table></figure><p><strong>case流程控制函数：</strong></p><ul><li><p>语法一：case when cond1 then res1 [ when cond2 then res2 ] else res end ;</p></li><li><p>含义：如果 cond1 成立， 取 res1。 如果 cond2 成立，取 res2。 如果前面的条件都不成立，则取 res。</p></li><li><p>语法二（仅适用于等值匹配）：case expr when val1 then res1 [ when val2 then res2 ] else res end ;</p></li><li><p>含义：如果 expr 的值为 val1 ， 取 res1。 如果 expr 的值为 val2 ，取 res2。 如果前面的条件都不成立，则取 res。</p></li></ul><p>重新启动服务，打开Apifox进行测试。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-408-1024x646.png" alt="img"></p><p>联调测试</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-409-1024x501.png" alt="img"></p><h3 id="8-3性别统计">8.3性别统计</h3><h4 id="8-3-1需求">8.3.1需求</h4><p>对于这类的图形报表，服务端要做的，就是为其提供数据即可。 我们可以通过官方的示例，看到提供的数据就是一个json格式的数据。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-410.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-361-1024x714.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-362-1024x307.png" alt="img"></p><h4 id="8-3-2代码实现">8.3.2代码实现</h4><p><strong>1). 在ReportController，添加方法。</strong></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 统计员工性别信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">&quot;/empGenderData&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="title class_">Result</span> <span class="title function_">getEmpGenderData</span>(<span class="params"></span>)&#123;</span><br><span class="line">    log.<span class="title function_">info</span>(<span class="string">&quot;统计员工性别信息&quot;</span>);</span><br><span class="line">    <span class="title class_">List</span>&lt;<span class="title class_">Map</span>&gt; genderList = reportService.<span class="title function_">getEmpGenderData</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Result</span>.<span class="title function_">success</span>(genderList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2). 在ReportService接口，添加接口方法。</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 统计员工性别信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">List&lt;Map&gt; <span class="title">getEmpGenderData</span>()</span>;</span><br></pre></td></tr></table></figure><p><strong>3). 在ReportServiceImpl实现类，实现方法</strong></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">List</span>&lt;<span class="title class_">Map</span>&gt; <span class="title function_">getEmpGenderData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> empMapper.<span class="title function_">countEmpGenderData</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>4). 定义EmpMapper 接口</strong></p><p>统计的是员工的信息，所以需要操作的是员工表。 所以代码我们就写在 <code>EmpMapper</code> 接口中即可。</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 统计员工性别信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@MapKey</span>(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">List&lt;Map&gt; <span class="built_in">countEmpGenderData</span>();</span><br></pre></td></tr></table></figure><p><strong>5). 定义EmpMapper.xml</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;!<span class="comment">-- 统计员工的性别信息 --&gt;</span></span><br><span class="line">&lt;<span class="keyword">select</span> id=&quot;countEmpGenderData&quot; resultType=&quot;java.util.Map&quot;&gt;</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">    <span class="keyword">if</span>(gender = <span class="number">1</span>, <span class="string">&#x27;男&#x27;</span>, <span class="string">&#x27;女&#x27;</span>) <span class="keyword">as</span> <span class="type">name</span>,</span><br><span class="line">    count(*) <span class="keyword">as</span> <span class="keyword">value</span></span><br><span class="line">    <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> gender ;</span><br><span class="line">&lt;/<span class="keyword">select</span>&gt;</span><br></pre></td></tr></table></figure><p>if函数语法：<code>if(条件, 条件为true取值, 条件为false取值)</code></p><p>ifnull函数语法：<code>ifnull(expr, val1)</code> 如果expr不为null，取自身，否则取val1</p><p>Apifox测试</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-411.png" alt="img"></p><p>联调测试</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-412.png" alt="img"></p><h1 id="–班级管理">–班级管理</h1><p>数据准备</p><p>在数据库中，创建学生表 <code>clazz</code> , <code>student</code>，SQL如下：</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">create table clazz<span class="punctuation">(</span></span><br><span class="line">    id   int unsigned primary key auto_increment comment &#x27;ID,主键&#x27;<span class="punctuation">,</span></span><br><span class="line">    name  varchar<span class="punctuation">(</span><span class="number">30</span><span class="punctuation">)</span> not <span class="literal">null</span> unique  comment &#x27;班级名称&#x27;<span class="punctuation">,</span></span><br><span class="line">    room  varchar<span class="punctuation">(</span><span class="number">20</span><span class="punctuation">)</span> comment &#x27;班级教室&#x27;<span class="punctuation">,</span></span><br><span class="line">    begin_date date not <span class="literal">null</span> comment &#x27;开课时间&#x27;<span class="punctuation">,</span></span><br><span class="line">    end_date date not <span class="literal">null</span> comment &#x27;结课时间&#x27;<span class="punctuation">,</span></span><br><span class="line">    master_id int unsigned <span class="literal">null</span> comment &#x27;班主任ID, 关联员工表ID&#x27;<span class="punctuation">,</span></span><br><span class="line">    subject tinyint unsigned not <span class="literal">null</span> comment &#x27;学科, 1:java, 2:前端, 3:大数据, 4:Python, 5:Go, 6: 嵌入式&#x27;<span class="punctuation">,</span></span><br><span class="line">    create_time datetime  comment &#x27;创建时间&#x27;<span class="punctuation">,</span></span><br><span class="line">    update_time datetime  comment &#x27;修改时间&#x27;</span><br><span class="line"><span class="punctuation">)</span>comment &#x27;班级表&#x27;<span class="punctuation">;</span></span><br><span class="line"></span><br><span class="line">INSERT INTO clazz VALUES <span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span>&#x27;JavaEE就业163期&#x27;<span class="punctuation">,</span>&#x27;212&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-04-30</span>&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-06-29</span>&#x27;<span class="punctuation">,</span><span class="number">10</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">2024-06-01</span> 17:08:23&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-06-01</span> 17:39:58&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span>&#x27;前端就业90期&#x27;<span class="punctuation">,</span>&#x27;210&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-07-10</span>&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-01-20</span>&#x27;<span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">2024-06-01</span> 17:45:12&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-06-01</span> 17:45:12&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">3</span><span class="punctuation">,</span>&#x27;JavaEE就业165期&#x27;<span class="punctuation">,</span>&#x27;108&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-06-15</span>&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-12-25</span>&#x27;<span class="punctuation">,</span><span class="number">6</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">2024-06-01</span> 17:45:40&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-06-01</span> 17:45:40&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">4</span><span class="punctuation">,</span>&#x27;JavaEE就业166期&#x27;<span class="punctuation">,</span>&#x27;105&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-07-20</span>&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-02-20</span>&#x27;<span class="punctuation">,</span><span class="number">20</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">2024-06-01</span> 17:46:10&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-06-01</span> 17:46:10&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">5</span><span class="punctuation">,</span>&#x27;大数据就业58期&#x27;<span class="punctuation">,</span>&#x27;209&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-08-01</span>&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-02-15</span>&#x27;<span class="punctuation">,</span><span class="number">7</span><span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span>&#x27;<span class="number">2024-06-01</span> 17:51:21&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-06-01</span> 17:51:21&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">6</span><span class="punctuation">,</span>&#x27;JavaEE就业167期&#x27;<span class="punctuation">,</span>&#x27;325&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-11-20</span>&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-05-10</span>&#x27;<span class="punctuation">,</span><span class="number">36</span><span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">2024-11-15</span> 11:35:46&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-12-13</span> 14:31:24&#x27;<span class="punctuation">)</span><span class="punctuation">;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">create table student<span class="punctuation">(</span></span><br><span class="line">  id int unsigned primary key auto_increment comment &#x27;ID,主键&#x27;<span class="punctuation">,</span></span><br><span class="line">  name varchar<span class="punctuation">(</span><span class="number">10</span><span class="punctuation">)</span>  not <span class="literal">null</span> comment &#x27;姓名&#x27;<span class="punctuation">,</span></span><br><span class="line">  no char<span class="punctuation">(</span><span class="number">10</span><span class="punctuation">)</span>  not <span class="literal">null</span> unique comment &#x27;学号&#x27;<span class="punctuation">,</span></span><br><span class="line">  gender tinyint unsigned  not <span class="literal">null</span> comment &#x27;性别, 1: 男, 2: 女&#x27;<span class="punctuation">,</span></span><br><span class="line">  phone  varchar<span class="punctuation">(</span><span class="number">11</span><span class="punctuation">)</span>  not <span class="literal">null</span> unique comment &#x27;手机号&#x27;<span class="punctuation">,</span></span><br><span class="line">  id_card  char<span class="punctuation">(</span><span class="number">18</span><span class="punctuation">)</span>  not <span class="literal">null</span> unique comment &#x27;身份证号&#x27;<span class="punctuation">,</span></span><br><span class="line">  is_college tinyint unsigned  not <span class="literal">null</span> comment &#x27;是否来自于院校, 1:是, 0:否&#x27;<span class="punctuation">,</span></span><br><span class="line">  address  varchar<span class="punctuation">(</span><span class="number">100</span><span class="punctuation">)</span>  comment &#x27;联系地址&#x27;<span class="punctuation">,</span></span><br><span class="line">  degree  tinyint unsigned  comment &#x27;最高学历, 1:初中, 2:高中, 3:大专, 4:本科, 5:硕士, 6:博士&#x27;<span class="punctuation">,</span></span><br><span class="line">  graduation_date date comment &#x27;毕业时间&#x27;<span class="punctuation">,</span></span><br><span class="line">  clazz_id  int unsigned not <span class="literal">null</span> comment &#x27;班级ID, 关联班级表ID&#x27;<span class="punctuation">,</span></span><br><span class="line">  violation_count tinyint unsigned default &#x27;0&#x27; not <span class="literal">null</span> comment &#x27;违纪次数&#x27;<span class="punctuation">,</span></span><br><span class="line">  violation_score tinyint unsigned default &#x27;0&#x27; not <span class="literal">null</span> comment &#x27;违纪扣分&#x27;<span class="punctuation">,</span></span><br><span class="line">  create_time  datetime  comment &#x27;创建时间&#x27;<span class="punctuation">,</span></span><br><span class="line">  update_time  datetime  comment &#x27;修改时间&#x27;</span><br><span class="line"><span class="punctuation">)</span> comment &#x27;学员表&#x27;<span class="punctuation">;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">INSERT INTO student VALUES <span class="punctuation">(</span><span class="number">1</span><span class="punctuation">,</span>&#x27;段誉&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2022000001</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1880000000</span>1&#x27;<span class="punctuation">,</span>&#x27;<span class="number">11012000030020</span><span class="number">0001</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;北京市昌平区建材城西路1号&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">2021-07-01</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-11-15</span> 16:20:59&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span>&#x27;萧峰&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2022000002</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1880021000</span>3&#x27;<span class="punctuation">,</span>&#x27;<span class="number">11012000030020</span><span class="number">0002</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;北京市昌平区建材城西路2号&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">2022-07-01</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">3</span><span class="punctuation">,</span>&#x27;虚竹&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2022000003</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1880001300</span>1&#x27;<span class="punctuation">,</span>&#x27;<span class="number">11012000030020</span><span class="number">0003</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;北京市昌平区建材城西路3号&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">2024-07-01</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">4</span><span class="punctuation">,</span>&#x27;萧远山&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2022000004</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1880000321</span>1&#x27;<span class="punctuation">,</span>&#x27;<span class="number">11012000030020</span><span class="number">0004</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;北京市昌平区建材城西路4号&#x27;<span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span>&#x27;<span class="number">2024-07-01</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">5</span><span class="punctuation">,</span>&#x27;阿朱&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2022000005</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">1880016000</span>2&#x27;<span class="punctuation">,</span>&#x27;<span class="number">11012000030020</span><span class="number">0005</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;北京市昌平区建材城西路5号&#x27;<span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span>&#x27;<span class="number">2020-07-01</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">6</span><span class="punctuation">,</span>&#x27;阿紫&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2022000006</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">1880000003</span>4&#x27;<span class="punctuation">,</span>&#x27;<span class="number">11012000030020</span><span class="number">0006</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;北京市昌平区建材城西路6号&#x27;<span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span>&#x27;<span class="number">2021-07-01</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">7</span><span class="punctuation">,</span>&#x27;游坦之&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2022000007</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1880000006</span>7&#x27;<span class="punctuation">,</span>&#x27;<span class="number">11012000030020</span><span class="number">0007</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;北京市昌平区建材城西路7号&#x27;<span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span>&#x27;<span class="number">2022-07-01</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">8</span><span class="punctuation">,</span>&#x27;康敏&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2022000008</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">1880000007</span>7&#x27;<span class="punctuation">,</span>&#x27;<span class="number">11012000030020</span><span class="number">0008</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;北京市昌平区建材城西路8号&#x27;<span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span>&#x27;<span class="number">2024-07-01</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">9</span><span class="punctuation">,</span>&#x27;徐长老&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2022000009</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1880000034</span>1&#x27;<span class="punctuation">,</span>&#x27;<span class="number">11012000030020</span><span class="number">0009</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;北京市昌平区建材城西路9号&#x27;<span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span>&#x27;<span class="number">2024-07-01</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">10</span><span class="punctuation">,</span>&#x27;云中鹤&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2022000010</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1880000657</span>1&#x27;<span class="punctuation">,</span>&#x27;<span class="number">11012000030020</span><span class="number">0010</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;北京市昌平区建材城西路10号&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">2020-07-01</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">11</span><span class="punctuation">,</span>&#x27;钟万仇&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2022000011</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1880000039</span>1&#x27;<span class="punctuation">,</span>&#x27;<span class="number">11012000030020</span><span class="number">0011</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;北京市昌平区建材城西路11号&#x27;<span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span>&#x27;<span class="number">2021-07-01</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-11-15</span> 16:21:24&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">12</span><span class="punctuation">,</span>&#x27;崔百泉&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2022000012</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1880000078</span>1&#x27;<span class="punctuation">,</span>&#x27;<span class="number">11012000030020</span><span class="number">0018</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;北京市昌平区建材城西路12号&#x27;<span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span>&#x27;<span class="number">2022-07-05</span>&#x27;<span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">6</span><span class="punctuation">,</span><span class="number">17</span><span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-12-13</span> 14:33:58&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">13</span><span class="punctuation">,</span>&#x27;耶律洪基&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2022000013</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1880000890</span>1&#x27;<span class="punctuation">,</span>&#x27;<span class="number">11012000030020</span><span class="number">0013</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;北京市昌平区建材城西路13号&#x27;<span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span>&#x27;<span class="number">2024-07-01</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-11-15</span> 16:21:21&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">14</span><span class="punctuation">,</span>&#x27;天山童姥&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2022000014</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">1880000920</span>1&#x27;<span class="punctuation">,</span>&#x27;<span class="number">11012000030020</span><span class="number">0014</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;北京市昌平区建材城西路14号&#x27;<span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span>&#x27;<span class="number">2024-07-01</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-11-15</span> 16:21:17&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">15</span><span class="punctuation">,</span>&#x27;刘竹庄&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2022000015</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1880000940</span>1&#x27;<span class="punctuation">,</span>&#x27;<span class="number">11012000030020</span><span class="number">0015</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;北京市昌平区建材城西路15号&#x27;<span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span>&#x27;<span class="number">2020-07-01</span>&#x27;<span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">16</span><span class="punctuation">,</span>&#x27;李春来&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2022000016</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1880000850</span>1&#x27;<span class="punctuation">,</span>&#x27;<span class="number">11012000030020</span><span class="number">0016</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;北京市昌平区建材城西路16号&#x27;<span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span>&#x27;<span class="number">2021-07-01</span>&#x27;<span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">17</span><span class="punctuation">,</span>&#x27;王语嫣&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2022000017</span>&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">1880000760</span>1&#x27;<span class="punctuation">,</span>&#x27;<span class="number">11012000030020</span><span class="number">0017</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;北京市昌平区建材城西路17号&#x27;<span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span>&#x27;<span class="number">2022-07-01</span>&#x27;<span class="punctuation">,</span><span class="number">4</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-11-14</span> 21:22:19&#x27;<span class="punctuation">)</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">(</span><span class="number">18</span><span class="punctuation">,</span>&#x27;郑成功&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024001101</span>&#x27;<span class="punctuation">,</span><span class="number">1</span><span class="punctuation">,</span>&#x27;<span class="number">1330909234</span>5&#x27;<span class="punctuation">,</span>&#x27;<span class="number">11011011011011</span><span class="number">0110</span>&#x27;<span class="punctuation">,</span><span class="number">0</span><span class="punctuation">,</span>&#x27;北京市昌平区回龙观街道88号&#x27;<span class="punctuation">,</span><span class="number">5</span><span class="punctuation">,</span>&#x27;<span class="number">2021-07-01</span>&#x27;<span class="punctuation">,</span><span class="number">3</span><span class="punctuation">,</span><span class="number">2</span><span class="punctuation">,</span><span class="number">7</span><span class="punctuation">,</span>&#x27;<span class="number">2024-11-15</span> 16:26:18&#x27;<span class="punctuation">,</span>&#x27;<span class="number">2024-11-15</span> 16:40:10&#x27;<span class="punctuation">)</span><span class="punctuation">;</span></span><br></pre></td></tr></table></figure><p>表结构关系说明：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-413-1024x562.png" alt="img"></p><p>实体类Clazz：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Data</span></span><br><span class="line"><span class="variable">@NoArgsConstructor</span></span><br><span class="line"><span class="variable">@AllArgsConstructor</span></span><br><span class="line">public class Clazz &#123;</span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">Integer</span> <span class="selector-tag">id</span>; <span class="comment">//ID</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">String</span> <span class="selector-tag">name</span>; <span class="comment">//班级名称</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">String</span> <span class="selector-tag">room</span>; <span class="comment">//班级教室</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">LocalDate</span> <span class="selector-tag">beginDate</span>; <span class="comment">//开课时间</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">LocalDate</span> <span class="selector-tag">endDate</span>; <span class="comment">//结课时间</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">Integer</span> <span class="selector-tag">masterId</span>; <span class="comment">//班主任</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">Integer</span> <span class="selector-tag">subject</span>; <span class="comment">//学科</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">LocalDateTime</span> <span class="selector-tag">createTime</span>; <span class="comment">//创建时间</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">LocalDateTime</span> <span class="selector-tag">updateTime</span>; <span class="comment">//修改时间</span></span><br><span class="line"></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">String</span> <span class="selector-tag">masterName</span>; <span class="comment">//班主任姓名</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">String</span> <span class="selector-tag">status</span>; <span class="comment">//班级状态 - 未开班 , 在读 , 已结课</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实体类Student：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Data</span></span><br><span class="line"><span class="variable">@NoArgsConstructor</span></span><br><span class="line"><span class="variable">@AllArgsConstructor</span></span><br><span class="line">public class Student &#123;</span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">Integer</span> <span class="selector-tag">id</span>; <span class="comment">//ID</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">String</span> <span class="selector-tag">name</span>; <span class="comment">//姓名</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">String</span> <span class="selector-tag">no</span>; <span class="comment">//序号</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">Integer</span> <span class="selector-tag">gender</span>; <span class="comment">//性别 , 1: 男 , 2 : 女</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">String</span> <span class="selector-tag">phone</span>; <span class="comment">//手机号</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">String</span> <span class="selector-tag">idCard</span>; <span class="comment">//身份证号</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">Integer</span> <span class="selector-tag">isCollege</span>; <span class="comment">//是否来自于院校, 1: 是, 0: 否</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">String</span> <span class="selector-tag">address</span>; <span class="comment">//联系地址</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">Integer</span> <span class="selector-tag">degree</span>; <span class="comment">//最高学历, 1: 初中, 2: 高中 , 3: 大专 , 4: 本科 , 5: 硕士 , 6: 博士</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">LocalDate</span> <span class="selector-tag">graduationDate</span>; <span class="comment">//毕业时间</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">Integer</span> <span class="selector-tag">clazzId</span>; <span class="comment">//班级ID</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">Short</span> <span class="selector-tag">violationCount</span>; <span class="comment">//违纪次数</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">Short</span> <span class="selector-tag">violationScore</span>; <span class="comment">//违纪扣分</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">LocalDateTime</span> <span class="selector-tag">createTime</span>; <span class="comment">//创建时间</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">LocalDateTime</span> <span class="selector-tag">updateTime</span>; <span class="comment">//修改时间</span></span><br><span class="line"></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">String</span> <span class="selector-tag">clazzName</span>;<span class="comment">//班级名称</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-条件分页查询">1.条件分页查询</h2><h3 id="1-1需求">1.1需求</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-363-1024x474.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-364-1024x718.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-365-1024x761.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-367-759x1024.png" alt="img"></p><h3 id="1-2代码实现">1.2代码实现</h3><p>1）在 <code>ClazzController</code> 中</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">Result</span> <span class="title function_">page</span>(<span class="params"><span class="title class_">String</span> name ,</span></span><br><span class="line"><span class="params">                   <span class="meta">@DateTimeFormat</span>(pattern = <span class="string">&quot;yyyy-MM-dd&quot;</span>) <span class="title class_">LocalDate</span> begin ,</span></span><br><span class="line"><span class="params">                   <span class="meta">@DateTimeFormat</span>(pattern = <span class="string">&quot;yyyy-MM-dd&quot;</span>) <span class="title class_">LocalDate</span> end,</span></span><br><span class="line"><span class="params">                   <span class="meta">@RequestParam</span>(defaultValue = <span class="string">&quot;1&quot;</span>) <span class="title class_">Integer</span> page ,</span></span><br><span class="line"><span class="params">                   <span class="meta">@RequestParam</span>(defaultValue = <span class="string">&quot;10&quot;</span>)<span class="title class_">Integer</span> pageSize</span>)&#123;</span><br><span class="line">    <span class="title class_">PageResult</span> pageResult = clazzService.<span class="title function_">page</span>(name , begin , end , page , pageSize);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Result</span>.<span class="title function_">success</span>(pageResult);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2).<code>Clazz</code>Service &amp; <code>Clazz</code>ServiceImpl</p><p>在 <code>ClazzService</code> 中</p><figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 条件分页查询</span><br><span class="line"> * <span class="meta">@param</span> name</span><br><span class="line"> * <span class="meta">@param</span> <span class="keyword">begin</span></span><br><span class="line"> * <span class="meta">@param</span> <span class="keyword">end</span></span><br><span class="line"> * <span class="meta">@param</span> page</span><br><span class="line"> * <span class="meta">@param</span> pageSize</span><br><span class="line"> * <span class="meta">@return</span></span><br><span class="line"> */</span><br><span class="line">PageResult page(<span class="built_in">String</span> name, LocalDate <span class="keyword">begin</span>, LocalDate <span class="keyword">end</span>, <span class="built_in">Integer</span> page, <span class="built_in">Integer</span> pageSize);</span><br></pre></td></tr></table></figure><p>在<code>Clazz</code>ServiceImpl中</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="built_in">public</span> PageResult page(String <span class="type">name</span>, LocalDate <span class="keyword">begin</span>, LocalDate <span class="keyword">end</span>, <span class="type">Integer</span> page, <span class="type">Integer</span> pageSize) &#123;</span><br><span class="line">    PageHelper.startPage(page, pageSize);</span><br><span class="line"></span><br><span class="line">    List&lt;Clazz&gt; dataList = clazzMapper.list(<span class="type">name</span>,<span class="keyword">begin</span>,<span class="keyword">end</span>);</span><br><span class="line">    Page&lt;Clazz&gt; p = (Page&lt;Clazz&gt;) dataList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">new</span> PageResult(p.getTotal(), p.getResult());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3）ClazzMapper中</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 动态条件查询</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">List&lt;Clazz&gt; <span class="title">list</span><span class="params">(<span class="type">String</span> name, LocalDate begin, LocalDate end)</span></span>;</span><br></pre></td></tr></table></figure><p>ClazzMapper.xml中</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="keyword">select</span> id=&quot;list&quot; resultType=&quot;com.itheima.pojo.Clazz&quot;&gt;</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        c.*,</span><br><span class="line">        e.name masterName,</span><br><span class="line">        (<span class="keyword">case</span> <span class="keyword">when</span> begin_date &amp;gt; now() <span class="keyword">then</span> <span class="string">&#x27;未开班&#x27;</span> <span class="keyword">when</span> now() &amp;gt; end_date <span class="keyword">then</span> <span class="string">&#x27;已结课&#x27;</span> <span class="keyword">else</span>  <span class="string">&#x27;在读中&#x27;</span> <span class="keyword">end</span> ) status</span><br><span class="line">    <span class="keyword">from</span> clazz c <span class="keyword">left join</span> emp e <span class="keyword">on</span> c.master_id = e.id</span><br><span class="line">    &lt;<span class="keyword">where</span>&gt;</span><br><span class="line">        &lt;<span class="keyword">if</span> test=&quot;name != null and name != &#x27;&#x27;&quot;&gt;</span><br><span class="line">            c.name <span class="keyword">like</span> concat(<span class="string">&#x27;%&#x27;</span>,#&#123;<span class="type">name</span>&#125;,<span class="string">&#x27;%&#x27;</span>)</span><br><span class="line">        &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">        &lt;<span class="keyword">if</span> test=&quot;begin != null and end != null&quot;&gt;</span><br><span class="line">            <span class="keyword">and</span> c.end_date <span class="keyword">between</span> #&#123;<span class="keyword">begin</span>&#125; <span class="keyword">and</span> #&#123;<span class="keyword">end</span>&#125;</span><br><span class="line">        &lt;/<span class="keyword">if</span>&gt;</span><br><span class="line">    &lt;/<span class="keyword">where</span>&gt;</span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span> c.update_time <span class="keyword">desc</span></span><br><span class="line">&lt;/<span class="keyword">select</span>&gt;</span><br></pre></td></tr></table></figure><h2 id="2-查询所有员工">2.查询所有员工</h2><h3 id="2-1需求-2">2.1需求</h3><p>那其实，对于培训机构来说，班主任就是这个企业的员工。所以，班主任下拉列表中展示的就是所有的员工数据。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-368-1024x490.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-415.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-414-1024x775.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-416-1024x841.png" alt="img"></p><h3 id="2-2代码实现">2.2代码实现</h3><p>1）在Emp<code>Controller</code> 中</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询所有的员工</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">&quot;/list&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="function">Result <span class="title">list</span><span class="params">()</span></span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;查询所有的员工数据&quot;</span>);</span><br><span class="line">        List&lt;Emp&gt; empList = empService.list();</span><br><span class="line">        <span class="function"><span class="keyword">return</span> Result.<span class="title">success</span><span class="params">(empList)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2).<code>Emp</code>Service &amp;EmpServiceImpl</p><p>在 <code>EmpService</code> 中</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 查询所有的员工数据</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">List&lt;Emp&gt; <span class="title">list</span>()</span>;</span><br></pre></td></tr></table></figure><p>在 EmpServiceImpl中</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="title class_">List</span>&lt;<span class="title class_">Emp</span>&gt; <span class="title function_">list</span>(<span class="params"></span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> empMapper.<span class="title function_">findAll</span>();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>3）EmpMapper 中</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询全部员工</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@Select</span>(<span class="string">&quot;select id, username, password, name, gender, phone, job, salary, image, entry_date, dept_id, create_time, update_time from emp&quot;</span>)</span><br><span class="line">List&lt;Emp&gt; <span class="built_in">findAll</span>();</span><br></pre></td></tr></table></figure><h2 id="3-新增班级信息">3.新增班级信息</h2><h3 id="3-1需求">3.1需求</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-417-1024x481.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-418-1024x640.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-419-1024x830.png" alt="img"></p><h3 id="3-2代码实现">3.2代码实现</h3><p>1）在 <code>ClazzController</code> 中</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 新增班级</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@PostMapping</span></span><br><span class="line">public Result <span class="built_in">save</span>(<span class="variable">@RequestBody</span> Clazz clazz)&#123;</span><br><span class="line">    <span class="selector-tag">clazzService</span><span class="selector-class">.save</span>(clazz);</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">Result</span><span class="selector-class">.success</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2).<code>Clazz</code>Service &amp; <code>Clazz</code>ServiceImpl</p><p>在 <code>ClazzService</code> 中</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加班级信息</span></span><br><span class="line"><span class="comment"> * @param clazz</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">save</span><span class="params">(Clazz clazz)</span></span>;</span><br></pre></td></tr></table></figure><p>在 <code>Clazz</code>ServiceImpl 中</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="built_in">public</span> <span class="type">void</span> save(Clazz clazz) &#123;</span><br><span class="line">    clazz.setCreateTime(LocalDateTime.now());</span><br><span class="line">    clazz.setUpdateTime(LocalDateTime.now());</span><br><span class="line">    clazzMapper.<span class="keyword">insert</span>(clazz);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3）ClazzMapper 中</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 添加班级信息</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   @Insert(<span class="string">&quot;insert into clazz VALUES (null,<span class="subst">#&#123;name&#125;</span>,<span class="subst">#&#123;room&#125;</span>,<span class="subst">#&#123;beginDate&#125;</span>,<span class="subst">#&#123;endDate&#125;</span>,<span class="subst">#&#123;masterId&#125;</span>, <span class="subst">#&#123;subject&#125;</span>,<span class="subst">#&#123;createTime&#125;</span>,<span class="subst">#&#123;updateTime&#125;</span>)&quot;</span>)</span><br><span class="line">   <span class="literal">void</span> insert(Clazz clazz);</span><br></pre></td></tr></table></figure><h2 id="4-根据ID查询班级">4.<strong>根据ID查询班级</strong></h2><h3 id="4-1需求">4.1需求</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-420-1024x488.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-421-1024x524.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-422-1024x644.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-423-1024x427.png" alt="img"></p><h3 id="4-2代码实现">4.2代码实现</h3><p>1）在 <code>ClazzController</code> 中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据ID查询班级详情</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">getInfo</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span>&#123;</span><br><span class="line">    <span class="type">Clazz</span> <span class="variable">clazz</span> <span class="operator">=</span> clazzService.getInfo(id);</span><br><span class="line">    <span class="keyword">return</span> Result.success(clazz);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2).<code>Clazz</code>Service &amp; <code>Clazz</code>ServiceImpl</p><p>在 <code>ClazzService</code> 中</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 根据ID查询班级详情</span><br><span class="line"> * @param <span class="built_in">id</span></span><br><span class="line"> * @<span class="literal">return</span></span><br><span class="line"> */</span><br><span class="line">Clazz getInfo(Integer <span class="built_in">id</span>);</span><br></pre></td></tr></table></figure><p>在 <code>Clazz</code>ServiceImpl 中</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function">Clazz <span class="title">getInfo</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">return</span> clazzMapper.<span class="title">getInfo</span><span class="params">(id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3）ClazzMapper 中</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据ID查询班级详情</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@Select</span>(<span class="string">&quot;select * from clazz where  id = #&#123;id&#125;&quot;</span>)</span><br><span class="line">Clazz <span class="built_in">getInfo</span>(Integer id);</span><br></pre></td></tr></table></figure><h2 id="5-修改班级信息">5.<strong>修改班级信息</strong></h2><h3 id="5-1需求-2">5.1需求</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-424-1024x491.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-425-1024x647.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-426-1024x838.png" alt="img"></p><h3 id="5-2代码实现">5.2代码实现</h3><p>1）在 <code>ClazzController</code> 中</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更新班级信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@PutMapping</span></span><br><span class="line">public Result <span class="built_in">update</span>(<span class="variable">@RequestBody</span> Clazz clazz)&#123;</span><br><span class="line">    <span class="selector-tag">clazzService</span><span class="selector-class">.update</span>(clazz);</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">Result</span><span class="selector-class">.success</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2).<code>Clazz</code>Service &amp; <code>Clazz</code>ServiceImpl</p><p>在 <code>ClazzService</code> 中</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 修改班级信息</span></span><br><span class="line"><span class="comment"> * @param clazz</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">(Clazz clazz)</span></span>;</span><br></pre></td></tr></table></figure><p>在 <code>Clazz</code>ServiceImpl 中</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="built_in">public</span> <span class="type">void</span> <span class="keyword">update</span>(Clazz clazz) &#123;</span><br><span class="line">    clazz.setUpdateTime(LocalDateTime.now());</span><br><span class="line">    clazzMapper.<span class="keyword">update</span>(clazz);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3）ClazzMapper 中</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 动态更新班级信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">(Clazz clazz)</span></span>;</span><br></pre></td></tr></table></figure><p>ClazzMapper.xml 中</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!--动态更新班级信息--&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;update&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       update clazz</span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">set</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;name != null and name != &#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               name = #</span><span class="template-variable">&#123;name&#125;</span><span class="language-xml">,</span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;room != null and room != &#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               room = #</span><span class="template-variable">&#123;room&#125;</span><span class="language-xml">,</span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;beginDate != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               begin_date = #</span><span class="template-variable">&#123;beginDate&#125;</span><span class="language-xml">,</span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;endDate != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               end_date = #</span><span class="template-variable">&#123;endDate&#125;</span><span class="language-xml">,</span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;masterId != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               master_id = #</span><span class="template-variable">&#123;masterId&#125;</span><span class="language-xml">,</span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;subject != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               subject = #</span><span class="template-variable">&#123;subject&#125;</span><span class="language-xml">,</span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;updateTime != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               update_time = #</span><span class="template-variable">&#123;updateTime&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       where id = #</span><span class="template-variable">&#123;id&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h2 id="6-删除班级信息">6.删除班级信息</h2><h3 id="6-1需求">6.1需求</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-427-1024x491.png" alt="img"></p><p><strong>注意：在页面原型中，要求如果该班级下关联的有学生，是不允许删除的，并提示错误信息：“对不起, 该班级下有学生, 不能直接删除”。 (提示：可以通过自定义异常 + 全局异常处理器实现)</strong></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-437-1024x490.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-428-1024x549.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-429-1024x520.png" alt="img"></p><h3 id="6-2代码实现">6.2代码实现</h3><p>1）在 <code>ClazzController</code> 中</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据ID删除班级</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@DeleteMapping</span>(<span class="string">&quot;/&#123;id&#125;&quot;</span>)</span><br><span class="line">public Result <span class="built_in">delete</span>(<span class="variable">@PathVariable</span> Integer id)&#123;</span><br><span class="line">    <span class="selector-tag">clazzService</span><span class="selector-class">.deleteById</span>(id);</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">Result</span><span class="selector-class">.success</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2).<code>Clazz</code>Service &amp; <code>Clazz</code>ServiceImpl</p><p>在 <code>ClazzService</code> 中</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 删除班级</span></span><br><span class="line"><span class="comment">    * @param id</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="type">void</span> <span class="title">deleteById</span><span class="params">(Integer id)</span></span>;</span><br></pre></td></tr></table></figure><p>在 <code>Clazz</code>ServiceImpl 中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteById</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">      <span class="comment">//1. 查询班级下是否有学员</span></span><br><span class="line">      <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> studentMapper.countByClazzId(id);</span><br><span class="line">      <span class="keyword">if</span>(count &gt; <span class="number">0</span>)&#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;班级下有学员, 不能直接删除~&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//2. 如果没有, 再删除班级信息</span></span><br><span class="line">      clazzMapper.deleteById(id);</span><br></pre></td></tr></table></figure><p>3）ClazzMapper 中</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据ID删除班级</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@Delete</span>(<span class="string">&quot;delete from clazz where id = #&#123;id&#125;&quot;</span>)</span><br><span class="line">void <span class="built_in">deleteById</span>(Integer id);</span><br></pre></td></tr></table></figure><h1 id="–学员管理">–学员管理</h1><h2 id="1-查询所有班级">1.查询所有班级</h2><h3 id="1-1需求-2">1.1需求</h3><p>在新增学员的时候，要展示出所有的班级信息。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-430-1024x493.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-431-1024x850.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-432-1024x692.png" alt="img"></p><h3 id="1-2代码实现-2">1.2代码实现</h3><p>1）在 <code>ClazzController</code> 中</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 查询全部班级</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@GetMapping</span>(<span class="string">&quot;/list&quot;</span>)</span><br><span class="line">  <span class="keyword">public</span> <span class="function">Result <span class="title">findAll</span><span class="params">()</span></span>&#123;</span><br><span class="line">      List&lt;Clazz&gt; clazzList = clazzService.findAll();</span><br><span class="line">      <span class="function"><span class="keyword">return</span> Result.<span class="title">success</span><span class="params">(clazzList)</span></span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>2).<code>Clazz</code>Service &amp; <code>Clazz</code>ServiceImpl</p><p>在 <code>ClazzService</code> 中</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 查询全部班级</span></span><br><span class="line"><span class="comment">    * @return</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">List&lt;Clazz&gt; <span class="title">findAll</span>()</span>;</span><br></pre></td></tr></table></figure><p>在 <code>Clazz</code>ServiceImpl 中</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> <span class="title class_">List</span>&lt;<span class="title class_">Clazz</span>&gt; <span class="title function_">findAll</span>(<span class="params"></span>) &#123;</span><br><span class="line">     <span class="keyword">return</span> clazzMapper.<span class="title function_">findAll</span>();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>3）ClazzMapper 中</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询全部班级</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@Select</span>(<span class="string">&quot;select * from clazz&quot;</span>)</span><br><span class="line">List&lt;Clazz&gt; <span class="built_in">findAll</span>();</span><br></pre></td></tr></table></figure><h2 id="2-条件分页查询">2.条件分页查询</h2><h3 id="2-1需求-3">2.1需求</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-433-1024x495.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-434-1024x744.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-435-1024x912.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-436-1024x854.png" alt="img"></p><h3 id="2-2代码实现-2">2.2代码实现</h3><p>1）在 Student<code>Controller</code> 中</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">Result</span> <span class="title function_">page</span>(<span class="params"><span class="title class_">String</span> name ,</span></span><br><span class="line"><span class="params">                   <span class="title class_">Integer</span> degree,</span></span><br><span class="line"><span class="params">                   <span class="title class_">Integer</span> clazzId,</span></span><br><span class="line"><span class="params">                   <span class="meta">@RequestParam</span>(defaultValue = <span class="string">&quot;1&quot;</span>) <span class="title class_">Integer</span> page ,</span></span><br><span class="line"><span class="params">                   <span class="meta">@RequestParam</span>(defaultValue = <span class="string">&quot;10&quot;</span>) <span class="title class_">Integer</span> pageSize</span>)&#123;</span><br><span class="line">    <span class="title class_">PageResult</span> pageResult = studentService.<span class="title function_">page</span>(name,degree,clazzId,page,pageSize);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Result</span>.<span class="title function_">success</span>(pageResult);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2).StudentService &amp; StudentServiceImpl</p><p>在 <code>StudentService</code> 中</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 条件分页查询</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PageResult page(<span class="built_in">String</span> name, <span class="built_in">Integer</span> degree, <span class="built_in">Integer</span> clazzId, <span class="built_in">Integer</span> page, <span class="built_in">Integer</span> pageSize);</span><br></pre></td></tr></table></figure><p>在StudentServiceImpl 中</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="built_in">public</span> PageResult page(String <span class="type">name</span>, <span class="type">Integer</span> degree, <span class="type">Integer</span> clazzId, <span class="type">Integer</span> page, <span class="type">Integer</span> pageSize) &#123;</span><br><span class="line">    PageHelper.startPage(page, pageSize);</span><br><span class="line"></span><br><span class="line">    List&lt;Student&gt; studentList = studentMapper.list(<span class="type">name</span>,degree,clazzId);</span><br><span class="line">    Page&lt;Student&gt; p = (Page&lt;Student&gt;) studentList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">new</span> PageResult(p.getTotal(), p.getResult());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3）StudentMapper 中</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 动态条件查询</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="built_in">List</span>&lt;Student&gt; <span class="built_in">list</span>(<span class="built_in">String</span> name, <span class="built_in">Integer</span> degree, <span class="built_in">Integer</span> clazzId);</span><br></pre></td></tr></table></figure><p>StudentMapper.xml 中</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!-- 动态条件查询 --&gt;</span></span></span><br><span class="line"><span class="language-xml"> <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;list&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.itheima.pojo.Student&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">     select s.*, c.name clazzName from student s left join clazz c on s.clazz_id = c.id</span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;<span class="name">where</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;name != null and name != &#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">             s.name like concat(&#x27;%&#x27;,#</span><span class="template-variable">&#123;name&#125;</span><span class="language-xml">,&#x27;%&#x27;)</span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;degree != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">             and s.degree = #</span><span class="template-variable">&#123;degree&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;clazzId != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">             and s.clazz_id = #</span><span class="template-variable">&#123;clazzId&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">     <span class="tag">&lt;/<span class="name">where</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">     order by s.update_time desc</span></span><br><span class="line"><span class="language-xml"> <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h2 id="3-新增学生信息">3.新增学生信息</h2><h3 id="3-1需求-2">3.1需求</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-439-1024x496.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-440-1024x787.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-441-1024x873.png" alt="img"></p><h3 id="3-2代码实现-2">3.2代码实现</h3><p>1）在 Student<code>Controller</code> 中</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 添加学生</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="variable">@PostMapping</span></span><br><span class="line"> public Result <span class="built_in">save</span>(<span class="variable">@RequestBody</span> Student student)&#123;</span><br><span class="line">     <span class="selector-tag">studentService</span><span class="selector-class">.save</span>(student);</span><br><span class="line">     <span class="selector-tag">return</span> <span class="selector-tag">Result</span><span class="selector-class">.success</span>();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>2).StudentService &amp; StudentServiceImpl</p><p>在 <code>StudentService</code> 中</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加学生信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">save</span><span class="params">(Student student)</span></span>;</span><br></pre></td></tr></table></figure><p>在 StudentServiceImpl 中</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="built_in">public</span> <span class="type">void</span> save(Student student) &#123;</span><br><span class="line">    student.setCreateTime(LocalDateTime.now());</span><br><span class="line">    student.setUpdateTime(LocalDateTime.now());</span><br><span class="line">    studentMapper.<span class="keyword">insert</span>(student);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3）StudentMapper 中</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加学生</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Insert(<span class="string">&quot;insert into student(name, no, gender, phone,id_card, is_college, address, degree, graduation_date,clazz_id, create_time, update_time) VALUES &quot;</span> +</span><br><span class="line">        <span class="string">&quot;(<span class="subst">#&#123;name&#125;</span>,<span class="subst">#&#123;<span class="literal">no</span>&#125;</span>,<span class="subst">#&#123;gender&#125;</span>,<span class="subst">#&#123;phone&#125;</span>,<span class="subst">#&#123;idCard&#125;</span>,<span class="subst">#&#123;isCollege&#125;</span>,<span class="subst">#&#123;address&#125;</span>,<span class="subst">#&#123;degree&#125;</span>,<span class="subst">#&#123;graduationDate&#125;</span>,<span class="subst">#&#123;clazzId&#125;</span>,<span class="subst">#&#123;createTime&#125;</span>,<span class="subst">#&#123;updateTime&#125;</span>)&quot;</span>)</span><br><span class="line"><span class="literal">void</span> insert(Student student);</span><br></pre></td></tr></table></figure><h2 id="4-根据ID查询学生">4.根据ID查询学生</h2><h3 id="4-1需求-2">4.1需求</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-442-1024x496.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-443-1024x522.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-444-1024x884.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-445-1024x575.png" alt="img"></p><h3 id="4-2代码实现-2">4.2代码实现</h3><p>1）在 StudentController 中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据ID查询学生信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">getInfo</span><span class="params">(<span class="meta">@PathVariable</span> Integer id)</span>&#123;</span><br><span class="line">    <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> studentService.getInfo(id);</span><br><span class="line">    <span class="keyword">return</span> Result.success(student);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2).StudentService &amp; StudentServiceImpl</p><p>在 StudentService 中</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据ID查询学生信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Student <span class="built_in">getInfo</span>(Integer id);</span><br></pre></td></tr></table></figure><p>在 StudentServiceImpl 中</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function">Student <span class="title">getInfo</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">      <span class="function"><span class="keyword">return</span> studentMapper.<span class="title">getById</span><span class="params">(id)</span></span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>3）StudentMapper 中</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据ID查询学生信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@Select</span>(<span class="string">&quot;select * from student where id = #&#123;id&#125;&quot;</span>)</span><br><span class="line">Student <span class="built_in">getById</span>(Integer id);</span><br></pre></td></tr></table></figure><h2 id="5-修改学生信息">5.修改学生信息</h2><h3 id="5-1需求-3">5.1需求</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-446-1024x491.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-447-1024x886.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-448-1024x448.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-449-1024x527.png" alt="img"></p><h3 id="5-2代码实现-2">5.2代码实现</h3><p>1）在 StudentController 中</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 修改学生信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@PutMapping</span></span><br><span class="line">public Result <span class="built_in">update</span>(<span class="variable">@RequestBody</span> Student student)&#123;</span><br><span class="line">    <span class="selector-tag">studentService</span><span class="selector-class">.update</span>(student);</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">Result</span><span class="selector-class">.success</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2).StudentService &amp; StudentServiceImpl</p><p>在 StudentService 中</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 修改学生信息</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">(Student student)</span></span>;</span><br></pre></td></tr></table></figure><p>在 StudentServiceImpl 中</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"> <span class="built_in">public</span> <span class="type">void</span> <span class="keyword">update</span>(Student student) &#123;</span><br><span class="line">     student.setUpdateTime(LocalDateTime.now());</span><br><span class="line">     studentMapper.<span class="keyword">update</span>(student);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>3）StudentMapper 中</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 修改学生信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">update</span><span class="params">(Student student)</span></span>;</span><br></pre></td></tr></table></figure><p>StudentMapper.xml 中</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!-- 修改学生信息 --&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;update&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       update student</span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">set</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;name != null and name != &#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               name = #</span><span class="template-variable">&#123;name&#125;</span><span class="language-xml">,</span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;no != null and no != &#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               no = #</span><span class="template-variable">&#123;no&#125;</span><span class="language-xml">,</span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;gender != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               gender = #</span><span class="template-variable">&#123;gender&#125;</span><span class="language-xml">,</span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;phone != null and phone != &#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               phone = #</span><span class="template-variable">&#123;phone&#125;</span><span class="language-xml">,</span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;idCard != null and idCard != &#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               id_card = #</span><span class="template-variable">&#123;idCard&#125;</span><span class="language-xml">,</span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;isCollege != null and isCollege != &#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               is_college = #</span><span class="template-variable">&#123;isCollege&#125;</span><span class="language-xml">,</span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;address != null and address != &#x27;&#x27;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               address = #</span><span class="template-variable">&#123;address&#125;</span><span class="language-xml">,</span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;graduationDate != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               graduation_date = #</span><span class="template-variable">&#123;graduationDate&#125;</span><span class="language-xml">,</span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;degree != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               degree = #</span><span class="template-variable">&#123;degree&#125;</span><span class="language-xml">,</span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;violationCount != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               violation_count = #</span><span class="template-variable">&#123;violationCount&#125;</span><span class="language-xml">,</span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;violationScore != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               violation_score = #</span><span class="template-variable">&#123;violationScore&#125;</span><span class="language-xml">,</span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;clazzId != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               clazz_id = #</span><span class="template-variable">&#123;clazzId&#125;</span><span class="language-xml">,</span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;updateTime != null&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">               update_time = #</span><span class="template-variable">&#123;updateTime&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       where id = #</span><span class="template-variable">&#123;id&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h2 id="6-删除学生信息">6.删除学生信息</h2><h3 id="6-1需求-2">6.1需求</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-450-1024x494.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-451-1024x546.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-452-1024x506.png" alt="img"></p><h3 id="6-2代码实现-2">6.2代码实现</h3><p>1）在 StudentController 中</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除学生信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@DeleteMapping</span>(<span class="string">&quot;/&#123;ids&#125;&quot;</span>)</span><br><span class="line">public Result <span class="built_in">delete</span>(<span class="variable">@PathVariable</span> List&lt;Integer&gt; ids)&#123;</span><br><span class="line">    <span class="selector-tag">studentService</span><span class="selector-class">.delete</span>(ids);</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">Result</span><span class="selector-class">.success</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2).StudentService &amp; StudentServiceImpl</p><p>在 StudentService 中</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除学生信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">void</span> <span class="keyword">delete</span>(List&lt;<span class="type">Integer</span>&gt; ids);</span><br></pre></td></tr></table></figure><p>在 StudentServiceImpl 中</p><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="keyword">delete</span>(List&lt;Integer&gt; ids) &#123;</span><br><span class="line">    studentMapper.<span class="keyword">delete</span>(ids);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3）StudentMapper 中</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 批量删除学生信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="keyword">delete</span>(List&lt;<span class="type">Integer</span>&gt; ids);</span><br></pre></td></tr></table></figure><p>StudentMapper.xml 中</p><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="comment">&lt;!--批量删除学生信息--&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;delete&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">       delete from student where id in</span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;ids&quot;</span> <span class="attr">item</span>=<span class="string">&quot;id&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span> <span class="attr">open</span>=<span class="string">&quot;(&quot;</span> <span class="attr">close</span>=<span class="string">&quot;)&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           #</span><span class="template-variable">&#123;id&#125;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">       <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h2 id="7-违纪处理">7.<strong>违纪处理</strong></h2><h3 id="7-1需求">7.1需求</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-453-1024x495.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-454-1024x499.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-455-1024x502.png" alt="img"></p><h3 id="7-2代码实现">7.2代码实现</h3><p>1）在 StudentController 中</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 违纪处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@PutMapping</span>(<span class="string">&quot;/violation/&#123;id&#125;/&#123;score&#125;&quot;</span>)</span><br><span class="line">public Result <span class="built_in">violationHandle</span>(<span class="variable">@PathVariable</span> Integer id , <span class="variable">@PathVariable</span> Integer score)&#123;</span><br><span class="line">    <span class="selector-tag">studentService</span><span class="selector-class">.violationHandle</span>(id, score);</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">Result</span><span class="selector-class">.success</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2).StudentService &amp; StudentServiceImpl</p><p>在 StudentService 中</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 违纪处理</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="literal">void</span> violationHandle(<span class="built_in">Integer</span> id, <span class="built_in">Integer</span> score);</span><br></pre></td></tr></table></figure><p>在 StudentServiceImpl 中</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">violationHandle</span>(<span class="params"><span class="title class_">Integer</span> id, <span class="title class_">Integer</span> score</span>) &#123;</span><br><span class="line">    studentMapper.<span class="title function_">updateViolation</span>(id, score);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3）StudentMapper 中</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 违纪处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Update(<span class="string">&quot;update student set violation_count = violation_count + 1 , violation_score = violation_score + <span class="subst">#&#123;score&#125;</span> , update_time = now() where id = <span class="subst">#&#123;id&#125;</span>&quot;</span>)</span><br><span class="line"><span class="literal">void</span> updateViolation(Integer id, Integer score);</span><br></pre></td></tr></table></figure><h2 id="8-学员信息统计">8.学员信息统计</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-457-1024x482.png" alt="img"></p><h3 id="8-1班级人数统计接口开发">8.1班级人数统计接口开发</h3><h4 id="8-1-1需求">8.1.1需求</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-458-1024x739.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-459-1024x291.png" alt="img"></p><h4 id="8-1-2代码实现">8.1.2代码实现</h4><p>1）在 ReportController 中</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 班级人数统计</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">&quot;/studentCountData&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="function">Result <span class="title">getStudentCountData</span><span class="params">()</span></span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;班级人数统计&quot;</span>);</span><br><span class="line">    ClazzCountOption clazzCountOption = reportService.getStudentCountData();</span><br><span class="line">    <span class="function"><span class="keyword">return</span> Result.<span class="title">success</span><span class="params">(clazzCountOption)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2). ReportService &amp; ReportServiceImpl</p><p>在 ReportService 中</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 统计班级人数</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function">ClazzCountOption <span class="title">getStudentCountData</span>()</span>;</span><br></pre></td></tr></table></figure><p>在  ReportServiceImpl 中</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    public ClazzCountOption getStudentCountData() &#123;</span><br><span class="line">        List&lt;<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt;&gt; countList = studentMapper.getStudentCount();</span><br><span class="line">        <span class="keyword">if</span>(!CollectionUtils.isEmpty(countList))&#123;</span><br><span class="line">            List&lt;<span class="built_in">Object</span>&gt; clazzList = countList.stream().<span class="keyword">map</span>(<span class="keyword">map</span> -&gt; &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">map</span>.get(<span class="string">&quot;cname&quot;</span>);</span><br><span class="line">            &#125;).toList();</span><br><span class="line"></span><br><span class="line">            List&lt;<span class="built_in">Object</span>&gt; dataList = countList.stream().<span class="keyword">map</span>(<span class="keyword">map</span> -&gt; &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">map</span>.get(<span class="string">&quot;scount&quot;</span>);</span><br><span class="line">            &#125;).toList();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ClazzCountOption(clazzList, dataList);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>在StudentMapper中</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 统计班级人数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@Select(<span class="string">&quot;select c.name cname , count(s.id) scount from clazz c  left join student s on s.clazz_id = c.id group by c.name order by count(s.id) desc &quot;</span>)</span><br><span class="line">List&lt;<span class="built_in">Map</span>&lt;<span class="built_in">String</span>,<span class="built_in">Object</span>&gt;&gt; getStudentCount();</span><br></pre></td></tr></table></figure><h3 id="8-2学员学历信息统计接口开发">8.2学员学历信息统计接口开发</h3><h4 id="8-2-1需求-2">8.2.1需求</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-460-1024x768.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-461-1024x735.png" alt="img"></p><h4 id="8-2-2代码实现-2">8.2.2代码实现</h4><p>1）在 ReportController 中</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 统计学员的学历信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">&quot;/studentDegreeData&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="title class_">Result</span> <span class="title function_">getStudentDegreeData</span>(<span class="params"></span>)&#123;</span><br><span class="line">    log.<span class="title function_">info</span>(<span class="string">&quot;统计学员的学历信息&quot;</span>);</span><br><span class="line">    <span class="title class_">List</span>&lt;<span class="title class_">Map</span>&gt; dataList = reportService.<span class="title function_">getStudentDegreeData</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Result</span>.<span class="title function_">success</span>(dataList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2). ReportService &amp; ReportServiceImpl</p><p>在 ReportService 中</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 统计学历人数</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function">List&lt;Map&gt; <span class="title">getStudentDegreeData</span>()</span>;</span><br></pre></td></tr></table></figure><p>在  ReportServiceImpl 中</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="title class_">List</span>&lt;<span class="title class_">Map</span>&gt; <span class="title function_">getStudentDegreeData</span>(<span class="params"></span>) &#123;</span><br><span class="line">       <span class="keyword">return</span> studentMapper.<span class="title function_">countStudentDegreeData</span>();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>3）StudentMapper 中</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 统计学员学历</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="variable">@MapKey</span>(<span class="string">&quot;name&quot;</span>)</span><br><span class="line"> List&lt;Map&gt; <span class="built_in">countStudentDegreeData</span>();</span><br></pre></td></tr></table></figure><p>StudentMapper.xml 中</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;!<span class="comment">--学员学历统计--&gt;</span></span><br><span class="line">&lt;<span class="keyword">select</span> id=&quot;countStudentDegreeData&quot; resultType=&quot;java.util.Map&quot;&gt;</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        (<span class="keyword">case</span> degree</span><br><span class="line">            <span class="keyword">when</span> <span class="number">1</span> <span class="keyword">then</span> <span class="string">&#x27;初中&#x27;</span></span><br><span class="line">            <span class="keyword">when</span> <span class="number">2</span> <span class="keyword">then</span> <span class="string">&#x27;高中&#x27;</span></span><br><span class="line">            <span class="keyword">when</span> <span class="number">3</span> <span class="keyword">then</span> <span class="string">&#x27;大专&#x27;</span></span><br><span class="line">            <span class="keyword">when</span> <span class="number">4</span> <span class="keyword">then</span> <span class="string">&#x27;本科&#x27;</span></span><br><span class="line">            <span class="keyword">when</span> <span class="number">5</span> <span class="keyword">then</span> <span class="string">&#x27;硕士&#x27;</span></span><br><span class="line">            <span class="keyword">when</span> <span class="number">6</span> <span class="keyword">then</span> <span class="string">&#x27;博士&#x27;</span></span><br><span class="line">            <span class="keyword">else</span> <span class="string">&#x27;其他&#x27;</span> <span class="keyword">end</span>)  <span class="type">name</span>,</span><br><span class="line">        count(*) <span class="keyword">value</span></span><br><span class="line">    <span class="keyword">from</span> student <span class="keyword">group</span> <span class="keyword">by</span> degree</span><br><span class="line">    <span class="keyword">order</span> <span class="keyword">by</span> degree</span><br><span class="line">&lt;/<span class="keyword">select</span>&gt;</span><br></pre></td></tr></table></figure><h2 id="9-删除部门完善">9.<strong>删除部门完善</strong></h2><h3 id="9-1需求">9.1需求</h3><p>如果部门下有员工，则不允许删除该部门，并给前端提示错误信息：对不起，当前部门下有员工，不能直接删除！</p><h3 id="9-2代码实现">9.2代码实现</h3><p>1）在 DeptController 中</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 删除部门 - 省略@RequestParam (前端传递的请求参数名与服务端方法形参名一致) [推荐]</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> @DeleteMapping</span><br><span class="line"> <span class="built_in">public</span> Result <span class="keyword">delete</span>(<span class="type">Integer</span> id)&#123;</span><br><span class="line">     //<span class="keyword">System</span>.<span class="keyword">out</span>.println(&quot;根据ID删除部门: &quot; + id);</span><br><span class="line">     <span class="keyword">log</span>.<span class="keyword">info</span>(&quot;根据ID删除部门: &#123;&#125;&quot;, id);</span><br><span class="line">     deptService.deleteById(id);</span><br><span class="line">     <span class="keyword">return</span> Result.success();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>2). DeptService &amp; DeptServiceImpl</p><p>在  DeptService 中</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据ID删除部门</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">deleteById</span><span class="params">(Integer id)</span></span>;</span><br></pre></td></tr></table></figure><p>在  DeptServiceImpl 中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteById</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">    <span class="comment">//1. 判断部门下是否有员工， 如果有， 需要提示错误信息</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> empMapper.countByDeptId(id);</span><br><span class="line">    <span class="keyword">if</span>(count &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BusinessException</span>(<span class="string">&quot;部门下有员工， 不能删除&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 删除部门</span></span><br><span class="line">    deptMapper.deleteById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3） DeptMapper 中</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据ID删除部门</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@Delete</span>(<span class="string">&quot;delete from dept where id = #&#123;id&#125;&quot;</span>)</span><br><span class="line">void <span class="built_in">deleteById</span>(Integer id);</span><br></pre></td></tr></table></figure><h1 id="–登录认证">–登录认证</h1><h2 id="1-登录功能">1.登录功能</h2><h3 id="1-1需求-3">1.1需求</h3><p>在登录界面中，我们可以输入用户的用户名以及密码，然后点击 “登录” 按钮就要请求服务器，服务端判断用户输入的用户名或者密码是否正确。如果正确，则返回成功结果，前端跳转至系统首页面。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-462-1024x648.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-463-1024x833.png" alt="img"></p><h3 id="1-2实现思路">1.2实现思路</h3><ul><li>怎么样才算登录成功了呢？<ul><li>用户名和密码都输入正确，登录成功</li><li>否则，登录失败</li></ul></li><li>登录功能的本质是什么？<ul><li>查询</li><li>根据用户名和密码查询员工信息</li></ul></li></ul><h3 id="1-3代码实现">1.3代码实现</h3><p><strong>1). 准备实体类 <code>LoginInfo</code>， 封装登录成功后， 返回给前端的数据 。</strong></p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 登录成功结果封装类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@Data</span></span><br><span class="line"><span class="variable">@NoArgsConstructor</span></span><br><span class="line"><span class="variable">@AllArgsConstructor</span></span><br><span class="line">public class LoginInfo &#123;</span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">Integer</span> <span class="selector-tag">id</span>; <span class="comment">//员工ID</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">String</span> <span class="selector-tag">username</span>; <span class="comment">//用户名</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">String</span> <span class="selector-tag">name</span>; <span class="comment">//姓名</span></span><br><span class="line">    <span class="selector-tag">private</span> <span class="selector-tag">String</span> <span class="selector-tag">token</span>; <span class="comment">//令牌</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2). 定义<code>LoginController</code></strong></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EmpService empService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(<span class="string">&quot;/login&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Result login(<span class="meta">@RequestBody</span> Emp emp)&#123;</span><br><span class="line">        log.info(<span class="string">&quot;员工来登录啦 , &#123;&#125;&quot;</span>, emp);</span><br><span class="line">        LoginInfo loginInfo = empService.login(emp);</span><br><span class="line">        <span class="keyword">if</span>(loginInfo != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> Result.success(loginInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Result.error(<span class="string">&quot;用户名或密码错误~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>**3).****<code>EmpService</code>**<strong>接口中增加 login 登录方法</strong></p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 登录</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">LoginInfo <span class="built_in">login</span>(Emp emp);</span><br></pre></td></tr></table></figure><p><strong>4).</strong> <strong><code>EmpServiceImpl</code></strong> <strong>实现login方法</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> LoginInfo <span class="title function_">login</span><span class="params">(Emp emp)</span> &#123;</span><br><span class="line">    <span class="type">Emp</span> <span class="variable">empLogin</span> <span class="operator">=</span> empMapper.getUsernameAndPassword(emp);</span><br><span class="line">    <span class="keyword">if</span>(empLogin != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="type">LoginInfo</span> <span class="variable">loginInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoginInfo</span>(empLogin.getId(), empLogin.getUsername(), empLogin.getName(), <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">return</span> loginInfo;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>5).</strong> **<code>EmpMapper</code>**<strong>增加接口方法</strong></p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据用户名和密码查询员工信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@Select</span>(<span class="string">&quot;select * from emp where username = #&#123;username&#125; and password = #&#123;password&#125;&quot;</span>)</span><br><span class="line">Emp <span class="built_in">getUsernameAndPassword</span>(Emp emp);</span><br></pre></td></tr></table></figure><p>但是当我们在浏览器中新的页面上输入地址：<code>http://localhost:90</code>，发现没有登录仍然可以进入到后端管理系统页面。</p><p>而真正的登录功能应该是：登陆后才能访问后端系统页面，不登陆则跳转登陆页面进行登陆。</p><p>为什么会出现这个问题？其实原因很简单，就是因为针对于我们当前所开发的部门管理、员工管理以及文件上传等相关接口来说，我们在服务器端并没有做任何的判断，没有去判断用户是否登录了。所以无论用户是否登录，都可以访问部门管理以及员工管理的相关数据。所以我们目前所开发的登录功能，它只是徒有其表。而我们要想解决这个问题，我们就需要完成一步非常重要的操作：登录校验。</p><h2 id="2-登录效验">2.登录效验</h2><p>什么是登录校验？</p><p>所谓登录校验，指的是我们在服务器端接收到浏览器发送过来的请求之后，首先我们要对请求进行校验。先要校验一下用户登录了没有，如果用户已经登录了，就直接执行对应的业务操作就可以了；如果用户没有登录，此时就不允许他执行相关的业务操作，直接给前端响应一个错误的结果，最终跳转到登录页面，要求他登录成功之后，再来访问对应的数据。</p><p>该怎么来实现登录校验的操作呢？具体的实现思路可以分为两部分：</p><ol><li>在员工登录成功后，需要将用户登录成功的信息存起来，记录用户已经登录成功的标记。</li><li>在浏览器发起请求时，需要在服务端进行统一拦截，拦截后进行登录校验。</li></ol><p>想要判断员工是否已经登录，我们需要在员工登录成功之后，存储一个登录成功的标记，接下来在每一个接口方法执行之前，先做一个条件判断，判断一下这个员工到底登录了没有。如果是登录了，就可以执行正常的业务操作，如果没有登录，会直接给前端返回一个错误的信息，前端拿到这个错误信息之后会自动的跳转到登录页面。</p><p>我们程序中所开发的查询功能、删除功能、添加功能、修改功能，都需要使用以上套路进行登录校验。为了简化这块操作，我们可以使用一种技术：统一拦截技术。</p><p>通过统一拦截的技术，我们可以来拦截浏览器发送过来的所有的请求，拦截到这个请求之后，就可以通过请求来获取之前所存入的登录标记，在获取到登录标记且标记为登录成功，就说明员工已经登录了。如果已经登录，我们就直接放行(意思就是可以访问正常的业务接口了)。</p><p>我们要完成以上操作，会涉及到web开发中的两个技术：</p><ol><li>会话技术：用户登录成功之后，在后续的每一次请求中，都可以获取到该标记。</li><li>统一拦截技术：过滤器Filter、拦截器Interceptor</li></ol><h3 id="2-1会话技术">2.1会话技术</h3><h4 id="2-1-1基础知识">2.1.1基础知识</h4><p><strong>什么是会话？</strong></p><p>在web开发当中，会话指的就是浏览器与服务器之间的一次连接，我们就称为一次会话。</p><p>举例：在用户打开浏览器第一次访问服务器的时候，这个会话就建立了，直到有任何一方断开连接，此时会话就结束了。在一次会话当中，是可以包含多次请求和响应的。</p><p>比如：打开了浏览器来访问web服务器上的资源（浏览器不能关闭、服务器不能断开）</p><ul><li>第1次：访问的是登录的接口，完成登录操作</li><li>第2次：访问的是部门管理接口，查询所有部门数据</li><li>第3次：访问的是员工管理接口，查询员工数据</li></ul><p>只要浏览器和服务器都没有关闭，<strong>以上3次请求都属于一次会话</strong>当中完成的。</p><p>需要注意的是：会话是和浏览器关联的，当有三个浏览器客户端和服务器建立了连接时，就会有三个会话。同一个浏览器在未关闭之前请求了多次服务器，这多次请求是属于同一个会话。</p><p><strong>会话跟踪：<strong>一种维护浏览器状态的方法，服务器</strong>需要识别多次请求是否来自于同一浏览器</strong>，以便在同一次会话的多次请求间共享数据。</p><p>我们使用会话跟踪技术就是要完成在同一个会话中，多个请求之间进行共享数据。</p><p><strong>为什么要共享数据呢？</strong></p><p>由于<strong>HTTP是无状态协议</strong>，在后面请求中怎么拿到前一次请求生成的数据呢？此时就需要在一次会话的多次请求之间进行数据共享</p><h4 id="2-1-2三种会话追踪方案">2.1.2三种会话追踪方案</h4><p>会话跟踪技术有三种：</p><ol><li>Cookie（客户端会话跟踪技术）：数据存储在客户端浏览器当中</li><li>Session（服务端会话跟踪技术）：数据存储在储在服务端</li><li>令牌技术</li></ol><h4 id="2-1-3方案一：Cookie">2.1.3<strong>方案一</strong>：Cookie</h4><p>cookie 是客户端会话跟踪技术，<strong>它是存储在客户端浏览器的</strong>，我们使用 cookie 来跟踪会话，我们就可以在浏览器第一次发起请求来请求服务器的时候，我们在服务器端来设置一个cookie。</p><p>比如第一次请求了登录接口，登录接口执行完成之后，我们就可以设置一个cookie，在 cookie 当中我们就可以来存储用户相关的一些数据信息。比如我可以在 cookie 当中来存储当前登录用户的用户名，用户的ID。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-465-1024x255.png" alt="img"></p><ul><li>服务器会 <strong>自动</strong> 的将 cookie 响应给浏览器。</li><li>浏览器接收到响应回来的数据之后，会 <strong>自动</strong> 的将 cookie 存储在浏览器本地。</li><li>在后续的请求当中，浏览器会 <strong>自动</strong> 的将 cookie 携带到服务器端。</li></ul><p><strong>为什么这一切都是自动化进行的？</strong></p><p>是因为 cookie 它是 HTTP 协议当中所支持的技术，而各大浏览器厂商都支持了这一标准。在 HTTP 协议官方给我们提供了一个响应头和请求头：</p><ul><li>响应头 Set-Cookie ：设置Cookie数据的</li><li>请求头 Cookie：携带Cookie数据的</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-475.png" alt="img"></p><p><strong>代码测试：</strong></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SessionController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置Cookie</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/c1&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Result cookie1(HttpServletResponse response)&#123;</span><br><span class="line">        response.addCookie(new Cookie(<span class="string">&quot;login_username&quot;</span>,<span class="string">&quot;itheima&quot;</span>)); <span class="comment">//设置Cookie/响应Cookie</span></span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">//获取Cookie</span></span><br><span class="line">    <span class="meta">@GetMapping(<span class="string">&quot;/c2&quot;</span>)</span></span><br><span class="line">    <span class="keyword">public</span> Result cookie2(HttpServletRequest request)&#123;</span><br><span class="line">        Cookie[] cookies = request.getCookies();</span><br><span class="line">        <span class="keyword">for</span> (Cookie cookie : cookies) &#123;</span><br><span class="line">            <span class="keyword">if</span>(cookie.getName().equals(<span class="string">&quot;login_username&quot;</span>))&#123;</span><br><span class="line">                System.<span class="keyword">out</span>.println(<span class="string">&quot;login_username: &quot;</span>+cookie.getValue()); <span class="comment">//输出name为login_username的cookie</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure><p>A. 访问c1接口，设置Cookie，<code>http://localhost:8080/c1</code></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-476-1024x353.png" alt="img"></p><p>我们可以看到，设置的cookie，通过<strong>响应头Set-Cookie</strong>响应给浏览器，并且浏览器会将Cookie，存储在浏览器端。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-477-1024x302.png" alt="img"></p><p>B. 访问c2接口 <code>http://localhost:8080/c2</code>，此时浏览器会自动的将Cookie携带到服务端，是通过<strong>请求头Cookie</strong>，携带的。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-478-1024x302.png" alt="img"></p><p><strong>优缺点：</strong></p><ul><li>优点：HTTP协议中支持的技术（像Set-Cookie 响应头的解析以及 Cookie 请求头数据的携带，都是浏览器自动进行的，是无需我们手动操作的）</li><li>缺点：<ul><li>移动端APP(Android、IOS)中无法使用Cookie</li><li>不安全，用户可以自己禁用Cookie</li><li>Cookie不能跨域</li></ul></li></ul><h4 id="2-1-4关于跨域">2.1.4关于跨域</h4><blockquote><p><strong>跨域介绍：</strong></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-479.png" alt="img"></p><ul><li>现在的项目，大部分都是前后端分离的，前后端最终也会分开部署，前端部署在服务器 192.168.150.200 上，端口 80，后端部署在 192.168.150.100上，端口 8080</li><li>我们打开浏览器直接访问前端工程，访问url：<a href="http://192.168.150.200/login.html">http://192.168.150.200/login.html</a></li><li>然后在该页面发起请求到服务端，而服务端所在地址不再是localhost，而是服务器的IP地址192.168.150.100，假设访问接口地址为：<a href="http://192.168.150.100:8080/login">http://192.168.150.100:8080/login</a></li><li>那此时就存在跨域操作了，因为我们是在http://192.168.150.200/login.html这个页面上访问了http://192.168.150.100:8080/login接口</li><li>此时如果服务器设置了一个Cookie，这个Cookie是不能使用的，<strong>因为Cookie无法跨域</strong></li></ul><p>区分跨域的维度（三个维度有任何一个维度不同，那就是跨域操作）：</p><ul><li>协议</li><li>IP/协议</li><li>端口</li></ul><p>举例：</p><ul><li><a href="http://192.168.150.200/login.html">http://192.168.150.200/login.html</a> ----------&gt; <a href="https://192.168.150.200/login">https://192.168.150.200/login</a> [协议不同，跨域]</li><li><a href="http://192.168.150.200/login.html">http://192.168.150.200/login.html</a> ----------&gt; <a href="http://192.168.150.100/login">http://192.168.150.100/login</a> [IP不同，跨域]</li><li><a href="http://192.168.150.200/login.html">http://192.168.150.200/login.html</a> ----------&gt; <a href="http://192.168.150.200:8080/login">http://192.168.150.200:8080/login</a> [端口不同，跨域]</li><li><a href="http://192.168.150.200/login.html">http://192.168.150.200/login.html</a> ----------&gt; <a href="http://192.168.150.200/login">http://192.168.150.200/login</a> [不跨域]</li></ul></blockquote><h4 id="2-1-5方案二Session">2.1.5方案二Session</h4><p>它是服务器端会话跟踪技术，所以<strong>它是存储在服务器端的</strong>。</p><ul><li><p><strong>服务器端会话跟踪技术</strong>：所有会话数据都保存在服务器上，只在客户端／浏览器里存一个标识（ID）。</p></li><li><p><strong>基于 Cookie 实现</strong>：底层通过在 HTTP 响应里下发一个名为 <code>JSESSIONID</code> 的 Cookie，把 Session 的 ID 把给浏览器。</p></li><li><p>创建并下发 Session</p></li></ul><p>第一次请求</p><ul><li>浏览器向服务器发起请求。</li><li>服务器检查当前请求是否带有 Session ID（Cookie），发现没有。</li><li>此时服务器自动创建一个新的 Session 对象（如图中标注为 Session(1)），并给它分配一个唯一 ID。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-480-1024x249.png" alt="img"></p><p>响应中下发 Cookie</p><ul><li>服务器在 HTTP 响应头中加上： <code>Set-Cookie: JSESSIONID=&lt;session-id&gt;</code></li><li>浏览器收到后，会把这个 <code>JSESSIONID</code> 存到本地。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-481-1024x248.png" alt="img"></p><ul><li>查找并复用 Session</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-482-1024x248.png" alt="img"></p><p><strong>浏览器自动带上 Cookie</strong></p><ul><li>之后每次发请求时，浏览器都会在头里加上：</li></ul><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">Cookie:</span> JSESSIONID<span class="operator">=</span><span class="symbol">&lt;session-id&gt;</span></span><br></pre></td></tr></table></figure><p><strong>服务器取回 Session 数据</strong></p><ul><li>服务器从 Cookie 里取出 <code>JSESSIONID</code>，根据这个 ID 从自身的 Session 存储中找到对应的会话对象。</li><li>因此，多个请求就能共享同一个 Session 对象里的数据（如用户登录状态、临时变量等）。</li></ul><ol><li></li></ol><p><strong>代码测试</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j</span><br><span class="line">@RestController</span><br><span class="line"><span class="built_in">public</span> <span class="keyword">class</span> SessionController &#123;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;/s1&quot;)</span><br><span class="line">    <span class="built_in">public</span> Result session1(HttpSession <span class="keyword">session</span>)&#123;</span><br><span class="line">        <span class="keyword">log</span>.<span class="keyword">info</span>(&quot;HttpSession-s1: &#123;&#125;&quot;, <span class="keyword">session</span>.hashCode());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">session</span>.setAttribute(&quot;loginUser&quot;, &quot;tom&quot;); //往<span class="keyword">session</span>中存储数据</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;/s2&quot;)</span><br><span class="line">    <span class="built_in">public</span> Result session2(HttpServletRequest request)&#123;</span><br><span class="line">        HttpSession <span class="keyword">session</span> = request.getSession();</span><br><span class="line">        <span class="keyword">log</span>.<span class="keyword">info</span>(&quot;HttpSession-s2: &#123;&#125;&quot;, <span class="keyword">session</span>.hashCode());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">Object</span> loginUser = <span class="keyword">session</span>.getAttribute(&quot;loginUser&quot;); //从<span class="keyword">session</span>中获取数据</span><br><span class="line">        <span class="keyword">log</span>.<span class="keyword">info</span>(&quot;loginUser: &#123;&#125;&quot;, loginUser);</span><br><span class="line">        <span class="keyword">return</span> Result.success(loginUser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>A. 访问 s1 接口，<code>http://localhost:8080/s1</code></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-483-1024x368.png" alt="img"></p><p>请求完成之后，在响应头中，就会看到有一个Set-Cookie的响应头，里面响应回来了一个Cookie，就是JSESSIONID，这个就是服务端会话对象 Session 的ID。</p><p>B. 访问 s2 接口，<code>http://localhost:8080/s2</code></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-484-1024x292.png" alt="img"></p><p>接下来，在后续的每次请求时，都会将Cookie的值，携带到服务端，那服务端呢，接收到Cookie之后，会自动的根据JSESSIONID的值，找到对应的会话对象Session。</p><p>那经过这两步测试，大家也会看到，在控制台中输出如下日志：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-485-1024x77.png" alt="img"></p><p>两次请求，获取到的Session会话对象的hashcode是一样的，就说明是同一个会话对象。而且，第一次请求时，往Session会话对象中存储的值，第二次请求时，也获取到了。 那这样，我们就可以通过Session会话对象，在同一个会话的多次请求之间来进行数据共享了。</p><p><strong>优缺点</strong></p><ul><li>优点：Session是存储在服务端的，安全</li><li>缺点：<ul><li>服务器集群环境下无法直接使用Session</li><li>移动端APP(Android、IOS)中无法使用Cookie</li><li>用户可以自己禁用Cookie</li><li>Cookie不能跨域</li></ul></li></ul><p>PS：Session 底层是基于Cookie实现的会话跟踪，如果Cookie不可用，则该方案，也就失效了。</p><h4 id="2-1-6服务器集群环境为何无法使用Session？">2.1.6<strong>服务器集群环境为何无法使用Session？</strong></h4><p>在多机部署（集群）下直接用 Session 会碰到这样的问题：</p><ol><li>集群部署<ul><li>为了避免单点故障，项目通常部署多份（例如 3 台 Tomcat），并在前端加一台负载均衡服务器来分发请求。</li><li></li></ul></li><li>Session 本地存储<ul><li>每台 Tomcat 都维护自己的一份 Session 存储，Session ID（JSESSIONID）和会话数据只保存在产生它的那台机器上。</li></ul></li><li>请求不稳定路由<ul><li>浏览器第一次登录，经负载均衡到达 A 服务器，A 服务器创建 Session(1)，并下发 JSESSIONID=1 给浏览器。</li><li>浏览器第二次请求（带 JSESSIONID=1）又被路由到 B 服务器，B 服务器在自己的存储里找不到 ID=1 的 Session，就无法识别用户状态。</li></ul></li><li>结果<ul><li>同一个浏览器连续请求，却因为被分到不同节点，拿不到同一个 Session，导致会话跟踪失效。</li></ul></li></ol><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-468.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-469.png" alt="img"></p><ol><li></li></ol><p><strong>核心结论</strong>：</p><ul><li>传统的服务器内存型 Session 只能在单机上使用；</li><li>在集群环境下，必须引入“会话共享”或“粘性会话”等机制，才能保证每次请求都能取到同一个 Session 对象。</li></ul><h4 id="2-1-7方案三：令牌技术">2.1.7方案三：令牌技术</h4><p>这里提到的令牌，其实它就是一个用户身份的标识，本质就是一个字符串。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-470-1024x248.png" alt="img"></p><p>如果通过令牌技术来跟踪会话，我们就可以在浏览器发起请求。在请求登录接口的时候，如果登录成功，我就可以生成一个令牌，令牌就是用户的合法身份凭证。接下来我在响应数据的时候，我就可以直接将令牌响应给前端。</p><p>接下来我们在前端程序当中接收到令牌之后，就需要将这个令牌存储起来。这个存储可以存储在 cookie 当中，也可以存储在其他的存储空间(比如：localStorage)当中。</p><p>接下来，在后续的每一次请求当中，都需要将令牌携带到服务端。携带到服务端之后，接下来我们就需要来校验令牌的有效性。如果令牌是有效的，就说明用户已经执行了登录操作，如果令牌是无效的，就说明用户之前并未执行登录操作。</p><p>此时，如果是在同一次会话的多次请求之间，我们想共享数据，我们就可以将共享的数据存储在令牌当中就可以了。</p><p><strong>优缺点</strong></p><ul><li>优点：<ul><li>支持PC端、移动端</li><li>解决集群环境下的认证问题</li><li>减轻服务器的存储压力（无需在服务器端存储）</li></ul></li><li>缺点：需要自己实现（包括令牌的生成、令牌的传递、令牌的校验）</li></ul><h3 id="2-2JWT令牌">2.2JWT令牌</h3><h4 id="2-2-1介绍">2.2.1介绍</h4><ul><li>JWT全称 JSON Web Token （官网：<a href="https://jwt.io/%EF%BC%89%EF%BC%8C%E5%AE%9A%E4%B9%89%E4%BA%86%E4%B8%80%E7%A7%8D%E7%AE%80%E6%B4%81%E7%9A%84%E3%80%81%E8%87%AA%E5%8C%85%E5%90%AB%E7%9A%84%E6%A0%BC%E5%BC%8F%EF%BC%8C%E7%94%A8%E4%BA%8E%E5%9C%A8%E9%80%9A%E4%BF%A1%E5%8F%8C%E6%96%B9%E4%BB%A5json%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F%E5%AE%89%E5%85%A8%E7%9A%84%E4%BC%A0%E8%BE%93%E4%BF%A1%E6%81%AF%E3%80%82%E7%94%B1%E4%BA%8E%E6%95%B0%E5%AD%97%E7%AD%BE%E5%90%8D%E7%9A%84%E5%AD%98%E5%9C%A8%EF%BC%8C%E8%BF%99%E4%BA%9B%E4%BF%A1%E6%81%AF%E6%98%AF%E5%8F%AF%E9%9D%A0%E7%9A%84%E3%80%82">https://jwt.io/），定义了一种简洁的、自包含的格式，用于在通信双方以json数据格式安全的传输信息。由于数字签名的存在，这些信息是可靠的。</a><ul><li>简洁：是指jwt就是一个简单的字符串。可以在请求参数或者是请求头当中直接传递。</li><li>自包含：指的是jwt令牌，看似是一个随机的字符串，但是我们是可以根据自身的需求在jwt令牌中存储自定义的数据内容。如：可以直接在jwt令牌中存储用户的相关信息。</li><li><strong>简单来讲，jwt就是将原始的json数据格式进行了安全的封装，这样就可以直接基于jwt在通信双方安全的进行信息传输了。</strong></li></ul></li></ul><p>JWT的组成： （JWT令牌由三个部分组成，三个部分之间使用英文的点来分割）</p><ul><li>第一部分：Header(头）， 记录令牌类型、签名算法等。 例如：{“alg”:“HS256”,“type”:“JWT”}</li><li>第二部分：Payload(有效载荷），携带一些自定义信息、默认信息等。 例如：{“id”:“1”,“username”:“Tom”}</li><li>第三部分：Signature(签名），防止Token被篡改、确保安全性。将header、payload，并加入指定秘钥，通过指定签名算法计算而来。</li></ul><blockquote><p>签名的目的就是为了防jwt令牌被篡改，而正是因为jwt令牌最后一个部分数字签名的存在，所以整个jwt 令牌是非常安全可靠的。一旦jwt令牌当中任何一个部分、任何一个字符被篡改了，整个令牌在校验的时候都会失败，所以它是非常安全可靠的。</p></blockquote><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-486-1024x86.png" alt="img"></p><p>JWT是如何将原始的JSON格式数据，转变为字符串的呢？</p><ul><li>其实在生成JWT令牌时，会对JSON格式的数据进行一次编码：进行base64编码</li><li>Base64：是一种基于64个可打印的字符来表示二进制数据的编码方式。既然能编码，那也就意味着也能解码。所使用的64个字符分别是A到Z、a到z、 0- 9，一个加号，一个斜杠，加起来就是64个字符。任何数据经过base64编码之后，最终就会通过这64个字符来表示。当然还有一个符号，那就是等号。等号它是一个补位的符号</li><li>需要注意的是Base64是编码方式，而不是加密方式。</li></ul><h4 id="2-2-2生成和校验">2.2.2生成和校验</h4><p>1). 首先我们先来实现JWT令牌的生成。要想使用JWT令牌，需要先引入JWT的依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- JWT依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在引入完JWT来赖后，就可以调用工具包中提供的API来完成JWT令牌的生成和校验。工具类：Jwts</p><p>2). 生成JWT代码实现：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">testGenJwt</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Map</span>&lt;<span class="title class_">String</span>, <span class="title class_">Object</span>&gt; claims = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    claims.<span class="title function_">put</span>(<span class="string">&quot;id&quot;</span>, <span class="number">10</span>);</span><br><span class="line">    claims.<span class="title function_">put</span>(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;itheima&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">String</span> jwt = <span class="title class_">Jwts</span>.<span class="title function_">builder</span>().<span class="title function_">signWith</span>(<span class="title class_">SignatureAlgorithm</span>.<span class="property">HS256</span>, <span class="string">&quot;aXRjYXN0&quot;</span>)</span><br><span class="line">        .<span class="title function_">addClaims</span>(claims)</span><br><span class="line">        .<span class="title function_">setExpiration</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(<span class="title class_">System</span>.<span class="title function_">currentTimeMillis</span>() + <span class="number">12</span> * <span class="number">3600</span> * <span class="number">1000</span>))</span><br><span class="line">        .<span class="title function_">compact</span>();</span><br><span class="line"></span><br><span class="line">    <span class="title class_">System</span>.<span class="property">out</span>.<span class="title function_">println</span>(jwt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行测试方法：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiJ9<span class="selector-class">.eyJpZCI6MSwiZXhwIjoxNjcyNzI5NzMwfQ</span>.fHi0Ub8npbyt71UqLXDdLyipptLgxBUg_mSuGJtXtBk</span><br></pre></td></tr></table></figure><p>输出的结果就是生成的JWT令牌,，通过英文的点分割对三个部分进行分割，我们可以将生成的令牌复制一下，然后打开JWT的官网，将生成的令牌直接放在Encoded位置，此时就会自动的将令牌解析出来。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-487-1024x595.png" alt="img"></p><p>第一部分解析出来，看到JSON格式的原始数据，所使用的签名算法为HS256。</p><p>第二个部分是我们自定义的数据，之前我们自定义的数据就是id，还有一个exp代表的是我们所设置的过期时间。</p><p>由于前两个部分是base64编码，所以是可以直接解码出来。但最后一个部分并不是base64编码，是经过签名算法计算出来的，所以最后一个部分是不会解析的。</p><p>3). 实现了JWT令牌的生成，下面我们接着使用Java代码来校验JWT令牌(解析生成的令牌)：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testParseJwt</span>()</span> &#123;</span><br><span class="line">    Claims claims = Jwts.parser().setSigningKey(<span class="string">&quot;aXRjYXN0&quot;</span>)</span><br><span class="line">        .parseClaimsJws(<span class="string">&quot;eyJhbGciOiJIUzI1NiJ9.eyJpZCI6MTAsInVzZXJuYW1lIjoiaXRoZWltYSIsImV4cCI6MTcwMTkwOTAxNX0.N-MD6DmoeIIY5lB5z73UFLN9u7veppx1K5_N_jS9Yko&quot;</span>)</span><br><span class="line">        .getBody();</span><br><span class="line">    System.<span class="keyword">out</span>.println(claims);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行测试方法：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attribute">id</span>=10, <span class="attribute">username</span>=itheima, <span class="attribute">exp</span>=1701909015&#125;</span><br></pre></td></tr></table></figure><p>令牌解析后，我们可以看到id和过期时间，如果在解析的过程当中没有报错，就说明解析成功了。</p><p>通过以上测试，我们在使用JWT令牌时需要注意：</p><ul><li>JWT校验时使用的签名秘钥，必须和生成JWT令牌时使用的秘钥是配套的。</li><li>如果JWT令牌解析校验时报错，则说明 JWT令牌被篡改 或 失效了，令牌非法。</li></ul><h4 id="2-2-3登录时下发令牌">2.2.3登录时下发令牌</h4><ol><li>生成令牌<ul><li>在登录成功之后来生成一个JWT令牌，并且把这个令牌直接返回给前端</li></ul></li><li>校验令牌<ul><li>拦截前端请求，从请求中获取到令牌，对令牌进行解析校验</li></ul></li></ol><p><strong>实现步骤：</strong></p><ol><li>引入JWT工具类：在项目工程下创建 <code>com.itheima.util</code> 包，并把提供JWT工具类复制到该包下</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">itheima</span>.<span class="property">util</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.<span class="property">jsonwebtoken</span>.<span class="property">Claims</span>;</span><br><span class="line"><span class="keyword">import</span> io.<span class="property">jsonwebtoken</span>.<span class="property">Jwts</span>;</span><br><span class="line"><span class="keyword">import</span> io.<span class="property">jsonwebtoken</span>.<span class="property">SignatureAlgorithm</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">Date</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">util</span>.<span class="property">Map</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="title class_">String</span> signKey = <span class="string">&quot;SVRIRUlNQQ==&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="title class_">Long</span> expire = 43200000L;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成JWT令牌</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="title class_">String</span> <span class="title function_">generateJwt</span>(<span class="params"><span class="title class_">Map</span>&lt;<span class="title class_">String</span>,<span class="title class_">Object</span>&gt; claims</span>)&#123;</span><br><span class="line">        <span class="title class_">String</span> jwt = <span class="title class_">Jwts</span>.<span class="title function_">builder</span>()</span><br><span class="line">                .<span class="title function_">addClaims</span>(claims)</span><br><span class="line">                .<span class="title function_">signWith</span>(<span class="title class_">SignatureAlgorithm</span>.<span class="property">HS256</span>, signKey)</span><br><span class="line">                .<span class="title function_">setExpiration</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(<span class="title class_">System</span>.<span class="title function_">currentTimeMillis</span>() + expire))</span><br><span class="line">                .<span class="title function_">compact</span>();</span><br><span class="line">        <span class="keyword">return</span> jwt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析JWT令牌</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jwt JWT令牌</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> JWT第二部分负载 payload 中存储的内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="title class_">Claims</span> <span class="title function_">parseJWT</span>(<span class="params"><span class="title class_">String</span> jwt</span>)&#123;</span><br><span class="line">        <span class="title class_">Claims</span> claims = <span class="title class_">Jwts</span>.<span class="title function_">parser</span>()</span><br><span class="line">                .<span class="title function_">setSigningKey</span>(signKey)</span><br><span class="line">                .<span class="title function_">parseClaimsJws</span>(jwt)</span><br><span class="line">                .<span class="title function_">getBody</span>();</span><br><span class="line">        <span class="keyword">return</span> claims;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>完善 <code>EmpServiceImpl</code>中的 <code>login</code> 方法逻辑， 登录成功，生成JWT令牌并返回</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">LoginInfo</span> <span class="title function_">login</span>(<span class="params"><span class="title class_">Emp</span> emp</span>) &#123;</span><br><span class="line">    <span class="title class_">Emp</span> empLogin = empMapper.<span class="title function_">getUsernameAndPassword</span>(emp);</span><br><span class="line">    <span class="keyword">if</span>(empLogin != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="comment">//1. 生成JWT令牌</span></span><br><span class="line">        <span class="title class_">Map</span>&lt;<span class="title class_">String</span>,<span class="title class_">Object</span>&gt; dataMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        dataMap.<span class="title function_">put</span>(<span class="string">&quot;id&quot;</span>, empLogin.<span class="title function_">getId</span>());</span><br><span class="line">        dataMap.<span class="title function_">put</span>(<span class="string">&quot;username&quot;</span>, empLogin.<span class="title function_">getUsername</span>());</span><br><span class="line">        </span><br><span class="line">        <span class="title class_">String</span> jwt = <span class="title class_">JwtUtils</span>.<span class="title function_">generateJwt</span>(dataMap);</span><br><span class="line">        <span class="title class_">LoginInfo</span> loginInfo = <span class="keyword">new</span> <span class="title class_">LoginInfo</span>(empLogin.<span class="title function_">getId</span>(), empLogin.<span class="title function_">getUsername</span>(), empLogin.<span class="title function_">getName</span>(), jwt);</span><br><span class="line">        <span class="keyword">return</span> loginInfo;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3过滤器Filter">2.3过滤器Filter</h3><p>刚才通过浏览器的开发者工具，我们可以看到在后续的请求当中，都会在请求头中携带JWT令牌到服务端，而服务端需要统一拦截所有的请求，从而判断是否携带的有合法的JWT令牌。</p><p>那怎么样来统一拦截到所有的请求校验令牌的有效性呢？这里我们会学习两种解决方案：</p><ul><li>Interceptor拦截器</li><li>Filter过滤器</li></ul><h4 id="2-3-1Filter快速入门">2.3.1Filter快速入门</h4><p><strong>什么是Filter？</strong></p><ul><li>Filter表示过滤器，是 JavaWeb三大组件(Servlet、Filter、Listener)之一。</li><li>过滤器可以把对资源的请求拦截下来，从而实现一些特殊的功能<ul><li>使用了过滤器之后，要想访问web服务器上的资源，必须先经过滤器，过滤器处理完毕之后，才可以访问对应的资源。</li></ul></li><li>过滤器一般完成一些通用的操作，比如：登录校验、统一编码处理、敏感字符处理等。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-488.png" alt="img"></p><p>下面我们通过Filter快速入门程序掌握过滤器的基本使用操作：</p><ul><li>第1步，定义过滤器 ：1.定义一个类，实现 Filter 接口，并重写其所有方法。</li><li>第2步，配置过滤器：Filter类上加 @WebFilter 注解，配置拦截资源的路径。引导类上加 @ServletComponentScan 开启Servlet组件支持。</li></ul><p><strong>1). 定义过滤器</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DemoFilter</span> <span class="title">implements</span> <span class="title">Filter</span> &#123;</span><br><span class="line">    <span class="comment">//初始化方法, web服务器启动, 创建Filter实例时调用, 只调用一次</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span>(<span class="params">FilterConfig filterConfig</span>) throws ServletException</span> &#123;</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">&quot;init ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//拦截到请求时,调用该方法,可以调用多次</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span>(<span class="params">ServletRequest servletRequest, ServletResponse servletResponse, FilterChain chain</span>) throws IOException, ServletException</span> &#123;</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">&quot;拦截到了请求...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//销毁方法, web服务器关闭时调用, 只调用一次</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span>()</span> &#123;</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">&quot;destroy ... &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>init方法：过滤器的初始化方法。在web服务器启动的时候会自动的创建Filter过滤器对象，在创建过滤器对象的时候会自动调用init初始化方法，这个方法只会被调用一次。</li><li>doFilter方法：这个方法是在每一次拦截到请求之后都会被调用，所以这个方法是会被调用多次的，每拦截到一次请求就会调用一次doFilter()方法。</li><li>destroy方法： 是销毁的方法。当我们关闭服务器的时候，它会自动的调用销毁方法destroy，而这个销毁方法也只会被调用一次。</li></ul><p><strong>2). 配置过滤器</strong></p><p>在定义完Filter之后，Filter其实并不会生效，还需要完成Filter的配置，Filter的配置非常简单，只需要在Filter类上添加一个注解：<code>@WebFilter</code>，并指定属性<code>urlPatterns</code>，通过这个属性指定过滤器要拦截哪些请求</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebFilter</span>(urlPatterns = <span class="string">&quot;/*&quot;</span>) <span class="comment">//配置过滤器要拦截的请求路径（ /* 表示拦截浏览器的所有请求 ）</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="comment">//初始化方法, web服务器启动, 创建Filter实例时调用, 只调用一次</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;init ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//拦截到请求时,调用该方法,可以调用多次</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;拦截到了请求...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//销毁方法, web服务器关闭时调用, 只调用一次</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;destroy ... &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当我们在Filter类上面加了@WebFilter注解之后，接下来我们还需要在启动类上面加上一个注解<code>@ServletComponentScan</code>，通过这个<code>@ServletComponentScan</code>注解来开启SpringBoot项目对于Servlet组件的支持。</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@ServletComponentScan</span> <span class="comment">//开启对Servlet组件的支持</span></span><br><span class="line"><span class="variable">@SpringBootApplication</span></span><br><span class="line">public class TliasManagementApplication &#123;</span><br><span class="line">    <span class="selector-tag">public</span> <span class="selector-tag">static</span> <span class="selector-tag">void</span> <span class="selector-tag">main</span>(String[] args) &#123;</span><br><span class="line">        <span class="selector-tag">SpringApplication</span><span class="selector-class">.run</span>(TliasManagementApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重新启动服务，打开浏览器，执行部门管理的请求，可以看到控制台输出了过滤器中的内容：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-489-1024x128.png" alt="img"></p><p>**注意事项：**在过滤器Filter中，如果不执行放行操作，将无法访问后面的资源。 放行操作：<code>chain.doFilter(request, response);</code></p><h4 id="2-3-2登录校验过滤器">2.3.2登录校验过滤器</h4><p>我们先来回顾下前面分析过的登录校验的基本流程：</p><ul><li>要进入到后台管理系统，我们必须先完成登录操作，此时就需要访问登录接口login。</li><li>登录成功之后，我们会在服务端生成一个JWT令牌，并且把JWT令牌返回给前端，前端会将JWT令牌存储下来。</li><li>在后续的每一次请求当中，都会将JWT令牌携带到服务端，请求到达服务端之后，要想去访问对应的业务功能，此时我们必须先要校验令牌的有效性。</li><li>对于校验令牌的这一块操作，我们使用登录校验的过滤器，在过滤器当中来校验令牌的有效性。如果令牌是无效的，就响应一个错误的信息，也不会再去放行访问对应的资源了。如果令牌存在，并且它是有效的，此时就会放行去访问对应的web资源，执行相应的业务操作。</li></ul><ol><li>所有的请求，拦截到了之后，都需要校验令牌吗 ？<ul><li>答案：<strong>登录请求例外</strong></li></ul></li><li>拦截到请求后，什么情况下才可以放行，执行业务操作 ？<ul><li>答案：<strong>有令牌，且令牌校验通过(合法)；否则都返回未登录错误结果</strong></li></ul></li></ol><p>具体流程</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-471.png" alt="img"></p><p>基于上面的业务流程，我们分析出具体的操作步骤：</p><ol><li>获取请求url</li><li>判断请求url中是否包含login，如果包含，说明是登录操作，放行</li><li>获取请求头中的令牌（token）</li><li>判断令牌是否存在，如果不存在，响应 401</li><li>解析token，如果解析失败，响应 401</li><li>放行</li></ol><h4 id="2-3-3代码实现">2.3.3代码实现</h4><p>在 <code>com.itheima.filter</code> 包下创建<code>TokenFilter</code>，具体代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.utils.JwtUtils;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.*;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.annotation.WebFilter;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** * 令牌校验过滤器 */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@WebFilter(urlPatterns = &quot;/*&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TokenFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest req, ServletResponse resp, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> (HttpServletRequest) req;</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> (HttpServletResponse) resp;</span><br><span class="line">        <span class="comment">//1. 获取请求url。</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> request.getRequestURL().toString();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 判断请求url中是否包含login，如果包含，说明是登录操作，放行。</span></span><br><span class="line">        <span class="keyword">if</span>(url.contains(<span class="string">&quot;login&quot;</span>))&#123; <span class="comment">//登录请求</span></span><br><span class="line">            log.info(<span class="string">&quot;登录请求 , 直接放行&quot;</span>);</span><br><span class="line">            chain.doFilter(request, response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 获取请求头中的令牌（token）。</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jwt</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4. 判断令牌是否存在，如果不存在，返回错误结果（未登录）。</span></span><br><span class="line">        <span class="keyword">if</span>(!StringUtils.hasLength(jwt))&#123; <span class="comment">//jwt为空</span></span><br><span class="line">            log.info(<span class="string">&quot;获取到jwt令牌为空, 返回错误结果&quot;</span>);</span><br><span class="line">            response.setStatus(HttpStatus.SC_UNAUTHORIZED);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5. 解析token，如果解析失败，返回错误结果（未登录）。</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            JwtUtils.parseJWT(jwt);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            log.info(<span class="string">&quot;解析令牌失败, 返回错误结果&quot;</span>);</span><br><span class="line">            response.setStatus(HttpStatus.SC_UNAUTHORIZED);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//6. 放行。</span></span><br><span class="line">        log.info(<span class="string">&quot;令牌合法, 放行&quot;</span>);</span><br><span class="line">        chain.doFilter(request , response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-3-4Filter详解">2.3.4Filter详解</h4><p>Filter过滤器的快速入门程序我们已经完成了，接下来我们就要详细的介绍一下过滤器Filter在使用中的一些细节。主要介绍以下3个方面的细节：</p><ol><li>过滤器的执行流程</li><li>过滤器的拦截路径配置</li><li>过滤器链</li></ol><ul><li>执行流程</li></ul><p>首先我们先来看下过滤器的执行流程：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-490.png" alt="img"></p><p>过滤器当中我们拦截到了请求之后，如果希望继续访问后面的web资源，就要执行放行操作，放行就是调用 FilterChain对象当中的doFilter()方法，在调用doFilter()这个方法之前所编写的代码属于放行之前的逻辑。</p><p>在放行后访问完 web 资源之后还会回到过滤器当中，回到过滤器之后如有需求还可以执行放行之后的逻辑，放行之后的逻辑我们写在doFilter()这行代码之后。</p><p>测试代码：</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebFilter</span>(urlPatterns = <span class="string">&quot;/*&quot;</span>) </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">//初始化方法, 只调用一次</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;init 初始化方法执行了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;DemoFilter   放行前逻辑.....&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//放行请求</span></span><br><span class="line">        filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;DemoFilter   放行后逻辑.....&quot;</span>);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">//销毁方法, 只调用一次</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;destroy 销毁方法执行了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启动之后运行测试：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-491.png" alt="img"></p><ul><li>拦截路径</li></ul><p>执行流程我们搞清楚之后，接下来再来介绍一下过滤器的拦截路径，Filter可以根据需求，配置不同的拦截资源路径：</p><table><thead><tr><th>拦截路径</th><th>urlPatterns值</th><th>含义</th></tr></thead><tbody><tr><td>拦截具体路径</td><td>/login</td><td>只有访问 /login 路径时，才会被拦截</td></tr><tr><td>目录拦截</td><td>/emps/*</td><td>访问/emps下的所有资源，都会被拦截</td></tr><tr><td>拦截所有</td><td>/*</td><td>访问所有资源，都会被拦截</td></tr></tbody></table><p>下面我们来测试&quot;拦截具体路径&quot;：</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebFilter</span>(urlPatterns = <span class="string">&quot;/login&quot;</span>)  <span class="comment">//拦截/login具体路径</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;DemoFilter   放行前逻辑.....&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//放行请求</span></span><br><span class="line">        filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;DemoFilter   放行后逻辑.....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        Filter.<span class="keyword">super</span>.init(filterConfig);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Filter.<span class="keyword">super</span>.destroy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>过滤器链</li></ul><p>最后我们在来介绍下过滤器链，什么是过滤器链呢？所谓过滤器链指的是在一个web应用程序当中，可以配置多个过滤器，多个过滤器就形成了一个过滤器链。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-492.png" alt="img"></p><p>比如：在我们web服务器当中，定义了两个过滤器，这两个过滤器就形成了一个过滤器链。</p><p>而这个链上的过滤器在执行的时候会一个一个的执行，会先执行第一个Filter，放行之后再来执行第二个Filter，如果执行到了最后一个过滤器放行之后，才会访问对应的web资源。</p><p>访问完web资源之后，按照我们刚才所介绍的过滤器的执行流程，还会回到过滤器当中来执行过滤器放行后的逻辑，而在执行放行后的逻辑的时候，顺序是反着的。</p><p>先要执行过滤器2放行之后的逻辑，再来执行过滤器1放行之后的逻辑，最后在给浏览器响应数据。</p><p>过滤器链上过滤器的执行顺序：注解配置的Filter，优先级是按照过滤器类名（字符串）的自然排序。 比如：</p><ul><li>AbcFilter</li><li>DemoFilter</li></ul><p>这两个过滤器来说，AbcFilter 会先执行，DemoFilter会后执行。</p><h3 id="2-4拦截器Interceptor">2.4拦截器Interceptor</h3><h4 id="2-4-1快速入门">2.4.1快速入门</h4><p><strong>什么是拦截器？</strong></p><ul><li>是一种动态拦截方法调用的机制，类似于过滤器。</li><li>拦截器是Spring框架中提供的，用来动态拦截控制器方法的执行。</li><li>拦截器的作用：拦截请求，在指定方法调用前后，根据业务需要执行预先设定的代码。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-493.png" alt="img"></p><p>在拦截器当中，我们通常也是做一些通用性的操作，比如：我们可以通过拦截器来拦截前端发起的请求，将登录校验的逻辑全部编写在拦截器当中。在校验的过程当中，如发现用户登录了(携带JWT令牌且是合法令牌)，就可以直接放行，去访问spring当中的资源。如果校验时发现并没有登录或是非法令牌，就可以直接给前端响应未登录的错误信息。</p><p>下面我们通过快速入门程序，来学习下拦截器的基本使用。拦截器的使用步骤和过滤器类似，也分为两步：</p><ol><li>定义拦截器</li><li>注册配置拦截器</li></ol><p><strong>1). 自定义拦截器</strong></p><p>实现HandlerInterceptor接口，并重写其所有方法</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//自定义拦截器</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="comment">//目标资源方法执行前执行。 返回true：放行    返回false：不放行</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object <span class="keyword">handler</span>)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;preHandle .... &quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">//true表示放行</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//目标资源方法执行后执行</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object <span class="keyword">handler</span>, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;postHandle ... &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//视图渲染完毕后执行，最后执行</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object <span class="keyword">handler</span>, Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;afterCompletion .... &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：</p><ul><li>preHandle方法：目标资源方法执行前执行。 返回true：放行 返回false：不放行</li><li>postHandle方法：目标资源方法执行后执行</li><li>afterCompletion方法：视图渲染完毕后执行，最后执行</li></ul><p><strong>2). 注册配置拦截器</strong></p><p>在 <code>com.itheima</code>下创建一个包，然后创建一个配置类 <code>WebConfig</code>， 实现 <code>WebMvcConfigurer</code> 接口，并重写 <code>addInterceptors</code> 方法</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//自定义的拦截器对象</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">DemoInterceptor</span> demoInterceptor;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">addInterceptors</span>(<span class="params"><span class="title class_">InterceptorRegistry</span> registry</span>) &#123;</span><br><span class="line">       <span class="comment">//注册自定义拦截器对象</span></span><br><span class="line">        registry.<span class="title function_">addInterceptor</span>(demoInterceptor).<span class="title function_">addPathPatterns</span>(<span class="string">&quot;/**&quot;</span>);<span class="comment">//设置拦截器拦截的请求路径（ /** 表示拦截所有请求）</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重新启动SpringBoot服务，打开Apifox测试：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-494.png" alt="img"></p><p>可以看到控制台输出的日志：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-495.png" alt="img"></p><p>接下来我们再来做一个测试：将拦截器中返回值改为false</p><p>使用Apifox，再次点击send发送请求后，没有响应数据，说明请求被拦截了没有放行</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-496.png" alt="img"></p><h4 id="2-4-2牌校验Interceptor">2.4.2牌校验Interceptor</h4><p>通过拦截器来完成案例当中的登录校验功能。</p><p>登录校验的业务逻辑以及操作步骤我们前面已经分析过了，和登录校验Filter过滤器当中的逻辑是完全一致的。现在我们只需要把这个技术方案由原来的过滤器换成拦截器interceptor就可以了。</p><p><strong>1). TokenInterceptor</strong></p><p>在 <code>com.itheima.interceptor</code> 包下创建 <code>TokenInterceptor</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TokenInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//1. 获取请求url。</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> request.getRequestURL().toString();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 判断请求url中是否包含login，如果包含，说明是登录操作，放行。</span></span><br><span class="line">        <span class="keyword">if</span>(url.contains(<span class="string">&quot;login&quot;</span>))&#123; <span class="comment">//登录请求</span></span><br><span class="line">            log.info(<span class="string">&quot;登录请求 , 直接放行&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 获取请求头中的令牌（token）。</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jwt</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4. 判断令牌是否存在，如果不存在，返回错误结果（未登录）。</span></span><br><span class="line">        <span class="keyword">if</span>(!StringUtils.hasLength(jwt))&#123; <span class="comment">//jwt为空</span></span><br><span class="line">            log.info(<span class="string">&quot;获取到jwt令牌为空, 返回错误结果&quot;</span>);</span><br><span class="line">            response.setStatus(HttpStatus.SC_UNAUTHORIZED);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5. 解析token，如果解析失败，返回错误结果（未登录）。</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            JwtUtils.parseJWT(jwt);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            log.info(<span class="string">&quot;解析令牌失败, 返回错误结果&quot;</span>);</span><br><span class="line">            response.setStatus(HttpStatus.SC_UNAUTHORIZED);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//6. 放行。</span></span><br><span class="line">        log.info(<span class="string">&quot;令牌合法, 放行&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2). 配置拦截器</strong></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="comment">//拦截器对象</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">TokenInterceptor</span> tokenInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">addInterceptors</span>(<span class="params"><span class="title class_">InterceptorRegistry</span> registry</span>) &#123;</span><br><span class="line">       <span class="comment">//注册自定义拦截器对象</span></span><br><span class="line">        registry.<span class="title function_">addInterceptor</span>(tokenInterceptor).<span class="title function_">addPathPatterns</span>(<span class="string">&quot;/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>登录校验的拦截器编写完成后，接下来我们就可以重新启动服务来做一个测试： （<strong>关闭登录校验Filter过滤器</strong>）</p><h4 id="2-4-3nterceptor详解">2.4.3nterceptor详解</h4><p>拦截器的使用细节我们主要介绍两个部分：</p><ol><li>拦截器的拦截路径配置</li><li>拦截器的执行流程</li></ol><ul><li>拦截路径</li></ul><p>首先我们先来看拦截器的拦截路径的配置，在注册配置拦截器的时候，我们要指定拦截器的拦截路径，通过<code>addPathPatterns(&quot;要拦截路径&quot;)</code>方法，就可以指定要拦截哪些资源。</p><p>在入门程序中我们配置的是<code>/**</code>，表示拦截所有资源，而在配置拦截器时，不仅可以指定要拦截哪些资源，还可以指定不拦截哪些资源，只需要调用<code>excludePathPatterns(&quot;不拦截路径&quot;)</code>方法，指定哪些资源不需要拦截。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//拦截器对象</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">DemoInterceptor</span> demoInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">addInterceptors</span>(<span class="params"><span class="title class_">InterceptorRegistry</span> registry</span>) &#123;</span><br><span class="line">        <span class="comment">//注册自定义拦截器对象</span></span><br><span class="line">        registry.<span class="title function_">addInterceptor</span>(demoInterceptor)</span><br><span class="line">                .<span class="title function_">addPathPatterns</span>(<span class="string">&quot;/**&quot;</span>)<span class="comment">//设置拦截器拦截的请求路径（ /** 表示拦截所有请求）</span></span><br><span class="line">                .<span class="title function_">excludePathPatterns</span>(<span class="string">&quot;/login&quot;</span>);<span class="comment">//设置不拦截的请求路径</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在拦截器中除了可以设置<code>/**</code>拦截所有资源外，还有一些常见拦截路径设置：</p><table><thead><tr><th>拦截路径</th><th>含义</th><th>举例</th></tr></thead><tbody><tr><td>/*</td><td>一级路径</td><td>能匹配/depts，/emps，/login，不能匹配 /depts/1</td></tr><tr><td>/**</td><td>任意级路径</td><td>能匹配/depts，/depts/1，/depts/1/2</td></tr><tr><td>/depts/*</td><td>/depts下的一级路径</td><td>能匹配/depts/1，不能匹配/depts/1/2，/depts</td></tr><tr><td>/depts/**</td><td>/depts下的任意级路径</td><td>能匹配/depts，/depts/1，/depts/1/2，不能匹配/emps/1</td></tr></tbody></table><ul><li>执行流程</li></ul><p>介绍完拦截路径的配置之后，接下来我们再来介绍拦截器的执行流程。通过执行流程，就能够清晰的知道过滤器与拦截器的执行时机。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-504-1024x348.png" alt="img"></p><ul><li>当我们打开浏览器来访问部署在web服务器当中的web应用时，此时我们所定义的过滤器会拦截到这次请求。拦截到这次请求之后，它会先执行放行前的逻辑，然后再执行放行操作。而由于我们当前是基于springboot开发的，所以放行之后是进入到了spring的环境当中，也就是要来访问我们所定义的controller当中的接口方法。</li><li>Tomcat并不识别所编写的Controller程序，但是它识别Servlet程序，所以在Spring的Web环境中提供了一个非常核心的Servlet：DispatcherServlet（前端控制器），所有请求都会先进行到DispatcherServlet，再将请求转给Controller。</li><li>当我们定义了拦截器后，会在执行Controller的方法之前，请求被拦截器拦截住。执行<code>preHandle()</code>方法，这个方法执行完成后需要返回一个布尔类型的值，如果返回true，就表示放行本次操作，才会继续访问controller中的方法；如果返回false，则不会放行（controller中的方法也不会执行）。</li><li>在controller当中的方法执行完毕之后，再回过来执行<code>postHandle()</code>这个方法以及<code>afterCompletion()</code> 方法，然后再返回给DispatcherServlet，最终再来执行过滤器当中放行后的这一部分逻辑的逻辑。执行完毕之后，最终给浏览器响应数据。</li></ul><p>以上就是拦截器的执行流程。通过执行流程分析，大家应该已经清楚了过滤器和拦截器之间的区别，其实它们之间的区别主要是两点：</p><ul><li><strong>接口规范不同：过滤器需要实现Filter接口，而拦截器需要实现HandlerInterceptor接口。</strong></li><li><strong>拦截范围不同：过滤器Filter会拦截所有的资源，而Interceptor只会拦截Spring环境中的资源。</strong></li></ul><h1 id="5-AOP（面向切面编程）">5.AOP（面向切面编程）</h1><h2 id="1-AOP基础">1.AOP基础</h2><h3 id="1-1AOP入门">1.1AOP入门</h3><p><strong>什么是AOP？</strong></p><p>AOP：Aspect Oriented Programming（面向切面编程、面向方面编程），其实说白了，面向切面编程就是面向特定方法编程。</p><p>那什么又是面向方法编程呢，为什么又需要面向方法编程呢？</p><p>来，我们举个例子做一个说明：</p><p>比如，我们这里有一个项目，项目中开发了很多的业务功能。然而有一些业务功能执行效率比较低，执行耗时较长，我们需要针对于这些业务方法进行优化。 那首先第一步就需要定位出执行耗时比较长的业务方法，再针对于业务方法再来进行优化。</p><p>此时我们就需要统计当前这个项目当中每一个业务方法的执行耗时。那么统计每一个业务方法的执行耗时该怎么实现？</p><p>可能多数人首先想到的就是在每一个业务方法运行之前，记录这个方法运行的开始时间。在这个方法运行完毕之后，再来记录这个方法运行的结束时间。拿结束时间减去开始时间，不就是这个方法的执行耗时吗。</p><p>而这个功能如果通过AOP来实现，我们只需要单独定义下面这一小段代码即可，不需要修改原始的任何业务方法即可记录每一个业务方法的执行耗时。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span> <span class="comment">//当前类为切面类</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RecordTimeAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;execution(* com.itheima.service.impl.DeptServiceImpl.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">recordTime</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">//记录方法执行开始时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//执行原始方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> pjp.proceed();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//记录方法执行结束时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//计算方法执行耗时</span></span><br><span class="line">        log.info(<span class="string">&quot;方法执行耗时: &#123;&#125;毫秒&quot;</span>,end-begin);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>常见的应用场景如下：</p><ul><li>记录系统的操作日志</li><li>权限控制</li><li>事务管理：我们前面所讲解的Spring事务管理，底层其实也是通过AOP来实现的，只要添加@Transactional注解之后，AOP程序自动会在原始方法运行前先来开启事务，在原始方法运行完毕之后提交或回滚事务</li></ul><p>这些都是AOP应用的典型场景。</p><p>所以，AOP的优势主要体现在以下四个方面：</p><ul><li>减少重复代码：不需要在业务方法中定义大量的重复性的代码，只需要将重复性的代码抽取到AOP程序中即可。</li><li>代码无侵入：在基于AOP实现这些业务功能时，对原有的业务代码是没有任何侵入的，不需要修改任何的业务代码。</li><li>提高开发效率</li><li>维护方便</li></ul><h3 id="1-2AOP核心概念">1.2AOP核心概念</h3><ul><li><p>连接点：JoinPoint</p><p>，可以被AOP控制的方法（暗含方法执行时的相关信息）</p><ul><li>连接点指的是可以被aop控制的方法。例如：入门程序当中所有的业务方法都是可以被aop控制的方法。</li><li>在SpringAOP提供的JoinPoint当中，封装了连接点方法在执行时的相关信息。（后面会有具体的讲解）</li></ul></li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-472.png" alt="img"></p><ul><li><p>通知：Advice</p><p>，指哪些重复的逻辑，也就是共性功能（最终体现为一个方法）</p><ul><li>在入门程序中是需要统计各个业务方法的执行耗时的，此时我们就需要在这些业务方法运行开始之前，先记录这个方法运行的开始时间，在每一个业务方法运行结束的时候，再来记录这个方法运行的结束时间。</li><li>是在AOP面向切面编程当中，我们只需要将这部分重复的代码逻辑抽取出来单独定义。抽取出来的这一部分重复的逻辑，也就是共性的功能。</li></ul></li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-473.png" alt="img"></p><ul><li><p>切入点：PointCut</p><p>，匹配连接点的条件，通知仅会在切入点方法执行时被应用。</p><ul><li>在通知当中，我们所定义的共性功能到底要应用在哪些方法上？此时就涉及到了切入点pointcut概念。切入点指的是匹配连接点的条件。通知仅会在切入点方法运行时才会被应用。</li><li>在aop的开发当中，我们通常会通过一个切入点表达式来描述切入点(后面会有详解)。</li><li>假如：切入点表达式改为DeptServiceImpl.list()，此时就代表仅仅只有list这一个方法是切入点。只有list()方法在运行的时候才会应用通知。</li></ul></li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-474.png" alt="img"></p><ul><li><strong>切面：Aspect</strong>，描述通知与切入点的对应关系（通知+切入点）</li></ul><p>当通知和切入点结合在一起，就形成了一个切面。通过切面就能够描述当前aop程序需要针对于哪个原始方法，在什么时候执行什么样的操作。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-505.png" alt="img"></p><p>而切面所在的类，称之为切面类（被<code>@Aspect</code>注解标识的类）。</p><ul><li><strong>目标对象：Target</strong>，通知所应用的对象</li></ul><p>目标对象指的就是通知所应用的对象，我们就称之为目标对象。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-506.png" alt="img"></p><p>AOP的核心概念我们介绍完毕之后，接下来我们再来分析一下我们所定义的通知是如何与目标对象结合在一起，对目标对象当中的方法进行功能增强的。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-507-1024x468.png" alt="img"></p><p>Spring的AOP底层是基于动态代理技术来实现的，也就是说在程序运行的时候，会自动的基于动态代理技术为目标对象生成一个对应的代理对象。在代理对象当中就会对目标对象当中的原始方法进行功能的增强。</p><p>SpringAOP 旨在管理bean对象的过程中，主要通过底层的动态代理机制，对特定的方法进行编程 。</p><h2 id="2-AOP进阶">2.AOP进阶</h2><h3 id="2-1通知类型">2.1通知类型</h3><p>在入门程序当中，我们已经使用了一种功能最为强大的通知类型：Around环绕通知。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span> <span class="comment">//当前类为切面类</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimeAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around(&quot;execution(* com.itheima.service.impl.DeptServiceImpl.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">recordTime</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">//记录方法执行开始时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//执行原始方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> pjp.proceed();</span><br><span class="line">        <span class="comment">//记录方法执行结束时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//计算方法执行耗时</span></span><br><span class="line">        log.info(<span class="string">&quot;方法执行耗时: &#123;&#125;毫秒&quot;</span>,end-begin);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>只要我们在通知方法上加上了<code>@Around</code>注解，就代表当前通知是一个环绕通知。</p><table><thead><tr><th><strong>Spring AOP 通知类型</strong></th><th></th></tr></thead><tbody><tr><td>@Around</td><td>环绕通知，此注解标注的通知方法在目标方法前、后都被执行</td></tr><tr><td>@Before</td><td>前置通知，此注解标注的通知方法在目标方法前被执行</td></tr><tr><td>@After</td><td>后置通知，此注解标注的通知方法在目标方法后被执行，无论是否有异常都会执行</td></tr><tr><td>@AfterReturning</td><td>返回后通知，此注解标注的通知方法在目标方法后被执行，有异常不会执行</td></tr><tr><td>@AfterThrowing</td><td>异常后通知，此注解标注的通知方法发生异常后执行</td></tr></tbody></table><p>下面我们通过代码演示，来加深对于不同通知类型的理解：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAspect1</span> &#123;</span><br><span class="line">    <span class="comment">//前置通知</span></span><br><span class="line">    <span class="meta">@Before(&quot;execution(* com.itheima.service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">(JoinPoint joinPoint)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;before ...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//环绕通知</span></span><br><span class="line">    <span class="meta">@Around(&quot;execution(* com.itheima.service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">around</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        log.info(<span class="string">&quot;around before ...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//调用目标对象的原始方法执行</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> proceedingJoinPoint.proceed();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//原始方法如果执行时有异常，环绕通知中的后置代码不会在执行了</span></span><br><span class="line">        </span><br><span class="line">        log.info(<span class="string">&quot;around after ...&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//后置通知</span></span><br><span class="line">    <span class="meta">@After(&quot;execution(* com.itheima.service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">(JoinPoint joinPoint)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;after ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回后通知（程序在正常执行的情况下，会执行的后置通知）</span></span><br><span class="line">    <span class="meta">@AfterReturning(&quot;execution(* com.itheima.service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterReturning</span><span class="params">(JoinPoint joinPoint)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;afterReturning ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//异常通知（程序在出现异常的情况下，执行的后置通知）</span></span><br><span class="line">    <span class="meta">@AfterThrowing(&quot;execution(* com.itheima.service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterThrowing</span><span class="params">(JoinPoint joinPoint)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;afterThrowing ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重新启动SpringBoot服务，进行测试：</p><p><strong>1). 没有异常情况下：</strong></p><p>使用 Apifox 测试查询所有部门数据</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-508-1024x541.png" alt="img"></p><p>查看idea中控制台日志输出：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-509-1024x194.png" alt="img"></p><blockquote><p>程序没有发生异常的情况下，@AfterThrowing标识的通知方法不会执行。</p></blockquote><p><strong>2). 出现异常情况下：</strong></p><p>修改DeptServiceImpl业务实现类中的代码： 添加异常</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_"><span class="keyword">class</span> <span class="title">DeptServiceImpl</span> <span class="keyword"><span class="keyword">implements</span> <span class="type">DeptService</span></span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DeptMapper deptMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Dept&gt; list() &#123;</span><br><span class="line"></span><br><span class="line">        List&lt;Dept&gt; deptList = deptMapper.list();</span><br><span class="line">        <span class="comment">//模拟异常</span></span><br><span class="line">        int num = <span class="number">10</span>/<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> deptList;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//省略其他代码...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重新启动SpringBoot服务，测试发生异常情况下通知的执行：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-510-1024x541.png" alt="img"></p><p>查看idea中控制台日志输出</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-511-1024x272.png" alt="img"></p><blockquote><p>程序发生异常的情况下：</p><ul><li>@AfterReturning标识的通知方法不会执行，@AfterThrowing标识的通知方法执行了</li><li>@Around环绕通知中原始方法调用时有异常，通知中的环绕后的代码逻辑也不会在执行了 （因为原始方法调用已经出异常了）</li></ul></blockquote><p>在使用通知时的注意事项：</p><ul><li><strong>@Around环绕通知需要自己调用 ProceedingJoinPoint.proceed() 来让原始方法执行</strong>，其他通知不需要考虑目标方法执行</li><li><strong>@Around环绕通知方法的返回值，必须指定为Object</strong>，来接收原始方法的返回值，否则原始方法执行完毕，是获取不到返回值的。</li></ul><p>五种常见的通知类型，我们已经测试完毕了，此时我们再来看一下刚才所编写的代码，有什么问题吗？</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//前置通知</span></span><br><span class="line"><span class="variable">@Before</span>(<span class="string">&quot;execution(* com.itheima.service.*.*(..))&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//环绕通知</span></span><br><span class="line"><span class="variable">@Around</span>(<span class="string">&quot;execution(* com.itheima.service.*.*(..))&quot;</span>)</span><br><span class="line">  </span><br><span class="line"><span class="comment">//后置通知</span></span><br><span class="line"><span class="variable">@After</span>(<span class="string">&quot;execution(* com.itheima.service.*.*(..))&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回后通知（程序在正常执行的情况下，会执行的后置通知）</span></span><br><span class="line"><span class="variable">@AfterReturning</span>(<span class="string">&quot;execution(* com.itheima.service.*.*(..))&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//异常通知（程序在出现异常的情况下，执行的后置通知）</span></span><br><span class="line"><span class="variable">@AfterThrowing</span>(<span class="string">&quot;execution(* com.itheima.service.*.*(..))&quot;</span>)</span><br></pre></td></tr></table></figure><p>我们发现啊，每一个注解里面都指定了切入点表达式，而且这些切入点表达式都一模一样。此时我们的代码当中就存在了大量的重复性的切入点表达式，假如此时切入点表达式需要变动，就需要将所有的切入点表达式一个一个的来改动，就变得非常繁琐了。</p><p>怎么来解决这个切入点表达式重复的问题？ 答案就是：<strong>抽取</strong></p><p><strong>Spring提供了<code>@PointCut</code>注解，该注解的作用是将公共的切入点表达式抽取出来，需要用到时引用该切入点表达式即可。</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAspect1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//切入点方法（公共的切入点表达式）</span></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(* com.itheima.service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">pt</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//前置通知（引用切入点）</span></span><br><span class="line">    <span class="meta">@Before(&quot;pt()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">(JoinPoint joinPoint)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;before ...&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//环绕通知</span></span><br><span class="line">    <span class="meta">@Around(&quot;pt()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">around</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        log.info(<span class="string">&quot;around before ...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//调用目标对象的原始方法执行</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> proceedingJoinPoint.proceed();</span><br><span class="line">        <span class="comment">//原始方法在执行时：发生异常</span></span><br><span class="line">        <span class="comment">//后续代码不在执行</span></span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;around after ...&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//后置通知</span></span><br><span class="line">    <span class="meta">@After(&quot;pt()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">(JoinPoint joinPoint)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;after ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回后通知（程序在正常执行的情况下，会执行的后置通知）</span></span><br><span class="line">    <span class="meta">@AfterReturning(&quot;pt()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterReturning</span><span class="params">(JoinPoint joinPoint)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;afterReturning ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//异常通知（程序在出现异常的情况下，执行的后置通知）</span></span><br><span class="line">    <span class="meta">@AfterThrowing(&quot;pt()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterThrowing</span><span class="params">(JoinPoint joinPoint)</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;afterThrowing ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要注意的是：<strong>当切入点方法使用<code>private</code>修饰时，仅能在当前切面类中引用该表达式， 当外部其他切面类中也要引用当前类中的切入点表达式，就需要把<code>private</code>改为<code>public</code></strong>，而在引用的时候，具体的语法为：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Slf4j</span></span><br><span class="line"><span class="variable">@Component</span></span><br><span class="line"><span class="variable">@Aspect</span></span><br><span class="line">public class MyAspect2 &#123;</span><br><span class="line">    <span class="comment">//引用MyAspect1切面类中的切入点表达式</span></span><br><span class="line">    <span class="variable">@Before</span>(<span class="string">&quot;com.itheima.aspect.MyAspect1.pt()&quot;</span>)</span><br><span class="line">    public void <span class="built_in">before</span>()&#123;</span><br><span class="line">        <span class="selector-tag">log</span><span class="selector-class">.info</span>(<span class="string">&quot;MyAspect2 -&gt; before ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2通知顺序">2.2通知顺序</h3><p>当在项目中，定义了多个切面类，而多个切面类中多个切入点都匹配到了同一个目标方法。此时当目标方法在运行的时候，这多个切面类当中的这些通知方法都会运行。</p><p>这多个通知方法到底哪个先运行，哪个后运行？ 下面我们通过程序来验证（这里呢，我们就定义两种类型的通知进行测试，一种是前置通知<code>@Before</code>，一种是后置通知<code>@After</code>）</p><p>定义多个切面类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAspect2</span> &#123;</span><br><span class="line">    <span class="comment">//前置通知</span></span><br><span class="line">    <span class="meta">@Before(&quot;execution(* com.itheima.service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;MyAspect2 -&gt; before ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//后置通知</span></span><br><span class="line">    <span class="meta">@After(&quot;execution(* com.itheima.service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;MyAspect2 -&gt; after ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAspect3</span> &#123;</span><br><span class="line">    <span class="comment">//前置通知</span></span><br><span class="line">    <span class="meta">@Before(&quot;execution(* com.itheima.service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;MyAspect3 -&gt; before ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//后置通知</span></span><br><span class="line">    <span class="meta">@After(&quot;execution(* com.itheima.service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;MyAspect3 -&gt;  after ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAspect4</span> &#123;</span><br><span class="line">    <span class="comment">//前置通知</span></span><br><span class="line">    <span class="meta">@Before(&quot;execution(* com.itheima.service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;MyAspect4 -&gt; before ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//后置通知</span></span><br><span class="line">    <span class="meta">@After(&quot;execution(* com.itheima.service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;MyAspect4 -&gt; after ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重新启动SpringBoot服务，测试通知的执行顺序：</p><blockquote><p>备注：</p><ol><li>把DeptServiceImpl实现类中模拟异常的代码删除或注释掉。</li><li>注释掉其他切面类(把<code>@Aspect</code>注释即可)，仅保留MyAspect2、MyAspect3、MyAspect4 ，这样就可以清晰看到执行的结果，而不被其他切面类干扰。</li></ol></blockquote><p>使用 Apifox 测试查询所有部门数据。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-512-1024x542.png" alt="img"></p><p>查看idea中控制台日志输出</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-513-1024x240.png" alt="img"></p><ul><li>通过以上程序运行可以看出在不同切面类中，默认按照切面类的类名字母排序：<ul><li>目标方法前的通知方法：字母排名靠前的先执行</li><li>目标方法后的通知方法：字母排名靠前的后执行</li></ul></li></ul><p>如果我们想控制通知的执行顺序有两种方式：</p><ol><li>修改切面类的类名（这种方式非常繁琐、而且不便管理）</li><li>使用Spring提供的<code>@Order</code>注解</li></ol><p>使用@Order注解，控制通知的执行顺序：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Order(2)</span>  <span class="comment">//切面类的执行顺序（前置通知：数字越小先执行; 后置通知：数字越小越后执行）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAspect2</span> &#123;</span><br><span class="line">    <span class="comment">//前置通知</span></span><br><span class="line">    <span class="meta">@Before(&quot;execution(* com.itheima.service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;MyAspect2 -&gt; before ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//后置通知 </span></span><br><span class="line">    <span class="meta">@After(&quot;execution(* com.itheima.service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;MyAspect2 -&gt; after ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Order(3)</span>  <span class="comment">//切面类的执行顺序（前置通知：数字越小先执行; 后置通知：数字越小越后执行）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAspect3</span> &#123;</span><br><span class="line">    <span class="comment">//前置通知</span></span><br><span class="line">    <span class="meta">@Before(&quot;execution(* com.itheima.service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;MyAspect3 -&gt; before ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//后置通知</span></span><br><span class="line">    <span class="meta">@After(&quot;execution(* com.itheima.service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;MyAspect3 -&gt;  after ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Order(1)</span> <span class="comment">//切面类的执行顺序（前置通知：数字越小先执行; 后置通知：数字越小越后执行）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAspect4</span> &#123;</span><br><span class="line">    <span class="comment">//前置通知</span></span><br><span class="line">    <span class="meta">@Before(&quot;execution(* com.itheima.service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;MyAspect4 -&gt; before ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//后置通知</span></span><br><span class="line">    <span class="meta">@After(&quot;execution(* com.itheima.service.*.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">after</span><span class="params">()</span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;MyAspect4 -&gt; after ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重新启动SpringBoot服务，测试通知执行顺序：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-514-1024x235.png" alt="img"></p><p><strong>通知的执行顺序大家主要知道两点即可：</strong></p><ol><li><strong>不同的切面类当中，默认情况下通知的执行顺序是与切面类的类名字母排序是有关系的</strong></li><li><strong>可以在切面类上面加上@Order注解，来控制不同的切面类通知的执行顺序</strong></li></ol><h3 id="2-3切点表达式">2.3切点表达式</h3><p>切入点表达式：描述切入点方法的一种表达式</p><ul><li>作用：主要用来决定项目中的哪些方法需要加入通知</li><li>常见形式：<ul><li>execution(……)：根据方法的签名来匹配</li><li>@annotation(……) ：根据注解匹配</li></ul></li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-497-1024x78.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-498-1024x74.png" alt="img"></p><h4 id="2-3-1execution">2.3.1execution</h4><p>execution主要根据方法的返回值、包名、类名、方法名、方法参数等信息来匹配，语法为：</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">execution</span>(访问修饰符?  返回值包名.类名.?方法名(方法参数) <span class="keyword">throws</span> 异常?)</span><br></pre></td></tr></table></figure><p>其中带<code>?</code>的表示可以省略的部分</p><ul><li>访问修饰符：可省略（比如: public、protected）</li><li>包名.类名： 可省略</li><li>throws 异常：可省略（注意是方法上声明抛出的异常，不是实际抛出的异常）</li></ul><p>示例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Before(&quot;execution(void com.itheima.service.impl.DeptServiceImpl.delete(java.lang.Integer))&quot;)</span></span><br></pre></td></tr></table></figure><p>可以使用通配符描述切入点</p><ul><li><code>*</code> ：单个独立的任意符号，可以通配任意返回值、包名、类名、方法名、任意类型的一个参数，也可以通配包、类、方法名的一部分</li><li><code>..</code> ：多个连续的任意符号，可以通配任意层级的包，或任意类型、任意个数的参数</li></ul><p>切入点表达式的语法规则：</p><ul><li>方法的访问修饰符可以省略</li><li>返回值可以使用<code>*</code>号代替（任意返回值类型）</li><li>包名可以使用<code>*</code>号代替，代表任意包（一层包使用一个<code>*</code>）</li><li>使用<code>..</code>配置包名，标识此包以及此包下的所有子包</li><li>类名可以使用<code>*</code>号代替，标识任意类</li><li>方法名可以使用<code>*</code>号代替，表示任意方法</li><li>可以使用 <code>*</code> 配置参数，一个任意类型的参数</li><li>可以使用<code>..</code> 配置参数，任意个任意类型的参数</li></ul><p><strong>切入点表达式示例</strong></p><ul><li>省略方法的修饰符号</li></ul><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution(<span class="type">void</span> com.itheima.service.impl.DeptServiceImpl.<span class="keyword">delete</span>(java.lang.Integer))</span><br></pre></td></tr></table></figure><ul><li>使用<code>*</code>代替返回值类型</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">execution</span><span class="params">(* com.itheima.service.impl.DeptServiceImpl.delete(java.lang.Integer)</span></span>)</span><br></pre></td></tr></table></figure><ul><li>使用<code>*</code>代替包名（一层包使用一个<code>*</code>）</li></ul><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution(<span class="name">*</span> com.itheima.*.*.DeptServiceImpl.delete(<span class="name">java</span>.lang.Integer))</span><br></pre></td></tr></table></figure><ul><li>使用<code>..</code>省略包名</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">execution</span><span class="params">(* com..DeptServiceImpl.delete(java.lang.Integer)</span></span>)  </span><br></pre></td></tr></table></figure><ul><li>使用<code>*</code>代替类名</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">execution</span><span class="params">(* com..*.delete(java.lang.Integer)</span></span>)</span><br></pre></td></tr></table></figure><ul><li>使用<code>*</code>代替方法名</li></ul><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution(<span class="name">*</span> com..*.*(<span class="name">java</span>.lang.Integer))</span><br></pre></td></tr></table></figure><ul><li>使用 <code>*</code> 代替参数</li></ul><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution<span class="comment">(* com.itheima.service.impl.DeptServiceImpl.delete(*)</span>)</span><br></pre></td></tr></table></figure><ul><li>使用<code>..</code>省略参数</li></ul><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution(<span class="name">*</span> com..*.*(..))</span><br></pre></td></tr></table></figure><p><strong>注意事项：</strong></p><ul><li>根据业务需要，可以使用 且（&amp;&amp;）、或（||）、非（!） 来组合比较复杂的切入点表达式。</li></ul><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution(* <span class="keyword">com</span>.itheima.service.DeptService<span class="meta">.list</span>(..)) || execution(* <span class="keyword">com</span>.itheima.service.DeptService.delete(..))</span><br></pre></td></tr></table></figure><p>切入点表达式的书写建议：</p><ul><li>所有业务方法名在命名时尽量规范，方便切入点表达式快速匹配。如：查询类方法都是 find 开头，更新类方法都是update开头</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//业务类</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">DeptService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">List</span>&lt;<span class="title class_">Dept</span>&gt; <span class="title function_">findAllDept</span>(<span class="params"></span>) &#123;</span><br><span class="line">       <span class="comment">//省略代码...</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Dept</span> <span class="title function_">findDeptById</span>(<span class="params"><span class="title class_">Integer</span> id</span>) &#123;</span><br><span class="line">       <span class="comment">//省略代码...</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">updateDeptById</span>(<span class="params"><span class="title class_">Integer</span> id</span>) &#123;</span><br><span class="line">       <span class="comment">//省略代码...</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">updateDeptByMoreCondition</span>(<span class="params"><span class="title class_">Dept</span> dept</span>) &#123;</span><br><span class="line">       <span class="comment">//省略代码...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//其他代码...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>//匹配DeptServiceImpl类中以find开头的方法</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">execution</span><span class="params">(* com.itheima.service.impl.DeptServiceImpl.find*(..)</span></span>)</span><br></pre></td></tr></table></figure><ul><li>描述切入点方法通常基于接口描述，而不是直接描述实现类，增强拓展性</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">execution</span><span class="params">(* com.itheima.service.DeptService.*(..)</span></span>)</span><br></pre></td></tr></table></figure><ul><li>在满足业务需要的前提下，尽量缩小切入点的匹配范围。如：包名匹配尽量不使用 …，使用 * 匹配单个包</li></ul><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execution(<span class="name">*</span> com.itheima.*.*.DeptServiceImpl.find*(..))</span><br></pre></td></tr></table></figure><blockquote><p><strong>切入点表达式书写建议：</strong></p><ul><li>所有业务方法名在命名时尽量规范，方便切入点表达式快速匹配。如：findXxx，updateXxx。</li><li>描述切入点方法通常基于接口描述，而不是直接描述实现类，增强拓展性。</li><li>在满足业务需要的前提下，尽量缩小切入点的匹配范围。如：包名尽量不使用…，使用 <code>*</code> 匹配单个包。</li></ul></blockquote><h4 id="2-3-2-annotation">2.3.2@annotation</h4><ol><li></li></ol><p>已经学习了execution切入点表达式的语法。那么如果我们要匹配多个无规则的方法，比如：list()和 delete()这两个方法。这个时候我们基于execution这种切入点表达式来描述就不是很方便了。而在之前我们是将两个切入点表达式组合在了一起完成的需求，这个是比较繁琐的。</p><p>我们可以借助于另一种切入点表达式 <code>@annotation</code> 来描述这一类的切入点，从而来简化切入点表达式的书写。</p><p>实现步骤：</p><ol><li>编写自定义注解</li><li>在业务类要做为连接点的方法上添加自定义注解</li></ol><p><strong>自定义注解</strong>：<code>LogOperation</code></p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="variable">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line">public <span class="variable">@interface</span> LogOperation&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>业务类</strong>：<code>DeptServiceImpl</code></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeptServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">DeptService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">DeptMapper</span> deptMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@LogOperation</span> <span class="comment">//自定义注解（表示：当前方法属于目标方法）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">List</span>&lt;<span class="title class_">Dept</span>&gt; <span class="title function_">list</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title class_">List</span>&lt;<span class="title class_">Dept</span>&gt; deptList = deptMapper.<span class="title function_">list</span>();</span><br><span class="line">        <span class="comment">//模拟异常</span></span><br><span class="line">        <span class="comment">//int num = 10/0;</span></span><br><span class="line">        <span class="keyword">return</span> deptList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@LogOperation</span> <span class="comment">//自定义注解（表示：当前方法属于目标方法）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">delete</span>(<span class="params"><span class="title class_">Integer</span> id</span>) &#123;</span><br><span class="line">        <span class="comment">//1. 删除部门</span></span><br><span class="line">        deptMapper.<span class="title function_">delete</span>(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">save</span>(<span class="params"><span class="title class_">Dept</span> dept</span>) &#123;</span><br><span class="line">        dept.<span class="title function_">setCreateTime</span>(<span class="title class_">LocalDateTime</span>.<span class="title function_">now</span>());</span><br><span class="line">        dept.<span class="title function_">setUpdateTime</span>(<span class="title class_">LocalDateTime</span>.<span class="title function_">now</span>());</span><br><span class="line">        deptMapper.<span class="title function_">save</span>(dept);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Dept</span> <span class="title function_">getById</span>(<span class="params"><span class="title class_">Integer</span> id</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> deptMapper.<span class="title function_">getById</span>(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">update</span>(<span class="params"><span class="title class_">Dept</span> dept</span>) &#123;</span><br><span class="line">        dept.<span class="title function_">setUpdateTime</span>(<span class="title class_">LocalDateTime</span>.<span class="title function_">now</span>());</span><br><span class="line">        deptMapper.<span class="title function_">update</span>(dept);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>切面类</strong></p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Slf4j</span></span><br><span class="line"><span class="variable">@Component</span></span><br><span class="line"><span class="variable">@Aspect</span></span><br><span class="line">public class MyAspect6 &#123;</span><br><span class="line">    <span class="comment">//针对list方法、delete方法进行前置通知和后置通知</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//前置通知</span></span><br><span class="line">    <span class="variable">@Before</span>(<span class="string">&quot;@annotation(com.itheima.anno.LogOperation)&quot;</span>)</span><br><span class="line">    public void <span class="built_in">before</span>()&#123;</span><br><span class="line">        <span class="selector-tag">log</span><span class="selector-class">.info</span>(<span class="string">&quot;MyAspect6 -&gt; before ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//后置通知</span></span><br><span class="line">    @<span class="selector-tag">After</span>(<span class="string">&quot;@annotation(com.itheima.anno.LogOperation)&quot;</span>)</span><br><span class="line">    <span class="selector-tag">public</span> <span class="selector-tag">void</span> <span class="selector-tag">after</span>()&#123;</span><br><span class="line">        <span class="selector-tag">log</span><span class="selector-class">.info</span>(<span class="string">&quot;MyAspect6 -&gt; after ...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重启SpringBoot服务，测试查询所有部门数据，查看控制台日志：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-503.png" alt="img"></p><p>到此两种常见的切入点表达式已经介绍完了。</p><ul><li>execution切入点表达式<ul><li>根据我们所指定的方法的描述信息来匹配切入点方法，这种方式也是最为常用的一种方式</li><li>如果我们要匹配的切入点方法的方法名不规则，或者有一些比较特殊的需求，通过execution切入点表达式描述比较繁琐</li></ul></li><li>annotation 切入点表达式<ul><li>基于注解的方式来匹配切入点方法。这种方式虽然多一步操作，我们需要自定义一个注解，但是相对来比较灵活。我们需要匹配哪个方法，就在方法上加上对应的注解就可以了</li></ul></li></ul><p>根据业务需要，可以使用 &amp;&amp; ，||，！ 来组合比较复杂的切入点表达式。</p><h2 id="3-AOP案例">3.AOP案例</h2><h3 id="3-1需求-3">3.1需求</h3><p>需求：将案例（Tlias智能学习辅助系统）中增、删、改相关接口的操作日志记录到数据库表中</p><ul><li>就是当访问部门管理和员工管理当中的增、删、改相关功能接口时，需要详细的操作日志，并保存在数据表中，便于后期数据追踪。</li></ul><p>操作日志信息包含：</p><ul><li>操作人、操作时间、执行方法的全类名、执行方法名、方法运行时参数、返回值、方法执行时长</li></ul><blockquote><p>所记录的日志信息包括当前接口的操作人是谁操作的，什么时间点操作的，以及访问的是哪个类当中的哪个方法，在访问这个方法的时候传入进来的参数是什么，访问这个方法最终拿到的返回值是什么，以及整个接口方法的运行时长是多长时间。</p></blockquote><h3 id="3-2分析">3.2分析</h3><ul><li>问题1：项目当中增删改相关的方法是不是有很多？<ul><li>很多</li></ul></li><li>问题2：我们需要针对每一个功能接口方法进行修改，在每一个功能接口当中都来记录这些操作日志吗？<ul><li>这种做法比较繁琐</li></ul></li></ul><p>以上两个问题的解决方案：可以使用AOP解决(每一个增删改功能接口中要实现的记录操作日志的逻辑代码是相同)。</p><p>可以把这部分记录操作日志的通用的、重复性的逻辑代码抽取出来定义在一个通知方法当中，我们通过AOP面向切面编程的方式，在不改动原始功能的基础上来对原始的功能进行增强。目前我们所增强的功能就是来记录操作日志，所以也可以使用AOP的技术来实现。使用AOP的技术来实现也是最为简单，最为方便的。</p><ul><li>问题3：既然要基于AOP面向切面编程的方式来完成的功能，那么我们要使用 AOP五种通知类型当中的哪种通知类型？<ul><li>答案：@Around【因为在获取方法执行时长时，需要在目标方法的前后都运行】</li></ul></li><li>问题4：最后一个问题，切入点表达式我们该怎么写？<ul><li>答案：@annotation【因为Controller层增、删、改执行方法的名称没有固定前缀/后缀，直接用方法名的话比较麻烦】</li></ul></li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-515.png" alt="img"></p><h3 id="3-3步骤">3.3步骤</h3><p>简单分析了一下大概的实现思路后，接下来我们就要来完成案例了。案例的实现步骤其实就两步：</p><p>定义切面类，完成记录操作日志的逻辑</p><ul><li>准备工作<ul><li>引入AOP的起步依赖</li><li>导入资料中准备好的数据库表结构，并引入对应的实体类</li></ul></li><li>编码实现(基于AI实现)<ul><li>自定义注解<code>@LogOperation</code></li><li>定义切面类，完成记录操作日志的逻辑</li></ul></li></ul><h3 id="3-4代码实现">3.4代码实现</h3><p><strong>1). 准备工作</strong></p><ul><li>在 pom.xml 中引入AOP的依赖</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>创建数据库表结构</li></ul><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 操作日志表</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> operate_log(</span><br><span class="line">    id <span class="type">int</span> unsigned <span class="keyword">primary key</span> auto_increment <span class="keyword">comment</span> <span class="string">&#x27;ID&#x27;</span>,</span><br><span class="line">    operate_emp_id <span class="type">int</span> unsigned <span class="keyword">comment</span> <span class="string">&#x27;操作人ID&#x27;</span>,</span><br><span class="line">    operate_time datetime <span class="keyword">comment</span> <span class="string">&#x27;操作时间&#x27;</span>,</span><br><span class="line">    class_name <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">comment</span> <span class="string">&#x27;操作的类名&#x27;</span>,</span><br><span class="line">    method_name <span class="type">varchar</span>(<span class="number">100</span>) <span class="keyword">comment</span> <span class="string">&#x27;操作的方法名&#x27;</span>,</span><br><span class="line">    method_params <span class="type">varchar</span>(<span class="number">1000</span>) <span class="keyword">comment</span> <span class="string">&#x27;方法参数&#x27;</span>,</span><br><span class="line">    return_value <span class="type">varchar</span>(<span class="number">2000</span>) <span class="keyword">comment</span> <span class="string">&#x27;返回值, 存储json格式&#x27;</span>,</span><br><span class="line">    cost_time <span class="type">int</span> <span class="keyword">comment</span> <span class="string">&#x27;方法执行耗时, 单位:ms&#x27;</span></span><br><span class="line">) <span class="keyword">comment</span> <span class="string">&#x27;操作日志表&#x27;</span>;</span><br></pre></td></tr></table></figure><ul><li>引入资料中准备的实体类</li></ul><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_"><span class="keyword">class</span> <span class="title">OperateLog</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id; <span class="comment">//ID</span></span><br><span class="line">    <span class="keyword">private</span> Integer operateEmpId; <span class="comment">//操作人ID</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime operateTime; <span class="comment">//操作时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> className; <span class="comment">//操作类名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> methodName; <span class="comment">//操作方法名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> methodParams; <span class="comment">//操作方法参数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">String</span> returnValue; <span class="comment">//操作方法返回值</span></span><br><span class="line">    <span class="keyword">private</span> Long costTime; <span class="comment">//操作耗时</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>引入资料中准备的日志操作Mapper接口 <code>OperateLogMapper</code></li></ul><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">package com.itheima.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.pojo.OperateLog;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Insert;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Mapper;</span><br><span class="line"></span><br><span class="line">@Mapper</span><br><span class="line">public interface OperateLogMapper &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="regexp">//</span>插入日志数据</span><br><span class="line">    @Insert(<span class="string">&quot;insert into operate_log (operate_emp_id, operate_time, class_name, method_name, method_params, return_value, cost_time) &quot;</span> +</span><br><span class="line">            <span class="string">&quot;values (<span class="subst">#&#123;operateEmpId&#125;</span>, <span class="subst">#&#123;operateTime&#125;</span>, <span class="subst">#&#123;className&#125;</span>, <span class="subst">#&#123;methodName&#125;</span>, <span class="subst">#&#123;methodParams&#125;</span>, <span class="subst">#&#123;returnValue&#125;</span>, <span class="subst">#&#123;costTime&#125;</span>);&quot;</span>)</span><br><span class="line">    public <span class="keyword">void</span> insert(OperateLog log);</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>1). 自定义注解</strong> <strong><code>@LogOperation</code></strong></p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  自定义注解，用于标识哪些方法需要记录日志</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="variable">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line">public <span class="variable">@interface</span> LogOperation &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2). 定义AOP记录日志的切面类</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.itheima.anno.LogOperation;</span><br><span class="line"><span class="keyword">import</span> com.itheima.mapper.OperateLogMapper;</span><br><span class="line"><span class="keyword">import</span> com.itheima.pojo.OperateLog;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OperationLogAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OperateLogMapper operateLogMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 环绕通知</span></span><br><span class="line">    <span class="meta">@Around(&quot;@annotation(log)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">around</span><span class="params">(ProceedingJoinPoint joinPoint, LogOperation log)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">// 记录开始时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// 执行方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> joinPoint.proceed();</span><br><span class="line">        <span class="comment">// 当前时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// 耗时</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">costTime</span> <span class="operator">=</span> endTime - startTime;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构建日志对象</span></span><br><span class="line">        <span class="type">OperateLog</span> <span class="variable">operateLog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OperateLog</span>();</span><br><span class="line">        operateLog.setOperateEmpId(getCurrentUserId()); <span class="comment">// 需要实现 getCurrentUserId 方法</span></span><br><span class="line">        operateLog.setOperateTime(LocalDateTime.now());</span><br><span class="line">        operateLog.setClassName(joinPoint.getTarget().getClass().getName());</span><br><span class="line">        operateLog.setMethodName(joinPoint.getSignature().getName());</span><br><span class="line">        operateLog.setMethodParams(Arrays.toString(joinPoint.getArgs()));</span><br><span class="line">        operateLog.setReturnValue(result.toString());</span><br><span class="line">        operateLog.setCostTime(costTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 插入日志</span></span><br><span class="line">        operateLogMapper.insert(operateLog);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 示例方法，获取当前用户ID</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getCurrentUserId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 这里应该根据实际情况从认证信息中获取当前登录用户的ID</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">// 示例返回值</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>3). 在需要记录的日志的<strong><strong>Controller层</strong></strong>的方法上，加上注解</strong> <strong><code>@LogOperation</code></strong></p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@RestController</span></span><br><span class="line"><span class="variable">@RequestMapping</span>(<span class="string">&quot;/clazzs&quot;</span>)</span><br><span class="line">public class ClazzController &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">@Autowired</span></span><br><span class="line">    private ClazzService clazzService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**     * 新增班级     */</span><span class="variable">@LogOperation</span></span><br><span class="line">    <span class="variable">@PostMapping</span></span><br><span class="line">    public Result <span class="built_in">save</span>(<span class="variable">@RequestBody</span> Clazz clazz)&#123;</span><br><span class="line">        <span class="selector-tag">clazzService</span><span class="selector-class">.save</span>(clazz);</span><br><span class="line">        <span class="selector-tag">return</span> <span class="selector-tag">Result</span><span class="selector-class">.success</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure><p>重启SpringBoot服务，测试操作日志记录功能：</p><p>打开浏览器，针对于员工的数据、部门的数据进行增删改之后。我们打开数据库表结构可以来看一下：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-499-1024x333.png" alt="img"></p><p>我们会看到，在数据库表中，就清晰的记录了谁、什么时间点、调用了哪个类的哪个方法、传入了什么参数、返回了什么数据，都清晰的记录在数据库中了。</p><h3 id="3-5连接点">3.5连接点</h3><p>连接点可以简单理解为可以被AOP控制的方法。</p><p>我们目标对象当中所有的方法是不是都是可以被AOP控制的方法。而在SpringAOP当中，连接点又特指方法的执行。</p><p>在Spring中用JoinPoint抽象了连接点，用它可以获得方法执行时的相关信息，如目标类名、方法名、方法参数等。</p><ul><li>对于<code>@Around</code>通知，获取连接点信息只能使用<code>ProceedingJoinPoint</code>类型</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-500-1024x467.png" alt="img"></p><ul><li>对于其他四种通知，获取连接点信息只能使用<code>JoinPoint</code>，它是<code>ProceedingJoinPoint</code>的父类型</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-501-1024x395.png" alt="img"></p><h3 id="3-6获取当前登录员工">3.6获取当前登录员工</h3><ol><li></li></ol><ul><li>员工登录成功后，哪里存储的有当前登录员工的信息？ 给客户端浏览器下发的jwt令牌中</li><li>如何从JWT令牌中获取当前登录用户的信息呢？ 获取请求头中传递的jwt令牌，并解析</li><li>TokenFilter 中已经解析了令牌的信息，如何传递给AOP程序、Controller、Service呢？ThreadLocal</li></ul><h4 id="3-6-1ThreadLocal">3.6.1ThreadLocal</h4><ul><li>ThreadLocal并不是一个Thread，而是Thread的局部变量。</li><li>ThreadLocal为每个线程提供一份单独的存储空间，具有线程隔离的效果，不同的线程之间不会相互干扰。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-516-1024x199.png" alt="img"></p><ul><li>常见方法：<ul><li><code>public void set(T value)</code> 设置当前线程的线程局部变量的值</li><li><code>public T get()</code> 返回当前线程所对应的线程局部变量的值</li><li><code>public void remove()</code> 移除当前线程的线程局部变量</li></ul></li></ul><h4 id="3-6-2记录当前登录员工">3.6.2记录当前登录员工</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-517-1024x327.png" alt="img"></p><p>具体操作步骤：</p><ol><li>定义ThreadLocal操作的工具类，用于操作当前登录员工ID。</li></ol><p>在 <code>com.itheima.utils</code> 引入工具类 <code>CurrentHolder</code></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">package com.itheima.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CurrentHolder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> final ThreadLocal&lt;Integer&gt; CURRENT_LOCAL = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setCurrentId</span>(<span class="params">Integer employeeId</span>)</span> &#123;</span><br><span class="line">        CURRENT_LOCAL.<span class="keyword">set</span>(employeeId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title">getCurrentId</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CURRENT_LOCAL.<span class="keyword">get</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">remove</span>()</span> &#123;</span><br><span class="line">        CURRENT_LOCAL.<span class="keyword">remove</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>在<code>TokenFilter</code>中，解析完当前登录员工ID，将其存入ThreadLocal（用完之后需将其删除）。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.utils.CurrentHolder;</span><br><span class="line"><span class="keyword">import</span> com.itheima.utils.JwtUtils;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.*;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.annotation.WebFilter;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@WebFilter(urlPatterns = &quot;/*&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TokenFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> (HttpServletRequest) servletRequest;</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> (HttpServletResponse) servletResponse;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1. 获取请求的url地址</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> request.getRequestURI(); <span class="comment">// /employee/login</span></span><br><span class="line">        <span class="comment">//String url = request.getRequestURL().toString(); // http://localhost:8080/employee/login</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 判断是否是登录请求, 如果url地址中包含 login, 则说明是登录请求, 放行</span></span><br><span class="line">        <span class="keyword">if</span> (uri.contains(<span class="string">&quot;login&quot;</span>)) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;登录请求, 放行&quot;</span>);</span><br><span class="line">            filterChain.doFilter(request, response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 获取请求中的token</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4. 判断token是否为空, 如果为空, 响应401状态码</span></span><br><span class="line">        <span class="keyword">if</span> (token == <span class="literal">null</span> || token.isEmpty()) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;token为空, 响应401状态码&quot;</span>);</span><br><span class="line">            response.setStatus(<span class="number">401</span>); <span class="comment">// 响应401状态码</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5. 如果token不为空, 调用JWtUtils工具类的方法解析token, 如果解析失败, 响应401状态码</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> JwtUtils.parseJWT(token);</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">empId</span> <span class="operator">=</span> Integer.valueOf(claims.get(<span class="string">&quot;id&quot;</span>).toString());</span><br><span class="line">            CurrentHolder.setCurrentId(empId);log.info(<span class="string">&quot;token解析成功, 放行&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;token解析失败, 响应401状态码&quot;</span>);</span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//6. 放行</span></span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//7. 清空当前线程绑定的id</span></span><br><span class="line">        CurrentHolder.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>在AOP程序中，从ThreadLocal中获取当前登录员工的ID。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.aop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.anno.LogOperation;</span><br><span class="line"><span class="keyword">import</span> com.itheima.mapper.OperateLogMapper;</span><br><span class="line"><span class="keyword">import</span> com.itheima.pojo.OperateLog;</span><br><span class="line"><span class="keyword">import</span> com.itheima.utils.CurrentHolder;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OperationLogAspect</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OperateLogMapper operateLogMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 环绕通知</span></span><br><span class="line">    <span class="meta">@Around(&quot;@annotation(log)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">around</span><span class="params">(ProceedingJoinPoint joinPoint, LogOperation log)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">// 记录开始时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// 执行方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> joinPoint.proceed();</span><br><span class="line">        <span class="comment">// 当前时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// 耗时</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">costTime</span> <span class="operator">=</span> endTime - startTime;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 构建日志对象</span></span><br><span class="line">        <span class="type">OperateLog</span> <span class="variable">operateLog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OperateLog</span>();</span><br><span class="line">        operateLog.setOperateEmpId(getCurrentUserId()); <span class="comment">// 需要实现 getCurrentUserId 方法</span></span><br><span class="line">        operateLog.setOperateTime(LocalDateTime.now());</span><br><span class="line">        operateLog.setClassName(joinPoint.getTarget().getClass().getName());</span><br><span class="line">        operateLog.setMethodName(joinPoint.getSignature().getName());</span><br><span class="line">        operateLog.setMethodParams(Arrays.toString(joinPoint.getArgs()));</span><br><span class="line">        operateLog.setReturnValue(result.toString());</span><br><span class="line">        operateLog.setCostTime(costTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 插入日志</span></span><br><span class="line">        operateLogMapper.insert(operateLog);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 示例方法，获取当前用户ID</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">getCurrentUserId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CurrentHolder.getCurrentId();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码优化完毕之后，我们重新启动服务测试。就可以看到，可以获取到不同的登录用户信息了。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-502-1024x448.png" alt="img"></p><p>在同一个线程/同一个请求中，进行数据共享就可以使用 ThreadLocal。</p><h1 id="完结">完结</h1>]]></content>
      
      
      <categories>
          
          <category> SSM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaWeb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaWeb+AI（基础篇）</title>
      <link href="/posts/10.html"/>
      <url>/posts/10.html</url>
      
        <content type="html"><![CDATA[<h1 id="1-Maven（基础）">1.Maven（基础）</h1><h2 id="1-1介绍">1.1介绍</h2><p>Maven 是一款用于管理和构建Java项目的工具，是Apache旗下的一个开源项目 。</p><h2 id="1-2-Maven的作用">1.2 Maven的作用</h2><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-218-1024x459.png" alt="img"></p><h3 id="1-2-1依赖管理">1.2.1依赖管理</h3><p>方便快捷的管理项目依赖的资源(jar包)，避免版本冲突问题。</p><h3 id="1-2-2项目构建">1.2.2项目构建</h3><p>Maven还提供了标准化的跨平台的自动化构建方式。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-219-1024x160.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-220-1024x328.png" alt="img"></p><ul><li>通过Maven中的命令，就可以很方便的完成项目的编译(compile)、测试(test)、打包(package)、发布(deploy) 等操作。</li><li>而且这些操作都是跨平台的，无论什么系统，这些命令都是支持的。</li></ul><h3 id="1-2-3统一项目结构">1.2.3统一项目结构</h3><p>Maven 还提供了标准、统一的项目结构 。</p><p>如果我们使用了Maven这一款项目构建工具，它给我们提供了一套标准的java项目目录。如下所示：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-221.png" alt="img"></p><p>也就意味着，无论我们使用的是什么开发工具，只要是基于maven构建的java项目，最终的目录结构都是相同的。</p><p>最后呢，一句话总结一下什么是Maven。 <strong>Maven就是一款管理和构建java项目的工具。</strong></p><h2 id="2-Maven概述">2.Maven概述</h2><h3 id="2-1Maven介绍">2.1Maven介绍</h3><p>Apache Maven是一个项目管理和构建工具，它基于项目对象模型(Project Object Model , 简称: POM)的概念，通过一小段描述信息来管理项目的构建、报告和文档。</p><p>官网：<a href="https://maven.apache.org/">https://maven.apache.org/</a></p><p>Maven的作用：</p><ol><li>方便的依赖管理</li><li>统一的项目结构</li><li>标准的项目构建流程</li></ol><h3 id="2-2Maven模型">2.2Maven模型</h3><ul><li>项目对象模型 (Project Object Model)</li><li>依赖管理模型(Dependency)</li><li>构建生命周期/阶段(Build lifecycle &amp; phases)</li></ul><p>1). 构建生命周期/阶段(Build lifecycle &amp; phases)</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-222-1024x429.png" alt="img"></p><p>以上图中紫色框起来的部分，就是用来完成标准化构建流程 。当我们需要编译，Maven提供了一个编译插件供我们使用；当我们需要打包，Maven就提供了一个打包插件供我们使用等。</p><p>2). 项目对象模型 (Project Object Model)</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-223-1024x431.png" alt="img"></p><p>以上图中紫色框起来的部分属于项目对象模型，就是将我们自己的项目抽象成一个对象模型，有自己专属的坐标，如下图所示是一个Maven项目：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-224-1024x498.png" alt="img"></p><p>坐标，就是资源(jar包)的唯一标识，通过坐标可以定位到所需资源(jar包)位置。</p><p>坐标的组成部分：</p><ul><li>groupId: 组织名</li><li>arfitactId: 模块名</li><li>Version: 版本号</li></ul><p>3). 依赖管理模型(Dependency)</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-225-1024x430.png" alt="img"></p><p>以上图中紫色框起来的部分属于依赖管理模型，是使用坐标来描述当前项目依赖哪些第三方jar包。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-226-1024x407.png" alt="img"></p><p>之前我们项目中需要jar包时，直接就把jar包复制到项目下的lib目录，而现在我们只需要在pom.xml中配置依赖的配置文件即可。 而这个依赖对应的jar包其实就在我们本地电脑上的maven仓库中。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-273-1024x452.png" alt="img"></p><h3 id="2-3Maven仓库">2.3Maven仓库</h3><p>仓库：用于存储资源，管理各种jar包</p><p><strong>仓库的本质</strong>就是一个目录(文件夹)，这个目录被用来存储开发中所有依赖(就是jar包)和插件</p><p>Maven仓库分为：</p><ul><li>本地仓库：自己计算机上的一个目录(用来存储jar包)</li><li>中央仓库：由Maven团队维护的全球唯一的。仓库地址：<a href="https://repo1.maven.org/maven2/">https://repo1.maven.org/maven2/</a></li><li>远程仓库(私服)：一般由公司团队搭建的私有仓库</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-227-1024x343.png" alt="img"></p><p>当项目中使用坐标引入对应依赖jar包后，</p><ul><li>首先会查找本地仓库中是否有对应的jar包<ul><li>如果有，则在项目直接引用</li><li>如果没有，则去中央仓库中下载对应的jar包到本地仓库</li></ul></li><li>如果还可以搭建远程仓库(私服)，将来jar包的查找顺序则变为： 本地仓库 --&gt; 远程仓库–&gt; 中央仓库</li></ul><h3 id="2-4Maven安装步骤">2.4Maven安装步骤</h3><ol><li>解压安装</li><li>配置仓库</li><li>配置阿里云私服</li><li>配置Maven环境变量</li></ol><h3 id="2-5Maven的配置">2.5Maven的配置</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-228-1024x619.png" alt="img"></p><h3 id="2-6创建项目">2.6创建项目</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-229.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-230-1024x535.png" alt="img"></p><h3 id="2-7pom文件详解">2.7pom文件详解</h3><p>POM (Project Object Model) ：指的是项目对象模型，用来描述当前的maven项目。</p><p><strong>pom文件详解：</strong></p><ul><li><p><code>&lt;project&gt;</code>：pom文件的根标签，表示当前maven项目</p></li><li><pre><code>&lt;modelVersion&gt;<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  ：声明项目描述遵循哪一个POM模型版本</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> 虽然模型本身的版本很少改变，但它仍然是必不可少的。目前POM模型版本是4.0.0</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 坐标 ：</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> <span class="code">`&lt;groupId&gt;`</span> <span class="code">`&lt;artifactId&gt;`</span> <span class="code">`&lt;version&gt;`</span></span><br><span class="line"><span class="bullet">  -</span> 定位项目在本地仓库中的位置，由以上三个标签组成一个坐标</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="code">`&lt;maven.compiler.source&gt;`</span> ：编译JDK的版本</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="code">`&lt;maven.compiler.target&gt;`</span> ：运行JDK的版本</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="code">`&lt;project.build.sourceEncoding&gt;`</span> : 设置项目的字符集</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-231-1024x766.png</span>)</span><br><span class="line"></span><br><span class="line"><span class="section">### 2.8Maven坐标</span></span><br><span class="line"></span><br><span class="line">什么是坐标？</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> Maven中的坐标是<span class="strong">**资源**</span><span class="strong">**的唯一标识**</span> , 通过该坐标可以唯一定位资源位置</span><br><span class="line"><span class="bullet">-</span> 使用坐标来定义项目或引入项目中需要的依赖</span><br><span class="line"></span><br><span class="line">Maven坐标主要组成：</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> groupId：定义当前Maven项目隶属组织名称（通常是域名反写，例如：com.itheima）</span><br><span class="line"><span class="bullet">-</span> artifactId：定义当前Maven项目名称（通常是模块名称，例如 order-service、goods-service）</span><br><span class="line"><span class="bullet">-</span> version：定义当前项目版本号</span><br><span class="line"><span class="bullet">  -</span> SNAPSHOT: 功能不稳定、尚处于开发中的版本，即快照版本</span><br><span class="line"><span class="bullet">  -</span> RELEASE: 功能趋于稳定、当前更新停止，可以用于发行的版本</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-232.png</span>)</span><br><span class="line"></span><br><span class="line"><span class="strong">**注意：**</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 上面所说的资源可以是插件、依赖、当前项目。</span><br><span class="line"><span class="bullet">-</span> 我们的项目如果被其他的项目依赖时，也是需要坐标来引入的。</span><br><span class="line"></span><br><span class="line"><span class="section">## 3.依赖管理</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 3.1依赖配置</span></span><br><span class="line"></span><br><span class="line"><span class="section">#### 3.1.1基本配置</span></span><br><span class="line"></span><br><span class="line">依赖：指当前项目运行所需要的jar包。一个项目中可以引入多个依赖：</span><br><span class="line"></span><br><span class="line">例如：引入logback日志的依赖。具体步骤如下：</span><br><span class="line"></span><br><span class="line"><span class="bullet">1.</span> 在pom.xml中编写<span class="code">`&lt;dependencies&gt;`</span>标签</span><br><span class="line"><span class="bullet">2.</span> 在<span class="code">`&lt;dependencies&gt;`</span>标签中使用<span class="code">`&lt;dependency&gt;`</span>引入坐标</span><br><span class="line"><span class="bullet">3.</span> 定义坐标的 <span class="code">`groupId`</span>、<span class="code">`artifactId`</span>、<span class="code">`version`</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></code></pre></li></ul><dependencies>    <!-- 依赖 : spring-context -->    <dependency>        <groupId>org.springframework</groupId>        <artifactId>spring-context</artifactId>        <version>6.1.4</version>    </dependency></dependencies><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">4</span>.点击刷新按钮，引入最新加入的坐标</span><br><span class="line"></span><br><span class="line">#### <span class="number">3.1</span><span class="selector-class">.2</span>查找依赖</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>.利用中央仓库搜索的依赖坐标</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>.利用<span class="selector-tag">IDEA</span>工具搜索依赖</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>.插件(maven search)</span><br><span class="line"></span><br><span class="line">#### <span class="number">3.1</span><span class="selector-class">.3</span>依赖传递</span><br><span class="line"></span><br><span class="line">我们上面在<span class="selector-tag">pom</span><span class="selector-class">.xml</span>中配置了一项依赖，就是<span class="selector-tag">spring-context</span>，但是我们通过右侧的<span class="selector-tag">maven</span>面板可以看到，其实引入进来的依赖，并不是这一项，有非常多的依赖。</span><br><span class="line"></span><br><span class="line">为什么会出现这样的现象呢? 那这里呢，就涉及到<span class="selector-tag">maven</span>中非常重要的一个特性，那就是<span class="selector-tag">Maven</span>中的**依赖传递**。</span><br><span class="line"></span><br><span class="line">所谓<span class="selector-tag">maven</span>的依赖传递，指的就是如果在<span class="selector-tag">maven</span>项目中，<span class="selector-tag">A</span> 依赖了<span class="selector-tag">B</span>，<span class="selector-tag">B</span>依赖了<span class="selector-tag">C</span>，<span class="selector-tag">C</span>依赖了<span class="selector-tag">D</span>，那么在<span class="selector-tag">A</span>项目中，也会有<span class="selector-tag">C</span>、<span class="selector-tag">D</span>依赖，因为依赖会传递。</span><br><span class="line"></span><br><span class="line">那如果，传递下来的依赖，在项目开发中，我们确实不需要，此时，我们可以通过<span class="selector-tag">Maven</span>中的排除依赖功能，来将这个依赖排除掉。</span><br><span class="line"></span><br><span class="line">#### <span class="number">3.1</span><span class="selector-class">.4</span>排除依赖</span><br><span class="line"></span><br><span class="line">排除依赖：指主动断开依赖的资源，被排除的资源无需指定版本。</span><br><span class="line"></span><br><span class="line">!<span class="selector-attr">[img]</span>(<span class="attribute">https</span>:<span class="comment">//www.legendkiller.xyz/wp-content/uploads/2025/06/image-233.png)</span></span><br><span class="line"></span><br><span class="line">### <span class="number">3.2</span>生命周期</span><br><span class="line"></span><br><span class="line">Maven的生命周期就是为了对所有的构建过程进行抽象和统一。 描述了一次项目构建，经历哪些阶段。</span><br><span class="line"></span><br><span class="line">Maven从大量项目和构建工具中学习和反思，然后总结了一套高度完美的，易扩展的项目构建生命周期。这个生命周期包含了项目的清理，初始化，编译，测试，打包，集成测试，验证，部署和站点生成等几乎所有构建步骤。</span><br><span class="line"></span><br><span class="line">Maven对项目构建的生命周期划分为<span class="number">3</span>套（相互独立）：</span><br><span class="line"></span><br><span class="line">![img](<span class="attribute">https</span>:<span class="comment">//www.legendkiller.xyz/wp-content/uploads/2025/06/image-274-1024x171.png)</span></span><br><span class="line"></span><br><span class="line">- clean：清理工作。</span><br><span class="line">- default：核心工作。如：编译、测试、打包、安装、部署等。</span><br><span class="line">- site：生成报告、发布站点等。</span><br><span class="line"></span><br><span class="line">![img](<span class="attribute">https</span>:<span class="comment">//www.legendkiller.xyz/wp-content/uploads/2025/06/image-234-1024x482.png)</span></span><br><span class="line"></span><br><span class="line">主要关注以下几个：</span><br><span class="line"></span><br><span class="line">- clean：移除上一次构建生成的文件</span><br><span class="line">- compile：编译项目源代码</span><br><span class="line">- test：使用合适的单元测试框架运行测试(junit)</span><br><span class="line">- package：将编译后的文件打包，如：jar、war等</span><br><span class="line">- install：安装项目到本地仓库</span><br><span class="line"></span><br><span class="line">- 生命周期的顺序是：<span class="built_in">`clean`</span> --&gt; <span class="built_in">`validate`</span> --&gt; <span class="built_in">`compile`</span> --&gt; <span class="built_in">`test`</span> --&gt; <span class="built_in">`package`</span> --&gt; <span class="built_in">`verify`</span> --&gt; <span class="built_in">`install`</span> --&gt; <span class="built_in">`site`</span> --&gt; <span class="built_in">`deploy`</span></span><br><span class="line">- 我们需要关注的就是：<span class="built_in">`clean`</span> --&gt; <span class="built_in">`compile`</span> --&gt; <span class="built_in">`test`</span> --&gt; <span class="built_in">`package`</span> --&gt; <span class="built_in">`install`</span></span><br><span class="line"></span><br><span class="line">执行方式：</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>.**在idea中执行生命周期**</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>.**在命令行中执行生命周期**</span><br><span class="line"></span><br><span class="line">- mvn compile</span><br><span class="line">- mvn test</span><br><span class="line">- mvn package</span><br><span class="line">- mvn install</span><br><span class="line"></span><br><span class="line">## <span class="number">4</span>.单元测试</span><br><span class="line"></span><br><span class="line">### <span class="number">4.1</span>介绍</span><br><span class="line"></span><br><span class="line">**测试：**是一种用来促进鉴定软件的正确性、完整性、安全性和质量的过程。</span><br><span class="line"></span><br><span class="line">**阶段划分：**单元测试、集成测试、系统测试、验收测试。</span><br><span class="line"></span><br><span class="line">![img](<span class="attribute">https</span>:<span class="comment">//www.legendkiller.xyz/wp-content/uploads/2025/06/image-235-1024x246.png)</span></span><br><span class="line"></span><br><span class="line">**测试方法：**白盒测试、黑盒测试 及 灰盒测试</span><br><span class="line"></span><br><span class="line">![img](<span class="attribute">https</span>:<span class="comment">//www.legendkiller.xyz/wp-content/uploads/2025/06/image-236-1024x226.png)</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span>). 白盒测试</span><br><span class="line"></span><br><span class="line">清楚软件内部结构、代码逻辑。用于验证代码、逻辑正确性。</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>). 黑盒测试</span><br><span class="line"></span><br><span class="line">不清楚软件内部结构、代码逻辑。用于验证软件的功能、兼容性、验收测试等方面。</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>). 灰盒测试</span><br><span class="line"></span><br><span class="line">结合了白盒测试和黑盒测试的特点，既关注软件的内部结构又考虑外部表现（功能）。</span><br><span class="line"></span><br><span class="line">### <span class="number">4.2</span>Junit入门</span><br><span class="line"></span><br><span class="line">- 单元测试：就是针对最小的功能单元(方法)，编写测试代码对其正确性进行测试。</span><br><span class="line">- JUnit：最流行的Java测试框架之一，提供了一些功能，方便程序进行单元测试（第三方公司提供）。</span><br><span class="line"></span><br><span class="line">#### <span class="number">4.2</span>.<span class="number">1</span>为什么使用Junit？</span><br><span class="line"></span><br><span class="line">通过**main方法**是可以进行测试的，可以测试程序是否正常运行。但是main方法进行测试时，会存在如下问题：</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>. 测试代码与源代码未分开，难维护。</span><br><span class="line"><span class="number">2</span>. 一个方法测试失败，影响后面方法。</span><br><span class="line"><span class="number">3</span>. 无法自动化测试，得到测试报告。</span><br><span class="line"></span><br><span class="line">而如果我们使用了**JUnit单元测试**框架进行测试，将会有以下优势：</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>. 测试代码与源代码分开，便于维护。</span><br><span class="line"><span class="number">2</span>. 可根据需要进行自动化测试。</span><br><span class="line"><span class="number">3</span>. 可自动分析测试结果，产出测试报告。</span><br><span class="line"></span><br><span class="line">#### <span class="number">4.2</span>.<span class="number">2</span>断言</span><br><span class="line"></span><br><span class="line">JUnit提供了一些辅助方法，用来帮我们确定被测试的方法是否按照预期的效果正常工作，这种方式称为**断言**。</span><br><span class="line"></span><br><span class="line">| 断言方法                                              | 描述                                       |</span><br><span class="line">| ----------------------------------------------------- | ------------------------------------------ |</span><br><span class="line">| <span class="built_in">assertEquals</span>(Object exp, Object act, String msg)      | 检查两个值是否相等，不相等就报错。         |</span><br><span class="line">| <span class="built_in">assertNotEquals</span>(Object unexp, Object act, String msg) | 检查两个值是否不相等，相等就报错。         |</span><br><span class="line">| <span class="built_in">assertNull</span>(Object act, String msg)                    | 检查对象是否为null，不为null，就报错。     |</span><br><span class="line">| <span class="built_in">assertNotNull</span>(Object act, String msg)                 | 检查对象是否不为null，为null，就报错。     |</span><br><span class="line">| <span class="built_in">assertTrue</span>(boolean condition, String msg)             | 检查条件是否为true，不为true，就报错。     |</span><br><span class="line">| <span class="built_in">assertFalse</span>(boolean condition, String msg)            | 检查条件是否为false，不为false，就报错。   |</span><br><span class="line">| <span class="built_in">assertSame</span>(Object exp, Object act, String msg)        | 检查两个对象引用是否相等，不相等，就报错。 |</span><br><span class="line"></span><br><span class="line">使用断言的原因：</span><br><span class="line"></span><br><span class="line">- <span class="number">1</span>、单元测试方法运行不报错，不代表业务方法没问题；</span><br><span class="line">- <span class="number">2</span>、通过断言看可以检测方法运行结果是否和预期一致，从而判断业务方法逻辑的正确性；</span><br><span class="line"></span><br><span class="line">#### <span class="number">4.2</span>.<span class="number">3</span>常见注解</span><br><span class="line"></span><br><span class="line">在JUnit中还提供了一些注解，还增强其功能，常见的注解有以下几个：</span><br><span class="line"></span><br><span class="line">| 注解               | 说明                                                         | 备注                            |</span><br><span class="line">| ------------------ | ------------------------------------------------------------ | ------------------------------- |</span><br><span class="line">| <span class="variable">@Test</span>              | 测试类中的方法用它修饰才能成为测试方法，才能启动执行         | 单元测试                        |</span><br><span class="line">| <span class="variable">@BeforeEach</span>        | 用来修饰一个实例方法，该方法会在每一个测试方法执行之前执行一次。 | 初始化资源(准备工作)            |</span><br><span class="line">| <span class="variable">@AfterEach</span>         | 用来修饰一个实例方法，该方法会在每一个测试方法执行之后执行一次。 | 释放资源(清理工作)              |</span><br><span class="line">| <span class="variable">@BeforeAll</span>         | 用来修饰一个静态方法，该方法会在所有测试方法之前只执行一次。 | 初始化资源(准备工作)            |</span><br><span class="line">| <span class="variable">@AfterAll</span>          | 用来修饰一个静态方法，该方法会在所有测试方法之后只执行一次。 | 释放资源(清理工作)              |</span><br><span class="line">| <span class="variable">@ParameterizedTest</span> | 参数化测试的注解 (可以让单个测试运行多次，每次运行时仅参数不同) | 用了该注解，就不需要<span class="variable">@Test</span>注解了 |</span><br><span class="line">| <span class="variable">@ValueSource</span>       | 参数化测试的参数来源，赋予测试方法参数                       | 与参数化测试注解配合使用        |</span><br><span class="line">| <span class="variable">@DisplayName</span>       | 指定测试类、测试方法显示的名称 （默认为类名、方法名）        |                                 |</span><br><span class="line"></span><br><span class="line">演示 <span class="built_in">`@BeforeEach`</span>，<span class="built_in">`@AfterEach`</span>，<span class="built_in">`@BeforeAll`</span>，<span class="built_in">`@AfterAll`</span> 注解：</span><br><span class="line"></span><br></pre></td></tr></table></figure>public class UserServiceTest {<pre><code>@BeforeEachpublic void testBefore()&#123;    System.out.println(&quot;before...&quot;);&#125;@AfterEachpublic void testAfter()&#123;    System.out.println(&quot;after...&quot;);&#125;@BeforeAll //该方法必须被static修饰public static void testBeforeAll()&#123;     System.out.println(&quot;before all ...&quot;);&#125;@AfterAll //该方法必须被static修饰public static void testAfterAll()&#123;    System.out.println(&quot;after all...&quot;);&#125;@Testpublic void testGetAge()&#123;    Integer age = new UserService().getAge(&quot;110002200505091218&quot;);    System.out.println(age);&#125;@Testpublic void testGetGender()&#123;    String gender = new UserService().getGender(&quot;612429198904201611&quot;);    System.out.println(gender);&#125;</code></pre><p>}</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-237-1024x284.png</span>)</span><br><span class="line"></span><br><span class="line"><span class="strong">**在maven项目中，test目录存放单元测试的代码，是否可以在main目录中编写单元测试呢 ？**</span> </span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-238.png</span>)</span><br><span class="line"></span><br><span class="line">可以，但是不规范</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">#### 4.2.4依赖范围</span></span><br><span class="line"></span><br><span class="line">依赖的jar包，默认情况下，可以在任何地方使用，在main目录下，可以使用；在test目录下，也可以使用。</span><br><span class="line"></span><br><span class="line">在maven中，如果希望限制依赖的使用范围，可以通过 <span class="code">`&lt;scope&gt;…&lt;/scope&gt;`</span> 设置其作用范围。</span><br><span class="line"></span><br><span class="line"><span class="strong">**作用范围：**</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 主程序范围有效。（main文件夹范围内）</span><br><span class="line"><span class="bullet">-</span> 测试程序范围有效。（test文件夹范围内）</span><br><span class="line"><span class="bullet">-</span> 是否参与打包运行。（package指令范围内）</span><br><span class="line"></span><br><span class="line">scope的取值常见的如下：</span><br><span class="line"></span><br><span class="line">| scope值         | 主程序 | 测试程序 | 打包（运行） | 范例        |</span><br><span class="line">| --------------- | ------ | -------- | ------------ | ----------- |</span><br><span class="line">| compile（默认） | Y      | Y        | Y            | log4j       |</span><br><span class="line">| test            | -      | Y        | -            | junit       |</span><br><span class="line">| provided        | Y      | Y        | -            | servlet-api |</span><br><span class="line">| runtime         | -      | Y        | Y            | jdbc驱动    |</span><br><span class="line"></span><br><span class="line"><span class="section"># 2.Web后端基础</span></span><br><span class="line"></span><br><span class="line"><span class="section">## 1基础知识</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 1.1静态资源和动态资源</span></span><br><span class="line"></span><br><span class="line">像HTML、CSS、JS 以及图片、音频、视频等这些资源，我们都称为<span class="strong">**静态资源**</span>。 所谓静态资源，就是指在服务器上存储的不会改变的数据，通常不会根据用户的请求而变化。</span><br><span class="line"></span><br><span class="line">那与静态资源对应的还有一类资源，就是动态资源。那所谓<span class="strong">**动态资源**</span>，就是指在服务器端上存储的，会根据用户请求和其他数据动态生成的，内容可能会在每次请求时都发生变化。比如：Servlet、JSP等(负责逻辑处理)。而Servlet、JSP这些技术现在早都被企业淘汰了，现在在企业项目开发中，都是直接基于Spring框架来构建动态资源。</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-250-1024x307.png</span>)</span><br><span class="line"></span><br><span class="line">而对于我们java程序开发的动态资源来说，我们通常会将这些动态资源部署在<span class="strong">**Tomcat**</span>，这样的Web服务器中运行。 而浏览器与服务器在通信的时候，基本都是基于HTTP协议的。</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-251-1024x302.png</span>)</span><br><span class="line"></span><br><span class="line">那上述所描述的这种浏览器/服务器的架构模式呢，我们称之为：<span class="strong">**BS架构**</span>。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> BS架构：Browser/Server，浏览器/服务器架构模式。客户端只需要浏览器，应用程序的逻辑和数据都存储在服务端。</span><br><span class="line"><span class="bullet">  -</span> 优点：维护方便</span><br><span class="line"><span class="bullet">  -</span> 缺点：体验一般</span><br><span class="line"><span class="bullet">-</span> CS架构：Client/Server，客户端/服务器架构模式。需要单独开发维护客户端。</span><br><span class="line"><span class="bullet">  -</span> 优点：体验不错</span><br><span class="line"><span class="bullet">  -</span> 缺点：开发维护麻烦</span><br><span class="line"></span><br><span class="line"><span class="section">### 1.2 Spring框架</span></span><br><span class="line"></span><br><span class="line"><span class="section">#### 1.2.1 什么是Spring</span></span><br><span class="line"></span><br><span class="line">我们可以打开Spring的官网(https://spring.io)，去看一下Spring的简介：Spring makes Java simple。</span><br><span class="line"></span><br><span class="line">Spring的官方提供很多开源的项目，我们可以点击上面的projects，看到spring家族旗下的项目，按照流行程度排序为：</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-239-1024x605.png</span>)</span><br><span class="line"></span><br><span class="line">而Spring家族旗下这么多的技术，最基础、最核心的是 SpringFramework。其他的spring家族的技术，都是基于SpringFramework的，SpringFramework中提供很多实用功能，如：依赖注入、事务管理、web开发支持、数据访问、消息服务等等。</span><br><span class="line"></span><br><span class="line">而如果我们在项目中，直接基于<span class="strong">**SpringFramework**</span>进行开发，存在两个问题：</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 配置繁琐</span><br><span class="line"><span class="bullet">-</span> 入门难度大</span><br><span class="line"></span><br><span class="line">所以基于此，spring官方推荐我们从另外一个项目开始学习，那就是SpringBoot。 通过springboot就可以快速的帮我们构建应用程序，所以<span class="strong">**springboot**</span>呢，最大的特点有两个 ：</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 简化配置</span><br><span class="line"><span class="bullet">-</span> 快速开发</span><br><span class="line"></span><br><span class="line"><span class="strong">**Spring Boot 可以帮助我们非常快速的构建应用程序、简化开发、提高效率 。**</span></span><br><span class="line"></span><br><span class="line">1.2.2 常见问题</span><br><span class="line"></span><br><span class="line">联网基于spring的脚手架创建SpringBoot项目，偶尔可能会因为网内网络的原因，链接不上SpringBoot的脚手架网站，此时会出现如下现象：</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-240.png</span>)</span><br><span class="line"></span><br><span class="line">此时可以使用阿里云提供的脚手架，网址为：https://start.aliyun.com</span><br><span class="line"></span><br><span class="line"><span class="section">#### 1.2.3 SpringBootWeb入门解析</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**1). 为什么一个main方法就可以将Web应用启动了？**</span></span><br><span class="line"></span><br><span class="line">答：因为我们在创建springboot项目的时候，选择了web开发的<span class="strong">**起步依赖**</span> <span class="code">`spring-boot-starter-web`</span>。<span class="strong">**而`spring-boot-starter-web`依赖，又依赖了`spring-boot-starter-tomcat`**</span>，由于maven的依赖传递特性，那么在我们创建的springboot项目中也就已经有了tomcat的依赖，这个其实就是springboot中内嵌的tomcat。</span><br><span class="line"></span><br><span class="line">而我们运行引导类中的main方法，其实启动的就是springboot中内嵌的Tomcat服务器。 而我们所开发的项目，也会自动的部署在该tomcat服务器中，并占用8080端口号 。</span><br><span class="line"></span><br><span class="line">关于起步依赖：</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-241.png</span>)</span><br><span class="line"></span><br><span class="line"><span class="section">### 1.3HTTP协议</span></span><br><span class="line"></span><br><span class="line"><span class="section">#### 1.3.1介绍</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**HTTP**</span>：Hyper Text Transfer Protocol(超文本传输协议)，规定了浏览器与服务器之间数据传输的规则。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> http是互联网上应用最为广泛的一种网络协议</span><br><span class="line"><span class="bullet">-</span> http协议要求：浏览器在向服务器发送请求数据时，或是服务器在向浏览器发送响应数据时，<span class="strong">**都必须按照固定的格式进行数据传输**</span></span><br><span class="line"></span><br><span class="line"><span class="section">#### 1.3.2HTTP协议的特点</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**基于TCP协议:**</span> 面向连接，安全</span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; TCP是一种面向连接的(建立连接之前是需要经过三次握手)、可靠的、基于字节流的传输层通信协议，在数据传输方面更安全</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**基于请求-响应模型:**</span> 一次请求对应一次响应（先请求后响应）</span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; 请求和响应是一一对应关系，没有请求，就没有响应</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**HTTP协议是无状态协议:**</span> 对于数据没有记忆能力。每次请求-响应都是独立的</span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; 无状态指的是客户端发送HTTP请求给服务端之后，服务端根据请求响应数据，响应完后，不会记录任何信息。</span></span><br><span class="line"><span class="quote">&gt;</span></span><br><span class="line"><span class="quote">&gt; - 缺点: 多次请求间不能共享数据</span></span><br><span class="line"><span class="quote">&gt; - 优点: 速度快</span></span><br><span class="line"><span class="quote">&gt;</span></span><br><span class="line"><span class="quote">&gt; - 请求之间无法共享数据会引发的问题：</span></span><br><span class="line"><span class="quote">&gt;   - 如：京东购物。加入购物车和去购物车结算是两次请求</span></span><br><span class="line"><span class="quote">&gt;   - 由于HTTP协议的无状态特性，加入购物车请求响应结束后，并未记录加入购物车是何商品</span></span><br><span class="line"><span class="quote">&gt;   - 发起去购物车结算的请求后，因为无法获取哪些商品加入了购物车，会导致此次请求无法正确展示数据</span></span><br><span class="line"><span class="quote">&gt;</span></span><br><span class="line"><span class="quote">&gt; - 具体使用的时候，我们发现京东是可以正常展示数据的，原因是Java早已考虑到这个问题，并提出了使用会话技术(Cookie、Session)来解决这个问题。具体如何来做，后面会讲到。</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**HTTP协议又分为：请求协议和响应协议**</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 1.4HTTP请求协议</span></span><br><span class="line"></span><br><span class="line"><span class="section">#### 1.4.1介绍</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**请求协议：**</span>浏览器将数据以请求格式发送到服务器。包括：<span class="strong">**请求行、请求头 、请求体**</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**GET方式的请求协议：**</span></span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-249-1024x174.png</span>)</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 请求行</span><br><span class="line"></span><br><span class="line">  (以上图中红色部分) ：HTTP请求中的第一行数据。由：</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>请求方式</p>  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">、</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>资源路径</p>  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">、</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>协议/版本</p>  <figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  组成（之间使用空格分隔）</span><br><span class="line"></span><br><span class="line">  - 请求方式：GET</span><br><span class="line">  - 资源路径：/brand/findAll?name=OPPO&amp;status=1</span><br><span class="line">    - 请求路径：/brand/findAll</span><br><span class="line">    - 请求参数：name=OPPO&amp;status=1</span><br><span class="line">      - 请求参数是以key=value形式出现</span><br><span class="line">      - 多个请求参数之间使用`&amp;`连接</span><br><span class="line">    - 请求路径和请求参数之间使用`?`连接</span><br><span class="line">  - 协议/版本：HTTP/1.1</span><br><span class="line"></span><br><span class="line">- 请求头</span><br><span class="line"></span><br><span class="line">  (以上图中黄色部分) ：第二行开始，上图黄色部分内容就是请求头。格式为key: value形式</span><br><span class="line"></span><br><span class="line">  - http是个无状态的协议，所以在请求头设置浏览器的一些自身信息和想要响应的形式。这样服务器在收到信息后，就可以知道是谁，想干什么了</span><br><span class="line">  - 常见的HTTP请求头有:</span><br><span class="line"></span><br><span class="line">|<span class="string"> 请求头          </span>|<span class="string"> 含义                                                         </span>|</span><br><span class="line">|<span class="string"> --------------- </span>|<span class="string"> ------------------------------------------------------------ </span>|</span><br><span class="line">|<span class="string"> Host            </span>|<span class="string"> 表示请求的主机名                                             </span>|</span><br><span class="line">|<span class="string"> User-Agent      </span>|<span class="string"> 浏览器版本。 例如：Chrome浏览器的标识类似Mozilla/5.0 ...Chrome/79 ，IE浏览器的标识类似Mozilla/5.0 (Windows NT ...)like Gecko </span>|</span><br><span class="line">|<span class="string"> Accept          </span>|<span class="string"> 表示浏览器能接收的资源类型，如text/*，image/*或者*/*表示所有； </span>|</span><br><span class="line">|<span class="string"> Accept-Language </span>|<span class="string"> 表示浏览器偏好的语言，服务器可以据此返回不同语言的网页；     </span>|</span><br><span class="line">|<span class="string"> Accept-Encoding </span>|<span class="string"> 表示浏览器可以支持的压缩类型，例如gzip, deflate等。          </span>|</span><br><span class="line">|<span class="string"> Content-Type    </span>|<span class="string"> 请求主体的数据类型                                           </span>|</span><br><span class="line">|<span class="string"> Content-Length  </span>|<span class="string"> 数据主体的大小（单位：字节）                                 </span>|</span><br><span class="line"></span><br><span class="line">服务端可以根据请求头中的内容来获取客户端的相关信息，有了这些信息服务端就可以处理不同的业务需求。</span><br><span class="line"></span><br><span class="line">- 请求体 ：存储请求参数</span><br><span class="line">  - GET请求的请求参数在请求行中，故不需要设置请求体</span><br><span class="line"></span><br><span class="line">- <span class="symbol">*</span><span class="symbol">*</span>POST方式的请求协议：<span class="symbol">*</span><span class="symbol">*</span></span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-242-1024x247.png)</span><br><span class="line"></span><br><span class="line">- 请求行</span><br><span class="line"></span><br><span class="line">  (以上图中红色部分)：包含请求方式、资源路径、协议/版本</span><br><span class="line"></span><br><span class="line">  - 请求方式：POST</span><br><span class="line">  - 资源路径：/brand</span><br><span class="line">  - 协议/版本：HTTP/1.1</span><br><span class="line"></span><br><span class="line">- <span class="symbol">*</span><span class="symbol">*</span>请求头<span class="symbol">*</span><span class="symbol">*</span>(以上图中黄色部分)</span><br><span class="line"></span><br><span class="line">- 请求体</span><br><span class="line"></span><br><span class="line">  (以上图中绿色部分) ：存储请求参数</span><br><span class="line"></span><br><span class="line">  - 请求体和请求头之间是有一个空行隔开（作用：用于标记请求头结束）</span><br><span class="line"></span><br><span class="line">GET请求和POST请求的区别：</span><br><span class="line"></span><br><span class="line">|<span class="string"> **区别方式** </span>|<span class="string"> **GET请求**                                                  </span>|<span class="string"> **POST请求**         </span>|</span><br><span class="line">|<span class="string"> ------------ </span>|<span class="string"> ------------------------------------------------------------ </span>|<span class="string"> -------------------- </span>|</span><br><span class="line">|<span class="string"> 请求参数     </span>|<span class="string"> 请求参数在请求行中。&lt;br/&gt;例：/brand/findAll?name=OPPO&amp;status=1 </span>|<span class="string"> 请求参数在请求体中   </span>|</span><br><span class="line">|<span class="string"> 请求参数长度 </span>|<span class="string"> 请求参数长度有限制(浏览器不同限制也不同)                     </span>|<span class="string"> 请求参数长度没有限制 </span>|</span><br><span class="line">|<span class="string"> 安全性       </span>|<span class="string"> 安全性低。原因：请求参数暴露在浏览器地址栏中。               </span>|<span class="string"> 安全性相对高         </span>|</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 1.4.2获取请求数据</span></span><br><span class="line"></span><br><span class="line">Web服务器（Tomcat）对HTTP协议的请求数据进行解析，并进行了封装(HttpServletRequest)，并在调用Controller方法的时候传递给了该方法。这样，就使得程序员不必直接对协议进行操作，让Web开发更加便捷。</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-243-1024x310.png)</span><br><span class="line"></span><br><span class="line"><span class="comment">### 1.5HTTP响应协议</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### 1.5.1格式介绍</span></span><br><span class="line"></span><br><span class="line">- 响应协议：服务器将数据以响应格式返回给浏览器。包括：<span class="symbol">*</span><span class="symbol">*</span>响应行 、响应头 、响应体<span class="symbol">*</span><span class="symbol">*</span></span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-252-1024x188.png)</span><br><span class="line"></span><br><span class="line">- 响应行(以上图中红色部分)：响应数据的第一行。响应行由</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>协议及版本</p>  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">、</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>响应状态码</p>  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">、</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>状态码描述</p>  <figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  组成</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> 协议/版本：HTTP/1.1</span><br><span class="line"><span class="bullet">  -</span> 响应状态码：200</span><br><span class="line"><span class="bullet">  -</span> 状态码描述：OK</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 响应头(以上图中黄色部分)：响应数据的第二行开始。格式为key：value形式</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> http是个无状态的协议，所以可以在请求头和响应头中设置一些信息和想要执行的动作，这样，对方在收到信息后，就可以知道你是谁，你想干什么</span><br><span class="line"><span class="bullet">  -</span> 常见的HTTP响应头有:</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 常见的HTTP响应头有:</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Content-Type：表示该响应内容的类型，例如text/html，image/jpeg ；</p><p>Content-Length：表示该响应内容的长度（字节数）；</p><p>Content-Encoding：表示该响应压缩算法，例如gzip ；</p><p>Cache-Control：指示客户端应如何缓存，例如max-age=300表示可以最多缓存300秒 ;</p><p>Set-Cookie: 告诉浏览器为当前页面所在的域设置cookie ;</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- 响应体(以上图中绿色部分)： 响应数据的最后一部分。存储响应的数据</span><br><span class="line">  - 响应体和响应头之间有一个空行隔开（作用：用于标记响应头结束）</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 1.5.2响应状态码</span></span><br><span class="line"></span><br><span class="line">|<span class="string"> 状态码分类 </span>|<span class="string"> 说明                                                         </span>|</span><br><span class="line">|<span class="string"> ---------- </span>|<span class="string"> ------------------------------------------------------------ </span>|</span><br><span class="line">|<span class="string"> 1xx        </span>|<span class="string"> 响应中 --- 临时状态码。表示请求已经接受，告诉客户端应该继续请求或者如果已经完成则忽略 </span>|</span><br><span class="line">|<span class="string"> 2xx        </span>|<span class="string"> 成功 --- 表示请求已经被成功接收，处理已完成                  </span>|</span><br><span class="line">|<span class="string"> 3xx        </span>|<span class="string"> 重定向 --- 重定向到其它地方，让客户端再发起一个请求以完成整个处理 </span>|</span><br><span class="line">|<span class="string"> 4xx        </span>|<span class="string"> 客户端错误 --- 处理发生错误，责任在客户端，如：客户端的请求一个不存在的资源，客户端未被授权，禁止访问等 </span>|</span><br><span class="line">|<span class="string"> 5xx        </span>|<span class="string"> 服务器端错误 --- 处理发生错误，责任在服务端，如：服务端抛出异常，路由出错，HTTP版本不支持等 </span>|</span><br><span class="line"></span><br><span class="line">- `200 ok` 客户端请求成功</span><br><span class="line">- 401 Unauthorized 用户无权限访问页面</span><br><span class="line">- `404 Not Found` 请求资源不存在</span><br><span class="line">- `500 Internal Server Error` 服务端发生不可预期的错误</span><br><span class="line"></span><br><span class="line"><span class="comment">#### 1.5.3设置响应数据</span></span><br><span class="line"></span><br><span class="line">Web服务器对HTTP协议的响应数据进行了封装(HttpServletResponse)，并在调用Controller方法的时候传递给了该方法。这样，就使得程序员不必直接对协议进行操作，让Web开发更加便捷。</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-244-1024x306.png)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>package com.itheima;</p><p>import jakarta.servlet.http.HttpServletResponse;<br>import org.springframework.http.ResponseEntity;<br>import org.springframework.web.bind.annotation.RequestMapping;<br>import org.springframework.web.bind.annotation.RestController;</p><p>import java.io.IOException;</p><p>@RestController<br>public class ResponseController {</p><pre><code>@RequestMapping(&quot;/response&quot;)public void response(HttpServletResponse response) throws IOException &#123;    //1.设置响应状态码    response.setStatus(401);    //2.设置响应头    response.setHeader(&quot;name&quot;,&quot;itcast&quot;);    //3.设置响应体    response.setContentType(&quot;text/html;charset=utf-8&quot;);    response.setCharacterEncoding(&quot;utf-8&quot;);    response.getWriter().write(&quot;&lt;h1&gt;hello response&lt;/h1&gt;&quot;);&#125;@RequestMapping(&quot;/response2&quot;)public ResponseEntity&lt;String&gt; response2(HttpServletResponse response) throws IOException &#123;    return ResponseEntity            .status(401)            .header(&quot;name&quot;,&quot;itcast&quot;)            .body(&quot;&lt;h1&gt;hello response&lt;/h1&gt;&quot;);&#125;</code></pre><p>}</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">响应状态码 和 响应头如果没有特殊要求的话，通常不手动设定。服务器会根据请求处理的逻辑，自动设置响应状态码和响应头。</span><br><span class="line"></span><br><span class="line">## <span class="number">2.</span>SpringBootWeb案例</span><br><span class="line"></span><br><span class="line">### <span class="number">2.1</span>需求说明</span><br><span class="line"></span><br><span class="line">需求：基于SpringBoot开发web程序，完成用户列表的渲染展示</span><br><span class="line"></span><br><span class="line">![img](https:<span class="comment">//www.legendkiller.xyz/wp-content/uploads/2025/06/image-253-1024x309.png)</span></span><br><span class="line"></span><br><span class="line">当在浏览器地址栏，访问前端静态页面（http:<span class="comment">//localhost:8080/usre.html）后，在前端页面上，会发送ajax请求，请求服务端（http://localhost:8080/list），服务端程序加载 user.txt 文件中的数据，读取出来后最终给前端页面响应json格式的数据，前端页面再将数据渲染展示在表格中。</span></span><br><span class="line"></span><br><span class="line">### <span class="number">2.2</span>代码实现</span><br><span class="line"></span><br><span class="line">**<span class="number">1</span>). 准备工作：再创建一个SpringBoot工程，并勾选web依赖、lombok依赖。**</span><br><span class="line"></span><br><span class="line">**<span class="number">2</span>). 准备工作：引入资料中准备好的数据文件user.txt，以及static下的前端静态页面**</span><br><span class="line"></span><br><span class="line">**<span class="number">3</span>). 准备工作：定义封装用户信息的实体类。**</span><br><span class="line"></span><br><span class="line">在 `com.itheima` 下再定义一个包 `pojo`，专门用来存放实体类。 在该包下定义一个实体类User：</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>package com.itheima.pojo;</p><p>import lombok.AllArgsConstructor;<br>import lombok.Data;<br>import lombok.NoArgsConstructor;<br>import java.time.LocalDateTime;</p><p>/**</p><ul><li>封装用户信息<br>*/<br>@Data<br>@NoArgsConstructor<br>@AllArgsConstructor<br>public class User {<br>private Integer id;<br>private String username;<br>private String password;<br>private String name;<br>private Integer age;<br>private LocalDateTime updateTime;<br>}</li></ul><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**<span class="number">3</span>). 开发服务端程序，接收请求，读取文本数据并响应**</span><br><span class="line"></span><br><span class="line">由于在案例中，需要读取文本中的数据，并且还需要将对象转为json格式，所以这里呢，我们在项目中再引入一个非常常用的工具包hutool。 然后调用里面的工具类，就可以非常方便快捷的完成业务操作。</span><br><span class="line"></span><br><span class="line">`pom.xml`中引入依赖</span><br><span class="line"></span><br></pre></td></tr></table></figure><dependency>    <groupId>cn.hutool</groupId>    <artifactId>hutool-all</artifactId>    <version>5.8.27</version></dependency><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">在`com.itheima`包下新建一个子包`controller`，在其中创建一个`UserController`</span><br><span class="line"></span><br></pre></td></tr></table></figure>import cn.hutool.core.io.IoUtil;import cn.hutool.json.JSONConfig;import cn.hutool.json.JSONUtil;import com.itheima.pojo.User;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.RestController;import java.io.InputStream;import java.nio.charset.StandardCharsets;import java.time.LocalDateTime;import java.time.format.DateTimeFormatter;import java.util.ArrayList;import java.util.List;import java.util.stream.Collectors;<p>@RestController<br>public class UserController {</p><pre><code>@RequestMapping(&quot;/list&quot;)public String list()&#123;    //1.加载并读取文件    InputStream in = this.getClass().getClassLoader().getResourceAsStream(&quot;user.txt&quot;);    ArrayList&lt;String&gt; lines = IoUtil.readLines(in, StandardCharsets.UTF_8, new ArrayList&lt;&gt;());        //2.解析数据，封装成对象 --&gt; 集合    List&lt;User&gt; userList = lines.stream().map(line -&gt; &#123;        String[] parts = line.split(&quot;,&quot;);        Integer id = Integer.parseInt(parts[0]);        String username = parts[1];        String password = parts[2];        String name = parts[3];        Integer age = Integer.parseInt(parts[4]);        LocalDateTime updateTime = LocalDateTime.parse(parts[5], DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;));        return new User(id, username, password, name, age, updateTime);    &#125;).collect(Collectors.toList());        //3.响应数据    //return JSONUtil.toJsonStr(userList, JSONConfig.create().setDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;));    return userList;&#125;</code></pre><p>}</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="strong">**4). 启动服务测试，访问：**</span>http://localhost:8080/user.html</span><br><span class="line"></span><br><span class="line"><span class="section">### 2.3@ResponseBody</span></span><br><span class="line"></span><br><span class="line">controller方法中的return的结果，怎么就可以响应给浏览器呢？</span><br><span class="line"></span><br><span class="line">答案：使用@ResponseBody注解</span><br><span class="line"></span><br><span class="line"><span class="strong">**@ResponseBody注解：**</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 类型：方法注解、类注解</span><br><span class="line"><span class="bullet">-</span> 位置：书写在Controller方法上或类上</span><br><span class="line"><span class="bullet">-</span> 作用：将方法返回值直接响应给浏览器，如果返回值类型是实体对象/集合，将会转换为JSON格式后在响应给浏览器</span><br><span class="line"></span><br><span class="line">但是在我们所书写的Controller中，只在类上添加了@RestController注解、方法添加了@RequestMapping注解，并没有使用@ResponseBody注解，怎么给浏览器响应呢？</span><br><span class="line"></span><br><span class="line">这是因为，我们在类上加了<span class="strong">**@RestController注解，而这个注解是由两个注解组合起来的，分别是：@Controller 、@ResponseBody。**</span> 那也就意味着，我们在类上已经添加了@ResponseBody注解了，而一旦在类上加了@ResponseBody注解，就相当于该类所有的方法中都已经添加了@ResponseBody注解。</span><br><span class="line"></span><br><span class="line">提示：前后端分离的项目中，一般直接在请求处理类上加@RestController注解，就无需在方法上加@ResponseBody注解了。</span><br><span class="line"></span><br><span class="line"><span class="section">## 3.分层解耦</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 3.1三层架构</span></span><br><span class="line"></span><br><span class="line">在我们项目开发中呢，可以将代码分为三层，如图所示：</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-245-1024x380.png</span>)</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> Controller：控制层。接收前端发送的请求，对请求进行处理，并响应数据。</span><br><span class="line"><span class="bullet">-</span> Service：业务逻辑层。处理具体的业务逻辑。</span><br><span class="line"><span class="bullet">-</span> Dao：数据访问层(Data Access Object)，也称为持久层。负责数据访问操作，包括数据的增、删、改、查。</span><br><span class="line"></span><br><span class="line">基于三层架构的程序执行流程，如图所示：</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-275-1024x299.png</span>)</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 前端发起的请求，由Controller层接收（Controller响应数据给前端）</span><br><span class="line"><span class="bullet">-</span> Controller层调用Service层来进行逻辑处理（Service层处理完后，把处理结果返回给Controller层）</span><br><span class="line"><span class="bullet">-</span> Serivce层调用Dao层（逻辑处理过程中需要用到的一些数据要从Dao层获取）</span><br><span class="line"><span class="bullet">-</span> Dao层操作文件中的数据（Dao拿到的数据会返回给Service层）</span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; 思考：按照三层架构的思想，如果要对业务逻辑(Service层)进行变更，会影响到Controller层和Dao层吗？</span></span><br><span class="line"><span class="quote">&gt;</span></span><br><span class="line"><span class="quote">&gt; 答案：不会影响。 （程序的扩展性、维护性变得更好了）</span></span><br><span class="line"></span><br><span class="line">对之前的代码进行三层划分：</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-246-1024x528.png</span>)</span><br><span class="line"></span><br><span class="line">三层架构的好处：</span><br><span class="line"></span><br><span class="line"><span class="bullet">1.</span> 复用性强</span><br><span class="line"><span class="bullet">2.</span> 便于维护</span><br><span class="line"><span class="bullet">3.</span> 利用扩展</span><br><span class="line"></span><br><span class="line"><span class="section">### 3.2分层解耦</span></span><br><span class="line"></span><br><span class="line"><span class="section">#### 3.2.1问题分析</span></span><br><span class="line"></span><br><span class="line">由于我们现在在程序中，需要什么对象，直接new一个对象 <span class="code">`new UserServiceImpl()`</span> 。</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-254.png</span>)</span><br><span class="line"></span><br><span class="line">如果说我们需要更换实现类，比如由于业务的变更，UserServiceImpl 不能满足现有的业务需求，我们需要切换为 UserServiceImpl2 这套实现，就需要修改Contorller的代码，需要创建 UserServiceImpl2 的实现<span class="code">`new UserServiceImpl2()`</span> 。</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-255.png</span>)</span><br><span class="line"></span><br><span class="line">Service中调用Dao，也是类似的问题。这种呢，我们就称之为层与层之间 <span class="strong">**耦合**</span> 了。 那什么是耦合呢 ？</span><br><span class="line"></span><br><span class="line">首先需要了解软件开发涉及到的两个概念：内聚和耦合。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**内聚：**</span>软件中各个功能模块内部的功能联系。(模块中元素之间)</span><br><span class="line"><span class="bullet">-</span> <span class="strong">**耦合：**</span>衡量软件中各个层/模块之间的依赖、关联的程度。（模块/层与模块/层之间）</span><br><span class="line"></span><br><span class="line"><span class="strong">**软件设计原则：高内聚低耦合。**</span></span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; <span class="strong">**高内聚：**</span>指的是一个模块中各个元素之间的联系的紧密程度，如果各个元素(语句、程序段)之间的联系程度越高，则内聚性越高，即 &quot;高内聚&quot;。</span></span><br><span class="line"><span class="quote">&gt;</span></span><br><span class="line"><span class="quote">&gt; <span class="strong">**低耦合：**</span>指的是软件中各个层、模块之间的依赖关联程序越低越好。</span></span><br><span class="line"></span><br><span class="line">目前层与层之间是存在耦合的，Controller耦合了Service、Service耦合了Dao。而 高内聚、低耦合的目的是使程序模块的可重用性、移植性大大增强。</span><br><span class="line"></span><br><span class="line">那最终我们的目标呢，就是做到层与层之间，尽可能的降低耦合，甚至解除耦合。</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-256-1024x479.png</span>)</span><br><span class="line"></span><br><span class="line"><span class="section">#### 3.2.2解耦思路</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**1). 首先不能在EmpController中使用new对象。**</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**2). 将要用到的对象交给一个容器管理。**</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**3). 应用程序中用到这个对象，就直接从容器中获取**</span></span><br><span class="line"></span><br><span class="line">我们想要实现上述解耦操作，就涉及到Spring中的两个核心概念：</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 控制反转：</span><br><span class="line"></span><br><span class="line">   Inversion Of Control，简称</span><br><span class="line"></span><br><span class="line">  IOC</span><br><span class="line"></span><br><span class="line">  。对象的创建控制权由程序自身转移到外部（容器），这种思想称为控制反转。</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> 对象的创建权由程序员主动创建转移到容器(由容器创建、管理对象)。这个容器称为：IOC容器或Spring容器。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 依赖注入：</span><br><span class="line"></span><br><span class="line">   Dependency Injection，简称</span><br><span class="line"></span><br><span class="line">  DI</span><br><span class="line"></span><br><span class="line">  。容器为应用程序提供运行时，所依赖的资源，称之为依赖注入。</span><br><span class="line"></span><br><span class="line"><span class="bullet">  -</span> 程序运行时需要某个资源，此时容器就为其提供这个资源。</span><br><span class="line"><span class="bullet">  -</span> 例：EmpController程序运行时需要EmpService对象，Spring容器就为其提供并注入EmpService对象。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="strong">**bean对象：**</span>IOC容器中创建、管理的对象，称之为：bean对象。</span><br><span class="line"></span><br><span class="line"><span class="section">#### 3.2.3IOC&amp;DI入门</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**1). 将Service及Dao层的实现类，交给IOC容器管理**</span></span><br><span class="line"></span><br><span class="line">在实现类加上 <span class="code">`@Component`</span> 注解，就代表把当前类产生的对象交给IOC容器管理。</span><br><span class="line"></span><br><span class="line"><span class="strong">**A. UserDaoImpl**</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>@Component<br>public class UserDaoImpl implements UserDao {<br>@Override<br>public List<String> findAll() {<br>InputStream in = this.getClass().getClassLoader().getResourceAsStream(“user.txt”);<br>ArrayList<String> lines = IoUtil.readLines(in, StandardCharsets.UTF_8, new ArrayList&lt;&gt;());<br>return lines;<br>}<br>}</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="strong">**B. UserServiceImpl**</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>@Component<br>public class UserServiceImpl implements UserService {</p><pre><code>private UserDao userDao;@Overridepublic List&lt;User&gt; findAll() &#123;    List&lt;String&gt; lines = userDao.findAll();    List&lt;User&gt; userList = lines.stream().map(line -&gt; &#123;        String[] parts = line.split(&quot;,&quot;);        Integer id = Integer.parseInt(parts[0]);        String username = parts[1];        String password = parts[2];        String name = parts[3];        Integer age = Integer.parseInt(parts[4]);        LocalDateTime updateTime = LocalDateTime.parse(parts[5], DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;));        return new User(id, username, password, name, age, updateTime);    &#125;).collect(Collectors.toList());    return userList;&#125;</code></pre><p>}</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="strong">**2). 为Controller 及 Service注入运行时所依赖的对象**</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**A. UserServiceImpl**</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>@Component<br>public class UserServiceImpl implements UserService {</p><pre><code>@Autowiredprivate UserDao userDao;@Overridepublic List&lt;User&gt; findAll() &#123;    List&lt;String&gt; lines = userDao.findAll();    List&lt;User&gt; userList = lines.stream().map(line -&gt; &#123;        String[] parts = line.split(&quot;,&quot;);        Integer id = Integer.parseInt(parts[0]);        String username = parts[1];        String password = parts[2];        String name = parts[3];        Integer age = Integer.parseInt(parts[4]);        LocalDateTime updateTime = LocalDateTime.parse(parts[5], DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;));        return new User(id, username, password, name, age, updateTime);    &#125;).collect(Collectors.toList());    return userList;&#125;</code></pre><p>}</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="strong">**B. UserController**</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>@RestController<br>public class UserController {</p><pre><code>@Autowiredprivate UserService userService;@RequestMapping(&quot;/list&quot;)public List&lt;User&gt; list()&#123;    //1.调用Service    List&lt;User&gt; userList = userService.findAll();    //2.响应数据    return userList;&#125;</code></pre><p>}</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">## 4.IOC详解</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 4.1Bean的声明</span></span><br><span class="line"></span><br><span class="line">前面我们提到IOC控制反转，就是将对象的控制权交给Spring的IOC容器，由IOC容器创建及管理对象。IOC容器创建的对象称为bean对象。</span><br><span class="line"></span><br><span class="line">在之前的入门案例中，要把某个对象交给IOC容器管理，需要在类上添加一个注解：<span class="symbol">*</span><span class="symbol">*</span>`<span class="meta">@Component`**</span></span><br><span class="line"></span><br><span class="line">而Spring框架为了更好的标识web应用程序开发当中，bean对象到底归属于哪一层，又提供了<span class="meta">@Component的衍生注解：</span></span><br><span class="line"></span><br><span class="line">|<span class="string"> 注解        </span>|<span class="string"> 说明                 </span>|<span class="string"> 位置                                              </span>|</span><br><span class="line">|<span class="string"> ----------- </span>|<span class="string"> -------------------- </span>|<span class="string"> ------------------------------------------------- </span>|</span><br><span class="line">|<span class="string"> @Component  </span>|<span class="string"> 声明bean的基础注解   </span>|<span class="string"> 不属于以下三类时，用此注解                        </span>|</span><br><span class="line">|<span class="string"> @Controller </span>|<span class="string"> @Component的衍生注解 </span>|<span class="string"> 标注在控制层类上                                  </span>|</span><br><span class="line">|<span class="string"> @Service    </span>|<span class="string"> @Component的衍生注解 </span>|<span class="string"> 标注在业务层类上                                  </span>|</span><br><span class="line">|<span class="string"> @Repository </span>|<span class="string"> @Component的衍生注解 </span>|<span class="string"> 标注在数据访问层类上（由于与mybatis整合，用的少） </span>|</span><br><span class="line"></span><br><span class="line">那么此时，我们就可以使用 `<span class="meta">@Service`</span> 注解声明Service层的bean。 使用 `<span class="meta">@Repository`</span> 注解声明Dao层的bean。 代码实现如下：</span><br><span class="line"></span><br><span class="line">Service层:</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>@Service<br>public class UserServiceImpl implements UserService {</p><pre><code>private UserDao userDao;@Overridepublic List&lt;User&gt; findAll() &#123;    List&lt;String&gt; lines = userDao.findAll();    List&lt;User&gt; userList = lines.stream().map(line -&gt; &#123;        String[] parts = line.split(&quot;,&quot;);        Integer id = Integer.parseInt(parts[0]);        String username = parts[1];        String password = parts[2];        String name = parts[3];        Integer age = Integer.parseInt(parts[4]);        LocalDateTime updateTime = LocalDateTime.parse(parts[5], DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;));        return new User(id, username, password, name, age, updateTime);    &#125;).collect(Collectors.toList());    return userList;&#125;</code></pre><p>}</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="section">Dao层:</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>@Repository<br>public class UserDaoImpl implements UserDao {<br>@Override<br>public List<String> findAll() {<br>InputStream in = this.getClass().getClassLoader().getResourceAsStream(“user.txt”);<br>ArrayList<String> lines = IoUtil.readLines(in, StandardCharsets.UTF_8, new ArrayList&lt;&gt;());<br>return lines;<br>}<br>}</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**注意<span class="number">1</span>**：声明<span class="selector-tag">bean</span>的时候，可以通过注解的<span class="selector-tag">value</span>属性指定<span class="selector-tag">bean</span>的名字，如果没有指定，默认为类名首字母小写。</span><br><span class="line"></span><br><span class="line">**注意<span class="number">2</span>**：使用以上四个注解都可以声明<span class="selector-tag">bean</span>，但是在<span class="selector-tag">springboot</span>集成<span class="selector-tag">web</span>开发中，声明控制器<span class="selector-tag">bean</span>只能用@<span class="selector-tag">Controller</span>。</span><br><span class="line"></span><br><span class="line">### <span class="number">4.2</span>组件扫描</span><br><span class="line"></span><br><span class="line">问题：使用前面学习的四个注解声明的<span class="selector-tag">bean</span>，一定会生效吗？</span><br><span class="line"></span><br><span class="line">答案：不一定。（原因：<span class="selector-tag">bean</span>想要生效，还需要被组件扫描）</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">-</span> 前面声明<span class="selector-tag">bean</span>的四大注解，要想生效，还需要被组件扫描注解 **`@<span class="selector-tag">ComponentScan</span>`** 扫描。</span><br><span class="line"><span class="selector-tag">-</span> 该注解虽然没有显式配置，**但是实际上已经包含在了启动类声明注解 `@<span class="selector-tag">SpringBootApplication</span>` 中**，默认扫描的范围是启动类所在包及其子包。</span><br><span class="line"></span><br><span class="line">!<span class="selector-attr">[img]</span>(<span class="attribute">https</span>:<span class="comment">//www.legendkiller.xyz/wp-content/uploads/2025/06/image-257-1024x360.png)</span></span><br><span class="line"></span><br><span class="line">所以，我们在项目开发中，只需要按照如上项目结构，将项目中的所有的业务类，都放在启动类所在包的子包中，就无需考虑组件扫描问题。</span><br><span class="line"></span><br><span class="line">## <span class="number">5</span>.DI详解</span><br><span class="line"></span><br><span class="line">依赖注入，是指IOC容器要为应用程序去提供运行时所依赖的资源，而资源指的就是对象。</span><br><span class="line"></span><br><span class="line">在入门程序案例中，我们使用了<span class="variable">@Autowired</span>这个注解，完成了依赖注入的操作，而这个Autowired翻译过来叫：自动装配。</span><br><span class="line"></span><br><span class="line"><span class="built_in">`@Autowired`</span>注解，默认是按照**类型**进行自动装配的（去IOC容器中找某个类型的对象，然后完成注入操作）</span><br><span class="line"></span><br><span class="line">&gt; 入门程序举例：在EmpController运行的时候，就要到IOC容器当中去查找EmpService这个类型的对象，而我们的IOC容器中刚好有一个EmpService这个类型的对象，所以就找到了这个类型的对象完成注入操作。</span><br><span class="line"></span><br><span class="line">### <span class="number">5.1</span><span class="variable">@Autowired</span>用法</span><br><span class="line"></span><br><span class="line"><span class="variable">@Autowired</span> 进行依赖注入，常见的方式，有如下三种：</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>). 属性注入</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>@RestController<br>public class UserController {</p><pre><code>//方式一: 属性注入@Autowiredprivate UserService userService;</code></pre><p>}</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">- </span>优点：代码简洁、方便快速开发。</span><br><span class="line"><span class="bullet">- </span>缺点：隐藏了类之间的依赖关系、可能会破坏类的封装性。</span><br><span class="line"></span><br><span class="line">2). 构造函数注入</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>@RestController<br>public class UserController {</p><pre><code>//方式二: 构造器注入private final UserService userService;@Autowired //如果当前类中只存在一个构造函数, @Autowired可以省略public UserController(UserService userService) &#123;    this.userService = userService;&#125;</code></pre><p>}</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">- </span>优点：能清晰地看到类的依赖关系、提高了代码的安全性。</span><br><span class="line"><span class="bullet">- </span>缺点：代码繁琐、如果构造参数过多，可能会导致构造函数臃肿。</span><br><span class="line"><span class="bullet">- </span><span class="strong">**注意：如果只有一个构造函数，@Autowired注解可以省略。（通常来说，也只有一个构造函数）**</span></span><br><span class="line"></span><br><span class="line">3). setter注入</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>/** * 用户信息Controller */<br>@RestController<br>public class UserController {</p><pre><code>//方式三: setter注入private UserService userService;@Autowiredpublic void setUserService(UserService userService) &#123;    this.userService = userService;&#125;</code></pre><p>}</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="selector-tag">-</span> 优点：保持了类的封装性，依赖关系更清晰。</span><br><span class="line"><span class="selector-tag">-</span> 缺点：需要额外编写<span class="selector-tag">setter</span>方法，增加了代码量。</span><br><span class="line"></span><br><span class="line">在项目开发中，基于@<span class="selector-tag">Autowired</span>进行依赖注入时，基本都是第一种和第二种方式。（官方推荐第二种方式，因为会更加规范）但是在企业项目开发中，很多的项目中，也会选择第一种方式因为更加简洁、高效（在规范性方面进行了妥协）。</span><br><span class="line"></span><br><span class="line">### <span class="number">5.2</span>注意事项</span><br><span class="line"></span><br><span class="line">那如果在<span class="selector-tag">IOC</span>容器中，存在多个相同类型的<span class="selector-tag">bean</span>对象，会出现什么情况呢？</span><br><span class="line"></span><br><span class="line">在下面的例子中，我们准备了两个<span class="selector-tag">UserService</span>的实现类，并且都交给了<span class="selector-tag">IOC</span>容器管理。 代码如下：</span><br><span class="line"></span><br><span class="line">!<span class="selector-attr">[img]</span>(<span class="attribute">https</span>:<span class="comment">//www.legendkiller.xyz/wp-content/uploads/2025/06/image-266-1024x685.png)</span></span><br><span class="line"></span><br><span class="line">此时，我们启动项目会发现，控制台报错了：</span><br><span class="line"></span><br><span class="line">![img](<span class="attribute">https</span>:<span class="comment">//www.legendkiller.xyz/wp-content/uploads/2025/06/image-267-1024x480.png)</span></span><br><span class="line"></span><br><span class="line">出现错误的原因呢，是因为在Spring的容器中，UserService这个类型的bean存在两个，框架不知道具体要注入哪个bean使用，所以就报错了。</span><br><span class="line"></span><br><span class="line">如何解决上述问题呢？Spring提供了以下几种解决方案：</span><br><span class="line"></span><br><span class="line">- <span class="variable">@Primary</span></span><br><span class="line">- <span class="variable">@Qualifier</span></span><br><span class="line">- <span class="variable">@Resource</span></span><br><span class="line"></span><br><span class="line">**方案一：使用<span class="variable">@Primary</span>注解**</span><br><span class="line"></span><br><span class="line">当存在多个相同类型的Bean注入时，加上<span class="variable">@Primary</span>注解，来确定**默认的实现**。</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>@Primary<br>@Service<br>public class UserServiceImpl implements UserService {<br>}</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**方案二：使用<span class="variable">@Qualifier</span>注解**</span><br><span class="line"></span><br><span class="line">指定当前要注入的bean对象。 在<span class="variable">@Qualifier</span>的value属性中，**指定注入**的bean的名称。 <span class="variable">@Qualifier</span>注解不能单独使用，必须配合<span class="variable">@Autowired</span>使用。</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>@RestController<br>public class UserController {</p><pre><code>@Qualifier(&quot;userServiceImpl&quot;)@Autowiredprivate UserService userService;</code></pre><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="strong">**方案三：使用@Resource注解**</span></span><br><span class="line"></span><br><span class="line">是按照bean的名称进行注入。<span class="strong">**通过name属性指定**</span>要注入的bean的名称。</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>@RestController<br>public class UserController {</p><pre><code>@Resource(name = &quot;userServiceImpl&quot;)private UserService userService;</code></pre><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="symbol">*</span><span class="symbol">*</span>面试题：<span class="meta">@Autowird</span> 与 <span class="meta">@Resource的区别**</span></span><br><span class="line"></span><br><span class="line">- <span class="meta">@Autowired</span> 是spring框架提供的注解，而<span class="meta">@Resource是JDK提供的注解</span></span><br><span class="line">- <span class="meta">@Autowired</span> 默认是按照类型注入，而<span class="meta">@Resource是按照名称注入</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 6.常见状态码</span></span><br><span class="line"></span><br><span class="line">|<span class="string"> 状态码 </span>|<span class="string"> 英文描述                        </span>|<span class="string"> 解释                                                         </span>|</span><br><span class="line">|<span class="string"> ------ </span>|<span class="string"> ------------------------------- </span>|<span class="string"> ------------------------------------------------------------ </span>|</span><br><span class="line">|<span class="string"> 200    </span>|<span class="string"> OK                              </span>|<span class="string"> 客户端请求成功，即处理成功，这是我们最想看到的状态码         </span>|</span><br><span class="line">|<span class="string"> 302    </span>|<span class="string"> Found                           </span>|<span class="string"> 指示所请求的资源已移动到由Location响应头给定的 URL，浏览器会自动重新访问到这个页面 </span>|</span><br><span class="line">|<span class="string"> 304    </span>|<span class="string"> Not Modified                    </span>|<span class="string"> 告诉客户端，你请求的资源至上次取得后，服务端并未更改，你直接用你本地缓存吧。隐式重定向 </span>|</span><br><span class="line">|<span class="string"> 400    </span>|<span class="string"> Bad Request                     </span>|<span class="string"> 客户端请求有语法错误，不能被服务器所理解                     </span>|</span><br><span class="line">|<span class="string"> 403    </span>|<span class="string"> Forbidden                       </span>|<span class="string"> 服务器收到请求，但是拒绝提供服务，比如：没有权限访问相关资源 </span>|</span><br><span class="line">|<span class="string"> 404    </span>|<span class="string"> Not Found                       </span>|<span class="string"> 请求资源不存在，一般是URL输入有误，或者网站资源被删除了      </span>|</span><br><span class="line">|<span class="string"> 405    </span>|<span class="string"> Method Not Allowed              </span>|<span class="string"> 请求方式有误，比如应该用GET请求方式的资源，用了POST          </span>|</span><br><span class="line">|<span class="string"> 428    </span>|<span class="string"> Precondition Required           </span>|<span class="string"> 服务器要求有条件的请求，告诉客户端要想访问该资源，必须携带特定的请求头 </span>|</span><br><span class="line">|<span class="string"> 429    </span>|<span class="string"> Too Many Requests               </span>|<span class="string"> 指示用户在给定时间内发送了太多请求（“限速”），配合 Retry-After(多长时间后可以请求)响应头一起使用 </span>|</span><br><span class="line">|<span class="string"> 431    </span>|<span class="string"> Request Header Fields Too Large </span>|<span class="string"> 请求头太大，服务器不愿意处理请求，因为它的头部字段太大。请求可以在减少请求头域的大小后重新提交。 </span>|</span><br><span class="line">|<span class="string"> 500    </span>|<span class="string"> Internal Server Error           </span>|<span class="string"> 服务器发生不可预期的错误。服务器出异常了，赶紧看日志去吧     </span>|</span><br><span class="line">|<span class="string"> 503    </span>|<span class="string"> Service Unavailable             </span>|<span class="string"> 服务器尚未准备好处理请求，服务器刚刚启动，还未初始化好       </span>|</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.java操作数据库（MyBatis篇）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 1.介绍</span></span><br><span class="line"></span><br><span class="line">什么是MyBatis?</span><br><span class="line"></span><br><span class="line">- MyBatis是一款优秀的 <span class="symbol">*</span><span class="symbol">*</span>持久层<span class="symbol">*</span><span class="symbol">*</span><span class="symbol">*</span><span class="symbol">*</span>框架<span class="symbol">*</span><span class="symbol">*</span>，用于简化JDBC的开发。</span><br><span class="line">- MyBatis本是 Apache的一个开源项目iBatis，2010年这个项目由apache迁移到了google code，并且改名为MyBatis 。2013年11月迁移到Github。</span><br><span class="line">- 官网：https://mybatis.org/mybatis-3/zh/index.html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 持久层：指的是就是数据访问层(dao)，是用来操作数据库的。</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-339.png)</span><br><span class="line"></span><br><span class="line">- 框架：是一个半成品软件，是一套可重用的、通用的、软件基础代码模型。在框架的基础上进行软件开发更加高效、规范、通用、可拓展。</span><br><span class="line"></span><br><span class="line">mybatis的作用：通过Mybatis就可以大大<span class="symbol">*</span><span class="symbol">*</span>简化原生的JDBC程序的代码编写<span class="symbol">*</span><span class="symbol">*</span>，比如 通过 `select <span class="symbol">*</span> from user` 查询所有的用户数据，通过JDBC程序操作呢，需要大量的代码实现，而如果通过Mybatis实现相同的功能，只需要简单的三四行就可以搞定。</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-258-1024x528.png)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 2.入门Mybatis</span></span><br><span class="line"></span><br><span class="line">需求：使用Mybatis查询所有用户数据 。</span><br><span class="line"></span><br><span class="line"><span class="symbol">*</span><span class="symbol">*</span>1). 创建springboot工程，并导入 mybatis的起步依赖、mysql的驱动包、lombok。<span class="symbol">*</span><span class="symbol">*</span></span><br><span class="line"></span><br><span class="line">项目工程创建完成后，自动在pom.xml文件中，导入Mybatis依赖和MySQL驱动依赖。如下所示</span><br><span class="line"></span><br><span class="line">![img](https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-259-1024x592.png)</span><br><span class="line"></span><br><span class="line"><span class="symbol">*</span><span class="symbol">*</span>2). 数据准备：创建用户表user，并创建对应的实体类User。<span class="symbol">*</span><span class="symbol">*</span></span><br><span class="line"></span><br><span class="line">用户表</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>create table user(<br>id int unsigned primary key auto_increment comment ‘ID,主键’,<br>username varchar(20) comment ‘用户名’,<br>password varchar(32) comment ‘密码’,<br>name varchar(10) comment ‘姓名’,<br>age tinyint unsigned comment ‘年龄’<br>) comment ‘用户表’;</p><p>insert into user(id, username, password, name, age) values (1, ‘daqiao’, ‘123456’, ‘大乔’, 22),<br>(2, ‘xiaoqiao’, ‘123456’, ‘小乔’, 18),<br>(3, ‘diaochan’, ‘123456’, ‘貂蝉’, 24),<br>(4, ‘lvbu’, ‘123456’, ‘吕布’, 28),<br>(5, ‘zhaoyun’, ‘12345678’, ‘赵云’, 27);</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">实体类放在 `com.itheima.pojo` 包下</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>@Data<br>@NoArgsConstructor<br>@AllArgsConstructor<br>public class User {<br>private Integer id; //ID<br>private String username; //用户名<br>private String password; //密码<br>private String name; //姓名<br>private Integer age; //年龄<br>}</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**<span class="number">3</span>). 配置Mybatis**</span><br><span class="line"></span><br><span class="line">在 `application.properties` 中配置数据库的连接信息。</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>#数据库访问的url地址<br>spring.datasource.url=jdbc:mysql://localhost:3306/web<br>#数据库驱动类类名<br>spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver<br>#访问数据库-用户名<br>spring.datasource.username=root<br>#访问数据库-密码<br>spring.datasource.password=123456</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**<span class="number">4</span>). 编写Mybatis程序：编写Mybatis的持久层接口，定义SQL语句（注解）**</span><br><span class="line"></span><br><span class="line">在创建出来的springboot工程中，在引导类所在包下，在创建一个包 `mapper` 。在 `mapper` 包下创建一个接口 `UserMapper` ，这是一个持久层接口（Mybatis的持久层接口规范一般都叫 XxxMapper）。</span><br><span class="line"></span><br><span class="line">UserMapper接口的内容如下：</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>import com.itheima.pojo.User;<br>import org.apache.ibatis.annotations.Mapper;<br>import org.apache.ibatis.annotations.Select;<br>import java.util.List;</p><p>@Mapper<br>public interface UserMapper {<br>/**<br>* 查询全部<br>*/<br>@Select(“select * from user”)<br>public List<User> findAll();<br>}</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="bullet">-</span> @Mapper注解：表示是mybatis中的Mapper接口，程序运行时，框架会自动生成接口的实现类对象(代理对象)，并交给Spring的IOC容器管理</span><br><span class="line"><span class="bullet">-</span> @Select注解：代表的就是select查询，用于书写select查询语句</span><br><span class="line"></span><br><span class="line"><span class="strong">**5). 单元测试**</span></span><br><span class="line"></span><br><span class="line">在创建出来的SpringBoot工程中，在src下的test目录下，已经自动帮我们创建好了测试类 ，并且在测试类上已经添加了注解 <span class="code">`@SpringBootTest`</span>，代表该测试类已经与SpringBoot整合。</span><br><span class="line"></span><br><span class="line">该测试类在运行时，会自动通过引导类加载Spring的环境（IOC容器）。我们要测试那个bean对象，就可以直接通过<span class="code">`@Autowired`</span>注解直接将其注入进行，然后就可以测试了。</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-260-1024x554.png</span>)</span><br><span class="line"></span><br><span class="line"><span class="section">#### <span class="strong">**Mybatis与JDBC的对比**</span></span></span><br><span class="line"></span><br><span class="line">JDBC程序的<span class="strong">**缺点**</span>：</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> url、username、password 等相关参数全部硬编码在java代码中。</span><br><span class="line"><span class="bullet">-</span> 查询结果的解析、封装比较繁琐。</span><br><span class="line"><span class="bullet">-</span> 每一次操作数据库之前，先获取连接，操作完毕之后，关闭连接。 频繁的获取连接、释放连接造成资源浪费。</span><br><span class="line"></span><br><span class="line">分析了JDBC的缺点之后，我们再来看一下在mybatis中，是如何解决这些问题的：</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 数据库连接四要素(驱动、链接、用户名、密码)，都配置在springboot默认的配置文件 application.properties中</span><br><span class="line"><span class="bullet">-</span> 查询结果的解析及封装，由mybatis自动完成映射封装，我们无需关注</span><br><span class="line"><span class="bullet">-</span> 在mybatis中使用了数据库连接池技术，从而避免了频繁的创建连接、销毁连接而带来的资源浪费。</span><br><span class="line"></span><br><span class="line"><span class="section">## 3.数据库连接池</span></span><br><span class="line"></span><br><span class="line">在前面我们所讲解的mybatis中，使用了数据库连接池技术，避免频繁的创建连接、销毁连接而带来的资源浪费。</span><br><span class="line"></span><br><span class="line">下面我们就具体的了解下数据库连接池。</span><br><span class="line"></span><br><span class="line"><span class="section">### 3.1 介绍</span></span><br><span class="line"></span><br><span class="line">1). 没有数据库连接池的情况</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-340.png</span>)</span><br><span class="line"></span><br><span class="line">客户端执行SQL语句：要先创建一个新的连接对象，然后执行SQL语句，SQL语句执行后又需要关闭连接对象从而释放资源，每次执行SQL时都需要<span class="strong">**创建连接、销毁链接**</span>，这种频繁的重复创建销毁的过程是比较耗费计算机的性能。</span><br><span class="line"></span><br><span class="line">2). 有数据库连接池的情况</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-341.png</span>)</span><br><span class="line"></span><br><span class="line">数据库连接池是个容器，负责分配、管理数据库连接(Connection)</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 程序在启动时，会在数据库连接池(容器)中，创建一定数量的Connection对象</span><br><span class="line"></span><br><span class="line">允许应用程序重复使用一个现有的数据库连接，而不是再重新建立一个</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 客户端在执行SQL时，先从连接池中获取一个Connection对象，然后在执行SQL语句，SQL语句执行完之后，释放Connection时就会把Connection对象归还给连接池（Connection对象可以复用）</span><br><span class="line"></span><br><span class="line">释放空闲时间超过最大空闲时间的连接，来避免因为没有释放连接而引起的数据库连接遗漏</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 客户端获取到Connection对象了，但是Connection对象并没有去访问数据库(处于空闲)，数据库连接池发现Connection对象的空闲时间 &gt; 连接池中预设的最大空闲时间，此时数据库连接池就会自动释放掉这个连接对象</span><br><span class="line"></span><br><span class="line">数据库连接池的好处：</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 资源重用</span><br><span class="line"><span class="bullet">-</span> 提升系统响应速度</span><br><span class="line"><span class="bullet">-</span> 避免数据库连接遗漏</span><br><span class="line"></span><br><span class="line"><span class="section">### 3.2市面上不同的连接池</span></span><br><span class="line"></span><br><span class="line">常见的数据库连接池：<span class="strong">**C3P0 、DBCP 、Druid 、Hikari (springboot默认)**</span></span><br><span class="line"></span><br><span class="line">现在使用更多的是：<span class="strong">**Hikari、Druid （性能更优越）**</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**). Hikari（追光者） [默认的连接池]**</span></span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-342-1024x391.png</span>)</span><br><span class="line"></span><br><span class="line">从控制台输出的日志，我们也可以看出，springboot底层默认使用的数据库连接池就是 Hikari。</span><br><span class="line"></span><br><span class="line"><span class="strong">**2). Druid（德鲁伊）**</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> Druid连接池是阿里巴巴开源的数据库连接池项目</span><br><span class="line"><span class="bullet">-</span> 功能强大，性能优秀，是Java语言最好的数据库连接池之一</span><br><span class="line"></span><br><span class="line">如果我们想把默认的数据库连接池切换为Druid数据库连接池，只需要完成以下两步操作即可：</span><br><span class="line"></span><br><span class="line"><span class="quote">&gt; 参考官方地址：https://github.com/alibaba/druid/tree/master/druid-spring-boot-starter</span></span><br><span class="line"><span class="quote">&gt;</span></span><br><span class="line"><span class="quote">&gt; ①. 在`pom.xml`文件中引入依赖</span></span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure><blockquote><dependency>    <!-- Druid连接池依赖 -->    <groupId>com.alibaba</groupId>    <artifactId>druid-spring-boot-starter</artifactId>    <version>1.2.19</version></dependency><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">②.在`application.properties`中引入数据库连接配置</span><br><span class="line"></span><br></pre></td></tr></table></figure>spring.datasource.type=com.alibaba.druid.pool.DruidDataSourcespring.datasource.url=jdbc:mysql://localhost:3306/webspring.datasource.driver-class-name=com.mysql.cj.jdbc.Driverspring.datasource.username=rootspring.datasource.password=1233<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## <span class="number">4.</span>Mybatis的增删改查</span><br><span class="line"></span><br><span class="line">### <span class="number">4.1</span>删除</span><br><span class="line"></span><br><span class="line">- 需求：根据ID删除用户信息</span><br><span class="line">- SQL：delete <span class="keyword">from</span> user <span class="keyword">where</span> id = <span class="number">5</span>;</span><br><span class="line">- Mapper接口方法：</span><br><span class="line"> - 方式一：</span><br><span class="line"></span><br></pre></td></tr></table></figure></blockquote><p>/**</p><ul><li>根据id删除<br>*/<br>@Delete(“delete from user where id = 5”)<br>public void deleteById();</li></ul><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">这种方式执行删除操作，调用deleteById方法只能删除<span class="built_in">id</span>为<span class="number">5</span>的用户信息，因为将<span class="built_in">id</span>直接写死在代码中了，不可取。</span><br><span class="line"></span><br><span class="line">- 方式二：</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>/** * 根据id删除 */<br>@Delete(“delete from user where id = #{id}”)<br>public void deleteById(Integer id);</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">在Mybatis中，我们可以通过<span class="strong">**参数占位符号**</span> <span class="code">`#&#123;...&#125;`</span> 来占位，在调用<span class="code">`deleteById`</span>方法时，传递的参数值，最终会替换占位符。</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-261-1024x473.png</span>)</span><br><span class="line"></span><br><span class="line">运行之后，我们发现，<span class="code">`#&#123;...&#125;`</span> 占位符，其实最终被替换成了 ？占位符，生成的是预编译的SQL语句。【推荐】</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> DML语句执行完毕，是有返回值的，我们可以为Mapper接口方法定义返回值来接收，如下：</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>/**</p><ul><li>根据id删除<br>*/<br>@Delete(“delete from user where id = #{id}”)<br>public Integer deleteById(Integer id);</li></ul><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Integer类型的返回值，表示DML语句执行完毕影响的记录数。</span><br><span class="line"></span><br><span class="line">- Mybatis的提供的符号，有两个，一个是 `<span class="comment">#&#123;...&#125;`，另一个是 `$&#123;...&#125;`，区别如下：</span></span><br><span class="line"></span><br><span class="line">|<span class="string"> 符号 </span>|<span class="string"> 说明                                                   </span>|<span class="string"> 场景                       </span>|<span class="string"> 优缺点                </span>|</span><br><span class="line">|<span class="string"> ---- </span>|<span class="string"> ------------------------------------------------------ </span>|<span class="string"> -------------------------- </span>|<span class="string"> --------------------- </span>|</span><br><span class="line">|<span class="string"> #&#123;…&#125; </span>|<span class="string"> 占位符。执行时，会将#&#123;…&#125;替换为?，生成预编译SQL         </span>|<span class="string"> 参数值传递                 </span>|<span class="string"> 安全、性能高 （推荐） </span>|</span><br><span class="line">|<span class="string"> $&#123;…&#125; </span>|<span class="string"> 拼接符。直接将参数拼接在SQL语句中，**存在SQL注入问题** </span>|<span class="string"> 表名、字段名动态设置时使用 </span>|<span class="string"> 不安全、性能低        </span>|</span><br><span class="line"></span><br><span class="line"><span class="comment">### 4.2新增</span></span><br><span class="line"></span><br><span class="line">- 需求：添加一个用户</span><br><span class="line">- SQL：insert into user(username,password,name,age) values(&#x27;zhouyu&#x27;,&#x27;123456&#x27;,&#x27;周瑜&#x27;,20);</span><br><span class="line">- Mapper接口：</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>/**</p><ul><li>添加用户<br>*/<br>@Insert(“insert into user(username,password,name,age) values(#{username},#{password},#{name},#{age})”)<br>public void insert(User user);</li></ul><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">如果在<span class="keyword">SQL</span>语句中，我们需要传递多个参数，我们可以把多个参数封装到一个对象中。然后在<span class="keyword">SQL</span>语句中，我们可以通过`#&#123;对象属性名&#125;`的方式，获取到对象中封装的属性值。</span><br><span class="line"></span><br><span class="line">### <span class="number">4.3</span>修改</span><br><span class="line"></span><br><span class="line">- 需求：根据ID更新用户信息</span><br><span class="line">- <span class="keyword">SQL</span>：<span class="keyword">update</span> <span class="keyword">user</span> <span class="keyword">set</span> username = <span class="string">&#x27;zhouyu&#x27;</span>, <span class="keyword">password</span> = <span class="string">&#x27;123456&#x27;</span>, <span class="type">name</span> = <span class="string">&#x27;周瑜&#x27;</span>, age = <span class="number">20</span> <span class="keyword">where</span> id = <span class="number">1</span>；</span><br><span class="line">- Mapper接口方法：</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>/**</p><ul><li>根据id更新用户信息<br>*/<br>@Update(“update user set username = #{username},password = #{password},name = #{name},age = #{age} where id = #{id}”)<br>public void update(User user);</li></ul><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### <span class="number">4.4</span>查询</span><br><span class="line"></span><br><span class="line">- 需求：根据用户名和密码查询用户信息</span><br><span class="line">- SQL：select*fromuser whereusername = <span class="string">&#x27;zhouyu&#x27;</span> and password = <span class="string">&#x27;123456&#x27;</span></span><br><span class="line">- Mapper接口方法：</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>/**</p><ul><li>根据用户名和密码查询用户信息<br>*/<br>@Select(“select * from user where username = #{username} and password = #{password}”)<br>public User findByUsernameAndPassword(@Param(“username”) String username, @Param(“password”) String password);</li></ul><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="strong">**说明：**</span>基于官方骨架创建的springboot项目中，接口编译时会保留方法形参名，@Param注解可以省略 (#&#123;形参名&#125;)。</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-263-1024x124.png</span>)</span><br><span class="line"></span><br><span class="line"><span class="section">## 5.XML映射配置</span></span><br><span class="line"></span><br><span class="line">Mybatis的开发有两种方式：</span><br><span class="line"></span><br><span class="line"><span class="bullet">1.</span> 注解</span><br><span class="line"><span class="bullet">2.</span> XML</span><br><span class="line"></span><br><span class="line"><span class="section">### 5.1XML配置文件规范</span></span><br><span class="line"></span><br><span class="line">使用Mybatis的注解方式，主要是来完成一些简单的增删改查功能。如果需要实现复杂的SQL功能，建议使用XML来配置映射语句，也就是将SQL语句写在XML配置文件中。</span><br><span class="line"></span><br><span class="line"><span class="strong">**在Mybatis中使用XML映射文件方式开发，需要符合一定的规范：**</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">1.</span> XML映射文件的名称与Mapper接口名称一致，并且将XML映射文件和Mapper接口放置在相同包下（同包同名）</span><br><span class="line"><span class="bullet">2.</span> XML映射文件的namespace属性为Mapper接口全限定名一致</span><br><span class="line"><span class="bullet">3.</span> XML映射文件中sql语句的id与Mapper接口中的方法名一致，并保持返回类型一致。</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-264-1024x327.png</span>)</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">select</span>&gt;</span></span>标签：就是用于编写select查询语句的。</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> resultType属性，指的是查询返回的单条记录所封装的类型。</span><br><span class="line"></span><br><span class="line"><span class="section">### 5.2XML配置文件实现</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**第1步： 创建XML映射文件**</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**第2步：编写XML映射文件**</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><?xml version="1.0" encoding="UTF-8" ?><!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "https://mybatis.org/dtd/mybatis-3-mapper.dtd"><mapper namespace=""></mapper><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**第<span class="number">3</span>步：配置**</span><br><span class="line"></span><br><span class="line">**a. XML映射文件的<span class="keyword">namespace</span>属性为<span class="symbol">Mapper</span>接口全限定名**</span><br><span class="line"></span><br></pre></td></tr></table></figure><?xml version="1.0" encoding="UTF-8" ?><!DOCTYPE mapper        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"        "https://mybatis.org/dtd/mybatis-3-mapper.dtd"><mapper namespace="com.itheima.mapper.UserMapper"></mapper><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**b. <span class="type">XML</span>映射文件中<span class="keyword">sql</span>语句的id与Mapper接口中的方法名一致，并保持返回类型一致**</span><br><span class="line"></span><br></pre></td></tr></table></figure><?xml version="1.0" encoding="UTF-8" ?><!DOCTYPE mapper        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"        "https://mybatis.org/dtd/mybatis-3-mapper.dtd"><mapper namespace="com.itheima.mapper.EmpMapper"><pre><code>&lt;!--查询操作--&gt;&lt;select id=&quot;findAll&quot; resultType=&quot;com.itheima.pojo.User&quot;&gt;    select * from user&lt;/select&gt;</code></pre></mapper><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">resultType 属性的值，与查询返回的单条记录封装的类型一致。</span><br><span class="line"></span><br><span class="line">运行测试类，执行结果。</span><br><span class="line"></span><br><span class="line"><span class="section">### 5.3MybatisX介绍</span></span><br><span class="line"></span><br><span class="line">可以通过MybatisX快速定位：</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-265.png</span>)</span><br><span class="line"></span><br><span class="line">学习了Mybatis中XML配置文件的开发方式了，可能会存在一个疑问：到底是使用注解方式开发还是使用XML方式开发？</span><br><span class="line"></span><br><span class="line"><span class="strong">**结论：**</span>使用Mybatis的注解，主要是来完成一些简单的增删改查功能。如果需要实现复杂的SQL功能，建议使用XML来配置映射语句。</span><br><span class="line"></span><br><span class="line"><span class="section">## 6.SpringBoot配置文件</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 6.1介绍</span></span><br><span class="line"></span><br><span class="line">前面我们一直使用springboot项目创建完毕后自带的<span class="code">`application.properties`</span>进行属性的配置，而如果在项目中，我们需要配置大量的属性，采用properties配置文件这种 <span class="code">`key=value`</span> 的配置形式，就会显得配置文件的层级结构不清晰，也比较臃肿。</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-343-1024x494.png</span>)</span><br><span class="line"></span><br><span class="line">接下来要讲解的yml格式的配置文件。yml格式配置文件名字为：<span class="code">`application.yaml`</span> , <span class="code">`application.yml`</span> 这两个配置文件的后缀名虽然不一样，但是里面配置的内容形式都是一模一样的。</span><br><span class="line"></span><br><span class="line">我们可以来对比一下，采用 <span class="code">`application.properties`</span> 和 <span class="code">`application.yml`</span> 来配置同一段信息(数据库连接信息)，两者之间的配置对比：</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-268-1024x203.png</span>)</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-269-1024x265.png</span>)</span><br><span class="line"></span><br><span class="line">在项目开发中，我们推荐使用application.yml配置文件来配置信息，简洁、明了、以数据为中心</span><br><span class="line"></span><br><span class="line"><span class="section">### 6.2yml配置文件的基本语法</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> 大小写敏感</span><br><span class="line"><span class="bullet">-</span> 数值前边必须有空格，作为分隔符</span><br><span class="line"><span class="bullet">-</span> 使用缩进表示层级关系，缩进时，不允许使用Tab键，只能用空格（idea中会自动将Tab转换为空格）</span><br><span class="line"><span class="bullet">-</span> 缩进的空格数目不重要，只要相同层级的元素左侧对齐即可</span><br><span class="line"><span class="bullet">-</span> <span class="code">`#`</span>表示注释，从这个字符一直到行尾，都会被解析器忽略</span><br><span class="line"></span><br><span class="line">![<span class="string">img</span>](<span class="link">https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-270.png</span>)</span><br><span class="line"></span><br><span class="line">再来看下yml文件中常见的数据格式。在这里我们主要介绍最为常见的两类：</span><br><span class="line"></span><br><span class="line"><span class="bullet">1.</span> 定义对象或Map集合</span><br><span class="line"><span class="bullet">2.</span> 定义数组、list或set集合</span><br><span class="line"></span><br><span class="line">对象/Map集合</span><br><span class="line"></span><br></pre></td></tr></table></figure>user:  name: zhangsan  age: 18  password: 123456<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">数组<span class="operator">/</span><span class="built_in">List</span><span class="operator">/</span><span class="built_in">Set</span>集合</span><br><span class="line"></span><br></pre></td></tr></table></figure>hobby:   - java  - game  - sport```<p>在yml格式的配置文件中，如果配置项的值是以 0 开头的，值需要使用 ‘’ 引起来，因为以0开头在yml中表示8进制的数据。</p><p>给出一个案例，看看原有的 <code>application.properties</code> 配置文件与新建的 <code>application.</code>yml 配置文件的区别</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-271-1024x437.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-272.png" alt="img"></p><h4 id="问题">问题</h4><p>properties,yml,yaml的优先级？</p><p>当三种文件位于同一目录时，优先级顺序为：</p><p><strong>properties &gt; yml &gt; yaml</strong></p>]]></content>
      
      
      <categories>
          
          <category> SSM </category>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JavaWeb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JVM基础篇</title>
      <link href="/posts/8.html"/>
      <url>/posts/8.html</url>
      
        <content type="html"><![CDATA[<h1 id="基础篇">基础篇</h1><h2 id="1、初始JVM">1、初始JVM</h2><h3 id="1-1-什么是JVM">1.1 什么是JVM</h3><p>JVM 全称是 Java Virtual Machine，中文译名 Java虚拟机。JVM 本质上是一个运行在计算机上的程序，他的职责是运行Java字节码文件。</p><p>Java源代码执行流程如下：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-5-1024x282.png" alt="img"></p><p>分为三个步骤：</p><ul><li>1、编写Java源代码文件。</li><li>2、使用Java编译器（javac命令）将源代码编译成Java字节码文件。</li><li>3、使用Java虚拟机加载并运行Java字节码文件，此时会启动一个新的进程。</li></ul><h3 id="1-2-JVM的功能">1.2 JVM的功能</h3><ul><li>1 - 解释和运行</li><li>2 - 内存管理</li><li>3 - 即时编译</li></ul><h4 id="1-2-1-解释和运行">1.2.1 解释和运行</h4><p>对字节码文件中的指令，实时的解释成机器码，让计算机执行。</p><p>字节码文件中包含了字节码指令，计算器无法直接执行，Java虚拟机会将字节码文件中的字节码指令实时地解释成机器码，机器码是计算机可以运行的指令。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-6-1024x388.png" alt="img"></p><h4 id="1-2-2-内存管理">1.2.2 内存管理</h4><ul><li>自动为对象、方法等分配内存</li><li>自动的垃圾回收机制，回收不再使用的对象</li></ul><p>Java虚拟机会帮助程序员为对象分配内存，同时将不用的对象使用垃圾回收器回收掉，这是对比C和C++这些语言的一个优势。在C/C++语言中，对象的回收需要程序员手动去编写代码完成，如果遗漏了这段删除对象的代码，这个对象就会永远占用内存空间，不会再回收。所以JVM的这个功能降低了程序员编写代码的难度。</p><h4 id="1-2-3-即时编译">1.2.3 即时编译</h4><p>对热点代码进行优化，提升执行效率。即时编译可以说是提升Java程序性能最核心的手段。</p><p><strong>Java性能低的主要原因和跨平台特性</strong></p><p>Java语言如果不做任何的优化，性能其实是不如C和C++语言的。主要原因是：</p><p>在程序运行过程中，Java虚拟机需要将字节码指令实时地解释成计算机能识别的机器码，这个过程在运行时可能会反复地执行，所以效率较低。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-7-1024x235.png" alt="img"></p><p>C和C++语言在执行过程中，只需要将源代码编译成可执行文件，就包含了计算机能识别的机器码，无需在运行过程中再实时地解释，所以性能较高。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-8-1024x292.png" alt="img"></p><p>Java为什么要选择一条执行效率比较低的方式呢？主要是为了实现跨平台的特性。Java的字节码指令，如果希望在不同平台（操作系统+硬件架构），比如在windows或者linux上运行。可以使用同一份字节码指令，交给windows和linux上的Java虚拟机进行解释，这样就可以获得不同平台上的机器码了。这样就实现了Write Once，Run Anywhere 编写一次，到处运行 的目标。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-9-1024x386.png" alt="img"></p><p>但是C/C++语言，如果要让程序在不同平台上运行，就需要将一份源代码在不同平台上分别进行编译，相对来说比较麻烦。</p><h3 id="1-3常见的JVM"><strong>1.3常见的JVM</strong></h3><p>平时我们最常用的，就是Hotspot虚拟机。</p><table><thead><tr><th>名称</th><th>作者</th><th>支持版本</th><th>社区活跃度（github star）</th><th>特性</th><th>适用场景</th></tr></thead><tbody><tr><td>HotSpot (Oracle JDK版)</td><td>Oracle</td><td>所有版本</td><td>高(闭源)</td><td>使用最广泛，稳定可靠，社区活跃JIT支持Oracle JDK默认虚拟机</td><td>默认</td></tr><tr><td>HotSpot (Open JDK版)</td><td>Oracle</td><td>所有版本</td><td>中(16.1k)</td><td>同上开源，Open JDK默认虚拟机</td><td>默认对JDK有二次开发需求</td></tr><tr><td>GraalVM</td><td>Oracle</td><td>11, 17,19企业版支持8</td><td>高（18.7k）</td><td>多语言支持高性能、JIT、AOT支持</td><td>微服务、云原生架构需要多语言混合编程</td></tr><tr><td>Dragonwell JDK龙井</td><td>Alibaba</td><td>标准版 8,11,17扩展版11,17</td><td>低(3.9k)</td><td>基于OpenJDK的增强高性能、bug修复、安全性提升JWarmup、ElasticHeap、Wisp特性支持</td><td>电商、物流、金融领域对性能要求比较高</td></tr><tr><td>Eclipse OpenJ9 (原 IBM J9)</td><td>IBM</td><td>8,11,17,19,20</td><td>低(3.1k)</td><td>高性能、可扩展JIT、AOT特性支持</td><td>微服务、云原生架构</td></tr></tbody></table><h2 id="2-字节码文件详解">2.字节码文件详解</h2><h3 id="2-1-Java虚拟机的组成">2.1 Java虚拟机的组成</h3><p>Java虚拟机主要分为以下几个组成部分：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-31-1024x498.png" alt="img"></p><ul><li>类加载子系统：核心组件类加载器，负责将字节码文件中的内容加载到内存中。</li><li>运行时数据区：JVM管理的内存，创建出来的对象、类的信息等等内容都会放在这块区域中。</li><li>执行引擎：包含了即时编译器、解释器、垃圾回收器，执行引擎使用解释器将字节码指令解释成机器码，使用即时编译器优化性能，使用垃圾回收器回收不再使用的对象。</li><li>本地接口：调用本地使用C/C++编译好的方法，本地方法在Java中声明时，都会带上native关键字，如下图所示。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-32.png" alt="img"></p><h3 id="2-2字节码文件的组成">2.2字节码文件的组成</h3><h4 id="以正确的姿势打开文件">以正确的姿势打开文件</h4><p>字节码文件中保存了源代码编译之后的内容，以二进制方式存储，无法用记事本直接打开阅读。</p><p>可以通过NotePad++使用十六进制插件查看class文件：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-33.png" alt="img"></p><p>无法解读出文件里包含的内容，推荐使用 jclasslib工具查看字节码文件。 Github地址： <a href="https://github.com/ingokegel/jclasslib">https://github.com/ingokegel/jclasslib</a></p><p>字节码文件总共可以分为以下几个部分：</p><ul><li><strong>基础信息</strong>：魔数、字节码文件对应的Java版本号、访问标识(public final等等)、父类和接口信息</li><li><strong>常量池</strong>**：** 保存了字符串常量、类或接口名、字段名，主要在字节码指令中使用</li><li><strong>字段：</strong> 当前类或接口声明的字段信息</li><li><strong>方法：</strong> 当前类或接口声明的方法信息，核心内容为方法的字节码指令</li><li><strong>属性：</strong> 类的属性，比如源码的文件名、内部类的列表等</li></ul><h4 id="1-基本信息">1.基本信息</h4><p>基本信息包含了jclasslib中能看到的两块内容：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-34.png" alt="img"></p><h5 id="Magic魔数">Magic魔数</h5><p>每个Java字节码文件的前四个字节是固定的，用16进制表示就是0xcafebabe。文件是无法通过文件扩展名来确定文件类型的，文件扩展名可以随意修改不影响文件的内容。软件会使用文件的头几个字节（文件头）去校验文件的类型，如果软件不支持该种类型就会出错。</p><p>比如常见的文件格式校验方式如下：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-35.png" alt="img"></p><p>Java字节码文件中，将文件头称为magic魔数。Java虚拟机会校验字节码文件的前四个字节是不是0xcafebabe，如果不是，该字节码文件就无法正常使用，Java虚拟机会抛出对应的错误。</p><h5 id="主副版本号">主副版本号</h5><p>主副版本号指的是编译字节码文件时使用的JDK版本号，主版本号用来标识大版本号，JDK1.0-1.1使用了45.0-45.3，JDK1.2是46之后每升级一个大版本就加1；副版本号是当主版本号相同时作为区分不同版本的标识，一般只需要关心主版本号。</p><p>1.2之后大版本号计算方法就是 : 主版本号 – 44，比如主版本号52就是JDK8。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-36.png" alt="img"></p><p>版本号的作用主要是判断当前字节码的版本和运行时的JDK是否兼容。</p><p>报下面错误是兼容性出现问题。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-37.png" alt="img"></p><p>方法1：升级IDEA编译的Jdk版本。（容易引发其它的兼容性问题）</p><p>方法2：改变依赖的版本，替换包名，降低版本。（工作中推荐选用该方法）</p><h4 id="其他基础信息">其他基础信息</h4><p>其他基础信息包括访问标识、类和接口索引，如下：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-38-1024x488.png" alt="img"></p><h4 id="2-常量池：-保存了字符串常量，类或接口名，字段名主要在字节码指令中使用。">2.**常量池：**保存了字符串常量，类或接口名，字段名主要在字节码指令中使用。</h4><p>常量池中的数据都有一个编号，编号从1开始。比如“我爱北京天安门”这个字符串，在常量池中的编号就是7。在字段或者字节码指令中通过编号7可以快速的找到这个字符串。</p><p>字节码指令中通过编号引用到常量池的过程称之为符号引用。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-39.png" alt="img"></p><h4 id="3-字段：-当前类或接口声明的字段信息。">3.**字段：**当前类或接口声明的字段信息。</h4><p>如下图中，定义了两个字段a1和a2，这两个字段就会出现在字段这部分内容中。同时还包含字段的名字、描述符（字段的类型）、访问标识（public/private static final等）。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-40.png" alt="img"></p><h4 id="4-方法：-当前类或接口声明的方法信息字节码指令。">4.**方法：**当前类或接口声明的方法信息字节码指令。</h4><p>字节码中的方法区域是存放<strong>字节码指令</strong>的核心位置，字节码指令的内容存放在方法的Code属性中。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-41-1024x375.png" alt="img"></p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">int i</span> = 0;</span><br><span class="line"><span class="attribute">int j</span> = i + 1;</span><br></pre></td></tr></table></figure><p>这段代码编译成字节码指令之后是如下内容：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-42.png" alt="img"></p><p>我们需要先理解两块内存区域：操作数栈和局部变量表。</p><p><strong>操作数栈</strong>是用来存放临时数据的内容，是一个栈式的结构，先进后出。</p><p><strong>局部变量****表</strong>是存放方法中的局部变量，包含方法的参数、方法中定义的局部变量，在编译期就已经可以确定方法有多少个局部变量。</p><p>1、iconst_0，将常量0放入操作数栈。此时栈上只有0</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-43-1024x420.png" alt="img"></p><p>2、istore_1会从操作数栈中，将栈顶的元素弹出来，此时0会被弹出，放入局部变量表的1号位置。局部变量表中的1号位置，在编译时就已经确定是局部变量i使用的位置。完成了对局部变量i的赋值操作。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-44-1024x440.png" alt="img"></p><p>3、iload_1将局部变量表1号位置的数据放入操作数栈中，此时栈中会放入0。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-45-1024x430.png" alt="img"></p><p>4、iconst_1会将常量1放入操作数栈中。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-46-1024x431.png" alt="img"></p><p>5、iadd会将操作数栈顶部的两个数据相加，现在操作数栈上有两个数0和1，相加之后结果为1放入操作数栈中，此时栈上只有一个数也就是相加的结果1。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-47-1024x428.png" alt="img"></p><p>6、istore_2从操作数栈中将1弹出，并放入局部变量表的2号位置，2号位置是j在使用。完成了对局部变量j的赋值操作。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-48-1024x419.png" alt="img"></p><p>7.return语句执行，方法结束并返回。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-49-1024x421.png" alt="img"></p><h4 id="i-与-i">i++与++i</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-50.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-51.png" alt="img"></p><p>问：int i = 0; i = i++; 最终i的值是多少？</p><p>答：答案是0，我通过分析字节码指令发现，i++先把0取出来放入临时的操作数栈中，</p><p>接下来对i进行加1，i变成了1，最后再将之前保存的临时值0放入i，最后i就变成了0。</p><h4 id="5-属性：-类的属性，比如源码的文件名内部类的列表等。">5.**属性：**类的属性，比如源码的文件名内部类的列表等。</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-52.png" alt="img"></p><h4 id="字节码文件常见工具使用">字节码文件常见工具使用</h4><p>1.javap</p><p>javap是JDK自带的反编译工具，可以通过控制台查看字节码文件的内容。适合在服务器上查看字节码文件内容。</p><p>直接输入javap查看所有参数。输入<code>javap -v</code> 字节码文件名称 查看具体的字节码信息。如果jar包需要先使用 <code>jar –xvf</code> 命令解压。</p><p>2jclasslib插件</p><p>3.Arthas</p><p>Arthas是一款线上监控诊断产品，通过全局视角实时查看应用的load、内存、gc、线程的状态信息，并能在不修改应用代码的情况下，对业务问题进行诊断，大大提升线上问题排查的效率。</p><p>使用：</p><p>使用<code>java -jar arthas-boot.jar</code> 启动程序。</p><p>输入需要Arthas监控的进程id。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-53-1024x534.png" alt="img"></p><p>输入命令即可使用。</p><p>dashboard -i 2000 -n 3 ：隔2秒，执行3次。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-54.png" alt="img"></p><h3 id="2-3类的生命周期加载阶段">2.3类的生命周期加载阶段</h3><p>类的生命周期描述了一个类加载、使用、卸载的整个过程。整体可以分为：</p><ul><li>加载</li><li>连接，其中又分为验证、准备、解析三个子阶段</li><li>初始化</li><li>使用</li><li>卸载</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-55-1024x408.png" alt="img"></p><h4 id="2-3-1加载阶段">2.3.1加载阶段</h4><p>1.加载(Loading)阶段第一步是类加载器根据类的全限定名通过不同的渠道(（本地文件，通过网络传输的类，动态代理生成）)以二进制流的方式获取字节码信息，程序员可以使用Java代码拓展的不同的渠道。</p><p>2.类加载器在加载完类之后，Java虚拟机会将字节码中的信息保存到方法区中。</p><p>3.生成一个InstanceKlass对象，保存类的所有信息，里面还包含实现特定功能比如多态的信息。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-57.png" alt="img"></p><p>4.Java虚拟机还会在堆中生成一份与方法区中数据类似的java.lang.Class对象。作用是在Java代码中获取类的信息以及存储静态字段的数据。（JDK8及之后）</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-58.png" alt="img"></p><h4 id="2-3-2-连接阶段">2.3.2 连接阶段</h4><p>连接阶段分为三个子阶段:</p><ul><li>验证，验证内容是否满足《Java虚拟机规范》。</li><li>准备，给静态变量赋初值。</li><li>解析，将常量池中的符号引用替换成指向内存的直接引用。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-59-1024x451.png" alt="img"></p><p><strong>1.验证</strong>：验证内容是否满足Java虚拟机规范。</p><p>1.文件格式验证，比如文件是否以0xCAFEBABE开头，主次版本号是否满足当前Java虚拟机版本要求。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-63-1024x289.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-62.png" alt="img"></p><p>major是主版本号，&gt;=常量一般是45，对jdk1.8来说最高版本号是52，对jdk8只能支持45-52之间的主版本号。副版本号不能大于0</p><p>2、元信息验证，例如类必须有父类（super不能为空）。</p><p>3、验证程序执行指令的语义，比如方法内的指令执行中跳转到不正确的位置。</p><p>4、符号引用验证，例如是否访问了其他类中private的方法等。</p><p><strong>2</strong>.<strong>准备</strong>：准备阶段为静态变量（static）分配内存并设置初值，每一种基本数据类型和引用数据类型都有其初值。</p><table><thead><tr><th><strong>数据类型</strong></th><th><strong>初始值</strong></th></tr></thead><tbody><tr><td><strong>int</strong></td><td><strong>0</strong></td></tr><tr><td><strong>long</strong></td><td><strong>0L</strong></td></tr><tr><td><strong>short</strong></td><td><strong>0</strong></td></tr><tr><td><strong>char</strong></td><td><strong>‘\u0000’</strong></td></tr><tr><td><strong>byte</strong></td><td><strong>0</strong></td></tr><tr><td><strong>boolean</strong></td><td><strong>false</strong></td></tr><tr><td><strong>double</strong></td><td><strong>0.0</strong></td></tr><tr><td><strong>引用****数据类型</strong></td><td><strong>null</strong></td></tr></tbody></table><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-64-1024x337.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-65-1024x512.png" alt="img"></p><p><strong>3.解析</strong>：将常量池中的符号引用替换成指向内存的直接引用。直接引用不再使用编号，而是使用内存中的地址进行访问具体的数据。</p><h4 id="2-3-3初始化阶段">2.3.3初始化阶段</h4><p>初始化阶段会执行字节码文件中clinit（class init 类的初始化）方法的字节码指令，包含了静态代码块中的代码，并为静态变量赋值。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-66.png" alt="img"></p><ul><li>init方法，会在<strong>对象</strong>初始化时执行</li><li>main方法，主方法</li><li>clinit方法，<strong>类</strong>的初始化阶段执行</li></ul><hr><p>关于init和clint的区别：</p><table><thead><tr><th>名称</th><th>全名</th><th>类型</th><th>什么时候执行</th><th>作用</th></tr></thead><tbody><tr><td><code>&lt;init&gt;</code></td><td>实例构造方法</td><td>对象方法</td><td><code>new</code> 一个对象时（构造器执行）</td><td>初始化“对象”</td></tr><tr><td><code>&lt;clinit&gt;</code></td><td>类初始化方法</td><td>静态方法</td><td>第一次使用类时自动执行（仅一次）</td><td>初始化“类级别的静态内容”</td></tr></tbody></table><p><code>&lt;init&gt;</code> 是实例构造器方法，每次创建对象都会执行；而 <code>&lt;clinit&gt;</code> 是类初始化方法，只在类被第一次加载时执行一次，用来处理静态变量初始化和静态代码块。</p><p>1️⃣ <code>&lt;init&gt;</code>：构造方法（非静态）</p><ul><li>对应 Java 中的构造函数（<code>public Demo2() &#123;&#125;</code>）</li><li>每次创建对象（<code>new Demo2()</code>）时执行一次</li><li>是 <strong>对象级别</strong> 的初始化方法</li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Demo</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Demo</span>()</span> &#123;</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">&quot;构造器执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译后会生成 <code>&lt;init&gt;</code> 方法。</p><p>2️⃣ <code>&lt;clinit&gt;</code>：类初始化方法（静态）</p><ul><li><strong>不是你写的代码中显式的方法</strong>，而是编译器自动生成的</li><li>当类中包含：<ul><li>静态变量赋值（如：<code>public static int i = 10;</code>）</li><li>或静态代码块（如：<code>static &#123; System.out.println(&quot;xxx&quot;); &#125;</code>）</li><li>编译器会把这些放进一个叫 <code>&lt;clinit&gt;</code> 的方法中</li></ul></li><li><strong>这个方法在类加载时只执行一次</strong></li></ul><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> i = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;静态代码块&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译后，会生成一个 <code>&lt;clinit&gt;</code> 方法，里面包含上面两个静态初始化语句。</p><hr><p>继续来看clinit方法中的字节码指令：</p><p>1、iconst_1，将常量1放入操作数栈。此时栈中只有1这个数。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1136-1024x350.png" alt="img"></p><p>2、putstatic指令会将操作数栈上的数弹出来，并放入堆中静态变量的位置，字节码指令中#2指向了常量池中的静态变量value，在解析阶段会被替换成变量的地址。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1137-1024x345.png" alt="img"></p><p>3、后两步操作类似，执行value=2，将堆上的value赋值为2。</p><p>如果将代码的位置互换：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1</span> &#123;</span><br><span class="line">    <span class="type">static</span> &#123;</span><br><span class="line">        value = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">public</span> <span class="type">static</span> <span class="type">int</span> value = <span class="number">1</span>;</span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="type">static</span> <span class="type">void</span> <span class="title">main</span><span class="params">(<span class="type">String</span>[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1138.png" alt="img"></p><p>这样初始化结束之后，最终value的值就变成了1而不是2。</p><p>以下几种方式会导致类的初始化：</p><ul><li>1.访问一个类的静态变量或者静态方法（如果变量时final修饰的并且等号右边是常量不会触发初始化，因为在连接阶段会直接赋常量值）</li><li>2.调用Class.forName(String className)</li><li>3.new一个该类的对象时。</li><li>4.执行Main方法的当前类。</li></ul><p>添加-XX:+TraceClassLoading 参数可以打印出加载并初始化的类</p><p><strong>面试题1：</strong></p><p>如下代码的输出结果是什么？</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">publicclassTest1 &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(<span class="params">String[] <span class="keyword">args</span></span>)</span> &#123;</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">        newTest1();</span><br><span class="line">        newTest1();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    publicTest1()&#123;</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">&quot;B&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">&quot;C&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">&quot;D&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析步骤：</p><p><strong>Java 中的执行顺序是：</strong></p><ol><li><strong>静态代码块</strong>（<code>static&#123;&#125;</code>）——类加载时只执行一次</li><li>执行 <code>main()</code> 方法</li><li>创建对象时：<ul><li>先执行 <strong>构造代码块</strong>（<code>&#123;&#125;</code>）</li><li>再执行 <strong>构造方法</strong>（<code>Test1()</code>）</li></ul></li></ol><p>ldc #9是从常量池中将字符串D加载到操作数栈中。</p><p>invokevirtual是调用Println方法打印操作数栈上的内容。</p><p>1、执行main方法之前，先执行clinit指令。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1139-1024x132.png" alt="img"></p><p>指令会输出D</p><p>2、执行main方法的字节码指令。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1140.png" alt="img"></p><p>指令会输出A</p><p>3、创建两个对象，会执行两次对象初始化的指令。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1141.png" alt="img"></p><p>这里会输出CB，源代码中输出C这行，被放到了对象初始化的一开始来执行。</p><p>所以最后的结果应该是DACBCB</p><p>小结：类加载时先执行一次静态代码块，然后每次创建对象时都会先执行构造代码块 <code>&#123;&#125;</code>，再执行构造函数。这种顺序是面试中常考的基础知识点。</p><p>注意：构造代码块优于构造方法执行，这就是为什么C在B前面执行了</p><h4 id="clinit不会执行的几种情况">clinit不会执行的几种情况</h4><p>如下几种情况是不会进行初始化指令执行的：</p><p>1.无静态代码块且无静态变量赋值语句。</p><p>2.有静态变量的声明，但是<strong>没有赋值语句</strong>。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1142.png" alt="img"></p><p>3.<strong>静态变量</strong>的定义<strong>使用final关键字</strong>，这类变量会在准备阶段直接进行初始化。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1144.png" alt="img"></p><p>注意：</p><p>1.直接访问父类的静态变量，不会触发子类的初始化</p><p>2.子类的初始化clinit调用之前，会先调用父类的clinit初始化方法。</p><p><strong>面试题2：</strong></p><p>如下代码的输出结果是什么？</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Demo01</span> </span>&#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        new B02();</span><br><span class="line">        System.out.println(B02.a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A02</span></span>&#123;</span><br><span class="line">    static <span class="keyword">int</span> a= <span class="number">0</span>;</span><br><span class="line">    static&#123;</span><br><span class="line">        a = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B02</span> <span class="title">extends</span> <span class="title">A02</span></span>&#123;</span><br><span class="line">    static&#123;</span><br><span class="line">        a = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析步骤：</p><ul><li>1、调用new创建对象，需要初始化B02，优先初始化父类。</li><li>2、执行A02的初始化代码，将a赋值为1。</li><li>3、B02初始化，将a赋值为2。</li></ul><p>最终答案为2</p><p>变化</p><p>将<code>new B02();</code>注释掉会怎么样？</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1145.png" alt="img"></p><p>分析步骤：</p><ul><li>1、访问父类的静态变量，只初始化父类。</li><li>2、执行A02的初始化代码，将a赋值为1。</li></ul><p><strong>访问父类的静态变量，只初始化父类，a是A02的变量，属于父类的变量，所以只初始化了类A02</strong></p><p>答案为1</p><p><strong>验证题，我们验证后发现如下两个结论：</strong></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1146-1024x541.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1147-1024x450.png" alt="img"></p><h4 id="2-3-4类的声明周期总结">2.3.4类的声明周期总结</h4><p>1.加载阶段</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1148-1024x569.png" alt="img"></p><p>2，3,4连接阶段</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1149-1024x431.png" alt="img"></p><p>5初始化阶段</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1150-1024x557.png" alt="img"></p><p>6.使用阶段</p><p>7.卸载阶段</p><h3 id="2-4类加载器的分类">2.4类加载器的分类</h3><h4 id="2-4-1什么是类加载器">2.4.1什么是类加载器</h4><p>类加载器ClassLoader：是Java虚拟机提供给应用程序去实现获取类和接口字节码数据的技术，类加载器只参与加载过程中的字节码获取并加载到内存这一部分。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1151-1024x398.png" alt="img"></p><p><strong>类加载器的作用？</strong></p><p>类加载器负责在类加载过程中的字节码获取并加载到内存中。通过加载字节码数据放入内存转换成byte[]，接下来调用虚拟机底层方法将byte[]转换成方法区和堆中的数据。</p><h4 id="2-4-2类加载器的分类">2.4.2类加载器的分类</h4><p>类加载器分为两类，一类是Java代码中实现的，一类是Java虚拟机底层源码实现的。</p><ul><li>虚拟机底层实现：源代码位于Java虚拟机的源码中，实现语言与虚拟机底层语言一致，比如Hotspot使用C++。主要目的是保证Java程序运行中基础类被正确地加载，比如java.lang.String，Java虚拟机需要确保其可靠性。</li><li>JDK中默认提供或者自定义：JDK中默认提供了多种处理不同渠道的类加载器，程序员也可以自己根据需求定制，使用Java语言。所有Java中实现的类加载器都需要继承<strong>ClassLoader</strong>这个抽象类。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1152.png" alt="img"></p><p>JDK9之后出现模块化，所以JDK9是分水岭。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1154-1024x546.png" alt="img"></p><p>类加载器的详细信息可以通过Arthas的classloader命令查看：</p><p><code>classloader</code> - 查看 classloader 的继承树，urls，类加载信息，使用 classloader 去 getResource</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1155-1024x398.png" alt="img"></p><ul><li>BootstrapClassLoader是启动类加载器，numberOfInstances是类加载器的数量只有1个，loadedCountTotal是加载类的数量1861个。</li><li>ExtClassLoader是扩展类加载器</li><li>AppClassLoader是应用程序类加载器</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1156.png" alt="img"></p><h4 id="2-4-3启动类加载器（Bootstrap-ClassLoader）">2.4.3启动类加载器（Bootstrap ClassLoader）</h4><ul><li>启动类加载器（Bootstrap ClassLoader）是由Hotspot虚拟机提供的、使用<strong>C++编写</strong>的类加载器。</li><li>默认加载Java安装目录/jre/lib下的类文件，比如rt.jar，tools.jar，resources.jar等。（rt.jar是最核心的jar包。string，integer，long，日期类。）</li></ul><p>运行如下代码：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** * 启动程序类加载器案例 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BootstrapClassLoaderDemo</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="type">static</span> <span class="type">void</span> <span class="title">main</span><span class="params">(<span class="type">String</span>[] args)</span> throwsIOException </span>&#123;</span><br><span class="line">        ClassLoader classLoader = <span class="type">String</span>.<span class="keyword">class</span>.<span class="built_in">getClassLoader</span>();</span><br><span class="line">        System.out.<span class="built_in">println</span>(classLoader);</span><br><span class="line"></span><br><span class="line">        System.in.<span class="built_in">read</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这段代码通过String类获取到它的类加载器并且打印，结果是<code>null</code>。这是因为启动类加载器<strong>在JDK8中是由C++语言来编写的</strong>，在Java代码中去获取既不适合也不安全，所以才返回<code>null</code></p><p>在Arthas中可以通过<code>sc -d 类名</code>的方式查看加载这个类的类加载器详细的信息，比如：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1157.png" alt="img"></p><p>通过上图可以看到，java.lang.String类的类加载器是空的，Hash值也是null。</p><p><strong>如何让启动类加载器去加载用户jar包：</strong></p><ul><li>1.把要扩展的类打成jar包，放入jre/lib下进行扩展（不推荐，会要求名称符合规范）。</li><li>2.使用参数进行扩展。推荐，使用-Xbootclasspath/a:jar包目录/jar包名进行扩展。</li></ul><p>如下图，在IDEA配置中添加虚拟机参数，就可以加载<code>D:/jvm/jar/classloader-test.jar</code>这个jar包了。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1158.png" alt="img"></p><h4 id="2-4-4扩展类加载器和应用程序类加载器（Extension-ClassLoader-和-Application-ClassLoader）">2.4.4扩展类加载器和应用程序类加载器（Extension ClassLoader 和 Application ClassLoader）</h4><ul><li>扩展类加载器和应用程序类加载器都是JDK提供的，使用Java编写的类加载器。</li><li>它们的源码都位于sun.misc.Launcher中，是一个静态内部类。继承自URLClassLoader。具备通过目录或者指定jar包将字节码文件加载到内存中。</li></ul><p>继承关系图：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1160-1024x292.png" alt="img"></p><ul><li>ClassLoader类定义了具体的行为模式，简单来说就是先从本地或者网络<strong>获得字节码信息</strong>，然后调用虚拟机底层的方法<strong>创建方法区和堆上的对象</strong>。这样的好处就是让子类只需要去实现如何获取字节码信息这部分代码。</li><li>SecureClassLoader提供了证书机制，提升了安全性。</li><li>URLClassLoader提供了根据URL获取目录下或者指定jar包进行加载，获取字节码的数据。</li><li>扩展类加载器和应用程序类加载器继承自URLClassLoader，获得了上述的三种能力。</li></ul><p><strong>扩展类加载器</strong></p><p>扩展类加载器（Extension Class Loader）是JDK中提供的、使用Java编写的类加载器。默认加载Java安装目录/jre/lib/ext下的类文件。</p><p>通过扩展类加载器去加载用户jar包：</p><ul><li><strong>放入/jre/lib/ext下进行扩展</strong>。不推荐，尽可能不要去更改JDK安装目录中的内容。</li><li><strong>使用参数进行扩展使用参数进行扩展</strong>。推荐，使用-Djava.ext.dirs=jar包目录 进行扩展,这种方式会覆盖掉原始目录，可以用;(windows):(macos/linux)追加上原始目录</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1161.png" alt="img"></p><p>使用<code>引号</code>将整个地址包裹起来，这样路径中即便是有空格也不需要额外处理。路径中要包含原来ext文件夹，同时在最后加上扩展的路径。</p><p><strong>应用程序加载器</strong></p><p>应用程序类加载器会加载classpath下的类文件，默认加载的是项目中的类以及通过maven引入的第三方jar包中的类。</p><p>如下案例中，打印出<code>Student</code>和<code>FileUtils</code>的类加载器：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** * 应用程序类加载器案例 */</span>publicclassAppClassLoaderDemo &#123;</span><br><span class="line">    publicstaticvoidmain(String[] args) throwsIOException, InterruptedException &#123;</span><br><span class="line">        //当前项目中创建的Student类Student student = newStudent();</span><br><span class="line">        ClassLoader classLoader = Student.<span class="keyword">class</span>.getClassLoader();</span><br><span class="line">        <span class="keyword">System</span>.<span class="keyword">out</span>.println(classLoader);</span><br><span class="line"></span><br><span class="line">        //maven依赖中包含的类ClassLoader classLoader1 = FileUtils.<span class="keyword">class</span>.getClassLoader();</span><br><span class="line">        <span class="keyword">System</span>.<span class="keyword">out</span>.println(classLoader1);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">System</span>.<span class="keyword">in</span>.<span class="keyword">read</span>();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出结果如下：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1162.png" alt="img"></p><p>类加载器的加载路径可以通过classloader –c hash值 查看：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1163-1024x399.png" alt="img"></p><h3 id="2-5、双亲委派机制">2.5、双亲委派机制</h3><p>双亲委派机制指的是：<strong>当一个类加载器接收到加载类的任务时，会自底向上查找是否加载</strong></p><p><strong>再由顶向下进行加载</strong>。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1164.png" alt="img"></p><p>详细流程：</p><p>每个类加载器都有一个父类加载器（Java实现的类加载器，<strong>内部都保存了一个parent的成员变量</strong>，它表示我的父类加载器是谁）。父类加载器的关系如下，启动类加载器没有父类加载器：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1165.png" alt="img"></p><p><strong>在类加载的过程中，每个类加载器都会先检查是否已经加载了该类，如果已经加载则直接返回，否则会将加载请求委派给父类加载器。</strong></p><p>自己没干的就让父类干；自己干了的就直接给你</p><h4 id="2-5-1案例1：">2.5.1案例1：</h4><p>比如com.itheima.my.A假设在启动类加载器的加载目录中，而应用程序类加载器接到了加载类的任务。</p><p>1、应用程序类加载器首先判断自己加载过没有，没有加载过就交给父类加载器 - 扩展类加载器。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1166.png" alt="img"></p><p>2、扩展类加载器也没加载过，交给他的父类加载器 - 启动类加载器。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1167-1024x462.png" alt="img"></p><p>3、启动类加载器发现已经加载过，直接返回。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1168-1024x448.png" alt="img"></p><h4 id="2-5-2案例2：">2.5.2案例2：</h4><p>B类在扩展类加载器加载路径中，同样应用程序类加载器接到了加载任务，按照案例1中的方式一层一层向上查找，<strong>发现都没有加载过</strong>。那么启动类加载器会首先尝试加载。它发现这类不在它的加载目录中，向下传递给扩展类加载器。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1169-1024x438.png" alt="img"></p><p>扩展类加载器发现这个类在它加载路径中，加载成功并返回。（注：<strong>如果所有类加载器都无法加载这个类，最终抛出 ClassNotFoundException</strong>）</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1170-1024x436.png" alt="img"></p><p>如果第二次再接收到加载任务，同样地向上查找。扩展类加载器发现已经加载过，就可以返回了。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1171-1024x440.png" alt="img"></p><h4 id="2-5-3双亲委派机制的作用">2.5.3双亲委派机制的作用</h4><ul><li>1.保证类加载的安全性。通过双亲委派机制避免恶意代码替换JDK中的核心类库，比如java.lang.String，确保核心类库的完整性和安全性。</li><li>2.避免重复加载。双亲委派机制可以避免同一个类被多次加载。</li></ul><h4 id="2-5-4如何指定加载类的类加载器？">2.5.4如何指定加载类的类加载器？</h4><p>在Java中如何使用代码的方式去主动加载一个类呢？</p><p>方式1：使用Class.forName方法，使用当前类的类加载器去加载指定的类。</p><p>方式2：获取到类加载器，通过类加载器的loadClass方法指定某个类加载器加载。</p><p>例如：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1172.png" alt="img"></p><h4 id="2-5-5三个面试题">2.5.5三个面试题</h4><p>1、如果一个类重复出现在三个类加载器的加载位置，应该由谁来加载？</p><p>启动类加载器加载，根据双亲委派机制，它的优先级是最高的</p><p>2、String类能覆盖吗，在自己的项目中去创建一个java.lang.String类，会被加载吗？</p><p>不能，会返回启动类加载器加载在rt.jar包中的String类。</p><p>3、<strong>类的双亲委派机制是什么？</strong>（！）</p><ul><li><p>1.先描述双亲委派机制的流程。</p></li><li><p>2.然后描述类加载器之间的关系。</p></li><li><p>3.双亲委派机制的好处</p></li><li><p>当一个类加载器去加载某个类的时候，会自底向上查找是否加载过，如果加载过就直接返回，如果一直到最顶层的类加载器都没有加载，再由顶向下进行加载。</p></li><li><p>应用程序类加载器的父类加载器是扩展类加载器，扩展类加载器的父类加载器是启动类加载器。</p></li><li><p>双亲委派机制的好处有两点：第一是避免恶意代码替换JDK中的核心类库，比如java.lang.String，确保核心类库的完整性和安全性。第二是避免一个类重复地被加载。</p></li></ul><h3 id="2-6打破双亲委派机制">2.6打破双亲委派机制</h3><p>有三种方式，但本质上只有第一种算是真正的打破了双亲委派机制：</p><ul><li>自定义类加载器并且重写loadClass方法。Tomcat通过这种方式实现应用之间类隔离，《面试篇》中分享它的做法。</li><li>线程上下文类加载器。利用上下文类加载器加载类，比如JDBC和JNDI等。</li><li>Osgi框架的类加载器。历史上Osgi框架实现了一套新的类加载器机制，允许同级之间委托进行类的加载，目前很少使用。</li></ul><h4 id="2-6-1打破类的双亲委派机制-自定义类加载器">2.6.1打破类的双亲委派机制 自定义类加载器</h4><p>一个Tomcat程序中是可以运行多个Web应用的，如果这两个应用中出现了相同限定名的类，比如Servlet类，Tomcat要保证这两个类都能加载并且它们应该是不同的类。如果不打破双亲委派机制，当应用类加载器加载Web应用1中的MyServlet之后，Web应用2中相同限定名的MyServlet类就无法被加载了。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1173.png" alt="img"></p><p>Tomcat使用了自定义类加载器来实现应用之间类的隔离。 每一个应用会有一个独立的类加载器加载对应的类。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1174.png" alt="img"></p><p>那么自定义加载器是如何能做到的呢？首先我们需要先了解，双亲委派机制的代码到底在哪里，接下来只需要把这段代码消除即可。</p><p>ClassLoader中包含了4个核心方法，双亲委派机制的核心代码就位于loadClass方法中。</p><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">Class</span>&lt;?&gt; loadClass(String <span class="keyword">name</span>)</span><br><span class="line">类加载的入口，提供了双亲委派机制。内部会调用findClass   重要</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">Class</span>&lt;?&gt; findClass(String <span class="keyword">name</span>)</span><br><span class="line">由类加载器子类实现,获取二进制数据调用defineClass ，比如URLClassLoader会根据文件路径去获取类文件中的二进制数据。    重要</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">Class</span>&lt;?&gt; defineClass(String <span class="keyword">name</span>, byte[] b, <span class="built_in">int</span> off, <span class="built_in">int</span> len)</span><br><span class="line">做一些类名的校验，然后调用虚拟机底层的方法将字节码信息加载到虚拟机内存中</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> void resolveClass(<span class="keyword">Class</span>&lt;?&gt; c)</span><br><span class="line">执行类生命周期中的连接阶段</span><br></pre></td></tr></table></figure><p>注：</p><ul><li><ol><li>自定义类加载器可以重写findClass方法来<strong>自定义获取字节码信息的途径</strong>。</li></ol></li><li><ol start="2"><li>如果想通过自定义类加载器来打破双亲委派机制则需要重写loadClass方法，不再实现双亲委派机制。</li></ol></li></ul><p>关于findClass：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1175-1024x403.png" alt="img"></p><p>我们接着继续看ClassLoader中4个核心方法</p><p>1、入口方法：（采用类加载器.loadclass方法默认不会执行连接和初始化。而使用Class.forNmae（）会执行连接和初始化。）</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1176.png" alt="img"></p><p>2、再进入看下：（synchronized保证多线程条件下同一个类不会被多次加载）</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1177.png" alt="img"></p><p>如果查找都失败，进入加载阶段，首先会由启动类加载器加载，这段代码在<code>findBootstrapClassOrNull</code>中。如果失败会抛出异常，接下来执行下面这段代码：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1178.png" alt="img"></p><p>父类加载器加载失败就会抛出异常，回到子类加载器的这段代码，这样就实现了加载并向下传递。</p><p>3、最后根据传入的参数判断是否进入连接阶段：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1179.png" alt="img"></p><p>以下代码：<strong>通过自定义类加载器来打破 Java 的双亲委派机制</strong>，实现对同一个类文件的“重复加载”，从而得到两个<strong>互相不等的类对象</strong>（类对象层面不同）。</p><figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">packageclassloader</span>.<span class="property">broken</span>;<span class="comment">//package com.itheima.jvm.chapter02.classloader.broken;importorg.apache.commons.io.IOUtils;</span></span><br><span class="line"></span><br><span class="line">importjava.<span class="property">io</span>.<span class="property">File</span>;</span><br><span class="line">importjava.<span class="property">io</span>.<span class="property">FileInputStream</span>;</span><br><span class="line">importjava.<span class="property">io</span>.<span class="property">IOException</span>;</span><br><span class="line">importjava.<span class="property">io</span>.<span class="property">InputStream</span>;</span><br><span class="line">importjava.<span class="property">nio</span>.<span class="property">charset</span>.<span class="property">StandardCharsets</span>;</span><br><span class="line">importjava.<span class="property">security</span>.<span class="property">ProtectionDomain</span>;</span><br><span class="line">importjava.<span class="property">util</span>.<span class="property">regex</span>.<span class="property">Matcher</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** * 打破双亲委派机制 - 自定义类加载器 */</span><span class="variable">publicclassBreakClassLoader1</span> <span class="title function_">extendsClassLoader</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">private</span> <span class="title class_">String</span> <span class="variable">basePath</span>;</span><br><span class="line">    <span class="variable">private</span> <span class="variable">final</span> <span class="keyword">static</span> <span class="title class_">String</span> <span class="variable">FILE_EXT</span><span class="operator">=</span> <span class="string">&quot;.class&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置加载目录</span></span><br><span class="line">    <span class="variable">public</span> <span class="variable">void</span> <span class="title function_">setBasePath</span>(<span class="params">String</span> <span class="params">basePath</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">basePath</span> <span class="operator">=</span> <span class="variable">basePath</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用commons io 从指定目录下加载文件</span></span><br><span class="line">    <span class="variable">private</span> <span class="variable">byte</span>[] <span class="title function_">loadClassData</span>(<span class="params">String</span> <span class="params">name</span>)  &#123;</span><br><span class="line">        <span class="title function_">try</span>&#123;</span><br><span class="line">            <span class="title class_">String</span> <span class="variable">tempName</span> <span class="operator">=</span> <span class="variable">name</span>.<span class="property">replaceAll</span>(<span class="string">&quot;<span class="char escape_">\\</span>.&quot;</span>, <span class="title class_">Matcher</span>.<span class="property">quoteReplacement</span>(<span class="title class_">File</span>.<span class="property">separator</span>));</span><br><span class="line">            <span class="title class_">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="title function_">newFileInputStream</span>(<span class="variable">basePath</span> <span class="operator">+</span> <span class="variable">tempName</span> <span class="operator">+</span> <span class="variable">FILE_EXT</span>);</span><br><span class="line">            <span class="title function_">try</span>&#123;</span><br><span class="line">                returnIOUtils.<span class="property">toByteArray</span>(<span class="variable">fis</span>);</span><br><span class="line">            &#125; <span class="title function_">finally</span>&#123;</span><br><span class="line">                <span class="title class_">IOUtils</span>.<span class="property">closeQuietly</span>(<span class="variable">fis</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="title function_">catch</span>(<span class="params">Exception</span> <span class="params">e</span>) &#123;</span><br><span class="line">            <span class="title class_">System</span>.<span class="property">out</span>.<span class="property">println</span>(<span class="string">&quot;自定义类加载器加载失败，错误原因：&quot;</span><span class="operator">+</span> <span class="variable">e</span>.<span class="property">getMessage</span>());</span><br><span class="line">            returnnull;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//重写loadClass方法</span></span><br><span class="line">    @<span class="title class_">Override</span></span><br><span class="line">    <span class="variable">public</span> <span class="title class_">Class</span><span class="operator">&lt;</span>?<span class="operator">&gt;</span> <span class="title function_">loadClass</span>(<span class="title class_">String</span> <span class="variable">name</span>) <span class="title function_">throwsClassNotFoundException</span> &#123;</span><br><span class="line">        <span class="comment">//如果是java包下，还是走双亲委派机制</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">name</span>.<span class="property">startsWith</span>(<span class="string">&quot;java.&quot;</span>))&#123;</span><br><span class="line">            returnsuper.<span class="property">loadClass</span>(<span class="variable">name</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//从磁盘中指定目录下加载</span></span><br><span class="line">        <span class="variable">byte</span>[] <span class="variable">data</span> <span class="operator">=</span> <span class="title function_">loadClassData</span>(<span class="variable">name</span>);</span><br><span class="line">        <span class="comment">//调用虚拟机底层方法，方法区和堆区创建对象</span></span><br><span class="line">        <span class="title function_">returndefineClass</span>(<span class="variable">name</span>, <span class="variable">data</span>, <span class="number">0</span>, <span class="variable">data</span>.<span class="property">length</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">public</span> <span class="keyword">static</span> <span class="variable">void</span> <span class="title function_">main</span>(<span class="title class_">String</span>[] <span class="variable">args</span>) <span class="variable">throwsClassNotFoundException</span>, <span class="title class_">InstantiationException</span>, <span class="title class_">IllegalAccessException</span>, <span class="title class_">IOException</span> &#123;</span><br><span class="line">        <span class="comment">//第一个自定义类加载器对象</span></span><br><span class="line">        <span class="title class_">BreakClassLoader</span>1 classLoader1 <span class="operator">=</span> <span class="title function_">newBreakClassLoader1</span>();</span><br><span class="line">        classLoader1.<span class="property">setBasePath</span>(<span class="string">&quot;D:<span class="char escape_">\\</span>lib<span class="char escape_">\\</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Class</span><span class="operator">&lt;</span>?<span class="operator">&gt;</span> <span class="variable">clazz1</span> <span class="operator">=</span> classLoader1.<span class="property">loadClass</span>(<span class="string">&quot;com.itheima.my.A&quot;</span>);</span><br><span class="line">         <span class="comment">//第二个自定义类加载器对象</span></span><br><span class="line">        <span class="title class_">BreakClassLoader</span>1 classLoader2 <span class="operator">=</span> <span class="title function_">newBreakClassLoader1</span>();</span><br><span class="line">        classLoader2.<span class="property">setBasePath</span>(<span class="string">&quot;D:<span class="char escape_">\\</span>lib<span class="char escape_">\\</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Class</span><span class="operator">&lt;</span>?<span class="operator">&gt;</span> <span class="variable">clazz2</span> <span class="operator">=</span> classLoader2.<span class="property">loadClass</span>(<span class="string">&quot;com.itheima.my.A&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">System</span>.<span class="property">out</span>.<span class="property">println</span>(<span class="variable">clazz1</span> <span class="operator">==</span> <span class="variable">clazz2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Thread</span>.<span class="property">currentThread</span>().<span class="property">setContextClassLoader</span>(classLoader1);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">System</span>.<span class="property">out</span>.<span class="property">println</span>(<span class="title class_">Thread</span>.<span class="property">currentThread</span>().<span class="property">getContextClassLoader</span>());</span><br><span class="line"></span><br><span class="line">        <span class="title class_">System</span>.<span class="property">in</span>.<span class="property">read</span>();</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Java 中“类相等”的判断不仅看类名是否相同，还要看是由“哪个类加载器”加载的。同名类如果由不同加载器加载，JVM 会认为它们是两个不同的类。</strong></p><h5 id="自定义类加载器父类怎么是AppClassLoader呢？"><strong>自定义类加载器父类怎么是AppClassLoader呢？</strong></h5><p>在不手动指定父加载器的情况下，自定义类加载器的父加载器默认是 <strong>应用类加载器（AppClassLoader）</strong>，也就是加载我们项目代码的那个加载器。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1180.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1183-1024x524.png" alt="img"></p><p>以Jdk8为例，ClassLoader类中提供了构造方法设置parent的内容：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1181.png" alt="img"></p><p>这个构造方法由另外一个构造方法调用，其中父类加载器由getSystemClassLoader方法设置，该方法返回的是AppClassLoader。（<code>ClassLoader</code> 构造器中是如何设置 parent 的？）</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1182.png" alt="img"></p><ul><li><code>getSystemClassLoader()</code> 会返回当前 JVM 的系统类加载器（也就是 AppClassLoader）；</li><li>所以，如果你不显式写 <code>super(xxx)</code>，系统会自动帮你传入 <code>AppClassLoader</code> 作为父加载器。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1184-1024x372.png" alt="img"></p><p><strong>想改变默认父加载器怎么办？</strong></p><p>可以用如下方式指定：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ClassLoader</span> <span class="variable">myLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyClassLoader</span>(ClassLoader.getSystemClassLoader().getParent()); <span class="comment">// 把 parent 指定为 ExtClassLoader</span></span><br></pre></td></tr></table></figure><p>或者可以重写子类的构造方法，使用 <code>super(自定义parent)</code> 指定想要的父加载器。</p><h5 id="两个自定义类加载器加载相同限定名的类，不会冲突吗？"><strong>两个自定义类加载器加载相同限定名的类，不会冲突吗？</strong></h5><p><strong>不会冲突</strong>，在同一个Java虚拟机中，只有<strong>相同类加载器+相同的类限定名才会被认为是同一个类</strong>。</p><p>在Arthas中使用sc –d 类名的方式查看具体的情况。</p><p>如下代码：</p><figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">public</span> <span class="keyword">static</span> <span class="variable">void</span> <span class="title function_">main</span>(<span class="title class_">String</span>[] <span class="variable">args</span>) <span class="variable">throwsClassNotFoundException</span>, <span class="title class_">InstantiationException</span>, <span class="title class_">IllegalAccessException</span>, <span class="title class_">IOException</span> &#123;</span><br><span class="line">        <span class="comment">//第一个自定义类加载器对象</span></span><br><span class="line">        <span class="title class_">BreakClassLoader</span>1 classLoader1 <span class="operator">=</span> <span class="title function_">newBreakClassLoader1</span>();</span><br><span class="line">        classLoader1.<span class="property">setBasePath</span>(<span class="string">&quot;D:<span class="char escape_">\\</span>lib<span class="char escape_">\\</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Class</span><span class="operator">&lt;</span>?<span class="operator">&gt;</span> <span class="variable">clazz1</span> <span class="operator">=</span> classLoader1.<span class="property">loadClass</span>(<span class="string">&quot;com.itheima.my.A&quot;</span>);</span><br><span class="line">         <span class="comment">//第二个自定义类加载器对象</span></span><br><span class="line">        <span class="title class_">BreakClassLoader</span>1 classLoader2 <span class="operator">=</span> <span class="title function_">newBreakClassLoader1</span>();</span><br><span class="line">        classLoader2.<span class="property">setBasePath</span>(<span class="string">&quot;D:<span class="char escape_">\\</span>lib<span class="char escape_">\\</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">Class</span><span class="operator">&lt;</span>?<span class="operator">&gt;</span> <span class="variable">clazz2</span> <span class="operator">=</span> classLoader2.<span class="property">loadClass</span>(<span class="string">&quot;com.itheima.my.A&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="title class_">System</span>.<span class="property">out</span>.<span class="property">println</span>(<span class="variable">clazz1</span> <span class="operator">==</span> <span class="variable">clazz2</span>);</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure><p>打印的应该是false，因为两个类加载器不同，尽管加载的是同一个类名，最终Class对象也不是相同的。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1185.png" alt="img"></p><p>通过Arthas看也会出现两个不同的A类。</p><h4 id="补充：关于loadClass和findClass">补充：关于loadClass和findClass</h4><p>如果要扩展一个类的加载的渠道，应该是重写findClass方法，而不是loadClass去打破双亲委派机制。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1186-1024x463.png" alt="img"></p><p><code>loadClass()</code> 方法是整个类加载流程的“入口”，<strong>包含了双亲委派的逻辑</strong>；<br>如果你想自己定义怎么加载一个类，<strong>应该重写 <code>findClass()</code>，而不是篡改 <code>loadClass()</code> 的流程</strong>。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1187-1024x768.png" alt="img"></p><p><strong><code>findClass(String name)</code>（子类实现）</strong></p><p>你只要重写这个方法，就可以定义自己的“加载策略”：比如从本地文件、网络、数据库读取字节码，然后用 <code>defineClass()</code> 转换为 JVM 类对象。</p><p>总结：如果你要“扩展加载逻辑”但 <strong>不想破坏双亲委派机制</strong>（比如加一个新的加载路径、从加密 JAR 加载），应该 <strong>只重写 <code>findClass()</code></strong>；<br>如果你要“打破委派机制”实现“类隔离、插件沙箱”，可以 <strong>重写 <code>loadClass()</code> 但要清楚风险</strong>。</p><h4 id="2-6-2打破类的双亲委派机制-线程上下文类加载器">2.6.2打破类的双亲委派机制 线程上下文类加载器</h4><p>利用上下文类加载器加载类，比如JDBC和JNDI等。</p><p>我们来看下JDBC的案例：</p><p>1、JDBC中使用了DriverManager来管理项目中引入的不同数据库的驱动，比如mysql驱动、oracle驱动。</p><p>2.DriverManager属于rt.jar是启动类加载器加载的。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1188.png" alt="img"></p><p>3、依赖中的mysql驱动对应的类，由应用程序类加载器来加载。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1190.png" alt="img"></p><p>在类中有初始化代码：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1191.png" alt="img"></p><p>DriverManager属于rt.jar是启动类加载器加载的。而用户jar包中的驱动需要由应用类加载器加载，<em>这就违反了双亲委派机制</em>。（这点存疑，一会儿再讨论）</p><p>那么问题来了，DriverManager怎么知道jar包中要加载的驱动在哪儿？</p><p>步骤 1：Driver 类中的 static 块会注册驱动</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    DriverManager.registerDriver(<span class="keyword">new</span> Driver());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当 mysql 驱动类加载时，它自己会注册到 DriverManager 中</p><p>2、DriverManager 启动时会调用 <code>loadInitialDrivers()</code></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1192.png" alt="img"></p><p>这个<code>loadInitialDrivers()</code>里用到了 <strong>JDK 提供的 SPI 机制</strong>，自动扫描 classpath 下所有实现了 <code>java.sql.Driver</code> 接口的类。</p><p>3、这里使用了SPI机制，去加载所有jar包中实现了Driver接口的实现类。（spi全称为（Service Provider Interface），是JDK内置的一种服务提供发现机制。）</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1193-1024x767.png" alt="img"></p><p>SPI 机制从哪里找这些“实现类”？</p><p>它去找每个 jar 包里的：</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">META</span>-<span class="keyword">INF</span>/services/java.sql.Driver</span><br></pre></td></tr></table></figure><p>文件中写的就是实现类名，例如：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com<span class="selector-class">.mysql</span><span class="selector-class">.cj</span><span class="selector-class">.jdbc</span>.Drive</span><br></pre></td></tr></table></figure><p>4、SPI 机制从哪里找这些“实现类”？</p><p>它去找每个 jar 包里的：</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">META</span>-<span class="keyword">INF</span>/services/java.sql.Driver</span><br></pre></td></tr></table></figure><p>文件中写的就是实现类名，例如：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com<span class="selector-class">.mysql</span><span class="selector-class">.cj</span><span class="selector-class">.jdbc</span>.Drive</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1195.png" alt="img"></p><p>5、SPI 是用哪个类加载器加载这些类的？</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ClassLoader cl <span class="operator">=</span> Thread.currentThread().getContextClassLoader()<span class="comment">;</span></span><br></pre></td></tr></table></figure><p><strong>使用当前线程的上下文类加载器</strong>，即 AppClassLoader，来加载驱动类！</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1196-1024x190.png" alt="img"></p><h5 id="总结：">总结：</h5><p><strong>背景：JDBC 驱动怎么加载的？</strong></p><p>我们在写 JDBC 连接数据库时，通常不需要显式加载驱动类（<code>Class.forName(&quot;com.mysql.cj.jdbc.Driver&quot;)</code>），JVM 会自动完成加载。那么 JVM 是怎么知道 mysql 驱动在哪的呢？</p><p>关键角色：DriverManager + SPI机制 + 线程上下文类加载器</p><ol><li>DriverManager 是谁加载的？</li></ol><ul><li><p><code>DriverManager</code> 类在 <code>rt.jar</code> 中，属于 JDK 自带类。</p></li><li><p>所以它是由 <strong>启动类加载器 BootstrapClassLoader</strong> 加载的。</p></li><li><p>mysql 驱动类是谁加载的？</p></li><li><p>比如 <code>com.mysql.cj.jdbc.Driver</code> 驱动类，是我们自己引入的 jar 包中的类；</p></li><li><p>它由 <strong>应用程序类加载器（AppClassLoader）</strong> 加载。</p></li></ul><p>那么，DriverManager（JDK内部）是怎么找到用户引入的 mysql 驱动类的？</p><p>这就涉及到：</p><p><strong>⭐ SPI 机制（Service Provider Interface）+ 上下文类加载器</strong></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1197.png" alt="img"></p><h5 id="JDBC案例中真的打破了双亲委派机制吗？">JDBC案例中真的打破了双亲委派机制吗？</h5><p>最早这个论点提出是在周志明《深入理解Java虚拟机》中，他认为打破了双亲委派机制，这种由启动类加载器加载的类，委派应用程序类加载器去加载类的方式，所以打破了双亲委派机制。</p><p><strong>但是如果我们分别从DriverManager以及驱动类的加载流程上分析，JDBC只是在DriverManager加载完之后，通过初始化阶段触发了驱动类的加载，类的加载依然遵循双亲委派机制。</strong></p><p><strong>所以我认为这里没有打破双亲委派机制，只是用一种巧妙的方法让启动类加载器加载的类，去引发的其他类的加载。</strong></p><p>正确理解：</p><p><strong>并不是 DriverManager 自己去加载 mysql 驱动</strong>，而是：它借助了线程的上下文类加载（AppClassLoader）<strong>去加载</strong>用户 jar 包中的驱动类。</p><p>这是一种 <strong>“类加载器协作”而不是“委派破坏”</strong>。</p><p>综上所述：JDBC 加载驱动的过程，其实是 DriverManager 启动后，通过 SPI + 上下文类加载器让应用类加载器去加载驱动类，从而实现了插件式的扩展，<strong>并没有真正破坏双亲委派机制</strong>，而是一种巧妙的“绕开但不违背”的做法。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1209-1024x386.png" alt="img"></p><p>我们可以用生活里的例子来类别这种关系：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1210.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1211.png" alt="img"></p><h4 id="2-6-3打破类的双亲委派机制-osgi和类的热部署">2.6.3打破类的双亲委派机制 osgi和类的热部署</h4><p><strong>Osgi框架的类加载器</strong></p><p>历史上，OSGi模块化框架。它存在同级之间的类加载器的委托加载。OSGi还使用类加载器实现了热部署的功能。热部署指的是在服务不停止的情况下，动态地更新字节码文件到内存中。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1198.png" alt="img"></p><p>由于这种机制使用已经不多，所以不再过多讨论OSGi，着重来看下热部署在实际项目中的应用。</p><h5 id="案例：使用阿里arthas不停机解决线上问题">案例：使用阿里arthas不停机解决线上问题</h5><p><strong>背景：</strong></p><p>小李的团队将代码上线之后，发现存在一个小bug，但是用户急着使用，如果重新打包再发布需要一个多小时的时间，所以希望能使用arthas尽快的将这个问题修复。</p><p><strong>思路：</strong></p><ol><li>在出问题的服务器上部署一个 arthas，并启动。</li><li>jad --source-only 类全限定名 &gt; 目录/文件名.java jad 命令反编译，然后可以用其它编译器，比如 vim 来修改源码</li><li>mc –c 类加载器的hashcode 目录/文件名.java -d 输出目录</li></ol><p>mc 命令用来编译修改过的代码</p><ol><li>retransform class文件所在目录/xxx.class</li></ol><p>用 retransform 命令加载新的字节码</p><p><strong>详细流程：</strong></p><p>1、这段代码编写有误，在枚举中的类型判断上使用了<code>==</code> 而不是<code>equals</code>。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1199.png" alt="img"></p><p>2、枚举中是这样定义的，1001是普通用户，1002是VIP用户：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1200.png" alt="img"></p><p>3、由于代码有误，导致传递1001参数时，返回的是收费用户的内容。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1201.png" alt="img"></p><p>4、<code>jad --source-only 类全限定名 &gt; 目录/文件名.java</code> 使用 jad 命令反编译，然后可以用其它编译器，比如 vim 来修改源码</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1202-1024x78.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1203.png" alt="img"></p><p>5、<code>mc –c 类加载器的hashcode 目录/文件名.java -d 输出目录</code> 使用mc 命令用来编译修改过的代码</p><p>这里的hashcode要先使用使用sc来查看</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1206-1024x148.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1207-1024x52.png" alt="img"></p><p>6、<code>retransform class文件所在目录/xxx.class</code> 用 retransform 命令加载新的字节码</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1205.png" alt="img"></p><p>7、测试：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1208-1024x62.png" alt="img"></p><p><strong>注意事项：</strong></p><ul><li>1、程序重启之后，字节码文件会恢复，除非将class文件放入jar包中进行更新。</li><li>2、使用retransform不能添加方法或者字段，也不能更新正在执行中的方法。</li></ul><h3 id="2-7、JDK9之后的类加载器">2.7、JDK9之后的类加载器</h3><p>JDK8及之前的版本中，扩展类加载器和应用程序类加载器的源码位于rt.jar包中的sun.misc.Launcher.java。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1212.png" alt="img"></p><p>由于JDK9引入了module的概念，类加载器在设计上发生了很多变化。</p><ul><li>1.启动类加载器使用Java编写，位于jdk.internal.loader.ClassLoaders类中。Java中的BootClassLoader继承自BuiltinClassLoader实现从模块中找到要加载的字节码资源文件。启动类加载器依然无法通过java代码获取到，返回的仍然是null，保持了统一。</li><li>2、扩展类加载器被替换成了平台类加载器（Platform Class Loader）。平台类加载器遵循模块化方式加载字节码文件，所以继承关系从URLClassLoader变成了BuiltinClassLoader，BuiltinClassLoader实现了从模块中加载字节码文件。平台类加载器的存在更多的是为了与老版本的设计方案兼容，自身没有特殊的逻辑。</li></ul><table><thead><tr><th>对比维度</th><th>JDK 8 及以前</th><th>JDK 9 及以后（模块化系统）</th></tr></thead><tbody><tr><td>🌟 体系结构</td><td>启动类加载器 → 扩展类加载器 → 应用程序类加载器</td><td>启动类加载器 → 平台类加载器 → 应用程序类加载器</td></tr><tr><td>🔹 扩展类加载器</td><td><code>ExtensionClassLoader</code>（加载 jre/lib/ext）</td><td>✅ 被移除，⛳替代为 Platform ClassLoader</td></tr><tr><td>🔹 平台类加载器</td><td>❌ 不存在</td><td>✅ 新增：<code>PlatformClassLoader</code>，加载标准模块和平台库</td></tr><tr><td>🔹 启动类加载器</td><td>C++ 实现，加载 <code>rt.jar</code>（JVM 内部）</td><td>Java 实现，源码位于 <code>jdk.internal.loader.ClassLoaders</code> 类中</td></tr><tr><td>🔹 应用类加载器</td><td><code>AppClassLoader</code>（加载 classpath 下用户类）</td><td>✅ 保留，作用不变</td></tr><tr><td>🔹 加载路径来源</td><td>通过 <code>Launcher.java</code> 中硬编码的路径</td><td>统一改由 <code>module</code> 系统管理，Boot/Platform/App 各自处理模块</td></tr><tr><td>🔹 模块化支持</td><td>❌ 无模块化概念，纯基于类路径 classpath</td><td>✅ 强制启用 Java Platform Module System (JPMS)</td></tr><tr><td>🔹 类加载粒度</td><td>基于 <code>.class</code> 文件或 jar</td><td>支持基于模块描述符（module-info.java）的模块化加载</td></tr><tr><td>🔹 启动类加载器是否可获取资源</td><td>可以加载资源但不可直接用 Java 获取类</td><td>启动类加载器仍返回 <code>null</code>，对用户隐藏实现（保持一致性）</td></tr><tr><td>🔹 加载逻辑统一性</td><td>加载机制较分散</td><td>Boot / Platform / App 加载逻辑更加统一、模块化</td></tr><tr><td>🔹 类加载器是否继承自 URLClassLoader</td><td>Extension 和 AppClassLoader 都继承了 URLClassLoader</td><td>JDK9 中 PlatformClassLoader 不再继承 URLClassLoader</td></tr></tbody></table><ul><li><strong>JDK 9 后最关键的变化是模块化系统 JPMS 引入</strong>，类加载器设计围绕模块系统重新架构。</li><li><strong>扩展类加载器被移除</strong>，由 PlatformClassLoader 统一管理平台模块。</li><li><strong>启动类加载器从 C++ 转向 Java 实现</strong>，但对外接口保持一致。</li><li><strong>类加载器职责更清晰，加载粒度从 class 级别提升到 module 级别</strong>。</li></ul><h2 id="3、运行时数据区">3、运行时数据区</h2><p>Java虚拟机在运行Java程序过程中管理的内存区域，称之为<strong>运行时数据区</strong>。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1214-1024x383.png" alt="img"></p><p>线程不共享：创建一个线程每个线程里都有一份程序计数器、Java虚拟机栈、本地方法栈对应的数据，自己的数据由自己维护，其它线程不能访问对方线程中的数据。</p><p>线程共享：放入任何数据，每个线程都能访问数据，共享。</p><ul><li><p>应用场景：Java的内存分成哪几部分？详细介绍一下。</p></li><li><p>Java内存中哪些部分会内存溢出？</p></li><li><p>JDK7和8在内存结构上的区别是什么？</p></li><li><p>工作中的实际问题：内存溢出。</p></li><li><p>内存调优的学习路线：</p></li><li><p>1.了解运行时内存结构，了解JVM运行过程中每一部分的内存结构以及哪些部分容易出现内存溢出。</p></li><li><p>2.掌握内存问题的产生原因，学习代码中常见的几种内存泄露，性能问题的常见原因。</p></li><li><p>3.掌握内存调优的基本方法，学习内存泄露，性能问题等常见JVM问题的常规解决方法。</p></li></ul><h3 id="3-1-程序计数器">3.1 程序计数器</h3><p>程序计数器（Program Counter Register）也叫PC寄存器，每个线程会通过程序计数器记录当前要执行的的字节码指令的地址。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1215-1024x434.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1218.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1219.png" alt="img"></p><p>ifne 9 ，意思是将操作数栈中的数与0进行比较，如果相等执行6，如果不相等执行9。</p><p>在<strong>加载阶段</strong>，虚拟机将字节码文件中的指令读取到内存之后，会将原文件中的偏移量转换成内存地址。每一条字节码指令都会拥有一个内存地址。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1216-1024x490.png" alt="img"></p><p>在代码执行过程中，程序计数器会记录下一行字节码指令的地址。执行完当前指令之后，虚拟机的执行引擎根据程序计数器执行下一行指令。这里为了简单起见，使用偏移量代替，真实内存中执行时保存的应该是地址。</p><p>比如当前执行的是偏移量为0的指令，那么程序计数器中保存的就是下一条的地址（偏移量1）。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1268.png" alt="img"></p><p>一路向下执行</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1221-1024x441.png" alt="img"></p><p>一直执行到方法的最后一行指令，此时方法执行return语句，当前方法执行结束，程序计数器中会放入方法出口的地址（栈中讲解，简单来说就是这个B方法结束了，A调用了B，那么要回到A方法）</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1222-1024x442.png" alt="img"></p><p>所以，程序计数器可以控制程序指令的进行，实现分支、跳转、异常等逻辑。不管是分支、跳转、异常，只需要在程序计数器中放入下一行要执行的指令地址即可。</p><p>在多线程执行情况下，Java虚拟机需要通过程序计数器记录CPU切换前解释执行到那一句指令并继续解释运行。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1269.png" alt="img"></p><h4 id="程序计数器会出现内存溢出吗？">程序计数器会出现内存溢出吗？</h4><p>内存溢出指的是<strong>程序在使用某一块内存区域时，存放的数据需要占用的内存大小超过了虚拟机能提供的内存上限</strong>。由于每个线程只存储一个固定长度的内存地址，程序计数器是不会发生内存溢出的。程序员无需对程序计数器做任何处理。</p><h3 id="3-2Java虚拟机栈">3.2Java虚拟机栈</h3><p>Java虚拟机栈（Java Virtual Machine Stack）采用栈的数据结构来管理方法调用中的基本数据，先进后出（First In Last Out）,每一个方法的调用使用一个栈帧（Stack Frame）来保存。</p><p>main方法执行时，会创建main方法的栈帧：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1223-1024x564.png" alt="img"></p><p>接下来执行study方法，会创建study方法的栈帧</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1224-1024x567.png" alt="img"></p><p>进入eat方法，创建eat方法的栈帧</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1225-1024x573.png" alt="img"></p><p>eat方法执行完之后，会弹出它的栈帧：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1226-1024x573.png" alt="img"></p><p>然后调用sleep方法，创建sleep方法栈帧</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1267.png" alt="img"></p><p>最后study方法结束之后弹出栈帧，main方法结束之后弹出main的栈帧。</p><p>Java虚拟机栈随着线程的创建而创建，而回收则会在线程的销毁时进行。由于方法可能会在不同线程中执行，每个线程都会包含一个自己的虚拟机栈。如下就有两个线程的虚拟机栈，main线程和线程A。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1227.png" alt="img"></p><p>Java虚拟机栈的栈帧中主要包含三方面的内容：</p><ul><li>局部变量表：作用是在运行过程中存放所有的局部变量。</li><li>操作数栈：是栈帧中虚拟机在执行指令过程中用来存放临时数据的一块区域。</li><li>帧数据：包含动态链接、方法出口、异常表的引用。</li></ul><h4 id="3-2-1局部变量表">3.2.1局部变量表</h4><p>局部变量表的作用是在方法执行过程中存放所有的局部变量。局部变量表分为两种，一种是字节码文件中的，另外一种是栈帧中的也就是保存在内存中。栈帧中的局部变量表是根据字节码文件中的内容生成的。</p><p>1.我们先来看下<strong>字节码文件中的局部变量表</strong>：编译成字节码文件时就可以确定局部变量表的内容。</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static voidtest1()&#123;</span><br><span class="line">    inti <span class="operator">=</span> <span class="number">0</span><span class="comment">;</span></span><br><span class="line">    longj <span class="operator">=</span> <span class="number">1</span><span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>test1方法的局部变量表如下：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1228.png" alt="img"></p><p>Nr表示的是变量的编号，按照生命的顺序，起始PC保存了从哪一行字节码指令开始可以访问这个局部变量，长度以生效那行到销毁那行计算。</p><p>局部变量表中保存了字节码指令生效的偏移量：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1229-1024x331.png" alt="img"></p><p>i在1中就赋值成功了，它可以访问2,3,4 起始PC2，长度3。j在3中赋值成功，起始PC3，长度1</p><p>比如<code>i</code>这个变量，它的起始PC是2，代表从<code>lconst_1</code>这句指令开始才能使用<code>i</code>，长度为3，也就是2-4这三句指令都可以使用<code>i</code>。为什么从2才能使用，因为0和1这两句字节码指令还在处理<code>int i = 0</code>这句赋值语句。<code>j</code>这个变量只有等3指令执行完之后也就是<code>long j = 1</code>代码执行完之后才能使用，所以起始PC为4，只能在4这行字节码指令中使用。</p><p>2.接下来看下<strong>栈帧中的局部变量表</strong>，栈帧中的局部变量表是一个数组，数组中每一个位置称之为槽(slot) ，long和double类型占用两个槽，其他类型占用一个槽。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1230-1024x326.png" alt="img"></p><p><code>i</code>占用数组下标为0的位置，<code>j</code>占用数组下标1-2的位置。</p><p>刚才看到的是静态方法，实例方法中的序号为0的位置存放的是this，指的是当前调用方法的对象，运行时会在内存中存放实例对象的地址。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1231-1024x309.png" alt="img"></p><p>方法参数也会保存在局部变量表中，其顺序与方法中参数定义的顺序一致。局部变量表保存的内容有：实例方法的this对象，方法的参数，方法体中声明的局部变量。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1297-1024x331.png" alt="img"></p><p>test3方法中包含两个参数<code>k</code>,<code>m</code>，这两个参数也会被加入到局部变量表中。</p><p><strong>以下代码的局部变量表中会占用几个槽？</strong></p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">publicvoidtest4(<span class="built_in">int</span>k,<span class="built_in">int</span>m)&#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span>a = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">int</span>b = <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span>c = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">int</span>i = <span class="number">0</span>;</span><br><span class="line">    longj = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为了节省空间，局部变量表中的槽是可以复用的，一旦某个局部变量不再生效，当前槽就可以再次被使用。</p><p>1、方法执行时，实例对象<code>this</code>、<code>k</code>、<code>m</code> 会被放入局部变量表中，占用3个槽</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1232-1024x365.png" alt="img"></p><p>2、将1的值放入局部变量表下标为3的位置上，相当于给a进行赋值。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1298-1024x373.png" alt="img"></p><p>3、将2放入局部变量表下标为4的位置，给b赋值为2。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1233-1024x363.png" alt="img"></p><p>4、ab已经脱离了生效范围，所以下标为3和4的这两个位置可以复用。此时c的值1就可以放入下标为3的位置。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1234-1024x350.png" alt="img"></p><p>4、脱离c的生效范围之后，给i赋值就可以复用c的位置。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1235-1024x355.png" alt="img"></p><p>5、最后放入j，j是一个long类型，占用两个槽。但是可以复用b所在的位置，所以占用4和5这两个位置</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1236-1024x358.png" alt="img"></p><p>所以，局部变量表数值的长度为6</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1237.png" alt="img"></p><h4 id="3-2-2操作数栈">3.2.2操作数栈</h4><p>操作数栈是栈帧中虚拟机在执行指令过程中用来存放中间数据的一块区域。他是一种栈式的数据结构，如果一条指令将一个值压入操作数栈，则后面的指令可以弹出并使用该值。</p><p>在编译期就可以确定操作数栈的最大深度，从而在执行时正确的分配内存大小。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1238-1024x318.png" alt="img"></p><p>为什么是2？ 操作数栈中最多会出现两个数字0,1,因此最大深度为2</p><h4 id="3-2-3帧数据">3.2.3<strong>帧数据</strong></h4><p>帧数据主要包含动态链接、方法出口、异常表的引用。</p><p><strong>动态链接</strong></p><p>当前类的字节码指令引用了其他类的属性或者方法时，需要将符号引用（编号）转换成对应的运行时常量池中的内存地址。动态链接就保存了编号到运行时常量池的内存地址的映射关系。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1239-1024x340.png" alt="img"></p><p><strong>方法出口</strong></p><p>方法出口指的是方法在正确或者异常结束时，当前栈帧会被弹出，同时程序计数器应该指向上一个栈帧中的下一条指令的地址。所以在当前栈帧中，需要存储此方法出口的地址。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1240.png" alt="img"></p><p><strong>异常表</strong></p><p>异常表存放的是代码中异常的处理信息，包含了异常捕获的生效范围以及异常发生后跳转到的字节码指令位置。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1241-1024x344.png" alt="img"></p><p><code>如下案例：i=1</code>这行源代码编译成字节码指令之后，会包含偏移量2-4这三行指令。其中2-3是对i进行赋值1的操作，4的没有异常就跳转到10方法结束。如果出现异常的情况下，继续执行到7这行指令，7会将异常对象放入操作数栈中，这样在catch代码块中就可以使用异常对象了。接下来执行8-9，对i进行赋值为2的操作。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1242-1024x391.png" alt="img"></p><p>所以异常表中，异常捕获的起始偏移量就是2，结束偏移量是4，在2-4执行过程中抛出了<code>java.lang.Exception</code>对象或者子类对象，就会将其捕获，然后跳转到偏移量为7的指令。</p><h4 id="3-2-4栈内存溢出">3.2.4栈内存溢出</h4><p>Java虚拟机栈如果栈帧过多，占用内存超过栈内存可以分配的最大大小就<strong>会出现内存溢出</strong>。Java虚拟机栈内存溢出时会出现StackOverflowError的错误。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1243.png" alt="img"></p><p>如果我们不指定栈的大小，JVM 将创建一个具有默认大小的栈。大小取决于操作系统和计算机的体系结构。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1244-1024x151.png" alt="img"></p><p>我们来模拟下栈内存的溢出情况:</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> count = <span class="number">0</span>;</span><br><span class="line">     <span class="comment">//递归方法调用自己</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">recursion</span>()</span>&#123;</span><br><span class="line">         System.<span class="keyword">out</span>.println(++count);</span><br><span class="line">         recursion();</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure><p>使用递归让方法调用自身，但是不设置退出条件。定义调用次数的变量，每一次调用让变量加1。查看错误发生时总调用的次数。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1245.png" alt="img"></p><p><strong>解决方案-设置栈的大小</strong></p><p>要修改Java虚拟机栈的大小，可以使用虚拟机参数 -Xss 。</p><ul><li>语法：-Xss栈大小</li><li>单位：字节（默认，必须是 1024 的倍数）、k或者K(KB)、m或者M(MB)、g或者G(GB)</li></ul><p>例如：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">-Xss1048576 </span></span><br><span class="line"><span class="deletion">-Xss1024K      </span></span><br><span class="line"><span class="deletion">-Xss1m</span></span><br><span class="line"><span class="deletion">-Xss1g</span></span><br></pre></td></tr></table></figure><p>操作步骤如下，不同IDEA版本的设置方式会略有不同：</p><p>1、点击修改配置Modify options</p><p>2、点击Add VM options</p><p>3、添加参数</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1247.png" alt="img"></p><p>调成512k之后，明显发现最大栈帧数量减少了：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1246.png" alt="img"></p><p>对windows来说，JDK8测试最小值为180K，最大值为1024M。</p><p>如果局部变量过多，操作数栈的深度过大也会影响栈内存的大小。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1248.png" alt="img"></p><p>Java虚拟机栈存储了Java方法调用时的栈帧，而本地方法栈存储的是native本地方法的栈帧。</p><h3 id="3-3本地方法栈">3.3本地方法栈</h3><p>Java虚拟机栈存储了Java方法调用时的栈帧，而本地方法栈存储的是native本地方法的栈帧。（C++）</p><p>在Hotspot虚拟机中，<strong>Java虚拟机栈和本地方法栈实现上使用了同一个栈空间</strong>。本地方法栈会在栈内存上生成一个栈帧，临时保存方法的参数同时方便出现异常时也把本地方法的栈信息打印出来。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1249.png" alt="img"></p><p>比如测试下这段代码：</p><figure class="highlight wren"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** * 本地方法栈 */</span><span class="title function_">publicclassNativeDemo1</span> &#123;</span><br><span class="line">    <span class="title function_">publicstaticvoidmain</span>(<span class="params">String</span>[] <span class="params">args</span>) &#123;</span><br><span class="line">        <span class="title function_">try</span>&#123;</span><br><span class="line">            <span class="title class_">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="title function_">newFileOutputStream</span>(<span class="string">&quot;E:<span class="char escape_">\\</span>123.txt&quot;</span>);</span><br><span class="line">            <span class="variable">fileOutputStream</span>.<span class="property">write</span>(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="title function_">catch</span>(<span class="params">FileNotFoundException</span> <span class="params">e</span>) &#123;</span><br><span class="line">            <span class="variable">e</span>.<span class="property">printStackTrace</span>();</span><br><span class="line">        &#125; <span class="title function_">catch</span>(<span class="params">IOException</span> <span class="params">e</span>) &#123;</span><br><span class="line">            <span class="variable">e</span>.<span class="property">printStackTrace</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行之后发生异常，会打印出所有栈帧的名字：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1250.png" alt="img"></p><p><code>open0</code>是一个本地方法，所以创建了本地方法的栈帧。本地方法和Java虚拟机方法</p><h3 id="3-4-堆内存">3.4 堆内存</h3><p>一般Java程序中堆内存是空间最大的一块内存区域。</p><p>创建出来的对象都存在于堆上。栈上的局部变量表中，可以存放堆上对象的引用。静态变量也可以存放堆对象的引用，通过静态变量就可以实现对象在线程之间共享。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1251-1024x282.png" alt="img"></p><p>这段代码中通过<code>new</code>关键字创建了两个<code>Student</code>类的对象，这两个对象会被存放在堆上。在栈上通过<code>s1</code>和<code>s2</code>两个局部变量保存堆上两个对象的地址，从而实现了引用关系的建立。</p><h4 id="3-4-1堆内存的溢出">3.4.1堆内存的溢出</h4><p>通过new关键字不停创建对象，放入集合中，模拟堆内存的溢出，观察堆溢出之后的异常信息。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> chapter03.heap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 堆内存的使用和回收</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, IOException &#123;</span><br><span class="line"></span><br><span class="line">        ArrayList&lt;Object&gt; objects = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Object&gt;();</span><br><span class="line">        System.in.read();</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">            objects.add(<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">100</span>]);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>堆内存大小是有上限的，当对象一直向堆中放入对象达到上限之后，就会抛出OutOfMemory错误。在这段代码中，不停创建100M大小的字节数组并放入ArrayList集合中，最终超过了堆内存的上限。抛出如下错误：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1252-1024x76.png" alt="img"></p><h4 id="3-4-2三个重要的值">3.4.2三个重要的值</h4><p>堆空间有三个需要关注的值，used、total、max。used指的是当前已使用的堆内存，total是java虚拟机已经分配的可用堆内存，max是java虚拟机可以分配的最大堆内存。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1253.png" alt="img"></p><p>可以通过：dashboard 进行访问，如果只能看内存只需要输入：memory</p><blockquote><p>手动指定刷新频率（不指定默认5秒一次）：<code>dashboard –i 刷新频率(毫秒)</code></p></blockquote><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1254-1024x261.png" alt="img"></p><p>随着堆中的对象增多，当total可以使用的内存即将不足时，java虚拟机会继续分配内存给堆。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1255.png" alt="img"></p><p>此时used达到了total的大小，Java虚拟机会向操作系统申请更大的内存。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1256.png" alt="img"></p><p>但是这个申请过程不是无限的，total最多只能与max相等。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1257.png" alt="img"></p><p>那么是不是当used = max = total的时候，堆内存就溢出了呢？</p><p>不是，堆内存溢出的判断条件比较复杂，在下一章《垃圾回收器》中会详细介绍。</p><p>如果不设置任何的虚拟机参数，max默认是系统内存的1/4，total默认是系统内存的1/64。在实际应用中一般都需要设置total和max的值。</p><h4 id="3-4-3设置堆的大小">3.4.3设置堆的大小</h4><p>要修改堆的大小，可以使用虚拟机参数 –Xmx（max最大值）和-Xms (初始的total)。</p><p>语法：<code>-Xmx值 -Xms值</code></p><p>单位：字节（默认，必须是 1024 的倍数）、k或者K(KB)、m或者M(MB)、g或者G(GB)</p><p>限制：Xmx必须大于 2 MB，Xms必须大于1MB</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">-Xms6291456</span></span><br><span class="line"><span class="deletion">-Xms6144k</span></span><br><span class="line"><span class="deletion">-Xms6m</span></span><br><span class="line"><span class="deletion">-Xmx83886080</span></span><br><span class="line"><span class="deletion">-Xmx81920k</span></span><br><span class="line"><span class="deletion">-Xmx80m</span></span><br></pre></td></tr></table></figure><p>这样可以将max和初始的total都设置为4g，在启动后就已经获得了最大的堆内存大小。运行过程中不需要向操作系统申请。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1258.png" alt="img"></p><p>使用<code>arthas</code>的<code>memory</code>命令同样可以看到：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1259-1024x182.png" alt="img"></p><p>为什么arthas中显示的heap堆大小与设置的值不一样呢？</p><p>arthas中的heap堆内存使用了JMX技术中内存获取方式，这种方式与垃圾回收器有关，计算的是可以分配对象的内存，而不是整个内存。</p><p><strong>建议：</strong></p><p>Java服务端程序开发时，建议将-Xmx和-Xms设置为相同的值，这样在程序启动之后可使用的总内存就是最大内存，而无需向java虚拟机再次申请，减少了申请并分配内存时间上的开销，同时也不会出现内存过剩之后堆收缩的情况。-Xmx具体设置的值与实际的应用程序运行环境有关，在《实战篇》中会给出设置方案。</p><h3 id="3-5-方法区">3.5 方法区</h3><p>方法区是存放基础信息的位置，线程共享，主要包含三部分内容：</p><ul><li>类的元信息，保存了所有类的基本信息</li><li>运行时常量池，保存了字节码文件中的常量池内容</li><li>字符串常量池，保存了字符串常量</li></ul><h4 id="3-5-1类的元信息">3.5.1类的元信息</h4><p>方法区是用来存储每个类的基本信息（元信息），一般称之为InstanceKlass对象。在类的加载阶段完成。其中就包含了类的字段、方法等字节码文件中的内容，同时还保存了运行过程中需要使用的虚方法表（实现多态的基础）等信息。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1261-1024x455.png" alt="img"></p><h4 id="3-5-2运行时常量池">3.5.2运行时常量池</h4><p>方法区除了存储类的元信息之外，还存放了运行时常量池。常量池中存放的是字节码中的常量池内容。</p><p>字节码文件中通过编号查表的方式找到常量，这种常量池称为静态常量池。当常量池加载到内存中之后，可以通过内存地址快速的定位到常量池中的内容，这种常量池称为运行时常量池。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1262-1024x318.png" alt="img"></p><h4 id="3-5-3方法区的实现">3.5.3方法区的实现</h4><p>方法区是《Java虚拟机规范》中设计的虚拟概念，每款Java虚拟机在实现上都各不相同。Hotspot设计如下：</p><p>JDK7及之前的版本将方法区存放在堆区域中的<strong>永久代空间</strong>，堆的大小由虚拟机参数来控制。</p><p>JDK8及之后的版本将方法区存放在<strong>元空间</strong>中，元空间位于操作系统维护的直接内存中，默认情况下只要不超过操作系统承受的上限，可以一直分配。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1263-1024x258.png" alt="img"></p><p>可以通过arthas的<code>memory</code>命令看到方法区的名称以及大小：</p><ul><li>JDK7及之前的版本查看ps_perm_gen属性。</li><li>JDK8及之后的版本查看metaspace属性。</li></ul><h4 id="3-5-4方法区的溢出">3.5.4方法区的溢出</h4><p>通过ByteBuddy框架，动态创建类并将字节码数据加载到内存中。通过死循环不停地加载到方法区，观察方法区是否会出现内存溢出的情况。分别在JDK7和JDK8上运行上述代码。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1264.png" alt="img"></p><p>实验发现，JDK7上运行大概十几万次，就出现了错误。</p><p>在JDK8上运行百万次，程序都没有出现任何错误，但是内存会直线升高。这说明JDK7和JDK8在方法区的存放上，采用了不同的设计。</p><ul><li>JDK7将方法区存放在堆区域中的永久代空间，堆的大小由虚拟机参数-XX:MaxPermSize=值来控制。</li><li>JDK8将方法区存放在元空间中，元空间位于操作系统维护的直接内存中，默认情况下只要不超过操作系统承受的上限，可以一直分配。可以使用-XX:MaxMetaspaceSize=值将元空间最大大小进行限制。</li></ul><p>在JDK8中将最大元空间内存设置为256m，再次测试</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1265.png" alt="img"></p><p>这次就出现了MetaSpace溢出的错误：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1266.png" alt="img"></p><h4 id="3-5-5字符串常量池">3.5.5字符串常量池</h4><p>方法区中除了类的元信息、运行时常量池之外，还有一块区域叫字符串常量池(StringTable)。</p><p>字符串常量池存储在代码中定义的常量字符串内容。比如“123” 这个123就会被放入字符串常量池。</p><p>如下代码执行时，代码中包含<code>abc</code>字符串，就会被直接放入字符串常量池。在堆上创建String对象，并通过局部变量s1引用堆上的对象。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1270-1024x396.png" alt="img"></p><p>接下来通过s2局部变量引用字符串常量池的<code>abc</code>。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1271-1024x394.png" alt="img"></p><p>所以s1和s2指向的不是同一个对象，打印出<code>false</code>。</p><p>所以s1和s2指向的不是同一个对象，打印出<code>false</code>。</p><h5 id="字符串常量池和运行时常量池有什么关系？">字符串常量池和运行时常量池有什么关系？</h5><p>早期设计时，字符串常量池是属于运行时常量池的一部分，他们存储的位置也是一致的。后续做出了调整，将字符串常量池和运行时常量池做了拆分。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1272-1024x357.png" alt="img"></p><p>在 JDK 7 及之前的版本中，静态变量是存储在方法区（永久代）的，而从 JDK 8 开始，随着永久代的移除，静态变量被存储在了堆区，并且位于 Class 对象内部。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1273.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1274.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1275.png" alt="img"></p><h5 id="StringTable的练习题1：">StringTable的练习题1：</h5><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1276.png" alt="img"></p><p>1、首先将<code>1</code>放入字符串常量池，通过局部变量a引用字符串常量池中的<code>1</code>字符串。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1277-1024x513.png" alt="img"></p><p>2、同理处理b和c：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1278-1024x506.png" alt="img"></p><p>3、将a和b指向的字符串进行连接，本质上就是使用StringBuilder进行连接，最后创建了一个新的字符串放入堆中。然后将局部变量d指向堆上的对象。</p><p>因为a+b通过stingbuild的append方法，最后new string（），<strong>new对象是放在堆中的</strong></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1279-1024x502.png" alt="img"></p><p>4、所以c和d指向的不是同一个对象，打印出的结果就是false。</p><p>即c指向了字符串常量池里的&quot;12&quot;，d指向了堆内存中的&quot;12&quot;</p><h5 id="StringTable的练习题2：">StringTable的练习题2：</h5><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1280.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1281-1024x453.png" alt="img"></p><p>说明在编译阶段，已经将1和2进行连接，最终生成12的字符串常量池中的结果。所以返回结果就是true，c和d都指向字符串常量池中的对象。</p><p>总结：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1282-1024x311.png" alt="img"></p><h5 id="intern方法">intern方法</h5><p>String.intern()方法是可以手动将字符串放入字符串常量池中</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1283-1024x468.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1284.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1285.png" alt="img"></p><p>结论：JDK7以及之后的版本中，我们在堆上创建的字符串，如果调用了intern（）方法，它只是在常量池中存放了这个对象的引用，而不再会把字符串搬运到常量池中</p><h4 id="3-5-6面试题：静态变量存储在哪里呢？">3.5.6面试题：静态变量存储在哪里呢？</h4><ul><li>JDK6及之前的版本中，静态变量是存放在方法区中的，也就是永久代。</li><li>JDK7及之后的版本中，静态变量是存放在堆中的Class对象中，脱离了永久代。具体源码可参考虚拟机源码：BytecodeInterpreter针对putstatic指令的处理。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1286-1024x522.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1287-1024x613.png" alt="img"></p><h3 id="3-6-直接内存">3.6 直接内存</h3><p>直接内存（Direct Memory）并不在《Java虚拟机规范》中存在，所以并不属于Java运行时的内存区域。</p><p>在 JDK 1.4 中引入了 NIO 机制，使用了直接内存，主要为了解决以下两个问题:</p><ul><li>1、Java堆中的对象如果不再使用要回收，回收时会影响对象的创建和使用。</li><li>2、IO操作比如读文件，需要先把文件读入直接内存（缓冲区）再把数据复制到Java堆中。</li></ul><p>现在直接放入直接内存即可，同时Java堆上维护直接内存的引用，减少了数据复制的开销。写文件也是类似的思路。</p><p>使用堆创建对象的过程：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1288-1024x263.png" alt="img"></p><p>如果使用直接内存创建对象的过程，就不需要进行复制对象，数据直接存放在直接内存中：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1289-1024x221.png" alt="img"></p><h4 id="3-6-1使用方法">3.6.1使用方法</h4><p>要创建直接内存上的数据，可以使用<code>ByteBuffer</code>。</p><p>语法： <code>ByteBuffer directBuffer = ByteBuffer.allocateDirect(size);</code></p><p>注意事项： arthas的memory命令可以查看直接内存大小，属性名direct。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1290-1024x265.png" alt="img"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> chapter03.direct;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.ByteBuffer;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 直接内存的使用和回收</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">100</span>; <span class="comment">//100mb</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;ByteBuffer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;ByteBuffer&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        System.in.read();</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">//1.创建DirectByteBuffer对象并返回</span></span><br><span class="line">            <span class="comment">//2.在DirectByteBuffer构造方法中，向操作系统申请直接内存空间</span></span><br><span class="line">            <span class="type">ByteBuffer</span> <span class="variable">directBuffer</span> <span class="operator">=</span> ByteBuffer.allocateDirect(size);</span><br><span class="line">            <span class="comment">//directBuffer = null;</span></span><br><span class="line"></span><br><span class="line">            list.add(directBuffer);</span><br><span class="line">            System.out.println(++count);</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行之后，用arthas监控发现，每隔5秒直接内存会增长100M：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1291.png" alt="img"></p><p>如果将<code>Thread.</code><em><code>sleep</code></em><code>(5000);</code>注释掉，让直接内存快速大量分配。操作系统内存不足时就会报错：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1292.png" alt="img"></p><h4 id="3-6-2设置直接内存">3.6.2设置直接内存</h4><p>为了避免将内存耗尽，需要设置直接内存的最大值。如果需要手动调整直接内存的大小，可以使用<code>XX:MaxDirectMemorySize=大小</code></p><p>单位k或K表示千字节，m或M表示兆字节，g或G表示千兆字节。默认不设置该参数情况下，JVM 自动选择 最大分配的大小。</p><p>以下示例以不同的单位说明如何将 直接内存大小设置为 1024 KB：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-XX:<span class="attribute">MaxDirectMemorySize</span>=1m</span><br><span class="line">-XX:<span class="attribute">MaxDirectMemorySize</span>=1024k</span><br><span class="line">-XX:<span class="attribute">MaxDirectMemorySize</span>=1048576</span><br></pre></td></tr></table></figure><p>在Idea中设置直接内存最大值为1g：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1293.png" alt="img"></p><h2 id="4、垃圾回收">4、垃圾回收</h2><p>在C/C++这类没有自动垃圾回收机制的语言中，一个对象如果不再使用，需要手动释放，否则就会出现内存泄漏。</p><p>内存泄漏指的是不再使用的对象在系统中未被回收，内存泄漏的积累可能会导致内存溢出。</p><p>我们称这种<strong>释放对象的过程为垃圾回收</strong>，而需要<strong>程序员编写代码进行回收的方式为手动回收</strong>。手动回收的方式相对来说回收比较及时，删除代码执行之后对象就被回收了，可以快速释放内存。缺点是对程序员要求比较高，很容易出现创建完对象之后，程序员忘记释放对象。</p><p>Java中为了简化对象的释放，引入了<strong>自动的垃圾回收（Garbage Collection简称GC</strong>）机制。通过垃圾回收器来对不再使用的对象完成自动的回收，垃圾回收器主要负责对堆上的内存进行回收。其他很多现代语言比如C#、Python、Go都拥有自己的垃圾回收器。</p><p>垃圾回收器如果发现某个对象不再使用，就可以回收该对象。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1294-1024x351.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1295-1024x362.png" alt="img"></p><ul><li>自动垃圾回收，自动根据对象是否使用由虚拟机来回收对象<ul><li>优点：降低程序员实现难度、降低对象回收bug的可能性</li><li>缺点：程序员无法控制内存回收的及时性</li></ul></li><li>手动垃圾回收，由程序员编程实现对象的删除<ul><li>优点：回收及时性高，由程序员把控回收的时机</li><li>缺点：编写不当容易出现悬空指针、重复释放、内存泄漏等问题</li></ul></li></ul><p><strong>那么垃圾回收器需要负责对哪些部分的内存进行回收呢？</strong></p><p>首先是<strong>线程不共享的部分</strong>，都是伴随着线程的创建而创建，线程的销毁而销毁。而方法的栈帧在执行完方法之后就会自动弹出栈并释放掉对应的内存。所以这一部分不需要垃圾回收器负责回收。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1296.png" alt="img"></p><h3 id="4-1-方法区的回收">4.1 方法区的回收</h3><p>方法区中能回收的内容主要就是不再使用的类。</p><ul><li>了解即可，因为在实际开发中，很难同时满足三个条件。</li><li>因为，自己编写的类是由应用程序加载器加载，而这个加载器在运行过程中是不会被回收的,所以自己编写的类，只要被加载，就不会被回收</li></ul><p>判定一个类可以被卸载。需要<strong>同时满足下面三个条件</strong>：</p><p>1、此类所有实例对象都已经被回收，在堆中不存在任何该类的实例对象以及子类对象。</p><p>这段代码中就将局部变量对堆上实例对象的引用去除了，所以对象就可以被回收。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1299.png" alt="img"></p><p>2、加载该类的类加载器已经被回收。</p><p>这段代码让局部变量对类加载器的引用去除，类加载器就可以回收。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1300-1024x190.png" alt="img"></p><p>3、该类对应的 java.lang.Class 对象没有在任何地方被引用。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1301.png" alt="img"></p><p><strong>如果需要手动触发垃圾回收，可以调用System.gc()方法。</strong></p><p>调用System.gc()方法并不一定会立即回收垃圾，仅仅向JAVA虚拟机发送一个垃圾回收的请求，具体是否需要执行垃圾回收Java虚拟机会自行判断。</p><p><strong>那么类卸载主要用在什么场景下呢？</strong></p><p>开发中此类场景一般很少出现，主要在如 OSGi、JSP 的热部署等应用场景中。</p><p>每个jsp文件对应一个唯一的类加载器，当一个jsp文件修改了，就直接卸载这个jsp类加载器。重新创建类加载器，重新加载jsp文件。</p><h3 id="4-2-如何判断对象可以回收">4.2 如何判断对象可以回收</h3><p>Java中的对象是否能被回收，是根据对象是否被引用来决定的。如果对象被引用了，说明该对象还在使用，不允许被回收。</p><p>比如下面代码的内存结构图：</p><p>第一行代码执行之后，堆上创建了Demo类的实例对象，同时栈上保存局部变量引用堆上的对象。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1303-1024x326.png" alt="img"></p><p>第二行代码执行之后，局部变量对堆上的对象引用去掉，那么堆上的对象就可以被回收了。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1304-1024x327.png" alt="img"></p><p>一个更复杂的案例：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1305-1024x357.png" alt="img"></p><p>这个案例中，如果要让对象a和b回收，必须将局部变量到堆上的引用去除。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1306-1024x366.png" alt="img"></p><p>那么问题来了，A和B互相之间的引用需要去除吗？答案是不需要，因为局部变量都没引用这两个对象了，在代码中已经无法访问这两个对象，即便他们之间互相有引用关系，也不影响对象的回收。</p><p>判断对象是否可以回收，主要有两种方式：引用计数法和可达性分析法。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1307-1024x468.png" alt="img"></p><h4 id="4-2-1引用计数法">4.2.1引用计数法</h4><p>引用计数法会为每个对象维护一个引用计数器，当对象被引用时加1，取消引用时减1。</p><p>对象A的计数器初始为0，局部变量a1对它引用之后，计数器加1就变成了1。同样A对B产生了引用，B的计数器也是1。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1308-1024x409.png" alt="img"></p><p>优越点：</p><p>引用计数法的<strong>优点是实现简单</strong>，C++中的智能指针就采用了引用计数法，但是它也存在缺点，主要有两点：</p><ul><li>1.每次引用和取消引用都需要维护计数器，对系统性能会有一定的影响</li><li>2.存在循环引用问题，所谓循环引用就是当A引用B，B同时引用A时会出现对象无法回收的问题。</li></ul><p>如下图由于A和B之间存在互相引用，所以计数器都为1，两个对象都不能被回收。但是由于没有局部变量对这两个代码产生引用，代码中已经无法访问到这两个对象，理应可以被回收。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1309-1024x372.png" alt="img"></p><p>查看垃圾回收日志</p><p>如果想要查看垃圾回收的信息，可以使用<code>-verbose:gc</code>参数。</p><p>语法： <code>-verbose:gc</code></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1310-1024x258.png" alt="img"></p><p>加上这个参数之后执行代码，发现对象确实被回收了：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1313-1024x763.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1311.png" alt="img"></p><p>通过不同的死循环创建对象，内存并没有上升，一直维持在1000K,说明每轮循环创建的两个对象在垃圾回收之后都被回收了。即没有发生内存泄漏</p><h4 id="4-2-2可达性分析法">4.2.2可达性分析法</h4><p>Java使用的是可达性分析算法来判断对象是否可以被回收。可达性分析将对象分为两类：垃圾回收的<strong>根对象（GC Root）<strong>和</strong>普通对象</strong>，对象与对象之间存在<strong>引用关系</strong>。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1314-1024x351.png" alt="img"></p><h5 id="哪些对象被称之为GC-Root对象呢？">哪些对象被称之为GC Root对象呢？</h5><p>1.线程Thread对象（创建线程之后，整个线程对象），引用线程栈帧中的方法参数、局部变量等。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1315.png" alt="img"></p><p>2.系统类加载器加载的java.lang.Class对象，引用类中的静态变量。</p><p>解释一下2：系统类加载器也就是应用程序类加载器，前面说到过，他是不可回收的，这个类加载器不会被回收，所以这个类也就不会被回收，那么这个类里面的静态变量也就不会被回收，所以就可以是GC root对象</p><p>Launcher包含应用程序类加载器和GC Root对象。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1316.png" alt="img"></p><p>3.监视器对象，用来保存同步锁synchronized关键字持有的对象。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1317-1024x289.png" alt="img"></p><p>4.本地方法调用时使用的全局对象。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1318.png" alt="img"></p><h5 id="查看GC-Root">查看GC Root</h5><p>通过arthas和eclipse Memory Analyzer工具可以查看GC Root，MAT工具是eclipse推出的Java堆内存检测工具。</p><p>1.使用arthas的heapdump命令可将内存快照保存到本地磁盘中。</p><p>2.使用MAT工具打开堆内存快照文件。</p><p>3.选择GC Roots功能查看所有的GC Root。</p><h3 id="4-3-常见的引用对象">4.3 常见的引用对象</h3><p>可达性算法中描述的对象引用，一般指的是<strong>强引用</strong>，即是GCRoot对象对普通对象有引用关系，只要这层关系存在，普通对象就不会被回收。除了强引用之外，Java中还设计了几种其他引用方式：</p><ul><li><strong>软引用</strong></li><li><strong>弱引用</strong></li><li><strong>虚引用</strong></li><li><strong>终结器引用</strong></li></ul><h4 id="4-3-1软引用">4.3.1软引用</h4><p>如果一个对象只有软引用关联到它，<strong>当程序内存不足时</strong>，就会将软引用中的数据进行回收。在JDK 1.2版之后提供了SoftReference类来实现软引用，软引用常用于<strong>缓存</strong>中。</p><p>软引入的好处？</p><p>如果对象A是一个缓存，平时会保存在内存中，如果想访问数据可以快速访问。但是如果内存不够用了，我们就可以将这部分缓存清理掉释放内存。即便缓存没了，也可以从数据库等地方获取数据，不会影响到业务正常运行，这样可以减少内存溢出产生的可能性。</p><p><strong>特别注意：</strong></p><p><strong>软引用对象本身，也需要被强引用，否则软引用对象也会被回收掉</strong>。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1323-1024x464.png" alt="img"></p><h5 id="软引用的使用方法">软引用的使用方法</h5><p>软引用的执行过程如下：</p><p>1.将对象使用软引用包装起来，new SoftReference&lt;对象类型&gt;(对象)。</p><p>2.内存不足时，虚拟机尝试进行垃圾回收。</p><p>3.如果垃圾回收仍不能解决内存不足的问题，回收软引用中的对象。</p><p>4.如果依然内存不足，抛出OutOfMemory异常。</p><p>把最大堆内存设置为200M，无法容纳2个100M的生成，所以当第2个100M生成时内存空间不足，会把软引用释放掉，所以第2次输出软引用的内容是null。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1325.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1324.png" alt="img"></p><p>软引用中的对象如果在内存不足时回收，SoftReferece对象本身也需要被回收。如何知道哪些SoftReference对象需要回收呢？（<strong>软引用（SoftReference）对象是如何被 GC 回收的，以及如何利用引用队列（ReferenceQueue）监控和清理的完整过程</strong>）</p><p>SoftReference提供了一套队列机制：<br>1.软引用创建时，通过构造器传入引用队列。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1326-1024x356.png" alt="img"></p><p>2.在软引用中包含的对象被回收时，该软引用对象会被放入引用队列。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1327-1024x325.png" alt="img"></p><p>3.通过代码遍历引用队列，将SoftReference的强引用删除。</p><p>这个队列记录了内容为空的SoftReference，可以便利队列来释放空的SoftReference</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** * 软引用案例3 - 引用队列使用 */</span>publicclassSoftReferenceDemo3 &#123;</span><br><span class="line"></span><br><span class="line">    publicstaticvoidmain(String[] <span class="keyword">args</span>) throwsIOException &#123;</span><br><span class="line"></span><br><span class="line">        ArrayList&lt;SoftReference&gt; softReferences = newArrayList&lt;&gt;();</span><br><span class="line">        ReferenceQueue&lt;<span class="built_in">byte</span>[]&gt; queues = newReferenceQueue&lt;<span class="built_in">byte</span>[]&gt;();</span><br><span class="line">        <span class="keyword">for</span>(inti = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="built_in">byte</span>[] bytes = newbyte[<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">100</span>];</span><br><span class="line">            SoftReference studentRef = newSoftReference&lt;<span class="built_in">byte</span>[]&gt;(bytes,queues);</span><br><span class="line">            softReferences.<span class="keyword">add</span>(studentRef);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SoftReference&lt;<span class="built_in">byte</span>[]&gt; <span class="keyword">ref</span> = <span class="literal">null</span>;</span><br><span class="line">        intcount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>((<span class="keyword">ref</span> = (SoftReference&lt;<span class="built_in">byte</span>[]&gt;) queues.poll()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">        System.<span class="keyword">out</span>.println(count);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第一步：创建软引用并绑定引用队列</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SoftReference&lt;<span class="built_in">byte</span>[]&gt; <span class="keyword">ref</span> = <span class="keyword">new</span> SoftReference&lt;&gt;(bytes, queues);</span><br></pre></td></tr></table></figure><ul><li>你把 <code>byte[]</code> 数据包装成了一个软引用；</li><li>同时绑定了一个引用队列 <code>queues</code>，表示一旦这个数据被回收了，你就能通过队列知道。</li></ul><p>第二步：GC 回收软引用指向的对象</p><p>由于你在 <code>for</code> 循环中分配了很多大内存：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">byte</span>[] bytes = new byte[<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">100</span>]; // <span class="number">100</span>MB × <span class="number">10</span>次</span><br></pre></td></tr></table></figure><p>当 JVM 内存不够时，GC 就会触发，开始尝试回收这些 <code>byte[]</code> 对象——因为它们只是<strong>软引用</strong>，GC 是可以回收它们的。</p><p>一旦 GC 回收了这些 byte[] 对象，对应的 <code>SoftReference</code> 就会被加入 <code>queues</code> 队列！</p><p>第三步：程序从引用队列中轮询出已失效引用</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ((ref = (SoftReference&lt;<span class="keyword">byte</span>[]&gt;) queues.poll()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">count</span>++;</span><br><span class="line">&#125;</span><br><span class="line">System.out.<span class="keyword">println</span>(<span class="keyword">count</span>); <span class="comment">// 打印：9</span></span><br></pre></td></tr></table></figure><ul><li>遍历队列，把被回收通知了的软引用拿出来；</li><li>你可以手动把它们从 <code>ArrayList</code> 中删掉，释放 SoftReference 本身（否则软引用对象还会占内存）；</li><li>最终打印出有几个对象已经被 GC 回收并放入队列。</li></ul><p>最终输出是：<code>9</code></p><p>表示你创建的 10 个软引用中，有 9 个关联的 <code>byte[]</code> 被 GC 回收，通知已经进入队列。</p><p>最终展示的结果是：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1328.png" alt="img"></p><p>这9个软引用对象中包含的数据已经被回收掉，所以可以手动从ArrayList中去掉，这样就可以释放这9个对象。</p><p>一句话总结：软引用的对象被 GC 回收后，JVM 会自动把对应的 SoftReference 放入你提供的 ReferenceQueue 中，程序就可以从这个队列中感知到该软引用失效，从而主动清除引用本身，释放内存。</p><h5 id="软引用的缓存案例">软引用的缓存案例</h5><p>使用软引用实现学生信息的缓存，能支持内存不足时清理缓存。</p><p>设计一个 <code>StudentCache</code> 缓存类，用软引用保存大量 <code>Student</code> 对象的缓存。当内存不足时，JVM 可以自动释放缓存中不用的对象，避免内存溢出（OOM）。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1330.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1329-1024x435.png" alt="img"></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">packagechapter04.soft;</span><br><span class="line"></span><br><span class="line">importjava.lang.<span class="keyword">ref</span>.ReferenceQueue;</span><br><span class="line">importjava.lang.<span class="keyword">ref</span>.SoftReference;</span><br><span class="line">importjava.util.HashMap;</span><br><span class="line">importjava.util.Map;</span><br><span class="line"><span class="comment">/** * 软引用案例4 - 学生信息的缓存 */</span><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StudentCache</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> StudentCache cache= <span class="keyword">new</span> StudentCache();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(<span class="params">String[] <span class="keyword">args</span></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span>; ; i++) &#123;</span><br><span class="line">            StudentCache.getInstance().cacheStudent(<span class="keyword">new</span> Student(i, String.valueOf(i)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;Integer, StudentRef&gt; StudentRefs;<span class="comment">// 用于Cache内容的存储</span></span><br><span class="line">   <span class="keyword">private</span> ReferenceQueue&lt;Student&gt; q;<span class="comment">// 垃圾Reference的队列</span></span><br><span class="line">   <span class="comment">// 继承SoftReference，使得每一个实例都具有可识别的标识。</span></span><br><span class="line">  <span class="comment">// 并且该标识与其在HashMap内的key相同。</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title">StudentRef</span> <span class="title">extends</span> <span class="title">SoftReference</span>&lt;<span class="title">Student</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> Integer _key= <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">StudentRef</span>(<span class="params">Student em, ReferenceQueue&lt;Student&gt; q</span>)</span> &#123;</span><br><span class="line">            super(em, q);</span><br><span class="line">            _key = em.getId();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建一个缓存器实例</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">StudentCache</span>()</span> &#123;</span><br><span class="line">        StudentRefs = newHashMap&lt;Integer, StudentRef&gt;();</span><br><span class="line">        q = newReferenceQueue&lt;Student&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取得缓存器实例</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> StudentCache <span class="title">getInstance</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cache;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 以软引用的方式对一个Student对象的实例进行引用并保存该引用  </span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cacheStudent</span>(<span class="params">Student em</span>)</span> &#123;</span><br><span class="line">        cleanCache();<span class="comment">// 清除垃圾引用</span></span><br><span class="line">       StudentRef <span class="keyword">ref</span> = <span class="keyword">new</span> StudentRef(em, q);</span><br><span class="line">        StudentRefs.put(em.getId(), <span class="keyword">ref</span>);</span><br><span class="line">        System.<span class="keyword">out</span>.println(StudentRefs.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 依据所指定的ID号，重新获取相应Student对象的实例</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> Student <span class="title">getStudent</span>(<span class="params">Integer id</span>)</span> &#123;</span><br><span class="line">        Student em = <span class="literal">null</span>;</span><br><span class="line"><span class="comment">// 缓存中是否有该Student实例的软引用，如果有，从软引用中取得。if(StudentRefs.containsKey(id)) &#123;</span></span><br><span class="line">            StudentRef <span class="keyword">ref</span> = StudentRefs.<span class="keyword">get</span>(id);</span><br><span class="line">            em = <span class="keyword">ref</span>.<span class="keyword">get</span>();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// 如果没有软引用，或者从软引用中得到的实例是null，重新构建一个实例，</span></span><br><span class="line"><span class="comment">// 并保存对这个新建实例的软引用</span></span><br><span class="line">           <span class="keyword">if</span>(em == <span class="literal">null</span>) &#123;</span><br><span class="line">            em = newStudent(id, String.valueOf(id));</span><br><span class="line">            System.<span class="keyword">out</span>.println(<span class="string">&quot;Retrieve From StudentInfoCenter. ID=&quot;</span>+ id);</span><br><span class="line">            <span class="keyword">this</span>.cacheStudent(em);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> em;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清除那些所软引用的Student对象已经被回收的StudentRef对象</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cleanCache</span>()</span> &#123;</span><br><span class="line">        StudentRef <span class="keyword">ref</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">while</span>((<span class="keyword">ref</span> = (StudentRef) q.poll()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            StudentRefs.<span class="keyword">remove</span>(<span class="keyword">ref</span>._key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    // 清除Cache内的全部内容</span></span><br><span class="line"><span class="comment">//    public void clearCache() &#123;</span></span><br><span class="line"><span class="comment">//        cleanCache();</span></span><br><span class="line"><span class="comment">//        StudentRefs.clear();</span></span><br><span class="line"><span class="comment">//        //System.gc();</span></span><br><span class="line"><span class="comment">//        //System.runFinalization();</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">Student</span> &#123;</span><br><span class="line">    <span class="built_in">int</span> id;</span><br><span class="line">    String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Student</span>(<span class="params"><span class="built_in">int</span> id, String name</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">getId</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">publicvoid <span class="title">setId</span>(<span class="params">intid</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span>(<span class="params">String name</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1331.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1332.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1333.png" alt="img"></p><p>一句话总结核心机制：</p><blockquote><p>利用 <code>SoftReference</code> + <code>ReferenceQueue</code> + <code>HashMap</code> 组合，实现了一个自动可回收的缓存系统，支持在内存紧张时释放不常用对象，且可感知对象被回收并做清理。</p></blockquote><h4 id="4-3-2弱引用（了解）">4.3.2弱引用（了解）</h4><p>弱引用的整体机制和软引用基本一致，<strong>区别在于弱引用包含的对象在垃圾回收时，不管内存够不够都会直接被回收</strong>。在JDK 1.2版之后提供了WeakReference类来实现弱引用，<strong>弱引用主要在ThreadLocal中使用</strong>。</p><p>弱引用对象本身也可以使用引用队列进行回收。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">packagechapter04.weak;</span><br><span class="line"></span><br><span class="line">importjava.io.IOException;</span><br><span class="line">importjava.lang.<span class="keyword">ref</span>.WeakReference;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** * 弱引用案例 - 基本使用 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WeakReferenceDemo2</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(<span class="params">String[] <span class="keyword">args</span></span>) throwsIOException</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">byte</span>[] bytes = newbyte[<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">100</span>];</span><br><span class="line">        WeakReference&lt;<span class="built_in">byte</span>[]&gt; weakReference = newWeakReference&lt;<span class="built_in">byte</span>[]&gt;(bytes);</span><br><span class="line">        bytes = <span class="literal">null</span>;</span><br><span class="line">        System.<span class="keyword">out</span>.println(weakReference.<span class="keyword">get</span>());</span><br><span class="line"></span><br><span class="line">        System.gc();</span><br><span class="line"></span><br><span class="line">        System.<span class="keyword">out</span>.println(weakReference.<span class="keyword">get</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行之后发现gc执行之后，对象已经被回收了。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1334.png" alt="img"></p><h4 id="4-3-3虚引用和终结器引用（了解）">4.3.3虚引用和终结器引用（了解）</h4><p>这两种引用在常规开发中<strong>是不会使用的。</strong></p><ul><li><p>虚引用也叫幽灵引用/幻影引用，不能通过虚引用对象获取到包含的对象。<strong>虚引用唯一的用途是当对象被垃圾回收器回收时可以接收到对应的通知</strong>。Java中使用PhantomReference实现了虚引用，直接内存中为了及时知道直接内存对象不再使用，从而回收内存，使用了虚引用来实现。</p></li><li><p>终结器引用指的是在对象需要被回收时，终结器引用会关联对象并放置在Finalizer类中的引用队列中，在稍后由一条由FinalizerThread线程从队列中获取对象，然后执行对象的finalize方法，<strong>在对象第二次被回收时，该对象才真正的被回收</strong>。在这个过程中可以在finalize方法中再将自身对象使用强引用关联上，但是不建议这样做。</p></li></ul><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">packagechapter04.finalreference;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** * 终结器引用案例 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FinalizeReferenceDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> FinalizeReferenceDemo reference = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">alive</span>()</span> &#123;</span><br><span class="line">        System.<span class="keyword">out</span>.println(<span class="string">&quot;当前对象还存活&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span>() throws Throwable</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            System.<span class="keyword">out</span>.println(<span class="string">&quot;finalize()执行了...&quot;</span>);</span><br><span class="line">            <span class="comment">//设置强引用自救reference = this;</span></span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            super.finalize();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    publicstaticvoidmain(String[] <span class="keyword">args</span>) throws Throwable &#123;</span><br><span class="line">        reference = <span class="keyword">new</span> FinalizeReferenceDemo();</span><br><span class="line">       test();</span><br><span class="line">       test();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    privatestaticvoidtest() throws InterruptedException &#123;</span><br><span class="line">        reference = <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">//回收对象System.gc();</span></span><br><span class="line">        <span class="comment">//执行finalize方法的优先级比较低，休眠500ms等待一下Thread.sleep(500);</span></span><br><span class="line">        <span class="keyword">if</span>(reference != <span class="literal">null</span>) &#123;</span><br><span class="line">            reference.alive();</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            System.<span class="keyword">out</span>.println(<span class="string">&quot;对象已被回收&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1335.png" alt="img"></p><h3 id="4-4-垃圾回收算法">4.4 垃圾回收算法</h3><p>Java是如何实现垃圾回收的呢？简单来说，垃圾回收要做的有两件事：</p><ul><li>1、找到内存中存活的对象</li><li>2、释放不再存活对象的内存，使得程序能再次利用这部分空间</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1353-1024x235.png" alt="img"></p><h4 id="4-4-1垃圾回收算法的评价标准">4.4.1垃圾回收算法的评价标准</h4><p>Java垃圾回收过程会通过单独的GC线程来完成，但是不管使用哪一种GC算法，都会有部分阶段需要停止所有的用户线程。这个过程被称之为Stop The World简称STW，如果STW时间过长则会影响用户的使用。</p><p>如下图，用户代码执行和垃圾回收执行让用户线程停止执行（STW）是交替执行的。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1336-1024x182.png" alt="img"></p><p>所以判断GC算法是否优秀，可以从三个方面来考虑：</p><p>1.吞吐量</p><p>吞吐量指的是 CPU 用于执行用户代码的时间与 CPU 总执行时间的比值，即吞吐量 = 执行用户代码时间 /（执行用户代码时间 + GC时间）。吞吐量数值越高，垃圾回收的效率就越高。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1337-1024x237.png" alt="img"></p><p>2.最大暂停时间</p><p>最大暂停时间指的是所有在垃圾回收过程中的STW时间最大值。比如如下的图中，黄色部分的STW就是最大暂停时间，显而易见上面的图比下面的图拥有更少的最大暂停时间。最大暂停时间越短，用户使用系统时受到的影响就越短。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1338-1024x311.png" alt="img"></p><p>3.堆使用效率</p><p>不同垃圾回收算法，对堆内存的使用方式是不同的。比如标记清除算法，可以使用完整的堆内存。而复制算法会将堆内存一分为二，每次只能使用一半内存。从堆使用效率上来说，标记清除算法要优于复制算法。</p><p>上述三种评价标准：堆使用效率、吞吐量，以及最大暂停时间不可兼得。</p><p>一般来说，堆内存越大，最大暂停时间就越长。想要减少最大暂停时间，就会降低吞吐量。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1339.png" alt="img"></p><p>没有一个垃圾回收算法能兼顾上述三点评价标准，所以不同的垃圾回收算法它的侧重点是不同的，适用于不同的应用场景。</p><h4 id="4-4-2标记清除算法">4.4.2标记清除算法</h4><p>标记清除算法的核心思想分为两个阶段：</p><p>1.标记阶段，将所有存活的对象进行标记。Java中使用可达性分析算法，从GC Root开始通过引用链遍历出所有存活对象。</p><p>2.清除阶段，从内存中删除没有被标记也就是非存活对象。</p><p>第一个阶段，从GC Root对象开始扫描，将对象A、B、C在引用链上的对象标记出来：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1340-1024x375.png" alt="img"></p><p>第二个阶段，将没有标记的对象清理掉，所以对象D就被清理掉了。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1341-1024x372.png" alt="img"></p><p>优点：实现简单，只需要在第一阶段给每个对象维护标志位，第二阶段删除对象即可。</p><p>缺点：1.碎片化问题</p><p>由于内存是连续的，所以在对象被删除之后，内存中会出现很多细小的可用内存单元。如果我们需要的是一个比较大的空间，很有可能这些内存单元的大小过小无法进行分配。</p><p>如下图，红色部分已经被清理掉了，总共回收了9个字节，但是每个都是一个小碎片，无法为5个字节的对象分配空间。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1342-1024x351.png" alt="img"></p><p>缺点2.分配速度慢。由于内存碎片的存在，需要维护一个空闲链表，极有可能发生每次需要遍历到链表的最后才能获得合适的内存空间。 我们需要用一个链表来维护，哪些空间可以分配对象，很有可能需要遍历这个链表到最后，才能发现这块空间足够我们去创建一个对象。如下图，遍历到最后才发现有足够的空间分配3个字节的对象了。如果链表很长，遍历也会花费较长的时间。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1343-1024x290.png" alt="img"></p><h4 id="4-4-3复制算法">4.4.3复制算法</h4><p>复制算法的核心思想是：</p><p>1.准备两块空间From空间和To空间，每次在对象分配阶段，只能使用其中一块空间（From空间）。</p><p>对象A首先分配在From空间：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1344-1024x300.png" alt="img"></p><p>2.在垃圾回收GC阶段，将From中存活对象复制到To空间。</p><p>在垃圾回收阶段，如果对象A存活，就将其复制到To空间。然后将From空间直接清空。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1345-1024x312.png" alt="img"></p><p>3.将两块空间的From和To名字互换。</p><p>接下来将两块空间的名称互换，下次依然在From空间上创建对象。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1346-1024x306.png" alt="img"></p><p>完整的复制算法的例子：</p><p>1.将堆内存分割成两块From空间 To空间，对象分配阶段，创建对象。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1347-1024x296.png" alt="img"></p><p>2.GC阶段开始，将GC Root搬运到To空间</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1348-1024x304.png" alt="img"></p><p>3.将GC Root关联的对象，搬运到To空间</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1349-1024x307.png" alt="img"></p><p>4.清理From空间，并把名称互换</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1350-1024x296.png" alt="img"></p><p>优点：</p><ul><li>吞吐量高，复制算法只需要遍历一次存活对象复制到To空间即可，比标记-整理算法少了一次遍历的过程，因而性能较好，但是不如标记-清除算法，因为标记清除算法不需要进行对象的移动</li><li>不会发生碎片化，复制算法在复制之后就会将对象按顺序放入To空间中，所以对象以外的区域都是可用空间，不存在碎片化内存空间。</li></ul><p>缺点：</p><p>内存使用效率低，每次只能让一半的内存空间来为创建对象使用。</p><h4 id="4-4-4标记整理算法">4.4.4标记整理算法</h4><p>标记整理算法也叫标记压缩算法，是对标记清理算法中容易产生内存碎片问题的一种解决方案。</p><p>核心思想分为两个阶段：</p><p>1.标记阶段，将所有存活的对象进行标记。Java中使用可达性分析算法，从GC Root开始通过引用链遍历出所有存活对象。</p><p>2.整理阶段，将存活对象移动到堆的一端。是清理非存活对象的内存空间</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1351-1024x238.png" alt="img"></p><p>优点：</p><ul><li>内存使用效率高，整个堆内存都可以使用，不会像复制算法只能使用半个堆内存</li><li>不会发生碎片化，在整理阶段可以将对象往内存的一侧进行移动，剩下的空间都是可以分配对象的有效空间</li></ul><p>缺点：</p><p>整理阶段的效率不高，整理算法有很多种，比如Lisp2整理算法需要对整个堆中的对象搜索3次，整体性能不佳。可以通过Two-Finger、表格算法、ImmixGC等高效的整理算法优化此阶段的性能。</p><h4 id="4-4-5分代垃圾回收算法">4.4.5分代垃圾回收算法</h4><p>分代垃圾回收算法是现代优秀的垃圾回收算法，会将上述描述的垃圾回收算法组合进行使用，其中应用最广的就是分代垃圾回收算法（Generational GC）。</p><p>分代垃圾回收将整个内存区域划分为年轻代和老年代：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1352-1024x366.png" alt="img"></p><p>在JDK8中，添加-XX:+UseSerialGC参数使用分代回收的垃圾回收器，运行程序。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1355-1024x638.png" alt="img"></p><p>可以通过memory命令来查看内存</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1354-1024x228.png" alt="img"></p><p>Eden + survivor 这两块区域组成了年轻代。</p><p>tenured_gen指的是晋升区域，其实就是老年代。</p><p>1、分代回收时，创建出来的对象，首先会被放入Eden伊甸园区。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1356-1024x332.png" alt="img"></p><p>2、随着对象在Eden区越来越多，如果Eden区满，新创建的对象已经无法放入，就会触发<strong>年轻代的GC</strong>，称为Minor GC或者Young GC。</p><p><strong>Minor GC会把需要eden中和From需要回收的对象回收，把没有回收的对象放入To区。</strong></p><p>eden[首次]满时，会触发垃圾回收，根据可达性判断存活的对象，将存活的对象复制到某个幸存区（假设为From区），同时Eden区清空。当后续eden再满时，就会将eden和From区的对象进行回收然后将幸存的对象复制到To区。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1357-1024x359.png" alt="img"></p><p>3、接下来，S0会变成To区，S1变成From区。当eden区满时再往里放入对象，依然会发生Minor GC。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1358-1024x366.png" alt="img"></p><p>此时会回收<strong>eden区和S1(from)中的对象</strong>，并把eden和from区中剩余的对象放入S0。</p><p>注意：每次Minor GC中都会为对象记录他的年龄，初始值为0，每次GC完加1。</p><p>4、如果Minor GC后对象的年龄达到阈值（最大15，默认值和垃圾回收器有关），对象就会被晋升至老年代。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1359-1024x360.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1360-1024x350.png" alt="img"></p><p>当整个新生代的空间都被使用时，无法放入新的对象时，先尝试Minor GC，把未达到年龄阈值但是最老的对象放入老年代，如果老年代空间也被占满了，会触发Full GC（回收整个堆的所有对象）</p><p>一个长时间运行的应用可能积累了许多长生命周期的对象，导致老年代逐渐填满，即使新生代并未完全填满，JVM也可能触发Full GC来清理老年代</p><p>如果Full GC依然无法回收掉老年代的对象，那么当对象继续放入老年代时，就会抛出Out Of Memory异常。</p><p>至于为什么不会被回收：因为这里的回收条件依然要满足可达性分析，如果不满足，是不能被回收的</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1361-1024x362.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1362-1024x294.png" alt="img"></p><h3 id="4-5-垃圾回收器">4.5 垃圾回收器</h3><h4 id="4-5-1为什么分代GC算法要把堆分成年轻代和老年代？">4.5.1为什么分代GC算法要把堆分成年轻代和老年代？</h4><p>首先我们要知道堆内存中对象的特性：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1363-1024x532.png" alt="img"></p><ul><li>系统中的大部分对象，都是创建出来之后很快就不再使用可以被回收，比如用户获取订单数据，订单数据返回给用户之后就可以释放了。</li><li>老年代中会存放长期存活的对象，比如Spring的大部分bean对象，在程序启动之后就不会被回收了。</li><li>在虚拟机的默认设置中，新生代大小要远小于老年代的大小。</li></ul><p>分代GC算法将堆分成年轻代和老年代主要原因有：</p><ul><li>1、可以通过调整年轻代和老年代的比例来适应不同类型的应用程序，提高内存的利用率和性能。</li><li>2、新生代和老年代使用不同的垃圾回收算法，新生代一般选择复制算法，老年代可以选择标记-清除和标记-整理算法，由程序员来选择灵活度较高。</li><li>3、分代的设计中允许只回收新生代（minor gc），如果能满足对象分配的要求就不需要对整个堆进行回收(full gc),STW时间就会减少。</li></ul><p>-----------------------------------------------------------------------------------------------------------</p><p>垃圾回收器是垃圾回收算法的具体实现。</p><h4 id="4-5-2垃圾回收器组合关系">4.5.2垃圾回收器组合关系</h4><p>由于垃圾回收器分为年轻代和老年代，<strong>除了G1之外其他垃圾回收器必须成对组合进行使用。</strong></p><p>具体的关系图如下：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1364-1024x367.png" alt="img"></p><h4 id="4-5-3Serial和Serial-Old的组合">4.5.3Serial和Serial Old的组合</h4><h5 id="年轻代-Serial垃圾回收器">年轻代-Serial垃圾回收器</h5><p>Serial是一种<strong>单线程串行回收</strong>年轻代的垃圾回收器。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1365.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1366-1024x131.png" alt="img"></p><h5 id="老年代-SerialOld垃圾回收器">老年代-SerialOld垃圾回收器</h5><p>SerialOld是Serial垃圾回收器的老年代版本，采用<strong>单线程串行回收</strong></p><p>-XX:+UseSerialGC 新生代、老年代都使用串行回收器。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1368.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1367-1024x151.png" alt="img"></p><h4 id="4-5-4ParNew和CMS的组合">4.5.4ParNew和CMS的组合</h4><h5 id="年轻代-ParNew垃圾回收器">年轻代-ParNew垃圾回收器</h5><p>ParNew垃圾回收器本质上是对Serial在多CPU下的优化，使用<strong>多线程</strong>进行垃圾回收</p><p>-XX:+UseParNewGC 新生代使用ParNew回收器， 老年代使用串行回收器</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1369.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1370-1024x134.png" alt="img"></p><h5 id="老年代-CMS-Concurrent-Mark-Sweep-垃圾回收器-JDK14废弃">老年代- CMS(Concurrent Mark Sweep)垃圾回收器(JDK14废弃)</h5><p>CMS垃圾回收器关注的是系统的<strong>暂停时间</strong>，允许用户线程和垃圾回收线程在某些步骤中同时执行，减少了用户线程的等待时间。</p><p>参数：XX:+UseConcMarkSweepGC</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1372.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1373-1024x164.png" alt="img"></p><p>CMS执行步骤：</p><p>1.初始标记，用极短的时间标记出GC Roots能直接关联到的对象。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1374.png" alt="img"></p><p>2.并发标记, 标记所有的对象，用户线程不需要暂停。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1375.png" alt="img"></p><p>3.重新标记，由于并发标记阶段有些对象会发生了变化，存在错标、漏标等情况，需要重新标记。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1376.png" alt="img"></p><p>4.并发清理，清理死亡的对象，用户线程不需要暂停。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1377-1024x277.png" alt="img"></p><p>也就是说只有两个阶段会产生STW，一个是初始标记阶段一个是重新标记阶段，但这两个停顿时间会短一些(并发标记时间比较长 重新标记只是找错漏情况 会比较短)</p><p><strong>缺点：</strong></p><p>1、CMS使用了标记-清除算法，在垃圾收集结束之后会出现大量的内存碎片，CMS会在Full GC时进行碎片的整理。这样会导致用户线程暂停，可以使用-XX:CMSFullGCsBeforeCompaction=N 参数（默认0）调整N次Full GC之后再整理。</p><p>2.、无法处理在并发清理过程中产生的“浮动垃圾”，不能做到完全的垃圾回收。(浮动垃圾（Floating Garbage） 是指：在 CMS 的并发标记阶段，应用线程继续运行期间新产生的、后来变成不可达的对象，但 CMS 没有标记到它们。这些对象在这一轮 GC 中被“遗漏”了，因此不会被回收，直到下一次GC才有机会被清理</p><p>3、如果老年代内存不足无法分配对象，CMS就会退化成Serial Old单线程回收老年代。</p><h4 id="4-5-5Parallel-Scavenge-和Parallel-Old的组合（JDK8默认组合）">4.5.5Parallel Scavenge 和Parallel Old的组合（JDK8默认组合）</h4><h5 id="年轻代-Parallel-Scavenge垃圾回收器">年轻代-Parallel Scavenge垃圾回收器</h5><p>Parallel Scavenge是<strong>JDK8默认的年轻代垃圾回收器</strong>，多线程并行回收，关注的是系统的吞吐量。具备<strong>自动调整堆内存大小</strong>的特点。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1378.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1379-1024x163.png" alt="img"></p><p><strong>常用参数：</strong></p><p>Parallel Scavenge允许手动设置最大暂停时间和吞吐量。Oracle官方建议在使用这个组合时，不要设置堆内存的最大值，垃圾回收器会根据最大暂停时间和吞吐量自动调整内存大小。</p><ul><li>最大暂停时间，<code>-XX:MaxGCPauseMillis=n</code> 设置每次垃圾回收时的最大停顿毫秒数</li><li>吞吐量，<code>-XX:GCTimeRatio=n</code> 设置吞吐量为n（用户线程执行时间 = n/n + 1）</li><li><strong>自动调整内存大小</strong>, <code>-XX:+UseAdaptiveSizePolicy</code>设置可以让垃圾回收器根据吞吐量和最大停顿的毫秒数自动调整内存大小</li></ul><p>吞吐量的值默认99（用户线程执行99%时间，垃圾回收线程1%）</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1390-1024x58.png" alt="img"></p><p>最大暂停时间默认值(非常大，基本任何时间都满足，相对于没有限制最大暂停时间)</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1391-1024x61.png" alt="img"></p><h5 id="老年代-Parallel-Old垃圾回收器">老年代-Parallel Old垃圾回收器</h5><p>Parallel Old是为Parallel Scavenge收集器设计的老年代版本，利用多线程并行收集。</p><p>参数： -XX:+UseParallelGC 或</p><p>-XX:+UseParallelOldGC可以使用Parallel Scavenge + Parallel Old这种组合。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1380.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1382-1024x141.png" alt="img"></p><h4 id="G1垃圾回收器（JDK9之后默认的垃圾回收器）">G1垃圾回收器（JDK9之后默认的垃圾回收器）</h4><p>JDK9之后默认的垃圾回收器是G1（Garbage First）垃圾回收器。Parallel Scavenge关注吞吐量，允许用户设置最大暂停时间 ，但是会减少年轻代可用空间的大小。CMS关注暂停时间，但是吞吐量方面会下降。</p><p>而G1设计目标就是将上述两种垃圾回收器的优点融合：</p><ul><li>1.支持巨大的堆空间回收，并有较高的吞吐量。</li><li>2.支持多CPU并行垃圾回收。</li><li>3.允许用户设置最大暂停时间。</li></ul><p>JDK9之后强烈建议使用G1垃圾回收器。</p><p>G1出现之前的垃圾回收器，年轻代和老年代一般是连续的，如下图：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1383-1024x332.png" alt="img"></p><p>G1的整个堆会被划分成多个大小相等的区域，称之为区Region，区域<strong>不要求是连续的</strong>。分为Eden、Survivor、Old区。Region的大小通过堆空间大小/2048计算得到，也可以通过参数-XX:G1HeapRegionSize=32m指定(其中32m指定region大小为32M)，Region size必须是2的指数幂，取值范围从1M到32M。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1384.png" alt="img"></p><p>G1垃圾回收有两种方式：</p><p>1、年轻代回收（Young GC）</p><p>2、混合回收（Mixed GC）</p><h5 id="年轻代回收">年轻代回收</h5><p>年轻代回收（Young GC），回收Eden区和Survivor区中不用的对象。会导致STW，G1中可以通过参数</p><p>-XX:MaxGCPauseMillis=n（默认200） 设置每次垃圾回收时的最大暂停时间毫秒数，G1垃圾回收器会尽可能地保证暂停时间。</p><p>1、新创建的对象会存放在Eden区。当G1判断年轻代区不足（max默认60%即占年轻代设置大小的60%），无法分配对象时需要回收时会执行Young GC。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1385.png" alt="img"></p><p>2、标记出Eden和Survivor区域中的存活对象，</p><p>3、根据配置的最大暂停时间选择某些区域将<strong>存活对象</strong>复制到一个新的Survivor区中（年龄+1），清空这些区域。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1386.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1387.png" alt="img"></p><p>G1在进行Young GC的过程中会去记录每次垃圾回收时每个Eden区和Survivor区的平均耗时，以作为下次回收时的参考依据。这样就可以根据配置的最大暂停时间计算出本次回收时最多能回收多少个Region区域了。</p><p>比如 -XX:MaxGCPauseMillis=n（默认200），每个Region回收耗时40ms，那么这次回收最多只能回收4个Region。</p><p>4、后续Young GC时与之前相同，只不过Survivor区中存活对象会被搬运到另一个Survivor区。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1388.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1389.png" alt="img"></p><p>5、当某个存活对象的年龄到达阈值（默认15），将被放入老年代。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1392.png" alt="img"></p><p>6、部分对象如果大小超过Region的一半，会直接放入老年代，这类老年代被称为Humongous区。比如堆内存是4G，每个Region是2M，只要一个大对象超过了1M就被放入Humongous区，如果对象过大会横跨多个Region。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1393.png" alt="img"></p><p>7、多次回收之后，会出现很多Old老年代区，此时总堆占有率达到阈值时</p><p>（-XX:InitiatingHeapOccupancyPercent默认45%）会触发混合回收MixedGC。回收所有年轻代和部分老年代的对象以及大对象区。采用复制算法来完成。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1394.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1395-1024x558.png" alt="img"></p><h5 id="混合回收">混合回收</h5><p>混合回收分为：初始标记（initial mark）、并发标记（concurrent mark）、最终标记（remark或者Finalize Marking）、并发清理（cleanup）</p><p><strong>G1对老年代的清理会选择存活度最低的区域来进行回收，这样可以保证回收效率最高</strong>，这也是G1（Garbage first）名称的由来。最后清理阶段使用复制算法，不会产生内存碎片。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1396-1024x322.png" alt="img"></p><p>混合回收的步骤：</p><ul><li>1、初始标记，STW，采用三色标记法标记从GC Root可直达的对象。 STW时间极短。</li><li>2、并发标记，并发执行，对存活对象进行标记。</li><li>3、最终标记，STW，处理SATB相关的对象标记。 STW时间极短。</li><li>4、清理，STW，如果区域中没有任何存活对象就直接清理。 STW时间极短。</li><li>5、转移，将存活对象复制到别的区域。 STW时间较长。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1397-1024x380.png" alt="img"></p><p>注意：如果清理过程中发现没有足够的空Region存放转移的对象，会出现Full GC。单线程执行标记-整理算法，此时会导致用户线程的暂停。所以尽量保证应该用的堆内存有一定多余的空间。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1398.png" alt="img"></p><h4 id="4-5-6G1-–-Garbage-First-垃圾回收器（相关参数）">4.5.6G1 – Garbage First 垃圾回收器（相关参数）</h4><p>参数1： <code>-XX:+UseG1GC</code> 打开G1的开关，JDK9之后默认不需要打开</p><p>参数2：<code>-XX:MaxGCPauseMillis=毫秒值</code> 最大暂停的时间</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1400.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1399-1024x136.png" alt="img"></p><p>使用以下代码测试g1垃圾回收器，打印出每个阶段的时间:</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">packagechapter04.gc;</span><br><span class="line"></span><br><span class="line">importjava.io.IOException;</span><br><span class="line">importjava.util.ArrayList;</span><br><span class="line">importjava.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** * 垃圾回收器案例3 */</span></span><br><span class="line"> <span class="comment">//-XX:+UseG1GC   -Xmn8g -Xmx16g -XX:SurvivorRatio=8  -XX:+PrintGCDetails -verbose:gc</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GcDemo2</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span>(<span class="params">String[] <span class="keyword">args</span></span>) throws IOException</span> &#123;</span><br><span class="line">        intcount = <span class="number">0</span>;</span><br><span class="line">        List&lt;Object&gt; list = newArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="comment">//System.out.println(++count);if(count++ % 10240 == 0)&#123;</span></span><br><span class="line">                list.clear();</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//            byte[] bytes = new byte[1024 * 1024 * 1];</span></span><br><span class="line">               list.<span class="keyword">add</span>(newbyte[<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">1</span> / <span class="number">2</span>]);</span><br><span class="line"><span class="comment">//            System.gc();&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>每个region大小为2m，一共有84个young区，26个幸存者区。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1401.png" alt="img"></p><p>初始标记花了0.0478秒。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1402.png" alt="img"></p><p>并发标记总共耗时10ms，不会产生STW。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1403.png" alt="img"></p><h4 id="4-5-7总结">4.5.7总结</h4><p>垃圾回收器的组合关系虽然很多，但是针对几个特定的版本，比较好的组合选择如下：</p><p>JDK8及之前：</p><p>ParNew + CMS（关注暂停时间）、Parallel Scavenge + Parallel Old (关注吞吐量)、 G1（JDK8之前不建议，较大堆并且关注暂停时间）</p><p>JDK9之后:</p><p>G1（默认）</p><p>从JDK9之后，由于G1日趋成熟，JDK默认的垃圾回收器已经修改为G1，所以强烈建议在生产环境上使用G1。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1404-1024x517.png" alt="img"></p><p>对于线程不共享的程序计数器和栈空间来说，它会伴随着线程的创建而创建，跟着线程的回收而回收</p><p>对于线程共享的两部分方法区和堆来说，方法区一般不需要回收，在特定的某些技术如JSP等技术会通过回收类加载器去回收方法区的类，但一般对于程序员来说这块很少关注；堆则会有垃圾回收器来负责回收</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1406-1024x204.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1405.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1407-1024x396.png" alt="img"></p><p>标记-清除算法：标记之后再清除，容易产生内存碎片</p><p>复制算法：从一块区域复制到另一块区域容易造成只能使用一部分内存，对内存的使用率会下降</p><p>标记-整理算法：标记之后将存活的对象推到一边，对象会移动，效率不高</p><p>分代GC算法:将内存区域划分为年轻代、幸存者区、老年代进行回收、可以使用多种回收算法</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1408-1024x469.png" alt="img"></p><p>Serial和Serial Old的组合：单线程回收，主要适用于单核CPU场景</p><p>ParNew和CMS的组合:暂停时间较短，适用于大型互联网应用中与用户交互的部分（创建订单，查询商品信息），但还需注意CMS的缺点</p><p>Parallel Scavenge 和Parallel Old的组合：吞吐量高，适用于后台进行大量数据操作</p><p>G1垃圾回收器：适用于较大的堆，具有可控的暂停时间</p><h1 id="基础篇完结">基础篇完结</h1>]]></content>
      
      
      <categories>
          
          <category> JVM </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysql基础篇</title>
      <link href="/posts/9.html"/>
      <url>/posts/9.html</url>
      
        <content type="html"><![CDATA[<p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1409-1024x502.png" alt="img"></p><h2 id="基础篇">基础篇</h2><h2 id="1-MySQL概述">1.MySQL概述</h2><h3 id="1-1数据库相关概念">1.1数据库相关概念</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1410.png" alt="img"></p><h3 id="1-2MySQL数据库安装与配置-略">1.2MySQL数据库安装与配置 -略</h3><h3 id="1-3关系型数据库与非关系型数据库">1.3关系型数据库与非关系型数据库</h3><p>详见-Redis基础篇 1.1认识NoSQL</p><p>这里简单总结一下：</p><h4 id="基本概念">基本概念</h4><ul><li><p><strong>关系型数据库（RDBMS）</strong><br>基于<strong>表格结构</strong>（行和列），严格遵守数据模式（schema）。常见：MySQL、PostgreSQL、Oracle、SQL Server。</p></li><li><p>非关系型数据库（NoSQL）</p><p>全称</p><p>Not Only SQL</p><p>，数据组织方式灵活，不一定是表格。常见类型：</p><ul><li><strong>键值型</strong>（Redis、Memcached）</li><li><strong>文档型</strong>（MongoDB）</li><li><strong>图数据库</strong>（Neo4j）</li></ul></li></ul><h4 id="结构化-vs-非结构化">结构化 vs. 非结构化</h4><ul><li><strong>关系型数据库</strong>：数据是<strong>结构化的</strong>，每个表都有明确字段、数据类型和约束，插入必须符合这些规则。</li><li><strong>NoSQL</strong>：格式更自由，没有强制固定结构，可以直接存键值对、JSON文档、图数据等。<br>✅ 优势：灵活，适应快速变化的业务需求<br>❌ 劣势：缺乏统一标准，数据一致性依赖应用层处理</li></ul><h4 id="关联关系">关联关系</h4><ul><li><strong>关系型数据库</strong>：通过<strong>外键</strong>等机制维护表之间的关联，数据一致性强，查询关系方便。</li><li><strong>NoSQL</strong>：通常不内置关联，需要应用层逻辑或在文档中<strong>冗余存储</strong>（把相关数据直接嵌入），牺牲了优雅性换取查询速度。</li></ul><h4 id="查询方式">查询方式</h4><ul><li><strong>关系型数据库</strong>：统一使用 <strong>SQL</strong>，语法标准化，跨数据库迁移相对容易。</li><li><strong>NoSQL</strong>：每种数据库都有自己的查询方式，例如 MongoDB 用 JSON 语法，Redis 用命令行指令，缺乏统一性。</li></ul><h4 id="事务处理">事务处理</h4><ul><li><strong>关系型数据库</strong>：遵守 <strong>ACID</strong> 原则（原子性、一致性、隔离性、持久性），适合需要强一致性的场景（如银行转账）。</li><li><strong>NoSQL</strong>：事务支持有限，有些只保证“最终一致性”，性能好但一致性弱。</li></ul><h4 id="存储方式与扩展性">存储方式与扩展性</h4><ul><li><p>关系型数据库</p><p>：</p><ul><li>存储在磁盘上（大量磁盘 I/O，速度相对慢）</li><li>扩展以<strong>垂直扩展</strong>（提升单机性能）为主，做水平扩展（分库分表）会很麻烦，因为表之间存在复杂关联</li></ul></li><li><p>NoSQL</p><p>：</p><ul><li>依赖内存操作（速度快）</li><li>原生支持<strong>水平扩展</strong>（数据分布到多台机器上），适合处理海量数据</li></ul></li></ul><table><thead><tr><th>特性</th><th>关系型数据库</th><th>非关系型数据库</th></tr></thead><tbody><tr><td>数据结构</td><td>表格结构</td><td>键值、文档、图等</td></tr><tr><td>结构约束</td><td>严格 schema</td><td>灵活，无固定 schema</td></tr><tr><td>关联关系</td><td>外键维护</td><td>应用层或冗余数据</td></tr><tr><td>查询语言</td><td>SQL（统一）</td><td>各家不同</td></tr><tr><td>事务</td><td>ACID</td><td>最终一致性为主</td></tr><tr><td>存储</td><td>磁盘 I/O</td><td>内存优先</td></tr><tr><td>扩展性</td><td>垂直扩展为主</td><td>水平扩展为主</td></tr></tbody></table><p>关系型数据库就像<strong>严格的 Excel 表格</strong>，规则清晰、关系严谨；<br>NoSQL 就像<strong>灵活的笔记本</strong>，随便写、随便画，速度快、扩展性好，但需要你自己保证内容的逻辑性。</p><h3 id="1-4MySQL客户端连接">1.4MySQL客户端连接</h3><p>1.使用MySQL提供的客户端命令行工具</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1411-1024x437.png" alt="img"></p><p>2.使用系统自带的命令行工具执行指令</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> mysql  [-h 127.0.0.1]  [-P 3306]  -u root -p</span><br><span class="line">参数：</span><br><span class="line"><span class="deletion">-h : MySQL服务所在的主机IP</span></span><br><span class="line"><span class="deletion">-P : MySQL服务端口号， 默认3306</span></span><br><span class="line"><span class="deletion">-u : MySQL数据库用户名</span></span><br><span class="line"><span class="deletion">-p ： MySQL数据库用户名对应的密</span></span><br></pre></td></tr></table></figure><h2 id="2-SQL">2.SQL</h2><p>全称 Structured Query Language，结构化查询语言。操作关系型数据库的编程语言，定义了<br>一套操作关系型数据库统一标准。</p><h3 id="1-通用语法及分类">1.通用语法及分类</h3><ul><li>DDL: 数据定义语言，用来定义数据库对象（数据库、表、字段）</li><li>DML: 数据操作语言，用来对数据库表中的数据进行增删改</li><li>DQL: 数据查询语言，用来查询数据库中表的记录</li><li>DCL: 数据控制语言，用来创建数据库用户、控制数据库的控制权限</li></ul><h3 id="2-DDL（数据定义语言）">2.DDL（数据定义语言）</h3><p>数据定义语言</p><h4 id="数据库操作">数据库操作</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">查询所有数据库：</span><br><span class="line"><span class="keyword">SHOW</span> DATABASES;</span><br><span class="line">查询当前数据库：</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DATABASE</span>();</span><br><span class="line">创建数据库：</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> [ <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> ] 数据库名 [ <span class="keyword">DEFAULT</span> CHARSET 字符集] [<span class="keyword">COLLATE</span> 排序规则 ];</span><br><span class="line">删除数据库：</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">DATABASE</span> [ <span class="keyword">IF</span> <span class="keyword">EXISTS</span> ] 数据库名;</span><br><span class="line">使用数据库：</span><br><span class="line">USE 数据库名;</span><br></pre></td></tr></table></figure><p>注意事项</p><ul><li>UTF8字符集长度为3字节，有些符号占4字节，所以推荐用utf8mb4字符集</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1416-1024x832.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1417-1024x872.png" alt="img"></p><h4 id="表操作">表操作</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">查询当前数据库所有表：</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">TABLES</span>;</span><br><span class="line">查询表结构：</span><br><span class="line"><span class="keyword">DESC</span> 表名;</span><br><span class="line">查询指定表的建表语句：</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> 表名;</span><br></pre></td></tr></table></figure><p>创建表：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE <span class="selector-tag">TABLE</span>  表名(</span><br><span class="line">字段<span class="number">1</span>  字段<span class="number">1</span>类型 <span class="selector-attr">[ COMMENT  字段1注释 ]</span>,</span><br><span class="line">字段<span class="number">2</span>  字段<span class="number">2</span>类型 <span class="selector-attr">[COMMENT  字段2注释 ]</span>,</span><br><span class="line">字段<span class="number">3</span>  字段<span class="number">3</span>类型 <span class="selector-attr">[COMMENT  字段3注释 ]</span>,</span><br><span class="line"> ......</span><br><span class="line">字段n  字段n类型 <span class="selector-attr">[COMMENT  字段n注释 ]</span> </span><br><span class="line">) <span class="selector-attr">[ COMMENT  表注释 ]</span> ;</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1418.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1419.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1420.png" alt="img"></p><p><strong>最后一个字段后面没有逗号</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">添加字段：</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> 表名 <span class="keyword">ADD</span> 字段名 类型(长度) [<span class="keyword">COMMENT</span> 注释] [约束];</span><br><span class="line">例：<span class="keyword">ALTER</span> <span class="keyword">TABLE</span> emp <span class="keyword">ADD</span> nickname <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">COMMENT</span> <span class="string">&#x27;昵称&#x27;</span>;</span><br><span class="line">修改数据类型：</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> 表名 MODIFY 字段名 新数据类型(长度);</span><br><span class="line">修改字段名和字段类型：</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> 表名 CHANGE 旧字段名 新字段名 类型(长度) [<span class="keyword">COMMENT</span> 注释] [约束];</span><br><span class="line">例：将emp表的nickname字段修改为username，类型为<span class="type">varchar</span>(<span class="number">30</span>)</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> emp CHANGE nickname username <span class="type">varchar</span>(<span class="number">30</span>) <span class="keyword">COMMENT</span> <span class="string">&#x27;昵称&#x27;</span>;</span><br><span class="line">删除字段：</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> 表名 <span class="keyword">DROP</span> 字段名;</span><br><span class="line">修改表名：</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> 表名 <span class="keyword">RENAME</span> <span class="keyword">TO</span> 新表名</span><br><span class="line">删除表：</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> [<span class="keyword">IF</span> <span class="keyword">EXISTS</span>] 表名;</span><br><span class="line">删除表，并重新创建该表：</span><br><span class="line"><span class="keyword">TRUNCATE</span> <span class="keyword">TABLE</span> 表名;</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1421-1024x157.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1423-1024x197.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1424.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1425.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1426.png" alt="img"></p><h3 id="3-数据类型">3.数据类型</h3><h4 id="数值类型">数值类型</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1412-1024x352.png" alt="img"></p><p>如:<br>1). 年龄字段 – 不会出现负数, 而且人的年龄不会太大<br>age tinyint unsigned</p><p>2). 分数 – 总分100分, 最多出现一位小数 score double(4,1)</p><h4 id="字符串类型">字符串类型</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1413-1024x363.png" alt="img"></p><p>如：<br>1). 用户名 username ------&gt; 长度不定, 最长不会超过50<br>username varchar(50)</p><p>2). 性别 gender ---------&gt; 存储值, 不是男,就是女 gender char(1) 3). 手机号 phone --------&gt; 固定长度为11 phone char(11)</p><h4 id="日期时间类型">日期时间类型</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1414-1024x247.png" alt="img"></p><p>如:<br>1). 生日字段 birthday<br>birthday date</p><p>2). 创建时间 createtime createtime  datetime</p><h3 id="4-图形化界面工具">4 图形化界面工具</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1415-1024x285.png" alt="img"></p><h3 id="5-DML（数据操作语言）">5.DML（数据操作语言）</h3><h4 id="添加数据">添加数据</h4><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">指定字段：</span><br><span class="line">INSERT <span class="keyword">INTO</span> 表名 (字段名<span class="number">1</span>, 字段名<span class="number">2</span>, <span class="params">...</span>) VALUES (值<span class="number">1</span>, 值<span class="number">2</span>, <span class="params">...</span>);</span><br><span class="line">全部字段：</span><br><span class="line">INSERT <span class="keyword">INTO</span> 表名 VALUES (值<span class="number">1</span>, 值<span class="number">2</span>, <span class="params">...</span>);</span><br><span class="line">批量添加数据：</span><br><span class="line">INSERT <span class="keyword">INTO</span> 表名 (字段名<span class="number">1</span>, 字段名<span class="number">2</span>, <span class="params">...</span>) VALUES (值<span class="number">1</span>, 值<span class="number">2</span>, <span class="params">...</span>), (值<span class="number">1</span>, 值<span class="number">2</span>, <span class="params">...</span>), (值<span class="number">1</span>, 值<span class="number">2</span>, <span class="params">...</span>);</span><br><span class="line">INSERT <span class="keyword">INTO</span> 表名 VALUES (值<span class="number">1</span>, 值<span class="number">2</span>, <span class="params">...</span>), (值<span class="number">1</span>, 值<span class="number">2</span>, <span class="params">...</span>), (值<span class="number">1</span>, 值<span class="number">2</span>, <span class="params">...</span>);</span><br></pre></td></tr></table></figure><p>注意事项</p><ul><li>字符串和日期类型数据应该包含在引号中</li><li>插入的数据大小应该在字段的规定范围内</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1427.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1428-1024x491.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1429-1024x166.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1430-1024x178.png" alt="img"></p><h4 id="更新和删除数据">更新和删除数据</h4><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">修改数据：</span><br><span class="line"><span class="keyword">UPDATE</span> 表名 <span class="keyword">SET</span> 字段名<span class="number">1</span> = 值<span class="number">1</span>, 字段名<span class="number">2</span> = 值<span class="number">2</span>, ... [ <span class="keyword">WHERE</span> 条件 ];</span><br><span class="line">例：</span><br><span class="line"><span class="keyword">UPDATE</span> emp <span class="keyword">SET</span> name = <span class="string">&#x27;Jack&#x27;</span> <span class="keyword">WHERE</span> id = <span class="number">1</span>;</span><br><span class="line">删除数据：</span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> 表名 [ <span class="keyword">WHERE</span> 条件 ];</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1431.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1432.png" alt="img"></p><h3 id="6-DQL-数据查询语言）">6 .DQL(数据查询语言）</h3><p>语法：</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">字段列表</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">表名字段</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">条件列表</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">分组字段列表</span><br><span class="line"><span class="keyword">HAVING</span></span><br><span class="line">分组后的条件列表</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">排序字段列表</span><br><span class="line"><span class="keyword">LIMIT</span></span><br><span class="line">分页参数</span><br></pre></td></tr></table></figure><h4 id="基础查询">基础查询</h4><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">查询多个字段：</span><br><span class="line"><span class="keyword">SELECT</span> 字段<span class="number">1</span>, 字段<span class="number">2</span>, 字段<span class="number">3</span>, ... <span class="keyword">FROM</span> 表名;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> 表名;</span><br><span class="line">设置别名：</span><br><span class="line"><span class="keyword">SELECT</span> 字段<span class="number">1</span> [ <span class="keyword">AS</span> 别名<span class="number">1</span> ], 字段<span class="number">2</span> [ <span class="keyword">AS</span> 别名<span class="number">2</span> ], 字段<span class="number">3</span> [ <span class="keyword">AS</span> 别名<span class="number">3</span> ], ... <span class="keyword">FROM</span> 表名;</span><br><span class="line"><span class="keyword">SELECT</span> 字段<span class="number">1</span> [ 别名<span class="number">1</span> ], 字段<span class="number">2</span> [ 别名<span class="number">2</span> ], 字段<span class="number">3</span> [ 别名<span class="number">3</span> ], ... <span class="keyword">FROM</span> 表名;</span><br><span class="line">去除重复记录：</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> 字段列表 <span class="keyword">FROM</span> 表名;</span><br><span class="line">转义：</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> 表名 <span class="keyword">WHERE</span> name <span class="keyword">LIKE</span> <span class="string">&#x27;/_张三&#x27;</span> ESCAPE <span class="string">&#x27;/&#x27;</span></span><br><span class="line">/ 之后的_不作为通配符</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1433.png" alt="img"></p><h4 id="条件查询">条件查询</h4><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line"><span class="keyword">SELECT</span> 字段列表 <span class="keyword">FROM</span> 表名 <span class="keyword">WHERE</span> 条件列表;</span><br></pre></td></tr></table></figure><p>条件：</p><table><thead><tr><th>比较运算符</th><th>功能</th></tr></thead><tbody><tr><td>&gt;</td><td>大于</td></tr><tr><td>&gt;=</td><td>大于等于</td></tr><tr><td>&lt;</td><td>小于</td></tr><tr><td>&lt;=</td><td>小于等于</td></tr><tr><td>=</td><td>等于</td></tr><tr><td>&lt;&gt; 或 !=</td><td>不等于</td></tr><tr><td>BETWEEN … AND …</td><td>在某个范围内（含最小、最大值）</td></tr><tr><td>IN(…)</td><td>在in之后的列表中的值，多选一</td></tr><tr><td>LIKE 占位符</td><td>模糊匹配（_匹配单个字符，%匹配任意个字符）</td></tr><tr><td>IS NULL</td><td>是NULL</td></tr></tbody></table><table><thead><tr><th>逻辑运算符</th><th>功能</th></tr></thead><tbody><tr><td>AND 或 &amp;&amp;</td><td>并且（多个条件同时成立）</td></tr><tr><td>OR 或 ||</td><td>或者（多个条件任意一个成立）</td></tr><tr><td>NOT 或 !</td><td>非，不是</td></tr></tbody></table><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 年龄等于30</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> age = <span class="number">30</span>;</span><br><span class="line"><span class="comment">-- 年龄小于30</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> age &lt; <span class="number">30</span>;</span><br><span class="line"><span class="comment">-- 小于等于</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> age &lt;= <span class="number">30</span>;</span><br><span class="line"><span class="comment">-- 没有身份证</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> idcard <span class="keyword">is</span> <span class="keyword">null</span> <span class="keyword">or</span> idcard = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="comment">-- 有身份证</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> idcard;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> idcard <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">-- 不等于</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> age != <span class="number">30</span>;</span><br><span class="line"><span class="comment">-- 年龄在20到30之间</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> age <span class="keyword">between</span> <span class="number">20</span> <span class="keyword">and</span> <span class="number">30</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> age &gt;= <span class="number">20</span> <span class="keyword">and</span> age &lt;= <span class="number">30</span>;</span><br><span class="line"><span class="comment">-- 下面语句不报错，但查不到任何信息</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> age <span class="keyword">between</span> <span class="number">30</span> <span class="keyword">and</span> <span class="number">20</span>;</span><br><span class="line"><span class="comment">-- 性别为女且年龄小于30</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> age &lt; <span class="number">30</span> <span class="keyword">and</span> gender = <span class="string">&#x27;女&#x27;</span>;</span><br><span class="line"><span class="comment">-- 年龄等于25或30或35</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> age = <span class="number">25</span> <span class="keyword">or</span> age = <span class="number">30</span> <span class="keyword">or</span> age = <span class="number">35</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> age <span class="keyword">in</span> (<span class="number">25</span>, <span class="number">30</span>, <span class="number">35</span>);</span><br><span class="line"><span class="comment">-- 姓名为两个字</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> <span class="type">name</span> <span class="keyword">like</span> <span class="string">&#x27;__&#x27;</span>;</span><br><span class="line"><span class="comment">-- 身份证最后为X</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> idcard <span class="keyword">like</span> <span class="string">&#x27;%X&#x27;</span>;</span><br></pre></td></tr></table></figure><h4 id="聚合查询（聚合函数）">聚合查询（聚合函数）</h4><p>常见聚合函数：</p><table><thead><tr><th>函数</th><th>功能</th></tr></thead><tbody><tr><td>count</td><td>统计数量</td></tr><tr><td>max</td><td>最大值</td></tr><tr><td>min</td><td>最小值</td></tr><tr><td>avg</td><td>平均值</td></tr><tr><td>sum</td><td>求和</td></tr></tbody></table><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line"><span class="keyword">SELECT</span> 聚合函数(字段列表) <span class="keyword">FROM</span> 表名;</span><br><span class="line">例：</span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(id) <span class="keyword">from</span> employee <span class="keyword">where</span> workaddress = <span class="string">&quot;广东省&quot;</span>;</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1434.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1435.png" alt="img"></p><h4 id="分组查询">分组查询</h4><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line"><span class="keyword">SELECT</span> 字段列表 <span class="keyword">FROM</span> 表名 [ <span class="keyword">WHERE</span> 条件 ] <span class="keyword">GROUP</span> <span class="keyword">BY</span> 分组字段名 [ <span class="keyword">HAVING</span> 分组后的过滤条件 ];</span><br></pre></td></tr></table></figure><p>where 和 having 的区别：</p><ul><li>执行时机不同：where是分组之前进行过滤，不满足where条件不参与分组；having是分组后对结果进行过滤。</li><li>判断条件不同：where不能对聚合函数进行判断，而having可以。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1436.png" alt="img"></p><p>例子：</p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-- 根据性别分组，统计男性和女性数量（只显示分组数量，不显示哪个是男哪个是女）</span><br><span class="line"><span class="keyword">select</span> count<span class="comment">(*) from employee group by gender;</span></span><br><span class="line"><span class="comment">-- 根据性别分组，统计男性和女性数量</span></span><br><span class="line"><span class="comment">select gender, count(*)</span> <span class="keyword">from</span> employee <span class="keyword">group</span> <span class="keyword">by</span> gender<span class="punctuation">;</span></span><br><span class="line">-- 根据性别分组，统计男性和女性的平均年龄</span><br><span class="line"><span class="keyword">select</span> gender, avg(age) <span class="keyword">from</span> employee <span class="keyword">group</span> <span class="keyword">by</span> gender<span class="punctuation">;</span></span><br><span class="line">-- 年龄小于<span class="number">45</span>，并根据工作地址分组</span><br><span class="line"><span class="keyword">select</span> workaddress, count<span class="comment">(*) from employee where age &lt; 45 group by workaddress;</span></span><br><span class="line"><span class="comment">-- 年龄小于45，并根据工作地址分组，获取员工数量大于等于3的工作地址</span></span><br><span class="line"><span class="comment">select workaddress, count(*)</span> address_count <span class="keyword">from</span> employee <span class="keyword">where</span> age &lt; <span class="number">45</span> <span class="keyword">group</span> <span class="keyword">by</span> workaddress having address_count &gt;= <span class="number">3</span><span class="punctuation">;</span></span><br></pre></td></tr></table></figure><h4 id="排序查询">排序查询</h4><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line"><span class="keyword">SELECT</span> 字段列表 <span class="keyword">FROM</span> 表名 <span class="keyword">ORDER</span> <span class="keyword">BY</span> 字段<span class="number">1</span> 排序方式<span class="number">1</span>, 字段<span class="number">2</span> 排序方式<span class="number">2</span>;</span><br></pre></td></tr></table></figure><p>排序方式：</p><ul><li>ASC: 升序（默认）</li><li>DESC: 降序</li></ul><p>例子：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 根据年龄升序排序</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> employee <span class="keyword">ORDER</span> <span class="keyword">BY</span> age <span class="keyword">ASC</span>;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> employee <span class="keyword">ORDER</span> <span class="keyword">BY</span> age;</span><br><span class="line"><span class="comment">-- 两字段排序，根据年龄升序排序，入职时间降序排序</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> employee <span class="keyword">ORDER</span> <span class="keyword">BY</span> age <span class="keyword">ASC</span>, entrydate <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure><p>注意事项</p><p>如果是多字段排序，当第一个字段值相同时，才会根据第二个字段进行排序</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1437.png" alt="img"></p><h4 id="分页查询">分页查询</h4><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line"><span class="keyword">SELECT</span> 字段列表 <span class="keyword">FROM</span> 表名 <span class="keyword">LIMIT</span> 起始索引, 查询记录数;</span><br></pre></td></tr></table></figure><p>例子：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询第一页数据，展示10条</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> employee <span class="keyword">LIMIT</span> <span class="number">0</span>, <span class="number">10</span>;</span><br><span class="line"><span class="comment">-- 查询第二页</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> employee <span class="keyword">LIMIT</span> <span class="number">10</span>, <span class="number">10</span>;</span><br></pre></td></tr></table></figure><p>注意事项</p><ul><li>起始索引从0开始，起始索引 = （查询页码 - 1） * 每页显示记录数</li><li>分页查询是数据库的方言，不同数据库有不同实现，MySQL是LIMIT</li><li>如果查询的是第一页数据，起始索引可以省略，直接简写 LIMIT 10</li></ul><h4 id="案例">案例</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1438.png" alt="img"></p><h4 id="DQL执行顺序">DQL执行顺序</h4><p>FROM -&gt; WHERE -&gt; GROUP BY -&gt; SELECT -&gt; ORDER BY -&gt; LIMIT</p><h3 id="7-DCL-数据控制语言">7.DCL(数据控制语言)</h3><p>用来管理数据库用户、控制数据库的访问权限。</p><h4 id="管理用户">管理用户</h4><p>查询用户：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">USE mysql;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span>;</span><br><span class="line">创建用户:</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;用户名&#x27;</span>@<span class="string">&#x27;主机名&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;密码&#x27;</span>;</span><br><span class="line">修改用户密码：</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> <span class="string">&#x27;用户名&#x27;</span>@<span class="string">&#x27;主机名&#x27;</span> IDENTIFIED <span class="keyword">WITH</span> mysql_native_password <span class="keyword">BY</span> <span class="string">&#x27;新密码&#x27;</span>;</span><br><span class="line">删除用户：</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">USER</span> <span class="string">&#x27;用户名&#x27;</span>@<span class="string">&#x27;主机名&#x27;</span>;</span><br></pre></td></tr></table></figure><p>例子：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 创建用户test，只能在当前主机localhost访问</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;test&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"><span class="comment">-- 创建用户test，能在任意主机访问</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;test&#x27;</span>@<span class="string">&#x27;%&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="string">&#x27;test&#x27;</span> identified <span class="keyword">by</span> <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"><span class="comment">-- 修改密码</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">user</span> <span class="string">&#x27;test&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> identified <span class="keyword">with</span> mysql_native_password <span class="keyword">by</span> <span class="string">&#x27;1234&#x27;</span>;</span><br><span class="line"><span class="comment">-- 删除用户</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">user</span> <span class="string">&#x27;test&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br></pre></td></tr></table></figure><p>注意事项</p><ul><li>主机名可以使用 % 通配</li></ul><h4 id="权限控制">权限控制</h4><p>常用权限：</p><table><thead><tr><th>权限</th><th>说明</th></tr></thead><tbody><tr><td>ALL, ALL PRIVILEGES</td><td>所有权限</td></tr><tr><td>SELECT</td><td>查询数据</td></tr><tr><td>INSERT</td><td>插入数据</td></tr><tr><td>UPDATE</td><td>修改数据</td></tr><tr><td>DELETE</td><td>删除数据</td></tr><tr><td>ALTER</td><td>修改表</td></tr><tr><td>DROP</td><td>删除数据库/表/视图</td></tr><tr><td>CREATE</td><td>创建数据库/表</td></tr></tbody></table><p>上述只是简单罗列了常见的几种权限描述，其他权限描述及含义，可以直接参考官方文档。</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">查询权限：</span><br><span class="line"><span class="keyword">SHOW</span> GRANTS <span class="keyword">FOR</span> <span class="string">&#x27;用户名&#x27;</span>@<span class="string">&#x27;主机名&#x27;</span>;</span><br><span class="line">授予权限：</span><br><span class="line"><span class="keyword">GRANT</span> 权限列表 <span class="keyword">ON</span> 数据库名.表名 <span class="keyword">TO</span> <span class="string">&#x27;用户名&#x27;</span>@<span class="string">&#x27;主机名&#x27;</span>;</span><br><span class="line">撤销权限：</span><br><span class="line"><span class="keyword">REVOKE</span> 权限列表 <span class="keyword">ON</span> 数据库名.表名 <span class="keyword">FROM</span> <span class="string">&#x27;用户名&#x27;</span>@<span class="string">&#x27;主机名&#x27;</span>;</span><br></pre></td></tr></table></figure><p>注意事项</p><ul><li>多个权限用逗号分隔</li><li>授权时，数据库名和表名可以用 * 进行通配，代表所有</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1439.png" alt="img"></p><h2 id="3-函数">3.函数</h2><ul><li>字符串函数</li><li>数值函数</li><li>日期函数</li><li>流程函数</li></ul><h3 id="1-字符串函数">1.字符串函数</h3><p>常用函数：</p><table><thead><tr><th>函数</th><th>功能</th></tr></thead><tbody><tr><td>CONCAT(s1, s2, …, sn)</td><td>字符串拼接，将s1, s2, …, sn拼接成一个字符串</td></tr><tr><td>LOWER(str)</td><td>将字符串全部转为小写</td></tr><tr><td>UPPER(str)</td><td>将字符串全部转为大写</td></tr><tr><td>LPAD(str, n, pad)</td><td>左填充，用字符串pad对str的左边进行填充，达到n个字符串长度</td></tr><tr><td>RPAD(str, n, pad)</td><td>右填充，用字符串pad对str的右边进行填充，达到n个字符串长度</td></tr><tr><td>TRIM(str)</td><td>去掉字符串头部和尾部的空格</td></tr><tr><td>SUBSTRING(str, start, len)</td><td>返回从字符串str从start位置起的len个长度的字符串</td></tr><tr><td>REPLACE(column, source, replace)</td><td>替换字符串</td></tr></tbody></table><p>使用示例：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 拼接</span></span><br><span class="line"><span class="keyword">SELECT</span> CONCAT(<span class="string">&#x27;Hello&#x27;</span>, <span class="string">&#x27;World&#x27;</span>);</span><br><span class="line"><span class="comment">-- 小写</span></span><br><span class="line"><span class="keyword">SELECT</span> LOWER(<span class="string">&#x27;Hello&#x27;</span>);</span><br><span class="line"><span class="comment">-- 大写</span></span><br><span class="line"><span class="keyword">SELECT</span> UPPER(<span class="string">&#x27;Hello&#x27;</span>);</span><br><span class="line"><span class="comment">-- 左填充</span></span><br><span class="line"><span class="keyword">SELECT</span> LPAD(<span class="string">&#x27;01&#x27;</span>, <span class="number">5</span>, <span class="string">&#x27;-&#x27;</span>);</span><br><span class="line"><span class="comment">-- 右填充</span></span><br><span class="line"><span class="keyword">SELECT</span> RPAD(<span class="string">&#x27;01&#x27;</span>, <span class="number">5</span>, <span class="string">&#x27;-&#x27;</span>);</span><br><span class="line"><span class="comment">-- 去除空格</span></span><br><span class="line"><span class="keyword">SELECT</span> TRIM(<span class="string">&#x27; Hello World &#x27;</span>);</span><br><span class="line"><span class="comment">-- 切片（起始索引为1）</span></span><br><span class="line"><span class="keyword">SELECT</span> SUBSTRING(<span class="string">&#x27;Hello World&#x27;</span>, <span class="number">1</span>, <span class="number">5</span>);</span><br></pre></td></tr></table></figure><h3 id="2-数值函数">2.数值函数</h3><p>常见函数：</p><table><thead><tr><th>函数</th><th>功能</th></tr></thead><tbody><tr><td>CEIL(x)</td><td>向上取整</td></tr><tr><td>FLOOR(x)</td><td>向下取整</td></tr><tr><td>MOD(x, y)</td><td>返回x/y的模</td></tr><tr><td>RAND()</td><td>返回0~1内的随机数</td></tr><tr><td>ROUND(x, y)</td><td>求参数x的四舍五入值，保留y位小数</td></tr></tbody></table><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1440.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1441.png" alt="img"></p><h3 id="3-日期函数">3.日期函数</h3><p>常用函数：</p><table><thead><tr><th>函数</th><th>功能</th></tr></thead><tbody><tr><td>CURDATE()</td><td>返回当前日期</td></tr><tr><td>CURTIME()</td><td>返回当前时间</td></tr><tr><td>NOW()</td><td>返回当前日期和时间</td></tr><tr><td>YEAR(date)</td><td>获取指定date的年份</td></tr><tr><td>MONTH(date)</td><td>获取指定date的月份</td></tr><tr><td>DAY(date)</td><td>获取指定date的日期</td></tr><tr><td>DATE_ADD(date, INTERVAL expr type)</td><td>返回一个日期/时间值加上一个时间间隔expr后的时间值</td></tr><tr><td>DATEDIFF(date1, date2)</td><td>返回起始时间date1和结束时间date2之间的天数</td></tr></tbody></table><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1442-519x1024.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1443.png" alt="img"></p><h3 id="4-流程函数">4.流程函数</h3><p>常用函数：</p><table><thead><tr><th>函数</th><th>功能</th></tr></thead><tbody><tr><td>IF(value, t, f)</td><td>如果value为true，则返回t，否则返回f</td></tr><tr><td>IFNULL(value1, value2)</td><td>如果value1不为空，返回value1，否则返回value2</td></tr><tr><td>CASE WHEN [ val1 ] THEN [ res1 ] … ELSE [ default ] END</td><td>如果val1为true，返回res1，… 否则返回default默认值</td></tr><tr><td>CASE [ expr ] WHEN [ val1 ] THEN [ res1 ] … ELSE [ default ] END</td><td>如果expr的值等于val1，返回res1，… 否则返回default默认值</td></tr></tbody></table><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1444.png" alt="img"></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">select</span></span><br><span class="line"> id,</span><br><span class="line"> <span class="type">name</span>,</span><br><span class="line"> (<span class="keyword">case</span> <span class="keyword">when</span> math &gt;= <span class="number">85</span> <span class="keyword">then</span> <span class="string">&#x27;优秀&#x27;</span> <span class="keyword">when</span> math &gt;=<span class="number">60</span> <span class="keyword">then</span> <span class="string">&#x27;及格&#x27;</span> <span class="keyword">else</span> <span class="string">&#x27;不及格&#x27;</span> <span class="keyword">end</span> ) </span><br><span class="line"><span class="string">&#x27;数学&#x27;</span>,</span><br><span class="line"> <span class="keyword">end</span> ) <span class="string">&#x27;英语&#x27;</span>,</span><br><span class="line"> <span class="keyword">end</span> ) <span class="string">&#x27;语文&#x27;</span></span><br><span class="line"> (<span class="keyword">case</span> <span class="keyword">when</span> english &gt;= <span class="number">85</span> <span class="keyword">then</span> <span class="string">&#x27;优秀&#x27;</span> <span class="keyword">when</span> english &gt;=<span class="number">60</span> <span class="keyword">then</span> <span class="string">&#x27;及格&#x27;</span> <span class="keyword">else</span> <span class="string">&#x27;不及格&#x27;</span> </span><br><span class="line">(<span class="keyword">case</span> <span class="keyword">when</span> chinese &gt;= <span class="number">85</span> <span class="keyword">then</span> <span class="string">&#x27;优秀&#x27;</span> <span class="keyword">when</span> chinese &gt;=<span class="number">60</span> <span class="keyword">then</span> <span class="string">&#x27;及格&#x27;</span> <span class="keyword">else</span> <span class="string">&#x27;不及格&#x27;</span> </span><br><span class="line"><span class="keyword">from</span> score;</span><br></pre></td></tr></table></figure><h2 id="4-约束">4.约束</h2><p>概念：约束是作用于表中字段上的规则，用于限制存储在表中的数据。<br>目的：保证数据库中数据的正确、有效性和完整性。</p><p>分类：</p><table><thead><tr><th>约束</th><th>描述</th><th>关键字</th></tr></thead><tbody><tr><td>非空约束</td><td>限制该字段的数据不能为null</td><td>NOT NULL</td></tr><tr><td>唯一约束</td><td>保证该字段的所有数据都是唯一、不重复的</td><td>UNIQUE</td></tr><tr><td>主键约束</td><td>主键是一行数据的唯一标识，要求非空且唯一</td><td>PRIMARY KEY</td></tr><tr><td>默认约束</td><td>保存数据时，如果未指定该字段的值，则采用默认值</td><td>DEFAULT</td></tr><tr><td>检查约束（8.0.1版本后）</td><td>保证字段值满足某一个条件</td><td>CHECK</td></tr><tr><td>外键约束</td><td>用来让两张图的数据之间建立连接，保证数据的一致性和完整性</td><td>FOREIGN KEY</td></tr></tbody></table><p>约束是作用于表中字段上的，可以再创建表/修改表的时候添加约束。</p><h3 id="1-常用约束">1.常用约束</h3><table><thead><tr><th>约束条件</th><th>关键字</th></tr></thead><tbody><tr><td>主键</td><td>PRIMARY KEY</td></tr><tr><td>自动增长</td><td>AUTO_INCREMENT</td></tr><tr><td>不为空</td><td>NOT NULL</td></tr><tr><td>唯一</td><td>UNIQUE</td></tr><tr><td>逻辑条件</td><td>CHECK</td></tr><tr><td>默认值</td><td>DEFAULT</td></tr></tbody></table><p>例子：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">user</span>(</span><br><span class="line">id <span class="type">int</span> <span class="keyword">primary key</span> auto_increment,</span><br><span class="line"><span class="type">name</span> <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">unique</span>,</span><br><span class="line">age <span class="type">int</span> <span class="keyword">check</span>(age &gt; <span class="number">0</span> <span class="keyword">and</span> age &lt; <span class="number">120</span>),</span><br><span class="line">status <span class="type">char</span>(<span class="number">1</span>) <span class="keyword">default</span> <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">gender <span class="type">char</span>(<span class="number">1</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h3 id="2-外键约束">2.外键约束</h3><p>添加外键：</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> 表名(</span><br><span class="line">字段名 字段类型,</span><br><span class="line">...</span><br><span class="line">[CONSTRAINT] [外键名称] <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span>(外键字段名) <span class="keyword">REFERENCES</span> 主表(主表列名)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> 表名 <span class="keyword">ADD</span> CONSTRAINT 外键名称 <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (外键字段名) <span class="keyword">REFERENCES</span> 主表(主表列名);</span><br><span class="line"></span><br><span class="line">-- 例子</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> emp <span class="keyword">add</span> constraint fk_emp_dept_id <span class="keyword">foreign</span> <span class="keyword">key</span>(dept_id) <span class="keyword">references</span> dept(id);</span><br></pre></td></tr></table></figure><p>删除外键：</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> 表名 <span class="keyword">DROP</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> 外键名;</span><br></pre></td></tr></table></figure><p>删除/更新行为</p><table><thead><tr><th>行为</th><th>说明</th></tr></thead><tbody><tr><td>NO ACTION</td><td>当在父表中删除/更新对应记录时，首先检查该记录是否有对应外键，如果有则不允许删除/更新（与RESTRICT一致）</td></tr><tr><td>RESTRICT</td><td>当在父表中删除/更新对应记录时，首先检查该记录是否有对应外键，如果有则不允许删除/更新（与NO ACTION一致）</td></tr><tr><td>CASCADE</td><td>当在父表中删除/更新对应记录时，首先检查该记录是否有对应外键，如果有则也删除/更新外键在子表中的记录</td></tr><tr><td>SET NULL</td><td>当在父表中删除/更新对应记录时，首先检查该记录是否有对应外键，如果有则设置子表中该外键值为null（要求该外键允许为null）</td></tr><tr><td>SET DEFAULT</td><td>父表有变更时，子表将外键设为一个默认值（Innodb不支持）</td></tr></tbody></table><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">更改删除/更新行为：</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> 表名 <span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> 外键名称 <span class="keyword">FOREIGN KEY</span> (外键字段) <span class="keyword">REFERENCES</span> 主表名(主表字段名) <span class="keyword">ON</span> <span class="keyword">UPDATE</span> 行为 <span class="keyword">ON</span> <span class="keyword">DELETE</span> 行为;</span><br></pre></td></tr></table></figure><h2 id="5-多表查询">5.多表查询</h2><h3 id="1-多表关系">1.多表关系</h3><ul><li>一对一</li><li>一对多（多对一）</li><li>多对多</li></ul><h4 id="一对多">一对多</h4><p>案例：部门与员工<br>关系：一个部门对应多个员工，一个员工对应一个部门<br>实现：在多的一方建立外键，指向一的一方的主键</p><h4 id="多对多">多对多</h4><p>案例：学生与课程<br>关系：一个学生可以选多门课程，一门课程也可以供多个学生选修<br>实现：建立第三张中间表，中间表至少包含两个外键，分别关联两方主键</p><h4 id="一对一">一对一</h4><p>案例：用户与用户详情<br>关系：一对一关系，多用于单表拆分，将一张表的基础字段放在一张表中，其他详情字段放在另一张表中，以提升操作效率<br>实现：在任意一方加入外键，关联另外一方的主键，并且设置外键为唯一的（UNIQUE）</p><h3 id="2-查询">2.查询</h3><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">合并查询（笛卡尔积，会展示所有组合结果）：</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee, dept;</span><br></pre></td></tr></table></figure><blockquote><p>笛卡尔积：两个集合A集合和B集合的所有组合情况（在多表查询时，需要消除无效的笛卡尔积）</p></blockquote><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">消除无效笛卡尔积：</span><br><span class="line">select * <span class="keyword">from</span> employee, dept <span class="keyword">where</span> employee.dept = dept.<span class="built_in">id</span>;</span><br></pre></td></tr></table></figure><h3 id="3-内连接查询">3.内连接查询</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1445.png" alt="img"></p><p>内连接查询的是两张表交集的部分</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">隐式内连接：</span><br><span class="line"><span class="keyword">SELECT</span> 字段列表 <span class="keyword">FROM</span> 表<span class="number">1</span>, 表<span class="number">2</span> <span class="keyword">WHERE</span> 条件 ...;</span><br><span class="line">显式内连接：</span><br><span class="line"><span class="keyword">SELECT</span> 字段列表 <span class="keyword">FROM</span> 表<span class="number">1</span> [ <span class="keyword">INNER</span> ] <span class="keyword">JOIN</span> 表<span class="number">2</span> <span class="keyword">ON</span> 连接条件 ...;</span><br></pre></td></tr></table></figure><p>显式性能比隐式高</p><p>例子：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询员工姓名，及关联的部门的名称</span></span><br><span class="line"><span class="comment">-- 隐式</span></span><br><span class="line"><span class="keyword">select</span> e.name, d.name <span class="keyword">from</span> employee <span class="keyword">as</span> e, dept <span class="keyword">as</span> d <span class="keyword">where</span> e.dept = d.id;</span><br><span class="line"><span class="comment">-- 显式</span></span><br><span class="line"><span class="keyword">select</span> e.name, d.name <span class="keyword">from</span> employee <span class="keyword">as</span> e <span class="keyword">inner</span> <span class="keyword">join</span> dept <span class="keyword">as</span> d <span class="keyword">on</span> e.dept = d.id;</span><br></pre></td></tr></table></figure><h3 id="4-外连接查询">4.外连接查询</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1446.png" alt="img"></p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">左外连接：</span><br><span class="line">查询左表所有数据，以及两张表交集部分数据</span><br><span class="line"><span class="keyword">SELECT</span> 字段列表 <span class="keyword">FROM</span> 表<span class="number">1</span> <span class="keyword">LEFT</span> [ <span class="keyword">OUTER</span> ] <span class="keyword">JOIN</span> 表<span class="number">2</span> <span class="keyword">ON</span> 条件 ...;</span><br><span class="line">相当于查询表1的所有数据，包含表1和表2交集部分数据</span><br><span class="line">右外连接：</span><br><span class="line">查询右表所有数据，以及两张表交集部分数据</span><br><span class="line"><span class="keyword">SELECT</span> 字段列表 <span class="keyword">FROM</span> 表<span class="number">1</span> <span class="keyword">RIGHT</span> [ <span class="keyword">OUTER</span> ] <span class="keyword">JOIN</span> 表<span class="number">2</span> <span class="keyword">ON</span> 条件 ...;</span><br></pre></td></tr></table></figure><p>例子：</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-- 左</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">e</span>.*, d.name <span class="keyword">from</span> employee <span class="keyword">as</span> <span class="built_in">e</span> <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> dept <span class="keyword">as</span> d <span class="keyword">on</span> <span class="built_in">e</span>.dept = d.id;</span><br><span class="line"><span class="keyword">select</span> d.name, <span class="built_in">e</span>.* <span class="keyword">from</span> dept d <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> emp <span class="built_in">e</span> <span class="keyword">on</span> <span class="built_in">e</span>.dept = d.id;  -- 这条语句与下面的语句效果一样</span><br><span class="line">-- 右</span><br><span class="line"><span class="keyword">select</span> d.name, <span class="built_in">e</span>.* <span class="keyword">from</span> employee <span class="keyword">as</span> <span class="built_in">e</span> <span class="keyword">right</span> <span class="keyword">outer</span> <span class="keyword">join</span> dept <span class="keyword">as</span> d <span class="keyword">on</span> <span class="built_in">e</span>.dept = d.id;</span><br></pre></td></tr></table></figure><p>左连接可以查询到没有dept的employee，右连接可以查询到没有employee的dept</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1447.png" alt="img"></p><h3 id="5-自连接查询">5.自连接查询</h3><p>当前表与自身的连接查询，自连接必须使用表别名</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">语法：</span><br><span class="line"><span class="selector-tag">SELECT</span> 字段列表 <span class="selector-tag">FROM</span> 表<span class="selector-tag">A</span> 别名<span class="selector-tag">A</span> JOIN 表<span class="selector-tag">A</span> 别名<span class="selector-tag">B</span> ON 条件 ...;</span><br></pre></td></tr></table></figure><p>自连接查询，可以是内连接查询，也可以是外连接查询</p><p>例子：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询员工及其所属领导的名字</span></span><br><span class="line"><span class="keyword">select</span> a.name, b.name <span class="keyword">from</span> employee a, employee b <span class="keyword">where</span> a.manager = b.id;</span><br><span class="line"><span class="comment">-- 没有领导的也查询出来</span></span><br><span class="line"><span class="keyword">select</span> a.name, b.name <span class="keyword">from</span> employee a <span class="keyword">left join</span> employee b <span class="keyword">on</span> a.manager = b.id;</span><br></pre></td></tr></table></figure><p>注意事项:</p><ul><li>在自连接查询中，必须要为表起别名，要不然我们不清楚所指定的条件、返回的字段，到底是哪一张表的字段。</li></ul><h3 id="6-联合查询-union-union-all">6.联合查询 union, union all</h3><p>把多次查询的结果合并，形成一个新的查询集</p><p>语法：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">SELECT</span> 字段列表 <span class="selector-tag">FROM</span> 表<span class="selector-tag">A</span> ...</span><br><span class="line">UNION <span class="selector-attr">[ALL]</span></span><br><span class="line"><span class="selector-tag">SELECT</span> 字段列表 <span class="selector-tag">FROM</span> 表<span class="selector-tag">B</span> ...</span><br></pre></td></tr></table></figure><p>注意事项</p><ul><li>UNION ALL 会有重复结果，UNION 不会</li><li>联合查询比使用or效率高，不会使索引失效</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1448.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1449.png" alt="img"></p><h3 id="7-子查询">7.子查询</h3><p>SQL语句中嵌套SELECT语句，称谓嵌套查询，又称子查询。<br><code>SELECT * FROM t1 WHERE column1 = ( SELECT column1 FROM t2);</code><br><strong>子查询外部的语句可以是 INSERT / UPDATE / DELETE / SELECT 的任何一个</strong></p><p>根据子查询结果可以分为：</p><ul><li>标量子查询（子查询结果为单个值）</li><li>列子查询（子查询结果为一列）</li><li>行子查询（子查询结果为一行）</li><li>表子查询（子查询结果为多行多列）</li></ul><p>根据子查询位置可分为：</p><ul><li>WHERE 之后</li><li>FROM 之后</li><li>SELECT 之后</li></ul><h4 id="标量子查询">标量子查询</h4><p>子查询返回的结果是单个值（数字、字符串、日期等）。<br>常用操作符：- &lt; &gt; &gt; &gt;= &lt; &lt;=</p><p>例子：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询销售部所有员工</span></span><br><span class="line"><span class="keyword">select</span> id <span class="keyword">from</span> dept <span class="keyword">where</span> <span class="type">name</span> = <span class="string">&#x27;销售部&#x27;</span>;</span><br><span class="line"><span class="comment">-- 根据销售部部门ID，查询员工信息</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> dept = <span class="number">4</span>;</span><br><span class="line"><span class="comment">-- 合并（子查询）</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> dept = (<span class="keyword">select</span> id <span class="keyword">from</span> dept <span class="keyword">where</span> <span class="type">name</span> = <span class="string">&#x27;销售部&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查询xxx入职之后的员工信息</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> entrydate &gt; (<span class="keyword">select</span> entrydate <span class="keyword">from</span> employee <span class="keyword">where</span> <span class="type">name</span> = <span class="string">&#x27;xxx&#x27;</span>);</span><br></pre></td></tr></table></figure><h4 id="列子查询">列子查询</h4><p>返回的结果是一列（可以是多行）。</p><p>常用操作符：</p><table><thead><tr><th>操作符</th><th>描述</th></tr></thead><tbody><tr><td>IN</td><td>在指定的集合范围内，多选一</td></tr><tr><td>NOT IN</td><td>不在指定的集合范围内</td></tr><tr><td>ANY</td><td>子查询返回列表中，有任意一个满足即可</td></tr><tr><td>SOME</td><td>与ANY等同，使用SOME的地方都可以使用ANY</td></tr><tr><td>ALL</td><td>子查询返回列表的所有值都必须满足</td></tr></tbody></table><p>例子：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询销售部和市场部的所有员工信息</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> dept <span class="keyword">in</span> (<span class="keyword">select</span> id <span class="keyword">from</span> dept <span class="keyword">where</span> <span class="type">name</span> = <span class="string">&#x27;销售部&#x27;</span> <span class="keyword">or</span> <span class="type">name</span> = <span class="string">&#x27;市场部&#x27;</span>);</span><br><span class="line"><span class="comment">-- 查询比财务部所有人工资都高的员工信息</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> salary &gt; <span class="keyword">all</span>(<span class="keyword">select</span> salary <span class="keyword">from</span> employee <span class="keyword">where</span> dept = (<span class="keyword">select</span> id <span class="keyword">from</span> dept <span class="keyword">where</span> <span class="type">name</span> = <span class="string">&#x27;财务部&#x27;</span>));</span><br><span class="line"><span class="comment">-- 查询比研发部任意一人工资高的员工信息</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> salary &gt; <span class="keyword">any</span> (<span class="keyword">select</span> salary <span class="keyword">from</span> employee <span class="keyword">where</span> dept = (<span class="keyword">select</span> id <span class="keyword">from</span> dept <span class="keyword">where</span> <span class="type">name</span> = <span class="string">&#x27;研发部&#x27;</span>));</span><br></pre></td></tr></table></figure><h4 id="行子查询">行子查询</h4><p>返回的结果是一行（可以是多列）。<br>常用操作符：=, &lt;, &gt;, IN, NOT IN</p><p>例子：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询与xxx的薪资及直属领导相同的员工信息</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> (salary, manager) = (<span class="number">12500</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> (salary, manager) = (<span class="keyword">select</span> salary, manager <span class="keyword">from</span> employee <span class="keyword">where</span> <span class="type">name</span> = <span class="string">&#x27;xxx&#x27;</span>);</span><br></pre></td></tr></table></figure><h4 id="表子查询">表子查询</h4><p>返回的结果是多行多列<br>常用操作符：IN</p><p>例子：</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-- 查询与xxx1，xxx2的职位和薪资相同的员工</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> (job, salary) <span class="keyword">in</span> (<span class="keyword">select</span> job, salary <span class="keyword">from</span> employee <span class="keyword">where</span> name = <span class="string">&#x27;xxx1&#x27;</span> <span class="keyword">or</span> name = <span class="string">&#x27;xxx2&#x27;</span>);</span><br><span class="line">-- 查询入职日期是2006-01-01之后的员工，及其部门信息</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">e</span>.*, d.* <span class="keyword">from</span> (<span class="keyword">select</span> * <span class="keyword">from</span> employee <span class="keyword">where</span> entrydate &gt; <span class="string">&#x27;2006-01-01&#x27;</span>) <span class="keyword">as</span> <span class="built_in">e</span> <span class="keyword">left</span> <span class="keyword">join</span> dept <span class="keyword">as</span> d <span class="keyword">on</span> <span class="built_in">e</span>.dept = d.id;</span><br></pre></td></tr></table></figure><h3 id="8-案例">8.案例</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1450-1024x952.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1451.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1452.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1453.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1454-936x1024.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1455.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1456.png" alt="img"></p><h2 id="6-事务">6.事务</h2><p>事务是一组操作的集合，事务会把所有操作作为一个整体一起向系统提交或撤销操作请求，即这些操作要么同时成功，要么同时失败。</p><p>基本操作：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1. 查询张三账户余额</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> account <span class="keyword">where</span> <span class="type">name</span> = <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"><span class="comment">-- 2. 将张三账户余额-1000</span></span><br><span class="line"><span class="keyword">update</span> account <span class="keyword">set</span> <span class="type">money</span> = <span class="type">money</span> - <span class="number">1000</span> <span class="keyword">where</span> <span class="type">name</span> = <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"><span class="comment">-- 此语句出错后张三钱减少但是李四钱没有增加</span></span><br><span class="line">模拟<span class="keyword">sql</span>语句错误</span><br><span class="line"><span class="comment">-- 3. 将李四账户余额+1000</span></span><br><span class="line"><span class="keyword">update</span> account <span class="keyword">set</span> <span class="type">money</span> = <span class="type">money</span> + <span class="number">1000</span> <span class="keyword">where</span> <span class="type">name</span> = <span class="string">&#x27;李四&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 查看事务提交方式</span></span><br><span class="line"><span class="keyword">SELECT</span> @@AUTOCOMMIT;</span><br><span class="line"><span class="comment">-- 设置事务提交方式，1为自动提交，0为手动提交，该设置只对当前会话有效</span></span><br><span class="line"><span class="keyword">SET</span> @@AUTOCOMMIT = <span class="number">0</span>;</span><br><span class="line"><span class="comment">-- 提交事务</span></span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="comment">-- 回滚事务</span></span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 设置手动提交后上面代码改为：</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> account <span class="keyword">where</span> <span class="type">name</span> = <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"><span class="keyword">update</span> account <span class="keyword">set</span> <span class="type">money</span> = <span class="type">money</span> - <span class="number">1000</span> <span class="keyword">where</span> <span class="type">name</span> = <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"><span class="keyword">update</span> account <span class="keyword">set</span> <span class="type">money</span> = <span class="type">money</span> + <span class="number">1000</span> <span class="keyword">where</span> <span class="type">name</span> = <span class="string">&#x27;李四&#x27;</span>;</span><br><span class="line"><span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure><p>操作方式二：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">开启事务：</span><br><span class="line"><span class="keyword">START</span> <span class="keyword">TRANSACTION</span> 或 <span class="keyword">BEGIN</span> <span class="keyword">TRANSACTION</span>;</span><br><span class="line">提交事务：</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line">回滚事务：</span><br><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line"><span class="keyword">start</span> <span class="keyword">transaction</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> account <span class="keyword">where</span> <span class="type">name</span> = <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"><span class="keyword">update</span> account <span class="keyword">set</span> <span class="type">money</span> = <span class="type">money</span> - <span class="number">1000</span> <span class="keyword">where</span> <span class="type">name</span> = <span class="string">&#x27;张三&#x27;</span>;</span><br><span class="line"><span class="keyword">update</span> account <span class="keyword">set</span> <span class="type">money</span> = <span class="type">money</span> + <span class="number">1000</span> <span class="keyword">where</span> <span class="type">name</span> = <span class="string">&#x27;李四&#x27;</span>;</span><br><span class="line"><span class="keyword">commit</span>;</span><br></pre></td></tr></table></figure><h3 id="四大特性ACID">四大特性ACID</h3><ul><li>原子性(Atomicity)：事务是不可分割的最小操作单元，要么全部成功，要么全部失败</li><li>一致性(Consistency)：事务完成时，必须使所有数据都保持一致状态</li><li>隔离性(Isolation)：数据库系统提供的隔离机制，保证事务在不受外部并发操作影响的独立环境下运行</li><li>持久性(Durability)：事务一旦提交或回滚，它对数据库中的数据的改变就是永久的</li></ul><h3 id="并发事务">并发事务</h3><table><thead><tr><th>问题</th><th>描述</th></tr></thead><tbody><tr><td>脏读</td><td>一个事务读到另一个事务还没提交的数据</td></tr><tr><td>不可重复读</td><td>一个事务先后读取同一条记录，但两次读取的数据不同</td></tr><tr><td>幻读</td><td>一个事务按照条件查询数据时，没有对应的数据行，但是再插入数据时，又发现这行数据已经存在</td></tr></tbody></table><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1457.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1458.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/06/image-1459.png" alt="img"></p><p>并发事务隔离级别：</p><table><thead><tr><th>隔离级别</th><th>脏读</th><th>不可重复读</th><th>幻读</th></tr></thead><tbody><tr><td>Read uncommitted</td><td>√</td><td>√</td><td>√</td></tr><tr><td>Read committed</td><td>×</td><td>√</td><td>√</td></tr><tr><td>Repeatable Read(默认)</td><td>×</td><td>×</td><td>√</td></tr><tr><td>Serializable</td><td>×</td><td>×</td><td>×</td></tr></tbody></table><ul><li>√表示在当前隔离级别下该问题会出现</li><li>Serializable 性能最低；Read uncommitted 性能最高，数据安全性最差</li></ul><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">查看事务隔离级别：</span><br><span class="line"><span class="keyword">SELECT</span> @@TRANSACTION_ISOLATION;</span><br><span class="line">设置事务隔离级别：</span><br><span class="line"><span class="keyword">SET</span> [ <span class="keyword">SESSION</span> | <span class="keyword">GLOBAL</span> ] <span class="keyword">TRANSACTION</span> <span class="keyword">ISOLATION</span> <span class="keyword">LEVEL</span> &#123;<span class="keyword">READ</span> <span class="keyword">UNCOMMITTED</span> | <span class="keyword">READ</span> <span class="keyword">COMMITTED</span> | <span class="keyword">REPEATABLE</span> <span class="keyword">READ</span> | <span class="keyword">SERIALIZABLE</span> &#125;;</span><br><span class="line"><span class="keyword">SESSION</span> 是会话级别，表示只针对当前会话有效，<span class="keyword">GLOBAL</span> 表示对所有会话有效</span><br></pre></td></tr></table></figure><h2 id="基础篇完结">基础篇完结</h2>]]></content>
      
      
      <categories>
          
          <category> mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>前端web复习</title>
      <link href="/posts/4.html"/>
      <url>/posts/4.html</url>
      
        <content type="html"><![CDATA[<p>备考蓝桥杯时写的复习文档（目前有html+css+JavaScript+Ajax）<br>共263页</p><p><a href="https://www.legendkiller.xyz/wp-content/uploads/2025/05/web%E5%A4%8D%E4%B9%A0.pdf">https://www.legendkiller.xyz/wp-content/uploads/2025/05/web复习.pdf</a></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
          <category> 前端 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>六级生词</title>
      <link href="/posts/3.html"/>
      <url>/posts/3.html</url>
      
        <content type="html"><![CDATA[<p>radiate 散发</p><p>herd 兽群</p><p>immerse 沉浸于</p><p>consent 同意</p><p>manipulate 暗中操作</p><p>relentless 不停的，持续的</p><p>fluctuate 波动</p><p>exotic 异国风情的，外来的</p><p>census 官方统计</p><p>simultaneous 同步的，同时存在</p><p>hinge 铰链</p><p>inevitable 不可避免的</p><p>impair 削弱</p><p>saturate 浸透，使饱和</p><p>crawl 爬行</p><p>retail 零售</p><p>insurance 保险</p><p>device 想出</p><p>dynamic 动态的，充满活力的</p><p>fiscal 财政的</p><p>patrol 巡逻</p><p>scrape 刮掉</p><p>pasture 牧场</p><p>metropolitan 大城市的</p><p>explicit 清楚的</p><p>institution 机构，习俗</p><p>crack 破裂</p><p>incorporate 包含，并入</p><p>conserve 节约</p><p>lever 操纵杆</p><p>utter 完全的</p><p>preliminary 初步的</p><p>harsh 严厉的</p><p>illuminate 照亮</p><p>ascend 上升</p><p>decay 腐烂</p><p>bizarre 奇异的，古怪的</p><p>sensitive 体贴的</p><p>diagnose 诊断</p><p>authentic 真品的</p><p>substantial 大量的</p><p>destined 命中注定的</p><p>contrive 设法做到</p><p>feeble虚弱无力的</p><p>cater 满足，迎合</p><p>catastrophe 重大灾难</p><p>correlate 相互关联</p><p>torture 拷打</p><p>perish 死亡</p><p>fragile 易碎的</p><p>peculiar 古怪的，奇怪的</p><p>cruise 乘船游览</p><p>parliament 议会</p><p>perpetual 长久的</p><p>reckless 鲁莽的</p><p>calorie 卡路里</p><p>intrigue 激起…兴趣</p><p>assemble 集合</p><p>estimate 估计</p><p>impulse 冲动</p><p>eligible 有资格的</p><p>deliver发表</p><p>avert防止</p><p>glitter 闪亮</p><p>consensus 一致看法</p><p>versus 与…相比</p><p>fabricate 捏造</p><p>tumble 跌倒</p><p>lure 引诱</p><p>spectrum 光谱，系列</p><p>aviation 航空</p><p>extinct 已灭绝的</p><p>tremendous 巨大的</p><p>priest 牧师</p><p>unveil 公布</p><p>renowned 有名的</p><p>signify 表示</p><p>designate 指定</p><p>insulate 使隔热，使隔音</p><p>inferior 较差的</p><p>proclaim 宣布，声明</p><p>vigorous 精力旺盛的</p><p>candidate 候选人</p><p>greed 贪婪</p><p>imperial 帝国的</p><p>inhibit 抑制</p><p>revolve 旋转</p><p>temperament 气质</p><p>corporate 公司的</p><p>substitute 代替者</p><p>compliment 称赞</p><p>contradict 反驳</p><p>fragile 易碎的</p><p>scare 缺乏的</p><p>ultimate 最终的</p><p>escalate 扩大</p><p>adolescent 青少年</p><p>mediate 调停</p><p>stroke 一击</p><p>collaboration 合作</p><p>monetary 货币的</p><p>clinic 诊所</p><p>suicide 自杀</p><p>interpret 解释，说明</p><p>conspicuous 易见的</p><p>evacuate 撤离</p><p>evoke 引起</p><p>profitable 盈利的</p><p>counsel 忠告，建议</p><p>aggressive 好斗的</p><p>pitch 球场</p><p>fatigue 疲惫的</p><p>legitimate 合法的</p><p>tropical 热带的</p><p>perceive 看待</p><p>prototype 原型</p><p>derail 脱轨</p><p>deficit 亏损</p><p>contract 合同</p><p>institute n.机构 v. 建立</p><p>catastrophe 重大灾难</p><p>recreation 娱乐</p><p>veteran 有经验的人，老手</p><p>eject 驱逐</p><p>plight 困境</p><p>ascribe 将…归因于</p><p>poll 民意调查</p><p>indigenous 当地的</p><p>advisable 明智的</p><p>chronic 慢性的</p><p>external 外部的</p><p>momentum 势头</p><p>gloomy 昏暗的</p><p>ingenious 精巧的</p><p>stagger 蹒跚</p><p>arrogant 傲慢的</p><p>exclude 将……排斥在外</p><p>retrieve 取回</p><p>workship 崇拜</p><p>biography 人物传记</p><p>ambiguous 模棱两可的</p><p>dispatch 派遣</p><p>concede 承认……属实</p><p>neutral 中立的</p><p>strive 努力</p><p>speculate 猜测</p><p>inventory 存货</p><p>coordinate 使……协调</p><p>dazzle 使目眩</p><p>transient 短暂的</p><p>ferry 渡船</p><p>lawsuit 诉讼</p><p>depict 描绘</p><p>fascinate 使着迷</p><p>moan 呻吟</p><p>dimension 尺寸</p><p>sway 摇摆</p><p>academic 学术的</p><p>applause 鼓掌</p><p>dictate 口述，命令</p><p>quote 引用</p><p>circulation 血液循环</p><p>ration 定量供应</p><p>odd 奇怪的</p><p>indicate 声明，暗示</p><p>eliminate 消除</p><p>municipal 城市的</p><p>migrate 迁移</p><p>rigor 严谨</p><p>merit 优秀品质</p><p>warrant 授权令，使合理</p><p>scenario 设想</p><p>exempt 被免除</p><p>coalition 联合体，联盟</p><p>expire 到期</p><p>coincide 同时发生</p><p>propel 推动</p><p>execute 执行</p><p>rage 暴怒</p><p>refine 提炼</p><p>rash 轻率的</p><p>cater 提供饮食，迎合</p><p>induce 引诱</p><p>permeate 渗透</p><p>spontaneous 自发的</p><p>robust 强健的</p><p>blend 融合</p><p>colonial 殖民地的</p><p>pedestrian 行人</p><p>antibiotic 抗生素的</p><p>simulate 假装</p><p>flee 逃离</p><p>hurricane 飓风</p><p>recipient 接受者</p><p>controversy 争论</p><p>confer 授予</p><p>refer 涉及</p><p>infer 推断</p><p>shuttle 航天飞机</p><p>intrinsic 本质的</p><p>sentiment 情绪</p><p>inquire询问</p><p>require需要</p><p>acquire获得</p><p>enquire询问</p><p>diligent 勤奋的</p><p>segregate 隔离</p><p>shatter 破碎</p><p>epidemic 流行病</p><p>enterprise 企业</p><p>viable 可行的</p><p>precise 精确的</p><p>manifest 显示，表明</p><p>esteem 尊重</p><p>premium 保险费</p><p>spectacle 眼睛，奇特的现象</p><p>prejudice 偏见</p><p>setback 挫折</p><p>buck 美元，抵制</p><p>drastic 严厉的</p><p>offspring 子女，后代</p><p>acquaint 使熟悉</p><p>demography 人口学的</p><p>nonetheless 尽管如此</p><p>scrutiny 彻底审查</p><p>disclose 透露</p><p>magnitude 巨大</p><p>retort 反驳</p><p>session 一场</p><p>therapy 疗法</p><p>predecessor 前任</p><p>formula 公式</p><p>ward 病房</p><p>expel 开除</p><p>gadget 小器具</p><p>pension 养老金</p><p>prosper 兴旺</p><p>fraud 诈骗</p><p>supervisor 监督者</p><p>toll 伤亡人数</p><p>descend 下来，下降</p><p>enormous 巨大的</p><p>furnish 布置</p><p>incentive 激励</p><p>refute 反驳</p><p>negotiate谈判</p><p>aggravate 加重</p><p>terminate 结束，终止</p><p>enlighten 启发</p><p>inertia 惯性</p><p>skeptical 怀疑的</p><p>chunk 厚块</p><p>brew 啤酒，酝酿</p><p>duplicate 复制</p><p>assess 评估</p><p>sake目的</p><p>narrative 叙事</p><p>purchase 购买</p><p>magnify放大</p><p>severe 严重的</p><p>installment 一期</p><p>assert 断言</p><p>boom 繁荣</p><p>hectic 忙碌的</p><p>dismay 使担心，使失望</p><p>democratic 民主的</p><p>justify 证明</p><p>conflict 冲突</p><p>dilemma 窘境，困境</p><p>peculiar 古怪的</p><p>tenant 房客</p><p>ascertain 弄清</p><p>heir继承人</p><p>chamber 房间，议院</p><p>detain 拘留</p><p>greedy 贪婪的</p><p>resort 求助</p><p>migrant 移民者</p><p>weird 古怪的</p><p>crucial 至关重要的</p><p>moreover 而且</p><p>agony 极度痛苦的</p><p>demonstrate 表明，证明</p><p>graphic 绘画的</p><p>vaccine 疫苗</p><p>cruise 乘船浏览</p><p>rational 合理的</p><p>domestic 国内的</p><p>accurate 准确的</p><p>ethnic 种族的</p><p>conducive 有助于的</p><p>remedy 解决方法</p><p>collide 碰撞</p><p>cripple 瘸子</p><p>livestock 牲畜</p><p>disgust 厌恶</p><p>envisage 设想</p><p>inherent 内在的</p><p>solemn 严肃的</p><p>concise 简洁的</p><p>condemn 谴责</p><p>augment增大</p><p>obedient 服从的</p><p>lane 小路</p><p>maneuver 策略</p><p>portray描述</p><p>surgeon 外科医生</p><p>forge 建立</p><p>reconcile 使和谐一致</p><p>liberal 自由的</p><p>accommodation 住宿</p><p>implement 履行</p><p>internal 国内的</p><p>navigate导航</p><p>mortgage 抵押</p><p>accessory 配件</p><p>executive 经理</p><p>exile 流行</p><p>dividend 红利</p><p>regulation 规章</p><p>correlate 相互关联</p><p>instruct 指示</p><p>kit 成套工具</p><p>arrogance 傲慢</p><p>unprecedented 史无前例的</p><p>swell 肿胀</p><p>amend 修订</p><p>extract 提取</p><p>intimate 亲密的</p><p>devastate 彻底破坏</p><p>withdraw 撤回</p><p>graze 吃青草</p><p>grope 摸索，寻找</p><p>distracted 注意力分散的</p><p>obscure 难以理解的，掩盖</p><p>subordinate 下级，下属</p><p>contaminate 弄脏，污染</p><p>retreat 撤退</p><p>cherish 珍爱</p><p>conscience 良心</p><p>erupt 火山爆发</p><p>subtle 细微的</p><p>unleash 释放</p><p>endorse 公开支持</p><p>flaw 瑕疵</p><p>publicity 关注</p><p>endurance 耐力</p><p>fabric 织物</p><p>discriminate 歧视</p><p>peer 同龄人</p><p>subsidy 补贴</p><p>prime 首要的</p><p>compatible 兼容的</p><p>facet 部分</p><p>bleak 没有希望的</p><p>scatter 散开，播撒</p><p>revive 苏醒</p><p>irritate 使烦躁</p><p>maturity 成熟</p><p>plausible 貌似合理的</p><p>trivial 琐碎的</p><p>circuit 电路</p><p>galaxy 星系</p><p>deplete 大量消耗</p><p>preception 理解</p><p>loyalty 忠诚</p><p>violate 违反</p><p>adhere 黏附</p><p>paradox 矛盾的人，悖论</p><p>presume 推测</p><p>quit 辞去</p><p>irrational 不合理的</p><p>notion 观念</p><p>guard 卫兵，看守</p><p>baffle 使…困惑</p><p>dub 将…戏称为</p><p>institution 机构</p><p>superior 更好的，上级</p><p>contest 比赛</p><p>amplify 放大</p><p>deduce 推断</p><p>dignity 尊严，自尊</p><p>monopoly 垄断</p><p>cognitive 认识的</p><p>episode 一段经历</p><p>exclusive 独占的</p><p>jerk 猛拽</p><p>commute 上下班往返</p><p>conceive 想象</p><p>undermine 逐渐削弱</p><p>comply 服从</p><p>sophisticated 精密的，见多识广的，老练的</p><p>malicious 恶毒的</p><p>guardian 监护人</p><p>multitude 众多</p><p>nurture 培养</p><p>proposition 提议</p><p>diesel 柴油</p><p>articulate 清楚地表达</p><p>precedent 先例</p><p>infinite 无限的</p><p>consolidate 加强</p><p>boost 使增长</p><p>relay 传递</p><p>downside 缺点</p><p>distinct 截然不同的</p><p>allege 断言</p><p>allocate 分配</p><p>ponder 沉思</p><p>sanctuary 禁猎区</p><p>vicinity 周围地区</p><p>initial 开始的，最初的</p><p>contempt 鄙视</p><p>overwhelm 击败</p><p>territory 领土</p><p>trillion 一万亿</p><p>outdated 过时的</p><p>real estate 房地产</p><p>specify 具体指明</p><p>delicate 微妙的</p><p>blunt 钝的</p><p>deprive 剥夺</p><p>declaration 宣布</p><p>barrel 桶</p><p>equation 等式</p><p>oppress 压迫</p><p>flourish 繁荣</p><p>handicap 生理缺陷</p><p>extravagant 奢侈的</p><p>erase 消除</p><p>brisk 轻快的</p><p>negligible 微不足道的</p><p>addict 瘾君子</p><p>continent 洲，大陆</p><p>patent 专利权</p><p>recession 经济衰退</p><p>rival 竞争者</p><p>detach 摆脱</p><p>integral 必不可少的</p><p>endow 捐款</p><p>immune 免疫的</p><p>wipe out 彻底消灭</p><p>implicit 含蓄的</p><p>render 使变得</p><p>prevail 盛行</p><p>slump 暴跌</p><p>disrupt 使中断</p><p>deteriorate 恶化</p><p>stake 股份</p><p>consecutive 连续的</p><p>turbulent 动荡的</p><p>anticipate 预料</p><p>via经过</p><p>startle 使…吓一跳</p><p>quota 限额</p><p>literal 字面上的</p><p>penalty 罚金</p><p>eccentric 古怪的</p><p>prospective 潜在的</p><p>plunge 暴跌</p><p>neglect 疏忽</p><p>stimulus 刺激物</p><p>intricate 错综复杂的</p><p>occasional 偶尔的</p><p>hierarchy 等级制度</p><p>scholarly 学术的</p><p>protein 蛋白质</p><p>evaporate 蒸发</p><p>outset 开始</p><p>tuition 教授</p><p>intimidate 恐吓</p><p>pharmacy 病房</p><p>optic 眼的，视力的</p><p>memorial 纪念碑</p><p>intuition 直觉</p><p>prestige 威信</p><p>trait 特征</p><p>mourn 哀悼</p><p>enroll 使加入，招收</p><p>bureau 局，司，处，办事处</p><p>milestone 里程碑</p><p>tangle 缠结在一起</p><p>cast 扔</p><p>involved 卷入的</p><p>obsess 使痴迷</p><p>stun 使震惊</p><p>toss 扔</p><p>justification 正当理由</p><p>integrity 正直</p><p>dedicate 献身</p><p>parliament 议会</p><p>beam 光束</p><p>assure 确保</p><p>navigation 导航</p><p>endeavor 努力</p><p>scope 范围</p><p>multiple 多个的</p><p>prominent 杰出的</p><p>luxury 奢侈</p><p>impractical 不切实际的</p><p>insight 洞悉，洞察力</p><p>deposit 存款</p><p>emulate 效仿</p><p>subsidiary 辅助的，次要的</p><p>drown 溺死</p><p>rein 控制</p><p>jeopardize 使处于危险境地，危及</p><p>proof 证据</p><p>formulate 规划</p><p>thermal 热的，热量的</p><p>curriculum 课程</p><p>prevalent 流行的</p><p>antique 古董</p><p>contemplate 打算，考虑</p><p>capture 抓住</p><p>elevate 提拔</p><p>debris 残骸</p><p>paradise 天堂</p><p>slack 懈怠的，松弛的</p><p>hazard 危险</p><p>senator 参议员</p><p>exert 施加</p><p>haunt 萦绕，长期困扰</p><p>mutual 相互的</p><p>ornament 装饰品</p><p>confront 直面，正视</p><p>slight 轻微的</p><p>incur 招致</p><p>sculpture 雕像</p><p>bare 赤裸的，荒芜的</p><p>irrigate 灌溉</p><p>vacant 空的</p><p>reproach 责备</p><p>twist 弯曲变形</p><p>routine 惯例，常规</p><p>reassure 使安心</p><p>descendant 后代，后裔</p><p>barren 贫瘠的，荒芜的</p><p>rescue 营救</p><p>grim 严肃的，令人沮丧的</p><p>negotiation 谈判</p><p>guilt 内疚</p><p>industrial 工业的</p><p>hijack 劫持，控制</p><p>overstate 夸大</p><p>porch 门廊</p><p>analogy 类比</p><p>vulnerable 脆弱的</p><p>assumption 假设</p><p>contradiction 矛盾</p><p>intend 计划打算</p><p>humane 人道的</p><p>fossil 化石</p><p>statue 雕像</p><p>alter 警觉的</p><p>transplant 移植</p><p>temptation 引诱</p><p>solitude 独处</p><p>eager 热切的</p><p>alternate 交替的</p><p>resign 辞职</p><p>curb 控制</p><p>revenge 报复</p><p>assault 攻击</p><p>liable 可能做…的</p><p>hatch 孵化</p><p>cable 电缆</p><p>pest 害虫</p><p>surge 激增</p><p>nominal 象征性的，名义上的</p><p>settlement 协议，和解</p><p>frontier 边界</p><p>concrete 确实的，具体的</p><p>summon 召唤</p><p>embark 从事，着手</p><p>occupation 职业</p><p>abrupt 突然的，意外的</p><p>reluctant 勉强的</p><p>crush 捣碎，压碎</p><p>dominant 占支配地位的</p><p>compensate 弥补，补偿</p><p>instrument 仪器，乐器</p><p>stance 态度，立场</p><p>commerce 商业，贸易</p><p>corrupt 腐败的，不道德的</p><p>redundant 多余的</p><p>jungle 热带丛林</p><p>stabilize 稳定</p><p>embed 使…嵌入</p><p>literature 文学作品</p><p>commence 开始，着手</p><p>surpass 超过</p><p>destiny 命运</p><p>comprehensive 全面的，综合性的</p><p>resume 继续，简历</p><p>synthetic 合成的，人造的</p><p>sufficient 充足的</p><p>soar 升空，猛增</p><p>bias 偏见</p><p>degrade 有辱…的人格</p><p>conference 会议</p><p>underestimate 低估</p><p>disorder 失调，紊乱</p><p>tough 艰难的</p><p>interact 互动</p><p>preserve 维护</p><p>devastating 毁灭性的</p><p>hemisphere 半球</p><p>appliance 装置，家电</p><p>autonomy 自治权</p><p>dwell 居住</p><p>stimulate 刺激，激发</p><p>intent 意图，目的</p><p>pessimistic 悲观的</p><p>superiority 优越</p><p>jury 陪审团</p><p>given 指定的</p><p>notorious 臭名昭著的</p><p>considerable 相当多的</p><p>compact 紧凑的</p><p>carton 硬纸盒</p><p>freight 货物</p><p>choke 窒息</p><p>fuss 紧张不安</p><p>entertain 使快乐，娱乐</p><p>prolong 延长</p><p>criterion 标准</p><p>tactic 策略</p><p>hypothesis 假说</p><p>consult 向…咨询，求救</p><p>imperative 紧急的</p><p>bonus 奖金</p><p>incidentally 顺便提一下，偶然地</p><p>regardless 不管，无论如何</p><p>surgery 外科手术</p><p>massive 巨大的</p><p>consistent 一贯的</p><p>collision 碰撞</p><p>resemble 看起来像</p><p>breakthrough 突破</p><p>federal 联邦制的</p><p>illustrate 说明</p><p>distinctive 独特的，有特色的</p><p>responsive 反应敏捷的</p><p>excess 过多</p><p>casualty 伤亡人员</p><p>testify 作证</p><p>specialise 专门从事</p><p>delegate 代表</p><p>solidarity 团结一致</p><p>drill 钻机，演习</p><p>transaction 交易，业务</p><p>immigrant 移民</p><p>generalize 概括，归纳</p><p>sober 冷静的</p><p>impetus 动力，促进</p><p>benign 和善的，良性的</p><p>reserve 预订，预约</p><p>triumph 成功，胜利</p><p>likelihood 可能性</p><p>contact 联系</p><p>malignant 恶意的，恶性的</p><p>liability 责任</p><p>renew 延长</p><p>authority 权威，权力</p><p>browse 浏览，吃草</p><p>mentor 导师</p><p>innocent 无罪的</p><p>repel 驱逐，赶走</p><p>distress 悲伤，忧虑</p><p>obese 病态肥胖的，臃肿的</p><p>vegetation 植被</p><p>discharge 排出，解雇</p><p>interaction 互动</p><p>ideal 理想的</p><p>suppress 镇压，压抑</p><p>illiterate 文盲</p><p>paralyze 使瘫痪</p><p>plentiful 丰富的</p><p>destined 命中注定的</p><p>discrepancy 差异</p><p>conception 构思，概念</p><p>recognition 认出，识别</p><p>affiliate 使隶属于，使紧密联系</p><p>conscientious 认真的，勤勤恳恳</p><p>manual 人力的，体力的</p><p>minister 部长，大臣</p><p>oppose 反对</p><p>distort 使变形，使扭曲</p><p>deploy 部署</p><p>intelligible 可理解的</p><p>intermittent 间歇的，断断续续的</p><p>formidable 令人敬畏的</p><p>indifferent 不感兴趣的</p><p>denial 否认</p><p>phase 阶段</p><p>substantial 大量的</p><p>pause 暂停</p><p>drought 干旱</p><p>sustainable 可持续的</p><p>intangible 无形的，难以描述地</p><p>expedition 远征，探险</p><p>indulge 沉迷，满足</p><p>quest 探索，寻求</p><p>disastrous 灾难性的</p><p>sensation 知觉，感觉能力</p><p>observe 观察</p><p>resent 怨恨，憎恶</p><p>disguise 装扮，假扮</p><p>feasible 可行的</p><p>provoke 激起</p><p>accumulate 积累</p><p>assurance 担保，保证</p><p>tackle 处理</p><p>feeble 虚弱无力的</p><p>pursuit 追求</p><p>accuse 职责</p><p>compile 汇编</p><p>cabinet 储藏柜</p><p>objection 反对</p><p>engage 从事，参加</p><p>vast 巨大的</p><p>preside 主持</p><p>suspicion 怀疑</p><p>particle 微粒，粒子</p><p>subsistence 勉强生存</p><p>racial 种族间的，种族的</p><p>persistence 毅力</p><p>blaze 闪耀</p><p>convene 召集，召开</p><p>console 安慰，控制台</p><p>transition 过渡，转变</p><p>competence 能力，才干</p><p>hostile 敌意的，反对的</p><p>erect 建造</p><p>haze 烟雾</p><p>authorize 批准，授权</p><p>alternative 可代替的</p><p>consultant 顾问</p><p>perference 偏好</p><p>pole 杆子，地级</p><p>prescribe 开药，规定</p><p>populate 居住于</p><p>drawback 缺点，不利条件</p><p>morality 道德</p><p>ritual 仪式</p><p>genetic 遗传的，基因的</p><p>ingredient 配料，成分，因素</p><p>layer 层</p><p>transcend 超出，超越</p><p>plate 盘</p><p>angle 角度</p><p>spotlight 聚光灯</p><p>eternal 永恒的</p><p>successive 连续的</p><p>separate 单独的</p><p>promising 大有希望的</p><p>sequence 一系列</p><p>priority 优先权</p><p>compel 强迫，逼迫</p><p>implication 暗示，可能的影响</p><p>prosperity 兴旺</p><p>sneak 偷偷地走，潜行</p><p>concession 让步，认输</p><p>hamper 妨碍，阻碍</p><p>initiate 开始，发起</p><p>essence 本质</p><p>contrive 设法做到，图谋</p><p>instinct 本能</p><p>identical 完全相同的</p><p>protest 抗议，反对</p><p>conformity 遵从，遵守</p><p>deliberate 故意的</p><p>luminous 发亮的，发光的</p><p>plead 恳求</p><p>outbreak 爆发</p><p>fraction 少量，一点儿</p><p>derive 起源于，来自</p><p>elastic 有弹性的</p><p>mislead 误导</p><p>engagement 订婚，参加</p><p>reliance 依赖，依靠</p><p>polar 极地的</p><p>prescription 处方</p><p>cumulative 累加的</p><p>commodity 商品</p><p>revelation 揭露</p><p>strike 罢工，打，击</p><p>reservation 预订</p><p>encounter 遭遇</p><p>dispose 丢掉</p><p>bypass 旁道</p><p>combat 战斗，搏斗</p><p>stick 棍，刺入插入</p><p>stride 大步走，步伐</p><p>glamour 魅力，吸引力</p><p>reap 获得</p><p>layman 外行，门外汉</p><p>polish 改善，润色</p><p>patch 小块，斑点</p><p>perish 死亡</p><p>plea 恳求</p><p>virgin 未开发的，原始状态的</p><p>exceptional 杰出的，非凡的</p><p>rural 乡下的，乡村的</p><p>breed 繁殖，饲养</p><p>threshold 门槛，起始点</p><p>additive 添加剂，添加物</p><p>turnover 营业额</p><p>presumably 很可能</p><p>overturn 推翻</p><p>cease 停止</p><p>elite 精英</p><p>intensive 密集的</p><p>harmonious 和睦的</p><p>circumstance 情况，情形</p><p>persist 顽强坚持，持续</p><p>tease 逗弄</p><p>elicit 引出</p><p>celebrity 名人，明星</p><p>recur 再次发生</p><p>barely 仅仅</p><p>extent 程度</p><p>disregard 不理会</p><p>integrate 合并</p><p>torture 拷打，拷问</p><p>nourish 给…提供营养</p><p>inhabitant 居民</p><p>suspend 暂停，中止</p><p>snap 啪嗒声，断裂</p><p>provocative 挑衅的，煽动的</p><p>autonomous 自治的</p><p>federation 联盟，联合会</p><p>pesticide 杀虫剂</p><p>potency 影响力</p><p>interactive 交互的</p><p>potent 有强效的，烈性的</p><p>deviate 背离，偏离</p><p>specification 规格</p><p>convention 习俗，大会</p><p>specific 明确具体的</p><p>terrify 使害怕，使恐惧</p><p>contention 看法，争论</p><p>vice 恶习，副的次的</p><p>submerge 使浸没，淹没</p><p>opponent 对手，竞争者</p><p>obesity 肥胖</p><p>defy 违抗</p><p>terrific 极好的</p><p>tragedy 不幸，悲剧</p><p>acquaintance 熟人，了解</p><p>detect 发现</p><p>glacier 冰川</p><p>probe 追问</p><p>frantic 发狂似的</p><p>practitioner 从业人员</p><p>fund 基金</p><p>cooperative 合作的</p><p>invoke 唤起，引用</p><p>compulsory 强制性的，义务的</p><p>craftsmanship 手艺</p><p>disposal 丢掉</p><p>intensity 强烈，剧烈</p><p>striking 显著的</p><p>elaborate 复杂的，详尽的</p><p>elementary 基本的</p><p>subsidize 给…发补贴，补助</p><p>disperse 扩散，散开</p><p>underlie 构成…的基础</p><p>storage 储藏</p><p>peak 顶峰</p><p>mechanical 机械的</p><p>likewise 同样地</p><p>testimony 证词</p><p>utilize 利用，使用</p><p>breakdown 故障</p><p>restraint 制止，克制</p><p>quantitative 数量的</p><p>excessive 过多的</p><p>recruit 招收，招聘</p><p>lens 镜片</p><p>strategic 战略性的</p><p>qualitative 质量的</p><p>invariably 总是，不变地</p><p>surgical 外科手术的</p><p>miniature 很小的，微型的</p><p>premises 前提</p><p>headline 重要新闻</p><p>nominate 提名</p><p>urgency 紧急</p><p>marginal 微不足道的</p><p>voyage 航行，航海</p><p>vicious 恶性的，残暴的</p><p>journalist 记者</p><p>misguide 错误地引导</p><p>monitor 监视</p><p>initiative 主动性</p><p>shrink 缩水</p><p>precaution 预防措施</p><p>currency 货币，通货</p><p>questionnaire 调查问卷</p><p>bureaucracy 官僚制度，官僚主义</p><p>crisp 脆的</p><p>expertise 专门技术</p><p>compassion 同情，怜悯</p><p>conventional 传统的</p><p>invisible 看不见的</p><p>compromise 折中，妥协，让步</p><p>heighten 加强，增加</p><p>composer 作曲家</p><p>comprise 包括</p><p>thereby 因此</p><p>exaggerate 夸大</p><p>psychological 心理的</p><p>coverage 新闻报道</p><p>orthodox 正统的</p><p>decent 像样的，得体的</p><p>doom 厄运，使…注定遭受</p><p>specialty 专业</p><p>crude 粗略的</p><p>masterpiece 杰作</p><p>ordeal 折磨，苦难的经历</p><p>intensify 加强</p><p>disposition 性情，布置</p><p>burden 负担</p><p>mechanism 机械装置，方法</p><p>syndrome 综合征</p><p>transmission 传输</p><p>underlying 深层的</p><p>extensive 广阔的</p><p>suspicious 觉得可疑的</p><p>plenty 大量</p><p>inclined 倾向于…的</p><h1 id="六级作文模版">六级作文模版</h1><h2 id="议论文">议论文</h2><p>开头 Living in an era of rapid technological development ,and continuous expansion of knowledge,(主题)have/has become increasingly important,which is significantly impacting ( 某人的生活/学校生活/个人经历 ) <strong>生活在技术快速发展、知识不断扩展的时代，sth已经变得越来越重要，这对影响了某人的生活/学校生活/个人经历</strong></p><ul><li><p>当主题是…的影响时： Therefore, it’s of great significance for sb to do sth ，The following reasons can account for this viewpoint. <strong>因此，某人做某事具有重要意义，以下原因可以解释这一观点。</strong></p></li><li><p>当主题是…的重要性时：Therefore,I deem that the (importance of AI …的重要性/要贴近主题) lies in the following aspects <strong>因此，我认为sth的重要性在于以下几个方面</strong></p></li></ul><p>论据+论点</p><ul><li><p>论点1：First and foremost,there is no doubt that （sth can enhance sb work/study efficiency,and offer tremendous convenience in our daily/school life） <strong>首先，毫无疑问（某物可以提高某人的工作/学习效率，为我们的日常/学校生活提供极大的便利）</strong></p></li><li><p>论据1：Based on the investigation of big data(Based on big data research), it can be found that，a majority of (Accomplished individuals) admitted that they’ve spent most of their time doing sth <strong>通过大数据调查可以发现，大多数（成功人士）承认，他们大部分时间都花在做某事上</strong></p></li><li><p>论点2：Moreover,it has formed a consensus that（it has become a general consensus） (by sth can acquire adequate knowledge and experience easily,it is an excellent way for sb to understand what they hope and need) <strong>而且，这已经形成了一个共识，即（通过某事可以轻松获得足够的知识和经验，这是让某人了解他们希望和需要什么的绝佳方式）</strong></p></li><li><p>论点3：Last but not least,I sincerely believe that(by sth can facilitate communication and collaboration,which helpful <strong>in broadening</strong> ours horizons) <strong>最后但同样重要的一点是，我真诚地相信（通过某事可以促进沟通和合作，有助于拓宽我们的视野）</strong></p></li></ul><p>结尾</p><p>In short, the above statement can lead us reach a conclusion <strong>简而言之，通过上述陈述我们可以得出结论</strong></p><p>sth is revolutionizing the way we live,it is predictable that if sb makes reasonable use of sth,the future of sth will be become more beautiful and hopeful <strong>某事物正在彻底改变我们每个人的生活方式，可以预见，如果某人合理地利用某事物，其未来将会变得更加美好和充满希望</strong></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 英语六级 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>落日</title>
      <link href="/posts/7.html"/>
      <url>/posts/7.html</url>
      
        <content type="html"><![CDATA[<p>碑是那么小，与其说是为了纪念，更像是为了忘却。</p><p>叶文洁走到悬崖边，她曾在这里亲手结束了两个军人的生命。她并没有像其他同行的人那样眺望云海，而是把目光集中到一个方向，在那一片云层下面，有一个叫齐家屯的小村庄……</p><p>叶文洁的心脏艰难地跳动着，像一根即将断裂的琴弦，黑雾开始在她的眼前漫涌，她用尽生命的最后能量坚持着，在一切都没入永恒的黑暗之前，她想再看一次红岸基地的日落。</p><p>在西方的天际，正在云海中下沉的夕阳仿佛被融化了，太阳的血在云海和天空中弥漫开来，映现出一大片壮丽的血红。</p><p>“这是人类的落日……”叶文洁轻轻地说。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-485-1024x657.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> 杂项 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 短文 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>实验三 汽车租赁系统的UML设计建模 （完结）</title>
      <link href="/posts/1.html"/>
      <url>/posts/1.html</url>
      
        <content type="html"><![CDATA[<p>一、实验目的及要求<br>对汽车租赁系统进行分析，利用 UML 工具进行建模。<br>二、实验环境<br>微型计算机、Rational Rose<br>三、实验内容</p><ol><li>对汽车租赁系统进行需求分析，并确定其基本模块，如基本数据维护模块、基本业务<br>模块、数据库模块、信息查询模块。</li><li>确定系统中的类，并生成类图和各个类之间的关系。</li><li>确定 UML 模型框架，并作出以下各图：<br>（1）系统的用例图<br>（2）系统的时序图<br>（3）系统的协作图<br>（4）系统的活动图<br>四、实验步骤<br>1．分析系统，写出系统的功能需求分析描述。<br>（1）基本数据维护模块应包括：<br>添加车辆信息；修改车辆信息；添加员工信息；修改员工信息等。<br>（2）基本业务模块应包括：<br>用户填写预定申请；工作人员处理预定请求；技术人员填写服务纪录；工作人员处理还<br>车请求；<br>（3）数据库模块应包括：<br>客户信息管理；车辆信息管理；租赁信息管理；员工信息管理；<br>（4）信息查询模块应包括：<br>查询客户信息；查询员工信息；查询车辆信息；查询客户租车记录等；</li><li>建立 UML 模型<br>包括用例图、类图、时序图、活动图、协作图、状态图的构建。</li></ol><h2 id="具体分析："><strong>具体分析：</strong></h2><h2 id="1-需求分析部分：">1.需求分析部分：</h2><h3 id="1-系统的功能需求分析"><strong>1.系统的功能需求分析</strong></h3><p>（1）基本数据维护模块应包括：</p><p>添加车辆信息；修改车辆信息；添加员工信息；修改员工信息等。</p><p>（2）基本业务模块应包括：用户填写预定申请；工作人员处理预定请求；技术人员填写服务纪录；工作人员处理还车请求；<br>（3）数据库模块应包括：客户信息管理；车辆信息管理；租赁信息管理；员工信息管理；</p><p>（4）信息查询模块应包括：查询客户信息；查询员工信息；查询车辆信息；查询客户租车记录等；</p><h3 id="2-基本数据维护模块"><strong>2</strong>.基本数据维护模块</h3><p>基本数据维护模块是汽车租赁系统中的基础功能模块，主要用于管理与系统运行相关的基础数据，包括车辆信息与员工信息的添加、修改等操作。该模块的良好设计有助于保持数据一致性和系统稳定性，为后续业务操作提供数据支持。</p><p>（1）添加汽车信息：汽车租聘处的车辆信息全部保存在数据库中，确保后续租赁、维护、查询等操作能准确定位目标车辆。<br>应包括以下字段：</p><ul><li>车辆编号（唯一标识）</li><li>品牌型号（如：丰田凯美瑞）</li><li>车牌号码</li><li>颜色</li><li>类型（轿车/越野车/商务车等）</li><li>日租金</li><li>当前状态（空闲/租赁中/维护中）</li></ul><p>功能需求：</p><ul><li>信息提交后，应自动存入车辆信息表中。</li><li>系统管理员登录后可通过图形界面填写车辆信息。</li><li>系统应对车辆编号、车牌号进行唯一性校验。</li></ul><p>（2）修改车辆信息：由于车辆信息可能发生变更（如状态变更、日租金调整等），系统应支持对已有车辆信息的修改。</p><p>功能需求：</p><ul><li>系统提供按车牌号或车辆编号的查询功能。</li><li>支持对车辆状态、日租金等字段的修改。</li></ul><p>（3）添加员工信息：为支持系统操作、客户服务等功能，所有员工的信息需录入系统。</p><p>应包括以下字段：</p><ul><li>员工编号（唯一标识）</li><li>姓名</li><li>岗位（如：管理员、技术人员、客服人员）</li><li>联系电话</li><li>入职日期</li></ul><p>功能需求：</p><ul><li>信息验证后保存至员工信息表中。</li><li>由管理员添加员工信息。</li><li>员工编号自动生成或手动录入，确保唯一性。</li></ul><p>（4）修改员工信息</p><p>为应对员工岗位调整、联系方式变更等情况，系统应支持员工信息的维护与更新。</p><p>功能需求：</p><ul><li>修改记录应自动存档以备追踪。</li><li>支持通过员工编号查询目标员工。</li><li>可修改姓名、联系方式、岗位等内容。</li></ul><h3 id="3-基本业务模块"><strong>3.基本业务模块</strong></h3><p>基本业务模块是汽车租赁系统中最核心的功能板块，涉及用户与系统之间的交互行为，覆盖租赁全过程的操作，包括预定、车辆服务、还车等环节。</p><p>（1）用户填写预定申请：</p><p>用户在系统中发起租车请求，填写所需租赁的车辆类型、起止时间等信息，系统将记录并等待工作人员处理。</p><blockquote><p><strong>功能需求：</strong></p><ul><li>预定信息可由用户随时查看和取消（在审核前）。</li><li>用户登录后可进入“车辆预定”界面；</li><li>填写预定表单内容：租车人信息、租赁时间段、所需车型、用途说明等；</li><li>系统自动检索对应时间段内可租车辆；</li><li>提交成功后，系统自动生成预定记录，状态为“待处理”；</li></ul></blockquote><p>（2）工作人员处理预定请求：</p><p>工作人员负责审核用户预定请求，确认车辆状态，并将状态变更为“已预定”或“拒绝”。</p><p><strong>功能需求：</strong></p><ul><li>审核通过的预定会锁定对应车辆的时间段状态。</li><li>工作人员登录后可查看所有“待处理”的预定申请；</li><li>支持按日期、用户、车辆类型等条件筛选；</li><li>可进行“通过”或“拒绝”操作，并添加处理备注；</li><li>处理完成后，系统将通知用户审核结果；</li></ul><p>（3）技术人员填写服务记录：</p><p>技术人员在车辆使用前/后进行检查，填写车辆维护与检测记录，保障车辆安全与状态信息准确。</p><p><strong>功能需求：</strong></p><ul><li>登录系统后，可查询并选择需要维护记录的车辆；</li><li>填写内容包括：检查日期、检查人、车辆状况、建议维修、是否可租等；</li><li>提交后，系统更新车辆状态（可租/需维护）；</li><li>服务记录保存至车辆服务历史中。</li></ul><p>（4）工作人员处理还车请求：</p><p>租赁期结束，用户归还车辆，工作人员需核对车辆状况，并更新车辆使用信息及租赁记录。（根据租赁时间和车辆使用状态收取租赁费，如果车辆有损坏收取一定的罚金）</p><p><strong>功能需求：</strong></p><ul><li>归还信息同步到租赁历史记录中。</li><li>系统提供“还车处理”界面；</li><li>工作人员输入车辆编号或租赁单号查询；</li><li>核对车辆归还时间、油量、车况、违章等情况；</li><li>计算最终租赁费用（按日租金×天数+其他费用）；</li><li>如若车辆无误系统自动将租赁记录归档，车辆状态更新为“空闲”；</li><li>如若车辆有损坏，收取一定的罚金，将车辆送往维修厂，车辆状态更新为“维护中”</li></ul><h3 id="4-数据库模块"><strong>4.数据库模块</strong></h3><p>数据库模块是整个汽车租赁系统的数据核心，负责系统中各类信息的存储、管理和调用。通过科学的数据结构设计与数据表管理，确保系统高效、稳定、安全运行，为业务模块提供支撑。</p><h4 id="（1）客户信息管理：">（1）客户信息管理：</h4><p>用于存储和管理客户的基本资料，是租赁流程中用户识别与信用追踪的重要依据。</p><p><strong>主要字段包括：</strong></p><ul><li>客户编号（唯一标识）</li><li>姓名</li><li>性别</li><li>身份证号/驾照号</li><li>联系方式</li><li>注册日期</li><li>租赁历史记录</li><li>备注（如违章记录、黑名单等）</li></ul><p><strong>功能需求：</strong></p><ul><li>支持添加、查询、修改客户信息；</li><li>客户信息在注册或首次租赁时录入；</li><li>系统可根据客户编号或证件号进行唯一性校验；</li><li>敏感信息应加密存储，保障数据安全。</li></ul><h4 id="（2）车辆信息管理：">（2）车辆信息管理：</h4><p>用于维护系统中所有车辆的详细资料，是支撑预定、还车、查询、服务等模块的关键数据来源。</p><p><strong>主要字段包括：</strong></p><ul><li>车辆编号</li><li>品牌型号</li><li>车牌号码</li><li>类型</li><li>当前状态（空闲/租赁中/维护中）</li><li>日租金</li></ul><p><strong>功能需求：</strong></p><ul><li>所有车辆在录入系统时自动生成记录；</li><li>状态字段根据业务流程动态更新；</li><li>支持按车型、状态、编号等条件查询；</li><li>可对车辆信息进行更新（如租金调整、状态更改）。</li></ul><h4 id="（3）租赁信息管理：">（3）租赁信息管理：</h4><p>用于记录每一次租赁交易的完整数据，包括客户、车辆、时间段、费用等，是统计、报表、追责等功能的依据。</p><p><strong>主要字段包括：</strong></p><ul><li>租赁编号（唯一标识）</li><li>客户编号</li><li>车辆编号</li><li>起租时间</li><li>归还时间</li><li>实际归还时间</li><li>总费用</li><li>租赁状态（已完成/未还车/逾期等）</li><li>违章或损坏记录（如有）</li></ul><p><strong>功能需求：</strong></p><ul><li>每次成功预定后生成租赁记录；</li><li>记录车辆的实际归还情况与费用；</li><li>可按客户、车辆、时间段等查询历史租赁记录；</li><li>重要字段不允许擅自修改，保障数据一致性。</li></ul><h4 id="（4）员工信息管理：">（4）员工信息管理：</h4><p>用于维护系统中所有工作人员的数据，分为不同岗位权限，为后台管理操作和分工协作提供依据。</p><p><strong>主要字段包括：</strong></p><ul><li>员工编号</li><li>姓名</li><li>联系电话</li><li>岗位（管理员/客服/技术人员等）</li><li>登录账号</li><li>密码（加密存储）</li><li>入职时间</li></ul><p><strong>功能需求：</strong></p><ul><li>管理员具备添加、修改员工信息权限；</li><li>系统登录需根据员工账号进行权限验证；</li><li>支持岗位权限管理，不同岗位访问系统不同模块；</li><li>可按员工编号、姓名等条件检索。</li></ul><h3 id="5-信息查询模块"><strong>5.信息查询模块</strong></h3><p>信息查询模块为用户与工作人员提供高效、便捷的数据检索服务，支持对客户、员工、车辆及租赁记录等信息的多维度查询，确保系统数据的可访问性和透明度。本模块是系统操作过程中的重要辅助功能。</p><h4 id="（1）查询客户信息：">（1）查询客户信息：</h4><p>工作人员或管理员可根据客户信息进行快速定位与核查。</p><p><strong>功能需求：</strong></p><ul><li>支持按客户编号、姓名、身份证号/驾照号等条件模糊或精确查询；</li><li>展示客户基本信息、联系方式、注册时间、累计租赁次数等；</li><li>可查看该客户所有历史租赁记录；</li><li>提供黑名单或违章记录的标注提示。</li></ul><h4 id="（2）查询员工信息：">（2）查询员工信息：</h4><p>管理员用于管理员工的身份、岗位、权限等信息。</p><p><strong>功能需求：</strong></p><ul><li>可根据员工编号、姓名、岗位进行查询；</li><li>展示员工基本资料、联系方式、所属岗位及入职日期；</li><li>提供岗位权限信息，判断员工是否具备某项操作权限；</li><li>可导出员工信息表作为管理资料。</li></ul><h4 id="（3）查询车辆信息：">（3）查询车辆信息：</h4><p>便于用户选择合适车辆及工作人员掌握车辆运营状态。</p><p><strong>功能需求：</strong></p><ul><li>支持按车辆编号、品牌型号、车牌号、车辆类型、当前状态等查询条件；</li><li>展示车辆的基本信息、当前状态、是否可租、日租金等；</li><li>提供车辆历史服务记录及维修记录查看接口；</li><li>支持状态筛选（仅查看“空闲”车辆、仅查看“维修中”车辆等）；</li><li>可将车辆查询结果导出为表格或打印。</li></ul><h4 id="（4）查询客户租车记录：">（4）查询客户租车记录：</h4><p>用于客户服务、信用评估、异常交易追踪等目的。</p><p><strong>功能需求：</strong></p><ul><li>可按客户编号、姓名进行查询；</li><li>展示所有历史租车记录，包括租赁时间段、车辆信息、费用、归还情况；</li><li>支持对租赁状态（已完成/逾期/未还）进行筛选；</li><li>记录中应包含每次租车的服务情况、是否存在违章或损坏；</li><li>可导出租赁记录明细用于对账、备份或追责。</li></ul><h2 id="2-用例图设计">2.用例图设计</h2><h3 id="1-1-参与者（Actors）">1.1 参与者（Actors）</h3><p>系统中主要的参与者有：</p><ul><li><strong>客户（Customer）</strong>：使用系统提交预定、查询租车记录等。</li><li><strong>工作人员（Staff）</strong>：负责审核预定、处理还车等。</li><li><strong>技术人员（Technician）</strong>：负责填写服务记录，更新车辆状态。</li><li><strong>管理员（Admin）</strong>：负责系统数据维护，包括添加/修改员工和车辆信息。</li></ul><h3 id="1-2-系统主要用例（Use-Cases）">1.2 系统主要用例（Use Cases）</h3><p>将前面分析过的功能模块转化为用例：</p><h4 id="（1）基本数据维护">（1）基本数据维护</h4><ul><li>添加车辆信息</li><li>修改车辆信息</li><li>添加员工信息</li><li>修改员工信息</li></ul><h4 id="（2）基本业务操作">（2）基本业务操作</h4><ul><li>填写租车预定申请</li><li>审核预定请求</li><li>填写车辆服务记录</li><li>处理还车请求</li></ul><h4 id="（3）信息查询">（3）信息查询</h4><ul><li>查询客户信息</li><li>查询员工信息</li><li>查询车辆信息</li><li>查询客户租车记录</li></ul><h3 id="1-3-参与者与用例之间的关系">1.3 参与者与用例之间的关系</h3><table><thead><tr><th>参与者</th><th>可执行的用例</th></tr></thead><tbody><tr><td>客户</td><td>填写租车预定申请、查询客户租车记录</td></tr><tr><td>普通工作人员（客服）</td><td>审核预定请求、处理还车请求、查询客户/车辆信息</td></tr><tr><td>技术人员</td><td>填写车辆服务记录</td></tr><tr><td>管理员</td><td>添加/修改车辆信息、添加/修改员工信息、查询员工信息</td></tr></tbody></table><h3 id="1-4可视化建议（在Rational-Rose中建图）：">1.4可视化建议（在Rational Rose中建图）：</h3><p>整体用一个系统边框（System）包住所有用例，命名为“汽车租赁系统”</p><p>创建4个Actor，分别命名为：</p><ul><li><code>客户</code></li><li><code>工作人员</code></li><li><code>技术人员</code></li><li><code>管理员</code></li></ul><p>创建12个用例（Use Case）：</p><p>每个功能点用椭圆表示，用线连接Actor与他们能够使用的用例</p><table><thead><tr><th>模块</th><th>用例（功能）名称</th><th>所属角色</th></tr></thead><tbody><tr><td>数据维护模块</td><td>添加车辆信息</td><td>管理员</td></tr><tr><td>数据维护模块</td><td>修改车辆信息</td><td>管理员</td></tr><tr><td>数据维护模块</td><td>添加员工信息</td><td>管理员</td></tr><tr><td>数据维护模块</td><td>修改员工信息</td><td>管理员</td></tr><tr><td>业务模块</td><td>填写租车预定申请</td><td>客户</td></tr><tr><td>业务模块</td><td>审核预定请求</td><td>工作人员</td></tr><tr><td>业务模块</td><td>填写服务记录</td><td>技术人员</td></tr><tr><td>业务模块</td><td>处理还车请求</td><td>工作人员</td></tr><tr><td>查询模块</td><td>查询客户信息</td><td>工作人员/管理员</td></tr><tr><td>查询模块</td><td>查询员工信息</td><td>管理员</td></tr><tr><td>查询模块</td><td>查询车辆信息</td><td>工作人员/管理员</td></tr><tr><td>查询模块</td><td>查询客户租车记录</td><td>客户/工作人员</td></tr></tbody></table><h3 id="总结：">总结：</h3><ul><li><strong>“参与者”是使用系统的人或角色</strong></li><li><strong>“用例”是系统提供的某项功能或服务</strong></li><li>一个参与者可以参与多个用例</li><li>一个用例也可以被多个参与者使用（例如查询车辆信息）</li></ul><h2 id="3-类图设计">3.类图设计</h2><p><strong>类图说明系统的静态结构</strong>：有哪些类（实体），它们有哪些属性（字段）、方法（功能），以及类之间的关系（关联、继承、依赖等）。</p><h3 id="系统中的核心类">系统中的核心类</h3><table><thead><tr><th>类名</th><th>上层继承/从属关系</th><th>关联对象</th><th>主要属性字段</th><th>主要方法（功能）</th></tr></thead><tbody><tr><td><strong>Person（抽象类）</strong></td><td>-</td><td>-</td><td>name、ID、address、phoneNo</td><td>getName()、setName() 等</td></tr><tr><td>├─ <strong>Customer</strong>（客户类）</td><td>Person</td><td>Rental（1对多）</td><td>编号、证件号、联系方式、租赁历史记录</td><td>提交预定申请()、查询租赁记录()</td></tr><tr><td>└── <strong>Employee（抽象类-员工）</strong></td><td>Person</td><td>无</td><td>编号、岗位、电话、账号密码</td><td>登录()、操作功能（由子类具体实现）</td></tr><tr><td>├── <em><strong>*Admin*</strong></em>（<strong>管理员</strong>）</td><td>Employee</td><td>无</td><td>是否为高级管理员</td><td>添加员工()、添加车辆()</td></tr><tr><td>├── <strong>CommonWorker</strong>（一般员工-客服）</td><td>Employee</td><td>无</td><td>处理租赁流程</td><td>处理预定()、处理还车()</td></tr><tr><td>└── <strong>SkillWorker</strong>（技术人员）</td><td>Employee</td><td>ServiceRecord（1对多）</td><td>技能项、资格证书、服务记录</td><td>填写服务记录()</td></tr><tr><td><strong>Vehicle</strong>（车辆类）</td><td>-</td><td>Rental、ServiceRecord</td><td>编号、车牌、品牌、类型、状态、租金、维修记录</td><td>更新状态()、计算租金()</td></tr><tr><td><strong>Rental</strong>（租赁类）</td><td>-</td><td>Customer、Vehicle</td><td>租赁编号、客户编号、车辆编号、起止日期、费用、状态</td><td>创建租赁记录()、计算费用()</td></tr><tr><td><strong>ServiceRecord</strong>（服务记录类）</td><td>-</td><td>Vehicle、SkillWorker</td><td>服务编号、车辆编号、技术员编号、检查时间、状况、建议维修</td><td>提交服务记录()</td></tr></tbody></table><p><strong>思路：分两个类图画，一个客户及公司员工类图，一个汽车租赁系统类图</strong></p><h2 id="4-时序图设计">4.时序图设计</h2><p>展示“对象间在某个业务过程中的交互顺序”。</p><p>时序图（Sequence Diagram）用于展示<strong>对象之间在某一用例中的交互过程</strong>，关注消息发送顺序。</p><p>基本元素包括：</p><ul><li><strong>参与对象（Actor 或类的实例）</strong>：上方水平排列</li><li><strong>生命线（Lifeline）</strong>：垂直虚线，表示对象的存活期</li><li><strong>消息（Message）</strong>：对象之间发送的请求，用箭头标示，按时间从上到下</li></ul><h3 id="（1）管理员查看工作记录时序图">（1）管理员查看工作记录时序图</h3><p>该图描述了管理员在系统中查看普通工作人员的工作记录及其任务完成率的流程。该操作用于管理监督和绩效评估。</p><p><strong>参与对象</strong>：</p><ul><li><code>管理员</code>（Admin）</li><li><code>普通工作人员</code>（CommonWorker）</li><li><code>服务记录</code>（ServiceRecord）</li></ul><p><strong>交互顺序</strong>：</p><ol><li>管理员可根据任务情况进行评估与记录。</li><li><code>Admin</code> 登录系统并进入“员工管理”功能界面；</li><li>系统展示可查询员工列表；</li><li><code>Admin</code> 选定某位 <code>CommonWorker</code>，调用其方法 <code>查看工作记录()</code>；</li><li><code>CommonWorker</code> 返回其历史 <code>ServiceRecord</code>；</li><li><code>Admin</code> 要求评估任务完成情况，调用 <code>calculate()</code> 方法计算 <code>commissionRate</code>；</li><li><code>CommonWorker</code> 返回任务完成率给 <code>Admin</code>；</li></ol><h3 id="（2）客户预订车辆时序图"><strong>（2）客户预订车辆时序图</strong></h3><p>该图描述了客户通过系统发起租车申请并由工作人员处理的全过程。</p><p><strong>参与对象</strong>：</p><ul><li><code>客户</code>（Customer）</li><li><code>普通工作人员</code>（CommonWorker）</li><li><code>车辆</code>（Vehicle）</li><li><code>租赁记录</code>（Rental）</li></ul><p><strong>交互顺序</strong>：</p><blockquote><ol><li><code>Customer</code> 填写并提交租赁申请（调用 <code>提交预定申请()</code> 方法）；</li><li><code>CommonWorker</code> 接收申请并调用 <code>处理预定()</code> ；</li><li><code>CommonWorker</code> 通过 <code>Vehicle</code> 查询所需车型是否可租（调用 <code>更新状态()</code>、查询 <code>当前状态</code> 属性）；</li><li>若车辆空闲，则创建一个新的 <code>Rental</code> 实例；</li><li><code>Rental</code> 记录客户、车辆、起止时间等信息，并由 <code>CommonWorker</code> 完成预定处理；</li><li>返回预定结果给 <code>Customer</code>。</li></ol></blockquote><h3 id="（3）客户取车时序图"><strong>（3）客户取车时序图</strong></h3><p>该图展示了客户在预定成功后前往门店取车的业务流程。涉及对租赁状态确认、付款、车辆状态更新等关键操作。</p><p><strong>参与对象</strong>：</p><ul><li><code>客户</code>（Customer）</li><li><code>普通工作人员</code>（CommonWorker）</li><li><code>车辆</code>（Vehicle）</li><li><code>租赁记录</code>（Rental）</li><li><code>服务记录</code>（ServiceRecord`）（填写工作记录）</li></ul><p><strong>交互顺序</strong>：</p><ol><li><code>Customer</code> 按约定时间到店取车；</li><li><code>CommonWorker</code> 校验客户的身份和租赁状态；</li><li>若验证成功，提示 <code>Customer</code> 进行付款；</li><li>付款完成后，<code>CommonWorker</code> 填写 <code>ServiceRecord</code>（调用 <code>填写服务记录()</code> 方法，记录取车信息）；</li><li><code>CommonWorker</code> 调用 <code>Vehicle</code> 类方法 <code>更新状态()</code>，将车辆状态更新为“租赁中”；</li><li><code>Rental</code> 对象状态设置为“进行中”，系统完成租赁激活；</li><li>系统通知客户取车完成。</li></ol><h3 id="（4）客户还车时序图"><strong>（4）客户还车时序图</strong></h3><p>该图展示了客户完成用车后归还车辆的完整流程，包括车辆检查、费用结算、服务记录填写、状态更新等操作。</p><p><strong>参与对象</strong>：</p><ul><li><code>客户</code>（Customer）</li><li><code>普通工作人员</code>（CommonWorker）</li><li><code>技术人员</code>（SkillWorker）</li><li><code>车辆</code>（Vehicle）</li><li><code>租赁记录</code>（Rental）</li><li><code>服务记录</code>（ServiceRecord`）</li></ul><p><strong>交互顺序</strong>：</p><ol><li>Customer 按约定时间归还车辆；</li><li>SkillWorker 对 Vehicle 进行检查，确认车况并调用 填写服务记录()；</li><li>若车辆存在损坏，记录在 ServiceRecord 中，并提交维修建议；</li><li>CommonWorker 根据 Rental 中的起止时间与车辆状态，计算费用（调用 计算费用() 方法）；</li><li>若有损坏或违章，额外费用一并计算；</li><li>Vehicle 状态通过 更新状态() 方法设为“空闲”或“维护中”；</li><li>Rental 状态设为“已完成”，交易结束；</li></ol><h2 id="5-协作图设计">5.协作图设计</h2><p>协作图（Collaboration Diagram）用于描述在某个用例场景中，参与对象之间为了完成任务所进行的交互行为。它重点突出对象之间的<strong>结构关系</strong>与<strong>消息传递顺序</strong>。</p><p>本系统协作图设计覆盖三个典型场景：</p><h3 id="（1）客户预订车辆协作图">（1）客户预订车辆协作图</h3><p>该图描述客户发起租车请求并由系统处理的过程，突出“客户—工作人员—车辆—租赁记录”之间的协作关系。</p><p><strong>参与对象</strong>：</p><ul><li><code>客户</code>（Customer）</li><li><code>普通工作人员</code>（CommonWorker）</li><li><code>车辆</code>（Vehicle）</li><li><code>租赁记录</code>（Rental）</li></ul><p><strong>协作过程</strong>：</p><ol><li><code>Customer</code> 发起租车请求；</li><li><code>CommonWorker</code> 接收并检查请求；</li><li>向 <code>Vehicle</code> 查询当前状态（是否可租）；</li><li>如果可租，生成 <code>Rental</code> 记录并存储租期、费用等信息；</li><li>返回处理结果给 <code>Customer</code>。</li></ol><h3 id="（2）客户取车协作图">（2）客户取车协作图</h3><p>客户在门店取车，由工作人员完成验证、记录与状态更新。</p><p><strong>参与对象</strong>：</p><ul><li><code>客户</code>（Customer）</li><li><code>普通工作人员</code>（CommonWorker）</li><li><code>车辆</code>（Vehicle）</li><li><code>服务记录</code>（ServiceRecord）</li><li><code>租赁记录</code>（Rental）</li></ul><p><strong>协作过程</strong>：</p><ol><li><code>Customer</code> 到达前台，出示身份信息；</li><li><code>CommonWorker</code> 校验信息与租赁状态；</li><li>要求付款并调用 <code>ServiceRecord</code> 填写记录；</li><li>修改 <code>Vehicle</code> 的状态为“租赁中”；</li><li>将 <code>Rental</code> 状态设为“进行中”；</li><li>通知 <code>Customer</code> 成功取车。</li></ol><h3 id="（3）客户还车协作图">（3）客户还车协作图</h3><p>客户完成使用后归还车辆，系统进行检查、结算与状态同步。</p><p><strong>参与对象</strong>：</p><ul><li><code>客户</code>（Customer）</li><li><code>普通工作人员</code>（CommonWorker）</li><li><code>技术人员</code>（SkillWorker）</li><li><code>车辆</code>（Vehicle）</li><li><code>服务记录</code>（ServiceRecord）</li><li><code>租赁记录</code>（Rental）</li></ul><p><strong>协作过程</strong>：</p><ol><li><code>Customer</code> 提交还车；</li><li><code>SkillWorker</code> 检查车辆，填写 <code>ServiceRecord</code>；</li><li><code>CommonWorker</code> 根据 <code>Rental</code> 计算费用；</li><li>如有异常（如车辆损坏），加入额外罚金；</li><li>调用 <code>Vehicle</code> 更新状态为“空闲”或“维护中”；</li><li>更新 <code>Rental</code> 为“已完成”，关闭流程；</li><li>通知 <code>Customer</code> 交易结束。</li></ol><h2 id="6-活动图设计">6. 活动图设计</h2><p>活动图（Activity Diagram）用于表示系统中某个用例或业务流程的<strong>控制流程</strong>与<strong>状态流转</strong>，强调操作的执行顺序与并发结构。以下选取三个典型业务流程进行建模。</p><h3 id="（1）客户预订车辆活动图">（1）客户预订车辆活动图</h3><p>该图描述了客户租车申请从填写表单到系统生成预定记录的全过程。</p><p><strong>流程说明</strong>：</p><ul><li>初始节点：客户登录系统；</li><li>填写租车申请表（车型、时间等）；</li><li>系统校验字段完整性；</li><li>系统检查该时间段内是否有可租车辆；<ul><li>若无车辆 → 流程结束，提示“预定失败”；</li><li>若有车辆 → 进入下一步；</li></ul></li><li>系统生成预定记录；</li><li>将预定状态设为“待审核”；</li><li>返回“预定提交成功”提示。</li></ul><h3 id="（2）客户取车活动图">（2）客户取车活动图</h3><p>展示客户前往门店领取车辆的完整操作流程。</p><p><strong>流程说明</strong>：</p><ul><li>初始节点：客户到达门店；</li><li>出示身份信息；</li><li>工作人员验证预订状态；<ul><li>若状态异常 → 结束流程，提示“验证失败”；</li><li>若验证成功 → 进入下一步；</li></ul></li><li>系统提示付款；</li><li>客户付款；</li><li>工作人员填写服务记录；</li><li>更新车辆状态为“租赁中”；</li><li>结束流程，客户完成取车。</li></ul><h3 id="（3）客户还车活动图">（3）客户还车活动图</h3><p>描述客户用车结束后归还车辆的业务流程。</p><p><strong>流程说明</strong>：</p><ul><li>初始节点：客户提交还车；</li><li>技术人员进行车辆检查；</li><li>系统记录服务检查结果；</li><li>工作人员根据租期与车况计算费用；</li><li>客户付款（含额外罚金）；</li><li>系统更新车辆状态（空闲/维护中）；</li><li>租赁记录设为“已完成”；</li><li>流程终止。</li></ul><h2 id="7-状态图设计">7. 状态图设计</h2><p>状态图（State Diagram）用于描述系统中某一对象在生命周期中所经历的<strong>状态变迁</strong>，以及引起这些状态变化的事件或条件。它对于理解对象行为及其触发逻辑尤为重要。</p><p>本系统重点绘制以下两个状态图：</p><h3 id="（1）车辆（Vehicle）状态图">（1）车辆（Vehicle）状态图</h3><p>车辆在租赁生命周期中会经历多个状态变化，状态图可清晰展示其状态切换逻辑。</p><p><strong>状态节点</strong>：</p><ul><li>空闲（Idle）</li><li>已预定（Reserved）</li><li>租赁中（Rented）</li><li>检修中（Under Maintenance）</li></ul><p><strong>触发事件</strong>：</p><ul><li>客户提交预定申请 → 状态由“空闲”变为“已预定”</li><li>客户取车 → 状态变为“租赁中”</li><li>客户还车后车辆正常 → 状态变为“空闲”</li><li>客户还车后车辆损坏 → 状态变为“检修中”</li><li>检修完毕 → 状态恢复为“空闲”</li></ul><h3 id="（2）租赁记录（Rental）状态图">（2）租赁记录（Rental）状态图</h3><p><code>Rental</code> 对象代表一次租赁交易，其状态流转反映交易的执行进度与完成情况。</p><p><strong>状态节点</strong>：</p><ul><li>待审核（Pending）</li><li>已批准（Approved）</li><li>进行中（Ongoing）</li><li>已完成（Completed）</li><li>被拒绝（Rejected）</li></ul><p><strong>触发事件</strong>：</p><ul><li>用户提交申请 → 状态设为“待审核”</li><li>工作人员审核通过 → 状态变为“已批准”</li><li>客户取车后 → 状态设为“进行中”</li><li>客户还车并结算完成 → 状态设为“已完成”</li><li>审核不通过 → 状态变为“被拒绝”</li></ul><p>以下附上实验报告</p><p><a href="https://www.legendkiller.xyz/wp-content/uploads/2025/05/%E8%AE%A1%E6%9C%AC2204-202214024112-%E7%8E%8B%E7%A3%8A-1-3.doc">计本2204 202214024112 王磊</a><a href="https://www.legendkiller.xyz/wp-content/uploads/2025/05/%E8%AE%A1%E6%9C%AC2204-202214024112-%E7%8E%8B%E7%A3%8A-1-3.doc">下载</a></p>]]></content>
      
      
      <categories>
          
          <category> 学习笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> UML建模 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis实战篇</title>
      <link href="/posts/6.html"/>
      <url>/posts/6.html</url>
      
        <content type="html"><![CDATA[<p>导读：实战篇我们要学习一些什么样的内容</p><ul><li>短信登录</li></ul><p>这一块我们会使用redis共享session来实现</p><ul><li>商户查询缓存</li></ul><p>通过本章节，我们会理解缓存击穿，缓存穿透，缓存雪崩等问题，让小伙伴的对于这些概念的理解不仅仅是停留在概念上，更是能在代码中看到对应的内容</p><ul><li>优惠卷秒杀</li></ul><p>通过本章节，我们可以学会Redis的计数器功能， 结合Lua完成高性能的redis操作，同时学会Redis分布式锁的原理，包括Redis的三种消息队列</p><ul><li>附近的商户</li></ul><p>我们利用Redis的GEOHash来完成对于地理坐标的操作</p><ul><li>UV统计</li></ul><p>主要是使用Redis来完成统计功能</p><ul><li>用户签到</li></ul><p>使用Redis的BitMap数据统计功能</p><ul><li>好友关注</li></ul><p>基于Set集合的关注、取消关注，共同关注等等功能，这一块知识咱们之前就讲过，这次我们在项目中来使用一下</p><ul><li>打人探店</li></ul><p>基于List来完成点赞列表的操作，同时基于SortedSet来完成点赞的排行榜功能</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-24-1024x590.png" alt="img"></p><h2 id="1、短信登录">1、短信登录</h2><h3 id="1-1、导入黑马点评项目">1.1、导入黑马点评项目</h3><h4 id="1-1-1-、导入SQL（Mysql版本大于5-7）">1.1.1 、导入SQL（Mysql版本大于5.7）</h4><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-25.png" alt="img"></p><h4 id="1-1-2、有关当前模型">1.1.2、有关当前模型</h4><p>手机或者app端发起请求，请求我们的nginx服务器，nginx基于七层模型走的事HTTP协议，可以实现基于Lua直接绕开tomcat访问redis，也可以作为静态资源服务器，轻松扛下上万并发， 负载均衡到下游tomcat服务器，打散流量，我们都知道一台4核8G的tomcat，在优化和处理简单业务的加持下，大不了就处理1000左右的并发， 经过nginx的负载均衡分流后，利用集群支撑起整个项目，同时nginx在部署了前端项目后，更是可以做到动静分离，进一步降低tomcat服务的压力，这些功能都得靠nginx起作用，所以nginx是整个项目中重要的一环。</p><p>在tomcat支撑起并发流量后，我们如果让tomcat直接去访问Mysql，根据经验Mysql企业级服务器只要上点并发，一般是16或32 核心cpu，32 或64G内存，像企业级mysql加上固态硬盘能够支撑的并发，大概就是4000起~7000左右，上万并发， 瞬间就会让Mysql服务器的cpu，硬盘全部打满，容易崩溃，所以我们在高并发场景下，会选择使用mysql集群，同时为了进一步降低Mysql的压力，同时增加访问的性能，我们也会加入Redis，同时使用Redis集群使得Redis对外提供更好的服务。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-26-1024x432.png" alt="img"></p><p>1.1.3、导入后端项目</p><p>注意要修改application.yaml文件里的mysql，redis地址信息</p><p>1.1.4、导入前端工程</p><p>1.1.5 运行前端项目</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">localhost</span>：<span class="number">8080</span></span><br></pre></td></tr></table></figure><h3 id="1-2-、基于Session实现登录流程">1.2 、基于Session实现登录流程</h3><p><strong>发送验证码：</strong></p><p>用户在提交手机号后，会校验手机号是否合法，如果不合法，则要求用户重新输入手机号</p><p>如果手机号合法，后台此时生成对应的验证码，同时将验证码进行保存，然后再通过短信的方式将验证码发送给用户</p><p><strong>短信验证码登录、注册：</strong></p><p>用户将验证码和手机号进行输入，后台从session中拿到当前验证码，然后和用户输入的验证码进行校验，如果不一致，则无法通过校验，如果一致，则后台根据手机号查询用户，如果用户不存在，则为用户创建账号信息，保存到数据库，无论是否存在，都会将用户信息保存到session中，方便后续获得当前登录信息</p><p><strong>校验登录状态:</strong></p><p>用户在请求时候，会从cookie中携带者JsessionId到后台，后台通过JsessionId从session中拿到用户信息，如果没有session信息，则进行拦截，如果有session信息，则将用户信息保存到threadLocal中，并且放行</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-27-1024x494.png" alt="img"></p><h3 id="1-3实现发送短信验证码">1.3实现发送短信验证码</h3><p><strong>页面流程</strong></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-29-1024x443.png" alt="img"></p><p>具体代码如下</p><ul><li>*<strong>发送验证码*</strong></li></ul><p>UserController</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送手机验证码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@PostMapping</span>(<span class="string">&quot;code&quot;</span>)</span><br><span class="line">public Result <span class="built_in">sendCode</span>(<span class="variable">@RequestParam</span>(<span class="string">&quot;phone&quot;</span>) String phone, HttpSession session) &#123;</span><br><span class="line">    <span class="comment">// TODO 发送短信验证码并保存验证码</span></span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">userService</span><span class="selector-class">.sendCode</span>(phone, session);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>IUserService</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUserService</span> <span class="keyword">extends</span> <span class="title class_">IService</span>&lt;<span class="title class_">User</span>&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送验证码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> <span class="variable">phone</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> <span class="variable">session</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="title class_">Result</span> <span class="title function_">sendCode</span>(<span class="title class_">String</span> phone, <span class="title class_">HttpSession</span> session);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">IUserServiceImpl</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送验证码</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">phone</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">session</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> <span class="title class_">Result</span> <span class="title function_">sendCode</span>(<span class="params"><span class="title class_">String</span> phone, <span class="title class_">HttpSession</span> session</span>) &#123;</span><br><span class="line"> <span class="comment">// 1.校验手机号</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="title class_">RegexUtils</span>.<span class="title function_">isPhoneInvalid</span>(phone)) &#123;</span><br><span class="line"> <span class="comment">// 2.如果不符合，返回错误信息</span></span><br><span class="line"> <span class="keyword">return</span> <span class="title class_">Result</span>.<span class="title function_">fail</span>(<span class="string">&quot;手机号格式错误！&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// 3.符合，生成验证码</span></span><br><span class="line"> <span class="title class_">String</span> code = <span class="title class_">RandomUtil</span>.<span class="title function_">randomNumbers</span>(<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 4.保存验证码到 session</span></span><br><span class="line"> session.<span class="title function_">setAttribute</span>(<span class="string">&quot;code&quot;</span>,code);</span><br><span class="line"> <span class="comment">// 5.发送验证码</span></span><br><span class="line"> log.<span class="title function_">debug</span>(<span class="string">&quot;发送短信验证码成功，验证码：&#123;&#125;&quot;</span>, code);</span><br><span class="line"> <span class="comment">// 返回ok</span></span><br><span class="line"> <span class="keyword">return</span> <span class="title class_">Result</span>.<span class="title function_">ok</span>();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><ul><li>*<strong>登录*</strong></li></ul><p>UserController</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 登录功能</span></span><br><span class="line"><span class="comment"> * @param loginForm 登录参数，包含手机号、验证码；或者手机号、密码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">@PostMapping</span>(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line">public Result <span class="built_in">login</span>(<span class="variable">@RequestBody</span> LoginFormDTO loginForm, HttpSession session)&#123;</span><br><span class="line">    <span class="comment">// 实现登录功能</span></span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">userService</span><span class="selector-class">.login</span>(loginForm, session);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>IUserService</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录功能</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> loginForm</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Result <span class="title">login</span><span class="params">(LoginFormDTO loginForm, HttpSession session)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>IUserServiceImpl</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户登录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">loginForm</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">session</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="title class_">Result</span> <span class="title function_">login</span>(<span class="params"><span class="title class_">LoginFormDTO</span> loginForm, <span class="title class_">HttpSession</span> session</span>) &#123;</span><br><span class="line">    <span class="comment">//1.校验手机号</span></span><br><span class="line">    <span class="title class_">String</span> phone = loginForm.<span class="title function_">getPhone</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">RegexUtils</span>.<span class="title function_">isPhoneInvalid</span>(phone)) &#123;</span><br><span class="line">        <span class="comment">//如果不符合，返回错误信息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Result</span>.<span class="title function_">fail</span>(<span class="string">&quot;手机号格式错误&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.校验验证码</span></span><br><span class="line">    <span class="title class_">Object</span> cacheCode = session.<span class="title function_">getAttribute</span>(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">    <span class="title class_">String</span> code = loginForm.<span class="title function_">getCode</span>();</span><br><span class="line">    <span class="keyword">if</span> (cacheCode == <span class="literal">null</span> || !cacheCode.<span class="title function_">toString</span>().<span class="title function_">equals</span>(code)) &#123;</span><br><span class="line">        <span class="comment">//3.不一致，直接返回错误信息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Result</span>.<span class="title function_">fail</span>(<span class="string">&quot;验证码错误&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4.一致，根据手机号查询用户 select * from tb_user where phone = ?</span></span><br><span class="line">    <span class="title class_">User</span> user = <span class="title function_">query</span>().<span class="title function_">eq</span>(<span class="string">&quot;phone&quot;</span>, phone).<span class="title function_">one</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.判断用户是否存在</span></span><br><span class="line">    <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//6。不存在，创建新用户并保存</span></span><br><span class="line">        user = <span class="title function_">createUserWithPhone</span>(phone);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//7.存在，保存用户到session</span></span><br><span class="line">    session.<span class="title function_">setAttribute</span>(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//8.返回登录成功的结果</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Result</span>.<span class="title function_">ok</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="title class_">User</span> <span class="title function_">createUserWithPhone</span>(<span class="params"><span class="title class_">String</span> phone</span>) &#123;</span><br><span class="line">    <span class="comment">//1.创建用户</span></span><br><span class="line">    <span class="title class_">User</span> user = <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.<span class="title function_">setPhone</span>(phone);</span><br><span class="line">    user.<span class="title function_">setNickName</span>(<span class="variable constant_">USER_NICK_NAME_PREFIX</span>+<span class="title class_">RandomUtil</span>.<span class="title function_">randomString</span>(<span class="number">10</span>));</span><br><span class="line">    <span class="comment">//2.保存用户到数据库 insert into tb_user values (null, ?, null)</span></span><br><span class="line">    <span class="title function_">save</span>(user);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-4-显示登录拦截">1.4 显示登录拦截</h3><p><strong>tomcat的运行原理</strong></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-53-1024x599.png" alt="img"></p><h4 id="1-建立连接"><strong>1. 建立连接</strong></h4><ul><li><strong>用户（客户端）</strong> 发起一个 HTTP 请求，首先会通过浏览器或其他客户端发起 <strong>TCP 连接</strong>。</li><li>这个连接由用户的 <strong>socket</strong> 建立，连接到服务器上指定的 <strong>端口号</strong>（Tomcat 注册的端口，如默认的 8080）。</li><li>Tomcat 在启动时，会开启一个 <strong>监听线程</strong>（Acceptor），专门负责监听该端口，等待接入的 socket 连接。</li></ul><h4 id="2-分发请求"><strong>2. 分发请求</strong></h4><ul><li>一旦监听线程监听到客户端发来的连接请求，它就会：<ul><li><strong>接收 socket 连接</strong></li><li>将这个连接交给 <strong>工作线程池（Worker Thread Pool）</strong> 中的一个线程去处理。</li></ul></li><li>这一步很关键：<ul><li>每个请求都被分发给线程池中的一个工作线程，<strong>实现了多线程并发处理</strong>。</li><li>这个线程随后会负责整个请求的生命周期。</li></ul></li></ul><h4 id="3-处理请求"><strong>3. 处理请求</strong></h4><ul><li><p>工作线程接手后，它会：</p><ul><li>读取客户端发送的 HTTP 请求数据。</li><li>把这些数据解析成标准的 <strong><code>HttpServletRequest</code></strong> 对象，并准备好一个空的 <strong><code>HttpServletResponse</code></strong>。</li></ul></li><li><p>然后请求进入你部署在 Tomcat 中的</p><p>WebApp</p><p>（SpringMVC、Servlet 应用等）：</p><ul><li>依次经过：<ul><li><strong>Controller</strong>（接收请求，路由分发）</li><li><strong>Service</strong>（处理业务逻辑）</li><li><strong>DAO</strong>（访问数据库，获取或修改数据）</li></ul></li></ul></li><li><p>数据处理完成后，返回值会封装到 <code>response</code> 中。</p></li></ul><h4 id="4-返回响应"><strong>4. 返回响应</strong></h4><ul><li>一旦业务处理完毕，线程将响应内容写入 <code>HttpServletResponse</code>。</li><li>然后再通过最初建立的 <strong>socket 连接</strong>，把响应数据发送回客户端（用户）。</li><li>至此，<strong>一个请求-响应生命周期完成</strong>，socket 连接可能被关闭或复用（根据是否使用 keep-alive）。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-54-1024x522.png" alt="img"></p><p>preHandle前置拦截：</p><p>postHandle后置拦截：</p><p>afterCompletion视图渲染之后返回给用户之前：</p><p>在utils下面编写一个LoginInterceptor类，实现preHandle和afterCompletion这两个方法（这里User和UserDto的问题，我推荐的是统一使用UserDto，采用BeanUtils里的copy方法即可）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//获取session</span></span><br><span class="line">        <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession();</span><br><span class="line">        <span class="comment">//获取用户</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) session.getAttribute(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="comment">//判断用户是否存在</span></span><br><span class="line">        <span class="keyword">if</span>(user==<span class="literal">null</span>)&#123;</span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">UserDTO</span> <span class="variable">userDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserDTO</span>();</span><br><span class="line">        BeanUtils.copyProperties(user,userDTO);</span><br><span class="line">        <span class="comment">//存在，保存用户信息的ThreadLocal</span></span><br><span class="line">        UserHolder.saveUser(userDTO);</span><br><span class="line">        <span class="comment">//放行</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//移除用户</span></span><br><span class="line">        UserHolder.removeUser();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>​<br>在config下面创建一个MvcConfig类：</p><p>通过addInterceptors方法来添加拦截器，registry是拦截器的注册器。</p><p>用.excludePathPatterns来排除不需要拦截的路径。在这里code、login、bloghot、shop、shopType、upload和voucher等都不需要拦截。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">StringRedisTemplate</span> stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">addInterceptors</span>(<span class="params"><span class="title class_">InterceptorRegistry</span> registry</span>) &#123;</span><br><span class="line">        <span class="comment">// 登录拦截器</span></span><br><span class="line">        registry.<span class="title function_">addInterceptor</span>(<span class="keyword">new</span> <span class="title class_">LoginInterceptor</span>())</span><br><span class="line">                .<span class="title function_">excludePathPatterns</span>(</span><br><span class="line">                        <span class="string">&quot;/shop/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/voucher/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop-type/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/upload/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/blog/hot&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/user/code&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/user/login&quot;</span></span><br><span class="line">                ).<span class="title function_">order</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// token刷新的拦截器</span></span><br><span class="line">        registry.<span class="title function_">addInterceptor</span>(<span class="keyword">new</span> <span class="title class_">RefreshTokenInterceptor</span>(stringRedisTemplate)).<span class="title function_">addPathPatterns</span>(<span class="string">&quot;/**&quot;</span>).<span class="title function_">order</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输入手机号码点击获取验证码，写入返回后端的验证码，勾选协议之后，登录会直接返回首页，此时看我的个人主页没问题：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-55.png" alt="img"></p><h3 id="1-5、隐藏用户敏感信息">1.5、隐藏用户敏感信息</h3><p>我们通过浏览器观察到此时用户的全部信息都在，这样极为不靠谱，所以我们应当在返回用户信息之前，将用户的敏感信息进行隐藏，采用的核心思路就是书写一个UserDto对象，这个UserDto对象就没有敏感信息了，我们在返回前，将有用户敏感信息的User对象转化成没有敏感信息的UserDto对象，那么就能够避免这个尴尬的问题了</p><p>在1.4已将User转为UserDTO返回给前端。</p><h3 id="1-6、session共享问题">1.6、session共享问题</h3><p><strong>核心思路分析：</strong></p><p>每个tomcat中都有一份属于自己的session,假设用户第一次访问第一台tomcat，并且把自己的信息存放到第一台服务器的session中，但是第二次这个用户访问到了第二台tomcat，那么在第二台服务器上，肯定没有第一台服务器存放的session，所以此时 整个登录拦截功能就会出现问题，我们能如何解决这个问题呢？早期的方案是<strong>session拷贝</strong>，就是说虽然每个tomcat上都有不同的session，但是每当任意一台服务器的session修改时，都会同步给其他的Tomcat服务器的session，这样的话，就可以实现session的共享了</p><p>但是这种方案具有<strong>两个大问题</strong></p><p>1、每台服务器中都有完整的一份session数据，<strong>服务器压力过大。</strong></p><p>2、session拷贝数据时，可能会出现<strong>延迟</strong></p><p>所以咱们后来采用的方案都是<strong>基于redis来完成</strong>，我们把session换成redis，<strong>redis数据本身就是共享的</strong>，就可以避免session共享的问题了</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-56-1024x444.png" alt="img"></p><h3 id="1-7-Redis代替session的业务流程">1.7 Redis代替session的业务流程</h3><p>思考一下利用redis来存储数据，那么到底使用哪种结构呢</p><p>想要保存用户的登录信息有2种方法：1.用String类型。2.用Hash类型。</p><p>如下图，如果使用String，注意他的value，用多占用一点空间，如果使用哈希，则他的value中只会存储他数据本身，如果不是特别在意内存，其实使用String就可以啦。</p><p>String类型是以JSON字符串格式来保存，比较简单直观，但是占用内存比较多（因为有name和age这类的json格式）：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-59.png" alt="img"></p><p>Hash结构可以将对象中的每个字段独立存储，可以针对单个字段做CRUD，并且内存占用更少：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-58.png" alt="img"></p><p>所以我们可以使用String结构，就是一个简单的key，value键值对的方式，但是关于key的处理，session他是每个用户都有自己的session，但是redis的key是共享的，咱们就不能使用code了</p><h4 id="1-7-1在设计这个key的时候，需要满足两点">1.7.1在设计这个key的时候，需要满足两点</h4><p>1、key要具有唯一性</p><p>2、key要方便携带</p><p>如果我们采用phone：手机号这个的数据来存储当然是可以的，但是如果把这样的敏感数据存储到redis中并且从页面中带过来毕竟不太合适，<strong>所以我们在后台生成一个随机串token</strong>，然后让前端带来这个token就能完成我们的整体逻辑了</p><h4 id="1-7-2-整体访问流程">1.7.2 整体访问流程</h4><p>当注册完成后，用户去登录会去校验用户提交的手机号和验证码，是否一致，如果一致，则根据手机号查询用户信息，不存在则新建，最后将用户数据保存到redis，并且生成token作为redis的key，当我们校验用户是否登录时，会去携带着token进行访问，从redis中取出token对应的value，判断是否存在这个数据，如果没有则拦截，如果存在则将其保存到threadLocal中，并且放行。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-60-1024x557.png" alt="img"></p><h3 id="1-8-基于Redis实现短信登录">1.8 基于Redis实现短信登录</h3><p>在UserServiceImpl中写入如下代码（调用StringRedisTemplate中的set方法进行数据插入，最好在key的前面加入业务前缀以示区分，形成区分）：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Resource</span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate <span class="built_in">string</span>RedisTemplate;</span><br></pre></td></tr></table></figure><p>在sendCode这个方法里将保存验证码的代码替换为下面：</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//保存验证码到redis</span></span><br><span class="line"><span class="symbol">stringRedisTemplate.opsForValue</span>()<span class="meta">.set</span>(LOGIN_CODE_KEY+phone,<span class="meta">code</span>,LOGIN_CODE_TTL, TimeUnit.MINUTES)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>在login这个方法里进行如下2处修改：</p><p>首先是校验验证码：</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//校验验证码</span></span><br><span class="line"><span class="built_in">String</span> cacheCode = stringRedisTemplate.opsForValue().<span class="keyword">get</span>(LOGIN_CODE_KEY + phone);</span><br></pre></td></tr></table></figure><p>然后是添加把用户信息添加到Redis的逻辑</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 7.保存用户信息到 redis中</span></span><br><span class="line">    <span class="comment">// 7.1.随机生成token，作为登录令牌</span></span><br><span class="line">    <span class="built_in">String</span> token = UUID.randomUUID().toString(<span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// 7.2.将User对象转为HashMap存储</span></span><br><span class="line">    UserDTO userDTO = BeanUtil.copyProperties(user, UserDTO.<span class="keyword">class</span>);</span><br><span class="line">    <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt; userMap = BeanUtil.beanToMap(userDTO, <span class="keyword">new</span> HashMap&lt;&gt;(),</span><br><span class="line">            CopyOptions.create()</span><br><span class="line">                    .setIgnoreNullValue(<span class="keyword">true</span>)</span><br><span class="line">                    .setFieldValueEditor((fieldName, fieldValue) -&gt; fieldValue.toString()));</span><br><span class="line">    <span class="comment">// 7.3.存储</span></span><br><span class="line">    <span class="built_in">String</span> tokenKey = LOGIN_USER_KEY + token;</span><br><span class="line">    stringRedisTemplate.opsForHash().putAll(tokenKey, userMap);</span><br><span class="line">    <span class="comment">// 7.4.设置token有效期</span></span><br><span class="line">    stringRedisTemplate.expire(tokenKey, LOGIN_USER_TTL, TimeUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 8.返回token</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(token);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在MvcConfig类上有@Configuration注解，说明是由Spring来负责依赖注入。</p><p>在MvcConfig类中要编写如下的代码：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">StringRedisTemplate</span> stringRedisTemplate;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">addInterceptors</span>(<span class="params"><span class="title class_">InterceptorRegistry</span> registry</span>)&#123;</span><br><span class="line">        registry.<span class="title function_">addInterceptor</span>(<span class="keyword">new</span> <span class="title class_">LoginInterceptor</span>(stringRedisTemplate))</span><br><span class="line">                .<span class="title function_">excludePathPatterns</span>(</span><br><span class="line">                        <span class="string">&quot;/user/code&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/user/login&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/upload/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/blog/hot&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop-type/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/voucher/**&quot;</span></span><br><span class="line">                );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在utils下的LoginInterceptor中写入如下代码</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginInterceptor</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object <span class="keyword">handler</span>)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//TODO；1.获取请求头中的token</span></span><br><span class="line">        String token = request.getHeader(<span class="string">&quot;authorization&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(StrUtil.isBlank(token))&#123;</span><br><span class="line">            <span class="comment">//不存在，拦截，返回401状态码</span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//TODO：2.基于TOKEN获取redis的用户</span></span><br><span class="line">        Map&lt;Object, Object&gt; userMap = stringRedisTemplate.opsForHash().entries(LOGIN_USER_KEY + token);</span><br><span class="line">        <span class="comment">//判断用户是否存在</span></span><br><span class="line">        <span class="keyword">if</span>(userMap.isEmpty())&#123;</span><br><span class="line">            <span class="comment">//不存在，拦截，返回401状态码</span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//TODO：3.将查询到的Hash数据转化为UserDTO对象</span></span><br><span class="line">        UserDTO userDTO = BeanUtil.fillBeanWithMap(userMap, <span class="keyword">new</span> UserDTO(), <span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">//TODO：4.存在，保存用户信息的ThreadLocal</span></span><br><span class="line">        UserHolder.saveUser(userDTO);</span><br><span class="line">        <span class="comment">//TODO：5.刷新token有效期</span></span><br><span class="line">        stringRedisTemplate.expire(LOGIN_USER_KEY + token,RedisConstants.LOGIN_USER_TTL, TimeUnit.MINUTES);</span><br><span class="line">        <span class="comment">//放行</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object <span class="keyword">handler</span>, Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//移除用户</span></span><br><span class="line">        UserHolder.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：首先把Redis和数据库都启动。 原始的项目的Redis的服务器ID需要更改为自己的。点击发送验证码，redis中有记录，没问题：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-61-1024x369.png" alt="img"></p><p>但点击登录的时候会报一个无法将Long转String的错误。因为用的是stringRedisTemplate要求所有的字段都是string类型的。</p><p>需要对UserServiceImpl中如下的位置进行修改：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-62-1024x471.png" alt="img"></p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">Object</span>&gt; userMap = BeanUtil.beanToMap(userDTO,<span class="keyword">new</span> HashMap&lt;&gt;(),</span><br><span class="line">        CopyOptions.create()</span><br><span class="line">                .setIgnoreNullValue(<span class="literal">true</span>)</span><br><span class="line">                .setFieldValueEditor<span class="function"><span class="params">((fieldName,fieldValue)-&gt;fieldValue.toString())</span>);</span></span><br></pre></td></tr></table></figure><p>测试：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-63-1024x391.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-64-1024x249.png" alt="img"></p><h3 id="1-9-解决状态登录刷新问题">1.9 解决状态登录刷新问题</h3><h4 id="1-9-1-初始方案思路总结：">1.9.1 初始方案思路总结：</h4><p>在这个方案中，他确实可以使用对应路径的拦截，同时刷新登录token令牌的存活时间，但是现在这个拦截器他只是拦截需要被拦截的路径，<strong>假设当前用户访问了一些不需要拦截的路径，那么这个拦截器就不会生效，所以此时令牌刷新的动作实际上就不会执行</strong>，所以这个方案他是存在问题的</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-65-1024x571.png" alt="img"></p><h4 id="1-9-2-优化方案">1.9.2 优化方案</h4><p>既然之前的拦截器无法对不需要拦截的路径生效，<strong>那么我们可以添加一个拦截器，在第一个拦截器中拦截所有的路径，把第二个拦截器做的事情放入到第一个拦截器中，同时刷新令牌</strong>，因为第一个拦截器有了threadLocal的数据，所以此时第二个拦截器只需要判断拦截器中的user对象是否存在即可，完成整体刷新功能。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-66-1024x507.png" alt="img"></p><h4 id="1-9-3-代码">1.9.3 代码</h4><p>复制LoginInterceptor变成一份新的RefreshTokenInterceptor，把下面几处地方改为return true即可：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-67-1024x725.png" alt="img"></p><p>LoginInterceptor的代码变成如下：</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object <span class="keyword">handler</span>)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//1.判断是否需要拦截（ThreadLocal中是否有用户）</span></span><br><span class="line">        <span class="keyword">if</span>(UserHolder.getUser()==<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="comment">//没有，需要拦截，设置状态码</span></span><br><span class="line">            response.setStatus(<span class="number">401</span>);</span><br><span class="line">            <span class="comment">//拦截</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//放行</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object <span class="keyword">handler</span>, Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//移除用户</span></span><br><span class="line">        UserHolder.removeUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在还需要在MvcConfig里面对拦截器进行更新配置，需要（用order）调整拦截器的执行顺序：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">StringRedisTemplate</span> stringRedisTemplate;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">addInterceptors</span>(<span class="params"><span class="title class_">InterceptorRegistry</span> registry</span>)&#123;</span><br><span class="line">        registry.<span class="title function_">addInterceptor</span>(<span class="keyword">new</span> <span class="title class_">LoginInterceptor</span>())</span><br><span class="line">                .<span class="title function_">excludePathPatterns</span>(</span><br><span class="line">                        <span class="string">&quot;/user/code&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/user/login&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/upload/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/blog/hot&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/shop-type/**&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;/voucher/**&quot;</span></span><br><span class="line">                ).<span class="title function_">order</span>(<span class="number">1</span>);</span><br><span class="line">        registry.<span class="title function_">addInterceptor</span>(<span class="keyword">new</span> <span class="title class_">RefreshTokenInterceptor</span>(stringRedisTemplate))</span><br><span class="line">                .<span class="title function_">addPathPatterns</span>(<span class="string">&quot;/**&quot;</span>).<span class="title function_">order</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2、商户查询缓存">2、商户查询缓存</h2><h3 id="2-1什么是缓存">2.1什么是缓存</h3><p><strong>缓存(<strong>Cache),就是数据交换的</strong>缓冲区</strong>,俗称的缓存就是<strong>缓冲区内的数据</strong>,一般从数据库中获取,存储于本地代码一般<strong>读写性能较高</strong>，</p><p>例如:</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">例<span class="number">1</span>:Static <span class="keyword">final</span> ConcurrentHashMap&lt;K,V&gt; map = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(); 本地用于高并发</span><br><span class="line"></span><br><span class="line">例<span class="number">2</span>:<span class="type">static</span> <span class="keyword">final</span> Cache&lt;K,V&gt; USER_CACHE = CacheBuilder.<span class="built_in">newBuilder</span>().<span class="built_in">build</span>(); 用于redis等缓存</span><br><span class="line"></span><br><span class="line">例<span class="number">3</span>:Static <span class="keyword">final</span> Map&lt;K,V&gt; map =  <span class="keyword">new</span> <span class="built_in">HashMap</span>(); 本地缓存</span><br></pre></td></tr></table></figure><p>由于其被<strong>Static</strong>修饰,所以随着类的加载而被加载到<strong>内存之中</strong>,作为本地缓存,由于其又被<strong>final</strong>修饰,所以其引用(例3:map)和对象(例3:new HashMap())之间的关系是固定的,不能改变,因此不用担心赋值(=)导致缓存失效;</p><p><strong>缓存作用</strong>：降低后端负载；提高读写的效率，降低响应时间。</p><p><strong>缓存成本</strong>：数据一致性成本（数据库里的数据如果发生变化，容易与缓存中的数据形成不一致）。代码维护成本高（搭建集群）。运营成本高。</p><p><strong>如何使用缓存</strong></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-68-1024x432.png" alt="img"></p><h3 id="2-2-添加商户缓存">2.2 添加商户缓存</h3><p>标准的操作方式就是查询数据库之前先查询缓存，如果缓存数据存在，则直接从缓存中返回，如果缓存数据不存在，再查询数据库，然后将数据存入redis。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-77.png" alt="img"></p><p>在ShopController类的queryShopById方法中：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@GetMapping</span>(<span class="string">&quot;/&#123;id&#125;&quot;</span>)</span><br><span class="line">public Result <span class="built_in">queryShopById</span>(<span class="variable">@PathVariable</span>(<span class="string">&quot;id&quot;</span>) Long id) &#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">Result</span><span class="selector-class">.ok</span>(shopService.<span class="built_in">queryById</span>(id));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在IShopService接口中编写如下代码：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="symbol">IShopService</span> <span class="symbol">extends</span> <span class="symbol">IService</span>&lt;<span class="symbol">Shop</span>&gt; &#123;</span><br><span class="line">    Object queryById(Long id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在ShopServiceImpl类的queryById方法中编写具体代码：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ShopServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl&lt;ShopMapper</span>, <span class="title">Shop&gt;</span> <span class="title">implements</span> <span class="title">IShopService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">StringRedisTemplate</span> stringRedisTemplate;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public <span class="type">Object</span> queryById(<span class="type">Long</span> id) &#123;</span><br><span class="line">        <span class="type">String</span> key = <span class="type">CACHE_SHOP_KEY</span> + id;</span><br><span class="line">        <span class="comment">//1.从Redis查询缓存</span></span><br><span class="line">        <span class="type">String</span> shopJson = stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="comment">//2.判断是否存在</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="type">StrUtil</span>.isNotBlank(shopJson))&#123;</span><br><span class="line">            <span class="comment">//3.存在，直接返回</span></span><br><span class="line">            <span class="type">Shop</span> shop = <span class="type">JSONUtil</span>.toBean(shopJson, <span class="type">Shop</span>.<span class="keyword">class</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="type">Result</span>.ok(shop);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//4.不存在，根据id查询数据库</span></span><br><span class="line">        <span class="type">Shop</span> shop = getById(id);</span><br><span class="line">        <span class="comment">//5.不存在，返回错误</span></span><br><span class="line">        <span class="keyword">if</span>(shop==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="type">Result</span>.fail(<span class="string">&quot;店铺不存在！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//6.存在，写入Redis</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, <span class="type">JSONUtil</span>.toJsonStr(shop));</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Result</span>.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>核心是通过调用hutool工具包中的JSONUtil类来实现对象转JSON（方法：toJsonStr(对象)）和JSON转对象（方法：toBean(json,Bean的类型)）</p><p>TODO：对分类进行缓存。</p><p>在ShopController类的queryShopByList方法中：</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">&quot;list&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="function">Result <span class="title">queryTypeList</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//        List&lt;ShopType&gt; typeList = typeService</span></span><br><span class="line"><span class="comment">//                .query().orderByAsc(&quot;sort&quot;).list();</span></span><br><span class="line">        List&lt;ShopType&gt; typeList = typeService.queryTypeList();</span><br><span class="line">        <span class="function"><span class="keyword">return</span> Result.<span class="title">ok</span><span class="params">(typeList)</span></span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>在IShopService接口中编写如下代码：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="symbol">IShopTypeService</span> <span class="symbol">extends</span> <span class="symbol">IService</span>&lt;<span class="symbol">ShopType</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;ShopType&gt; queryTypeList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ShopTypeServiceImpl：</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ShopTypeServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl&lt;ShopTypeMapper</span>, <span class="title">ShopType&gt;</span> <span class="title">implements</span> <span class="title">IShopTypeService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">StringRedisTemplate</span> stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public <span class="type">List</span>&lt;<span class="type">ShopType</span>&gt; queryTypeList() &#123;</span><br><span class="line">        <span class="type">String</span> key = <span class="string">&quot;login:type&quot;</span>;</span><br><span class="line"><span class="comment">//        SetOperations&lt;String, String&gt; setOps = redisTemplate.opsForSet();</span></span><br><span class="line">        <span class="comment">// 1. 从redis查询商铺缓存</span></span><br><span class="line"><span class="comment">//        String shopTypeJson = setOps.members(key).toString();</span></span><br><span class="line">        <span class="type">String</span> shopTypeJson = stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">        <span class="comment">// 2. 判断是否存在</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="type">StrUtil</span>.isNotBlank(shopTypeJson)) &#123;</span><br><span class="line">            <span class="comment">// 3. 存在，转化为List返回</span></span><br><span class="line"><span class="comment">//            return objectMapper.readValue(shopTypeJson, new TypeReference&lt;List&lt;ShopType&gt;&gt;()&#123;&#125;);</span></span><br><span class="line">            <span class="keyword">return</span> <span class="type">JSONUtil</span>.toList(shopTypeJson, <span class="type">ShopType</span>.<span class="keyword">class</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4. 不存在，查询数据库</span></span><br><span class="line">        <span class="type">List</span>&lt;<span class="type">ShopType</span>&gt; typeList = <span class="keyword">this</span>.query().orderByAsc(<span class="string">&quot;sort&quot;</span>).list();</span><br><span class="line">        <span class="comment">// 5. 不存在，返回空列表</span></span><br><span class="line">        <span class="keyword">if</span> (typeList.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">ArrayList</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 6. 存在，写入redis</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(key, <span class="type">JSONUtil</span>.toJsonStr(typeList));</span><br><span class="line">        <span class="comment">// 7. 返回</span></span><br><span class="line">        <span class="keyword">return</span> typeList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-缓存更新策略">2.3 缓存更新策略</h3><p>缓存更新是<strong>redis为了节约内存而设计出来的一个东西</strong>，主要是因为内存数据宝贵，当我们向redis插入太多数据，此时就可能会导致缓存中的数据过多，所以<strong>redis会对部分数据进行更新</strong>，或者把他叫为淘汰更合适。</p><ul><li><strong>内存淘汰：redis自动进行</strong>，当redis内存达到咱们设定的max-memery的时候，会自动触发淘汰机制，淘汰掉一些不重要的数据(可以自己设置策略方式)</li><li>**超时剔除：**当我们给redis设置了过期时间ttl之后，<strong>redis会将超时的数据进行删除</strong>，方便咱们继续使用缓存</li><li><strong>主动更新：<strong>我们可以</strong>手动调用方法</strong>把缓存删掉，通常用于解决缓存和数据库不一致问题</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-88.png" alt="img"></p><h4 id="2-3-1-数据库缓存不一致解决方案：">2.3.1 数据库缓存不一致解决方案：</h4><p><strong>缓存的数据源来自于数据库</strong>,而数据库的<strong>数据是会发生变化的</strong>,因此,如果当数据库中<strong>数据发生变化,而缓存却没有同步</strong>,此时就会有<strong>一致性问题存在</strong>。</p><p>解决方案：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-89.png" alt="img"></p><h4 id="2-3-2-数据库和缓存不一致采用什么方案">2.3.2 数据库和缓存不一致采用什么方案</h4><p>选择方案一：但是方案一调用者如何处理呢？这里有几个问题操作缓存和数据库时有三个问题需要考虑：</p><p>1.选择删除缓存还是更新缓存？</p><ul><li>更新缓存：每次更新数据库都会更新缓存，无效的写操作比较多。</li><li>删除缓存：更新数据库时让缓存失效，查询时再更新缓存。</li></ul><p>2.如何保证缓存与数据库的操作的同时成功或失败？</p><ul><li>单体系统，将缓存与数据库操作放在一个事务</li><li>分布式系统，利用TCC等分布式事务方案</li></ul><p>3.先操作缓存还是先操作数据库？</p><ul><li>先删除缓存，再操作数据库</li><li>先操作数据库，再删除缓存</li></ul><p>答：我们应当是<strong>先操作数据库，再删除缓存</strong>，原因在于，如果你选择第一种方案，在两个线程并发来访问时，假设线程1先来，他先把缓存删了，此时线程2过来，他查询缓存数据并不存在，此时他写入缓存，当他写入缓存后，线程1再执行更新动作时，实际上写入的就是旧的数据，新的数据被旧数据覆盖了。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-90.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-91.png" alt="img"></p><h3 id="2-4-实现商铺和缓存与数据库双写一致">2.4 实现商铺和缓存与数据库双写一致</h3><p>给查询商铺的缓存添加超时剔除和主动更新的策略。</p><p>修改ShopController中的业务逻辑，满足下面要求：</p><p>1.根据id查询商铺时，如果缓存未命中，则查询数据库，将数据库结果写入缓存，并设置超时时间。</p><p>2.根据id修改店铺时，先修改数据库，再删除缓存。</p><p>首先修改ShopServiceImpl的redis过期时间：</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stringRedisTemplate.opsForValue()<span class="meta">.set</span>(key, <span class="keyword">JSONUtil.toJsonStr(shop),CACHE_SHOP_TTL, </span>TimeUnit.MINUTES);</span><br></pre></td></tr></table></figure><p>修改ShopController中的updateShop方法：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@PutMapping</span></span><br><span class="line">public Result <span class="built_in">updateShop</span>(<span class="variable">@RequestBody</span> Shop shop) &#123;</span><br><span class="line">    <span class="comment">// 写入数据库</span></span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">Result</span><span class="selector-class">.ok</span>(shopService.<span class="built_in">update</span>(shop));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>向IShopService接口中添加update方法：</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable"><span class="class">Object</span></span> <span class="function"><span class="title">update</span>(<span class="variable">Shop</span> <span class="variable">shop</span>);</span></span><br></pre></td></tr></table></figure><p>向ShopServiceImpl类中添加update方法：</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function">Object <span class="title">update</span><span class="params">(Shop shop)</span> </span>&#123;</span><br><span class="line">    Long id = shop.getId();</span><br><span class="line">    <span class="keyword">if</span>(id == <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;商铺id不存在&quot;</span>)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    updateById(shop);</span><br><span class="line">    stringRedisTemplate.delete(CACHE_SHOP_KEY + id);</span><br><span class="line">    <span class="function"><span class="keyword">return</span> Result.<span class="title">ok</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：首先删除缓存中的数据，然后看SQL语句是否执行，是否加上了TTL过期时间。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-92.png" alt="img"></p><p>访问http://localhost:8081/shop，然后修改101茶餐厅为102茶餐厅：</p><p>注意要发送的是PUT请求，请求的内容如下：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-93.png" alt="img"></p><p>然后去数据库看是否名称更新为102茶餐厅，然后看缓存中的数据是否被删除，用户刷新页面看到102茶餐厅，缓存中会有最新的数据。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-94.png" alt="img"></p><h3 id="2-5-缓存穿透问题的解决思路">2.5 缓存穿透问题的解决思路</h3><p>缓存穿透 ：<strong>缓存穿透是指客户端请求的数据在缓存中和数据库中都不存在，这样缓存永远不会生效，这些请求都会打到数据库。</strong></p><p>常见的解决方案有两种：</p><ul><li>缓存空对象</li><li>优点：实现简单，维护方便</li><li>缺点：<ul><li>额外的内存消耗</li><li>可能造成短期的不一致</li></ul></li><li>布隆过滤</li><li>优点：内存占用较少，没有多余key</li><li>缺点：<ul><li>实现复杂</li><li>存在误判可能</li></ul></li></ul><p>缓存空对象：</p><p>当我们客户端访问不存在的数据时，先请求redis，但是此时redis中没有数据，此时会访问到数据库，但是数据库中也没有数据，这个数据穿透了缓存，直击数据库，我们都知道数据库能够承载的并发不如redis这么高，如果大量的请求同时过来访问这种不存在的数据，这些请求就都会访问到数据库，<strong>简单的解决方案就是哪怕这个数据在数据库中也不存在，我们也把这个数据存入到redis中去，这样，下次用户过来访问这个不存在的数据，那么在redis中也能找到这个数据就不会进入到缓存了</strong></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-95.png" alt="img"></p><p>布隆过滤：</p><p>布隆过滤器其实采用的是<strong>哈希思想</strong>来解决这个问题，通过一个庞大的二进制数组，走哈希思想去判断当前这个要查询的这个数据是否存在，如果布隆过滤器判断存在，则放行，这个请求会去访问redis，哪怕此时redis中的数据过期了，但是数据库中一定存在这个数据，在数据库中查询出来这个数据后，再将其放入到redis中，</p><p>假设布隆过滤器判断这个数据不存在，则直接返回</p><p>这种方式<strong>优点在于节约内存空间</strong>，<strong>缺点是存在误判</strong>，误判原因在于：<strong>布隆过滤器走的是哈希思想，只要哈希思想，就可能存在哈希冲突</strong></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-96.png" alt="img"></p><h3 id="2-6-编码解决商品查询的缓存穿透问题：">2.6 编码解决商品查询的缓存穿透问题：</h3><p>下图是原始的：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-97.png" alt="img"></p><p>在原来的逻辑中，我们如果发现这个数据在mysql中不存在，直接就返回404了，<strong>这样是会存在缓存穿透问题的</strong></p><p>更改后的方案：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-98.png" alt="img"></p><p>如果这个数据不存在，我们不会返回404 ，还是<strong>会把这个数据写入到Redis中，并且将value设置为空</strong>，当再次发起查询时，我们如果发现命中之后，<strong>判断这个value是否是null，如果是null，则是之前写入的数据，证明是缓存穿透数据，如果不是，则直接返回数据。</strong></p><p>在ShopServiceImpl类里对queryById方法进行修改：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object queryById(<span class="built_in">Long</span> id) &#123;</span><br><span class="line">    String key = CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="comment">//1.从Redis查询缓存</span></span><br><span class="line">    String shopJson = stringRedisTemplate.opsForValue().<span class="keyword">get</span>(key);</span><br><span class="line">    <span class="comment">//2.判断是否存在</span></span><br><span class="line">    <span class="keyword">if</span>(StrUtil.isNotBlank(shopJson))&#123;</span><br><span class="line">        <span class="comment">//3.存在，直接返回</span></span><br><span class="line">        Shop shop = JSONUtil.toBean(shopJson, Shop.<span class="keyword">class</span>);</span><br><span class="line">        <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//上面是有值的情况，下面是无值的2种情况：A：空字符串。B：null。</span></span><br><span class="line">    <span class="keyword">if</span>(shopJson != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;店铺信息不存在！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4.不存在，根据id查询数据库</span></span><br><span class="line">    Shop shop = getById(id);</span><br><span class="line">    <span class="comment">//5.不存在，返回错误</span></span><br><span class="line">    <span class="keyword">if</span>(shop==<span class="literal">null</span>)&#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().<span class="keyword">set</span>(key,<span class="string">&quot;&quot;</span>,CACHE_NULL_TTL,TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;店铺不存在！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6.存在，写入Redis</span></span><br><span class="line">    stringRedisTemplate.opsForValue().<span class="keyword">set</span>(key, JSONUtil.toJsonStr(shop),CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：</p><p>localhost:8080/api/shop/1此时是命中数据。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-99.png" alt="img"></p><p>localhost:8080/api/shop/0此时未命中数据。打开缓存可以看到缓存的是空，并且TTL是200秒</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-100.png" alt="img"></p><p><strong>小总结：</strong></p><p>1.缓存穿透产生的原因是什么？</p><p>答：<strong>用户请求的数据在缓存中和数据库中都不存在，不断发起这样的请求，给数据库带来巨大压力</strong></p><p>2.缓存穿透的解决方案有哪些？</p><p>答：</p><ul><li>缓存null值</li><li>布隆过滤</li><li>增强id的复杂度，避免被猜测id规律</li><li>做好数据的基础格式校验</li><li>加强用户权限校验</li><li>做好热点参数的限流</li></ul><h3 id="2-7-缓存雪崩问题及解决思路">2.7 缓存雪崩问题及解决思路</h3><p>1.什么是缓存雪崩？</p><p>答：<strong>缓存雪崩是指在同一时段大量的缓存key同时失效或者Redis服务宕机，导致大量请求到达数据库，带来巨大压力。</strong></p><p>2.缓存雪崩的解决方案有哪些？</p><p>答：</p><ul><li>给业务添加多级缓存</li><li>给不同的Key的TTL添加随机值（解决大量缓存key同时失效）</li><li>利用Redis集群提高服务的可用性（解决Redis宕机）</li><li>给缓存业务添加降级限流策略</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-102.png" alt="img"></p><h3 id="2-8-缓存击穿问题及解决思路">2.8 缓存击穿问题及解决思路</h3><p>1.什么是缓存击穿？</p><p>答：缓存击穿问题也叫热点Key问题，<strong>就是一个被高并发访问并且缓存重建业务较复杂的key突然失效了，无数的请求访问会在瞬间给数据库带来巨大的冲击。</strong></p><p>2.缓存击穿的解决方案有哪些？</p><p>答：常见的解决方案有两种</p><ul><li>互斥锁</li><li>逻辑过期</li></ul><p>分析：假设线程1在查询缓存之后，本来应该去查询数据库，然后把这个数据重新加载到缓存的，此时只要线程1走完这个逻辑，其他线程就都能从缓存中加载这些数据了，但是假设在线程1没有走完的时候，后续的线程2，线程3，线程4同时过来访问当前这个方法， 那么这些线程都不能从缓存中查询到数据，那么他们就会同一时刻来访问查询缓存，都没查到，接着同一时间去访问数据库，同时的去执行数据库代码，对数据库访问压力过大</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-103.png" alt="img"></p><p><strong>解决方案一  使用锁互斥锁来解决：</strong></p><p>我们可以采用tryLock方法 + double check来解决这样的问题。</p><p>分析：假设现在线程1过来访问，他查询缓存没有命中，但是此时他获得到了锁的资源，那么线程1就会一个人去执行逻辑，假设现在线程2过来，线程2在执行过程中，并没有获得到锁，那么线程2就可以进行到休眠，直到线程1把锁释放后，线程2获得到锁，然后再来执行逻辑，此时就能够从缓存中拿到数据了。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-104.png" alt="img"></p><p><strong>解决方案二 逻辑过期方案</strong></p><p>方案分析：我们之所以会出现这个缓存击穿问题，主要原因是在于我们对key设置了过期时间，假设我们不设置过期时间，其实就不会有缓存击穿的问题，但是不设置过期时间，这样数据不就一直占用我们内存了吗，我们可以采用逻辑过期方案。</p><p>我们把过期时间设置在 redis的value中，注意：<strong>这个过期时间并不会直接作用于redis，而是我们后续通过逻辑去处理</strong>。假设线程1去查询缓存，然后从value中判断出来当前的数据已经过期了，此时线程1去获得互斥锁，那么其他线程会进行阻塞，获得了锁的线程他会开启一个 线程去进行 以前的重构数据的逻辑，直到新开的线程完成这个逻辑后，才释放锁， 而线程1直接进行返回，假设现在线程3过来访问，由于线程线程2持有着锁，所以线程3无法获得锁，线程3也直接返回数据，只有等到新开的线程2把重建数据构建完后，其他线程才能走返回正确的数据。</p><p>这种方案巧妙在于，异步的构建缓存，缺点在于在构建完缓存之前，返回的都是脏数据。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-105.png" alt="img"></p><p>进行对比</p><p><strong>互斥锁方案：<strong>由于</strong>保证了互斥性，所以数据一致</strong>，且实现简单，因为仅仅只需要加一把锁而已，也没其他的事情需要操心，所以<strong>没有额外的内存消耗</strong>，缺点在于有锁就有<strong>死锁问题的发生</strong>，且<strong>只能串行执行</strong>性能肯定受到影响</p><p><strong>逻辑过期方案：</strong> 线程读取过程中不需要等待，<strong>性能好，有一个额外的线程持有锁去进行重构数据</strong>，<strong>但是在重构数据完成前，其他的线程只能返回之前的数据</strong>，且实现起来麻烦</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-106.png" alt="img"></p><h3 id="2-9-利用互斥锁解决缓存击穿问题">2.9 利用互斥锁解决缓存击穿问题</h3><p>思路：相较于原来从缓存中查询不到数据后直接查询数据库而言，现在的方案是进行查询之后，如果从缓存没有查询到数据，则进行互斥锁的获取，获取互斥锁后，判断是否获得到了锁，如果没有获得到，则休眠，过一会再进行尝试，直到获取到锁为止，才能进行查询</p><p>如果获取到了锁的线程，再去进行查询，查询后将数据写入redis，再释放锁，返回数据，利用互斥锁就能保证只有一个线程去执行操作数据库的逻辑，防止缓存击穿</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-107.png" alt="img"></p><p><strong>操作锁的代码：</strong></p><p>核心思路就是利用redis的setnx方法来表示获取锁，该方法含义是redis中如果没有这个key，则插入成功，返回1，在stringRedisTemplate中返回true， 如果有这个key则插入失败，则返回0，在stringRedisTemplate返回false，<strong>我们可以通过true，或者是false，来表示是否有线程成功插入key，成功插入的key的线程我们认为他就是获得到锁的线程</strong>。</p><p>在ShopServiceImpl类中定义一个tryLock方法（在Redis中的setnx相当于setIfAbsent方法。）</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">boolean</span> <span class="title function_">tryLock</span>(<span class="params"><span class="title class_">String</span> key</span>)&#123;</span><br><span class="line">    <span class="title class_">Boolean</span> flag = stringRedisTemplate.<span class="title function_">opsForValue</span>().<span class="title function_">setIfAbsent</span>(key, <span class="string">&quot;1&quot;</span>, <span class="number">10</span>, <span class="title class_">TimeUnit</span>.<span class="property">SECONDS</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">BooleanUtil</span>.<span class="title function_">isTrue</span>(flag);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在ShopServiceImpl类中定义一个unLock方法用于解锁。</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unLock</span>(<span class="built_in">String</span> <span class="built_in">key</span>)&#123;</span><br><span class="line">    stringRedisTemplate.<span class="property">delete</span>(<span class="built_in">key</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在ShopServiceImpl类中定义一个queryWithPassThrough方法。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Shop queryWithPassThrough(<span class="built_in">Long</span> id)&#123;</span><br><span class="line">    String key = CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="comment">//1.从Redis查询缓存</span></span><br><span class="line">    String shopJson = stringRedisTemplate.opsForValue().<span class="keyword">get</span>(key);</span><br><span class="line">    <span class="comment">//2.判断是否存在</span></span><br><span class="line">    <span class="keyword">if</span>(StrUtil.isNotBlank(shopJson))&#123;</span><br><span class="line">        <span class="comment">//3.存在，直接返回</span></span><br><span class="line">        Shop shop = JSONUtil.toBean(shopJson, Shop.<span class="keyword">class</span>);</span><br><span class="line">        <span class="keyword">return</span> shop;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//上面是有值的情况，下面是无值的2种情况：A：空字符串。B：null。</span></span><br><span class="line">    <span class="keyword">if</span>(shopJson != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4.不存在，根据id查询数据库</span></span><br><span class="line">    Shop shop = getById(id);</span><br><span class="line">    <span class="comment">//5.不存在，返回错误</span></span><br><span class="line">    <span class="keyword">if</span>(shop==<span class="literal">null</span>)&#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().<span class="keyword">set</span>(key,<span class="string">&quot;&quot;</span>,CACHE_NULL_TTL,TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6.存在，写入Redis</span></span><br><span class="line">    stringRedisTemplate.opsForValue().<span class="keyword">set</span>(key, JSONUtil.toJsonStr(shop),CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    <span class="keyword">return</span> shop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在ShopServiceImpl类中定义一个queryWithMutex方法：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Shop queryWithMutex(<span class="built_in">Long</span> id)&#123;</span><br><span class="line">    String key = CACHE_SHOP_KEY + id;</span><br><span class="line">    <span class="comment">//1.从Redis查询缓存</span></span><br><span class="line">    String shopJson = stringRedisTemplate.opsForValue().<span class="keyword">get</span>(key);</span><br><span class="line">    <span class="comment">//2.判断是否存在</span></span><br><span class="line">    <span class="keyword">if</span>(StrUtil.isNotBlank(shopJson))&#123;</span><br><span class="line">        <span class="comment">//3.存在，直接返回</span></span><br><span class="line">        Shop shop = JSONUtil.toBean(shopJson, Shop.<span class="keyword">class</span>);</span><br><span class="line">        <span class="keyword">return</span> shop;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//上面是有值的情况，下面是无值的2种情况：A：空字符串。B：null。</span></span><br><span class="line">    <span class="keyword">if</span>(shopJson != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4.实现缓存重建</span></span><br><span class="line">    <span class="comment">//4.1 获取互斥锁</span></span><br><span class="line">    String lockKey = LOCK_SHOP_KEY+id;</span><br><span class="line">    Shop shop = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        boolean isLock = tryLock(lockKey);</span><br><span class="line">        <span class="comment">//4.2 判断是否获取成功</span></span><br><span class="line">        <span class="keyword">if</span>(!isLock)&#123;</span><br><span class="line">            <span class="comment">//4.3 失败，则休眠并重试</span></span><br><span class="line">            Thread.sleep(<span class="number">50</span>);</span><br><span class="line">            <span class="keyword">return</span> queryWithMutex(id);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//4.4 获取互斥锁成功，根据id查询数据库</span></span><br><span class="line">        shop = getById(id);</span><br><span class="line">        <span class="comment">//模拟重建的延时</span></span><br><span class="line">        Thread.sleep(<span class="number">200</span>);</span><br><span class="line">        <span class="comment">//5.数据库查询失败，返回错误</span></span><br><span class="line">        <span class="keyword">if</span>(shop==<span class="literal">null</span>)&#123;</span><br><span class="line">            stringRedisTemplate.opsForValue().<span class="keyword">set</span>(key,<span class="string">&quot;&quot;</span>,CACHE_NULL_TTL,TimeUnit.MINUTES);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//6.存在，写入Redis</span></span><br><span class="line">        stringRedisTemplate.opsForValue().<span class="keyword">set</span>(key, JSONUtil.toJsonStr(shop),CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> new RuntimeException(e);</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//7.释放互斥锁</span></span><br><span class="line">        unLock(lockKey);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//8.返回</span></span><br><span class="line">    <span class="keyword">return</span> shop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在ShopServiceImpl类中修改queryById，调用queryWithMutex：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title class_">Object</span> <span class="title function_">queryById</span>(<span class="params"><span class="title class_">Long</span> id</span>) &#123;</span><br><span class="line">    <span class="comment">//缓存穿透</span></span><br><span class="line">    <span class="comment">//Shop shop = queryWithPassThrough(id);</span></span><br><span class="line">    <span class="comment">//互斥锁解决缓存击穿</span></span><br><span class="line">    <span class="title class_">Shop</span> shop = <span class="title function_">queryWithMutex</span>(id);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Result</span>.<span class="title function_">ok</span>(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-10-利用逻辑过期解决缓存击穿问题">2.10  利用逻辑过期解决缓存击穿问题</h3><p><strong>需求：修改根据id查询商铺的业务，基于逻辑过期方式来解决缓存击穿问题</strong></p><p>思路分析：当用户开始查询redis时，判断是否命中，如果没有命中则直接返回空数据，不查询数据库，而一旦命中后，将value取出，判断value中的过期时间是否满足，如果没有过期，则直接返回redis中的数据，如果过期，则在开启独立线程后直接返回之前的数据，独立线程去重构数据，重构完成后释放互斥锁。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-108.png" alt="img"></p><p>如果封装数据，添加逻辑过期字段：因为现在redis中存储的数据的value需要带上过期时间，此时要么你去修改原来的实体类</p><p>答：可以在utils包下定义RedisData类（可以让Shop继承RedisData类），也可以在RedisData中设置一个Shop类的data属性：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisData</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime expireTime;</span><br><span class="line">    <span class="keyword">private</span> Object <span class="keyword">data</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在ShopServiceImpl类中定义saveShop2Redis方法：</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> saveShop2Redis(Long <span class="built_in">id</span>,Long expireSeconds)&#123;</span><br><span class="line">    <span class="comment">//1.查询店铺数据</span></span><br><span class="line">    Shop shop <span class="operator">=</span> getById(<span class="built_in">id</span>);</span><br><span class="line">    <span class="comment">//2.封装逻辑过期时间</span></span><br><span class="line">    RedisData redisData <span class="operator">=</span> <span class="keyword">new</span> RedisData();</span><br><span class="line">    redisData.setData(shop);</span><br><span class="line">    redisData.setExpireTime(LocalDateTime.now().plusSeconds(expireSeconds));</span><br><span class="line">    <span class="comment">//3.写入Redis</span></span><br><span class="line">    stringRedisTemplate.opsForValue().<span class="built_in">set</span>(CACHE_SHOP_KEY<span class="operator">+</span><span class="built_in">id</span>,JSONUtil.toJsonStr(redisData));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>单元测试，在test包下的HmDianPingApplicationTests中创建testSaveShop类写入测试代码（这里要注意的是输入alt+insert之后选择Test Method要选择Junit 5来进行测试方法的编写）：</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HmDianPingApplicationTests</span> </span>&#123;</span><br><span class="line">    <span class="variable">@Resource</span></span><br><span class="line">    private ShopServiceImpl shopService;</span><br><span class="line"> </span><br><span class="line">    <span class="variable">@Test</span></span><br><span class="line">    void testSaveShop() &#123;</span><br><span class="line">        shopService.saveShop2Redis(1L,10L);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到redis中确实存入了数据：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-109.png" alt="img"></p><p>在ShopServiceImpl中复制一份缓存穿透的代码，更改名称为queryWithLogicalExpire：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> final <span class="title class_">ExecutorService</span> <span class="variable constant_">CACHE_REBUILD_EXECUTOR</span> = <span class="title class_">Executors</span>.<span class="title function_">newFixedThreadPool</span>(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">public</span> <span class="title class_">Shop</span> <span class="title function_">queryWithLogicalExpire</span>(<span class="params"><span class="title class_">Long</span> id</span>)&#123;</span><br><span class="line">    <span class="title class_">String</span> key = <span class="variable constant_">CACHE_SHOP_KEY</span> + id;</span><br><span class="line">    <span class="comment">//1.从Redis查询缓存</span></span><br><span class="line">    <span class="title class_">String</span> shopJson = stringRedisTemplate.<span class="title function_">opsForValue</span>().<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="comment">//2.判断是否存在</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">StrUtil</span>.<span class="title function_">isBlank</span>(shopJson))&#123;</span><br><span class="line">        <span class="comment">//3.不存在，返回空</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4.命中，需要先把json反序列化为对象</span></span><br><span class="line">    <span class="title class_">RedisData</span> redisData = <span class="title class_">JSON</span>Util.<span class="title function_">toBean</span>(shopJson, <span class="title class_">RedisData</span>.<span class="property">class</span>);</span><br><span class="line">    <span class="title class_">JSON</span><span class="built_in">Object</span> data = (<span class="title class_">JSON</span><span class="built_in">Object</span>) redisData.<span class="title function_">getData</span>();</span><br><span class="line">    <span class="title class_">Shop</span> shop = <span class="title class_">JSON</span>Util.<span class="title function_">toBean</span>(data, <span class="title class_">Shop</span>.<span class="property">class</span>);</span><br><span class="line">    <span class="comment">//5.判断是否过期</span></span><br><span class="line">    <span class="comment">//5.1 未过期直接返回店铺信息</span></span><br><span class="line">    <span class="title class_">LocalDateTime</span> expireTime = redisData.<span class="title function_">getExpireTime</span>();</span><br><span class="line">    <span class="keyword">if</span>(expireTime.<span class="title function_">isAfter</span>(<span class="title class_">LocalDateTime</span>.<span class="title function_">now</span>()))&#123;</span><br><span class="line">        <span class="keyword">return</span> shop;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//5.2 已过期重建缓存</span></span><br><span class="line">    <span class="comment">//6.缓存重建</span></span><br><span class="line">    <span class="comment">//6.1.获取互斥锁</span></span><br><span class="line">    <span class="title class_">String</span> lockKey = <span class="variable constant_">LOCK_SHOP_KEY</span> + id;</span><br><span class="line">    <span class="built_in">boolean</span> isLock = <span class="title function_">tryLock</span>(lockKey);</span><br><span class="line">    <span class="comment">//6.2.判断是否获取互斥锁成功</span></span><br><span class="line">    <span class="keyword">if</span>(isLock)&#123;</span><br><span class="line">        <span class="comment">//6.3.成功，开启独立线程，实现缓存重建</span></span><br><span class="line">        <span class="variable constant_">CACHE_REBUILD_EXECUTOR</span>.<span class="title function_">submit</span>(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="title function_">saveShop2Redis</span>(id,20L); <span class="comment">//实际中应该设置为30分钟</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="title function_">unLock</span>(lockKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6.4.失败，返回过期的商铺信息</span></span><br><span class="line">    <span class="keyword">return</span> shop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：</p><p>先到数据库把102茶餐厅改为103茶餐厅（因为Redis之前插入了一条缓存为102茶餐厅，并且已经过期，此时数据库与缓存不一致），新的HTTP请求会将逻辑过期的数据删除，然后更新缓存。</p><p>线程数设置为100，Ramp-up时间设置为1</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-110.png" alt="img"></p><p>在查看结果树里面到中间某个HTTP请求会完成重建，响应数据会改变。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-111.png" alt="img"></p><p>1.安全性问题：在高并发情况下是否会有很多线程来做重建。</p><p>2.一致性问题：在重建完成之前得到的是否是旧的数据。</p><h3 id="2-11-封装Redis-工具类">2.11 封装Redis 工具类</h3><p>背景：在高并发系统中，我们通常使用 Redis 缓存数据库查询结果，减轻数据库压力。但如果直接使用 Redis，可能会遇到以下问题：</p><ol><li><strong>缓存穿透</strong>：请求的数据既不在缓存里，也不在数据库里，会频繁打数据库。</li><li><strong>缓存击穿</strong>：热点key突然失效，导致大量请求同时打到数据库。</li><li><strong>缓存雪崩</strong>：大量key同时过期，引起瞬时流量打满数据库。</li></ol><p>因此我们基于StringRedisTemplate封装一个缓存工具类，满足下列需求：</p><ul><li>方法1：将任意Java对象序列化为json并存储在string类型的key中，并且可以设置TTL过期时间</li><li>方法2：将任意Java对象序列化为json并存储在string类型的key中，并且可以设置逻辑过期时间，用于处理缓存击穿问题</li><li>方法3：根据指定的key查询缓存，并反序列化为指定类型，利用缓存空值的方式解决缓存穿透问题</li><li>方法4：根据指定的key查询缓存，并反序列化为指定类型，需要利用逻辑过期解决缓存击穿问题</li></ul><p><strong>具体实现</strong>：</p><p>在utils包下创建CacheClient类，先写入如下基础的代码：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CacheClient</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> final <span class="title class_">StringRedisTemplate</span> stringRedisTemplate;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">CacheClient</span>(<span class="title class_">StringRedisTemplate</span> stringRedisTemplate) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">stringRedisTemplate</span> = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">set</span>(<span class="params"><span class="title class_">String</span> key, <span class="title class_">Object</span> value, <span class="title class_">Long</span> time, <span class="title class_">TimeUnit</span> unit</span>)&#123;</span><br><span class="line">        stringRedisTemplate.<span class="title function_">opsForValue</span>().<span class="title function_">set</span>(key,<span class="title class_">JSON</span>Util.<span class="title function_">toJsonStr</span>(value),time,unit);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">setWithLogicalExpire</span>(<span class="params"><span class="title class_">String</span> key, <span class="title class_">Object</span> value,<span class="title class_">Long</span> expire,<span class="title class_">TimeUnit</span> unit</span>)&#123;</span><br><span class="line">        <span class="comment">//设置逻辑过期</span></span><br><span class="line">        <span class="title class_">RedisData</span> redisData = <span class="keyword">new</span> <span class="title class_">RedisData</span>();</span><br><span class="line">        redisData.<span class="title function_">setExpireTime</span>(<span class="title class_">LocalDateTime</span>.<span class="title function_">now</span>().<span class="title function_">plusSeconds</span>(unit.<span class="title function_">toSeconds</span>(expire)));</span><br><span class="line">        redisData.<span class="title function_">setData</span>(value);</span><br><span class="line">        stringRedisTemplate.<span class="title function_">opsForValue</span>().<span class="title function_">set</span>(key,<span class="title class_">JSON</span>Util.<span class="title function_">toJsonStr</span>(redisData));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-119.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-120.png" alt="img"></p><p>在CacheClient类中编写缓存穿透的共性方法queryWithPassThrough：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;R,ID&gt; R queryWithPassThrough(String keyPrefix, ID id, Class&lt;R&gt; type,</span><br><span class="line">                                     Function&lt;ID,R&gt; dbFallBack,<span class="built_in">Long</span> time,TimeUnit unit)&#123;</span><br><span class="line">    String key = keyPrefix + id;</span><br><span class="line">    <span class="comment">//1.从Redis查询缓存</span></span><br><span class="line">    String shopJson = stringRedisTemplate.opsForValue().<span class="keyword">get</span>(key);</span><br><span class="line">    <span class="comment">//2.判断是否存在</span></span><br><span class="line">    <span class="keyword">if</span>(StrUtil.isNotBlank(shopJson))&#123;</span><br><span class="line">        <span class="comment">//3.存在，直接返回</span></span><br><span class="line">        <span class="keyword">return</span> JSONUtil.toBean(shopJson, type);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//上面是有值的情况，下面是无值的2种情况：A：空字符串。B：null。</span></span><br><span class="line">    <span class="keyword">if</span>(shopJson != <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4.不存在，根据id查询数据库</span></span><br><span class="line">    R r = dbFallBack.apply(id);</span><br><span class="line">    <span class="comment">//5.不存在，返回错误</span></span><br><span class="line">    <span class="keyword">if</span>(r==<span class="literal">null</span>)&#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().<span class="keyword">set</span>(key,<span class="string">&quot;&quot;</span>,CACHE_NULL_TTL,TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6.存在，写入Redis</span></span><br><span class="line">    <span class="keyword">this</span>.<span class="keyword">set</span>(key,r,time,unit);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-121.png" alt="img"></p><p>编写完queryWithPassThrough之后可以到ShopServiceImpl中直接调用新的方法（记得引入CacheClient类）：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> CacheClient cacheClient;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object queryById(<span class="built_in">Long</span> id) &#123;</span><br><span class="line">    <span class="comment">//调用工具类解决缓存击穿</span></span><br><span class="line">    Shop shop = cacheClient.queryWithPassThrough(CACHE_SHOP_KEY, id, Shop.<span class="keyword">class</span>, <span class="keyword">this</span>::getById, CACHE_SHOP_TTL, TimeUnit.MINUTES);</span><br><span class="line">    <span class="keyword">if</span>(shop==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;店铺不存在！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok(shop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：成功会对不存在的店铺空值进行缓存。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-113.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-115.png" alt="img"></p><p>接下来拷贝queryWithLogicalExpire的代码到CacheClient类中进行改写：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> final <span class="title class_">ExecutorService</span> <span class="variable constant_">CACHE_REBUILD_EXECUTOR</span> = <span class="title class_">Executors</span>.<span class="title function_">newFixedThreadPool</span>(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">public</span> &lt;R,<span class="variable constant_">ID</span>&gt; R <span class="title function_">queryWithLogicalExpire</span>(<span class="params"><span class="title class_">String</span> keyPrefix,ID id,<span class="title class_">Class</span>&lt;R&gt; <span class="keyword">type</span>,<span class="title class_">Function</span>&lt;ID,R&gt; dbFallBack,<span class="title class_">Long</span> time,<span class="title class_">TimeUnit</span> unit</span>)&#123;</span><br><span class="line">    <span class="title class_">String</span> key = keyPrefix + id;</span><br><span class="line">    <span class="comment">//1.从Redis查询缓存</span></span><br><span class="line">    <span class="title class_">String</span> shopJson = stringRedisTemplate.<span class="title function_">opsForValue</span>().<span class="title function_">get</span>(key);</span><br><span class="line">    <span class="comment">//2.判断是否存在</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">StrUtil</span>.<span class="title function_">isBlank</span>(shopJson))&#123;</span><br><span class="line">        <span class="comment">//3.不存在，返回空</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4.命中，需要先把json反序列化为对象</span></span><br><span class="line">    <span class="title class_">RedisData</span> redisData = <span class="title class_">JSON</span>Util.<span class="title function_">toBean</span>(shopJson, <span class="title class_">RedisData</span>.<span class="property">class</span>);</span><br><span class="line">    <span class="title class_">JSON</span><span class="built_in">Object</span> data = (<span class="title class_">JSON</span><span class="built_in">Object</span>) redisData.<span class="title function_">getData</span>();</span><br><span class="line">    R r = <span class="title class_">JSON</span>Util.<span class="title function_">toBean</span>(data, <span class="keyword">type</span>);</span><br><span class="line">    <span class="comment">//5.判断是否过期</span></span><br><span class="line">    <span class="comment">//5.1 未过期直接返回店铺信息</span></span><br><span class="line">    <span class="title class_">LocalDateTime</span> expireTime = redisData.<span class="title function_">getExpireTime</span>();</span><br><span class="line">    <span class="keyword">if</span>(expireTime.<span class="title function_">isAfter</span>(<span class="title class_">LocalDateTime</span>.<span class="title function_">now</span>()))&#123;</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//5.2 已过期重建缓存</span></span><br><span class="line">    <span class="comment">//6.缓存重建</span></span><br><span class="line">    <span class="comment">//6.1.获取互斥锁</span></span><br><span class="line">    <span class="title class_">String</span> lockKey = <span class="variable constant_">LOCK_SHOP_KEY</span> + id;</span><br><span class="line">    <span class="built_in">boolean</span> isLock = <span class="title function_">tryLock</span>(lockKey);</span><br><span class="line">    <span class="comment">//6.2.判断是否获取互斥锁成功</span></span><br><span class="line">    <span class="keyword">if</span>(isLock)&#123;</span><br><span class="line">        <span class="comment">//6.3.成功，开启独立线程，实现缓存重建</span></span><br><span class="line">        <span class="variable constant_">CACHE_REBUILD_EXECUTOR</span>.<span class="title function_">submit</span>(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//查询数据库</span></span><br><span class="line">                R r1 = dbFallBack.<span class="title function_">apply</span>(id);</span><br><span class="line">                <span class="comment">//写入redis</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">setWithLogicalExpire</span>(key,r1,time,unit);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="title function_">unLock</span>(lockKey);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6.4.失败，返回过期的商铺信息</span></span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">boolean</span> <span class="title function_">tryLock</span>(<span class="params"><span class="title class_">String</span> key</span>)&#123;</span><br><span class="line">    <span class="title class_">Boolean</span> flag = stringRedisTemplate.<span class="title function_">opsForValue</span>().<span class="title function_">setIfAbsent</span>(key, <span class="string">&quot;1&quot;</span>, <span class="number">10</span>, <span class="title class_">TimeUnit</span>.<span class="property">SECONDS</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">BooleanUtil</span>.<span class="title function_">isTrue</span>(flag);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">unLock</span>(<span class="params"><span class="title class_">String</span> key</span>)&#123;</span><br><span class="line">    stringRedisTemplate.<span class="title function_">delete</span>(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-125.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-126.png" alt="img"></p><p>改写test下的HmDianPingApplicationTests类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HmDianPingApplicationTests</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> CacheClient cacheClient;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ShopServiceImpl shopService;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testSaveShop</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Shop</span> <span class="variable">shop</span> <span class="operator">=</span> shopService.getById(<span class="number">1L</span>);</span><br><span class="line">        cacheClient.setWithLogicalExpire(CACHE_SHOP_KEY+<span class="number">1L</span>,shop,<span class="number">10L</span>,TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：首先运行HmDianPingApplicationTests类里的测试方法，10秒后逻辑过期，此时运行后台程序，修改数据库1号商铺的name字段，此时访问：localhost:8080/api/shop/1 会出现效果第1次访问为缓存旧值，然后发现缓存过期开始重建，第2次访问开始就是新值。数据库也只有1次重建。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-116.png" alt="img"></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-117.png" alt="img"></p><h2 id="3、优惠卷秒杀">3、优惠卷秒杀</h2><h3 id="3-1-全局唯一ID">3.1 -全局唯一ID</h3><p>每个店铺都可以发布优惠券，当用户抢购时，就会生成订单并保存到tb_voucher_order这张表中，而订单表如果使用数据库自增ID会存在一些问题。</p><p>1.id的规律性太明显。</p><p>2.受单表数据量的限制（分表之后每张表都自增长，id会出现重复）。</p><p><strong>全局ID生成器</strong>：是一种在分布式系统下用来生成全局唯一ID的工具，一般要满足下列特性：</p><p>1.唯一性。2.高可用。3.高性能。4.递增性。5.安全性。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-127.png" alt="img"></p><p>为了增加ID的安全性，我们可以不直接使用Redis自增的数值，而是拼接一些其它信息：</p><p>ID的组成部分：符号位：1bit，永远为0代表整数</p><p>时间戳：31bit，以秒为单位，定义了一个起始时间，用当前时间减起始时间，预估可以使用69年。</p><p>序列号：32bit，秒内的计数器，支持每秒产生2^32个不同ID</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-128.png" alt="img"></p><h3 id="3-2-Redis实现全局唯一Id">3.2 -Redis实现全局唯一Id</h3><p>在utils包下定义一个RedisWorker类，是一个基于Redis的ID生成器。</p><p>如果只使用一个key来自增记录有一个坏处，最终key的自增数量会突破容量的上限，假如自增超过32位彼时便无法再存储新的数据，解决的方案是采用拼接日期。</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisIdWorker</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="built_in">long</span> BEGIN_TIMESTAMP = <span class="number">1640995200</span>L;</span><br><span class="line">    <span class="comment">//序列号的位数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="built_in">int</span> COUNT_BITS=<span class="number">32</span>;</span><br><span class="line">    <span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> RedisIdWorker(StringRedisTemplate stringRedisTemplate) &#123;</span><br><span class="line">        <span class="keyword">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span>  <span class="built_in">long</span> nextId(String keyPrefix)&#123;</span><br><span class="line">        <span class="comment">//1.生成时间戳</span></span><br><span class="line">        LocalDateTime now = LocalDateTime.now();</span><br><span class="line">        <span class="built_in">long</span> timeStamp = now.toEpochSecond(ZoneOffset.UTC) - BEGIN_TIMESTAMP;</span><br><span class="line">        <span class="comment">//2.生成序列号</span></span><br><span class="line">        <span class="comment">//2.1获取当前日期，精确到天</span></span><br><span class="line">        String <span class="built_in">date</span> = now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy:MM:dd&quot;</span>));</span><br><span class="line">        <span class="comment">//2.2自增长</span></span><br><span class="line">        <span class="built_in">long</span> <span class="keyword">count</span> = stringRedisTemplate.opsForValue().increment(<span class="string">&quot;icr:&quot;</span> + keyPrefix + <span class="string">&quot;:&quot;</span> + <span class="built_in">date</span>);</span><br><span class="line">        <span class="comment">//3.拼接并返回</span></span><br><span class="line">        <span class="keyword">return</span> timeStamp &lt;&lt; COUNT_BITS | <span class="keyword">count</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在HmDianPingApplicationTests中写入如下的测试代码：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Resource</span><br><span class="line"><span class="keyword">private</span> ShopServiceImpl shopService;</span><br><span class="line">@Resource</span><br><span class="line"><span class="keyword">private</span> RedisIdWorker redisIdWorker;</span><br><span class="line"><span class="keyword">private</span> ExecutorService es = Executors.<span class="built_in">newFixedThreadPool</span>(<span class="number">500</span>);</span><br><span class="line">@<span class="function">Test</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">testIdWorker</span><span class="params">()</span> throws InterruptedException </span>&#123;</span><br><span class="line">    CountDownLatch latch = <span class="keyword">new</span> <span class="built_in">CountDownLatch</span>(<span class="number">300</span>);</span><br><span class="line">    Runnable task = ()-&gt;&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)&#123;</span><br><span class="line">            <span class="type">long</span> id = redisIdWorker.<span class="built_in">nextId</span>(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">            System.out.<span class="built_in">println</span>(<span class="string">&quot;id=&quot;</span>+id);</span><br><span class="line">        &#125;</span><br><span class="line">        latch.<span class="built_in">countDown</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">long</span> begin = System.<span class="built_in">currentTimeMillis</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">300</span>;i++)&#123;</span><br><span class="line">        es.<span class="built_in">submit</span>(task);</span><br><span class="line">    &#125;</span><br><span class="line">    latch.<span class="built_in">await</span>();</span><br><span class="line">    <span class="type">long</span> end = System.<span class="built_in">currentTimeMillis</span>();</span><br><span class="line">    System.out.<span class="built_in">println</span>(<span class="string">&quot;Result Time = &quot;</span> + (end-begin));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行之后可以看到以十进制输出的所有编号</p><p>可以在Redis中看到自增长的结果，1次是30000：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-130.png" alt="img"></p><p>大概2秒可以生成3万条，速度还是可以的。</p><p>全局唯一ID生成策略：</p><p>1.UUID利用JDK自带的工具类即可生成，生成的是16进制的字符串，无单调递增的特性。</p><p>2.Redis自增（每天一个key，方便统计订单量。时间戳+计数器的格式。）</p><p>3.snowflake雪花算法（不依赖于Redis，性能更好，对于时钟依赖）</p><p>4.数据库自增</p><h2 id="🧩-与其他-ID-生成方案对比">🧩 与其他 ID 生成方案对比</h2><table><thead><tr><th>方法</th><th>特点</th><th>优缺点</th></tr></thead><tbody><tr><td><strong>UUID</strong></td><td>通过 JDK 提供 <code>UUID.randomUUID()</code></td><td>保证唯一，但无序、长度大，不适合排序和数据库主键</td></tr><tr><td><strong>Redis 自增（本例）</strong></td><td>时间戳 + 自增</td><td>并发高，易于控制和拆分，但依赖 Redis</td></tr><tr><td><strong>雪花算法（Snowflake）</strong></td><td>Twitter 开源的分布式 ID 方案</td><td>性能高，不依赖 Redis，但需要精确的机器时间</td></tr><tr><td><strong>数据库自增主键</strong></td><td>利用数据库主键自增</td><td>简单但性能差，分布式下易冲突或失效</td></tr></tbody></table><h3 id="3-3-添加优惠卷">3.3 添加优惠卷</h3><p>每个店铺都可以发放优惠券，分为平价券和特价券。平价券可以任意抢购，特价券需要秒杀抢购。</p><p>tb_voucher：优惠券基本信息，优惠金额，使用规则等。</p><p>tb_seckill_voucher：优惠券的库存，开始抢购时间，结束抢购时间，只有特价优惠券才需要填写这些信息。</p><p>而代金券由于优惠力度大，所以像第二种卷，就得限制数量，从表结构上也能看出，特价卷除了具有优惠卷的基本信息以外，还具有库存，抢购时间，结束时间等等字段</p><p>请求的信息如下：</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;shopId&quot;</span>:<span class="number">1</span>,</span><br><span class="line"><span class="string">&quot;title&quot;</span>:<span class="string">&quot;100元代金券&quot;</span>,</span><br><span class="line"><span class="string">&quot;subTitle&quot;</span>:<span class="string">&quot;周一至周五均可使用&quot;</span>,</span><br><span class="line"><span class="string">&quot;rules&quot;</span>:<span class="string">&quot;全场通用<span class="char escape_">\n</span>无需预约<span class="char escape_">\n</span>可无限叠加<span class="char escape_">\不</span>兑现、不找零<span class="char escape_">\n</span>仅限堂食&quot;</span>,</span><br><span class="line"><span class="string">&quot;payValue&quot;</span>:<span class="number">8000</span>,</span><br><span class="line"><span class="string">&quot;actualValue&quot;</span>:<span class="number">10000</span>,</span><br><span class="line"><span class="string">&quot;type&quot;</span>:<span class="number">1</span>,</span><br><span class="line"><span class="string">&quot;stock&quot;</span>:<span class="number">100</span>,</span><br><span class="line"><span class="string">&quot;beginTime&quot;</span>:<span class="string">&quot;2024-04-10T10:09:17&quot;</span>,</span><br><span class="line"><span class="string">&quot;endTime&quot;</span>:<span class="string">&quot;2024-04-11T12:09:04&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>新增普通卷代码：</strong></p><p>VoucherController</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@PostMapping</span></span><br><span class="line">public Result <span class="built_in">addVoucher</span>(<span class="variable">@RequestBody</span> Voucher voucher) &#123;</span><br><span class="line">    <span class="selector-tag">voucherService</span><span class="selector-class">.save</span>(voucher);</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">Result</span><span class="selector-class">.ok</span>(voucher.<span class="built_in">getId</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>新增秒杀卷代码：</strong></p><p><strong>VoucherController</strong></p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@PostMapping</span>(<span class="string">&quot;seckill&quot;</span>)</span><br><span class="line">public Result <span class="built_in">addSeckillVoucher</span>(<span class="variable">@RequestBody</span> Voucher voucher) &#123;</span><br><span class="line">    <span class="selector-tag">voucherService</span><span class="selector-class">.addSeckillVoucher</span>(voucher);</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">Result</span><span class="selector-class">.ok</span>(voucher.<span class="built_in">getId</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>VoucherServiceImpl</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSeckillVoucher</span><span class="params">(Voucher voucher)</span> &#123;</span><br><span class="line">    <span class="comment">// 保存优惠券</span></span><br><span class="line">    save(voucher);</span><br><span class="line">    <span class="comment">// 保存秒杀信息</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillVoucher</span>();</span><br><span class="line">    seckillVoucher.setVoucherId(voucher.getId());</span><br><span class="line">    seckillVoucher.setStock(voucher.getStock());</span><br><span class="line">    seckillVoucher.setBeginTime(voucher.getBeginTime());</span><br><span class="line">    seckillVoucher.setEndTime(voucher.getEndTime());</span><br><span class="line">    seckillVoucherService.save(seckillVoucher);</span><br><span class="line">    <span class="comment">// 保存秒杀库存到Redis中</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(SECKILL_STOCK_KEY + voucher.getId(), voucher.getStock().toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-4-实现秒杀下单">3.4 实现秒杀下单</h3><p>下单核心思路：当我们点击抢购时，会触发右侧的请求，我们只需要编写对应的controller即可</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-132.png" alt="img"></p><p>秒杀下单应该思考的内容：</p><p>下单时需要判断两点：</p><ul><li>秒杀是否开始或结束，如果尚未开始或已经结束则无法下单</li><li>库存是否充足，不足则无法下单</li></ul><p>下单核心逻辑分析：</p><p>当用户开始进行下单，我们应当去查询优惠卷信息，查询到优惠卷信息，判断是否满足秒杀条件</p><p>比如时间是否充足，如果时间充足，则进一步判断库存是否足够，如果两者都满足，则扣减库存，创建订单，然后返回订单id，如果有一个条件不满足则直接结束。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-134.png" alt="img"></p><p>在VouchrOrderController类中：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@RestController</span></span><br><span class="line"><span class="variable">@RequestMapping</span>(<span class="string">&quot;/voucher-order&quot;</span>)</span><br><span class="line">public class VoucherOrderController &#123;</span><br><span class="line">  <span class="variable">@Resource</span></span><br><span class="line">   private IVoucherService voucherService;</span><br><span class="line">   <span class="variable">@PostMapping</span>(<span class="string">&quot;seckill/&#123;id&#125;&quot;</span>)</span><br><span class="line">    public Result <span class="built_in">seckillVoucher</span>(<span class="variable">@PathVariable</span>(<span class="string">&quot;id&quot;</span>) Long voucherId) &#123;</span><br><span class="line">           <span class="selector-tag">return</span> <span class="selector-tag">voucherService</span><span class="selector-class">.seckillVoucher</span>(voucherId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在IVoucherOrderService中写入如下代码：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">interface</span> <span class="symbol">IVoucherOrderService</span> <span class="symbol">extends</span> <span class="symbol">IService</span> &#123;</span><br><span class="line">        Result seckillVoucher(Long voucherId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在VoucherOrderServiceImpl中写入如下代码：</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VoucherOrderServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">VoucherOrderMapper</span>, <span class="title">VoucherOrder</span>&gt; <span class="keyword">implements</span> <span class="title">IVoucherOrderService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisIdWorker redisIdWorker;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">Result <span class="title">seckillVoucher</span><span class="params">(Long voucherId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1.查询优惠券信息</span></span><br><span class="line">        SeckillVoucher voucher = seckillVoucherService.getById(voucherId);</span><br><span class="line">        <span class="comment">//2.判断秒杀是否开始</span></span><br><span class="line">        <span class="comment">//2.1秒杀尚未开始返回异常</span></span><br><span class="line">        <span class="keyword">if</span>(voucher.getBeginTime().isAfter(LocalDateTime.now()))&#123;</span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;秒杀尚未开始&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//2.2秒杀已结束返回异常</span></span><br><span class="line">        <span class="keyword">if</span>(voucher.getEndTime().isBefore(LocalDateTime.now()))&#123;</span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;秒杀已经结束&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.判断库存是否充足</span></span><br><span class="line">        <span class="keyword">if</span>(voucher.getStock()&lt;<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="comment">//3.1库存不足返回异常</span></span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;库存不足！&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.2库存充足扣减库存</span></span><br><span class="line">        <span class="keyword">boolean</span> success = seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>)</span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).update();</span><br><span class="line">        <span class="keyword">if</span>(!success)&#123;</span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;库存不足！&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//4.创建订单，返回订单id</span></span><br><span class="line">        VoucherOrder voucherOrder = <span class="keyword">new</span> VoucherOrder();</span><br><span class="line">        <span class="keyword">long</span> orderId = redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);<span class="comment">//订单id</span></span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        Long userId = UserHolder.getUser().getId();<span class="comment">//用户id</span></span><br><span class="line">        voucherOrder.setUserId(userId);</span><br><span class="line">        voucherOrder.setVoucherId(voucherId);<span class="comment">//代金券id</span></span><br><span class="line">        save(voucherOrder);</span><br><span class="line">        <span class="function"><span class="keyword">return</span> Result.<span class="title">ok</span><span class="params">(orderId)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-5-库存超卖问题分析">3.5 库存超卖问题分析</h3><p>假设线程1过来查询库存，判断出来库存大于1，正准备去扣减库存，但是还没有来得及去扣减，此时线程2过来，线程2也去查询库存，发现这个数量一定也大于1，那么这两个线程都会去扣减库存，最终多个线程相当于一起去扣减库存，此时就会出现库存的超卖问题。</p><p>正常逻辑：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-137.png" alt="img"></p><p>非正常逻辑：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-135.png" alt="img"></p><p>超卖问题是典型的多线程安全问题，针对这一问题的常见解决方案就是加锁：而对于加锁，我们通常有两种解决方案：见下图：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-138.png" alt="img"></p><p><strong>悲观锁：</strong></p><p>悲观锁可以实现对于数据的串行化执行，比如syn，和lock都是悲观锁的代表，同时，悲观锁中又可以再细分为公平锁，非公平锁，可重入锁，等等</p><p><strong>乐观锁：</strong></p><p>乐观锁：会有一个版本号，每次操作数据会对版本号+1，再提交回数据时，会去校验是否比之前的版本大1 ，如果大1 ，则进行操作成功，这套机制的核心逻辑在于，如果在操作过程中，版本号只比原来大1 ，那么就意味着操作过程中没有人对他进行过修改，他的操作就是安全的，如果不大1，则数据被修改过，当然乐观锁还有一些变种的处理方式比如cas</p><p>乐观锁的典型代表：就是cas，利用cas进行无锁化机制加锁，var5 是操作前读取的内存值，while中的var1+var2 是预估值，如果预估值 == 内存值，则代表中间没有被人修改过，此时就将新值去替换 内存值</p><p>其中do while 是为了在操作失败时，再次进行自旋操作，即把之前的逻辑再操作一次。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">int var5;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    var5 = <span class="keyword">this</span>.getIntVolatile(var1, var2);</span><br><span class="line">&#125; <span class="keyword">while</span>(!<span class="keyword">this</span>.compareAndSwapInt(var1, var2, var5, var5 + var4));</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> var5;</span><br></pre></td></tr></table></figure><p><strong>课程中的使用方式：</strong></p><p>课程中的使用方式是没有像cas一样带自旋的操作，也没有对version的版本号+1 ，他的操作逻辑是在操作时，对版本号进行+1 操作，然后要求version 如果是1 的情况下，才能操作，那么第一个线程在操作后，数据库中的version变成了2，但是他自己满足version=1 ，所以没有问题，此时线程2执行，线程2 最后也需要加上条件version =1 ，但是现在由于线程1已经操作过了，所以线程2，操作时就不满足version=1 的条件了，所以线程2无法执行成功</p><p><strong>版本号法：</strong></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-139.png" alt="img"></p><p><strong>CAS法</strong>（版本号法的简化版）：查询的时候把库存查出来，更新的时候判断库存和之前查到的库存是否一致，如果一致则更新数据。</p><h3 id="3-6-乐观锁解决超卖问题">3.6 乐观锁解决超卖问题</h3><p>只需加上下面这段代码即可：.eq(“stock”,voucher.getStock()) 。用于比较当前数据库的库存值和之前查询到的库存值是否相同，只有相同时才可以执行set语句。</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//<span class="number">3.2</span>库存充足扣减库存</span><br><span class="line">boolean success = seckillVoucherService.update()</span><br><span class="line">        .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>) //相当于set条件 set stock = stock - <span class="number">1</span></span><br><span class="line">        .e<span class="string">q(&quot;voucher_id&quot;, voucherId)</span> //相当于where条件 where id = ? <span class="keyword">and</span> stock = ?</span><br><span class="line">        .e<span class="string">q(&quot;stock&quot;,voucher.getStock()</span>).update();</span><br></pre></td></tr></table></figure><p>但经过测试现在出现了异常值偏高的问题，正常的请求大约只占10%。</p><p>原理是因为：假如一次有30个线程涌入，查询到库存值为100，只有1个线程能把值改为99，其它29个线程比对库存值99发现和自己查询到的库存值100不同，所以都认为数据已经被修改过，所以都失败了。</p><p>现在只需要保证stock&gt;0即可，只要存量大于0就可以任意扣减。</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> success = seckillVoucherService.<span class="keyword">update</span>()</span><br><span class="line">        .setSql(&quot;stock = stock - 1&quot;) //相当于<span class="keyword">set</span>条件 <span class="keyword">set</span> stock = stock - <span class="number">1</span></span><br><span class="line">        .eq(&quot;voucher_id&quot;, voucherId) //相当于<span class="keyword">where</span>条件 <span class="keyword">where</span> id = ? <span class="keyword">and</span> stock = ?</span><br><span class="line">        .gt(&quot;stock&quot;,<span class="number">0</span>).<span class="keyword">update</span>();</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-141.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-143.png" alt="img"></p><p>乐观锁缺陷：</p><p>需要大量对数据库进行访问，容易导致数据库的崩溃。</p><p>总结：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-144.png" alt="img"></p><h3 id="3-7优惠券秒杀-一人一单">3.7优惠券秒杀-一人一单</h3><p>需求：修改秒杀业务，要求同一个优惠券，一个用户只能下一单</p><p>问题分析：优惠卷是为了引流，但是目前的情况是，一个人可以无限制的抢这个优惠卷，所以我们应当增加一层逻辑，让一个用户只能下一个单，而不是让一个用户下多个单</p><p>具体操作逻辑如下：比如时间是否充足，如果时间充足，则进一步判断库存是否足够，然后再根据优惠卷id和用户id查询是否已经下过这个订单，如果下过这个订单，则不再下单，否则进行下单</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-156.png" alt="img"></p><p>❌ 错误方式：锁整个方法（比如 <code>synchronized public void createVoucherOrder()</code>）</p><p><strong>问题</strong>：所有用户都会竞争同一个锁，系统性能会很差（串行执行，效率极低）</p><p>✅ 正确方式：只对同一个用户加锁</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">synchronized</span>(<span class="params">userId.toString().intern()</span>) &#123; ... &#125;</span><br></pre></td></tr></table></figure><p><code>.intern()</code> 会让字符串引用变成常量池中的共享对象，相同内容就是同一个锁。</p><p><strong>为什么用 <code>.intern()</code>？</strong></p><p>因为 <code>toString()</code> 每次是新对象，锁不生效。</p><p>但是因为事务是在函数执行结束之后由Spring进行提交，如果把锁加在createVoucherOrder内部其实有点小——因为如果解锁之后，其它线程可以进入，而此时事务尚未提交，仍然会导致安全性问题。</p><h3 id="🔁-事务控制注意事项">🔁 <strong>事务控制注意事项</strong></h3><p><strong>问题点</strong>：Spring 的 <code>@Transactional</code> 只对代理对象生效。</p><p><strong>错误方式</strong>：直接在当前类中内部调用 <code>createVoucherOrder()</code>，事务不生效！</p><p><strong>解决方式</strong>：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IVoucherOrderService proxy <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy()<span class="comment">;</span></span><br><span class="line">return proxy.createVoucherOrder(voucherId)<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>这就是用当前线程的代理对象来调用方法，事务才能起作用。</p><p><strong>因此最终方案</strong>是把synchronized加在createVoucherOrder的方法外部，锁住的是用户id。</p><p><code>seckillVoucher()</code> 方法（外层逻辑 + 加锁 + 事务代理调用）</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">synchronized (userId.toString().intern()) &#123;</span><br><span class="line">    IVoucherOrderService proxy <span class="operator">=</span> (IVoucherOrderService) AopContext.currentProxy()<span class="comment">;</span></span><br><span class="line">    return proxy.createVoucherOrder(voucherId)<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="createVoucherOrder-方法（真正创建订单的逻辑，带事务）"><code>createVoucherOrder()</code> 方法（真正创建订单的逻辑，带事务）</h4><ul><li>先查询是否已经有订单（保证一人一单）。</li><li>如果没有，再扣库存。</li><li>然后创建订单并保存。</li></ul><p>总结：关于代理对象事务的问题：通常情况下，当一个使用了@Transactional注解的方法被调用时，Spring会从上下文中获取一个代理对象来管理事务。</p><p>但是如果加@Transactional方法是被同一个类中的另一个方法调用时，Spring不会使用代理对象，而是直接调用该方法，导致事务注解失效。</p><p>为避免这种情况，可以使用AopContext.currentProxy方法获取当前的代理对象，然后通过代理对象调用被@Transactional注解修饰的方法，确保事务生效。</p><p>在VoucherOrderServiceImpl中写入如下代码（注意：ctrl+alt+m可以把含有return的代码段进行提取）：</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VoucherOrderServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">VoucherOrderMapper</span>, <span class="title">VoucherOrder</span>&gt; <span class="keyword">implements</span> <span class="title">IVoucherOrderService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ISeckillVoucherService seckillVoucherService;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisIdWorker redisIdWorker;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">Result <span class="title">seckillVoucher</span><span class="params">(Long voucherId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1.查询优惠券信息</span></span><br><span class="line">        SeckillVoucher voucher = seckillVoucherService.getById(voucherId);</span><br><span class="line">        <span class="comment">//2.判断秒杀是否开始</span></span><br><span class="line">        <span class="comment">//2.1秒杀尚未开始返回异常</span></span><br><span class="line">        <span class="keyword">if</span>(voucher.getBeginTime().isAfter(LocalDateTime.now()))&#123;</span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;秒杀尚未开始&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//2.2秒杀已结束返回异常</span></span><br><span class="line">        <span class="keyword">if</span>(voucher.getEndTime().isBefore(LocalDateTime.now()))&#123;</span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;秒杀已经结束&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        voucher = seckillVoucherService.getById(voucherId);</span><br><span class="line">        <span class="comment">//3.判断库存是否充足</span></span><br><span class="line">        <span class="keyword">if</span>(voucher.getStock()&lt;<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="comment">//3.1库存不足返回异常</span></span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;库存不足！&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Long userId = UserHolder.getUser().getId();</span><br><span class="line">        <span class="keyword">synchronized</span> (userId.toString().intern())&#123;</span><br><span class="line">            <span class="comment">//获取代理对象</span></span><br><span class="line">            IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">            <span class="function"><span class="keyword">return</span> proxy.<span class="title">createVoucherOrder</span><span class="params">(voucherId)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function">Result <span class="title">createVoucherOrder</span><span class="params">(Long voucherId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//6.一人一单</span></span><br><span class="line">        Long userId = UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//6.1查询订单</span></span><br><span class="line">        <span class="keyword">int</span> count = query().eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId).count();</span><br><span class="line">        <span class="comment">//6.2判断是否存在</span></span><br><span class="line">        <span class="keyword">if</span>(count&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">//用户已经购买过了</span></span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;用户已经购买过一次！&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.2库存充足扣减库存</span></span><br><span class="line">        <span class="keyword">boolean</span> success = seckillVoucherService.update()</span><br><span class="line">                .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>) <span class="comment">//相当于set条件 set stock = stock - 1</span></span><br><span class="line">                .eq(<span class="string">&quot;voucher_id&quot;</span>, voucherId) <span class="comment">//相当于where条件 where id = ? and stock = ?</span></span><br><span class="line">                .gt(<span class="string">&quot;stock&quot;</span>,<span class="number">0</span>).update();</span><br><span class="line">        <span class="keyword">if</span>(!success)&#123;</span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;库存不足！&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//4.创建订单，返回订单id</span></span><br><span class="line">        VoucherOrder voucherOrder = <span class="keyword">new</span> VoucherOrder();</span><br><span class="line">        <span class="keyword">long</span> orderId = redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);<span class="comment">//订单id</span></span><br><span class="line">        voucherOrder.setId(orderId);</span><br><span class="line">        voucherOrder.setUserId(userId);</span><br><span class="line">        voucherOrder.setVoucherId(voucherId);<span class="comment">//代金券id</span></span><br><span class="line">        save(voucherOrder);</span><br><span class="line">        <span class="function"><span class="keyword">return</span> Result.<span class="title">ok</span><span class="params">(orderId)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在IVoucherOrderService接口中加入下面这个方法：</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable"><span class="class">Result</span></span> <span class="function"><span class="title">createVoucherOrder</span>(<span class="variable">Long</span> <span class="variable">voucherId</span>);</span></span><br></pre></td></tr></table></figure><p>在pom.xml中引入如下的依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在启动类HmDianPingApplication上加如下注解：</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableAspectJAutoProxy</span>(exposeProxy = <span class="keyword">true</span>)</span><br></pre></td></tr></table></figure><p>测试： 成功实现一名用户只能领取一张优惠券。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-157-1024x137.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-158-1024x111.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-159.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-160.png" alt="img"></p><h3 id="3-8-集群环境下的并发问题">3.8 集群环境下的并发问题</h3><p>通过加锁可以解决在单机情况下的一人一单安全问题，但是在集群模式下就不行了。</p><p>如下图可以设置项目启动的端口号，确保启动的项目之间端口号不同:</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-164.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-163.png" alt="img"></p><p>在nginx.conf中放开8082的这个配置：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-165.png" alt="img"></p><p>向下面这个页面发送请求：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost:<span class="number">8080</span><span class="regexp">/api/</span>voucher<span class="regexp">/list/</span><span class="number">1</span></span><br></pre></td></tr></table></figure><p>可以看到请求会分别被8082和8081接收，是轮询的效果：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-166.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-167.png" alt="img"></p><p>首先到tb_voucher_order把之前的订单删除，到tb_seckill_voucher中把stock重新改回100。</p><p>准备2个相同的秒杀请求：要注意请求的地址是：<a href="http://localhost:8080/api/voucher-order/seckill/13">http://localhost:8080/api/voucher-order/seckill/13</a></p><p>我这里直接用Jemeter来进行测试，模拟高并发场景：</p><p>下面是效果：可以看到并发请求能够同时进入集群的每台结点。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-169.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-170.png" alt="img"></p><p>正常情况：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-172.png" alt="img"></p><h3 id="单机下的锁控制（第一张图）">单机下的锁控制（第一张图）</h3><p>这一张图展示了多个线程在同一个 JVM 中操作的场景，用来说明单机下通过 <code>synchronized</code> 锁对象控制一人一单的机制 <strong>是有效的</strong>。</p><h4 id="✅-关键流程：">✅ 关键流程：</h4><ol><li><strong>线程1 和 线程2</strong> 分别尝试为同一用户下订单。</li><li>线程1 拿到了锁，执行完“查询是否已有订单”，判断没有，于是创建新订单，释放锁。</li><li>线程2 此时等待线程1释放锁，再做同样的流程。</li><li>但线程2执行到查询订单时，已经能查到订单，<strong>所以不会重复下单</strong>。</li></ol><h4 id="✅-结论：">✅ 结论：</h4><blockquote><p>单 JVM 下，同一个用户加锁是生效的，能有效防止并发时的重复下单。</p></blockquote><p>由于现在我们部署了多个tomcat，每个tomcat都有一个属于自己的jvm，那么假设在服务器A的tomcat内部，有两个线程，这两个线程由于使用的是同一份代码，那么他们的锁对象是同一个，是可以实现互斥的，但是如果现在是服务器B的tomcat内部，又有两个线程，但是他们的锁对象写的虽然和服务器A一样，但是锁对象却不是同一个，所以线程3和线程4可以实现互斥，但是却无法和线程1和线程2实现互斥，这就是 集群环境下，syn锁失效的原因，在这种情况下，我们就需要使用分布式锁来解决这个问题。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-173.png" alt="img"></p><h3 id="❌-集群下的锁失效问题（第二张图）">❌ 集群下的锁失效问题（第二张图）</h3><h4 id="左侧：JVM1（Tomcat-A）">左侧：JVM1（Tomcat A）</h4><ul><li>线程1 加锁成功，正在下单；</li><li>线程2 来了，在等待释放锁。</li></ul><h4 id="右侧：JVM2（Tomcat-B）">右侧：JVM2（Tomcat B）</h4><ul><li>线程3 是同一个用户的请求，但由于 JVM2 的锁对象和 JVM1 的锁对象<strong>不是同一个实例</strong>，所以也能加锁成功；</li><li>同样线程4 跟进等待线程3；</li></ul><h4 id="🧨-问题产生：">🧨 问题产生：</h4><p>虽然线程1和线程3锁的<strong>代码</strong>看起来是一样的，但因为<strong>JVM不一样，锁对象不是同一个</strong>，所以线程3并不知道线程1已经在处理下单逻辑了。</p><p>结果：</p><ul><li>JVM1 和 JVM2 各自都创建了一份订单，<strong>违反了一人一单的规则</strong>！</li></ul><p>现在就要实现让多个JVM使用的是同一把锁。跨JVM、跨进程的锁。</p><h2 id="4、分布式锁">4、分布式锁</h2><h3 id="4-1-、基本原理和实现方式对比">4.1 、基本原理和实现方式对比</h3><p>什么是分布式锁?</p><p>满足分布式系统或集群模式下多进程可见并且互斥的锁.(所有服务器都能访问的共享锁系统)</p><p>分布式锁的核心思想就是让大家都使用同一把锁，只要大家使用的是同一把锁，那么我们就能锁住线程，不让线程进行，让程序串行执行，这就是分布式锁的核心思路</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-174.png" alt="img"></p><p>那么分布式锁他应该满足一些什么样的条件呢？</p><ul><li>可见性：多个线程都能看到相同的结果，注意：这个地方说的可见性并不是并发编程中指的内存可见性，只是说多个进程之间都能感知到变化的意思</li><li>互斥：互斥是分布式锁的最基本的条件，使得程序串行执行</li><li>高可用：程序不易崩溃，时时刻刻都保证较高的可用性</li><li>高性能：由于加锁本身就让性能降低，所有对于分布式锁本身需要他就较高的加锁性能和释放锁性能</li><li>安全性：安全也是程序中必不可少的一环</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-175.png" alt="img"></p><p>常见的分布式锁有三种</p><ul><li>Mysql：mysql本身就带有锁机制，但是由于mysql性能本身一般，所以采用分布式锁的情况下，其实使用mysql作为分布式锁比较少见</li><li>Redis：redis作为分布式锁是非常常见的一种使用方式，现在企业级开发中基本都使用redis或者zookeeper作为分布式锁，利用setnx这个方法，如果插入key成功，则表示获得到了锁，如果有人插入成功，其他人插入失败则表示无法获得到锁，利用这套逻辑来实现分布式锁</li><li>Zookeeper：zookeeper也是企业级开发中较好的一个实现分布式锁的方案，由于本套视频并不讲解zookeeper的原理和分布式锁的实现，所以不过多阐述</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-176.png" alt="img"></p><h3 id="4-2-、Redis分布式锁的实现核心思路">4.2 、Redis分布式锁的实现核心思路</h3><p>你可以把它理解成在 Redis 里“占一个位置”，谁先占上就有执行权，其它人就得等。</p><p>实现分布式锁时需要实现的两个基本方法：</p><h4 id="4-2-1实现-Redis-锁最核心的就两个指令：">4.2.1实现 Redis 锁最核心的就两个指令：</h4><p><strong>1. <code>SETNX</code>（Set if Not Exists）</strong></p><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SETNX <span class="keyword">lock</span> thread1</span><br></pre></td></tr></table></figure><p>意思是：“如果这个 <code>lock</code> 键不存在，就设置为 <code>thread1</code>。”</p><ul><li><strong>成功返回 1</strong>：说明你拿到锁了；</li><li><strong>失败返回 0</strong>：说明别人已经抢先拿到锁。</li></ul><h3 id="2-DEL：释放锁">2. <code>DEL</code>：释放锁</h3><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEL <span class="keyword">lock</span></span><br></pre></td></tr></table></figure><p>释放锁，表示任务做完了，别人可以来了。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-177.png" alt="img"></p><h4 id="4-2-2设置过期时间，避免死锁">4.2.2设置过期时间，避免死锁</h4><h3 id="为什么需要加-EXPIRE？">为什么需要加 <code>EXPIRE</code>？</h3><p>假设：</p><ul><li>线程1 拿到了锁；</li><li>但它崩溃了，没来得及释放锁（<code>DEL</code> 没执行）；</li><li>那这把锁就<strong>永远卡在那里</strong>了，别人都拿不到！</li></ul><p>解决办法：<strong>设置锁的自动过期时间</strong>，例如 5 秒钟：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">EXPIRE</span> lock <span class="number">5</span></span><br></pre></td></tr></table></figure><p>然后可以用 <code>TTL lock</code> 查看锁剩下多少秒：</p><ul><li>正常返回剩余时间；</li><li>如果返回 -1，说明没有过期时间，会死锁；</li><li>如果返回 -2，说明锁已经不存在。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-178.png" alt="img"></p><h4 id="4-2-3避免-SETNX-和-EXPIRE-之间的间隙">4.2.3避免 <code>SETNX</code> 和 <code>EXPIRE</code> 之间的间隙</h4><p>问题来了：<br>如果你分两步执行——先 <code>SETNX</code> 拿锁，再 <code>EXPIRE</code> 设置过期时间，在这中间一旦宕机，就会出问题。</p><p>正确做法：用 Redis 的一条原子指令</p><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">lock</span> thread EX <span class="number">10</span> NX</span><br></pre></td></tr></table></figure><p>解释：</p><ul><li><code>EX 10</code>：设置过期时间 10 秒；</li><li><code>NX</code>：只有在 key 不存在时才设置；</li><li>这是 Redis 的原子操作，<strong>设置值+过期+互斥一次完成</strong>！</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-179.png" alt="img"></p><p>加锁效果演示</p><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">lock</span> thread EX <span class="number">10</span> NXOK</span><br></pre></td></tr></table></figure><p>说明加锁成功。</p><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">lock</span> thread EX <span class="number">10</span> NXnull</span><br></pre></td></tr></table></figure><p>说明锁已存在，加锁失败。</p><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TTL <span class="keyword">lock</span></span><br><span class="line"><span class="number">7</span></span><br></pre></td></tr></table></figure><p>说明锁还有 7 秒就会自动释放。</p><h4 id="4-2-4加锁与释放的正确流程总结">4.2.4加锁与释放的正确流程总结</h4><ul><li>获取锁：<ul><li>互斥性：确保只能有一个线程获取锁成功</li><li>非阻塞：尝试一次，成功返回true，失败返回false</li><li>自动过期：避免死锁</li></ul></li><li>释放锁：<ul><li>手动释放（业务完成后 <code>DEL</code>）</li><li>超时释放：获取锁时添加一个超时时间</li></ul></li></ul><h3 id="4-3-实现分布式锁版本一">4.3 实现分布式锁版本一</h3><p>在utils下面创建一个ILock接口：</p><p>这一步是做接口编程，便于后期扩展（比如换 Redisson 或 ZooKeeper 锁时，不改业务逻辑）</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ILock</span> </span>&#123;</span><br><span class="line">    <span class="comment">//尝试获取锁</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(<span class="keyword">long</span> timeoutSec)</span></span>;</span><br><span class="line">    <span class="comment">//释放锁</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在utils下面实现SimpleRedisLock类：</p><h3 id="细节解释：">细节解释：</h3><ul><li><code>threadId</code>：当前线程的唯一标识，设置为锁的值，便于后期扩展安全性；</li><li><code>setIfAbsent</code>：就是 Redis 的 <code>SET key value NX EX</code> 操作；</li><li><code>timeoutSec</code>：自动过期时间，防止死锁；</li><li><code>delete</code>：释放锁，直接删掉对应 Redis key。</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleRedisLock</span> <span class="keyword">implements</span> <span class="title class_">ILock</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">String</span> name;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">StringRedisTemplate</span> stringRedisTemplate;</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">SimpleRedisLock</span>(<span class="title class_">String</span> name, <span class="title class_">StringRedisTemplate</span> stringRedisTemplate) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">stringRedisTemplate</span> = stringRedisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> final <span class="title class_">String</span> <span class="variable constant_">KEY_PREFIX</span> = <span class="string">&quot;lock:&quot;</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">boolean</span> <span class="title function_">tryLock</span>(<span class="params">long timeoutSec</span>) &#123;</span><br><span class="line">        <span class="comment">//获取线程标示</span></span><br><span class="line">        long threadId = <span class="title class_">Thread</span>.<span class="title function_">currentThread</span>().<span class="title function_">getId</span>();</span><br><span class="line">        <span class="title class_">Boolean</span> success = stringRedisTemplate.<span class="title function_">opsForValue</span>().<span class="title function_">setIfAbsent</span>(<span class="variable constant_">KEY_PREFIX</span>+name,threadId+<span class="string">&quot;&quot;</span>,timeoutSec, <span class="title class_">TimeUnit</span>.<span class="property">SECONDS</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Boolean</span>.<span class="property">TRUE</span>.<span class="title function_">equals</span>(success);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">unlock</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">//释放锁</span></span><br><span class="line">        stringRedisTemplate.<span class="title function_">delete</span>(<span class="variable constant_">KEY_PREFIX</span>+name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>更改VoucherOrderServiceImpl类中的seckillVoucher方法的代码：</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedisIdWorker redisIdWorker;</span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function">Result <span class="title">seckillVoucher</span><span class="params">(Long voucherId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1.查询优惠券信息</span></span><br><span class="line">    SeckillVoucher voucher = seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">//2.判断秒杀是否开始</span></span><br><span class="line">    <span class="comment">//2.1秒杀尚未开始返回异常</span></span><br><span class="line">    <span class="keyword">if</span>(voucher.getBeginTime().isAfter(LocalDateTime.now()))&#123;</span><br><span class="line">        <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;秒杀尚未开始&quot;</span>)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.2秒杀已结束返回异常</span></span><br><span class="line">    <span class="keyword">if</span>(voucher.getEndTime().isBefore(LocalDateTime.now()))&#123;</span><br><span class="line">        <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;秒杀已经结束&quot;</span>)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    voucher = seckillVoucherService.getById(voucherId);</span><br><span class="line">    <span class="comment">//3.判断库存是否充足</span></span><br><span class="line">    <span class="keyword">if</span>(voucher.getStock()&lt;<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="comment">//3.1库存不足返回异常</span></span><br><span class="line">        <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;库存不足！&quot;</span>)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Long userId = UserHolder.getUser().getId();</span><br><span class="line">    SimpleRedisLock lock = <span class="keyword">new</span> SimpleRedisLock(<span class="string">&quot;order:&quot;</span>+userId,stringRedisTemplate);</span><br><span class="line">    <span class="keyword">boolean</span> isLock = lock.tryLock(<span class="number">1200</span>);</span><br><span class="line">    <span class="comment">//判断是否获取锁成功</span></span><br><span class="line">    <span class="keyword">if</span>(!isLock) &#123;</span><br><span class="line">        <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;不允许重复下单&quot;</span>)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//获取代理对象</span></span><br><span class="line">        IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">        <span class="function"><span class="keyword">return</span> proxy.<span class="title">createVoucherOrder</span><span class="params">(voucherId)</span></span>;</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>核心代码：</strong></p><p>在 <code>VoucherOrderServiceImpl</code> 里替换原来的加锁方式，改用 <code>SimpleRedisLock</code>：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SimpleRedisLock <span class="keyword">lock</span> = <span class="built_in">new</span> SimpleRedisLock(&quot;order:&quot; + userId, stringRedisTemplate);</span><br><span class="line"><span class="type">boolean</span> isLock = <span class="keyword">lock</span>.tryLock(<span class="number">1200</span>);</span><br></pre></td></tr></table></figure><p>如果加锁成功，就调用代理对象创建订单；失败就说明这个用户已经在处理中，拒绝重复下单。</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;不允许重复下单&quot;</span>)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">    <span class="function"><span class="keyword">return</span> proxy.<span class="title">createVoucherOrder</span><span class="params">(voucherId)</span></span>;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    lock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>经测试多台节点相同用户只能获取同一张优惠券成功：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-180.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-181.png" alt="img"></p><p>目前这个锁实现 <strong>仍有风险</strong>：</p><ul><li>❗️直接 delete key，<strong>没有验证是否是自己加的锁就删了</strong>（容易误删别人的锁）；</li><li>❗️如果执行时间超过了过期时间（比如 2 秒），锁会自动释放，但任务还没做完，另一个线程就可能抢到锁并重复执行！</li></ul><p>这些问题后面会通过加<strong>唯一标识 + Lua 脚本释放锁</strong>方式改进。</p><h3 id="4-4Redis分布式锁误删情况说明">4.4Redis分布式锁误删情况说明</h3><p>如果你没有校验“这把锁是不是我加的”，就可能会发生这种错误：</p><blockquote><p>一个线程因为卡顿或网络问题，<strong>等它醒来时，这把锁已经被别人拿走了，但它还以为是自己的，就把别人的锁删了！</strong></p></blockquote><p>逻辑说明：</p><p>持有锁的线程在锁的内部出现了阻塞，导致他的锁自动释放，这时其他线程，线程2来尝试获得锁，就拿到了这把锁，然后线程2在持有锁执行过程中，线程1反应过来，继续执行，而线程1执行过程中，走到了删除锁逻辑，此时就会把本应该属于线程2的锁进行删除，这就是误删别人锁的情况说明</p><p>解决方案：解决方案就是在每个线程释放锁的时候，去判断一下当前这把锁是否属于自己，如果属于自己，则不进行锁的删除，假设还是上边的情况，线程1卡顿，锁自动释放，线程2进入到锁的内部执行逻辑，此时线程1反应过来，然后删除锁，但是线程1，一看当前这把锁不是属于自己，于是不进行删除锁逻辑，当线程2走到删除锁逻辑时，如果没有卡过自动释放锁的时间点，则判断当前这把锁是属于自己的，于是删除这把锁。</p><p><strong>总结一句话就是</strong>：<strong>不要用 <code>delete</code> 直接释放锁</strong>，一定要检查“这把锁是不是我加的”再删，<strong>用 Lua 脚本保证原子性</strong>，否则就会在多线程或多机器环境下删错别人的锁！</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-183-1024x428.png" alt="img"></p><h4 id="图中流程详解">图中流程详解</h4><h4 id="▶-线程1：">▶ 线程1：</h4><ul><li>成功加锁并执行业务逻辑；</li><li>中途“卡住了”（可能是网络、GC 等卡顿）；</li><li>锁过期后，<strong>自动释放</strong>；</li><li>线程1 后续恢复，<strong>继续执行 delete</strong>，但这时锁已经不是它的了！</li></ul><h4 id="▶-线程2：">▶ 线程2：</h4><ul><li>线程1卡住时，锁过期；</li><li>它尝试加锁，成功（因为 Redis 已自动释放）；</li><li>它开始执行自己的业务。</li></ul><h4 id="▶-问题来了：">▶ 问题来了：</h4><ul><li>线程1 <strong>后知后觉</strong>地恢复并执行 <code>DEL lock</code>；</li><li>此时锁的值已变成线程2的标识；</li><li>但它仍然执行 delete，<strong>误删了线程2的锁</strong>！</li><li>线程3 也进来了，它就能获取锁，造成并发访问，<strong>逻辑错乱</strong>！</li></ul><h3 id="4-5-解决Redis分布式锁误删问题">4.5 解决Redis分布式锁误删问题</h3><p>目标：锁释放前先校验“锁是我加的”</p><p>新需求：</p><ul><li>加锁时：存入<strong>线程标识</strong>（如：UUID + Thread ID）；</li><li>解锁时：先取出 Redis 里的标识；<ul><li>如果和当前线程一致：才能删锁；</li><li>否则：不删，防止误删。</li></ul></li></ul><p>核心逻辑：在存入锁时，放入自己线程的标识，在删除锁时，判断当前这把锁的标识是不是自己存入的，如果是，则进行删除，如果不是，则不进行删除。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-184.png" alt="img"></p><p>首先要修改SimpleRedisLock里面的如下代码，主要是调用hutool工具包生成UUID（每次线程调用都会生成一个唯一的UUID），让Redis的前缀变成UUID+线程ID：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ID_PREFIX</span> <span class="operator">=</span> UUID.fastUUID().toString(<span class="literal">true</span>)+<span class="string">&quot;-&quot;</span>;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> timeoutSec)</span> &#123;</span><br><span class="line">    <span class="comment">//获取线程标示</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">threadId</span> <span class="operator">=</span> ID_PREFIX + Thread.currentThread().getId();</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">success</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(KEY_PREFIX+name,threadId,timeoutSec, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">return</span> Boolean.TRUE.equals(success);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在要修改的是SimpleRedisLock类里面的unlock方法，主要是比较当前线程的标示和Redis中锁的标示是否一致，只有标示一致才能释放锁：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">unlock</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">//获取线程标示</span></span><br><span class="line">    <span class="title class_">String</span> threadId = <span class="variable constant_">ID_PREFIX</span> + <span class="title class_">Thread</span>.<span class="title function_">currentThread</span>().<span class="title function_">getId</span>();</span><br><span class="line">    <span class="comment">//获取锁中的标示</span></span><br><span class="line">    <span class="title class_">String</span> id = stringRedisTemplate.<span class="title function_">opsForValue</span>().<span class="title function_">get</span>(<span class="variable constant_">KEY_PREFIX</span> + name);</span><br><span class="line">    <span class="keyword">if</span>(threadId.<span class="title function_">equals</span>(id))&#123;</span><br><span class="line">        <span class="comment">//释放锁</span></span><br><span class="line">        stringRedisTemplate.<span class="title function_">delete</span>(<span class="variable constant_">KEY_PREFIX</span>+name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>总结一句话：通过加“线程唯一标识”，并在释放锁时比对这个标识，成功解决 Redis 分布式锁的<strong>误删问题</strong>，确保只有“加锁者”才能“解锁”。</p><h3 id="4-6-分布式锁的原子性问题">4.6 分布式锁的原子性问题</h3><p>更为极端的误删逻辑说明：</p><p>线程1现在持有锁之后，在执行业务逻辑过程中，他正准备删除锁，而且已经走到了条件判断的过程中，比如他已经拿到了当前这把锁确实是属于他自己的，正准备删除锁，但是此时他的锁到期了，那么此时线程2进来，但是线程1他会接着往后执行，当他卡顿结束后，他直接就会执行删除锁那行代码，相当于条件判断并没有起到作用，这就是删锁时的原子性问题，之所以有这个问题，是因为线程1的拿锁，比锁，删锁，实际上并不是原子性的，我们要防止刚才的情况发生，</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-186-1024x441.png" alt="img"></p><ul><li><strong>线程1</strong> 获取锁成功（锁标识是线程1的 UUID）；</li><li>执行业务；</li><li>准备释放锁，<strong>正在判断锁是不是自己的</strong>（这个时候判断成功）；</li><li>但是！<strong>就在这一步之后线程1突然被卡住</strong>（阻塞或宕机）；</li><li>锁超时后被 Redis 自动释放；</li><li><strong>线程2、线程3</strong> 先后获取锁并执行业务；</li><li>线程1 醒来，继续往下执行 delete，<strong>把线程2或3的锁删掉了</strong>！！</li></ul><h4 id="关键问题：判断-删除不是原子操作">关键问题：<strong>判断 + 删除不是原子操作</strong></h4><p>这两个操作之间一旦出现“卡顿、延迟、调度切换”等非预期情况，就可能导致你<strong>误删了别人的锁</strong>，即便你之前已经做了线程标识校验。</p><p>解决方案：<strong>用 Lua 脚本让“判断+删除”原子执行</strong></p><h3 id="4-7-Lua脚本解决多条命令原子性问题">4.7 Lua脚本解决多条命令原子性问题</h3><h4 id="为什么用-Lua？">为什么用 Lua？</h4><blockquote><p>答：Redis 提供的 <code>EVAL</code> 命令支持在服务端运行 Lua 脚本，能让多个 Redis 命令组成 <strong>一个不可拆分的原子操作</strong>。</p></blockquote><p>Redis提供Lua脚本功能，在一个脚本中编写多条Redis命令，确保多条命令执行时的原子性。</p><p>Lua是一种编程语言，它的基本语法可以参考网站：<a href="https://www.runoob.com/lua/lua-tutorial.html">https://www.runoob.com/lua/lua-tutorial.html</a></p><h4 id="4-7-1Lua-脚本基本语法">4.7.1Lua 脚本基本语法</h4><p>这里重点介绍Redis提供的调用函数，语法如下：</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.<span class="built_in">call</span>(<span class="string">&#x27;命令名称&#x27;</span>, <span class="string">&#x27;key&#x27;</span>, <span class="string">&#x27;其它参数&#x27;</span>, ...)</span><br></pre></td></tr></table></figure><p>例如，我们要执行set name jack，则脚本是这样：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 执行 <span class="keyword">set</span> <span class="type">name</span> jack</span><br><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;jack&#x27;</span>)</span><br></pre></td></tr></table></figure><p>例如，我们要先执行set name Rose，再执行get name，则脚本如下：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 先执行 <span class="keyword">set</span> <span class="type">name</span> jack</span><br><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;Rose&#x27;</span>)</span><br><span class="line"># 再执行 <span class="keyword">get</span> <span class="type">name</span></span><br><span class="line"><span class="keyword">local</span> <span class="type">name</span> = redis.<span class="keyword">call</span>(<span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;name&#x27;</span>)</span><br><span class="line"># 返回</span><br><span class="line"><span class="keyword">return</span> <span class="type">name</span></span><br></pre></td></tr></table></figure><h4 id="4-7-2-使用-EVAL-调用脚本">4.7.2 使用 EVAL 调用脚本</h4><p>写好脚本以后，需要用Redis命令来调用脚本，调用脚本的常见命令如下：</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">EVAL</span> <span class="string">&quot;脚本内容&quot;</span> numkeys key1 [key2 …] arg1 [arg2 …]</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-187-1024x233.png" alt="img"></p><p>例如，我们要执行 redis.call(‘set’, ‘name’, ‘jack’) 这个脚本，语法如下：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-188.png" alt="img"></p><h4 id="4-7-3-参数动态传入方式">4.7.3. 参数动态传入方式</h4><p>如果脚本中的key、value不想写死，可以作为参数传递。key类型参数会放入KEYS数组，其它参数会放入ARGV数组，在脚本中可以从KEYS和ARGV数组获取这些参数：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-189-1024x137.png" alt="img"></p><ul><li><code>1</code>：表示有一个 key 参数</li><li><code>KEYS[1] = name</code>，<code>ARGV[1] = Rose</code></li></ul><p>接下来我们来回一下我们释放锁的逻辑：</p><p>目标：让以下逻辑变成一个原子操作：</p><ol><li>读取锁的值</li><li>比较值是否等于当前线程标识</li><li>如果一致，释放锁</li><li>如果不一致，不做任何操作</li></ol><p>如果用Lua脚本来表示则是这样的：</p><p>最终我们操作redis的拿锁比锁删锁的lua脚本就会变成这样</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 这里的 KEYS[1] 就是锁的key，这里的ARGV[1] 就是当前线程标示</span></span><br><span class="line"><span class="comment">-- 获取锁中的标示，判断是否与当前线程标示一致</span></span><br><span class="line"><span class="keyword">if</span> (redis.<span class="keyword">call</span>(<span class="string">&#x27;GET&#x27;</span>, KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>]) <span class="keyword">then</span></span><br><span class="line">  <span class="comment">-- 一致，则删除锁</span></span><br><span class="line">  <span class="keyword">return</span> redis.<span class="keyword">call</span>(<span class="string">&#x27;DEL&#x27;</span>, KEYS[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 不一致，则直接返回</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><h4 id="总结一句话">总结一句话</h4><blockquote><p>把“判断是不是自己 + 删除锁”这两步放进 Lua 脚本中交给 Redis 原子执行，彻底解决分布式锁的并发安全问题。</p><h3 id="4-8-利用Java代码调用Lua脚本改造分布式锁">4.8 利用Java代码调用Lua脚本改造分布式锁</h3><p>在SimpleRedisLock中写入如下的代码，因为我们希望的是在一开始就将Lua的脚本加载好，而不是等到要调用释放锁的时候再去加载Lua脚本，所以采用静态变量和静态代码块，这些部分在类初始化的时候就会被加载：</p></blockquote><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DefaultRedisScript&lt;<span class="keyword">Long</span>&gt; UNLOCK_SCRIPT;</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">     UNLOCK_SCRIPT = <span class="keyword">new</span> DefaultRedisScript&lt;&gt;();</span><br><span class="line">     UNLOCK_SCRIPT.setLocation(<span class="keyword">new</span> ClassPathResource(<span class="string">&quot;unlock.lua&quot;</span>));</span><br><span class="line">     UNLOCK_SCRIPT.setResultType(<span class="keyword">Long</span>.<span class="keyword">class</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="说明：">说明：</h3><ul><li><code>DefaultRedisScript</code> 是 Spring 提供的类；</li><li><code>setLocation</code> 是加载 Lua 脚本文件；</li><li><code>setResultType</code> 是告诉 Redis 你这个脚本要返回什么类型。</li></ul><blockquote><p>在SimpleRedisLock类的unlock方法中写入如下的代码：</p><p>在 <code>SimpleRedisLock</code> 的 <code>unlock()</code> 方法中，替换原来的 delete 逻辑：</p></blockquote><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Override</span></span><br><span class="line">public void <span class="built_in">unlock</span>() &#123;</span><br><span class="line">    <span class="selector-tag">stringRedisTemplate</span><span class="selector-class">.execute</span>(UNLOCK_SCRIPT,</span><br><span class="line">            Collections.<span class="built_in">singletonList</span>(KEY_PREFIX+name),</span><br><span class="line">            ID_PREFIX + Thread.<span class="built_in">currentThread</span>().<span class="built_in">getId</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这段代码在执行 Lua 脚本时：</p><ul><li><code>KEYS[1] = lock:order:xxx</code>（锁的 key）；</li><li><code>ARGV[1] = UUID-threadId</code>（锁的值，用于身份验证）；</li></ul><p><strong>RedisTemplate 是如何执行 Lua 的？</strong></p><p>我们的RedisTemplate中，可以利用execute方法去执行lua脚本，参数对应关系就如下图股</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-190-1024x476.png" alt="img"></p><p><strong>测试逻辑：</strong></p><p>第一个线程进来，得到了锁，手动删除锁，模拟锁超时了，其他线程会执行lua来抢锁，当第一天线程利用lua删除锁时，lua能保证他不能删除他的锁，第二个线程删除锁时，利用lua同样可以保证不会删除别人的锁，同时还能保证原子性。</p><p>在程序1和程序2的下面这个位置打上断点：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-191.png" alt="img"></p><p>在测试API中测试访问如下的URL：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="regexp">//</span>localhost:<span class="number">8080</span><span class="regexp">/api/</span>voucher-order<span class="regexp">/seckill/</span><span class="number">14</span></span><br></pre></td></tr></table></figure><p>分别测试秒杀优惠券1和2：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-192.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-193.png" alt="img"></p><p>在Redis中能看到程序1获取锁成功，然后直接把lock锁删掉，模拟超时释放的情况：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-194.png" alt="img"></p><p>然后让程序2往下走一步，可以看到程序2获取到了锁</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-195.png" alt="img"></p><p>然后可以直接放行程序1，会看到结果是程序2加的锁没有被删除。</p><p>最后放行程序2，会看到程序2加的锁被删除。</p><p>小总结：</p><p>基于Redis的分布式锁实现思路：</p><ul><li>利用set nx ex获取锁，并设置过期时间，保存线程标示</li><li>释放锁时先判断线程标示是否与自己一致，一致则删除锁</li><li>特性：<ul><li>利用set nx满足互斥性</li><li>利用set ex保证故障时锁依然能释放，避免死锁，提高安全性</li><li>利用Redis集群保证高可用和高并发特性</li></ul></li></ul><p>笔者总结：我们一路走来，利用添加过期时间，防止死锁问题的发生，但是有了过期时间之后，可能出现误删别人锁的问题，这个问题我们开始是利用删之前 通过拿锁，比锁，删锁这个逻辑来解决的，也就是删之前判断一下当前这把锁是否是属于自己的，但是现在还有原子性问题，也就是我们没法保证拿锁比锁删锁是一个原子性的动作，最后通过lua表达式来解决这个问题</p><p>已经把 Redis 分布式锁从“能用”优化到“高并发可安全用”的版本，使用 Lua 脚本在 Java 中原子释放锁，是实现这一切的关键一步。</p><p>但是目前还剩下一个问题锁不住，什么是锁不住呢，你想一想，如果当过期时间到了之后，我们可以给他续期一下，比如续个30s，就好像是网吧上网， 网费到了之后，然后说，来，网管，再给我来10块的，是不是后边的问题都不会发生了，那么续期问题怎么解决呢，可以依赖于我们接下来要学习redission啦</p><h2 id="5、分布式锁-redission">5、分布式锁-redission</h2><h3 id="5-1-分布式锁-redission功能介绍">5.1 分布式锁-redission功能介绍</h3><p>基于setnx实现的分布式锁存在下面的问题：</p><ol><li><strong>不可重入</strong></li></ol><ul><li><p>含义：同一个线程在还没释放锁时，又想再次获取这个锁，不能成功（会被自己阻塞）；</p></li><li><p>举例：就像你在方法 A 拿了锁，然后方法 A 又调用了 B，而 B 又要拿同一把锁，就挂住了；</p></li><li><p><strong>风险</strong>：递归调用/多层封装下容易死锁；</p></li><li><p><code>synchronized</code>/<code>ReentrantLock</code> 是可重入的，而原始 Redis 实现不是。</p></li><li><p><strong>不可重试</strong></p></li><li><p>含义：获取失败一次就放弃，没有“等待+重试”机制；</p></li><li><p><strong>问题</strong>：并发环境下，很多线程抢锁失败后立刻返回，<strong>不能等待排队</strong>，业务体验差。</p></li><li><p><strong>超时释放有风险</strong></p></li><li><p>加锁时设置了过期时间，防止死锁；</p></li><li><p><strong>但</strong>：如果业务执行时间过长，锁先过期了；</p></li><li><p>别人进来抢锁，你业务还没做完；</p></li><li><p>即使你用 Lua 判断 + 删除，也只能避免误删，但<strong>无法保证锁一定有效到你业务真正执行完毕</strong>；</p></li><li><p><strong>结论</strong>：需要“锁续期机制”来保持锁有效！</p></li><li><p><strong>主从一致性问题（分布式集群）</strong></p></li><li><p>Redis 使用主从集群时，写入数据是先写主节点，再同步给从节点；</p></li><li><p>如果在写成功前主节点挂了，但从节点没有拿到同步数据，<strong>从节点会认为锁没被加，导致锁被重复加</strong>；</p></li><li><p><strong>结果：多个线程同时进入临界区，锁形同虚设</strong>；</p></li><li><p>这个问题是 Redis 本身架构的弱点，单靠你手写逻辑不好处理。</p></li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-196.png" alt="img"></p><h4 id="总结一句话：">总结一句话：</h4><blockquote><p>自己写的 Redis 分布式锁，虽然能用，但存在 <strong>不可重入、不可续期、无排队、不稳定</strong> 等问题，在真正生产环境里不够健壮。</p></blockquote><p><strong>什么是Redission呢</strong></p><p>Redisson 是一个基于 Redis 的 Java 客户端框架，它封装了很多分布式服务，其中包括各种类型的 <strong>分布式锁实现</strong>，还带有“自动续期”、“可重入”、“公平锁”、“读写锁”等高级功能。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-203.png" alt="img"></p><h3 id="5-2-分布式锁-Redission快速入门">5.2 分布式锁-Redission快速入门</h3><p>第1步，先引入依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.13.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>第2步，在config包下创建RedissonConfig类，写入如下代码：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    @<span class="function">Bean</span></span><br><span class="line"><span class="function">    <span class="keyword">public</span> RedissonClient <span class="title">redissonClient</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 配置</span></span><br><span class="line">        Config config = <span class="keyword">new</span> <span class="built_in">Config</span>();</span><br><span class="line">        config.<span class="built_in">useSingleServer</span>().<span class="built_in">setAddress</span>(<span class="string">&quot;redis://192.168.150.101:6379&quot;</span>)</span><br><span class="line">            .<span class="built_in">setPassword</span>(<span class="string">&quot;123321&quot;</span>);</span><br><span class="line">        <span class="comment">// 创建RedissonClient对象</span></span><br><span class="line">        <span class="keyword">return</span> Redisson.<span class="built_in">create</span>(config);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="说明：-2">说明：</h3><ul><li>创建并注册 <code>RedissonClient</code> Bean；</li><li>使用 <code>useSingleServer()</code> 表示你使用的是单机 Redis（后期可以切换为集群模式）；</li><li>注意地址前缀是 <code>redis://</code>；</li><li>密码如果 Redis 没设可以不写 <code>.setPassword(...)</code>。</li></ul><p>第3步，引入RedissonClient，调用getLock获取锁对象，然后用tryLock获取锁。</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@Resource</span><br><span class="line"><span class="keyword">private</span> RedissionClient redissonClient;</span><br><span class="line"></span><br><span class="line">@Test</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testRedisson</span>() throws Exception</span>&#123;</span><br><span class="line">    <span class="comment">//获取锁(可重入)，指定锁的名称</span></span><br><span class="line">    RLock <span class="keyword">lock</span> = redissonClient.getLock(<span class="string">&quot;anyLock&quot;</span>);</span><br><span class="line">    <span class="comment">//尝试获取锁，参数分别是：获取锁的最大等待时间(期间会重试)，锁自动释放时间，时间单位</span></span><br><span class="line">    boolean isLock = <span class="keyword">lock</span>.tryLock(<span class="number">1</span>,<span class="number">10</span>,TimeUnit.SECONDS);</span><br><span class="line">    <span class="comment">//判断获取锁成功</span></span><br><span class="line">    <span class="keyword">if</span>(isLock)&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            System.<span class="keyword">out</span>.println(<span class="string">&quot;执行业务&quot;</span>);          </span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            <span class="comment">//释放锁</span></span><br><span class="line">            <span class="keyword">lock</span>.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>参数说明：</p><p><code>tryLock(1, 10, TimeUnit.SECONDS)</code>：</p><ul><li><strong>1 秒内尝试获取锁</strong>（抢不到就放弃）；</li><li>锁持有 <strong>10 秒后自动释放</strong>；</li></ul><p><code>lock.unlock()</code>：安全释放锁，防止阻塞；</p><p>Redisson 内部已经自动实现了线程标识、防误删、自动续期等逻辑。</p><p>在 VoucherOrderServiceImpl</p><p>注入RedissonClient</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function">Result <span class="title">seckillVoucher</span><span class="params">(Long voucherId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1.查询优惠券</span></span><br><span class="line">        SeckillVoucher voucher = seckillVoucherService.getById(voucherId);</span><br><span class="line">        <span class="comment">// 2.判断秒杀是否开始</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;</span><br><span class="line">            <span class="comment">// 尚未开始</span></span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;秒杀尚未开始！&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3.判断秒杀是否已经结束</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;</span><br><span class="line">            <span class="comment">// 尚未开始</span></span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;秒杀已经结束！&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4.判断库存是否充足</span></span><br><span class="line">        <span class="keyword">if</span> (voucher.getStock() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 库存不足</span></span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;库存不足！&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Long userId = UserHolder.getUser().getId();</span><br><span class="line">        <span class="comment">//创建锁对象 这个代码不用了，因为我们现在要使用分布式锁</span></span><br><span class="line">        <span class="comment">//SimpleRedisLock lock = new SimpleRedisLock(&quot;order:&quot; + userId, stringRedisTemplate);</span></span><br><span class="line">        RLock lock = redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span> + userId);</span><br><span class="line">        <span class="comment">//获取锁对象</span></span><br><span class="line">        <span class="keyword">boolean</span> isLock = lock.tryLock();</span><br><span class="line">       </span><br><span class="line">        <span class="comment">//加锁失败</span></span><br><span class="line">        <span class="keyword">if</span> (!isLock) &#123;</span><br><span class="line">            <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(<span class="string">&quot;不允许重复下单&quot;</span>)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//获取代理对象(事务)</span></span><br><span class="line">            IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">            <span class="function"><span class="keyword">return</span> proxy.<span class="title">createVoucherOrder</span><span class="params">(voucherId)</span></span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//释放锁</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h3 id="说明：-3">说明：</h3><ul><li><code>lock:order:userId</code>：给每个用户设置唯一的锁，防止同一用户重复下单；</li><li>使用 <code>tryLock()</code> 获取锁（默认立即尝试获取一次）；</li><li>Redisson 自动处理续期和线程隔离（不需要你手动判断 UUID + 线程 ID）；</li><li>释放锁直接调用 <code>.unlock()</code>，更简单更安全。</li></ul><p>第4步，启动服务</p><p>发送下面的请求：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-198.png" alt="img"></p><p>在执行释放锁的语句前，可以看到Redis中有锁的记录：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-199.png" alt="img"></p><p>用jmeter来测试，可以发现没有出现并发安全问题：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-200.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-201.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-202.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-204.png" alt="img"></p><h3 id="5-3-分布式锁-redission可重入锁原理">5.3 分布式锁-redission可重入锁原理</h3><h4 id="5-3-1重入锁的概念（本地锁和分布式锁通用）">5.3.1<strong>重入锁的概念（本地锁和分布式锁通用）</strong></h4><p>可重入锁（Reentrant Lock）允许 <strong>同一个线程重复获取同一把锁</strong>。</p><ul><li>例如一个线程调用了两次 <code>lock.lock()</code>，只要线程一致，不会死锁。解锁时必须解锁两次才彻底释放。</li></ul><h4 id="5-3-2本地锁（如-Java-ReentrantLock）的实现机制">5.3.2<strong>本地锁（如 Java ReentrantLock）的实现机制</strong></h4><ul><li><p>通过一个</p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatile <span class="keyword">state</span></span><br></pre></td></tr></table></figure><p>状态变量控制重入次数。</p><ul><li>初始状态：<code>state = 0</code> 表示没人持有。</li><li>第一次获取：<code>state = 1</code></li><li>同一线程再次获取：<code>state += 1</code></li><li>每次释放：<code>state -= 1</code></li><li>当 <code>state == 0</code>，锁释放成功。</li></ul></li></ul><h4 id="5-3-3Redisson-可重入分布式锁实现原理">5.3.3<strong>Redisson 可重入分布式锁实现原理</strong></h4><h4 id="1-Redis-中如何存储锁？">1. Redis 中如何存储锁？</h4><ul><li><p>使用</p><p>Hash 结构</p><p>存储：</p><ul><li>Key：锁的名称（如 <code>&quot;lock&quot;</code>）</li><li>Field（小key）：<code>UUID:ThreadId</code> 表示哪个线程持有锁</li><li>Value：重入次数，例如 <code>1</code> 表示加锁了一次</li></ul></li></ul><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lock &#123;</span><br><span class="line">  thread1 : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2.锁的获取逻辑</strong></p><p>情况1：锁不存在，直接加锁</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> redis.<span class="keyword">call</span>(<span class="string">&#x27;exists&#x27;</span>, KEYS[<span class="number">1</span>]) == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">  redis.<span class="keyword">call</span>(<span class="string">&#x27;hset&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>], <span class="number">1</span>);</span><br><span class="line">  redis.<span class="keyword">call</span>(<span class="string">&#x27;pexpire&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">return</span> nil;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><ul><li>判断锁是否存在（<code>exists</code>）</li><li>如果不存在，设置 hash <code>field = threadId</code>，值为 1（加锁一次）</li><li>设置过期时间（防止死锁）</li><li>返回 <code>nil</code>，表示加锁成功</li></ul><p>情况2：锁存在，且是自己线程持有（可重入）</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if redis.call(<span class="string">&#x27;hexists&#x27;</span>, <span class="symbol">KEYS</span>[<span class="number">1</span>], <span class="symbol">ARGV</span>[<span class="number">2</span>]) == <span class="number">1</span> then</span><br><span class="line">  redis.call(<span class="string">&#x27;hincrby&#x27;</span>, <span class="symbol">KEYS</span>[<span class="number">1</span>], <span class="symbol">ARGV</span>[<span class="number">2</span>], <span class="number">1</span>);</span><br><span class="line">  redis.call(<span class="string">&#x27;pexpire&#x27;</span>, <span class="symbol">KEYS</span>[<span class="number">1</span>], <span class="symbol">ARGV</span>[<span class="number">1</span>]);</span><br><span class="line">  return nil;</span><br><span class="line">end</span><br></pre></td></tr></table></figure><ul><li>判断当前线程是否已持有（<code>hexists</code>）</li><li>如果是：<code>hincrby</code> 锁计数 +1</li><li>续期（<code>pexpire</code>）</li><li>返回 <code>nil</code> 表示加锁成功（重入）</li></ul><p>情况3：锁被其他线程持有</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">return</span> redis.<span class="title">call</span><span class="params">(<span class="string">&#x27;pttl&#x27;</span>, KEYS[<span class="number">1</span>])</span></span>;</span><br></pre></td></tr></table></figure><ul><li>返回剩余过期时间</li><li>Java 端根据返回值是否是 <code>null</code> 判断是否加锁成功，如果失败会进行 <strong>自旋重试</strong>（while(true) 循环）</li></ul><p>完整代码</p><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;if (redis.call(&#x27;</span>exists&#x27;, KEYS[<span class="number">1</span>]) == <span class="number">0</span>) <span class="keyword">then</span> <span class="string">&quot; +</span></span><br><span class="line"><span class="string">                  &quot;</span>redis.call(<span class="string">&#x27;hset&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>], <span class="number">1</span>); <span class="string">&quot; +</span></span><br><span class="line"><span class="string">                  &quot;</span>redis.call(<span class="string">&#x27;pexpire&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>]); <span class="string">&quot; +</span></span><br><span class="line"><span class="string">                  &quot;</span><span class="keyword">return</span> nil; <span class="string">&quot; +</span></span><br><span class="line"><span class="string">              &quot;</span><span class="keyword">end</span>; <span class="string">&quot; +</span></span><br><span class="line"><span class="string">              &quot;</span><span class="keyword">if</span> (redis.call(<span class="string">&#x27;hexists&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>]) == <span class="number">1</span>) <span class="keyword">then</span> <span class="string">&quot; +</span></span><br><span class="line"><span class="string">                  &quot;</span>redis.call(<span class="string">&#x27;hincrby&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">2</span>], <span class="number">1</span>); <span class="string">&quot; +</span></span><br><span class="line"><span class="string">                  &quot;</span>redis.call(<span class="string">&#x27;pexpire&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>]); <span class="string">&quot; +</span></span><br><span class="line"><span class="string">                  &quot;</span><span class="keyword">return</span> nil; <span class="string">&quot; +</span></span><br><span class="line"><span class="string">              &quot;</span><span class="keyword">end</span>; <span class="string">&quot; +</span></span><br><span class="line"><span class="string">              &quot;</span><span class="keyword">return</span> redis.call(<span class="string">&#x27;pttl&#x27;</span>, KEYS[<span class="number">1</span>]);<span class="string">&quot;</span></span><br></pre></td></tr></table></figure><p>5.3.4 释放锁的逻辑</p><ul><li>判断锁是不是自己加的（判断 field 是否是自己）</li><li><code>hincrby</code> 把锁值减1</li><li>如果减完为0，使用 <code>del</code> 删除整个锁</li><li>若不是自己线程，加锁失败</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-205-1024x443.png" alt="img"></p><p>代码说明：</p><ul><li>第一次 <code>tryLock()</code> 成功后，调用 <code>method2()</code> 再加一次锁，也成功，体现 <strong>可重入性</strong>。</li><li>每次 <code>unlock()</code> 只是让 <code>value -1</code>，直到为0，才释放 Redis 中的锁。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-207-1024x514.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-206-1024x468.png" alt="img"></p><h3 id="5-4-分布式锁-redission锁重试和WatchDog机制">5.4 分布式锁-redission锁重试和WatchDog机制</h3><h4 id="5-4-1Redisson-分布式锁中-tryLock-重试-WatchDog-自动续期的源码机制。">5.4.1Redisson 分布式锁中 tryLock 重试 + WatchDog 自动续期的源码机制。</h4><p>下面是对含有waitTime（等待时间）的tryLock的跟踪：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-208.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-209.png" alt="img"></p><p><strong>主题：<code>tryLock(long waitTime, TimeUnit unit)</code> 的源码调用链 + 默认看门狗时间为 30 秒</strong></p><p>你调用的是：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">tryLock</span><span class="params">(waitTime, unit)</span></span></span><br></pre></td></tr></table></figure><p>实际会调用重载方法：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">tryLock</span><span class="params">(waitTime, -<span class="number">1</span>L, unit)</span></span> <span class="comment">// -1 表示未指定超时时间</span></span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-210.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-211-1024x378.png" alt="img"></p><p>重点含义：</p><p><code>leaseTime = -1</code> 触发 <strong>WatchDog 看门狗机制</strong></p><p>默认配置 this.lockWatchdogTimeout = 30000L // 30秒</p><p>Lua 脚本说明</p><p>return redis.call(‘pttl’, KEYS[1]);</p><ul><li>返回当前锁剩余时间（毫秒）</li><li>如果锁被占用，则 Redisson 用这个值判断是否自旋重试</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-212.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-213.png" alt="img"></p><p><strong>主题：锁的获取流程和释放锁的 Lua 脚本实现逻辑</strong></p><p>获取锁逻辑：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ttl == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>; <span class="comment">// 加锁成功</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>否则进入剩余时间判断：是否还有等待机会。</p><p>释放锁逻辑（Redis 脚本）</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;del&#x27;</span>, KEYS[<span class="number">1</span>]);</span><br><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;publish&#x27;</span>, KEYS[<span class="number">2</span>], ARGV[<span class="number">1</span>]); <span class="comment">// 发布解锁通知</span></span><br></pre></td></tr></table></figure><p>当锁释放时，通过 Redis <code>publish</code> 发消息，通知其他线程“锁已释放”，以唤醒它们继续抢锁。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-214.png" alt="img"></p><p>说明 subscriberFuture.await：</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">subscriberFuture.await(<span class="built_in">time</span>, TimeUnit.MILLISECONDS);</span><br></pre></td></tr></table></figure><ul><li>等待一段时间内是否能收到锁释放的通知（订阅模式）</li><li>如果 <code>false</code>，表示<strong>超时未收到通知</strong></li></ul><p>后续继续抢锁：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">tryAcquire</span><span class="params">(waitTime, leaseTime, unit, threadId)</span></span></span><br></pre></td></tr></table></figure><p>会再调用这个方法尝试重新获取锁。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-215.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-216.png" alt="img"></p><p>Redisson 并非死等，而是结合“等待发布+主动抢锁”，避免资源浪费。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-217.png" alt="img"></p><p>主题：触发 WatchDog 续期的逻辑（重点）</p><p>条件判断：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (leaseTime <span class="operator">=</span><span class="operator">=</span> -<span class="number">1</span>) // 表示未指定锁时间</span><br></pre></td></tr></table></figure><p>那么 Redisson 将默认使用：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">getLockWatchdogTimeout</span><span class="params">()</span></span> = <span class="number">30</span>_000 ms</span><br></pre></td></tr></table></figure><p>成功加锁后调用：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">scheduleExpirationRenewal</span>(threadId); <span class="comment">// 开启续约机制</span></span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-218.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-219.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-220.png" alt="img"></p><p>主题：WatchDog 定时任务如何每 10 秒自动续期</p><p>核心逻辑：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.<span class="built_in">int</span>ernalLockLeaseTime / <span class="number">3</span></span><br></pre></td></tr></table></figure><p>默认锁时间是 30 秒，所以每 <strong>10秒调用一次</strong> <code>renewExpiration()</code>，实现持续续期。</p><p>Lua脚本中的续期操作：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;pexpire&#x27;</span>, KEYS[<span class="number">1</span>], ARGV[<span class="number">1</span>]); <span class="comment">// 续期锁有效时间</span></span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-221.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-222.png" alt="img"></p><p>主题：取消看门狗续期任务（释放锁时触发）</p><p>解锁后调用：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.cancelExpirationRenewal(threadId)</span><br></pre></td></tr></table></figure><ul><li>作用：停止定时器，释放线程资源</li><li>只有当锁真正释放或者线程结束时，才会取消续期逻辑，确保资源不浪费</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-223.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-224.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-225-1024x524.png" alt="img"></p><h4 id="加锁逻辑总结：">加锁逻辑总结：</h4><ul><li><p>ttl == null</p><p>：获取锁成功</p><ul><li>leaseTime == -1：开启自动续期（WatchDog）</li><li>leaseTime != -1：定时释放锁，不续期</li></ul></li><li><p>ttl != null</p><p>：获取锁失败</p><ul><li>剩余时间 &gt; 0：订阅解锁信号</li><li>等待并判断是否超时，进行下一轮尝试</li></ul></li></ul><h4 id="解锁逻辑：">解锁逻辑：</h4><ul><li>成功释放后，<code>publish</code> 发布消息通知等待线程</li><li>取消续约任务，清理 <code>EXIPRATION_RENEWAL_MAP</code></li></ul><p><strong>总结一句话：Redisson 分布式锁 = <code>Redis + Lua + Java定时任务</code> 实现了一个 可重入、自动续期、带发布通知机制的分布式锁系统，健壮且高性能。</strong></p><h4 id="5-4-2Redisson-的两种加锁方式">5.4.2Redisson 的两种加锁方式</h4><p>Redisson 的 <code>lock()</code> 方法分为两种情况：</p><table><thead><tr><th>方法</th><th>描述</th></tr></thead><tbody><tr><td><code>lock(long leaseTime, TimeUnit unit)</code></td><td><strong>指定锁的超时时间</strong>，不会启动看门狗</td></tr><tr><td><code>lock()</code>（无参）</td><td><strong>未指定锁超时时间</strong>，Redisson 会自动启动 <strong>WatchDog</strong> 定时续约机制</td></tr></tbody></table><h4 id="5-4-3lock-加锁流程回顾">5.4.3lock() 加锁流程回顾</h4><p>1.获取当前线程 ID</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">long threadId <span class="operator">=</span> Thread.currentThread().getId()<span class="comment">;</span></span><br></pre></td></tr></table></figure><p>2.尝试加锁（tryAcquire）</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Long</span> ttl = tryAcquire(-<span class="number">1</span>, leaseTime, unit, threadId);</span><br><span class="line"><span class="keyword">if</span> (ttl == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>; <span class="comment">// 加锁成功或重入成功</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>若返回值为 <code>null</code>，表示加锁成功（或是当前线程重入）<br>若返回 <code>ttl</code>（过期时间），表示锁被其他线程占用，进入 <code>while(true)</code> 自旋重试逻辑</p><h4 id="5-4-4三种加锁场景逻辑判断（tryAcquire-内部）">5.4.4三种加锁场景逻辑判断（tryAcquire 内部）</h4><table><thead><tr><th>情况</th><th>Redis 逻辑</th><th>说明</th></tr></thead><tbody><tr><td>锁不存在</td><td><code>hset</code> + <code>pexpire</code></td><td>直接加锁成功</td></tr><tr><td>锁是当前线程持有</td><td><code>hincrby</code> + <code>pexpire</code></td><td>可重入，计数+1</td></tr><tr><td>锁存在，非当前线程</td><td>返回剩余过期时间</td><td>加锁失败，等待自旋重试</td></tr></tbody></table><h4 id="5-4-5-重试机制（循环抢锁）">5.4.5 重试机制（循环抢锁）</h4><p>如果初始加锁失败，会进入以下逻辑：</p><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    tryAcquire() <span class="comment">// 不断尝试获取锁</span></span><br><span class="line">    <span class="params">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Redisson 会自旋尝试，直到获取锁成功或超时。</p><h4 id="5-4-6-看门狗机制（WatchDog）">5.4.6 看门狗机制（WatchDog）</h4><h4 id="适用场景：">适用场景：</h4><p>调用 <code>lock()</code> <strong>无参</strong>版本时，不指定 <code>leaseTime</code>，Redisson 默认设置锁有效期为 <strong>30秒</strong>，并会启动 <strong>自动续期机制</strong>。</p><p>WatchDog 实现核心逻辑：</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ttlRemainingFuture.onComplete<span class="function"><span class="params">((ttlRemaining, e) -&gt; &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">if</span> (ttlRemaining == <span class="literal">null</span>) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        scheduleExpirationRenewal(threadId);</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;)</span>;</span></span><br></pre></td></tr></table></figure><p>如果加锁成功，就调用 <code>scheduleExpirationRenewal()</code>，触发自动续期。</p><h4 id="5-4-7-续约机制源码分析（renewExpiration）">5.4.7 续约机制源码分析（renewExpiration）</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">void</span> <span class="title function_">renewExpiration</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 每次续期都会重新创建一个定时任务（10秒后触发）</span></span><br><span class="line">    <span class="title class_">Timeout</span> task = commandExecutor.<span class="title function_">getConnectionManager</span>().<span class="title function_">newTimeout</span>(<span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">run</span>(<span class="params"><span class="title class_">Timeout</span> timeout</span>) &#123;</span><br><span class="line">            <span class="comment">// 仍持有锁 -&gt; 再续期30s</span></span><br><span class="line">            <span class="title function_">renewExpirationAsync</span>(threadId).<span class="title function_">onComplete</span>((res, e) -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (res) &#123;</span><br><span class="line">                    <span class="title function_">renewExpiration</span>(); <span class="comment">// 递归设置下次续期</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, internalLockLeaseTime / <span class="number">3</span>, <span class="title class_">TimeUnit</span>.<span class="property">MILLISECONDS</span>); <span class="comment">// 默认是每10秒执行一次（30/3）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="整体过程：">整体过程：</h4><ol><li><strong>默认锁有效时间：30秒</strong></li><li><strong>每 10 秒（30/3）启动一个定时任务续期</strong></li><li>如果线程还活着且仍持有锁 → 重置锁的过期时间为 30秒</li><li>如果线程挂了（如宕机、异常） → 不再续期，锁自动过期释放</li></ol><h4 id="5-4-8-总结：Redisson-锁的核心机制">5.4.8 总结：Redisson 锁的核心机制</h4><table><thead><tr><th>机制</th><th>功能</th></tr></thead><tbody><tr><td><code>tryAcquire()</code></td><td>尝试加锁逻辑，判断锁状态</td></tr><tr><td><code>while(true)</code></td><td>自旋重试机制，直到加锁成功</td></tr><tr><td><code>WatchDog</code>（看门狗）</td><td>自动续期，防止锁提前释放</td></tr><tr><td><code>renewExpiration()</code></td><td>启动定时任务每 10 秒续一次期</td></tr><tr><td>锁自动释放</td><td>线程挂掉不会续期，锁30秒后自动释放</td></tr></tbody></table><ul><li>看门狗机制是 <strong>线程持有锁自动续期的保障</strong>；</li><li>使用 <code>lock()</code>（无参）时 <strong>不要担心死锁</strong>，即使忘了释放锁，30秒后也会释放；</li><li>不传 <code>leaseTime</code> 才会触发 WatchDog；</li><li>Redisson 的重入锁依靠 <code>Hash结构 + 线程id + 计数</code> 实现。</li></ul><h3 id="5-5-分布式锁-redission锁的MutiLock原理">5.5 分布式锁-redission锁的MutiLock原理</h3><p><strong>为什么需要 MultiLock？Redisson 锁丢失的背景</strong></p><p>为了提高redis的可用性，我们会搭建集群或者主从，现在以主从为例</p><p>主从同步延迟 + 宕机导致锁丢失</p><p>图中描述的是以下场景：</p><ol><li>Java 应用尝试获取 Redis 锁：<code>SET lock thread1 NX EX 10</code>（设置锁）</li><li>锁成功设置到 Redis <strong>主节点</strong>（Master）</li><li>Redis 主节点还未将锁同步到从节点（Slave）</li><li>此时主节点宕机了</li><li>Redis 自动从 Slave 中选出一个新的 Master（原来的从节点）</li><li>由于新 Master 上 <strong>没有锁数据</strong> → 锁丢失！💥</li></ol><p>这意味着：<strong>即使你刚加完锁，锁信息也可能因为主从未同步就丢失，造成并发安全隐患！</strong></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-226-1024x487.png" alt="img"></p><p>为了避免上述锁丢失问题，<strong>Redisson 提出了 MultiLock</strong>，也叫“多节点锁”或“联合锁”。</p><h4 id="MultiLock-核心原理：">MultiLock 核心原理：</h4><ul><li>如果任何一个节点失败，则失败的锁会回滚并释放</li><li>同时向多个 Redis 主节点加锁（比如 Redis 主机集群）</li><li>只有 <strong>所有节点都加锁成功</strong>，才算真正获取到锁</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-227-1024x371.png" alt="img"></p><p>那么MutiLock 加锁原理是什么呢？笔者画了一幅图来说明:当我们去设置了多个锁时，redission会将多个锁添加到一个集合中，然后用while循环去不停去尝试拿锁，但是会有一个总共的加锁时间，这个时间是用需要加锁的个数 * 1500ms ，假设有3个锁，那么时间就是4500ms，假设在这4500ms内，所有的锁都加锁成功， 那么此时才算是加锁成功，如果在4500ms有线程加锁失败，则会再次去进行重试.</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/1653553093967-1-1024x311.png" alt="img"></p><ol><li>收集多个锁</li></ol><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LockList.<span class="built_in">add</span>(lock1, lock2, lock3)</span><br></pre></td></tr></table></figure><ul><li>收集所有待加锁的 Redis 实例</li><li>设置总加锁时间：</li></ul><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">总超时时间 <span class="operator">=</span> 锁数量 * <span class="number">1500</span>ms</span><br></pre></td></tr></table></figure><ul><li>例如：3 个锁 → 超时时间为 4500ms</li><li>加锁流程（伪代码）：</li></ul><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (tryLock(waitTime, leaseTime, TimeUnit.MILLISECONDS)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 加锁失败时自动重试</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>遍历每个锁，逐一尝试加锁</li></ol><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">lock</span> <span class="keyword">in</span> LockList) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        boolean locked = <span class="keyword">lock</span>.tryLock(<span class="number">4500</span>ms, <span class="number">-1</span>); <span class="comment">// -1：表示触发自动续期</span></span><br><span class="line">        <span class="keyword">if</span> (locked) &#123;</span><br><span class="line">            acquiredLocks.<span class="keyword">add</span>(<span class="keyword">lock</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">break</span>; <span class="comment">// 加锁失败中断</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-成功判定条件：">5. 成功判定条件：</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">如果 acquiredLocks.size == LockList.size <span class="comment">// 所有锁都成功</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure><h4 id="6-如果有锁失败，回滚所有已获取的锁：">6. 如果有锁失败，回滚所有已获取的锁：</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">unlockInner(acquiredLocks); <span class="comment">// 释放所有已加锁的节点</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-230.png" alt="img"></p><h2 id="6、秒杀优化">6、秒杀优化</h2><h3 id="6-1-秒杀优化-异步秒杀思路">6.1 秒杀优化-异步秒杀思路</h3><p>我们来回顾一下下单流程</p><p>当用户发起请求，此时会请求nginx，nginx会访问到tomcat，而tomcat中的程序，会进行串行操作，分成如下几个步骤</p><ul><li>1、查询优惠卷</li><li>2、判断秒杀库存是否足够</li><li>3、查询订单</li><li>4、校验是否是一人一单</li><li>5、扣减库存</li><li>6、创建订单</li></ul><p>在这六步操作中，又有很多操作是要去操作数据库的，而且还是一个线程串行执行， 这样就会导致我们的程序执行的很慢，所以我们需要异步程序执行，那么如何加速呢？</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-231-1024x503.png" alt="img"></p><p>原始秒杀流程（未优化）</p><p>这张图描述的是传统的秒杀请求处理流程：</p><p>流程步骤：</p><ol><li>用户发起秒杀请求，请求被 Nginx 接收并转发到 Tomcat</li><li>Tomcat 中执行串行逻辑（每一步都访问数据库）：<ul><li>查询优惠券</li><li>判断库存</li><li>查询订单（是否重复）</li><li>校验一人一单</li><li>扣减库存</li><li>创建订单</li></ul></li></ol><p>问题：</p><ul><li>所有操作都在主线程中串行执行，访问数据库频繁</li><li>请求高峰期，数据库压力爆炸，响应速度慢</li><li>容易引发 <strong>超卖</strong> 或 <strong>性能瓶颈</strong></li></ul><p>优化方案：我们将耗时比较短的逻辑判断放入到redis中，比如是否库存足够，比如是否一人一单，这样的操作，只要这种逻辑可以完成，就意味着我们是一定可以下单完成的，我们只需要进行快速的逻辑判断，根本就不用等下单逻辑走完，我们直接给用户返回成功， 再在后台开一个线程，后台线程慢慢的去执行queue里边的消息，这样程序不就超级快了吗？而且也不用担心线程池消耗殆尽的问题，因为这里我们的程序中并没有手动使用任何线程池，当然这里边有两个难点</p><p>第一个难点是我们怎么在redis中去快速校验一人一单，还有库存判断</p><p>第二个难点是由于我们校验和tomct下单是两个线程，那么我们如何知道到底哪个单他最后是否成功，或者是下单完成，为了完成这件事我们在redis操作完之后，我们会将一些信息返回给前端，同时也会把这些信息丢到异步queue中去，后续操作中，可以通过这个id来查询我们tomcat中的下单逻辑是否完成了。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-232-1024x484.png" alt="img"></p><p>前端请求流程变更：</p><ol><li><p>用户请求发送到 Nginx</p></li><li><p>Nginx 将请求发给 Redis 进行</p><p>快速判断</p><p>：</p><ul><li>秒杀库存是否足够</li><li>是否一人一单</li></ul></li></ol><blockquote><p>3.这两个逻辑在 Redis 中执行，响应极快，避免 Tomcat 阻塞。</p></blockquote><p>4.后台 Tomcat 消费消息队列中的数据，执行真正的下单流程（慢慢完成）</p><p>5.判断通过后，Redis 将 <strong>userId、orderId 等信息</strong> 存入 <strong>消息队列</strong></p><p>优势：</p><ul><li>高并发下不会压垮数据库</li><li>秒杀操作近似“无锁”，吞吐高</li><li>用户体验好（快速响应）</li><li>可扩展性强（异步处理易于伸缩）</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-233-1024x482.png" alt="img"></p><p>Redis Lua 脚本保障 <strong>库存判断 + 一人一单判断 + 写入状态</strong> 的<strong>原子性</strong>，这是关键！</p><p>Redis 数据结构设计</p><table><thead><tr><th>Key</th><th>Value</th></tr></thead><tbody><tr><td><code>stock:vid:7</code></td><td>秒杀库存（例如100）</td></tr><tr><td><code>order:vid:7</code></td><td>用户ID列表（如Set/Stream）记录下单人</td></tr></tbody></table><p>Lua 脚本逻辑图（左下）：</p><ol><li>判断库存是否充足（<code>if stock &lt;= 0</code>）</li><li>判断用户是否已下单（是否在 set 集合中）</li><li>若均通过：<ul><li>扣减库存</li><li>将用户加入 set 集合（防止重复）</li><li>返回成功码 <code>0</code></li></ul></li></ol><p>后续处理（右侧流程）：</p><ol><li>执行 Lua 脚本</li><li>如果返回结果为 0，说明可以下单</li><li>将 couponId、userId、orderId 加入消息队列</li><li>后台线程消费消息，执行真正的：<ul><li>校验库存（可选）</li><li>创建订单</li><li>持久化入数据库</li></ul></li></ol><h3 id="6-2-秒杀优化-Redis完成秒杀资格判断">6.2 秒杀优化-Redis完成秒杀资格判断</h3><p>需求：</p><ul><li>新增秒杀优惠券的同时，将优惠券信息保存到Redis中</li><li>基于Lua脚本，判断秒杀库存、一人一单，决定用户是否抢购成功</li><li>如果抢购成功，将优惠券id和用户id封装后存入阻塞队列</li><li>开启线程任务，不断从阻塞队列中获取信息，实现异步下单功能</li></ul><p>这个阶段我们要实现的是：</p><table><thead><tr><th>功能</th><th>技术方案</th></tr></thead><tbody><tr><td>秒杀资格判断（库存 &amp; 一人一单）</td><td>使用 Redis + Lua 脚本，原子判断</td></tr><tr><td>异步下单处理</td><td>Redis Stream 队列 + 后台线程消费</td></tr><tr><td>快速响应用户</td><td>Redis 脚本立即返回结果（成功/失败）</td></tr><tr><td>延迟落库</td><td>后台线程根据消息内容执行真正的下单操作</td></tr></tbody></table><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-234.png" alt="img"></p><p>在VoucherServiceImpl的addSeckillVoucher方法的末尾添加下面这段代码把秒杀的库存保存到Redis中：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//保存秒杀的库存到Redis</span></span><br><span class="line">stringRedisTemplate<span class="selector-class">.opsForValue</span>()<span class="selector-class">.set</span>(RedisConstants.SECKILL_STOCK_KEY +voucher.getId(),voucher<span class="selector-class">.getStock</span>()<span class="selector-class">.toString</span>());</span><br></pre></td></tr></table></figure><p>说明：</p><ul><li><code>SECKILL_STOCK_KEY</code> 前缀常量为 <code>&quot;seckill:stock:&quot;</code></li><li>Redis 中会生成一个 Key，例如：<code>seckill:stock:17</code>，值为库存数量</li><li>相当于秒杀券一上架，就把库存同步到了 Redis 里，后续不再访问数据库判断库存</li></ul><p>发送请求，新增一份优惠券：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-236.png" alt="img"></p><p>可以看到在Redis中记录了优惠券的记录：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-238.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-239.png" alt="img"></p><p>完整的VoucherServiceImpl</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSeckillVoucher</span><span class="params">(Voucher voucher)</span> &#123;</span><br><span class="line">    <span class="comment">// 保存优惠券</span></span><br><span class="line">    save(voucher);</span><br><span class="line">    <span class="comment">// 保存秒杀信息</span></span><br><span class="line">    <span class="type">SeckillVoucher</span> <span class="variable">seckillVoucher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SeckillVoucher</span>();</span><br><span class="line">    seckillVoucher.setVoucherId(voucher.getId());</span><br><span class="line">    seckillVoucher.setStock(voucher.getStock());</span><br><span class="line">    seckillVoucher.setBeginTime(voucher.getBeginTime());</span><br><span class="line">    seckillVoucher.setEndTime(voucher.getEndTime());</span><br><span class="line">    seckillVoucherService.save(seckillVoucher);</span><br><span class="line">    <span class="comment">// 保存秒杀库存到Redis中</span></span><br><span class="line">    <span class="comment">//SECKILL_STOCK_KEY 这个变量定义在RedisConstans中</span></span><br><span class="line">    <span class="comment">//private static final String SECKILL_STOCK_KEY =&quot;seckill:stock:&quot;</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(SECKILL_STOCK_KEY + voucher.getId(), voucher.getStock().toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>完整lua表达式</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1.参数列表</span></span><br><span class="line"><span class="comment">-- 1.1.优惠券id</span></span><br><span class="line"><span class="keyword">local</span> voucherId = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="comment">-- 1.2.用户id</span></span><br><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">2</span>]</span><br><span class="line"><span class="comment">-- 1.3.订单id</span></span><br><span class="line"><span class="keyword">local</span> orderId = ARGV[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2.数据key</span></span><br><span class="line"><span class="comment">-- 2.1.库存key</span></span><br><span class="line"><span class="keyword">local</span> stockKey = <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId</span><br><span class="line"><span class="comment">-- 2.2.订单key</span></span><br><span class="line"><span class="keyword">local</span> orderKey = <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 3.脚本业务</span></span><br><span class="line"><span class="comment">-- 3.1.判断库存是否充足 get stockKey</span></span><br><span class="line"><span class="keyword">if</span>(tonumber(redis.<span class="keyword">call</span>(<span class="string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 3.2.库存不足，返回1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 3.2.判断用户是否下单 SISMEMBER orderKey userId</span></span><br><span class="line"><span class="keyword">if</span>(redis.<span class="keyword">call</span>(<span class="string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 3.3.存在，说明是重复下单，返回2</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 3.4.扣库存 incrby stockKey -1</span></span><br><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;incrby&#x27;</span>, stockKey, <span class="number">-1</span>)</span><br><span class="line"><span class="comment">-- 3.5.下单（保存用户）sadd orderKey userId</span></span><br><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;sadd&#x27;</span>, orderKey, userId)</span><br><span class="line"><span class="comment">-- 3.6.发送消息到队列中， XADD stream.orders * k1 v1 k2 v2 ...</span></span><br><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;xadd&#x27;</span>, <span class="string">&#x27;stream.orders&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;userId&#x27;</span>, userId, <span class="string">&#x27;voucherId&#x27;</span>, voucherId, <span class="string">&#x27;id&#x27;</span>, orderId)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><h4 id="解析一下这个lua脚步">解析一下这个lua脚步</h4><p>（1）<strong>判断库存是否足够</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">tonumber</span>(redis.call(<span class="string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="number">0</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">1</span> <span class="keyword">end</span></span><br></pre></td></tr></table></figure><ul><li>库存不足返回 1，结束逻辑</li></ul><p>（2）<strong>判断是否重复下单</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> redis.<span class="keyword">call</span>(<span class="string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="number">1</span> <span class="keyword">then</span> <span class="keyword">return</span> <span class="number">2</span> <span class="keyword">end</span></span><br></pre></td></tr></table></figure><ul><li><code>orderKey</code> 是 <code>seckill:order:&lt;voucherId&gt;</code>，用 Set 保存已下单用户</li></ul><p>（3）<strong>扣库存、记录下单用户</strong></p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis.<span class="built_in">call</span>(<span class="string">&#x27;incrby&#x27;</span>, stockKey, <span class="number">-1</span>)</span><br><span class="line">redis.<span class="built_in">call</span>(<span class="string">&#x27;sadd&#x27;</span>, orderKey, userId)</span><br></pre></td></tr></table></figure><p>（4）<strong>写入消息队列 Stream</strong></p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis.<span class="built_in">call</span>(<span class="string">&#x27;xadd&#x27;</span>, <span class="string">&#x27;stream.orders&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;userId&#x27;</span>, userId, <span class="string">&#x27;voucherId&#x27;</span>, voucherId, <span class="string">&#x27;id&#x27;</span>, orderId)</span><br></pre></td></tr></table></figure><p>使用 Redis Stream 作为消息队列，后续后台线程从这里消费数据，实现异步下单。</p><p>当以上lua表达式执行完毕后，剩下的就是根据步骤3,4来执行我们接下来的任务了</p><p>VoucherOrderServiceImpl</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function">Result <span class="title">seckillVoucher</span><span class="params">(Long voucherId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取用户</span></span><br><span class="line">    Long userId = UserHolder.getUser().getId();</span><br><span class="line">    <span class="keyword">long</span> orderId = redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    <span class="comment">// 1.执行lua脚本</span></span><br><span class="line">    Long result = stringRedisTemplate.execute(</span><br><span class="line">            SECKILL_SCRIPT,</span><br><span class="line">            Collections.emptyList(),</span><br><span class="line">            voucherId.toString(), userId.toString(), String.valueOf(orderId)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">int</span> r = result.intValue();</span><br><span class="line">    <span class="comment">// 2.判断结果是否为0</span></span><br><span class="line">    <span class="keyword">if</span> (r != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 2.1.不为0 ，代表没有购买资格</span></span><br><span class="line">        <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(r == <span class="number">1</span> ? <span class="string">&quot;库存不足&quot;</span> : <span class="string">&quot;不能重复下单&quot;</span>)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//TODO 保存阻塞队列</span></span><br><span class="line">    <span class="comment">// 3.返回订单id</span></span><br><span class="line">    <span class="function"><span class="keyword">return</span> Result.<span class="title">ok</span><span class="params">(orderId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>脚本执行后返回值含义：</p><table><thead><tr><th>返回值</th><th>含义</th></tr></thead><tbody><tr><td><code>1</code></td><td>库存不足</td></tr><tr><td><code>2</code></td><td>重复下单</td></tr><tr><td><code>0</code></td><td>有秒杀资格，成功入队，异步下单中</td></tr></tbody></table><p>测试：</p><p>在Apifox中发送测试数据，秒杀下单，成功后返回订单id：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-240-1024x601.png" alt="img"></p><p>在Redis中库存成功扣减1，order有缓存</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-241.png" alt="img"></p><p>如果再次发送会提示不能重复下单：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-242-1024x600.png" alt="img"></p><p>准备在Jemeter中测试，首先把缓存中的优惠券库存改为200：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-243.png" alt="img"></p><p>测试后库存减为0，新增200条订单记录：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-244.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-245.png" alt="img"></p><p>可以看到平均响应时间减少10倍，最快响应时间减少60倍，最大响应时间缩短：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-246-1024x491.png" alt="img"></p><h3 id="6-3-秒杀优化-基于阻塞队列实现秒杀优化">6.3 秒杀优化-基于阻塞队列实现秒杀优化</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-235.png" alt="img"></p><p>阻塞队列：尝试从队列获取元素，如果没有元素会被阻塞，直到队列中有元素才会被唤醒，获取元素。</p><p>只要类一启动，用户随时都有可能来抢购，因此VoucherOrderHandler这个类的初始化必须在类初始化后执行。</p><p>在VoucherOrderServiceImpl类中，首先要新增一个orderTasks阻塞队列，然后设置一个线程池和run方法。</p><p>在run方法中调用阻塞队列的take方法，orderTasks.take方法是一个阻塞方法，如果队列中有元素会获取，如果队列中无元素则阻塞等待。</p><p>这里相当于是开启了一个全新的线程来执行获取队列中订单信息和异步创建订单的任务：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> BlockingQueue&lt;VoucherOrder&gt; orderTasks = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">1024</span>*<span class="number">1024</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ExecutorService</span> <span class="variable">seckill_order_executor</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line"><span class="comment">/**orderTasks 是一个阻塞队列，用来存储待处理的订单。seckill_order_executor 是一个单线程的执行器，用来处理队列中的订单任务。**/</span></span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">    seckill_order_executor.submit(<span class="keyword">new</span> <span class="title class_">VoucherOrderHandler</span>());</span><br><span class="line">&#125;<span class="comment">//在 @PostConstruct 注解的方法中，启动了一个新线程来不断地从队列中取出订单信息并处理：</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//1.获取队列中的订单信息</span></span><br><span class="line">                <span class="type">VoucherOrder</span> <span class="variable">voucherOrder</span> <span class="operator">=</span> orderTasks.take();</span><br><span class="line">                <span class="comment">//2.创建订单</span></span><br><span class="line">                handleVoucherOrder(voucherOrder);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;处理订单异常&quot;</span>,e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//take() 方法是阻塞的，只有队列中有元素时才会返回，如果没有元素，则当前线程会阻塞，直到有新元素加入队列。</span></span><br></pre></td></tr></table></figure><p>然后新增一个handleVoucherOrder方法，，首先通过 <strong>Redisson 分布式锁</strong> 来确保 <strong>一人一单</strong> 逻辑的原子性，防止同一个用户多次下单。：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> IVoucherOrderService proxy ;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleVoucherOrder</span>(<span class="params">VoucherOrder voucherOrder</span>)</span> &#123;</span><br><span class="line">    <span class="comment">//1.获取用户</span></span><br><span class="line">    Long userId = voucherOrder.getUserId();</span><br><span class="line">    <span class="comment">//2.创建锁对象</span></span><br><span class="line">    RLock <span class="keyword">lock</span> = redissonClient.getLock(<span class="string">&quot;lock:order:&quot;</span>+userId);</span><br><span class="line">    <span class="comment">//3.获取锁</span></span><br><span class="line">    boolean isLock = <span class="keyword">lock</span>.tryLock();</span><br><span class="line">    <span class="comment">//4.判断是否获取锁成功</span></span><br><span class="line">    <span class="keyword">if</span>(!isLock) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;不允许重复下单&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//获取代理对象</span></span><br><span class="line">        proxy.createVoucherOrder(voucherOrder);</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">lock</span>.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>获取锁后，调用 <code>createVoucherOrder</code> 方法来扣减库存并保存订单。</li><li>如果锁获取失败，说明该用户已经下单，直接返回。</li></ul><p>createVoucherOrder方法主要是用来对数据库操作，比如扣减库存，然后保存订单的信息到数据库，会有额外的对一人一单和库存数量的判断，虽然这些在Redis中已经判断过，但这里是双重保险。</p><p>异步处理不需要再返回给前端任何东西。</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">@Transactional</span><br><span class="line">public void createVoucherOrder(VoucherOrder voucherOrder) &#123;</span><br><span class="line">    <span class="comment">//6.一人一单</span></span><br><span class="line">    Long userId = voucherOrder.getUserId();</span><br><span class="line">    <span class="comment">//6.1查询订单</span></span><br><span class="line">    int <span class="keyword">count</span> = <span class="keyword">query</span>().<span class="keyword">eq</span>(<span class="string">&quot;user_id&quot;</span>, userId).<span class="keyword">eq</span>(<span class="string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId()).<span class="keyword">count</span>();</span><br><span class="line">    <span class="comment">//6.2判断是否存在</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">count</span>&gt;0)&#123;</span><br><span class="line">        <span class="comment">//用户已经购买过了</span></span><br><span class="line">        <span class="keyword">log</span>.<span class="keyword">error</span>(<span class="string">&quot;用户已经购买过一次！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3.2库存充足扣减库存</span></span><br><span class="line">    boolean success = seckillVoucherService.<span class="keyword">update</span>()</span><br><span class="line">            .setSql(<span class="string">&quot;stock = stock - 1&quot;</span>) <span class="comment">//相当于set条件 set stock = stock - 1</span></span><br><span class="line">            .<span class="keyword">eq</span>(<span class="string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId()) <span class="comment">//相当于where条件 where id = ? and stock = ?</span></span><br><span class="line">            .gt(<span class="string">&quot;stock&quot;</span>,0).<span class="keyword">update</span>();</span><br><span class="line">    <span class="keyword">if</span>(!success)&#123;</span><br><span class="line">        <span class="keyword">log</span>.<span class="keyword">error</span>(<span class="string">&quot;库存不足!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    long orderId = redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);<span class="comment">//订单id</span></span><br><span class="line">    voucherOrder.setId(orderId);</span><br><span class="line">    voucherOrder.setUserId(userId);</span><br><span class="line">    voucherOrder.setVoucherId(voucherOrder.getVoucherId());<span class="comment">//代金券id</span></span><br><span class="line">    <span class="keyword">save</span>(voucherOrder);</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line">下面是对seckillVoucher的简单修改：seckillVoucher 方法在执行 Lua 脚本后，判断用户是否有秒杀资格。如果有，则将订单信息封装并添加到阻塞队列中</span><br></pre></td></tr></table></figure><p>public Result seckillVoucher(Long voucherId) {</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">//1.执行Lua脚本</span></span><br><span class="line">Long result = stringRedisTemplate.execute(</span><br><span class="line">        SECKILL_SCRIPT,</span><br><span class="line">        Collections.emptyList(),</span><br><span class="line">        voucherId.toString(),</span><br><span class="line">        UserHolder.getUser().getId().toString()</span><br><span class="line">);</span><br><span class="line"><span class="keyword">int</span> r = result.intValue();</span><br><span class="line"><span class="keyword">if</span>(r != <span class="number">0</span>)&#123; <span class="comment">//2.判断结果是否为0,不为0,代表没有购买资格</span></span><br><span class="line">    <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(r==<span class="number">1</span> ? <span class="string">&quot;库存不足&quot;</span>:<span class="string">&quot;不能重复下单&quot;</span>)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//2.2.为0,有购买资格,把下单信息保存到阻塞队列</span></span><br><span class="line"><span class="keyword">long</span> orderId = redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line"><span class="comment">//封装</span></span><br><span class="line">VoucherOrder voucherOrder = <span class="keyword">new</span> VoucherOrder();</span><br><span class="line">voucherOrder.setId(orderId);<span class="comment">//订单id</span></span><br><span class="line">voucherOrder.setUserId(UserHolder.getUser().getId());<span class="comment">//用户id</span></span><br><span class="line">voucherOrder.setVoucherId(voucherId);<span class="comment">//代金券id</span></span><br><span class="line"><span class="comment">//保存阻塞队列</span></span><br><span class="line">orderTasks.add(voucherOrder);</span><br><span class="line"><span class="comment">//获取代理对象</span></span><br><span class="line">proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line"><span class="comment">//3.返回订单id</span></span><br><span class="line"><span class="function"><span class="keyword">return</span> Result.<span class="title">ok</span><span class="params">(orderId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>流程总结</p><ul><li><strong>秒杀资格判断</strong>：通过 Lua 脚本判断库存是否充足、是否重复下单。</li><li><strong>封装订单信息</strong>：如果有资格，封装订单信息并保存到阻塞队列。</li><li><strong>异步下单</strong>：通过新线程异步处理订单，防止阻塞前端。</li><li><strong>双重保险</strong>：Redis 和数据库中都进行库存与一人一单的判断，保证数据一致性</li></ul><p>测试：</p><p>先把tb_voucher_order内容清空。把tb_seckill_voucher的stock库存改为200。</p><p>然后把Redis中对应优惠券的库存改为200。清空之前生成的订单。检查是否有1000个用户的token。</p><p>先用Apifox进行测试，测试一人一单的情况：第2次下单显示不能重复下单。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-247.png" alt="img"></p><p>检查数据库是否多1条订单记录，库存是否减少1，缓存中库存是否减少1。</p><p>接下来用Jemeter进行测试，会发现库存扣减为0，数据库中多200条数据，缓存中的库存也扣减到0。</p><p>看聚合报告的结果如下：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-248-1024x240.png" alt="img"></p><p>因为做了异步下单，会占用一定的CPU，所以平均值要比第2次更长。</p><p>和下面前2次的结果进行对比可以发现，响应的平均值比最初提高10倍，最快响应时间提高了80倍，最慢响应时间提高了6倍。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-249-1024x475.png" alt="img"></p><p>秒杀业务的优化思路：</p><p>1.先利用Redis完成库存量、一人一单的判断，完成抢单业务。</p><p>2.将下单业务放入阻塞队列，利用独立线程异步下单。</p><p>基于阻塞队列的异步秒杀存在哪些问题：</p><p>1.内存限制问题。使用的是jdk提供的阻塞队列，使用的是JVM的内存，在一开始写死了队列空间的大小，如果在高并发的情况下，队列很快会被占满，如果不对队列的空间加以限制，很容易造成内存的溢出。</p><p>2.数据安全问题。缺乏持久化机制，是基于内存来保存信息，如果服务突然宕机，内存中保存的信息都会丢失。如果任务被取出，但由于突然发生事故异常，导致任务没有被消费，任务丢失，会造成数据不一致问题。</p><h2 id="7、Redis消息队列">7、Redis消息队列</h2><h3 id="7-1-Redis消息队列-认识消息队列">7.1 Redis消息队列-认识消息队列</h3><p>什么是消息队列：</p><p><strong>消息队列</strong> 是一种以异步通信为基础的机制，在分布式系统中应用广泛。它的作用就是 <strong>存储和管理消息</strong>，并通过 <strong>消息中间件（Message Broker）</strong> 来实现消息的传递。最基本的消息队列包含了三个主要角色：</p><ol><li><strong>生产者（Producer）</strong>：发送消息到队列。</li><li><strong>消息队列（Message Queue）</strong>：存储和管理消息。</li><li><strong>消费者（Consumer）</strong>：从队列中获取消息并进行处理。</li></ol><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-250.png" alt="img"></p><p><strong>示例说明：</strong></p><p>通过生活中的例子来帮助理解消息队列的作用：</p><ul><li><strong>生产者</strong>：就像一个 <strong>快递员</strong>，他负责将快递从商家拿到快递站点（消息队列），等待送货。</li><li><strong>消息队列</strong>：快递站点，在这里所有的快递都暂时存放，等待被派送到消费者。</li><li><strong>消费者</strong>：类似 <strong>收件人</strong>，他们接收到快递，处理自己的需求。</li></ul><p>为什么使用消息队列？</p><p><strong>提高效率</strong>：消息队列帮助系统处理并发，生产者可以快速发送消息，而消费者会异步处理。</p><p><strong>解耦</strong>：生产者和消费者的工作可以解耦开，生产者无需关心消费者的处理速度，反之亦然。</p><p>这种场景在我们秒杀中就变成了：</p><ol><li><strong>用户发起秒杀请求</strong>：用户点击秒杀按钮，系统作为 <strong>生产者</strong> 将秒杀请求（消息）发送到 Redis 消息队列。</li><li><strong>系统判断库存</strong>：队列中的消息进入处理流程，由 <strong>消费者</strong> 负责从 Redis 消息队列中取出消息并执行相应的处理，如判断库存、生成订单等。</li><li><strong>异步处理</strong>：消费者处理完消息后，最终结果会异步返回到</li></ol><p>Redis提供了3种不同的方式来实现消息队列：</p><ul><li>1.list结构：基于List结构模拟消息队列。</li><li>2.PubSub（发布订阅）：基本的点对点消息模型。</li><li>3.Stream：比较完善的功能强大的消息队列模型。</li></ul><h3 id="7-2-Redis消息队列-基于List实现消息队列">7.2 Redis消息队列-基于List实现消息队列</h3><p><strong>基于List结构模拟消息队列</strong></p><p>消息队列（Message Queue），字面意思就是存放消息的队列。而Redis的list数据结构是一个<strong>双向链表</strong>，因此支持从两端进行操作，能够实现队列的 <strong>先进先出</strong>（FIFO）模式。</p><p>关键命令：</p><ul><li><strong>LPUSH</strong>：将一个或多个元素插入到列表的 <strong>头部</strong>。用于生产者将消息发送到队列。</li><li><strong>RPOP</strong>：移除并返回列表的 <strong>尾部</strong> 元素。用于消费者从队列获取消息。</li><li><strong>BRPOP</strong>：当队列为空时，阻塞等待，直到有消息加入队列中</li></ul><h4 id="关键点：">关键点：</h4><ul><li><code>BRPOP</code> 和 <code>RPOP</code> 命令在队列为空时会返回 <code>null</code>，这与 <strong>JVM 阻塞队列</strong> 不同，JVM 阻塞队列会直接阻塞线程，直到队列有可用元素。</li><li>Redis 中使用 <code>BRPOP</code> 来实现 <strong>阻塞式队列</strong>，使得消费者可以在队列为空时阻塞等待。</li></ul><p>队列是入口和出口不在一边，因此我们可以利用：LPUSH 结合 RPOP、或者 RPUSH 结合 LPOP来实现。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-252.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-253.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-251.png" alt="img"></p><p>基于List的消息队列有哪些优缺点？ 优点：</p><ul><li><strong>利用 Redis 存储</strong>，不依赖于 JVM 内存中的队列，保证了消息队列的 <strong>持久性</strong> 和 <strong>高可用性</strong>。</li><li><strong>跨进程、跨平台</strong>：Redis 可以用于多台机器间的消息传递，适用于分布式系统。</li><li><strong>安全性</strong>：数据存储在 Redis 中，确保了消息不会丢失，特别是在 <strong>Redis 持久化</strong>（AOF 或 RDB）开启的情况下。</li></ul><p>缺点：</p><ul><li><strong>无法强制消费者处理消息的顺序</strong>：因为 Redis 是基于 List 实现的，所以 <strong>多个消费者</strong> 可能会错过某些消息，或消费顺序不保证。</li><li><strong>没有内建的消息确认机制</strong>：消费者可能会消费同一个消息，若处理失败时缺乏补偿机制。</li></ul><h3 id="7-3-Redis消息队列-基于PubSub的消息队列">7.3 Redis消息队列-基于PubSub的消息队列</h3><p>PubSub（发布订阅）是Redis2.0版本引入的消息传递模型。顾名思义，消费者可以订阅一个或多个channel，生产者向对应channel发送消息后，所有订阅者都能收到相关消息。</p><p>SUBSCRIBE channel [channel] ：订阅一个或多个频道 PUBLISH channel msg ：向一个频道发送消息 PSUBSCRIBE pattern[pattern] ：订阅与pattern格式匹配的所有频道</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-254.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-255.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-257.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-256.png" alt="img"></p><p>基于PubSub的消息队列有哪些优缺点？ 优点：</p><ul><li><strong>支持多生产者、多消费者</strong>：一个频道可以有多个生产者发布消息，多个消费者订阅并处理这些消息。</li><li><strong>灵活的订阅方式</strong>：可以精确订阅某个频道，也可以通过模式匹配（PSUBSCRIBE）订阅多个频道。</li><li><strong>实时性高</strong>：一旦消息发布，所有订阅者可以即时收到，适用于对实时性要求高的场景。</li></ul><p>缺点：</p><ul><li><strong>不支持数据持久化</strong>：Redis Pub/Sub 不会将消息持久化到磁盘，数据丢失风险较大。</li><li><strong>无法避免消息丢失</strong>：如果消费者在订阅时没有准备好，或 Redis 服务重启等原因，会丢失消息。</li><li><strong>消息堆积有限制</strong>：如果消息队列堆积过多，超出了 Redis 的内存限制，可能会导致消息丢失。</li></ul><h3 id="7-4-Redis消息队列-基于Stream的消息队列">7.4 Redis消息队列-基于Stream的消息队列</h3><p>Stream 是 Redis 5.0 引入的一种新数据类型，可以实现一个功能非常完善的消息队列。</p><p>发送消息的命令：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-258-1024x150.png" alt="img"></p><ul><li><strong>key</strong>：指定 Stream 的名称。</li><li><strong>field</strong> 和 <strong>value</strong>：消息的字段和值，每条消息会有多个字段和值。</li></ul><p>例如：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-259.png" alt="img"></p><p>这条命令会将 <code>&quot;name&quot;</code> 和 <code>&quot;age&quot;</code> 这两个字段及其对应的值 <code>&quot;jack&quot;</code> 和 <code>&quot;21&quot;</code> 添加到名为 <code>users</code> 的 Stream 中，同时 Redis 会自动为该消息生成一个 <strong>唯一的 ID</strong>（如 <code>1644085070523-0</code>）。</p><p>读取消息的方式之一：XREAD，需要注意的是key和*|ID中间那俩参数是<strong>可选参数</strong>，一个是用来判断是否自动创建队列，一个是用来设置队列最大消息数量。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-260.png" alt="img"></p><p>例如，使用XREAD读取第一个消息：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-261.png" alt="img"></p><p>这条命令会从名为 <code>users</code> 的 Stream 中读取消息，从 ID 为 <code>0</code> 的位置开始，最多读取 1 条消息。</p><p>XREAD阻塞方式，读取最新的消息：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-262.png" alt="img"></p><ul><li><strong>BLOCK 1000</strong> 表示阻塞等待最多 1000 毫秒，直到队列中有新的消息，或超时。</li><li><strong>$</strong> 代表读取最新的消息。</li></ul><p>在业务开发中，我们可以循环的调用XREAD阻塞方式来查询最新消息，从而实现持续监听队列的效果，伪代码如下</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-263.png" alt="img"></p><ul><li>该循环会不断执行 <code>XREAD</code> 命令，直到有新消息进入队列。</li><li>每次从 Stream 中读取消息并执行 <code>handleMessage()</code> 处理消息。</li></ul><p>注意：当我们指定起始ID为$时，代表读取最新的消息，如果我们处理一条消息的过程中，又有超过1条以上的消息到达队列，则下次获取时也只能获取到最新的一条，会出现漏读消息的问题</p><p>STREAM类型消息队列的XREAD命令特点：</p><ul><li>消息可回溯</li><li>一个消息可以被多个消费者读取</li><li>可以阻塞读取</li><li>有消息漏读的风险</li></ul><h3 id="7-5-Redis消息队列-基于Stream的消息队列-消费者组">7.5 Redis消息队列-基于Stream的消息队列-消费者组</h3><p>消费者组（Consumer Group）：将多个消费者划分到一个组中，监听同一个队列。消费者之间是竞争关系。</p><p>具备下列特点：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-264.png" alt="img"></p><p>创建消费者组：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-265.png" alt="img"></p><ul><li>key：队列名称</li><li>groupName：消费者组名称</li><li>ID：起始ID标示，$代表队列中最后一个消息，0则代表队列中第一个消息</li><li>MKSTREAM：队列不存在时自动创建队列</li></ul><p>其它常见命令：</p><p><strong>删除指定的消费者组</strong></p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">XGROUP DESTORY key groupName</span></span><br></pre></td></tr></table></figure><p><strong>给指定的消费者组添加消费</strong></p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">XGROUP CREATECONSUMER key groupname consumername</span></span><br></pre></td></tr></table></figure><p><strong>删除消费者组中的指定消费者</strong></p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">XGROUP DELCONSUMER key groupname consumername</span></span><br></pre></td></tr></table></figure><p>创建消费者组：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-269.png" alt="img"></p><p><strong>从消费者组读取消息：</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">XREADGROUP GROUP group consumer <span class="selector-attr">[COUNT count]</span> <span class="selector-attr">[BLOCK milliseconds]</span> <span class="selector-attr">[NOACK]</span> STREAMS key <span class="selector-attr">[key ...]</span> ID <span class="selector-attr">[ID ...]</span></span><br></pre></td></tr></table></figure><ul><li>group：消费组名称</li><li>consumer：消费者名称，如果消费者不存在，会自动创建一个消费者</li><li>count：本次查询的最大数量</li><li>BLOCK milliseconds：当没有消息时最长等待时间</li><li>NOACK：无需手动ACK，获取到消息后自动确认</li><li>STREAMS key：指定队列名称</li><li>ID：获取消息的起始ID：</li></ul><p>可以发现在同一个消费者组里的消费者对消息不会重复读取，而是依次读取，已被读取的消息不会再次被读取。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-270.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-271.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-272.png" alt="img"></p><p><strong>消费者确认消息：</strong></p><p>XACK key group ID</p><ul><li>key：是队列名称。</li><li>group：是消费者组名称。</li><li>ID：是接收到的消息的ID。</li></ul><p><strong>查看Pending-list队列的信息：</strong></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-273.png" alt="img"></p><ul><li>key：是队列名称。</li><li>group：是组名称。</li></ul><p>下面是消息确认：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-274.png" alt="img"></p><p>对消息进行确认，确认完消息会被移除：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-275.png" alt="img"></p><p>Pending-list队列里面存储的是已经读取，但是还没确认的消息。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-276.png" alt="img"></p><p>假如一台节点读取完消息还没却来得及确认就宕机了，可以通过以下的方法解决：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-277.png" alt="img"></p><p>正常情况下先用&gt;，如果出现异常，信息会进入到Pending-list，把ID从&gt;改为0，此时取的就是在Pending-list里的消息。</p><p>消费者监听消息的基本思路：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-266.png" alt="img"></p><p>STREAM类型消息队列的XREADGROUP命令特点：</p><ul><li>消息可回溯</li><li>可以多消费者争抢消息，加快消费速度</li><li>可以阻塞读取</li><li>没有消息漏读的风险</li><li>有消息确认机制，保证消息至少被消费一次</li><li>支持消息持久化</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-267.png" alt="img"></p><h3 id="7-6-基于Redis的Stream结构作为消息队列，实现异步秒杀下单">7.6 基于Redis的Stream结构作为消息队列，实现异步秒杀下单</h3><p>需求：在这个场景中，我们需要通过 <strong>Redis Stream</strong> 来实现一个 <strong>异步秒杀下单</strong> 的消息队列。步骤如下：</p><ul><li>创建一个Stream类型的消息队列，名为stream.orders</li><li>修改之前的秒杀下单Lua脚本，在认定有抢购资格后，直接向stream.orders中添加消息，内容包含voucherId、userId、orderId</li><li>项目启动时，开启一个线程任务，尝试获取stream.orders中的消息，完成下单</li></ul><p>直接通过控制台创建一个stream.orders队列：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-278.png" alt="img"></p><p>直接在Lua脚本中编写代码（主要增加一个局部变量）</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--1.参数列表</span></span><br><span class="line"><span class="comment">--1.1.优惠券id</span></span><br><span class="line"><span class="keyword">local</span> voucherId = ARGV[<span class="number">1</span>]</span><br><span class="line"><span class="comment">--1.2.用户id</span></span><br><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">2</span>]</span><br><span class="line"><span class="comment">--1.3.订单id</span></span><br><span class="line"><span class="keyword">local</span> orderId = ARGV[<span class="number">3</span>]</span><br><span class="line"> </span><br><span class="line"><span class="comment">--2.数据key</span></span><br><span class="line"><span class="comment">--2.1.库存key</span></span><br><span class="line"><span class="keyword">local</span> stockKey = <span class="string">&#x27;seckill:stock:&#x27;</span> .. voucherId</span><br><span class="line"><span class="comment">--2.2.订单key</span></span><br><span class="line"><span class="keyword">local</span> orderKey = <span class="string">&#x27;seckill:order:&#x27;</span> .. voucherId</span><br><span class="line"> </span><br><span class="line"><span class="comment">--3.脚本业务</span></span><br><span class="line"><span class="comment">--3.1.判断库存是否充足 get stockKey</span></span><br><span class="line"><span class="keyword">if</span>(tonumber(redis.<span class="keyword">call</span>(<span class="string">&#x27;get&#x27;</span>,stockKey)) &lt;= <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">--3.1.2.库存不足，返回1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--3.2.判断用户是否下单 SISMEMBER orderKey userId</span></span><br><span class="line"><span class="keyword">if</span>(redis.<span class="keyword">call</span>(<span class="string">&#x27;sismember&#x27;</span>,orderKey,userId)==<span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="comment">--3.2.1.存在，说明是重复下单，返回2</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--3.3.扣库存 incrby stockKey -1</span></span><br><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;incrby&#x27;</span>,stockKey,<span class="number">-1</span>)</span><br><span class="line"><span class="comment">--3.4.下单 sadd orderKey userId</span></span><br><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;sadd&#x27;</span>,orderKey,userId)</span><br><span class="line"><span class="comment">--3.5.发送消息到队列中 XADD stream.orders * k1 v1 k2 v2</span></span><br><span class="line">redis.<span class="keyword">call</span>(<span class="string">&#x27;xadd&#x27;</span>,<span class="string">&#x27;stream.orders&#x27;</span>,<span class="string">&#x27;*&#x27;</span>,<span class="string">&#x27;userId&#x27;</span>,userId,<span class="string">&#x27;voucherId&#x27;</span>,voucherId,<span class="string">&#x27;orderId&#x27;</span>,orderId)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><ul><li><strong><code>xadd</code></strong> 命令将 <code>userId</code>、<code>voucherId</code> 和 <code>orderId</code> 发送到名为 <code>stream.orders</code> 的队列中。</li><li>消息被发送到队列后，消费者可以异步处理这个消息。</li></ul><p>在VoucherOrderServiceImpl类中修改seckillVoucher方法：</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function">Result <span class="title">seckillVoucher</span><span class="params">(Long voucherId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取订单id</span></span><br><span class="line">    <span class="keyword">long</span> orderId = redisIdWorker.nextId(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">    <span class="comment">//1.执行Lua脚本(判断用户是否有购买资格，消息发出)</span></span><br><span class="line">    Long result = stringRedisTemplate.execute(</span><br><span class="line">            SECKILL_SCRIPT,</span><br><span class="line">            Collections.emptyList(),</span><br><span class="line">            voucherId.toString(),</span><br><span class="line">            UserHolder.getUser().getId().toString(),</span><br><span class="line">            String.valueOf(orderId)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">int</span> r = result.intValue();</span><br><span class="line">    <span class="keyword">if</span>(r != <span class="number">0</span>)&#123; <span class="comment">//2.判断结果是否为0,不为0,代表没有购买资格</span></span><br><span class="line">        <span class="function"><span class="keyword">return</span> Result.<span class="title">fail</span><span class="params">(r==<span class="number">1</span> ? <span class="string">&quot;库存不足&quot;</span>:<span class="string">&quot;不能重复下单&quot;</span>)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取代理对象</span></span><br><span class="line">    proxy = (IVoucherOrderService) AopContext.currentProxy();</span><br><span class="line">    <span class="comment">//3.返回订单id</span></span><br><span class="line">    <span class="function"><span class="keyword">return</span> Result.<span class="title">ok</span><span class="params">(orderId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过执行 Lua 脚本来进行秒杀资格的判断，并将订单信息发送到 <code>stream.orders</code> 队列。</p><p>在VoucherOrderServiceImpl中修改VoucherOrderHandler方法的代码：</p><p>代码思路如下：</p><p>1.从消息队列中尝试读消息。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">1</span>.<span class="number">1</span>.获取失败，继续循环。</span><br></pre></td></tr></table></figure><p>2.获取成功，进行解析和转换。</p><p>3.调用createVoucherOrder(voucherOrder)方法完成下单。</p><p>4.ACK确认</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">    <span class="number">4.1</span>.确认失败，调用<span class="title function_">handlePendingList</span>()方法进行处理。</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="title class_">ExecutorService</span> seckill_order_executor = <span class="title class_">Executors</span>.<span class="title function_">newSingleThreadExecutor</span>();</span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">void</span> <span class="title function_">init</span>(<span class="params"></span>)&#123;</span><br><span class="line">    seckill_order_executor.<span class="title function_">submit</span>(<span class="keyword">new</span> <span class="title class_">VoucherOrderHandler</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">VoucherOrderHandler</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line">    <span class="title class_">String</span> queueName = <span class="string">&quot;stream.order&quot;</span>;</span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">void</span> <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//1.获取消息队列中的订单信息 XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS streams.order &gt;</span></span><br><span class="line">                <span class="title class_">List</span>&lt;<span class="title class_">MapRecord</span>&lt;<span class="title class_">String</span>, <span class="title class_">Object</span>, <span class="title class_">Object</span>&gt;&gt; list = stringRedisTemplate.<span class="title function_">opsForStream</span>().<span class="title function_">read</span>(</span><br><span class="line">                        <span class="title class_">Consumer</span>.<span class="title function_">from</span>(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">                        <span class="title class_">StreamReadOptions</span>.<span class="title function_">empty</span>().<span class="title function_">count</span>(<span class="number">1</span>).<span class="title function_">block</span>(<span class="title class_">Duration</span>.<span class="title function_">ofSeconds</span>(<span class="number">2</span>)),</span><br><span class="line">                        <span class="title class_">StreamOffset</span>.<span class="title function_">create</span>(queueName, <span class="title class_">ReadOffset</span>.<span class="title function_">lastConsumed</span>())</span><br><span class="line">                );</span><br><span class="line">                <span class="comment">//2.判断消息获取是否成功</span></span><br><span class="line">                <span class="keyword">if</span>(list==<span class="literal">null</span> || list.<span class="title function_">isEmpty</span>())&#123;</span><br><span class="line">                    <span class="comment">//2.1.获取失败，没有消息，继续下一次循环</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//3.解析消息中的订单信息</span></span><br><span class="line">                <span class="title class_">MapRecord</span>&lt;<span class="title class_">String</span>, <span class="title class_">Object</span>, <span class="title class_">Object</span>&gt; record = list.<span class="title function_">get</span>(<span class="number">0</span>);</span><br><span class="line">                <span class="comment">//4.获取成功，可以下单</span></span><br><span class="line">                <span class="title class_">Map</span>&lt;<span class="title class_">Object</span>, <span class="title class_">Object</span>&gt; values = record.<span class="title function_">getValue</span>();</span><br><span class="line">                <span class="comment">//3.创建订单</span></span><br><span class="line">                <span class="title class_">VoucherOrder</span> voucherOrder = <span class="title class_">BeanUtil</span>.<span class="title function_">fillBeanWithMap</span>(values, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br><span class="line">                <span class="title function_">createVoucherOrder</span>(voucherOrder);</span><br><span class="line">                <span class="comment">//4.ACK确认</span></span><br><span class="line">                stringRedisTemplate.<span class="title function_">opsForStream</span>().<span class="title function_">acknowledge</span>(queueName,<span class="string">&quot;g1&quot;</span>,record.<span class="title function_">getId</span>());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) &#123;</span><br><span class="line">                log.<span class="title function_">debug</span>(<span class="string">&quot;处理订单异常&quot;</span>,e);</span><br><span class="line">                <span class="title function_">handlePendingList</span>();</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong><code>XREAD</code></strong> 命令从 <code>stream.orders</code> 队列中读取消息。</li><li>读取到消息后，调用 <code>createVoucherOrder()</code> 方法来处理订单。</li><li>使用 <strong>ACK 确认</strong> 来确保消息被正确消费。</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">  </span><br></pre></td></tr></table></figure><p>在VoucherOrderServiceImpl中添加handlePendingList()方法的代码：</p><p>下面有几个修改点：1.XREADGROUP语句末尾改为0，表示读Pending-list队列。2.Pending-list消息获取失败结束循环。3.如果抛异常只是暂停一下，然后会继续循环读。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">void</span> <span class="title function_">handlePendingList</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1.获取Pending-List中的订单信息 XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS streams.order 0</span></span><br><span class="line">            <span class="title class_">List</span>&lt;<span class="title class_">MapRecord</span>&lt;<span class="title class_">String</span>, <span class="title class_">Object</span>, <span class="title class_">Object</span>&gt;&gt; list = stringRedisTemplate.<span class="title function_">opsForStream</span>().<span class="title function_">read</span>(</span><br><span class="line">                    <span class="title class_">Consumer</span>.<span class="title function_">from</span>(<span class="string">&quot;g1&quot;</span>, <span class="string">&quot;c1&quot;</span>),</span><br><span class="line">                    <span class="title class_">StreamReadOptions</span>.<span class="title function_">empty</span>().<span class="title function_">count</span>(<span class="number">1</span>),</span><br><span class="line">                    <span class="title class_">StreamOffset</span>.<span class="title function_">create</span>(queueName, <span class="title class_">ReadOffset</span>.<span class="title function_">from</span>(<span class="string">&quot;0&quot;</span>))</span><br><span class="line">            );</span><br><span class="line">            <span class="comment">//2.判断消息获取是否成功</span></span><br><span class="line">            <span class="keyword">if</span>(list==<span class="literal">null</span> || list.<span class="title function_">isEmpty</span>())&#123;</span><br><span class="line">                <span class="comment">//2.1.获取失败，说明Pending-list里没有异常消息，结束循环</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//3.解析消息中的订单信息</span></span><br><span class="line">            <span class="title class_">MapRecord</span>&lt;<span class="title class_">String</span>, <span class="title class_">Object</span>, <span class="title class_">Object</span>&gt; record = list.<span class="title function_">get</span>(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">//4.获取成功，可以下单</span></span><br><span class="line">            <span class="title class_">Map</span>&lt;<span class="title class_">Object</span>, <span class="title class_">Object</span>&gt; values = record.<span class="title function_">getValue</span>();</span><br><span class="line">            <span class="comment">//3.创建订单</span></span><br><span class="line">            <span class="title class_">VoucherOrder</span> voucherOrder = <span class="title class_">BeanUtil</span>.<span class="title function_">fillBeanWithMap</span>(values, <span class="keyword">new</span> <span class="title class_">VoucherOrder</span>(), <span class="literal">true</span>);</span><br><span class="line">            <span class="comment">//4.ACK确认</span></span><br><span class="line">            stringRedisTemplate.<span class="title function_">opsForStream</span>().<span class="title function_">acknowledge</span>(queueName,<span class="string">&quot;g1&quot;</span>,record.<span class="title function_">getId</span>());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="title class_">Exception</span> e) &#123;</span><br><span class="line">            log.<span class="title function_">debug</span>(<span class="string">&quot;处理Pending-list异常&quot;</span>,e);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="title class_">Thread</span>.<span class="title function_">sleep</span>(<span class="number">20</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="title class_">InterruptedException</span> ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>总结：</p><ul><li><strong>异步下单</strong>：通过 Redis Stream 实现秒杀下单的异步处理，避免了前端用户的阻塞。</li><li><strong>消息队列</strong>：使用 Redis Stream 存储消息，确保每个秒杀请求可以被异步处理。</li><li><strong>消息确认机制</strong>：使用 ACK 确认确保消息被成功消费，并通过 Pending List 处理异常消息，防止丢失。</li></ul><p>测试：</p><p>用Apifox进行测试，测试接口请求发送成功：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-280-1024x590.png" alt="img"></p><p>测试成功后可以看到：tb_voucher_order表多了1条记录，tb_seckill_voucher表对应优惠券的库存-1；在Redis中seckill:order下出现订单记录，在stockill:stock下的库存-1，在stream.orders下出现1条新的记录。</p><p>然后用Jmeter进行测试：可以发现相较于未做异步处理的情况性能仍有较大提升。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-279-1024x264.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-281-1024x479.png" alt="img"></p><h2 id="8、达人探店">8、达人探店</h2><h3 id="8-1、达人探店-发布探店笔记">8.1、达人探店-发布探店笔记</h3><p>发布探店笔记</p><p>探店笔记类似点评网站的评价，往往是图文结合。对应的表有两个：<br>tb_blog：探店笔记表，包含笔记中的标题、文字、图片等<br>tb_blog_comments：其他用户对探店笔记的评价</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-283.png" alt="img"></p><p><strong>具体发布流程</strong></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-284.png" alt="img"></p><p>上传接口</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">&quot;upload&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">&quot;blog&quot;</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="title class_">Result</span> <span class="title function_">uploadImage</span>(<span class="params"><span class="meta">@RequestParam</span>(<span class="string">&quot;file&quot;</span>) <span class="title class_">MultipartFile</span> image</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取原始文件名称</span></span><br><span class="line">            <span class="title class_">String</span> originalFilename = image.<span class="title function_">getOriginalFilename</span>();</span><br><span class="line">            <span class="comment">// 生成新文件名</span></span><br><span class="line">            <span class="title class_">String</span> fileName = <span class="title function_">createNewFileName</span>(originalFilename);</span><br><span class="line">            <span class="comment">// 保存文件</span></span><br><span class="line">            image.<span class="title function_">transferTo</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="title class_">SystemConstants</span>.<span class="property">IMAGE_UPLOAD_DIR</span>, fileName));</span><br><span class="line">            <span class="comment">// 返回结果</span></span><br><span class="line">            log.<span class="title function_">debug</span>(<span class="string">&quot;文件上传成功，&#123;&#125;&quot;</span>, fileName);</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">Result</span>.<span class="title function_">ok</span>(fileName);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="title class_">IOException</span> e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;文件上传失败&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：同学们在操作时，需要修改SystemConstants.IMAGE_UPLOAD_DIR 自己图片所在的地址，在实际开发中图片一般会放在nginx上或者是云存储上。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-285-1024x179.png" alt="img"></p><p>BlogController</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(<span class="string">&quot;/blog&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IBlogService blogService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="keyword">public</span> Result saveBlog(<span class="meta">@RequestBody</span> Blog blog) &#123;</span><br><span class="line">        <span class="comment">//获取登录用户</span></span><br><span class="line">        UserDTO user = UserHolder.getUser();</span><br><span class="line">        blog.setUpdateTime(user.getId());</span><br><span class="line">        <span class="comment">//保存探店博文</span></span><br><span class="line">        blogService.saveBlog(blog);</span><br><span class="line">        <span class="comment">//返回id</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(blog.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-2-达人探店-查看探店笔记">8.2 达人探店-查看探店笔记</h3><p>探店笔记要包含笔记的内容和博主的相关信息。所以选择在Blog表中添加如下2个字段，这两个字段需要后续我们手动维护（赋值）。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-286-1024x814.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-287.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-289.png" alt="img"></p><p>在BlogController类里添加一个queryBlogById方法（虽然Controller里不应该出现业务代码，但鉴于只是简单的查询操作，就不必在意细节了）：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(<span class="string">&quot;/&#123;id&#125;&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> Result queryBlogById(<span class="meta">@PathVariable(<span class="string">&quot;id&quot;</span>)</span> <span class="built_in">Long</span> id)&#123;</span><br><span class="line">    Blog blog = blogService.getById(id);</span><br><span class="line">    <span class="keyword">if</span>(blog==<span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;笔记不存在&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    User user = userService.getById(id);</span><br><span class="line">    blog.setIcon(user.getIcon());</span><br><span class="line">    blog.setName(user.getNickName());</span><br><span class="line">    <span class="keyword">return</span> Result.ok(blog);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-3-达人探店-点赞功能">8.3 达人探店-点赞功能</h3><p>现在的点赞逻辑是，一个人可以对同一篇笔记点赞无数次。</p><p>需求：</p><ul><li>1.同一个用户只能点赞一次，如果再次点击则取消点赞。</li><li>2.如果当前用户已经点赞，则点赞按钮高亮显示（前端已实现，判断字段Blog类的isLike属性）</li></ul><p>分析：</p><ul><li>1.给Blog类中添加一个isLike字段，标示是否被当前用户点赞。</li><li>2.修改点赞功能，利用Redis的Set集合判断是否点赞过，未点赞则点赞数+1，已点赞则点赞数-1。</li><li>3.修改分页查询Blog业务和根据id查询Blog的业务，判断当前用户是否点赞过，赋值给isLike字段。</li><li>4.修改分页查询Blog业务，判断当前登录用户是否点赞过，赋值给isLike字段</li></ul><p>为什么采用set集合：</p><p>Redis 的 Set 是一个不允许重复元素的集合，特别适合用于存储用户是否点赞的状态。</p><p>代码如下：</p><p>在BlogController类中新增likeBlog方法：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@PutMapping</span>(<span class="string">&quot;/like/&#123;id&#125;&quot;</span>)</span><br><span class="line">public Result <span class="built_in">likeBlog</span>(<span class="variable">@PathVariable</span>(<span class="string">&quot;id&quot;</span>) Long id) &#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">blogService</span><span class="selector-class">.likeBlog</span>(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>使用 <code>@PutMapping</code> 表示用户点赞或取消点赞。</li><li>调用 <code>likeBlog</code> 方法来执行点赞逻辑。</li></ul><p>在IBlogService接口中添加方法声明：</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable"><span class="class">Result</span></span> <span class="function"><span class="title">likeBlog</span>(<span class="variable">Long</span> <span class="variable">id</span>);</span></span><br></pre></td></tr></table></figure><p>在BlogServiceImpl类中添加下面代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">BlogServiceImpl</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">likeBlog</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="comment">//1.获取登录用户</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> user.getId();</span><br><span class="line">    <span class="comment">//2.判断当前用户是否已经点赞过</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;blog:liked:&quot;</span> +id;</span><br><span class="line">    <span class="type">Boolean</span> <span class="variable">isMember</span> <span class="operator">=</span> stringRedisTemplate.opsForSet().isMember(key, userId.toString());</span><br><span class="line">    <span class="keyword">if</span>(BooleanUtil.isFalse(isMember))&#123;</span><br><span class="line">        <span class="comment">//3.未点赞，可以点赞</span></span><br><span class="line">        <span class="comment">//3.1.数据库点赞数+1</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked=liked+1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="comment">//3.2.保存用户到Redis</span></span><br><span class="line">        <span class="keyword">if</span>(isSuccess)&#123;</span><br><span class="line">            stringRedisTemplate.opsForSet().add(key,userId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//4.已点赞，取消点赞</span></span><br><span class="line">        <span class="comment">//4.1.数据库点赞数-1</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;liked=liked-1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="comment">//4.2.把用户从Redis的set集合移除</span></span><br><span class="line">        stringRedisTemplate.opsForSet().remove(key,userId.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>点赞</strong>：如果 Redis Set 中没有当前用户的 ID，说明用户还未点赞，执行数据库更新（点赞数+1），并将用户 ID 存入 Redis Set。</li><li><strong>取消点赞</strong>：如果 Redis Set 中有当前用户的 ID，说明用户已点赞，执行数据库更新（点赞数-1），并将用户 ID 从 Redis Set 中移除。</li></ul><p>因为我的queryBlogById和queryHotBlog的业务代码都沿用原本的代码写在BlogController中，因此我是直接在BlogController中写入isBlogLiked代码：</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">Boolean</span> isBlogLiked(Blog blog) &#123;</span><br><span class="line"><span class="built_in">Long</span> userId = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//1.获取登录用户</span></span><br><span class="line">userId = UserHolder.getUser().getId();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">log.debug(<span class="string">&quot;用户未登录！&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//2.判断当前用户是否已经点赞过</span></span><br><span class="line">String key = <span class="string">&quot;blog:liked:&quot;</span> +blog.getId();</span><br><span class="line"><span class="built_in">Boolean</span> isMember = stringRedisTemplate.opsForSet().isMember(key, userId.toString());</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">blog.setIsLike(BooleanUtil.isTrue(isMember));</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">log.debug(<span class="string">&quot;点赞信息为空！&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> isMember;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>判断用户是否点赞</strong>：通过 Redis 判断当前登录用户是否已点赞，如果点赞，则将 <code>isLike</code> 字段设置为 <code>true</code>，前端根据该字段值来控制点赞按钮的显示状态</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-291.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-290.png" alt="img"></p><p>总结：</p><ul><li><strong>点赞操作</strong>：使用 Redis Set 来存储每个用户对博客的点赞记录，确保每个用户只能对同一篇文章点赞一次。</li><li><strong>异步更新</strong>：通过 Redis 存储点赞状态，减少数据库操作频率，提高性能。</li><li><strong>前端交互</strong>：根据 <code>isLike</code> 字段，前端动态更新点赞按钮的状态，实现高亮显示和取消高亮。</li><li><strong>缓存优化</strong>：使用 Redis 快速检查用户的点赞状态，避免频繁访问数据库，提高系统响应速度。</li></ul><p>测试效果：点赞一次高亮，点赞两次取消。在缓存中有相应的记录</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-294.png" alt="img"></p><h3 id="8-4-达人探店-点赞排行榜">8.4 达人探店-点赞排行榜</h3><p>需求：在探店笔记详情页面，按照时间排序，把最早点赞的TOP5列举出来，形成点赞排行榜。</p><p>之前的点赞是放到set集合，但是<strong>set集合是不能排序的</strong>，所以这个时候，咱们可以采用一个可以排序的set集合，就是咱们的sortedSet</p><p><strong>SortedSet（有序集合）</strong> 是 Redis 中一个重要的数据结构，支持按 <strong>score</strong> 值排序，这非常适合用于排名等场景。我们需要根据 <strong>score</strong>（通常是时间戳或者用户的点赞数等）来排序。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-295.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-292.png" alt="img"></p><p>可以用ZADD命令添加元素，ZSCOPE来获得分数对应的元素，ZRANGE来</p><p>Redis 中通过 <strong>ZADD</strong> 命令来向 <strong>SortedSet</strong> 中添加元素，元素会根据 <strong>score</strong> 值排序。每个元素有两个部分：</p><ul><li><strong>Member</strong>：表示元素。</li><li><strong>Score</strong>：表示排序值，Redis 会根据这个值对元素进行排序。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-296.png" alt="img"></p><ul><li><code>ZADD</code> 添加了 3 个元素，分别为 m1、m2、m3，且分别赋予了不同的 <strong>score</strong>。</li><li><code>ZRANGE</code> 命令按 <strong>score</strong> 升序排列，并返回指定范围的元素。</li></ul><p>修改以下几点</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-297-1024x584.png" alt="img"></p><ul><li><strong>ZADD</strong> 用来将用户 ID 和当前时间戳（作为 <code>score</code>）加入到 Redis 的 SortedSet 中。</li><li><strong>ZREM</strong> 用来移除已点赞用户的记录，进行取消点赞操作。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-298.png" alt="img"></p><p>在Redis缓存中多了一个score：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-299.png" alt="img"></p><p>在BlogController类中添加如下方法：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@GetMapping</span>(<span class="string">&quot;/likes/&#123;id&#125;&quot;</span>)</span><br><span class="line">public Result <span class="built_in">queryBlogLikes</span>(<span class="variable">@PathVariable</span>(<span class="string">&quot;id&quot;</span>) Long id) &#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">blogService</span><span class="selector-class">.queryBlogLikes</span>(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 <code>BlogController</code> 类中新增查询接口方法 <code>queryBlogLikes</code>：</p><ul><li><strong>GET</strong> 请求 <code>/blog/likes/&#123;id&#125;</code> 查询某篇博客的 <strong>TOP 5 点赞用户</strong>。</li><li>返回结果是一个 <code>List&lt;UserDTO&gt;</code>，包含了点赞最多的用户。</li></ul><p>在IBlogService接口中添加如下方法：</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable"><span class="class">Result</span></span> <span class="function"><span class="title">queryBlogLikes</span>(<span class="variable">Long</span> <span class="variable">id</span>);</span></span><br></pre></td></tr></table></figure><p>在BlogServiceImpl类中添加如下方法：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="keyword">public</span> Result queryBlogLikes(<span class="keyword">Long</span> id) &#123;</span><br><span class="line">    String key = RedisConstants.BLOG_LIKED_KEY +id;</span><br><span class="line">    <span class="comment">//1.查询top5的点赞用户 zrange key 0 4</span></span><br><span class="line">    Set&lt;String&gt; top5 = stringRedisTemplate.opsForZSet().range(key, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span>(top5==<span class="keyword">null</span> || top5.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.解析出其中的用户id</span></span><br><span class="line">    List&lt;<span class="keyword">Long</span>&gt; ids = top5.stream().map(<span class="keyword">Long</span>::valueOf).<span class="keyword">collect</span>(Collectors.<span class="keyword">toList</span>());</span><br><span class="line">    <span class="comment">//3.根据用户id查询用户</span></span><br><span class="line">    List&lt;UserDTO&gt; userDTOS = userService.listByIds(ids)</span><br><span class="line">            .stream()</span><br><span class="line">            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.<span class="keyword">class</span>))</span><br><span class="line">            .<span class="keyword">collect</span>(Collectors.<span class="keyword">toList</span>());</span><br><span class="line">    <span class="comment">//4.返回</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(userDTOS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在会出现左图问题，先点赞的反而被排到后面了：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-300.png" alt="img"></p><p>下面是修改后的queryBlogLikes：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="keyword">public</span> Result queryBlogLikes(<span class="keyword">Long</span> id) &#123;</span><br><span class="line">    String key = RedisConstants.BLOG_LIKED_KEY +id;</span><br><span class="line">    <span class="comment">//1.查询top5的点赞用户 zrange key 0 4</span></span><br><span class="line">    Set&lt;String&gt; top5 = stringRedisTemplate.opsForZSet().range(key, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span>(top5==<span class="keyword">null</span> || top5.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.解析出其中的用户id</span></span><br><span class="line">    List&lt;<span class="keyword">Long</span>&gt; ids = top5.stream().map(<span class="keyword">Long</span>::valueOf).<span class="keyword">collect</span>(Collectors.<span class="keyword">toList</span>());</span><br><span class="line">    <span class="comment">//3.根据用户id查询用户</span></span><br><span class="line">    String idStr = StrUtil.<span class="keyword">join</span>(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">    List&lt;UserDTO&gt; userDTOS = userService.query()</span><br><span class="line">            .in(<span class="string">&quot;id&quot;</span>,ids)</span><br><span class="line">            .last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span>+idStr+<span class="string">&quot;)&quot;</span>).list()</span><br><span class="line">            .stream()</span><br><span class="line">            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.<span class="keyword">class</span>))</span><br><span class="line">            .<span class="keyword">collect</span>(Collectors.<span class="keyword">toList</span>());</span><br><span class="line">    <span class="comment">//4.返回</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(userDTOS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>能够正常展示：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-301.png" alt="img"></p><h2 id="9、好友关注">9、好友关注</h2><h3 id="9-1-好友关注-关注和取消关注">9.1 好友关注-关注和取消关注</h3><p>针对用户的操作：可以对用户进行关注和取消关注功能。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-302-1024x506.png" alt="img"></p><p>实现思路：</p><p>需求：基于该表数据结构，实现两个接口：</p><ul><li>关注和取关接口</li><li>判断是否关注的接口</li></ul><p>关注是User之间的关系，是博主与粉丝的关系，数据库中有一张tb_follow表来标示：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-303-1024x213.png" alt="img"></p><p>关注是给表新增记录，取关是删除表中记录。</p><p>在FollowController类中写入如下代码：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//关注</span></span><br><span class="line"><span class="variable">@PutMapping</span>(<span class="string">&quot;/&#123;id&#125;/&#123;isFollow&#125;&quot;</span>)</span><br><span class="line">public Result <span class="built_in">follow</span>(<span class="variable">@PathVariable</span>(<span class="string">&quot;id&quot;</span>) Long followUserId, <span class="variable">@PathVariable</span>(<span class="string">&quot;isFollow&quot;</span>) Boolean isFollow) &#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">followService</span><span class="selector-class">.follow</span>(followUserId, isFollow);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//取消关注</span></span><br><span class="line">@<span class="selector-tag">GetMapping</span>(<span class="string">&quot;/or/not/&#123;id&#125;&quot;</span>)</span><br><span class="line"><span class="selector-tag">public</span> <span class="selector-tag">Result</span> <span class="selector-tag">isFollow</span>(<span class="variable">@PathVariable</span>(<span class="string">&quot;id&quot;</span>) Long followUserId) &#123;</span><br><span class="line">      <span class="selector-tag">return</span> <span class="selector-tag">followService</span><span class="selector-class">.isFollow</span>(followUserId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>关注接口（PUT 请求）</strong>：</p><ul><li>路由：<code>/follow/&#123;id&#125;/&#123;isFollow&#125;</code></li><li>功能：判断是关注还是取消关注，通过 <code>isFollow</code> 参数来区分。如果 <code>isFollow</code> 为 <code>true</code>，则表示关注；如果为 <code>false</code>，则表示取消关注。</li></ul><p><strong>取消关注接口（GET 请求）</strong>：</p><ul><li>路由：<code>/or/not/&#123;id&#125;</code></li><li>功能：判断当前用户是否已关注目标用户。</li></ul><p>在IFollowService中写入如下代码：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="symbol">IFollowService</span> <span class="symbol">extends</span> <span class="symbol">IService</span>&lt;<span class="symbol">Follow</span>&gt; &#123;</span><br><span class="line">    Result follow(Long followUserId, Boolean isFollow); <span class="comment">// 关注或取关</span></span><br><span class="line">    Result isFollow(Long followUserId); <span class="comment">// 判断是否关注</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在FollowServiceImpl类中写入如下代码：</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Service</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">FollowServiceImpl</span> <span class="title">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">FollowMapper</span>, <span class="title">Follow</span>&gt; <span class="title">implements</span> <span class="title">IFollowService</span> </span>&#123;</span><br><span class="line">    // 关注与取消关注操作</span><br><span class="line">    <span class="variable">@Override</span></span><br><span class="line">    public Result follow(Long followUserId, Boolean isFollow) &#123;</span><br><span class="line">        Long userId = UserHolder.getUser().getId();</span><br><span class="line">        <span class="regexp">//</span><span class="number">1</span>.判断是关注还是取关</span><br><span class="line">        <span class="keyword">if</span>(isFollow)&#123;</span><br><span class="line">            <span class="regexp">//</span><span class="number">2</span>.关注，新增数据</span><br><span class="line">            Follow follow = new Follow();</span><br><span class="line">            follow.setUserId(userId);</span><br><span class="line">            follow.setFollowUserId(followUserId);</span><br><span class="line">            save(follow);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="regexp">//</span><span class="number">3</span>.取关，删除记录</span><br><span class="line">            remove(new QueryWrapper&lt;Follow&gt;()</span><br><span class="line">                    .e<span class="string">q(&quot;user_id&quot;, userId)</span>.e<span class="string">q(&quot;follow_user_id&quot;, followUserId)</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 判断当前用户是否已关注目标用户</span><br><span class="line">    <span class="variable">@Override</span></span><br><span class="line">    public Result isFollow(Long followUserId) &#123;</span><br><span class="line">        Long userId = UserHolder.getUser().getId();</span><br><span class="line">        <span class="regexp">//</span><span class="number">1</span>.查询是否关注</span><br><span class="line">        Integer count = query().e<span class="string">q(&quot;user_id&quot;, userId)</span>.e<span class="string">q(&quot;follow_user_id&quot;, followUserId)</span>.count();</span><br><span class="line">        <span class="regexp">//</span><span class="number">2</span>.判断是否关注</span><br><span class="line">        <span class="keyword">return</span> Result.ok(count&gt;<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>关注操作</strong>：首先获取当前登录的 <code>userId</code>，然后根据 <code>followUserId</code> 创建一个 <code>Follow</code> 实体对象，并将其保存到数据库中。</li><li><strong>取消关注操作</strong>：根据当前用户的 <code>userId</code> 和目标用户的 <code>followUserId</code> 删除 <code>tb_follow</code> 表中的记录，表示取消关注。</li><li><strong>判断是否已关注</strong></li><li><strong>isFollow 方法</strong>：该方法通过查询 <code>tb_follow</code> 表来判断当前用户是否已经关注某个目标用户。如果存在对应记录，则返回 <code>true</code>，否则返回 <code>false</code>。</li></ul><p>测试：点击关注显示关注成功，数据库里会有记录。取消关注后删除消息。</p><h3 id="9-2-好友关注-共同关注">9.2 好友关注-共同关注</h3><p>想要去看共同关注的好友，需要首先进入到这个页面，这个页面会发起两个请求</p><p>1、去查询用户的详情</p><p>2、去查询用户的笔记</p><p>以上两个功能和共同关注没有什么关系，大家可以自行将笔记中的代码拷贝到idea中就可以实现这两个功能了，我们的重点在于共同关注功能。</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserController 根据id查询用户</span></span><br><span class="line"><span class="meta">@GetMapping(<span class="string">&quot;/&#123;id&#125;&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> Result queryUserById(<span class="meta">@PathVariable(<span class="string">&quot;id&quot;</span>)</span> <span class="built_in">Long</span> userId)&#123;</span><br><span class="line"><span class="comment">// 查询详情</span></span><br><span class="line">User user = userService.getById(userId);</span><br><span class="line"><span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br><span class="line">UserDTO userDTO = BeanUtil.copyProperties(user, UserDTO.<span class="keyword">class</span>);</span><br><span class="line"><span class="comment">// 返回</span></span><br><span class="line"><span class="keyword">return</span> Result.ok(userDTO);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BlogController  根据id查询博主的探店笔记</span></span><br><span class="line"><span class="meta">@GetMapping(<span class="string">&quot;/of/user&quot;</span>)</span></span><br><span class="line"><span class="keyword">public</span> Result queryBlogByUserId(</span><br><span class="line"><span class="meta">@RequestParam(value = <span class="string">&quot;current&quot;</span>, defaultValue = <span class="string">&quot;1&quot;</span>)</span> Integer current,</span><br><span class="line"><span class="meta">@RequestParam(<span class="string">&quot;id&quot;</span>)</span> <span class="built_in">Long</span> id) &#123;</span><br><span class="line"><span class="comment">// 根据用户查询</span></span><br><span class="line">Page&lt;Blog&gt; page = blogService.query()</span><br><span class="line">.eq(<span class="string">&quot;user_id&quot;</span>, id).page(new Page&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));</span><br><span class="line"><span class="comment">// 获取当前页数据</span></span><br><span class="line">List&lt;Blog&gt; records = page.getRecords();</span><br><span class="line"><span class="keyword">return</span> Result.ok(records);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-304-1024x403.png" alt="img"></p><p>功能实现的思路是：</p><ul><li><strong>关注操作</strong>：当用户关注另一个用户时，不仅要在数据库表中插入记录，还需要将关注的用户ID存储在Redis的 <code>Set</code> 集合中。</li><li><strong>取消关注操作</strong>：当用户取消对另一个用户的关注时，除了删除数据库中的记录，还需要从Redis中移除对应的用户ID。</li><li><strong>共同关注操作</strong>：通过Redis的 <code>SINTER</code> 命令，获取当前用户与目标用户关注的交集，进而查询这些共同关注的用户信息。</li></ul><p>首先要更改FollowServiceImpl代码中的follow方法，主要在关注时把被关注用户的id放入redis，取关时从redis中移除id：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> IUserService userService;</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">FollowServiceImpl</span><span class="params">(StringRedisTemplate stringRedisTemplate)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.stringRedisTemplate = stringRedisTemplate;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">follow</span><span class="params">(Long followUserId, Boolean isFollow)</span> &#123;</span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + userId;</span><br><span class="line">    <span class="comment">//1.判断是关注还是取关</span></span><br><span class="line">    <span class="keyword">if</span>(isFollow)&#123;</span><br><span class="line">        <span class="comment">//2.关注，新增数据</span></span><br><span class="line">        <span class="type">Follow</span> <span class="variable">follow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Follow</span>();</span><br><span class="line">        follow.setUserId(userId);</span><br><span class="line">        follow.setFollowUserId(followUserId);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(follow);</span><br><span class="line">        <span class="keyword">if</span>(isSuccess)&#123;</span><br><span class="line">            <span class="comment">//把关注用户的id放入redis的set集合</span></span><br><span class="line">            stringRedisTemplate.opsForSet().add(key,followUserId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//3.取关，删除记录</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> remove(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;Follow&gt;()</span><br><span class="line">                .eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId));</span><br><span class="line">        <span class="keyword">if</span>(isSuccess)&#123;</span><br><span class="line">            <span class="comment">//把关注用户的id从Redis移除</span></span><br><span class="line">            stringRedisTemplate.opsForSet().remove(key,followUserId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>关注操作</strong>：当用户关注某人时，我们在数据库中插入关注记录，并将被关注用户的 <code>userId</code> 存入 Redis 的 <code>Set</code> 集合。</li><li><strong>取消关注操作</strong>：当用户取消关注时，我们从数据库删除对应的关注记录，并将该用户的 <code>userId</code> 从 Redis 中的 <code>Set</code> 集合移除。</li></ul><p>下面进行简单测试，关注时数据存入redis没问题：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-305.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-306.png" alt="img"></p><p>点击共同关注报错，但发出了请求，原因是还没编写方法：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-307-1024x272.png" alt="img"></p><p>可以通过SINTER命令求出交集：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-308.png" alt="img"></p><p>在 <code>FollowController</code> 中添加路由,在FollowController中写入下面代码：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@GetMapping</span>(<span class="string">&quot;/common/&#123;id&#125;&quot;</span>)</span><br><span class="line">public Result <span class="built_in">followCommons</span>(<span class="variable">@PathVariable</span>(<span class="string">&quot;id&quot;</span>) Long id)&#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">followService</span><span class="selector-class">.followCommons</span>(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 <code>IFollowService</code> 接口中声明,在IFollowService中写入下面代码：</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable"><span class="class">Result</span></span> <span class="function"><span class="title">followCommons</span>(<span class="variable">Long</span> <span class="variable">id</span>);</span></span><br></pre></td></tr></table></figure><p>在 <code>FollowServiceImpl</code> 类中实现,在FollowServiceImpl类中写入下面代码：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="keyword">public</span> Result followCommons(<span class="keyword">Long</span> id) &#123;</span><br><span class="line">    <span class="comment">//求的是目标用户和当前用户关注的交集</span></span><br><span class="line">    <span class="comment">//1.获取key</span></span><br><span class="line">    <span class="keyword">Long</span> userId = UserHolder.getUser().getId();</span><br><span class="line">    String key1 = <span class="string">&quot;follows:&quot;</span>+userId; <span class="comment">// 当前用户关注的集合</span></span><br><span class="line">    String key2 = <span class="string">&quot;follows:&quot;</span>+id; <span class="comment">// 目标用户关注的集合</span></span><br><span class="line">    <span class="comment">//2.使用Redis的SINTER命令求交集</span></span><br><span class="line">    Set&lt;String&gt; <span class="keyword">intersect</span> = stringRedisTemplate.opsForSet().<span class="keyword">intersect</span>(key1, key2);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">intersect</span>==<span class="keyword">null</span>||<span class="keyword">intersect</span>.isEmpty())&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3.解析id集合,将交集中的用户ID转换成Long类型</span></span><br><span class="line">    List&lt;<span class="keyword">Long</span>&gt; ids = <span class="keyword">intersect</span>.stream().map(<span class="keyword">Long</span>::valueOf).<span class="keyword">collect</span>(Collectors.<span class="keyword">toList</span>());</span><br><span class="line">    <span class="comment">//4. 查询共同关注的用户信息</span></span><br><span class="line">    List&lt;UserDTO&gt; users = userService.listByIds(ids)</span><br><span class="line">            .stream()</span><br><span class="line">            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.<span class="keyword">class</span>))</span><br><span class="line">            .<span class="keyword">collect</span>(Collectors.<span class="keyword">toList</span>());</span><br><span class="line">    <span class="keyword">return</span> Result.ok(users);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>获取共同关注用户</strong>：首先，我们获取当前用户和目标用户的关注列表（存储在 Redis 的 <code>Set</code> 集合中），然后使用 <code>SINTER</code> 命令获取它们的交集（即共同关注的用户）。接着，我们将这些用户ID查询出来，并返回用户信息。</p><p>像我现在关注的是小鱼同学和可可今天不吃肉。接下来换号，换成小鱼同学，电话：13686869696，让小鱼同学关注我和可可今天不吃肉。以小鱼同学的视角来查看我，可以看到我们共同关注了可可今天不吃肉。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-309.png" alt="img"></p><h3 id="9-3-好友关注-Feed流实现方案">9.3 好友关注-Feed流实现方案</h3><p><strong>Feed流</strong>，即动态消息流，是社交平台用来为用户持续提供内容的一种方式。通过Feed流，用户能够无需主动查找，系统自动推送符合其兴趣的内容，提供更加沉浸式的体验。常见的例子有社交网络的动态时间线（Timeline），例如Facebook、Instagram、Twitter等。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-310.png" alt="img"></p><h4 id="Feed流的两种模式："><strong>Feed流的两种模式：</strong></h4><ol><li><p>Timeline模式</p><p>：</p><ul><li><strong>定义</strong>：不对内容进行筛选，按内容的发布时间排序，通常用于好友或关注的人发布的内容，例如社交平台的动态。</li><li><strong>优点</strong>：信息全面，不会缺失任何内容；实现较为简单。</li><li><strong>缺点</strong>：可能存在信息噪音，用户未必感兴趣，导致内容获取效率低。</li></ul></li><li><p>智能排序</p><p>：</p><ul><li><strong>定义</strong>：通过智能算法筛选出用户感兴趣的内容，同时屏蔽掉违规或不感兴趣的内容。这样，系统推送的内容更符合用户的偏好。</li><li><strong>优点</strong>：用户能够获得更符合其兴趣的内容，增加用户粘性，可能让用户更沉浸在平台内。</li><li><strong>缺点</strong>：如果推荐算法不准确，可能会误推送不相关或让用户不满意的内容。</li></ul></li></ol><p>本例中，我们使用的是 <strong>Timeline模式</strong>，即基于用户关注的好友信息，按照时间顺序展示内容。</p><p>因此采用Timeline的模式。该模式的实现方案有三种：</p><ul><li>拉模式</li><li>推模式</li><li>推拉结合</li></ul><p><strong>拉模式</strong>：也叫做读扩散</p><p>该模式的核心含义就是：当用户想查看好友的动态时，系统会从用户关注的好友中拉取最新的内容。系统会根据用户关注的人群，拉取这些人发布的信息，并进行排序。</p><p>优点：</p><ul><li><strong>节约空间</strong>：数据仅在用户需要时才进行读取，减少了重复存储。</li><li>用户读取完信息后，可以清空收件箱，避免存储大量未读数据。</li></ul><p>缺点：</p><ul><li><strong>延迟性</strong>：用户在读取信息时才会去拉取，若用户关注了大量的人，系统可能需要一次性拉取大量的内容，增加服务器负担。</li><li>在数据量大时，可能会导致延时较高。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-311-1024x443.png" alt="img"></p><p><strong>推模式</strong>：也叫做写扩散。</p><p>当用户（如博主）发布新的内容时，系统会主动将内容推送到关注他的粉丝的收件箱中。这避免了用户每次都要去拉取数据。</p><p>优点：时效快，不用临时拉取</p><p>缺点：内存压力大，假设一个大V写信息，很多人关注他， 就会写很多分数据到粉丝那边去</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-312.png" alt="img"></p><p><strong>推拉结合模式</strong>：也叫做读写混合，兼具推和拉两种模式的优点。</p><p>推拉模式是一个折中的方案</p><ul><li><strong>普通用户</strong>：普通用户发布的内容会直接推送到其粉丝的收件箱中。</li><li><strong>大V用户</strong>：对于大V，系统会先将其内容写入到发件箱，再将内容推送到活跃粉丝的收件箱中；对于不活跃的粉丝，内容会存入发件箱，等他们上线时再拉取。</li></ul><p><strong>优点</strong>：</p><ul><li><strong>折中方案</strong>：既有推送的实时性，又能避免大V账号产生过大内存压力。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-313-1024x454.png" alt="img"></p><h3 id="9-4-好友关注-推送到粉丝收件箱">9.4 好友关注-推送到粉丝收件箱</h3><p>需求：</p><ul><li>修改新增探店笔记的业务，在保存blog到数据库的同时，推送到粉丝的收件箱</li><li>收件箱满足可以根据时间戳排序，必须用Redis的数据结构实现</li><li>查询收件箱数据时，可以实现分页查询</li></ul><p>Feed流中的数据会不断更新，所以数据的角标也在变化，因此不能采用传统的分页模式。</p><p>传统了分页在feed流是不适用的，因为我们的数据会随时发生变化</p><p>情景解释</p><ul><li>假设你首先请求了动态的第一页（<code>page=1</code>，每页5条数据），然后你会得到类似10、11、12、13、14这样的数据。</li><li>接着你请求第二页（<code>page=2</code>），你会期望得到接下来的数据（例如15、16、17等）。</li><li>然而，如果在你请求数据的过程中，动态流（feed）有新内容发布，那么你的请求就可能会获取到不一致的数据。</li></ul><p><strong>潜在问题</strong>：</p><ul><li>如果第一页的数据是在<code>t1</code>时刻请求的，而新数据（比如“Feed: 11”）是在<code>t3</code>时刻发布的，那么第二页获取的数据可能会和第一页重叠。</li><li>这会导致分页数据的重复或者错乱，因为Feed在更新时，数据会发生变化。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-314-1024x454.png" alt="img"></p><p>Feed流的滚动分页</p><ul><li>这里提出的解决方法是记录每次请求的最后一个数据ID（<code>lastId</code>），这样可以确保每次分页请求都知道从哪里开始获取数据。</li><li>比如，如果你已经获取到的最后一个ID是<code>6</code>，那么第二页的数据应该从ID为<code>6</code>的下一条数据开始，这样可以避免重复获取已读过的数据。</li></ul><p>举个例子：我每次请求时，保存当前最后读取的数据ID。</p><p>当请求下一页时，通过<code>lastId</code>来确认从哪里继续读取数据，确保不会重复或者遗漏。</p><p>这种方式确保了分页的数据不会受动态流中间更新的影响。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-315-1024x536.png" alt="img"></p><p>核心的意思：就是我们在保存完探店笔记后，获得到当前笔记的粉丝，然后把数据推送到粉丝的redis中去。</p><p>在BlogController里面写入如下代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">saveBlog</span><span class="params">(<span class="meta">@RequestBody</span> Blog blog)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取登录用户</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">    blog.setUserId(user.getId());</span><br><span class="line">    <span class="comment">// 保存探店博文</span></span><br><span class="line">    blogService.saveBlog(blog);</span><br><span class="line">    <span class="comment">// 返回id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(blog.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在IBlogService接口里面写入如下代码：</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable"><span class="class">Result</span></span> <span class="function"><span class="title">saveBlog</span>(<span class="variable">Blog</span> <span class="variable">blog</span>);</span></span><br></pre></td></tr></table></figure><p>在BlogServiceImpl类中写入如下代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">saveBlog</span><span class="params">(Blog blog)</span> &#123;</span><br><span class="line">    <span class="comment">//1.获取登录用户</span></span><br><span class="line">    <span class="type">UserDTO</span> <span class="variable">user</span> <span class="operator">=</span> UserHolder.getUser();</span><br><span class="line">    blog.setUserId(user.getId());</span><br><span class="line">    <span class="comment">//2.保存探店笔记</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(blog);</span><br><span class="line">    <span class="keyword">if</span>(!isSuccess)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(<span class="string">&quot;新增笔记失败！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3.查询笔记作业的所有粉丝</span></span><br><span class="line">    <span class="comment">//select * from tb_follow where follow_user_id = ?</span></span><br><span class="line">    List&lt;Follow&gt; follows = followService.query().eq(<span class="string">&quot;follow_user_id&quot;</span>, user.getId()).list();</span><br><span class="line">    <span class="comment">//4.推送笔记id给粉丝</span></span><br><span class="line">    <span class="keyword">for</span>(Follow follow : follows)&#123;</span><br><span class="line">        <span class="comment">//4.1.获取粉丝id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> follow.getUserId();</span><br><span class="line">        <span class="comment">//4.2.推送到粉丝收件箱是sortedSet</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;feed::&quot;</span>+userId;</span><br><span class="line">        stringRedisTemplate.opsForZSet().add(key,blog.getId().toString(),System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//返回id</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(blog.getId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="9-5好友关注-实现分页查询收邮箱的思路">9.5好友关注-实现分页查询收邮箱的思路</h3><p>ZRANGE是按照角标从小到大排序：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-316.png" alt="img"></p><p>这个命令返回一个有序集合中成员的范围，可以根据给定的最小值和最大值来限制返回的元素。</p><p>ZREVRANGE是按照角标从大到小排序：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-317.png" alt="img"></p><p>这个命令与 <code>ZRANGE</code> 类似，不过它是倒序返回集合中的元素。</p><p>ZREVRANGEBYSCORE是按照分数从大到小排序：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-318.png" alt="img"></p><p>这个命令根据分数进行过滤，返回分数范围内的成员，通常用来处理时间线或者排名之类的数据。</p><p>滚动查询：每次分页查询都会获取上一次查询返回的最小值，并将其作为下一次查询的最大值。这样确保每次查询返回的数据是连续的，不会重复或者遗漏。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-319.png" alt="img"></p><p>例如，当你使用 <code>ZRANGE</code> 或 <code>ZREVRANGE</code> 进行分页查询时，你可以设置 <code>LIMIT</code> 参数来限制返回的结果数量。第一次查询时，你会从第一个成员开始，后续每次查询会根据上一次查询的结果来调整开始的地方。</p><p>规律：分数最小值和查的数量固定不变。最大值为上一次查询的最小值、偏移量第1次给0，第1次后给在上一次的结果中，与最小值一样的元素的个数。</p><p>当分数一致出现问题：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-320.png" alt="img"></p><ul><li>分数相同的成员将被视为具有相同的顺序。</li><li>当分数相同的成员出现在两次分页查询的结果中时，它们会按照第一次查询的结果顺序被返回。</li><li>比如，当第一次查询返回分数为 6 的成员时，第二次查询会继续返回分数为 6 的成员，这样保证了分页的连续性。</li></ul><p>如果 <code>z1</code> 集合中有几个分数为 <code>6</code> 的元素，第一次查询返回了这些元素后，下一次查询会从上一次查询的结果继续获取数据。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-321.png" alt="img"></p><h3 id="9-6好友关注-实现滚动分页查询">9.6好友关注-实现滚动分页查询</h3><p>需求：在实现<strong>滚动分页查询</strong>时，目的是在用户的个人主页展示他们关注的博客内容。每次查询返回一定数量的数据，同时将最小时间戳和偏移量作为查询条件传递给下一次查询。</p><p>具体操作如下：</p><p>1.<strong>获取最小时间戳</strong>：每次查询结束后，分析出返回数据中的最小时间戳，这个时间戳将作为下一次查询的条件，用于获取比当前查询时间更新的博客。</p><p>2.<strong>计算偏移量</strong>：偏移量是上次查询中返回的数据条目数，目的是跳过已经查询过的数据，从而确保每次查询都能获取新的数据。</p><p>3.<strong>请求参数</strong>：每次请求时需要携带 <code>lastId</code>（即上一次查询的最小时间戳）和 <code>offset</code>（即偏移量）这两个参数。第一次查询时，前端会指定这两个参数，之后的查询由后台根据上一次的查询结果进行传递。</p><p>综上：我们的请求参数中就需要携带 lastId：上一次查询的最小时间戳 和偏移量这两个参数。</p><p>这两个参数第一次会由前端来指定，以后的查询就根据后台结果作为条件，再次传递到后台。</p><p>首先定义出来具体的返回值实体类</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScrollResult</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">List</span>&lt;<span class="string">?&gt;</span> list;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Long</span> minTime;</span><br><span class="line">    <span class="keyword">private</span> <span class="title class_">Integer</span> offset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ScrollResult</code> 类用于封装查询结果，包含三个字段：</p><ul><li><code>list</code>：存储查询到的博客列表。</li><li><code>minTime</code>：本次查询返回数据中的最小时间戳，用于下一次查询的条件。</li><li><code>offset</code>：偏移量，表示这次查询返回的数据数量，下一次查询需要跳过这些数据。</li></ul><p>在BlogController中写入下面代码：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@GetMapping</span>(<span class="string">&quot;/of/follow&quot;</span>)</span><br><span class="line">public Result <span class="built_in">queryBlogOfFollow</span>(<span class="variable">@RequestParam</span>(<span class="string">&quot;lastId&quot;</span>) Long max,<span class="variable">@RequestParam</span>(value = <span class="string">&quot;offset&quot;</span>,defaultValue = <span class="string">&quot;0&quot;</span>) Integer offset) &#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">blogService</span><span class="selector-class">.queryBlogOfFollow</span>(max,offset);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接口接收两个请求参数：</p><ul><li><code>lastId</code>：上次查询的最小时间戳。</li><li><code>offset</code>：本次查询的偏移量，默认值为 0。</li></ul><p>在IBlogService写入如下代码：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Result</span> queryBlogOfFollow(Long max, <span class="type">Integer</span> <span class="keyword">offset</span>);</span><br></pre></td></tr></table></figure><p>在BlogServiceImpl中写入如下代码：</p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Result queryB<span class="keyword">log</span>OfFollow(Long <span class="keyword">max</span>, Integer offset) &#123;</span><br><span class="line">    //<span class="number">1</span>.获取当前用户</span><br><span class="line">    Long <span class="keyword">user</span>Id = UserHolder.getUser().getId();</span><br><span class="line">    //<span class="number">2</span>.查询收件箱 ZREVRANGEBYSCORE key Max M<span class="keyword">in</span> LIMIT offset count</span><br><span class="line">    String key = FEED_KEY+<span class="keyword">user</span>Id;</span><br><span class="line">    Set<span class="variable">&lt;ZSetOperations.TypedTuple&lt;String&gt;</span>&gt; typedTuples = stringRedisTemplate.opsForZSet()</span><br><span class="line">            .reverseRangeByScoreWithScores(key, <span class="number">0</span>, <span class="keyword">max</span>, offset, <span class="number">3</span>);</span><br><span class="line">    //<span class="number">2.1</span>.非空判断</span><br><span class="line">    if(typedTuples==null || typedTuples.isEmpty())&#123;</span><br><span class="line">        return Result.ok();</span><br><span class="line">    &#125;</span><br><span class="line">    //<span class="number">3</span>.解析数据：blogId、<span class="keyword">min</span>Time(时间戳)、offset</span><br><span class="line">    List<span class="variable">&lt;Long&gt;</span> ids = new ArrayList<span class="variable">&lt;&gt;</span>(typedTuples.size());</span><br><span class="line">    long <span class="keyword">min</span>Time = <span class="number">0</span>;</span><br><span class="line">    int <span class="keyword">os</span> = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(ZSetOperations.TypedTuple<span class="variable">&lt;String&gt;</span> tuple:typedTuples)&#123;</span><br><span class="line">        //<span class="number">4.1</span>.获取id</span><br><span class="line">        String idStr = tuple.getValue();</span><br><span class="line">        ids.add(Long.valueOf(idStr));</span><br><span class="line">        //<span class="number">4.2</span>.获取分数</span><br><span class="line">        long time = tuple.getScore().longValue();</span><br><span class="line">        if(time == <span class="keyword">min</span>Time)&#123;</span><br><span class="line">            <span class="keyword">os</span>++;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            <span class="keyword">min</span>Time = time;</span><br><span class="line">            <span class="keyword">os</span>=<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //<span class="number">4</span>.根据id查询blog</span><br><span class="line">    String idStr = StrUtil.join(<span class="string">&quot;,&quot;</span>,ids);</span><br><span class="line">    List<span class="variable">&lt;Blog&gt;</span> blogs = query().<span class="keyword">in</span>(<span class="string">&quot;id&quot;</span>,ids).last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span>+idStr+<span class="string">&quot;)&quot;</span>).list();</span><br><span class="line">    <span class="keyword">for</span> (B<span class="keyword">log</span> blog : blogs) &#123;</span><br><span class="line">        isB<span class="keyword">log</span>Liked(blog);</span><br><span class="line">        User <span class="keyword">user</span> = <span class="keyword">user</span>Service.getById(blog.getUserId());</span><br><span class="line">        blog.<span class="built_in">set</span>Name(<span class="keyword">user</span>.getNickName());</span><br><span class="line">        blog.<span class="built_in">set</span>Icon(<span class="keyword">user</span>.getIcon());</span><br><span class="line">    &#125;</span><br><span class="line">    //<span class="number">5</span>.封装并返回</span><br><span class="line">    ScrollResult r = new ScrollResult();</span><br><span class="line">    r.<span class="built_in">set</span>List(blogs);</span><br><span class="line">    r.<span class="built_in">set</span>Offset(<span class="keyword">os</span>);</span><br><span class="line">    r.<span class="built_in">set</span>M<span class="keyword">in</span>Time(<span class="keyword">min</span>Time);</span><br><span class="line">    return Result.ok(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>获取当前用户</strong>：</p><ul><li>使用 <code>UserHolder.getUser().getId()</code> 获取当前登录用户的 ID。</li></ul><p><strong>查询动态流</strong>：</p><ul><li>使用 Redis 的 <code>reverseRangeByScoreWithScores</code> 命令按时间戳倒序获取动态流中的博客 ID。查询范围是从时间戳 0 到 <code>max</code>（即上次查询的最小时间戳），偏移量为 <code>offset</code>，每次查询 3 条数据。</li></ul><p><strong>处理查询结果</strong>：</p><ul><li>遍历查询结果，提取出博客的 ID 和时间戳。根据时间戳判断是否与上一次的最小时间戳相同，若相同，则偏移量加 1，若不同，则更新最小时间戳并重置偏移量。</li></ul><p><strong>查询博客信息</strong>：</p><ul><li>使用 <code>query().in(&quot;id&quot;, ids)</code> 根据查询到的博客 ID 查询博客详细信息，使用 <code>ORDER BY FIELD</code> 确保返回的博客顺序与 ID 列表一致。</li></ul><p><strong>返回结果</strong>：</p><ul><li>将查询到的博客信息、最小时间戳和偏移量封装在 <code>ScrollResult</code> 对象中，并返回给前端。</li></ul><p>效果图如下（我关注了小鱼同学，于是我可以看到小鱼同学发布的文章）：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-322.png" alt="img"></p><h2 id="10、附近商户">10、附近商户</h2><h3 id="10-1、附近商户-GEO数据结构的基本用法">10.1、附近商户-GEO数据结构的基本用法</h3><p>GEO是Geolocation的简写形式，代表地理坐标，在Redis的3.2版本后加入了GEO的支持，允许存储地理坐标信息，帮助我们根据经纬度来检索数据。</p><p>常见的命令有：</p><ol><li>GEOADD：添加一个地理空间信息，包含：经度（longitude）、纬度（latitude）、值（member）</li><li>GEODIST：计算指定的两个点之间的距离并返回</li><li>GEOHASH：将指定member的坐标转为hash字符串形式并返回</li><li>GEOPOS：返回指定member的坐标</li><li>GEORADIUS：指定圆心、半径，找到该圆内包含的所有member，并按照与圆心之间的距离排序后返回。6.以后已废弃</li><li>GEOSEARCH：在指定范围内搜索member，并按照与指定点之间的距离排序后返回。范围可以是圆形或矩形。6.2.新功能</li><li>GEOSEARCHSTORE：与GEOSEARCH功能一致，不过可以把结果存储到一个指定的key。 6.2.新功能</li></ol><h3 id="10-2、-附近商户-导入店铺数据到GEO">10.2、 附近商户-导入店铺数据到GEO</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-323-1024x421.png" alt="img"></p><p><strong>为什么使用 Redis GEO</strong>：</p><p>Redis 提供的 GEO 数据结构支持存储基于地理位置的成员，可以通过经纬度来存储地理坐标，并支持非常高效的基于距离的查询。这使得我们可以非常方便地进行以下操作：</p><ul><li><strong>插入商户的地理位置信息</strong>：将商户的经纬度和商户ID存入 Redis。</li><li><strong>根据距离查询商户</strong>：基于用户的当前位置，查询指定范围内的商户。</li></ul><p>具体场景说明：</p><p>当用户点击“美食”后，后台会根据用户的地理位置查询出周边的商户。查询的方式是：通过用户提供的地理坐标作为圆心，在 Redis 中根据经纬度存储商户信息，按距离来排序商户。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-324.png" alt="img"></p><p>我们要做的事情是：将数据库表中的数据导入到redis中去，redis中的GEO，GEO在redis中就一个menber和一个经纬度，我们把x和y轴传入到redis做的经纬度位置去，但我们不能把所有的数据都放入到menber中去，毕竟作为redis是一个内存级数据库，如果存海量数据，redis还是力不从心，所以我们在这个地方存储他的id即可。</p><p>但是这个时候还有一个问题，就是在redis中并没有存储type，所以我们无法根据type来对数据进行筛选，所以我们可以按照商户类型做分组，类型相同的商户作为同一组，以typeId为key存入同一个GEO集合中即可</p><p>在src/test/java/com/hmdp的HmDianPingApplicationTests类中写入如下的方法：</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="type">StringRedisTemplate</span> stringRedisTemplate;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line">void loadShopData()&#123;</span><br><span class="line">    <span class="comment">//1.查询店铺信息</span></span><br><span class="line">    <span class="type">List</span>&lt;<span class="type">Shop</span>&gt; list <span class="operator">=</span> shopService.list();</span><br><span class="line">    <span class="comment">//2.把店铺分组，按照typeId分组，typeId一致的放到一个集合</span></span><br><span class="line">    <span class="type">Map</span>&lt;<span class="type">Long</span>,<span class="type">List</span>&lt;<span class="type">Shop</span>&gt;&gt; map <span class="operator">=</span> list.stream().collect(<span class="type">Collectors</span>.groupingBy(Shop::getTypeId));</span><br><span class="line">    <span class="comment">//3.分批完成写入Redis</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">Map</span>.<span class="type">Entry</span>&lt;<span class="type">Long</span>, <span class="type">List</span>&lt;<span class="type">Shop</span>&gt;&gt; entry : map.entrySet()) &#123;</span><br><span class="line">        <span class="comment">//3.1.获取类型id</span></span><br><span class="line">        <span class="type">Long</span> typeid <span class="operator">=</span> entry.getKey();</span><br><span class="line">        <span class="type">String</span> key <span class="operator">=</span> <span class="string">&quot;shop:geo:&quot;</span><span class="operator">+</span>typeid;</span><br><span class="line">        <span class="comment">//3.2.获取同类型的店铺的集合</span></span><br><span class="line">        <span class="type">List</span>&lt;<span class="type">Shop</span>&gt; value <span class="operator">=</span> entry.getValue();</span><br><span class="line">        <span class="comment">//3.3.写入redis GEOADD key 经度 纬度 member</span></span><br><span class="line">        <span class="type">List</span>&lt;<span class="type">RedisGeoCommands</span>.<span class="type">GeoLocation</span>&lt;<span class="type">String</span>&gt;&gt; locations <span class="operator">=</span> new <span class="type">ArrayList</span>&lt;&gt;(value.size());</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">Shop</span> shop : value)&#123;</span><br><span class="line"><span class="comment">//                stringRedisTemplate.opsForGeo().add(key,new Point(shop.getX(),shop.getY()),shop.getId().toString());</span></span><br><span class="line">            locations.add(new <span class="type">RedisGeoCommands</span>.<span class="type">GeoLocation</span>&lt;&gt;(</span><br><span class="line">                    shop.getId().toString(),</span><br><span class="line">                    new <span class="type">Point</span>(shop.getX(),shop.getY())</span><br><span class="line">            ));</span><br><span class="line">        &#125;</span><br><span class="line">        stringRedisTemplate.opsForGeo().add(key,locations);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>步骤详解</strong>：</p><h4 id="1-查询商户信息：">1. <strong>查询商户信息</strong>：</h4><p>首先，从数据库中查询出所有的商户数据。</p><p><code>shopService.list()</code> 返回的是所有商户的信息，包括商户的经纬度（<code>x</code> 和 <code>y</code>）、商户类型（<code>typeId</code>）等。</p><ol start="2"><li><strong>将商户按类型分组</strong>：</li></ol><p>商户数据按 <code>typeId</code>（商户类型）进行分组，确保同类型的商户会存储在同一个 GEO 集合中。</p><p>通过 Java 8 的 <code>Collectors.groupingBy()</code> 方法，按照 <code>typeId</code> 对商户进行分组，返回一个以 <code>typeId</code> 为键的 <code>Map</code>，每个键对应一个商户类型的商户列表。</p><h4 id="3-将商户数据分批写入-Redis：">3. <strong>将商户数据分批写入 Redis</strong>：</h4><p>对于每一组商户，使用 Redis 的 <code>GEOADD</code> 命令将商户的经纬度数据添加到对应的 GEO 集合中。这样，我们就可以在 Redis 中为每种类型的商户创建一个单独的 GEO 集合。</p><ul><li><code>key</code>：以商户类型的 <code>typeId</code> 为键，创建一个对应的 Redis GEO 集合（如 <code>shop:geo:1</code> 对应类型为 1 的商户）。</li><li><code>locations</code>：这是一个 <code>List</code>，包含每个商户的 <code>GeoLocation</code>，每个商户的位置信息包括商户的 <code>ID</code> 和 <code>Point</code>（经纬度）。</li><li><code>stringRedisTemplate.opsForGeo().add(key, locations)</code>：通过 <code>stringRedisTemplate</code> 的 <code>Geo</code> 操作将商户的位置信息批量写入 Redis 中。</li></ul><h4 id="关于-Redis-GEO-的存储和查询："><strong>关于 Redis GEO 的存储和查询</strong>：</h4><ul><li><strong>存储数据</strong>：每个商户的 ID 作为 Redis GEO 集合的 member，商户的经纬度作为对应的 <code>Point</code> 存储在 Redis 中。</li><li><strong>查询数据</strong>：存储完成后，我们可以使用 Redis 提供的 GEO 命令来进行基于地理位置的查询。例如，可以查询给定坐标范围内的商户，或者根据用户的位置，查询附近的商户。</li></ul><p>测试：点击运行之后，在Redis中能够看到导入的数据：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-325-1024x608.png" alt="img"></p><h3 id="10-3-附近商户-实现附近商户功能">10.3 附近商户-实现附近商户功能</h3><p>SpringDataRedis的2.3.9版本并不支持Redis 6.2提供的GEOSEARCH命令，因此我们需要提示其版本，修改自己的POM</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.1.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li><strong><code>spring-data-redis</code></strong> 升级至 2.6.2 版本，以支持 Redis 6.2 新特性。</li><li><strong><code>lettuce-core</code></strong> 升级至 6.1.6 版本，确保支持 <code>GEOSEARCH</code> 命令。</li></ul><p>在ShopController中修改queryShopByType方法：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@GetMapping</span>(<span class="string">&quot;/of/type&quot;</span>)</span><br><span class="line">public Result <span class="built_in">queryShopByType</span>(</span><br><span class="line">        <span class="variable">@RequestParam</span>(<span class="string">&quot;typeId&quot;</span>) Integer typeId,</span><br><span class="line">        <span class="variable">@RequestParam</span>(value = <span class="string">&quot;current&quot;</span>, defaultValue = <span class="string">&quot;1&quot;</span>) Integer current,</span><br><span class="line">        <span class="variable">@RequestParam</span>(value=<span class="string">&quot;x&quot;</span>,required=false) Double x,</span><br><span class="line">        <span class="variable">@RequestParam</span>(value=<span class="string">&quot;y&quot;</span>,required=false) Double y</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="selector-tag">return</span> <span class="selector-tag">shopService</span><span class="selector-class">.queryShopByType</span>(typeId,current,x,y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong><code>typeId</code></strong>：商户类型ID，用于区分不同的商户。</li><li><strong><code>current</code></strong>：当前页，默认为1，用于分页。</li><li><strong><code>x</code> 和 <code>y</code></strong>：可选的经纬度，用于查询附近的商户。如果为空，则不按距离查询。</li></ul><p>在IShopService接口中写入如下方法：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Result</span> queryShopByType(<span class="type">Integer</span> typeId, <span class="type">Integer</span> <span class="keyword">current</span>, <span class="keyword">Double</span> x, <span class="keyword">Double</span> y);</span><br></pre></td></tr></table></figure><p>在ShopServiceImpl类中写入如下方法：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="keyword">public</span> Result queryShopByType(Integer typeId, Integer current, <span class="keyword">Double</span> x, <span class="keyword">Double</span> y) &#123;</span><br><span class="line">    <span class="comment">//1.判断是否需要根据坐标查询</span></span><br><span class="line">    <span class="keyword">if</span>(x==<span class="keyword">null</span> || y==<span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="comment">//不需要查询坐标，按数据库查</span></span><br><span class="line">        Page&lt;Shop&gt; page = query()</span><br><span class="line">                .eq(<span class="string">&quot;type_id&quot;</span>,typeId)</span><br><span class="line">                .page(<span class="keyword">new</span> Page&lt;&gt;(current, SystemConstants.DEFAULT_PAGE_SIZE));</span><br><span class="line">        <span class="keyword">return</span> Result.ok(page.getRecords());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2.计算分页参数</span></span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">from</span> = (current - <span class="number">1</span>)*SystemConstants.DEFAULT_PAGE_SIZE;</span><br><span class="line">    <span class="keyword">int</span> end = current*SystemConstants.DEFAULT_PAGE_SIZE;</span><br><span class="line">    <span class="comment">//3.查询redis，按照距离排序、分页。结果：shopId,distance</span></span><br><span class="line">    String key = SHOP_GEO_KEY+typeId;</span><br><span class="line">    GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = stringRedisTemplate.opsForGeo()</span><br><span class="line">            .search(</span><br><span class="line">                    key,</span><br><span class="line">                    GeoReference.fromCoordinate(x, y),</span><br><span class="line">                    <span class="keyword">new</span> Distance(<span class="number">5000</span>),</span><br><span class="line">                    RedisGeoCommands.GeoSearchCommandArgs.newGeoSearchArgs().includeDistance().limit(end)</span><br><span class="line">            );</span><br><span class="line">    <span class="comment">//4.解析出id</span></span><br><span class="line">    <span class="keyword">if</span>(results==<span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; list = results.getContent();</span><br><span class="line">    <span class="comment">//4.1.截取from-end的部分</span></span><br><span class="line">    List&lt;<span class="keyword">Long</span>&gt; ids = <span class="keyword">new</span> ArrayList&lt;&gt;(list.<span class="keyword">size</span>());</span><br><span class="line">    Map&lt;String,Distance&gt; distanceMap = <span class="keyword">new</span> HashMap&lt;&gt;(list.<span class="keyword">size</span>());</span><br><span class="line">    <span class="keyword">if</span>(list.<span class="keyword">size</span>()&lt;=<span class="keyword">from</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">    list.stream().skip(<span class="keyword">from</span>).forEach(result-&gt;&#123; <span class="comment">//跳过可能把所有数据跳过了</span></span><br><span class="line">        <span class="comment">//4.2.获取店铺id</span></span><br><span class="line">        String shopIdStr = result.getContent().getName();</span><br><span class="line">        ids.add(<span class="keyword">Long</span>.valueOf(shopIdStr));</span><br><span class="line">        <span class="comment">//4.3.获取距离</span></span><br><span class="line">        Distance distance = result.getDistance();</span><br><span class="line">        distanceMap.put(shopIdStr,distance);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//5.根据id查询shop</span></span><br><span class="line">    String idStr = StrUtil.<span class="keyword">join</span>(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">    List&lt;Shop&gt; shops = query().in(<span class="string">&quot;id&quot;</span>, ids).last(<span class="string">&quot;ORDER BY FIELD ( id,&quot;</span> + idStr + <span class="string">&quot;)&quot;</span>).list();</span><br><span class="line">    <span class="keyword">for</span>(Shop shop : shops)&#123;</span><br><span class="line">        shop.setDistance(distanceMap.get(shop.getId().toString()).getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6、返回</span></span><br><span class="line">    <span class="keyword">return</span> Result.ok(shops);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="步骤-1：判断是否需要根据坐标查询"><strong>步骤 1：判断是否需要根据坐标查询</strong></h4><p>首先检查 <code>x</code> 和 <code>y</code> 是否为空，如果为空，则不需要根据坐标查询，直接从数据库中查询商户信息。如果 <code>x</code> 和 <code>y</code> 不为空，则表示需要根据经纬度查询附近的商户。</p><h4 id="步骤-2：计算分页参数"><strong>步骤 2：计算分页参数</strong></h4><p>根据当前页数 <code>current</code>，计算分页的起始位置 <code>from</code> 和结束位置 <code>end</code>。这将用于从查询结果中提取对应的数据。</p><h4 id="步骤-3：查询-Redis-中的商户数据"><strong>步骤 3：查询 Redis 中的商户数据</strong></h4><p>使用 Redis 的 <code>GEOSEARCH</code> 命令查询商户，根据用户提供的经纬度（<code>x</code>, <code>y</code>）计算距离，筛选出距离用户位置在一定范围内的商户。</p><ul><li><code>SHOP_GEO_KEY + typeId</code>：Redis 中存储商户位置信息的键，以商户类型 <code>typeId</code> 为区分。</li><li><code>GeoReference.fromCoordinate(x, y)</code>：通过用户提供的经纬度创建 <code>GeoReference</code>。</li><li><code>new Distance(5000)</code>：设置查询的半径为 5000 米，即查询 5 公里范围内的商户。</li><li><code>limit(end)</code>：限制返回的商户数量。</li></ul><h4 id="步骤-4：解析查询结果"><strong>步骤 4：解析查询结果</strong></h4><p>从 Redis 返回的结果中提取商户 ID 和距离信息，并根据分页参数截取需要的数据。</p><ul><li>使用 <code>skip(from)</code> 跳过不需要的商户数据，确保从正确的起始位置开始提取商户。</li><li>提取商户的 ID 和距离信息，存入 <code>ids</code> 和 <code>distanceMap</code>。</li></ul><h4 id="步骤-5：根据商户-ID-查询商户详情"><strong>步骤 5：根据商户 ID 查询商户详情</strong></h4><p>根据提取到的商户 ID，从数据库中查询商户的详细信息，并将查询到的距离信息添加到商户数据中。</p><h4 id="步骤-6：返回结果"><strong>步骤 6：返回结果</strong></h4><p>最终返回商户的详细信息以及距离。</p><p>效果：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-326.png" alt="img"></p><h2 id="11、用户签到">11、用户签到</h2><h3 id="11-1、用户签到-BitMap功能演示">11.1、用户签到-BitMap功能演示</h3><p>我们针对签到功能完全可以通过mysql来完成，比如说以下这张表</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-327.png" alt="img"></p><p>用户一次签到，就是一条记录，假如有1000万用户，平均每人每年签到次数为10次，则这张表一年的数据量为 1亿条</p><p>每签到一次需要使用（8 + 8 + 1 + 1 + 3 + 1）共22 字节的内存，一个月则最多需要600多字节</p><p>我们如何能够简化一点呢？其实可以考虑小时候一个挺常见的方案，就是小时候，咱们准备一张小小的卡片，你只要签到就打上一个勾，我最后判断你是否签到，其实只需要到小卡片上看一看就知道了</p><p>我们可以采用类似这样的方案来实现我们的签到需求。</p><p>在实际场景中，可能有很多用户每月的签到记录。例如，假设每个用户每月有 30 天的签到记录，我们可以为每个用户使用一个 BitMap 来记录他们的签到情况。每位用户的签到信息会对应一个 1 或 0，1 表示签到，0 表示未签到。</p><p>把每一个bit位对应当月的每一天，形成了映射关系。用0和1标示业务状态，这种思路就称为位图（BitMap）。这样我们就用极小的空间，来实现了大量数据的表示</p><p>Redis中是利用string类型数据结构实现BitMap，因此最大上限是512M，转换为bit则是 2^32个bit位。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-328-1024x225.png" alt="img"></p><p>每天的签到是一个二进制位，1 表示签到，0 表示未签到。每个用户每月的签到数据就对应一个长度为 30 或 31 的二进制数。</p><p>假设一个用户的签到记录是：<br><code>1110101001001010111011001...</code><br>每个位置对应一个日期，1 表示该日期签到，0 表示未签到。</p><p>BitMap的操作命令有：</p><ul><li>SETBIT：向指定位置（offset）存入一个0或1</li><li>GETBIT ：获取指定位置（offset）的bit值</li><li>BITCOUNT ：统计BitMap中值为1的bit位的数量</li><li>BITFIELD ：操作（查询、修改、自增）BitMap中bit数组中的指定位置（offset）的值</li><li>BITFIELD_RO ：获取BitMap中bit数组，并以十进制形式返回</li><li>BITOP ：将多个BitMap的结果做位运算（与 、或、异或）</li><li>BITPOS ：查找bit数组中指定范围内第一个0或1出现的位置</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-329.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-330.png" alt="img"></p><p><strong>BITFIELD key GET</strong>(代表查询) <strong>u</strong>(u代表无符号，i代表有符号)<strong>截取几位作为结果 开始的位置</strong></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-333.png" alt="img"></p><h3 id="11-2-、用户签到-实现签到功能">11.2 、用户签到-实现签到功能</h3><p>需求：实现签到接口，将当前用户当天签到信息保存到Redis中</p><p>思路：</p><ul><li>将每个用户的签到数据以 <code>BitMap</code> 的形式存储。<code>BitMap</code> 通过位来表示数据，签到的位为 <code>1</code>，未签到的位为 <code>0</code>。</li><li>每次签到时，更新对应日期的位置（即每个用户的签到信息）。</li></ul><p>我们通过接口文档发现，此接口并没有传递任何的参数，没有参数怎么确实是哪一天签到呢？这个很容易，可以通过后台代码直接获取即可，然后到对应的地址上去修改bitMap。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-334-1024x510.png" alt="img"></p><p><strong>代码</strong></p><p>UserController</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">&quot;/sign&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="function">Result <span class="title">sign</span><span class="params">()</span></span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">return</span> userService.<span class="title">sign</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>UserServiceImpl</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sign</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1.获取当前登录用户</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">// 2.获取日期</span></span><br><span class="line">    <span class="type">LocalDateTime</span> <span class="variable">now</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="comment">// 3.拼接key</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">keySuffix</span> <span class="operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;:yyyyMM&quot;</span>));</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> USER_SIGN_KEY + userId + keySuffix;</span><br><span class="line">    <span class="comment">// 4.获取今天是本月的第几天</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">dayOfMonth</span> <span class="operator">=</span> now.getDayOfMonth();</span><br><span class="line">    <span class="comment">// 5.写入Redis SETBIT key offset 1</span></span><br><span class="line">    stringRedisTemplate.opsForValue().setBit(key, dayOfMonth - <span class="number">1</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> Result.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 <code>UserServiceImpl</code> 中，具体实现签到的功能。代码执行的步骤如下：</p><ul><li><strong>获取当前用户 ID</strong>：通过 <code>UserHolder.getUser().getId()</code> 获取当前用户的 ID。</li><li><strong>获取当前日期</strong>：使用 <code>LocalDateTime.now()</code> 获取当前日期，用于计算当天的日期。</li><li><strong>构建 Redis <code>key</code></strong>：根据用户 ID 和当前年月（格式：<code>yyyyMM</code>）构建 Redis 的 <code>key</code>，即 <code>USER_SIGN_KEY + userId + keySuffix</code>，其中 <code>keySuffix</code> 为年月。</li><li><strong>计算今天是本月的第几天</strong>：通过 <code>now.getDayOfMonth()</code> 获取今天是本月的第几天（例如 1、2、3…）。</li><li><strong>更新 Redis 中的 BitMap</strong>：通过 <code>stringRedisTemplate.opsForValue().setBit(key, dayOfMonth - 1, true)</code> 将对应日期的签到状态设置为 <code>1</code>，表示该用户已签到。</li></ul><p><code>SETBIT key offset 1</code>：将 <code>key</code> 对应的 BitMap 中的 <code>offset</code> 位置设置为 <code>1</code>，表示用户在该日期已签到。</p><ul><li><code>key</code>：用户某个月的签到记录。</li><li><code>offset</code>：签到的日期，<code>dayOfMonth - 1</code>（如 1 号签到对应的 <code>offset</code> 为 0）。</li><li><code>true</code>：表示该日期已签到（1），<code>false</code> 表示未签到（0）。</li></ul><p>用Apifox进行测试：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-335-1024x453.png" alt="img"></p><h3 id="11-3-用户签到-签到统计">11.3 用户签到-签到统计</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-337.png" alt="img"></p><p>在UserController类中写入如下代码：</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">&quot;/sign/count&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="function">Result <span class="title">signCount</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">return</span> userService.<span class="title">signCount</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在IUserService类中写入如下代码：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Result <span class="title">signCount</span>()</span>;</span><br></pre></td></tr></table></figure><p>在UserServiceImpl类中写入如下代码：</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">public Result signCount() &#123;</span><br><span class="line">    <span class="comment">//1.获取当前登录用户</span></span><br><span class="line">    Long userId = UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">//2.获取日期</span></span><br><span class="line">    LocalDateTime now = LocalDateTime.now();</span><br><span class="line">    <span class="comment">//3.拼接key</span></span><br><span class="line">    <span class="built_in">String</span> keySuffix = now.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyyMM&quot;</span>));</span><br><span class="line">    <span class="built_in">String</span> key = USER_SIGN_KEY + userId + keySuffix;</span><br><span class="line">    <span class="comment">//4.获取今天是本月第几天</span></span><br><span class="line">    <span class="built_in">int</span> dayOfMonth = now.getDayOfMonth();</span><br><span class="line">    <span class="comment">//5.获取本月截止今天为止的所有的签到记录，返回的是一个十进制的数字 BITFIELD sign:5:202203 GET u14 0</span></span><br><span class="line">    <span class="built_in">List</span>&lt;Long&gt; result = stringRedisTemplate.opsForValue().bitField(</span><br><span class="line">            key, BitFieldSubCommands.create()</span><br><span class="line">                    .<span class="keyword">get</span>(BitFieldSubCommands.BitFieldType.unsigned(dayOfMonth)).valueAt(<span class="number">0</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span>(result==<span class="keyword">null</span> || result.isEmpty())&#123;</span><br><span class="line">        <span class="comment">//没有任何签到结果</span></span><br><span class="line">        <span class="keyword">return</span> Result.ok(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Long <span class="built_in">num</span> = result.<span class="keyword">get</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">num</span>==<span class="keyword">null</span> || <span class="built_in">num</span>==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//6.循环遍历</span></span><br><span class="line">    <span class="built_in">int</span> count=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">        <span class="comment">//6.1.让这个数字与1做与运算，得到数字的最后一个bit位</span></span><br><span class="line">        <span class="keyword">if</span>((<span class="built_in">num</span>&amp;<span class="number">1</span>)==<span class="number">0</span>)&#123;<span class="comment">//6.2.判断这个bit位是否为0</span></span><br><span class="line">            <span class="comment">//6.3.如果为0，说明未签到结束</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//6.4.如果不为0，说明已签到，计数器+1</span></span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//6.5.把数字右移一位，抛弃最后一个bit位,继续下一个bit位</span></span><br><span class="line">        <span class="built_in">num</span> &gt;&gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> Result.ok(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>步骤 1</strong>：获取当前登录用户的 ID。</li><li><strong>步骤 2</strong>：获取当前日期。</li><li><strong>步骤 3</strong>：拼接 Redis <code>key</code>，格式为 <code>USER_SIGN_KEY + userId + &quot;yyyyMM&quot;</code>，用于标识每个月的签到数据。</li><li><strong>步骤 4</strong>：获取今天是本月的第几天，即 <code>dayOfMonth</code>。</li><li><strong>步骤 5</strong>：使用 <code>BITFIELD</code> 命令获取当前月截至今天的签到数据。通过 <code>BitFieldSubCommands</code> 设置获取签到信息的位数。</li><li><strong>步骤 6</strong>：遍历签到数据，通过位操作（与运算）统计连续签到的天数。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-338-1024x449.png" alt="img"></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-339.png" alt="img"></p><p>11.4 额外补充-关于使用bitmap来解决缓存穿透的方案</p><p>回顾<strong>缓存穿透</strong>：</p><p><strong>缓存穿透问题概述</strong>：</p><ul><li>典型的解决办法是 <strong>缓存空值</strong>，即当数据库查询返回空数据时，将这个空数据也存入缓存，以防止相同的无效查询频繁访问数据库。</li><li><strong>缓存穿透</strong>指的是用户请求的数据既不在缓存中，也不在数据库中。每次用户请求的都可能是一个不存在的数据。攻击者可以通过不断请求不存在的数据来绕过缓存，直接访问数据库，造成数据库负担过重。</li></ul><p><strong>传统解决方案</strong>：</p><p>在传统解决方案中，如果数据库中没有数据，缓存中也没有，我们就会把该数据标记为空并存入缓存，这样下一次请求该数据时直接从缓存中获取。但这个方法存在的问题是：</p><ul><li>如果查询的是不同的 ID 数据，缓存会逐渐变得非常大，占用较多内存。</li><li>如果请求的是某个不存在的数据，缓存无法从一开始解决。</li></ul><p>所以我们如何解决呢？</p><p>为了更有效地解决缓存穿透问题并优化存储空间，我们可以使用 <strong>BitMap</strong> 代替 <strong>List</strong> 来存储 ID 数据。</p><h4 id="思路："><strong>思路</strong>：</h4><ol><li><strong>数据存储方式</strong>：将所有合法的 ID 存储到一个非常大的 <strong>BitMap</strong> 中。每个 ID 的位置（即索引）对应于 BitMap 的某一位。当用户访问某个 ID 时，我们通过哈希算法（如 <code>id % bitmap.size</code>）计算出该 ID 应该存储在 BitMap 的哪个位置，并将该位置的值设置为 1，表示该数据已经存在。</li><li><strong>查询过程</strong>：当用户查询某个数据时，我们同样通过哈希算法计算该 ID 应该落在 BitMap 的哪个位置。如果该位置的值为 1，表示该数据存在；如果为 0，则表示该数据不存在，可以直接返回，不访问数据库。</li></ol><h4 id="步骤："><strong>步骤</strong>：</h4><ol><li><p>将 ID 数据存储到 BitMap</p><p>：例如，使用 Redis 的</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">SETBIT</span></span><br></pre></td></tr></table></figure><p>命令将某个 ID 对应的位设置为</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1</span><br></pre></td></tr></table></figure><p>，表示该 ID 对应的数据存在。</p><ul><li><code>SETBIT key offset 1</code>：设置 <code>key</code> 对应的位（由 ID 计算得出）为 1，表示数据存在。</li></ul></li><li><p><strong>查询时通过哈希计算位置</strong>：当用户请求某个 ID 时，使用哈希算法（<code>id % bitmap.size</code>）计算出该 ID 在 BitMap 中的偏移位置。如果该位置为 1，则表示该数据存在，反之为 0，则说明该数据不存在。</p></li></ol><h4 id="优点："><strong>优点</strong>：</h4><ul><li><strong>节省内存</strong>：BitMap 只用一个比特位来表示一个数据的存在与否，相比 List 或 HashMap 等数据结构，它能够显著减少内存占用。</li><li><strong>高效查询</strong>：BitMap 的查询操作非常快速，通过直接访问对应的位来判断数据是否存在，查询复杂度为 O(1)。</li></ul><h4 id="误差率："><strong>误差率</strong>：</h4><p>由于使用哈希算法来映射 ID 到 BitMap 中的位，因此可能会发生 <strong>哈希冲突</strong>。如果多个 ID 被映射到 BitMap 的同一位上，可能会出现误判的情况（即认为某个数据存在，但实际并不存在）。这种情况称为误差率。</p><p>误差率会随着哈希冲突的增加而增大，通常我们可以通过增加 BitMap 的大小来降低误差率。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-340-1024x260.png" alt="img"></p><ul><li>用户发起请求，查询某个数据（如 ID 为 1、2、3 的数据）。</li><li>数据被存储到 Redis 中，通过 <code>List</code> 存储 ID 数据。查询时，通过检查 <code>List</code> 是否包含对应的 ID 数据来判断缓存是否命中。</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-341-1024x432.png" alt="img"></p><ul><li>将 <code>List</code> 数据结构替换成 <code>BitMap</code>，并使用哈希算法将每个 ID 映射到 BitMap 的某一位。</li><li>使用 Redis 的 BitMap（<code>SETBIT</code> 和 <code>GETBIT</code>）操作，减少了 <code>List</code> 存储空间，并且提高了查询效率。</li></ul><h4 id="具体操作："><strong>具体操作</strong>：</h4><ul><li><strong>SETBIT</strong>：设置某个位为 <code>1</code>，表示数据存在。</li><li><strong>GETBIT</strong>：获取某个位的值，判断数据是否存在。</li></ul><h2 id="12、UV统计">12、UV统计</h2><h3 id="12-1-、UV统计-HyperLogLog">12.1 、UV统计-HyperLogLog</h3><p>首先我们搞懂两个概念：</p><ul><li>UV：全称Unique Visitor，也叫独立访客量，是指通过互联网访问、浏览这个网页的自然人。1天内同一个用户多次访问该网站，只记录1次。</li><li>PV：全称Page View，也叫页面访问量或点击量，用户每访问网站的一个页面，记录1次PV，用户多次打开页面，则记录多次PV。往往用来衡量网站的流量。</li></ul><p>通常来说UV会比PV大很多，所以衡量同一个网站的访问量，我们需要综合考虑很多因素，所以我们只是单纯的把这两个值作为一个参考值</p><p>UV统计在服务端做会比较麻烦，因为要判断该用户是否已经统计过了，需要将统计过的用户信息保存。但是如果每个访问的用户都保存到Redis中，数据量会非常恐怖，那怎么处理呢？</p><p>Hyperloglog(HLL)是从Loglog算法派生的概率算法，用于确定非常大的集合的基数，而不需要存储其所有值。相关算法原理大家可以参考：<a href="https://juejin.cn/post/6844903785744056333#heading-0">https://juejin.cn/post/6844903785744056333#heading-0</a> Redis中的HLL是基于string结构实现的，单个HLL的内存<strong>永远小于16kb</strong>，<strong>内存占用低</strong>的令人发指！作为代价，其测量结果是概率性的，<strong>有小于0.81％的误差</strong>。不过对于UV统计来说，这完全可以忽略。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-342-1024x356.png" alt="img"></p><p>不论添加几次，永远只记录一次。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-344.png" alt="img"></p><h3 id="12-2-UV统计-测试百万数据的统计">12.2 UV统计-测试百万数据的统计</h3><p>测试思路：我们直接利用单元测试，向HyperLogLog中添加100万条数据，看看内存占用和统计效果如何</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-343-1024x506.png" alt="img"></p><p>经过测试：我们会发生他的误差是在允许范围内，并且内存占用极小</p><p>100万数据成功写入：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-345-1024x556.png" alt="img"></p><p>测试前：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-346.png" alt="img"></p><p>测试后：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-347.png" alt="img"></p><p>大约占用11kb，确实是小于16kb。</p><h1 id="Redis-实战篇-黑马点评-完结">Redis(实战篇-黑马点评) 完结</h1>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis基础篇</title>
      <link href="/posts/5.html"/>
      <url>/posts/5.html</url>
      
        <content type="html"><![CDATA[<h2 id="1-初识Redis">1.初识Redis</h2><p>Redis是一种键值型的NoSql数据库，这里有两个关键字：</p><ul><li>键值型</li><li>NoSql</li></ul><p>其中<strong>键值型</strong>，是指Redis中存储的数据都是以key、value对的形式存储，而value的形式多种多样，可以是字符串、数值、甚至json：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-1024x416.png" alt="img"></p><h3 id=""></h3><h3 id="1-1-认识NoSQL">1.1.认识NoSQL</h3><p><strong>NoSql</strong>可以翻译做Not Only Sql（不仅仅是SQL），或者是No Sql（非Sql的）数据库。是相对于传统关系型数据库而言，有很大差异的一种特殊的数据库，因此也称之为<strong>非关系型数据库</strong>。</p><ul><li>Redis</li><li>Mongo db</li><li>MemCached</li></ul><h4 id="1-1-1-结构化与非结构化">1.1.1.结构化与非结构化</h4><p>传统关系型数据库是结构化数据，每一张表都有严格的约束信息：字段名、字段数据类型、字段约束等等信息，插入的数据必须遵守这些约束：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-2.png" alt="img"></p><p>而NoSql则对数据库格式没有严格约束，往往形式松散，自由。</p><p>可以是键值型：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-3.png" alt="img"></p><p>也可以是文档型：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-4.png" alt="img"></p><p>甚至可以是图格式：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-5.png" alt="img"></p><h4 id="1-1-2-关联和非关联">1.1.2.关联和非关联</h4><p>传统数据库的表与表之间往往存在关联，例如外键：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-6-1024x520.png" alt="img"></p><p>而非关系型数据库不存在关联关系，要维护关系要么靠代码中的业务逻辑，要么靠数据之间的耦合：</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="params">id:</span> <span class="number">1</span>,</span><br><span class="line">  <span class="params">name:</span> <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">  <span class="params">orders:</span> [</span><br><span class="line">    &#123;</span><br><span class="line">       <span class="params">id:</span> <span class="number">1</span>,</span><br><span class="line">       <span class="params">item:</span> &#123;</span><br><span class="line">     <span class="params">id:</span> <span class="number">10</span>, <span class="params">title:</span> <span class="string">&quot;荣耀6&quot;</span>, <span class="params">price:</span> <span class="number">4999</span></span><br><span class="line">       &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">       <span class="params">id:</span> <span class="number">2</span>,</span><br><span class="line">       <span class="params">item:</span> &#123;</span><br><span class="line">     <span class="params">id:</span> <span class="number">20</span>, <span class="params">title:</span> <span class="string">&quot;小米11&quot;</span>, <span class="params">price:</span> <span class="number">3999</span></span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此处要维护“张三”的订单与商品“荣耀”和“小米11”的关系，不得不冗余的将这两个商品保存在张三的订单文档中，不够优雅。还是建议用业务来维护关联关系。</p><h4 id="1-1-3-查询方式">1.1.3.查询方式</h4><p>传统关系型数据库会基于Sql语句做查询，语法有统一标准；</p><p>而不同的非关系数据库查询语法差异极大，五花八门各种各样。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-7-1024x391.png" alt="img"></p><h4 id="1-1-4-事务">1.1.4.事务</h4><p>传统关系型数据库能满足事务ACID的原则。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-8.png" alt="img"></p><p>而非关系型数据库往往不支持事务，或者不能严格保证ACID的特性，只能实现基本的一致性。</p><h4 id="1-1-5-总结">1.1.5.总结</h4><p>除了上述四点以外，在存储方式、扩展性、查询性能上关系型与非关系型也都有着显著差异，总结如下：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-9-1024x483.png" alt="img"></p><ul><li>存储方式<ul><li>关系型数据库基于磁盘进行存储，会有大量的磁盘IO，对性能有一定影响</li><li>非关系型数据库，他们的操作更多的是依赖于内存来操作，内存的读写速度会非常快，性能自然会好一些</li></ul></li><li>扩展性<ul><li>关系型数据库集群模式一般是主从，主从数据一致，起到数据备份的作用，称为垂直扩展。</li><li>非关系型数据库可以将数据拆分，存储在不同机器上，可以保存海量数据，解决内存大小有限的问题。称为水平扩展。</li><li>关系型数据库因为表之间存在关联关系，如果做水平扩展会给数据查询带来很多麻烦</li></ul></li></ul><h3 id="1-2-认识Redis">1.2.认识Redis</h3><p><strong>特征</strong>：</p><ul><li>键值（key-value）型，value支持多种不同数据结构，功能丰富</li><li>单线程，每个命令具备原子性</li><li>低延迟，速度快（基于内存、IO多路复用、良好的编码）。</li><li>支持数据持久化</li><li>支持主从集群、分片集群</li><li>支持多语言客户端</li></ul><h3 id="1-3-Redis的启动">1.3 Redis的启动</h3><p>redis的启动方式有很多种，例如：</p><ul><li>默认启动</li><li>指定配置启动</li><li>开机自启</li></ul><h4 id="1-3-1默认启动">1.3.1默认启动</h4><p>安装完成后，在任意目录输入redis-server命令即可启动Redis：</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-<span class="keyword">server</span></span><br></pre></td></tr></table></figure><h4 id="1-3-2-指定配置启动">1.3.2.指定配置启动</h4><p>如果要让Redis以<code>后台</code>方式启动，则必须修改Redis配置文件</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 进入redis安装目录 </span></span><br><span class="line"><span class="meta"># 启动</span></span><br><span class="line">redis-<span class="keyword">server</span>.exe redis.windows.conf</span><br><span class="line">Redis服务默认端口号为 <span class="number">6379</span> ，通过快捷键Ctrl + C 即可停止Redis服务</span><br><span class="line"></span><br><span class="line">当Redis服务启动成功后，可通过客户端进行连接。</span><br></pre></td></tr></table></figure><p>然后修改redis.conf文件中的一些配置：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 允许访问的地址，默认是127.0.0.1，会导致只能在本地访问。修改为0.0.0.0则可以在任意IP访问，生产环境不要设置为0.0.0.0</span></span><br><span class="line"><span class="attribute">bind</span> <span class="number">0.0.0.0</span></span><br><span class="line"><span class="comment"># 守护进程，修改为yes后即可后台运行 （windows不支持）</span></span><br><span class="line">daemonize <span class="literal">yes</span> </span><br><span class="line"><span class="comment"># 密码，设置后访问Redis必须输入密码</span></span><br><span class="line">requirepass <span class="number">123456</span></span><br></pre></td></tr></table></figure><p>Redis的其它常见配置：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 监听的端口</span></span><br><span class="line"><span class="attribute">port</span> <span class="number">6379</span></span><br><span class="line"><span class="comment"># 工作目录，默认是当前目录，也就是运行redis-server时的命令，日志、持久化等文件会保存在这个目录</span></span><br><span class="line"><span class="attribute">dir</span> .</span><br><span class="line"><span class="comment"># 数据库数量，设置为1，代表只使用1个库，默认有16个库，编号0~15</span></span><br><span class="line"><span class="attribute">databases</span> <span class="number">1</span></span><br><span class="line"><span class="comment"># 设置redis能够使用的最大内存</span></span><br><span class="line"><span class="attribute">maxmemory</span> <span class="number">512</span>mb</span><br><span class="line"><span class="comment"># 日志文件，默认为空，不记录日志，可以指定日志文件名</span></span><br><span class="line"><span class="attribute">logfile</span> <span class="string">&quot;redis.log&quot;</span></span><br></pre></td></tr></table></figure><p>停止服务：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 利用redis-cli来执行 shutdown 命令，即可停止 Redis 服务，</span></span><br><span class="line"><span class="comment"># 因为之前配置了密码，因此需要通过 -u 来指定密码</span></span><br><span class="line"><span class="attribute">redis</span>-cli -u <span class="number">123456</span> shutdown</span><br></pre></td></tr></table></figure><h4 id="1-3-3-客户端连接命令">1.3.3 客户端连接命令</h4><p><strong>redis-cli.exe</strong></p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-10-1024x261.png" alt="img"></p><p>通过redis-cli.exe命令默认连接的是本地的redis服务，并且使用默认6379端口。也可以通过指定如下参数连接：</p><ul><li>-h ip地址</li><li>-p 端口号</li><li>-a 密码（如果需要）</li><li></li></ul><h4 id="1-3-4Redis客户端图形工具">1.3.4Redis客户端图形工具</h4><p>默认提供的客户端连接工具界面不太友好，同时操作也较为麻烦，需引入一个Redis客户端图形工具。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-11-1024x771.png" alt="img"></p><h2 id="2-Redis数据类型">2. Redis数据类型</h2><h3 id="2-1-五种常用数据类型介绍">2.1 五种常用数据类型介绍</h3><p>Redis存储的是key-value结构的数据，其中key是字符串类型，value有5种常用的数据类型：</p><ul><li>字符串 string</li><li>哈希 hash</li><li>列表 list</li><li>集合 set</li><li>有序集合 sorted set / zset</li></ul><h3 id="2-2-各种数据类型特点">2.2 各种数据类型特点</h3><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-12.png" alt="img"></p><p><strong>解释说明：</strong></p><ul><li>字符串(string)：普通字符串，Redis中最简单的数据类型</li><li>哈希(hash)：也叫散列，类似于Java中的HashMap结构</li><li>列表(list)：按照插入顺序排序，可以有重复元素，类似于Java中的LinkedList</li><li>集合(set)：无序集合，没有重复元素，类似于Java中的HashSet</li><li>有序集合(sorted set/zset)：集合中每个元素关联一个分数(score)，根据分数升序排序，没有重复元素</li></ul><p>Redis是典型的key-value数据库，key一般是字符串，而value包含很多不同的数据类型：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-13-1024x516.png" alt="img"></p><h2 id="3-Redis常用命令">3. Redis常用命令</h2><h3 id="3-1-String字符串操作命令">3.1 String字符串操作命令</h3><p>Redis 中字符串类型常用命令：</p><ul><li>SET：添加或者修改已经存在的一个String类型的键值对</li><li>GET：根据key获取String类型的value</li><li>MSET：批量添加多个String类型的键值对</li><li>MGET：根据多个key获取多个String类型的value</li><li>INCR：让一个整型的key自增1</li><li>INCRBY:让一个整型的key自增并指定步长，例如：incrby num 2 让num值自增2</li><li>INCRBYFLOAT：让一个浮点类型的数字自增并指定步长</li><li>SETNX：添加一个String类型的键值对，前提是这个key不存在，否则不执行</li><li>SETEX：添加一个String类型的键值对，并且指定有效期</li></ul><p>更多命令可以参考Redis中文网：<a href="https://www.redis.net.cn/">https://www.redis.net.cn</a></p><h3 id="3-2-Hash哈希操作命令">3.2 Hash哈希操作命令</h3><p>Redis hash 是一个string类型的 field 和 value 的映射表，hash特别适合用于存储对象，常用命令：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-14.png" alt="img"></p><ul><li>HSET key field value：添加或者修改hash类型key的field的值</li><li>HGET key field：获取一个hash类型key的field的值</li><li>HMSET：批量添加多个hash类型key的field的值</li><li>HMGET：批量获取多个hash类型key的field的值</li><li>HGETALL：获取一个hash类型的key中的所有的field和value</li><li>HKEYS：获取一个hash类型的key中的所有的field</li><li>HINCRBY:让一个hash类型key的字段值自增并指定步长</li><li>HSETNX：添加一个hash类型的key的field值，前提是这个field不存在，否则不执行</li></ul><h3 id="3-3-List列表操作命令">3.3 List列表操作命令</h3><p>Redis中的List类型与Java中的LinkedList类似，可以看做是一个双向链表结构。既可以支持正向检索和也可以支持反向检索。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-15.png" alt="img"></p><p>特征也与LinkedList类似：</p><ul><li>有序</li><li>元素可以重复</li><li>插入和删除快</li><li>查询速度一般</li></ul><p>常用来存储一个有序数据，例如：朋友圈点赞列表，评论列表等。</p><ul><li>LPUSH key element … ：向列表左侧插入一个或多个元素</li><li>LPOP key：移除并返回列表左侧的第一个元素，没有则返回nil</li><li>RPUSH key element … ：向列表右侧插入一个或多个元素</li><li>RPOP key：移除并返回列表右侧的第一个元素</li><li>LRANGE key star end：返回一段角标范围内的所有元素</li><li>BLPOP和BRPOP：与LPOP和RPOP类似，只不过在没有元素时等待指定时间，而不是直接返回nil</li></ul><h3 id="3-4-Set集合操作命令">3.4 Set集合操作命令</h3><p>Redis的Set结构与Java中的HashSet类似，可以看做是一个value为null的HashMap。因为也是一个hash表，因此具备与HashSet类似的特征：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-16.png" alt="img"></p><ul><li>支持交集、并集、差集等功能</li><li>无序</li><li>元素不可重复</li><li>查找快</li></ul><p>Set的常见命令有：</p><ul><li>SADD key member … ：向set中添加一个或多个元素</li><li>SREM key member … : 移除set中的指定元素</li><li>SCARD key： 返回set中元素的个数</li><li>SISMEMBER key member：判断一个元素是否存在于set中</li><li>SMEMBERS：获取set中的所有元素</li><li>SINTER key1 key2 … ：求key1与key2的交集</li></ul><h3 id="3-5-SortedSet有序集合操作命令">3.5 SortedSet有序集合操作命令</h3><p>Redis的SortedSet是一个可排序的set集合，与Java中的TreeSet有些类似，但底层数据结构却差别很大。SortedSet中的每一个元素都带有一个score属性，可以基于score属性对元素排序，底层的实现是一个跳表（SkipList）加 hash表。</p><p>SortedSet具备下列特性：</p><ul><li>可排序</li><li>元素不重复</li><li>查询速度快</li></ul><p>因为SortedSet的可排序特性，经常被用来实现排行榜这样的功能。</p><p>常用命令：</p><ul><li>ZADD key score member：添加一个或多个元素到sorted set ，如果已经存在则更新其score值</li><li>ZREM key member：删除sorted set中的一个指定元素</li><li>ZSCORE key member : 获取sorted set中的指定元素的score值</li><li>ZRANK key member：获取sorted set 中的指定元素的排名</li><li>ZCARD key：获取sorted set中的元素个数</li><li>ZCOUNT key min max：统计score值在给定范围内的所有元素的个数</li><li>ZINCRBY key increment member：让sorted set中的指定元素自增，步长为指定的increment值</li><li>ZRANGE key min max：按照score排序后，获取指定排名范围内的元素</li><li>ZRANGEBYSCORE key min max：按照score排序后，获取指定score范围内的元素</li><li>ZDIFF、ZINTER、ZUNION：求差集、交集、并集</li><li>注意：所有的排名默认都是升序，如果要降序则在命令的Z后面添加REV即可，例如：</li><li><strong>升序</strong>获取sorted set 中的指定元素的排名：ZRANK key member</li><li><strong>降序</strong>获取sorted set 中的指定元素的排名：ZREVRANK key memeber</li></ul><p>注意：所有的排名默认都是升序，如果要降序则在命令的Z后面添加REV即可，例如：</p><ul><li><strong>升序</strong>获取sorted set 中的指定元素的排名：ZRANK key member</li><li><strong>降序</strong>获取sorted set 中的指定元素的排名：ZREVRANK key memeber</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-17.png" alt="img"></p><h3 id="3-6-通用命令">3.6 通用命令</h3><p>Redis的通用命令是不分数据类型的，都可以使用的命令：</p><ul><li>KEYS pattern 查找所有符合给定模式( pattern)的 key</li><li>EXISTS key 检查给定 key 是否存在</li><li>TYPE key 返回 key 所储存的值的类型</li><li>DEL key 该命令用于在 key 存在是删除 key</li><li>EXPIRE key 给一个key设置有效期，有效期到期时key会自动删除</li><li>TTL key 查看一个key的剩余有效期(-1永久，-2被移除)</li></ul><h3 id="3-7-Key结构">3.7 Key结构</h3><p>Redis没有类似MySQL中的Table的概念，我们该如何区分不同类型的key呢？</p><p>例如，需要存储用户、商品信息到redis，有一个用户id是1，有一个商品id恰好也是1，此时如果使用id作为key，那就会冲突了，该怎么办？</p><p>我们可以通过给key添加前缀加以区分，不过这个前缀不是随便加的，有一定的规范：</p><p>Redis的key允许有多个单词形成层级结构，多个单词之间用’:'隔开，格式如下：</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">项目名:业务名:类型:<span class="built_in">id</span></span><br></pre></td></tr></table></figure><p>这个格式并非固定，也可以根据自己的需求来删除或添加词条。这样以来，我们就可以把不同类型的数据区分开了。从而避免了key的冲突问题。</p><p>例如我们的项目名称叫 heima，有user和product两种不同类型的数据，我们可以这样定义key：</p><ul><li>user相关的key：<strong>heima:user:1</strong></li><li>product相关的key：<strong>heima:product:1</strong></li></ul><p>如果Value是一个Java对象，例如一个User对象，则可以将对象序列化为JSON字符串后存储：</p><table><thead><tr><th><strong>KEY</strong></th><th><strong>VALUE</strong></th></tr></thead><tbody><tr><td>heima:user:1</td><td>{“id”:1, “name”: “Jack”, “age”: 21}</td></tr><tr><td>heima:product:1</td><td>{“id”:1, “name”: “小米11”, “price”: 4999}</td></tr></tbody></table><p>并且，在Redis的桌面客户端中，还会以相同前缀作为层级结构，让数据看起来层次分明，关系清晰。</p><h2 id="4-在Java中操作Redis">4.在Java中操作Redis</h2><h3 id="4-1-Redis的Java客户端">4.1 Redis的Java客户端</h3><p>前面我们讲解了Redis的常用命令，这些命令是我们操作Redis的基础，那么我们在java程序中应该如何操作Redis呢？这就需要使用Redis的Java客户端，就如同我们使用JDBC操作MySQL数据库一样。</p><p>Redis 的 Java 客户端很多，常用的几种：</p><ul><li>Jedis</li><li>Lettuce</li><li>Spring Data Redis</li></ul><p>Spring 对 Redis 客户端进行了整合，提供了 Spring Data Redis，在Spring Boot项目中还提供了对应的Starter，即 spring-boot-starter-data-redis。</p><p>我们重点学习<strong>Spring Data Redis</strong>。</p><h4 id="4-1-1Jedis客户端">4.1.1Jedis客户端</h4><p>Jedis的官网地址： <a href="https://github.com/redis/jedis">https://github.com/redis/jedis</a>   （快速入门）</p><h4 id="4-1-2-SpringDataRedis客户端">4.1.2 SpringDataRedis客户端</h4><p>SpringData是Spring中数据操作的模块，包含对各种数据库的集成，其中对Redis的集成模块就叫做SpringDataRedis，官网地址：<a href="https://spring.io/projects/spring-data-redis">https://spring.io/projects/spring-data-redis</a></p><ul><li>提供了对不同Redis客户端的整合（Lettuce和Jedis）</li><li>提供了RedisTemplate统一API来操作Redis</li><li>支持Redis的发布订阅模型</li><li>支持Redis哨兵和Redis集群</li><li>支持基于Lettuce的响应式编程</li><li>支持基于JDK、JSON、字符串、Spring对象的数据序列化及反序列化</li><li>支持基于Redis的JDKCollection实现</li></ul><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-18-1024x331.png" alt="img"></p><p><strong>环境搭建</strong>：</p><p><strong>1). 导入Spring Data Redis的maven坐标</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>2). 配置Redis数据源</strong></p><p>在application-dev.yml中添加</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sky:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">10</span></span><br><span class="line">    <span class="attr">lettuce:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">8</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">8</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">max-wait:</span> <span class="string">100ms</span></span><br></pre></td></tr></table></figure><p>database:指定使用Redis的哪个数据库，Redis服务启动后默认有16个数据库，编号分别是从0到15。</p><p>可以通过修改Redis配置文件来指定数据库的数量。</p><p>在application.yml中添加读取application-dev.yml中的相关Redis配置</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">spring:</span></span><br><span class="line"><span class="symbol">  profiles:</span></span><br><span class="line"><span class="symbol">    active:</span> dev</span><br><span class="line"><span class="symbol">  redis:</span></span><br><span class="line"><span class="symbol">    host:</span> $<span class="punctuation">&#123;</span>sky.redis.host<span class="punctuation">&#125;</span></span><br><span class="line"><span class="symbol">    port:</span> $<span class="punctuation">&#123;</span>sky.redis.port<span class="punctuation">&#125;</span></span><br><span class="line"><span class="symbol">    password:</span> $<span class="punctuation">&#123;</span>sky.redis.password<span class="punctuation">&#125;</span></span><br><span class="line"><span class="symbol">    database:</span> $<span class="punctuation">&#123;</span>sky.redis.database<span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>3). 编写配置类，创建RedisTemplate对象</strong>，自定义RedisTemplate的序列化方式</p><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> RedisConfig &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; redisTemplate(RedisConnectionFactory connectionFactory)&#123;</span><br><span class="line">        <span class="comment">// 创建RedisTemplate对象</span></span><br><span class="line">        RedisTemplate&lt;String, Object&gt; <span class="keyword">template</span> = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">        <span class="comment">// 设置连接工厂</span></span><br><span class="line">        <span class="keyword">template</span>.setConnectionFactory(connectionFactory);</span><br><span class="line">        <span class="comment">// 创建JSON序列化工具</span></span><br><span class="line">        GenericJackson2JsonRedisSerializer jsonRedisSerializer = </span><br><span class="line">            <span class="keyword">new</span> GenericJackson2JsonRedisSerializer();</span><br><span class="line">        <span class="comment">// 设置Key的序列化</span></span><br><span class="line">        <span class="keyword">template</span>.setKeySerializer(RedisSerializer.<span class="built_in">string</span>());</span><br><span class="line">        <span class="keyword">template</span>.setHashKeySerializer(RedisSerializer.<span class="built_in">string</span>());</span><br><span class="line">        <span class="comment">// 设置Value的序列化</span></span><br><span class="line">        <span class="keyword">template</span>.setValueSerializer(jsonRedisSerializer);</span><br><span class="line">        <span class="keyword">template</span>.setHashValueSerializer(jsonRedisSerializer);</span><br><span class="line">        <span class="comment">// 返回</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">template</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-19-1024x210.png" alt="img"></p><p>缺点：</p><ul><li>可读性差</li><li>内存占用较大</li></ul><p>这里采用了JSON序列化来代替默认的JDK序列化方式。最终结果如图：</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-20-1024x326.png" alt="img"></p><p>*<strong>为了节省内存空间*</strong>，我们可以不使用JSON序列化器来处理value，而是统一使用String序列化器，要求只能存储String类型的key和value。当需要存储Java对象时，手动完成对象的序列化和反序列化。</p><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-21-1024x352.png" alt="img"></p><p>StringRedisTemplate，它的key和value的序列化方式默认就是String方式。</p><p>省去了我们自定义RedisTemplate的序列化方式的步骤，而是直接使用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"><span class="comment">// JSON序列化工具</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testSaveUser</span><span class="params">()</span> <span class="keyword">throws</span> JsonProcessingException &#123;</span><br><span class="line">    <span class="comment">// 创建对象</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;虎哥&quot;</span>, <span class="number">21</span>);</span><br><span class="line">    <span class="comment">// 手动序列化</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> mapper.writeValueAsString(user);</span><br><span class="line">    <span class="comment">// 写入数据</span></span><br><span class="line">    stringRedisTemplate.opsForValue().set(<span class="string">&quot;user:200&quot;</span>, json);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取数据</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">jsonUser</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;user:200&quot;</span>);</span><br><span class="line">    <span class="comment">// 手动反序列化</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> mapper.readValue(jsonUser, User.class);</span><br><span class="line">    System.out.println(<span class="string">&quot;user1 = &quot;</span> + user1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>小结：RedisTemplate 和 StringRedisTemplate</strong></p><p><code>**RedisTemplate**</code>（泛型通用）：</p><ul><li>是一个<strong>通用的 Redis 操作模板</strong>，支持任意类型的 key 和 value（通过泛型控制），例如对象、列表、哈希等。</li><li>需要自己配置序列化器（比如 <code>Jackson2JsonRedisSerializer</code>）来处理 key/value 的序列化与反序列化</li></ul><p><code>**StringRedisTemplate**</code>（专门针对字符串）</p><ul><li>是 <code>RedisTemplate&lt;String, String&gt;</code> 的一个<strong>专用子类</strong>。</li><li>内部已经默认设置好了字符串的序列化方式，适合 key 和 value 都是字符串的场景。</li><li>使用更简单直观，常用于缓存简单字符串值，如：</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stringRedisTemplate.opsForValue().<span class="built_in">set</span>(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value&quot;</span>);</span><br></pre></td></tr></table></figure><p><img src="https://www.legendkiller.xyz/wp-content/uploads/2025/05/image-22.png" alt="img"></p><h1 id="Redis基础篇完结"><strong>Redis基础篇完结</strong></h1>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
